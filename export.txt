# TOTETAXI — FULL CODEBASE EXPORT
# Generated: 2026-02-07 16:04:20
# Files: 168 (64 backend, 101 frontend, 3 root)
# Excludes: .env, migrations, tests, __init__.py, node_modules


============================================================
  ROOT
============================================================

# ──── CHANGELOG.md ────

```markdown
# ToteTaxi Development Changelog

**Project:** ToteTaxi Platform
**Last Updated:** February 7, 2026

---

## Summary

This document tracks all completed development work for client presentation and internal reference.

---

## February 7, 2026

### Performance & Code Quality (PR #6)

13 findings fixed from the security audit (1 HIGH, 7 MEDIUM, 5 MINOR). 2 items confirmed already fixed.

| Finding | Severity | Description | Fix |
|---------|----------|-------------|-----|
| H7 | HIGH | `time.sleep()` in Stripe webhook blocked gunicorn workers up to 3.9s | Moved to Celery tasks with exponential backoff retry |
| M2 | MEDIUM | Calendar N+1 queries (120+ for 60-day range) | Bulk query + defaultdict grouping (2 queries total) |
| M3 | MEDIUM | Customer management N+1 (200+ for 100 customers) | Prefetch with to_attr (3 queries total) |
| M4 | MEDIUM | Booking.save() recalculated pricing every time | Added `_skip_pricing` flag for status-only saves |
| M6 | MEDIUM | BrowsableAPI enabled in production | Conditional on DEBUG setting |
| M8 | MEDIUM | PaymentSerializer N+1 on booking relation | Added select_related to PaymentListView |
| M9 | MEDIUM | date.fromisoformat crashed on invalid input | Added try/except returning 400 |
| M10 | MEDIUM | Stripe webhook returned 404/500 causing Stripe retries | Now always returns 200 (async Celery processing) |
| L4 | MINOR | _get_most_used_address ignores address_type | Documented: SavedAddress has no address_type field |
| L5 | MINOR | CustomerBookingListView returned soft-deleted bookings | Added deleted_at__isnull=True filter |
| L9 | MINOR | Refund modal didn't show remaining refundable amount | Shows total_refunded and remaining amount |
| L11 | MINOR | No search debounce on staff management pages | 300ms useDebounce hook on booking + customer search |
| L19 | MINOR | Password reset didn't invalidate previous tokens | Old tokens marked used before creating new one |

**Already fixed (no changes needed):** M7 (pagination — DEFAULT_PAGINATION_CLASS in settings), L7 (console.log — next.config removeConsole)

**New files:** `backend/apps/payments/tasks.py`, `frontend/src/hooks/use-debounce.ts`
**Tests added:** 14 new tests across 4 test files
**Test results:** 199 passed, 0 regressions (5 pre-existing failures)

---

## February 6, 2026

### Auth & Permissions Security Fixes (PR #5)

6 more findings fixed from the security audit.

| Finding | Severity | Description | Fix |
|---------|----------|-------------|-----|
| H3 | HIGH | Staff endpoints used inline `hasattr` checks instead of DRF permission classes — no role enforcement | Created `IsStaffMember` and `IsAdminStaff` permission classes, applied to all 14 staff views |
| H5 | HIGH | Booking status accepted any arbitrary string — no transition validation | Added `VALID_TRANSITIONS` state machine to Booking model, validated in staff update view |
| C4 | CRITICAL | Booking number generation had race condition — concurrent saves could produce duplicates | Wrapped in `transaction.atomic()` + `select_for_update()` |
| C5 | CRITICAL | Customer stats (total_bookings, total_spent_cents) incremented in both payments AND logistics — double counting | Removed duplicate from logistics; kept single increment in payments with F() expressions |
| L1 | MINOR | StaffAction logged `view_booking` but it wasn't in ACTION_TYPES choices | Added `view_booking` to ACTION_TYPES |
| L18 | MINOR | SECRET_KEY had insecure default that could silently be used in production | Required in production (no fallback when FLY_APP_NAME set), default only for local dev |

**Skipped:** H4 (lock_account `timezone.timedelta`) — investigated and confirmed NOT broken (Django re-exports timedelta). H6 (CSRF) — low risk given CORS + SameSite + separate domains.

**Tests added:** 23 new tests across 3 test files
**Test results:** 185 passed, 0 regressions

---

### Security Audit & Critical Fixes (PR #4)

Full security audit performed. 6 findings fixed and deployed.

| Finding | Severity | Description | Fix |
|---------|----------|-------------|-----|
| C1 | CRITICAL | Payment amount never verified — attacker could pay $1 for a $995 move | Server-side Stripe PI amount vs booking total check on both guest and authenticated flows |
| C2 | CRITICAL | PaymentIntent reuse — same PI could create multiple bookings; guest flow had no Payment record | PI reuse check before booking creation; guest flow now creates Payment record |
| C3 | CRITICAL | Onfleet webhook had zero authentication — anyone could fake delivery status updates | HMAC-SHA512 signature verification using `ONFLEET_WEBHOOK_SECRET` |
| H1 | HIGH | Public calendar endpoint leaked customer names, booking IDs, prices to unauthenticated users | Staff gets full data, public gets booking counts only |
| H2 | HIGH | Booking/payment status endpoints enumerable via sequential TT-XXXXXX numbers | Changed to UUID-only lookup, stripped sensitive fields from response |
| H8 | HIGH | API error responses included raw exceptions — leaked Stripe keys, DB schema, file paths | Replaced all `str(e)` with generic messages; detailed errors logged server-side only |

**Tests added:** 24 new security tests across 4 test files
**Test results:** 162 passed, 0 regressions

---

## January 8, 2026

### Bug Fixes

| Bug | Description | Fix | Files Changed |
|-----|-------------|-----|---------------|
| Double-click login | Staff portal required clicking login twice due to CSRF race condition | Changed CSRF endpoint to AllowAny permission | `backend/apps/accounts/views.py` |
| Calendar not loading | Staff booking calendar showed no data | Fixed wrong API URL (`/api/public/calendar/availability/` → `/a
pi/public/availability/`) | `frontend/src/components/staff/booking-calendar.tsx` |
| Logistics stats empty | Dashboard stats showed blank values | Fixed response structure mismatch between backend and frontend | `backend/apps/logistics/services.py` |
| Refresh button no feedback | "Refresh Data" button appeared non-functional | Added isFetching loading state and visual feedback | `frontend/src/components/staff/staff-dashboard-overview.tsx` |
| Service buttons not working | "Select Petite/Standard/Full Move" buttons did nothing | Added onClick handlers to save package selection to booking wizard | `frontend/src/components/marketing/service-showcase.tsx` |
| Surge pricing only charges once | Out-of-zone surcharge only charged once even when both pickup AND delivery were outside core area | Updated to charge $175 per out-of-zone location (max $350) | `backend/apps/bookings/models.py`, `views.py`, `serializers.py` |
| Password field not registering | Login form password field wouldn't accept input | Fixed Input component conflict with react-hook-form (controlled vs uncontrolled) | `frontend/src/components/ui/input.tsx` |

### Features Built

#### Reports & Analytics Page
**Location:** Staff Dashboard → Reports

**Backend API** (`backend/apps/accounts/views.py`):
- New endpoint: `GET /api/staff/reports/`
- Returns:
  - Total revenue, booking count, customer count, completion rate
  - Daily revenue and bookings (past 30 days)
  - Bookings breakdown by status
  - Revenue breakdown by service type
  - Top 10 customers by revenue
  - Monthly revenue (past 12 months)

**Frontend** (`frontend/src/app/staff/reports/page.tsx`):
- Key metrics cards with icons
- Daily revenue bar chart
- Daily bookings bar chart
- Bookings by status breakdown (color-coded)
- Revenue by service type table
- Top customers table
- Monthly revenue summary table

### Email Features

| Item | Description | Files Changed |
|------|-------------|---------------|
| Calendar invite (.ics) in reminder emails | 24-hour reminder emails now include downloadable calendar invite with pickup time, location, and booking details (30 min event) | `backend/apps/customers/emails.py` |
| Post-delivery review email | Automatic email sent when booking status changes to "completed" requesting Google review (uses Place ID: ChIJK7UwwRDB0UIRP6hrsPW6ZMk) | `backend/apps/customers/emails.py`, `backend/apps/bookings/signals.py`, `backend/templates/emails/review_request.txt` |

### Content Updates

| Item | Description | Files Changed |
|------|-------------|---------------|
| Tote Camps footer link | Added link to totecamps.com in website footer | `frontend/src/components/layout/main-layout.tsx` |
| Hampton Jitney partner | Added as partner on partnerships page with description and link | `frontend/src/app/partnerships/page.tsx` |
| Hampton Jitney homepage | Added to "Trusted Partners" section on homepage (now 4-column grid) | `frontend/src/app/page.tsx` |
| Remove "New Booking" button | Removed non-functional "+ New Booking" button from staff calendar page | `frontend/src/components/staff/booking-calendar.tsx` |
| Remove "BLADE" branding | Removed all "BLADE" text from booking wizard - now shows "Airport Transfer" | `frontend/src/components/booking/*.tsx` (4 files) |
| JFK Route Announcement Popup | Added popup for new visitors announcing JFK route with "Book Now" CTA linking to Airport Transfer booking | `frontend/src/components/marketing/jfk-announcement-popup.tsx`, `frontend/src/app/page.tsx` |

### Infrastructure

| Item | Description |
|------|-------------|
| Google Places API | Enabled billing to activate address autocomplete |

---

## January 2, 2026 (Previous Session)

### Infrastructure & Webhook Fixes

| Item | Description | Files Changed |
|------|-------------|---------------|
| Stripe webhook retry logic | Fixed race condition where webhooks failed if booking wasn't created yet | `backend/apps/payments/views.py` |
| Onfleet webhook retry logic | Fixed race condition with task creation timing | `backend/apps/logistics/services.py` |
| Onfleet Trigger 7 handler | Implemented taskUpdated webhook handler | `backend/apps/logistics/services.py` |
| Customer profile 500 error | Fixed error when staff users accessed customer profiles | `backend/apps/customers/views.py` |
| Celery beat memory | Scaled memory to 512 MB to prevent OOM issues | Fly.io config |

---

## Running Totals

### Security Fixes: 25
- C1: Payment amount verification
- C2: PaymentIntent reuse prevention + guest Payment record
- C3: Onfleet webhook HMAC authentication
- C4: Booking number race condition (atomic generation)
- C5: Customer stats double-counting fix
- H1: Calendar PII stripped for public users
- H2: Booking/payment status UUID-only lookup
- H3: Staff permission classes (replace inline hasattr checks)
- H5: Booking status transition validation
- H7: Webhook time.sleep() replaced with Celery tasks
- H8: Error message sanitization
- M2: Calendar N+1 queries optimized
- M3: Customer management N+1 queries optimized
- M4: Booking.save() _skip_pricing flag
- M6: BrowsableAPI disabled in production
- M8: PaymentSerializer N+1 fixed
- M9: date.fromisoformat error handling
- M10: Stripe webhook always returns 200
- L1: StaffAction view_booking type added
- L4: _get_most_used_address documented
- L5: Soft-deleted bookings filtered
- L9: Refund modal partial refund awareness
- L11: Search debounce (300ms)
- L18: SECRET_KEY required in production
- L19: Password reset token invalidation

### Bugs Fixed: 8
- Double-click login (CSRF)
- Calendar not loading
- Logistics stats empty
- Refresh button no feedback
- Service buttons not working
- Surge pricing only charges once
- Password field not registering
- Customer profile 500 error

### Features Built: 1
- Reports & Analytics page (full implementation)

### Email Features: 2
- Calendar invite (.ics) in reminder emails
- Post-delivery review request email

### Content Updates: 4
- Tote Camps footer link
- Hampton Jitney on partnerships page
- Hampton Jitney on homepage
- JFK promo banner/popup

### Infrastructure Fixes: 5
- Stripe webhook retry logic
- Onfleet webhook retry logic
- Onfleet Trigger 7 handler
- Celery beat memory scaling
- Google Places API billing enabled

---

## Pending Work

### Proposed Features (Approved Jan 9)

| Feature | Estimate | Priority | Status |
|---------|----------|----------|--------|
| Discount Codes | 10-12 hours | HIGH | Not Started |
| Item Description Field | 5-6 hours | MEDIUM | Not Started |
| MailChimp Integration | 3-4 hours | LOW | Not Started |

### Easy Wins

| Item | Effort | Status |
|------|--------|--------|
| Box size dimensions info | Easy | Not Started |

### Medium Priority

| Item | Effort | Status |
|------|--------|--------|
| Abandoned cart emails | Medium | Not Started |
| Round-trip bookings | Large | Not Started |

### Needs Client Input
- Service type filters - need specific example of failure
- CRM customer data - need specific example of missing data
- Special dates surcharges - need date list from Danielle
```

# ──── CLAUDE.md ────

```markdown

# CLAUDE.md — ToteTaxi

## Project Overview
ToteTaxi is a booking and logistics platform for moving/transport services. Customers book services (Petite Move, Standard Move, Full Move, Organizing), make payments via Stripe, and track deliveries. Staff manage bookings, logistics, analytics, and customer data through a dedicated dashboard.

## Tech Stack
- **Backend:** Django 5.2 + Django REST Framework, PostgreSQL 16, Redis 7, Celery + Celery Beat
- **Frontend:** Next.js 16, React 19, TypeScript 5, Tailwind CSS 3, Zustand, React Query
- **Payments:** Stripe | **Logistics:** Onfleet | **Email:** Postmark (SMTP) | **Storage:** AWS S3
- **Monitoring:** Sentry (frontend + backend) | **Rate Limiting:** django-ratelimit
- **Static Files:** WhiteNoise | **API Docs:** drf-yasg (Swagger)

## Production URLs
- **Frontend:** https://totetaxi.netlify.app (Netlify)
- **Backend:** https://api.totetaxi.com (Fly.io, region `ewr`)
- **Backend (fallback):** https://totetaxi-backend.fly.dev
- **Django Admin:** https://api.totetaxi.com/admin/

## Development Setup

### Backend (from `/backend`)
```bash
docker-compose up                                    # PostgreSQL :5435, Redis :6382, Django :8005, Celery, Beat
docker-compose exec web python manage.py migrate     # Run migrations
docker-compose exec web python manage.py createsuperuser
```

### Frontend (from `/frontend`)
```bash
npm run dev       # Next.js dev server on :3000
npm run build     # Production build
npm run lint      # ESLint (next/core-web-vitals + next/typescript)
```

### Testing
```bash
# Backend (from /backend) — pytest with SQLite in-memory, Celery eager mode, rate limiting disabled
docker-compose exec web pytest                    # All tests
docker-compose exec web pytest apps/bookings/     # Single app
docker-compose exec web pytest -x                 # Stop on first failure

# Frontend (from /frontend) — Playwright, Chromium only, tests in frontend/tests/e2e/
npm run test:e2e          # Headless
npm run test:e2e:headed   # With browser
npm run test:e2e:ui       # Interactive UI mode
```

## API Structure
The backend API is split by audience (defined in `config/urls.py`):
```
/admin/                  — Django admin
/api/public/             — Public booking endpoints (no auth): services, pricing, availability, guest booking
/api/customer/           — Authenticated customer endpoints: profile, bookings, dashboard
/api/staff/              — Staff endpoints: booking management, analytics, reports
/api/staff/logistics/    — Staff logistics: Onfleet integration, delivery tracking
/api/payments/           — Payment endpoints: Stripe intents, webhooks, refunds
```

## Project Structure

### Backend (`/backend`)
- `config/` — Settings, root URLs, WSGI, Celery config
- `apps/accounts/` — User auth, staff management, JWT tokens
- `apps/bookings/` — Booking CRUD, service catalog, pricing, availability, guest bookings
- `apps/customers/` — Customer profiles, HybridAuthentication class
- `apps/logistics/` — Onfleet integration, delivery tracking
- `apps/payments/` — Stripe processing, webhooks, refunds
- `apps/services/` — Service definitions
- `scripts/entrypoint.sh` — Auto-runs migrations + collectstatic on container start

### Frontend (`/frontend/src`)
- `app/` — Next.js App Router pages
- `components/` — Organized by domain: `auth/`, `booking/`, `dashboard/`, `staff/`, `marketing/`, `ui/`, `layout/`, `providers/`
- `stores/` — Zustand stores: `auth-store`, `staff-auth-store`, `booking-store`, `ui-store`
- `hooks/` — Custom React hooks
- `lib/` — API client (Axios), utilities
- `types/` — TypeScript type definitions
- `utils/` — Helper functions

## Code Conventions

### Backend (Python)
- Django apps in `apps/` with standard files: `models.py`, `views.py`, `serializers.py`, `urls.py`
- Views use DRF class-based views (APIView, generics)
- URL patterns use kebab-case: `/api/public/guest-booking/`, `/api/public/validate-zip/`
- Models use UUIDs for public-facing IDs
- Black formatter: line-length 88, target Python 3.11
- isort: profile "black", skips migrations
- Timezone: `America/New_York` (USE_TZ=True)

### Frontend (TypeScript)
- Kebab-case filenames: `booking-wizard.tsx`, `staff-dashboard-overview.tsx`
- Components organized by domain under `components/`
- State: Zustand for client state, React Query for server state
- Forms: React Hook Form + Zod validation
- Styling: Tailwind CSS + Headless UI + Heroicons
- Path alias: `@/*` → `./src/*`
- React strict mode enabled
- `ignoreBuildErrors: true` in next.config (TypeScript errors won't block builds)
- Console.log stripped in production builds (errors/warnings kept)

### Authentication
- DRF uses custom `HybridAuthentication` (from `apps.customers.authentication`), not plain JWT
- Separate auth flows for customers and staff (`auth-store` vs `staff-auth-store`)
- JWT via `djangorestframework-simplejwt`

## Deployment

### Backend — Fly.io
- App: `totetaxi-backend`, region: `ewr` (Newark)
- Uses `Dockerfile.prod` (multi-stage, non-root `appuser`)
- 3 Fly processes: `web` (gunicorn, 4 workers), `worker` (celery), `beat` (celery-beat)
- `release_command` auto-runs migrations on deploy
- Secrets managed via `fly secrets set`

### Frontend — Netlify
- Deploys from the `frontend/` directory
- Production env vars in `.env.production`

## Environment Variables

### Frontend (`frontend/.env.local` for dev, `.env.production` for prod)
- `NEXT_PUBLIC_API_URL` — Backend URL (localhost:8005 dev, api.totetaxi.com prod)
- `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` — Stripe public key
- `NEXT_PUBLIC_GOOGLE_PLACES_API_KEY` — Google Places autocomplete
- `NEXT_PUBLIC_RECAPTCHA_SITE_KEY` — reCAPTCHA v3 spam prevention
- `NEXT_PUBLIC_SENTRY_DSN` / `NEXT_PUBLIC_SENTRY_ENVIRONMENT` — Sentry config

### Backend (`backend/.env` — see `.env.example`)
- `SECRET_KEY`, `DEBUG`, `DATABASE_URL`, `REDIS_URL`
- `STRIPE_SECRET_KEY`, `STRIPE_PUBLISHABLE_KEY`, `STRIPE_WEBHOOK_SECRET`
- `ONFLEET_API_KEY` — Onfleet logistics (mock mode defaults to True locally)
- `POSTMARK_API_KEY` — Transactional email
- `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_STORAGE_BUCKET_NAME` — S3 media
- `SENTRY_DSN` — Error monitoring
- `CORS_ALLOWED_ORIGINS` — Allowed frontend origins
- `RECAPTCHA_SECRET_KEY` — Server-side reCAPTCHA validation
- `BOOKING_EMAIL_BCC` — BCC list for booking confirmation emails

## Ports (Local Dev)
| Service    | Host Port | Internal |
|------------|-----------|----------|
| Frontend   | 3000      | 3000     |
| Backend    | 8005      | 8000     |
| PostgreSQL | 5435      | 5432     |
| Redis      | 6382      | 6379     |

## Important Gotchas
- Backend `.env` is required locally — Docker won't start without it (see `.env.example`)
- Fly.io uses real env vars (secrets), not `.env` files — settings.py detects `FLY_APP_NAME` to skip `.env` loading
- The entrypoint script (`scripts/entrypoint.sh`) unsets DB_HOST/DB_NAME/etc on Fly.io to force `DATABASE_URL` usage
- Onfleet defaults to mock/sandbox mode (`ONFLEET_MOCK_MODE=True`) — must explicitly set False for real dispatches
- Tests use in-memory SQLite, not PostgreSQL — some DB-specific queries may behave differently
- `ignoreBuildErrors: true` means TypeScript errors won't fail the Next.js build — lint separately with `npm run lint`
- Production docker-compose (`docker-compose.prod.yml`) uses `.env.production`, Redis auth, internal-only networking, and memory limits
- CORS is configured for `localhost:3000` and `totetaxi.netlify.app` by default
```

# ──── SECURITY_AUDIT_FEB2026.md ────

```markdown
# ToteTaxi Security Audit & Fix Plan
**Date:** February 6, 2026
**Audited by:** Claude Code (code-reviewer + ecommerce-security agents)
**Status:** All 4 PRs merged & deployed. Audit complete.

---

## Table of Contents
1. [Findings Summary](#findings-summary)
2. [Existing Test Coverage](#existing-test-coverage)
3. [Fix Plan by PR](#fix-plan-by-pr)
4. [Test Plan](#test-plan)
5. [Deployment Strategy](#deployment-strategy)
6. [Verification Checklist](#verification-checklist)

---

## Findings Summary

### CRITICAL — Fix Before Next Deploy

| ID | Finding | Files | Test Coverage |
|----|---------|-------|---------------|
| C1 | **Payment amount never verified** — booking creation checks `payment_intent.status == 'succeeded'` but never checks amount matches booking total. Attacker could pay $1 and book a $2,500 move. | `bookings/views.py:554-572`, `customers/booking_views.py:110-128` | **FIXED** PR #4 |
| C2 | **PaymentIntent reuse** — no check prevents using one successful PI to create multiple bookings. Guest flow doesn't even create a Payment record. | `bookings/views.py:535-617`, `customers/booking_views.py:84-185` | **FIXED** PR #4 |
| C3 | **Onfleet webhook has zero auth** — no signature verification despite `ONFLEET_WEBHOOK_SECRET` in settings. Anyone can POST fake task completions to mark bookings complete. | `logistics/views.py:127-198` | **FIXED** PR #4 |
| C4 | **Booking number race condition** — concurrent saves generate same `TT-XXXXXX`, one crashes with unhandled `IntegrityError` after payment. | `bookings/models.py:327-336` | **FIXED** PR #5 — atomic select_for_update |
| C5 | **Double-counting customer stats** — both `confirm_payment()` and `_mark_booking_completed()` increment `total_bookings` and `total_spent_cents`. | `payments/services.py:78-85`, `logistics/models.py:153-174` | **FIXED** PR #5 — removed duplicate, F() expressions |

### HIGH — Fix Within One Sprint

| ID | Finding | Files | Test Coverage |
|----|---------|-------|---------------|
| H1 | **Calendar endpoint leaks all booking PII publicly** — customer names, prices, booking numbers via `AllowAny` permission. | `bookings/views.py:419-483` | **FIXED** PR #4 |
| H2 | **Booking status endpoint enumerable** — sequential `TT-000001` + `AllowAny` = mass scraping of customer names and full addresses. | `bookings/views.py:620-633` | **FIXED** PR #4 |
| H3 | **Staff role permissions never enforced** — `staff` and `admin` roles exist but every view just checks `hasattr(request.user, 'staff_profile')`. Any staff can process unlimited refunds. | `accounts/views.py` (15+ locations), `payments/views.py:521-629` | **FIXED** PR #5 — IsStaffMember/IsAdminStaff permission classes |
| H4 | **`StaffProfile.lock_account` broken** — references `timezone.timedelta` which doesn't exist. Account lockout crashes instead of working. | `accounts/models.py:84` | **NOT BROKEN** — Django re-exports timedelta from datetime |
| H5 | **Booking status accepts any arbitrary string** — staff PATCH doesn't validate against `STATUS_CHOICES`. | `accounts/views.py:696-734` | **FIXED** PR #5 — VALID_TRANSITIONS state machine |
| H6 | **HybridAuthentication bypasses CSRF** — overrides `authenticate()` without calling `enforce_csrf()`. | `customers/authentication.py:8-58` | SKIPPED — low risk (CORS + SameSite + separate domains) |
| H7 | **`time.sleep()` in Stripe webhook** — blocks gunicorn workers up to 3.9 seconds per retry, can exhaust all workers. | `payments/views.py:200-217` | **FIXED** PR #6 — Celery tasks with exponential backoff |
| H8 | **Raw `str(e)` in error responses** — leaks Stripe API details, DB schema, file paths to clients. | Multiple views across payments, bookings, logistics, customers | **FIXED** PR #4 |

### MEDIUM

| ID | Finding | Files |
|----|---------|-------|
| M1 | No rate limiting on payment intent creation endpoints (Stripe cost amplification) | `bookings/views.py`, `payments/views.py`, `customers/booking_views.py` | **FIXED** PR #7 — 10/h per IP on all 3 endpoints |
| M2 | Calendar availability: 120+ DB queries for 60-day range (N+1) | `bookings/views.py:437-477` | **FIXED** PR #6 — bulk query + defaultdict |
| M3 | Customer management: 200+ queries for 100 customers (N+1) | `accounts/views.py:242-273` | **FIXED** PR #6 — Prefetch with to_attr |
| M4 | `Booking.save()` recalculates pricing every time — can silently change prices after config updates | `bookings/models.py:327-358` | **FIXED** PR #6 — _skip_pricing flag |
| M5 | Webhook idempotency on volatile Redis (lost on restart, 24h TTL < Stripe's 72h retry) | `payments/views.py:170-177` | **FIXED** PR #7 — TTL extended to 72h |
| M6 | BrowsableAPI enabled in production | `config/settings.py:200-213` | **FIXED** PR #6 — conditional on DEBUG |
| M7 | Payment/Refund list views have no pagination | `payments/views.py:484-518` | **ALREADY FIXED** — DEFAULT_PAGINATION_CLASS in settings |
| M8 | PaymentSerializer N+1 on booking relation | `payments/serializers.py:35-39` | **FIXED** PR #6 — select_related |
| M9 | `date.fromisoformat` crashes on invalid input (public endpoint) | `bookings/views.py:424-432` | **FIXED** PR #6 — try/except ValueError |
| M10 | Stripe webhook returns 404/500 instead of 200 (causes unwanted retries) | `payments/views.py:280-296` | **FIXED** PR #6 — Celery async dispatch always returns 200 |

### MINOR

| ID | Finding | Files |
|----|---------|-------|
| L1 | `StaffAction.log_action` called with invalid `action_type` `'view_booking'` | `accounts/views.py:495` — **FIXED** PR #5 |
| L2 | `sync_onfleet_status` is a stub that doesn't actually sync | `logistics/views.py:46-79` | **DOCUMENTED** PR #7 — TODO docstring + response message |
| L3 | Dead `try/except DoesNotExist` on `.filter().first()` calls | `bookings/models.py`, `bookings/views.py`, `bookings/serializers.py` | **FIXED** PR #7 |
| L4 | `_get_most_used_address` ignores `address_type` parameter | `customers/booking_views.py:322-323` | **DOCUMENTED** PR #6 — SavedAddress has no address_type field |
| L5 | `CustomerBookingListView` returns soft-deleted bookings | `customers/views.py:351-352` | **FIXED** PR #6 — filter deleted_at__isnull=True |
| L6 | Duplicate `BookingData`/`BookingAddress` type definitions | `frontend/src/types/index.ts`, `frontend/src/stores/booking-store.ts` | DEFERRED — risky refactor, no security benefit |
| L7 | Console.log throughout production frontend code | Multiple frontend files | **ALREADY FIXED** — next.config removeConsole strips in prod |
| L8 | `useRecalculatePricing` stale closure (empty dependency array) | `frontend/src/components/booking/review-payment-step.tsx:128-189` | **FIXED** PR #7 — useRef pattern |
| L9 | Refund modal doesn't account for prior partial refunds (client-side only) | `frontend/src/components/staff/refund-modal.tsx:47-54` | **FIXED** PR #6 — shows remaining refundable amount |
| L10 | Floating-point arithmetic for monetary dollar calculations | Multiple `*_dollars` properties | DEFERRED — risky refactor, no security benefit |
| L11 | No search debounce on booking/customer management | `frontend/src/components/staff/booking-management.tsx:124-125` | **FIXED** PR #6 — 300ms useDebounce hook |
| L12 | Duplicate view classes across `customers/views.py` and `customers/booking_views.py` | Both files | DEFERRED — risky refactor, no security benefit |
| L13 | `CustomerNotesUpdateView` in customers app has no audit logging (unlike accounts version) | `customers/views.py:375-398` | **FIXED** PR #7 — StaffAction audit log |
| L14 | Booking wizard auto-skip step 4 fragile pattern | `frontend/src/components/booking/booking-wizard.tsx:86-91` | **FIXED** PR #7 — removed redundant useEffect |
| L15 | `401` response interceptor clears both auth stores on any 401 | `frontend/src/lib/api-client.ts:64-87` — **FIXED** (scoped to matching store) |
| L16 | `CustomerProfile.add_booking_stats` no concurrency protection (needs F() expressions) | `customers/models.py:141-146` — **FIXED** PR #5 |
| L17 | Signal-based Onfleet task creation runs on every `Booking.save()` | `logistics/models.py:181-205` | **FIXED** PR #7 — scoped to status transitions |
| L18 | `SECRET_KEY` has insecure default fallback | `config/settings.py:25` — **FIXED** PR #5 |
| L19 | Password reset doesn't invalidate previous tokens | `customers/views.py:484-525`, `customers/models.py:41-73` | **FIXED** PR #6 — invalidate old tokens on new request |
| L20 | Session ID logged in plaintext (partial, 10 chars) | `customers/authentication.py:32-50` | **FIXED** PR #7 — masked to 4 chars + *** |

### Positive Security Controls (Already Done Right)
- Stripe webhook signature verification (properly implemented)
- Server-side pricing calculation (frontend prices never trusted)
- Rate limiting on auth endpoints (login, register, password reset)
- No raw SQL anywhere (ORM only, no injection risk)
- Security headers in production (HSTS, XSS filter, content-type nosniff)
- Sentry PII protection (`send_default_pii=False`)
- Email verification required for new accounts
- Comprehensive audit logging for staff actions
- Hybrid account prevention (can't be both staff and customer)
- Django password validation suite enabled
- Soft deletion with proper filtering
- CORS properly restricted

---

## Existing Test Coverage

### What's Well Covered
| Area | Files | Cases | Notes |
|------|-------|-------|-------|
| Booking pricing | `test_pricing.py`, `test_booking_flow.py` | ~12 | All package types, surcharges, specialty items |
| Payment flow | `test_stripe.py`, `test_stripe_integration.py`, `test_refunds.py` | ~12 | PI creation, confirmation, refunds, errors |
| Onfleet tasks | `test_task_creation.py` | ~30 | Task creation, state mapping, phone formatting, signals |
| Onfleet webhooks | `test_webhooks.py` | ~15 | All 8 trigger types, error handling, backward compat |
| Logistics views | `test_views.py` | ~23 | Staff endpoints, auth checks, CRUD |
| Customer auth | `test_api.py` | ~16 | Registration, login, password reset, email verification |
| Auth security | `test_security.py` | ~3 | Hybrid account prevention, role isolation |
| Emails | `test_emails.py` | ~12 | 6 email types, content validation, idempotency |
| Celery tasks | `test_tasks.py` | ~6 | Reminder logic, date filtering, status filtering |
| Frontend E2E | 8 Playwright files | ~32 | Booking wizard flows, pricing display, validation |

### Critical Gaps (Need Tests Before Fixing)
| Gap | Relevant Findings | Priority |
|-----|-------------------|----------|
| Payment amount verification (PI amount vs booking total) | C1, C2 | CRITICAL |
| PaymentIntent reuse prevention | C2 | CRITICAL |
| Onfleet webhook signature verification | C3 | CRITICAL |
| Concurrent booking number generation | C4 | CRITICAL |
| Customer stats double-counting | C5 | CRITICAL |
| Staff role-based permissions | H3 | HIGH |
| Public endpoint data exposure | H1, H2 | HIGH |
| Booking status validation | H5 | HIGH |
| `lock_account` functionality | H4 | HIGH |

---

## Fix Plan by PR

### PR 1: Critical Security Fixes
**Branch:** `fix/critical-security`
**Priority:** Ship ASAP
**Estimated scope:** ~10 files changed

#### Fixes Included:
1. **C1 + C2: Payment flow integrity**
   - Add amount verification: after retrieving PI from Stripe, assert `payment_intent.amount == booking.calculate_total()` before marking paid
   - Add PI reuse check: query for existing booking with same `payment_intent_id`, reject if found
   - Create Payment record for guest bookings (currently missing)
   - Files: `bookings/views.py`, `customers/booking_views.py`

2. **C3: Onfleet webhook authentication**
   - Implement HMAC signature verification using `ONFLEET_WEBHOOK_SECRET` from settings
   - Return 401 on invalid/missing signature
   - File: `logistics/views.py`

3. **H1 + H2: Public endpoint lockdown**
   - `CalendarAvailabilityView`: strip PII (remove customer names, prices, booking IDs) — return only date + slot count for public use
   - `BookingStatusView`: require auth OR add a non-guessable token (e.g., UUID lookup instead of sequential booking number)
   - `PaymentStatusView`: same treatment
   - Files: `bookings/views.py`, `bookings/serializers.py`

4. **H8: Error message sanitization**
   - Replace `str(e)` in all API responses with generic messages
   - Keep detailed errors in server logs only
   - Files: `payments/views.py`, `bookings/views.py`, `logistics/views.py`, `customers/booking_views.py`

#### Tests to Write:
```
test_payment_security.py
- test_booking_rejected_when_pi_amount_mismatches_total
- test_booking_rejected_when_pi_already_used
- test_guest_booking_creates_payment_record
- test_payment_amount_matches_booking_after_surcharges

test_webhook_auth.py
- test_onfleet_webhook_rejects_missing_signature
- test_onfleet_webhook_rejects_invalid_signature
- test_onfleet_webhook_accepts_valid_signature

test_public_endpoints.py
- test_calendar_does_not_expose_customer_names
- test_calendar_does_not_expose_booking_ids
- test_booking_status_requires_auth_or_token
- test_payment_status_requires_auth_or_token
- test_sequential_booking_numbers_not_enumerable

test_error_responses.py
- test_payment_error_does_not_leak_stripe_details
- test_booking_error_does_not_leak_db_schema
```

#### Existing Tests to Verify Still Pass:
- `test_stripe.py` (all)
- `test_stripe_integration.py` (all)
- `test_booking_flow.py` (all)
- `test_webhooks.py` (all)
- `test_task_creation.py` (all)

---

### PR 2: Auth, Permissions & State Integrity
**Branch:** `fix/auth-permissions`
**Priority:** Important — fix within one sprint
**Estimated scope:** ~8 files changed

#### Fixes Included:
1. **H3: Staff role enforcement**
   - Create `IsStaffMember` and `IsAdminStaff` DRF permission classes
   - Apply `IsAdminStaff` to refund processing, report generation
   - Apply `IsStaffMember` to all other staff views
   - Replace all `hasattr(request.user, 'staff_profile')` ad-hoc checks
   - Files: new `accounts/permissions.py`, `accounts/views.py`, `payments/views.py`, `logistics/views.py`

2. **H4: Fix broken `lock_account`**
   - Change `timezone.timedelta` to `timedelta` (from `datetime import timedelta`)
   - File: `accounts/models.py`

3. **H5: Booking status validation**
   - Validate `new_status in dict(Booking.STATUS_CHOICES)` before saving
   - File: `accounts/views.py`

4. **H6: CSRF enforcement in HybridAuthentication**
   - Add `self.enforce_csrf(request)` call for cookie-based auth path
   - File: `customers/authentication.py`

5. **C4: Booking number race condition**
   - Replace manual counter with DB sequence or atomic `SELECT FOR UPDATE`
   - Add retry logic for `IntegrityError` on `booking_number`
   - File: `bookings/models.py`

6. **C5: Double-counting customer stats**
   - Remove stat increment from `confirm_payment()` — keep only in `_mark_booking_completed()`
   - Use `F()` expressions for atomic updates (also fixes L16)
   - Files: `payments/services.py`, `logistics/models.py`, `customers/models.py`

7. **L1: Fix invalid `StaffAction` action type**
   - Add `'view_booking'` to `ACTION_TYPES`
   - File: `accounts/models.py`

8. **L18: Remove insecure SECRET_KEY default**
   - Remove default value, require env var
   - File: `config/settings.py`

#### Tests to Write:
```
test_staff_permissions.py
- test_staff_role_cannot_process_refunds
- test_admin_role_can_process_refunds
- test_staff_role_cannot_access_reports (if desired)
- test_admin_role_can_access_reports

test_account_lockout.py
- test_lock_account_sets_locked_until
- test_locked_account_rejects_login
- test_lock_expires_after_duration

test_booking_status_validation.py
- test_invalid_status_rejected
- test_valid_status_transitions_allowed

test_booking_number_concurrency.py
- test_concurrent_booking_creation_no_duplicates

test_customer_stats.py
- test_stats_incremented_once_not_twice_on_completion
- test_concurrent_stat_updates_use_f_expressions
```

#### Existing Tests to Verify Still Pass:
- `test_security.py` (all)
- `test_api.py` (all customer auth)
- `test_booking_flow.py` (all)
- `test_refunds.py` (all)
- `test_views.py` (logistics staff endpoints)

---

### PR 3: Performance & Code Quality
**Branch:** `fix/performance-cleanup`
**Priority:** No security risk — ship when ready
**Estimated scope:** ~15 files changed

#### Fixes Included:
1. **M2: Calendar N+1 queries** — prefetch surcharge rules, single booking query with date range
2. **M3: Customer management N+1** — add `prefetch_related('bookings', 'saved_addresses')`
3. **M4: Pricing recalc on every save** — only recalculate when pricing-relevant fields change
4. **M6: Disable BrowsableAPI in production** — wrap in `if DEBUG`
5. **M7: Add pagination to payment/refund list views**
6. **M8: PaymentSerializer N+1** — add `select_related('booking', 'booking__customer')`
7. **M9: `date.fromisoformat` error handling** — add try/except with 400 response
8. **M10: Stripe webhook return 200 always** — match Onfleet pattern
9. **H7: Move webhook retry to Celery** — replace `time.sleep()` with async task
10. **L5: Filter soft-deleted bookings in CustomerBookingListView**
11. **L7: Strip console.log from production frontend** — or gate behind `NODE_ENV`
12. **L11: Add search debounce** — 300ms on booking/customer management search inputs
13. **L4: Fix `_get_most_used_address`** — use `address_type` parameter
14. **L9: Refund modal partial refund awareness** — check remaining refundable amount
15. **L19: Invalidate previous password reset tokens**

#### Tests (Light):
- Verify existing pricing tests still pass after M4
- Verify existing payment tests still pass after M10
- Manual smoke test booking flow after M4 changes

---

## Deployment Strategy

### Pre-Deploy
- [ ] All existing tests pass (`pytest` backend, `npx playwright test` frontend)
- [ ] New tests pass for the PR being deployed
- [ ] Manual smoke test of booking flow locally

### PR 1 Deployment (Critical Security)
1. Deploy to staging (Fly.io staging app)
2. Smoke test:
   - Create a test booking — verify payment amount is checked
   - Try to reuse a PaymentIntent — verify rejection
   - Hit `/api/public/availability/` — verify no PII in response
   - Hit `/api/public/booking-status/TT-000001/` — verify blocked or stripped
   - Send fake POST to Onfleet webhook — verify 401
3. Deploy to production during low traffic
4. Post-deploy: create a real test booking with test card, refund it
5. Monitor Sentry for 1 hour

### PR 2 Deployment (Auth & Permissions)
1. Deploy to staging
2. Smoke test:
   - Log in as staff (non-admin) — verify refund endpoint returns 403
   - Log in as admin — verify refund works
   - Create booking — verify booking number generated correctly
   - Fail login 5 times — verify account locks
3. Deploy to production
4. Monitor Sentry

### PR 3 Deployment (Performance)
1. Deploy to staging
2. Smoke test:
   - Load staff dashboard — verify speed improvement
   - Create a booking — verify pricing unchanged
   - Check Stripe webhook handling still works
3. Deploy to production
4. Monitor Sentry + check response times

### Rollback Plan
```bash
# Check recent releases
fly releases -a totetaxi

# Roll back to previous release
fly deploy --image <previous-image> -a totetaxi
```
If anything breaks: revert first, debug second.

---

## Verification Checklist

After all PRs are merged and deployed:

- [ ] Re-run code-reviewer agent scoped to changed files
- [ ] Re-run ecommerce-security agent scoped to payment + auth + webhook files
- [ ] Cross-reference new findings against this document
- [ ] Update finding statuses (open -> fixed)
- [ ] All existing tests still pass
- [ ] All new tests pass
- [ ] Production smoke test: full booking + payment + delivery flow
- [ ] Sentry clean for 24 hours post-deploy

---

## Session Notes

### Test Infrastructure Available
- Backend: pytest + pytest-django + factory-boy + faker
- Frontend: Playwright (Chromium, E2E)
- Stripe: Test mode keys available, mock PaymentIntent in tests
- Onfleet: Mock mode built in, conftest forces mock in test env
- Emails: Django test mail.outbox

### Tests That Already Exist (Don't Rewrite)
- Pricing calculation (all package types, surcharges)
- Payment intent creation + confirmation
- Refund processing (full + partial)
- Onfleet task creation + webhook handling
- Customer auth (register, login, verify, reset)
- Email sending + content
- Celery reminder tasks

### Tests to Write (New)
- Payment amount mismatch rejection
- PaymentIntent reuse rejection
- Onfleet webhook signature verification
- Staff role-based access control
- Public endpoint PII stripping
- Account lockout functionality
- Booking status validation
- Concurrent booking number generation
- Customer stats single-count verification
- Error response sanitization
```


============================================================
  BACKEND
============================================================

# ──── backend/Dockerfile ────

```
# backend/Dockerfile
FROM python:3.11-slim

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app \
    PORT=8000

# Set work directory
WORKDIR /app

# Install system dependencies
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        postgresql-client \
        build-essential \
        libpq-dev \
        curl \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
COPY requirements.txt /app/
RUN pip install --no-cache-dir -r requirements.txt

# Copy project
COPY . /app/

# Create directories for logs and static files
RUN mkdir -p /app/logs /app/staticfiles /app/media

# Make entrypoint executable
RUN chmod +x /app/scripts/entrypoint.sh

# Collect static files
RUN python manage.py collectstatic --no-input --clear || echo "Collectstatic skipped"

# Expose port
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
  CMD curl -f http://localhost:8000/admin/ || exit 1

# Run entrypoint
ENTRYPOINT ["/app/scripts/entrypoint.sh"]
CMD ["gunicorn", "config.wsgi:application", "--bind", "0.0.0.0:8000", "--workers", "2", "--timeout", "120"]
```

# ──── backend/Dockerfile.prod ────

```
# backend/Dockerfile.prod
FROM python:3.11-slim as builder

# Build dependencies
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir --user -r requirements.txt

# Production stage
FROM python:3.11-slim

# Create non-root user for security
RUN adduser --disabled-password --gecos '' appuser

# Copy dependencies from builder stage
COPY --from=builder /root/.local /home/appuser/.local

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PATH=/home/appuser/.local/bin:$PATH \
    PYTHONPATH=/app

# Install only essential system dependencies
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        postgresql-client \
        curl \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get purge -y --auto-remove

# Set work directory
WORKDIR /app

# Copy project files
COPY --chown=appuser:appuser . /app/

# Create necessary directories with proper permissions
RUN mkdir -p /app/logs /app/staticfiles /app/media \
    && chown -R appuser:appuser /app

# Switch to non-root user
USER appuser

# Collect static files (allow failure during build, will run again at deploy)
RUN python manage.py collectstatic --no-input || true

EXPOSE 8000

# Use production-ready entrypoint
ENTRYPOINT ["/app/scripts/entrypoint.sh"]

# Default to Gunicorn with optimized worker configuration
CMD ["gunicorn", "config.wsgi:application", "--bind", "0.0.0.0:8000", "--workers", "4", "--worker-class", "sync", "--max-requests", "1000", "--max-requests-jitter", "100"]
```

# ──── backend/docker-compose.prod.yml ────

```yaml
# backend/docker-compose.prod.yml
name: totetaxi-production

services:
  # PostgreSQL Database - Internal only for security
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: ${DB_NAME:-totetaxi}
      POSTGRES_USER: ${DB_USER:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_INITDB_ARGS: "--auth-host=scram-sha-256"
    volumes:
      - postgres_data:/var/lib/postgresql/data/
      - ./postgresql.conf:/etc/postgresql/postgresql.conf:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-postgres}"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - internal
    restart: unless-stopped
    # No external ports - database is internal only

  # Redis for Celery - Internal only with authentication
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD} --maxmemory 256mb --maxmemory-policy allkeys-lru
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - internal
    restart: unless-stopped

  # Django Backend with Gunicorn
  web:
    build:
      context: .
      dockerfile: Dockerfile.prod
    command: gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 4 --worker-class sync --max-requests 1000 --access-logfile - --error-logfile -
    volumes:
      - static_volume:/app/staticfiles:ro
      - media_volume:/app/media
      - logs_volume:/app/logs
    ports:
      - "8005:8000"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - .env.production
    environment:
      - DATABASE_URL=postgres://${DB_USER:-postgres}:${DB_PASSWORD}@db:5432/${DB_NAME:-totetaxi}?sslmode=prefer
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
    networks:
      - internal
      - external
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # Celery Worker
  celery:
    build:
      context: .
      dockerfile: Dockerfile.prod
    command: celery -A config worker -l info --concurrency 4 --max-tasks-per-child 1000
    volumes:
      - logs_volume:/app/logs
      - media_volume:/app/media
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - .env.production
    environment:
      - DATABASE_URL=postgres://${DB_USER:-postgres}:${DB_PASSWORD}@db:5432/${DB_NAME:-totetaxi}?sslmode=prefer
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
    networks:
      - internal
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M

  # Celery Beat Scheduler
  celery-beat:
    build:
      context: .
      dockerfile: Dockerfile.prod
    command: celery -A config beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    volumes:
      - logs_volume:/app/logs
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - .env.production
    environment:
      - DATABASE_URL=postgres://${DB_USER:-postgres}:${DB_PASSWORD}@db:5432/${DB_NAME:-totetaxi}?sslmode=prefer
      - REDIS_URL=redis://:${REDIS_PASSWORD}@redis:6379/0
    networks:
      - internal
    restart: unless-stopped

volumes:
  postgres_data:
    driver: local
  static_volume:
    driver: local
  media_volume:
    driver: local
  redis_data:
    driver: local
  logs_volume:
    driver: local

networks:
  internal:
    driver: bridge
    internal: true
  external:
    driver: bridge
```

# ──── backend/docker-compose.yml ────

```yaml
name: totetaxi-backend

services:
  # PostgreSQL Database - PORT 5435
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: totetaxi
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5435:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis for Celery - PORT 6382
  redis:
    image: redis:7-alpine
    ports:
      - "6382:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Django Backend - PORT 8005
  web:
    build: .
    command: python manage.py runserver 0.0.0.0:8000
    volumes:
      - .:/app
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    ports:
      - "8005:8000"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - DEBUG=True
      - DATABASE_URL=postgres://postgres:postgres@db:5432/totetaxi
      - REDIS_URL=redis://redis:6379/0

  # Celery Worker
  celery:
    build: .
    command: celery -A config worker -l info
    volumes:
      - .:/app
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - DEBUG=True
      - DATABASE_URL=postgres://postgres:postgres@db:5432/totetaxi
      - REDIS_URL=redis://redis:6379/0

  # Celery Beat Scheduler
  celery-beat:
    build: .
    command: celery -A config beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    volumes:
      - .:/app
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    env_file:
      - .env
    environment:
      - DEBUG=True
      - DATABASE_URL=postgres://postgres:postgres@db:5432/totetaxi
      - REDIS_URL=redis://redis:6379/0

volumes:
  postgres_data:
  static_volume:
  media_volume:
  redis_data:
```

# ──── backend/fly.toml ────

```toml
app = 'totetaxi-backend'
primary_region = 'ewr'

[build]
  dockerfile = 'Dockerfile.prod'

[deploy]
  release_command = "python manage.py migrate --noinput"

[env]
  DEBUG = "False"
  DJANGO_LOG_LEVEL = "INFO"
  DJANGO_SETTINGS_MODULE = 'config.settings'
  PORT = '8000'
  PYTHONUNBUFFERED = '1'
  PYTHONPATH = '/app'

# ✅ MULTI-PROCESS CONFIGURATION
[processes]
  web = "gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 4"
  worker = "celery -A config worker -l info --concurrency 2"
  beat = "celery -A config beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler"

[http_service]
  internal_port = 8000
  force_https = true
  auto_stop_machines = false
  auto_start_machines = true
  min_machines_running = 1
  processes = ['web']  # Only web handles HTTP traffic

  [http_service.concurrency]
    type = 'requests'
    hard_limit = 200
    soft_limit = 100

# ✅ MACHINE CONFIGURATION - Separate for each process
[[vm]]
  memory = '1gb'
  cpu_kind = 'shared'
  cpus = 1
  processes = ['web']

[[vm]]
  memory = '512mb'
  cpu_kind = 'shared'
  cpus = 1
  processes = ['worker']

[[vm]]
  memory = '256mb'
  cpu_kind = 'shared'
  cpus = 1
  processes = ['beat']

[[statics]]
  guest_path = "/app/staticfiles"
  url_prefix = "/static/"
```

# ──── backend/gunicorn.conf.py ────

```python
import multiprocessing

# Server socket
bind = "0.0.0.0:8000"
backlog = 2048

# Worker processes
workers = multiprocessing.cpu_count() * 2 + 1
worker_class = "sync"
worker_connections = 1000
timeout = 30
keepalive = 2
max_requests = 1000
max_requests_jitter = 100

# Logging
accesslog = "-"
errorlog = "-"
loglevel = "info"

# Process naming
proc_name = "totetaxi"

# Server mechanics
preload_app = True
pidfile = "/tmp/gunicorn.pid"
```

# ──── backend/manage.py ────

```python
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()
```

# ──── backend/pyproject.toml ────

```toml
[build-system]
requires = ["setuptools>=61.0", "wheel"]
build-backend = "setuptools.build_meta"

[project]
name = "totetaxi-backend"
version = "0.1.0"
description = "ToteTaxi luxury delivery service backend API"
requires-python = ">=3.11"

[tool.black]
line-length = 88
target-version = ['py311']
include = '\.pyi?$'
extend-exclude = '''
/(
  migrations
)/
'''

[tool.isort]
profile = "black"
multi_line_output = 3
line_length = 88
skip_glob = ["**/migrations/*.py"]

[tool.coverage.run]
source = "."
omit = [
    "*/migrations/*",
    "*/venv/*",
    "*/tests/*",
    "manage.py",
    "config/wsgi.py",
    "config/asgi.py",
]
```

# ──── backend/requirements.txt ────

```
# Django Core - Latest LTS with full compatibility
Django==5.2.5
djangorestframework==3.16.1
django-cors-headers==4.6.0
django-environ==0.11.2

# Database
psycopg2-binary==2.9.9
dj-database-url==2.1.0

# Authentication & Security
djangorestframework-simplejwt==5.3.0
django-allauth==0.63.6
django-ipware==7.0.1

# API Documentation
drf-yasg==1.21.7

# Background Jobs - Latest stable versions
celery==5.5.3
redis==5.1.1
django-celery-beat==2.8.1

# File Storage
boto3==1.35.19
django-storages==1.14.4
Pillow==10.4.0

# Integrations - Latest versions
stripe==12.4.0
requests==2.32.3

# Monitoring & Logging
sentry-sdk==2.13.0

# Development
django-debug-toolbar==4.4.6
django-extensions==3.2.3

# Testing (Updated October 2025)
pytest==8.3.3
pytest-django==4.9.0
pytest-cov==5.0.0
factory-boy==3.3.1
faker==30.8.2
freezegun==1.5.1

# Production Server
gunicorn==23.0.0
whitenoise==6.7.0

# Rate Limiting & Caching
django-ratelimit==4.1.0
django-redis==5.4.0
```

# ──── backend/apps/accounts/admin.py ────

```python
from django.contrib import admin
from django.core.exceptions import ValidationError
from django.contrib import messages
from .models import StaffProfile, StaffAction


@admin.register(StaffProfile)
class StaffProfileAdmin(admin.ModelAdmin):
    list_display = ('user', 'user_email', 'role', 'department', 'can_approve_refunds', 'can_manage_staff', 'is_active', 'created_at')
    list_filter = ('role', 'department', 'is_active', 'created_at')
    search_fields = ('user__username', 'user__email', 'user__first_name', 'user__last_name')
    readonly_fields = ('can_approve_refunds', 'can_manage_staff', 'can_view_financial_reports', 'is_account_locked', 'created_at', 'updated_at')
    
    fieldsets = (
        ('User Information', {
            'fields': ('user', 'role', 'department', 'phone')
        }),
        ('Permissions', {
            'fields': ('can_approve_refunds', 'can_manage_staff', 'can_view_financial_reports'),
            'classes': ('collapse',)
        }),
        ('Security', {
            'fields': ('login_attempts', 'account_locked_until', 'is_account_locked', 'last_login_ip'),
            'classes': ('collapse',)
        }),
        ('Management', {
            'fields': ('is_active', 'hire_date', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )
    
    def user_email(self, obj):
        return obj.user.email
    user_email.short_description = 'Email'
    user_email.admin_order_field = 'user__email'
    
    def save_model(self, request, obj, form, change):
        try:
            super().save_model(request, obj, form, change)
        except ValidationError as e:
            messages.error(request, f"Cannot save staff profile: {e}")
            raise
    
    def get_queryset(self, request):
        return super().get_queryset(request).select_related('user')


@admin.register(StaffAction)
class StaffActionAdmin(admin.ModelAdmin):
    list_display = ('staff_user', 'action_type', 'created_at', 'ip_address', 'customer_id', 'booking_id')
    list_filter = ('action_type', 'created_at')
    search_fields = ('staff_user__username', 'staff_user__email', 'description', 'ip_address')
    readonly_fields = ('staff_user', 'action_type', 'description', 'ip_address', 'user_agent', 'customer_id', 'booking_id', 'created_at')
    ordering = ('-created_at',)
    
    def has_add_permission(self, request):
        # Staff actions should only be created programmatically
        return False
    
    def has_change_permission(self, request, obj=None):
        # Staff actions should be immutable audit logs
        return False
    
    def get_queryset(self, request):
        return super().get_queryset(request).select_related('staff_user')
```

# ──── backend/apps/accounts/apps.py ────

```python
from django.apps import AppConfig

class AccountsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'apps.accounts'  # Changed from 'accounts' to 'apps.accounts'
```

# ──── backend/apps/accounts/models.py ────

```python
import uuid
from django.contrib.auth.models import User
from django.db import models
from django.core.exceptions import ValidationError
from django.utils import timezone


class StaffProfile(models.Model):
    """Extended profile for staff users (Django User model + additional fields)"""
    
    ROLE_CHOICES = [
        ('staff', 'Staff'),
        ('admin', 'Admin'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='staff_profile')
    
    # Staff role within the staff system
    role = models.CharField(max_length=20, choices=ROLE_CHOICES, default='staff')
    
    # Staff-specific information
    department = models.CharField(max_length=50, blank=True)
    hire_date = models.DateField(null=True, blank=True)
    phone = models.CharField(max_length=20, blank=True)
    
    # Permissions tracking
    last_login_ip = models.GenericIPAddressField(null=True, blank=True)
    login_attempts = models.PositiveIntegerField(default=0)
    account_locked_until = models.DateTimeField(null=True, blank=True)
    
    # Management
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'accounts_staff_profile'
        verbose_name = 'Staff Profile'
        verbose_name_plural = 'Staff Profiles'
    
    def clean(self):
        """Prevent hybrid accounts - users cannot have both staff and customer profiles"""
        if self.user and hasattr(self.user, 'customer_profile'):
            raise ValidationError(
                f"User {self.user.email} already has a customer profile. "
                "Users cannot have both staff and customer profiles."
            )
    
    def save(self, *args, **kwargs):
        self.full_clean()
        super().save(*args, **kwargs)
    
    def __str__(self):
        return f"{self.user.get_full_name()} ({self.role})"
    
    @property
    def can_approve_refunds(self):
        """Only admin role can approve refunds"""
        return self.role == 'admin'
    
    @property
    def can_manage_staff(self):
        """Only admin role can manage other staff accounts"""
        return self.role == 'admin'
    
    @property
    def can_view_financial_reports(self):
        """Both staff and admin can view financial reports"""
        return self.role in ['staff', 'admin']
    
    @property
    def full_name(self):
        """Get full name from associated User model"""
        return self.user.get_full_name()
    
    @property
    def email(self):
        """Get email from associated User model"""
        return self.user.email
    
    def lock_account(self, minutes=30):
        """Lock account for specified minutes after failed login attempts"""
        self.account_locked_until = timezone.now() + timezone.timedelta(minutes=minutes)
        self.save()
    
    def unlock_account(self):
        """Unlock account and reset login attempts"""
        self.account_locked_until = None
        self.login_attempts = 0
        self.save()
    
    @property
    def is_account_locked(self):
        """Check if account is currently locked"""
        if self.account_locked_until:
            return timezone.now() < self.account_locked_until
        return False

    @classmethod
    def ensure_single_profile_type(cls, user):
        """Ensure user only has one type of profile"""
        if hasattr(user, 'staff_profile') and hasattr(user, 'customer_profile'):
            raise ValidationError(
                f"User {user.email} cannot have both staff and customer profiles. "
                "Please remove one profile type."
            )


class StaffAction(models.Model):
    """Audit log for staff actions - required for compliance"""
    
    ACTION_TYPES = [
        ('login', 'Login'),
        ('logout', 'Logout'),
        ('view_customer', 'View Customer'),
        ('modify_booking', 'Modify Booking'),
        ('process_refund', 'Process Refund'),
        ('approve_refund', 'Approve Refund'),
        ('upload_document', 'Upload Document'),
        ('send_notification', 'Send Notification'),
        ('export_data', 'Export Data'),
        ('view_dashboard', 'View Dashboard'),
        ('view_booking', 'View Booking'),
        ('modify_customer', 'Modify Customer'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Who performed the action
    staff_user = models.ForeignKey(User, on_delete=models.PROTECT, related_name='staff_actions')
    
    # What action was performed
    action_type = models.CharField(max_length=30, choices=ACTION_TYPES)
    description = models.TextField()
    
    # Context information
    ip_address = models.GenericIPAddressField()
    user_agent = models.TextField(blank=True)
    
    # Related objects (for tracking what was accessed/modified)
    customer_id = models.UUIDField(null=True, blank=True, help_text="Customer affected by action")
    booking_id = models.UUIDField(null=True, blank=True, help_text="Booking affected by action")
    
    # Timing
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'accounts_staff_action'
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['staff_user', '-created_at']),
            models.Index(fields=['action_type', '-created_at']),
            models.Index(fields=['customer_id']),
            models.Index(fields=['booking_id']),
        ]
    
    def __str__(self):
        return f"{self.staff_user.username} - {self.action_type} - {self.created_at}"
    
    @classmethod
    def log_action(cls, staff_user, action_type, description, request=None, customer_id=None, booking_id=None):
        """Helper method to log staff actions with proper IP detection"""
        ip_address = '127.0.0.1'  # default fallback
        user_agent = ''
        
        if request:
            # Get client IP from request
            x_forwarded_for = request.META.get('HTTP_X_FORWARDED_FOR')
            if x_forwarded_for:
                ip_address = x_forwarded_for.split(',')[0].strip()
            else:
                ip_address = request.META.get('REMOTE_ADDR', '127.0.0.1')
            
            user_agent = request.META.get('HTTP_USER_AGENT', '')
        
        return cls.objects.create(
            staff_user=staff_user,
            action_type=action_type,
            description=description,
            ip_address=ip_address,
            user_agent=user_agent,
            customer_id=customer_id,
            booking_id=booking_id
        )
```

# ──── backend/apps/accounts/permissions.py ────

```python
from rest_framework.permissions import BasePermission


class IsStaffMember(BasePermission):
    """Allow access only to users with a staff_profile (any role)."""

    def has_permission(self, request, view):
        return (
            request.user
            and request.user.is_authenticated
            and hasattr(request.user, 'staff_profile')
        )


class IsAdminStaff(BasePermission):
    """Allow access only to staff users with admin role."""

    def has_permission(self, request, view):
        return (
            request.user
            and request.user.is_authenticated
            and hasattr(request.user, 'staff_profile')
            and request.user.staff_profile.role == 'admin'
        )
```

# ──── backend/apps/accounts/serializers.py ────

```python
from rest_framework import serializers
from django.contrib.auth.models import User
from django.core.exceptions import ValidationError
from .models import StaffProfile, StaffAction


class StaffUserSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = ('id', 'username', 'email', 'first_name', 'last_name', 'is_active', 'date_joined')
        read_only_fields = ('id', 'date_joined')


class StaffProfileSerializer(serializers.ModelSerializer):
    user = StaffUserSerializer(read_only=True)
    full_name = serializers.ReadOnlyField()
    email = serializers.ReadOnlyField()
    can_approve_refunds = serializers.ReadOnlyField()
    can_manage_staff = serializers.ReadOnlyField()
    can_view_financial_reports = serializers.ReadOnlyField()
    
    class Meta:
        model = StaffProfile
        fields = (
            'id', 'user', 'role', 'department', 'hire_date', 'phone',
            'full_name', 'email', 'is_active', 'can_approve_refunds',
            'can_manage_staff', 'can_view_financial_reports', 'created_at'
        )
        read_only_fields = ('id', 'created_at')


class StaffLoginSerializer(serializers.Serializer):
    username = serializers.CharField()
    password = serializers.CharField(write_only=True)
    
    def validate(self, attrs):
        username = attrs.get('username')
        password = attrs.get('password')
        
        if not username or not password:
            raise serializers.ValidationError("Must include username and password")
        
        return attrs


class StaffActionSerializer(serializers.ModelSerializer):
    staff_user_name = serializers.SerializerMethodField()
    
    class Meta:
        model = StaffAction
        fields = (
            'id', 'action_type', 'description', 'staff_user_name',
            'ip_address', 'customer_id', 'booking_id', 'created_at'
        )
        read_only_fields = ('id', 'created_at')
    
    def get_staff_user_name(self, obj):
        return obj.staff_user.get_full_name() if obj.staff_user else None


class StaffCreateSerializer(serializers.Serializer):
    """Serializer for creating staff accounts with hybrid prevention"""
    username = serializers.CharField(max_length=150)
    email = serializers.EmailField()
    password = serializers.CharField(min_length=8, write_only=True)
    first_name = serializers.CharField(max_length=150)
    last_name = serializers.CharField(max_length=150)
    role = serializers.ChoiceField(choices=StaffProfile.ROLE_CHOICES)
    department = serializers.CharField(max_length=50, required=False, allow_blank=True)
    phone = serializers.CharField(max_length=20, required=False, allow_blank=True)
    
    def validate(self, attrs):
        # Check if email already exists
        if User.objects.filter(email__iexact=attrs['email']).exists():
            existing_user = User.objects.get(email__iexact=attrs['email'])
            if hasattr(existing_user, 'customer_profile'):
                raise serializers.ValidationError("This email is already registered as a customer account. Please use a different email.")
            else:
                raise serializers.ValidationError("User with this email already exists")
        
        # Check if username already exists
        if User.objects.filter(username=attrs['username']).exists():
            raise serializers.ValidationError("Username already exists")
        
        return attrs
    
    def create(self, validated_data):
        # Extract staff profile fields
        role = validated_data.pop('role')
        department = validated_data.pop('department', '')
        phone = validated_data.pop('phone', '')
        
        try:
            # Create User
            user = User.objects.create_user(**validated_data)
            
            # Create StaffProfile with validation
            StaffProfile.objects.create(
                user=user,
                role=role,
                department=department,
                phone=phone
            )
            
            return user
            
        except ValidationError as e:
            # Clean up user if profile creation fails
            if 'user' in locals():
                user.delete()
            raise serializers.ValidationError(str(e))
```

# ──── backend/apps/accounts/urls.py ────

```python
from django.urls import path
from . import views

# Staff API patterns
urlpatterns = [
    # Authentication
    path('auth/login/', views.StaffLoginView.as_view(), name='staff-login'),
    path('auth/logout/', views.StaffLogoutView.as_view(), name='staff-logout'),
    path('csrf-token/', views.StaffCSRFTokenView.as_view(), name='staff-csrf-token'),  # ADD THIS

    
    # Dashboard and operations
    path('dashboard/', views.StaffDashboardView.as_view(), name='staff-dashboard'),
    path('bookings/', views.BookingManagementView.as_view(), name='staff-bookings'),
    path('bookings/<uuid:booking_id>/', views.BookingDetailView.as_view(), name='staff-booking-detail'),
    
    # Customer management
    path('customers/', views.CustomerManagementView.as_view(), name='staff-customers'),
    path('customers/<int:customer_id>/', views.CustomerDetailView.as_view(), name='staff-customer-detail'),
    path('customers/<int:customer_id>/notes/', views.CustomerNotesUpdateView.as_view(), name='staff-customer-notes'),

    # Reports
    path('reports/', views.StaffReportsView.as_view(), name='staff-reports'),
]
```

# ──── backend/apps/accounts/views.py ────

```python
# backend/apps/accounts/views.py
from rest_framework import generics, status, permissions
from rest_framework.decorators import api_view, permission_classes
from rest_framework.response import Response
from rest_framework.views import APIView
from django.contrib.auth import login, logout, authenticate
from django.contrib.auth.models import User
from django.middleware.csrf import get_token
from django.views.decorators.csrf import ensure_csrf_cookie
from django.utils.decorators import method_decorator
from django.shortcuts import get_object_or_404
from django.db.models import Q, Count, Prefetch
from django_ratelimit.decorators import ratelimit
from .models import StaffProfile, StaffAction
from .permissions import IsStaffMember
from .serializers import (
    StaffLoginSerializer,
    StaffProfileSerializer,
    StaffUserSerializer,
    StaffActionSerializer
)
from apps.bookings.models import Booking
from apps.customers.models import CustomerProfile
from apps.payments.models import Payment, Refund
from apps.payments.serializers import RefundSerializer


@method_decorator(ratelimit(key='ip', rate='5/m', method='POST', block=True), name='post')
@method_decorator(ratelimit(key='header:user-agent', rate='10/m', method='POST', block=True), name='post')
@method_decorator(ensure_csrf_cookie, name='dispatch')
class StaffLoginView(APIView):
    """Staff authentication endpoint with rate limiting protection"""
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        serializer = StaffLoginSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        username = serializer.validated_data['username']
        password = serializer.validated_data['password']
        
        user = authenticate(username=username, password=password)
        
        if user and user.is_active:
            if not hasattr(user, 'staff_profile'):
                return Response(
                    {'error': 'This is not a staff account'}, 
                    status=status.HTTP_403_FORBIDDEN
                )
            
            if user.staff_profile.is_account_locked:
                return Response(
                    {'error': 'Account is temporarily locked. Contact administrator.'}, 
                    status=status.HTTP_403_FORBIDDEN
                )
            
            login(request, user)
            
            StaffAction.log_action(
                staff_user=user,
                action_type='login',
                description=f'Staff user {user.username} logged in successfully',
                request=request
            )
            
            user.staff_profile.login_attempts = 0
            user.staff_profile.save()
            
            # Ensure session is saved before getting key
            request.session.save()
            
            # Return session_id for mobile compatibility
            response = Response({
                'message': 'Login successful',
                'user': StaffUserSerializer(user).data,
                'staff_profile': StaffProfileSerializer(user.staff_profile).data,
                'session_id': request.session.session_key,
                'csrf_token': get_token(request)
            })
            
            return response
        else:
            if user:
                staff_profile = getattr(user, 'staff_profile', None)
                if staff_profile:
                    staff_profile.login_attempts += 1
                    if staff_profile.login_attempts >= 5:
                        staff_profile.lock_account(minutes=30)
                    staff_profile.save()
            
            return Response(
                {'error': 'Invalid username or password'}, 
                status=status.HTTP_401_UNAUTHORIZED
            )

@method_decorator(ratelimit(key='user', rate='10/m', method='POST', block=True), name='post')
class StaffLogoutView(APIView):
    """Staff logout endpoint with rate limiting"""
    permission_classes = [permissions.IsAuthenticated]
    
    def post(self, request):
        # Log logout action
        StaffAction.log_action(
            staff_user=request.user,
            action_type='logout',
            description=f'Staff user {request.user.username} logged out',
            request=request
        )
        
        logout(request)
        return Response({'message': 'Logout successful'})


@method_decorator(ratelimit(key='user', rate='30/m', method='GET', block=True), name='get')
class StaffDashboardView(APIView):
    """Staff operations dashboard with KPIs and rate limiting"""
    permission_classes = [IsStaffMember]

    def get(self, request):
        # Log dashboard access
        StaffAction.log_action(
            staff_user=request.user,
            action_type='view_dashboard',
            description='Accessed staff dashboard',
            request=request
        )
        
        # Get booking statistics
        total_bookings = Booking.objects.filter(deleted_at__isnull=True).count()
        pending_bookings = Booking.objects.filter(status='pending', deleted_at__isnull=True).count()
        confirmed_bookings = Booking.objects.filter(status='confirmed', deleted_at__isnull=True).count()
        paid_bookings = Booking.objects.filter(status='paid', deleted_at__isnull=True).count()
        completed_bookings = Booking.objects.filter(status='completed', deleted_at__isnull=True).count()
        
        # Get payment statistics
        total_payments = Payment.objects.filter(status='succeeded').count()
        pending_payments = Payment.objects.filter(status='pending').count()
        failed_payments = Payment.objects.filter(status='failed').count()
        
        # Calculate revenue
        from django.db.models import Sum
        total_revenue_cents = Payment.objects.filter(status='succeeded').aggregate(
            total=Sum('amount_cents')
        )['total'] or 0
        
        # Get recent bookings needing attention
        urgent_bookings = Booking.objects.filter(
            status__in=['pending', 'confirmed'],
            deleted_at__isnull=True
        ).order_by('pickup_date', 'created_at')[:10]
        
        # Get customer statistics
        total_customers = CustomerProfile.objects.count()
        vip_customers = CustomerProfile.objects.filter(is_vip=True).count()
        
        return Response({
            'staff_info': {
                'name': request.user.get_full_name(),
                'role': request.user.staff_profile.role,
                'permissions': {
                    'can_approve_refunds': request.user.staff_profile.can_approve_refunds,
                    'can_manage_staff': request.user.staff_profile.can_manage_staff,
                    'can_view_financial_reports': request.user.staff_profile.can_view_financial_reports
                }
            },
            'booking_stats': {
                'total_bookings': total_bookings,
                'pending_bookings': pending_bookings,
                'confirmed_bookings': confirmed_bookings,
                'paid_bookings': paid_bookings,
                'completed_bookings': completed_bookings
            },
            'payment_stats': {
                'total_payments': total_payments,
                'pending_payments': pending_payments,
                'failed_payments': failed_payments,
                'total_revenue_dollars': total_revenue_cents / 100
            },
            'customer_stats': {
                'total_customers': total_customers,
                'vip_customers': vip_customers
            },
            'urgent_bookings': self._serialize_urgent_bookings(urgent_bookings)
        })
    
    def _serialize_urgent_bookings(self, bookings):
        """Serialize urgent bookings for dashboard"""
        urgent_data = []
        for booking in bookings:
            urgent_data.append({
                'id': str(booking.id),
                'booking_number': booking.booking_number,
                'customer_name': booking.get_customer_name(),
                'customer_email': booking.get_customer_email(),
                'service_type': booking.get_service_type_display(),
                'pickup_date': booking.pickup_date,
                'status': booking.get_status_display(),
                'total_price_dollars': booking.total_price_dollars,
                'created_at': booking.created_at
            })
        return urgent_data


@method_decorator(ratelimit(key='user', rate='20/m', method='GET', block=True), name='get')
class CustomerManagementView(APIView):
    """Staff customer management with rate limiting - list and search customers"""
    permission_classes = [IsStaffMember]

    def get(self, request):
        # Get query parameters
        search = request.query_params.get('search', '')
        vip = request.query_params.get('vip', '')
        
        # Start with all customer profiles, prefetch related data to avoid N+1
        from apps.customers.models import SavedAddress
        customers = User.objects.filter(
            customer_profile__isnull=False,
        ).select_related(
            'customer_profile',
        ).prefetch_related(
            Prefetch(
                'bookings',
                queryset=Booking.objects.filter(
                    deleted_at__isnull=True,
                ).order_by('-created_at'),
                to_attr='prefetched_bookings',
            ),
            Prefetch(
                'saved_addresses',
                queryset=SavedAddress.objects.filter(
                    is_active=True,
                ).order_by('-times_used'),
                to_attr='prefetched_addresses',
            ),
        )

        # Apply search filter
        if search:
            customers = customers.filter(
                Q(first_name__icontains=search) |
                Q(last_name__icontains=search) |
                Q(email__icontains=search) |
                Q(customer_profile__phone__icontains=search)
            )

        # Apply VIP filter
        if vip == 'true':
            customers = customers.filter(customer_profile__is_vip=True)
        elif vip == 'false':
            customers = customers.filter(customer_profile__is_vip=False)

        # Serialize customer data
        customer_data = []
        for user in customers[:100]:  # Limit to 100 results
            profile = user.customer_profile
            recent_bookings = user.prefetched_bookings[:5]
            saved_addrs = user.prefetched_addresses[:3]

            customer_data.append({
                'id': user.id,
                'name': user.get_full_name(),
                'email': user.email,
                'phone': profile.phone,
                'is_vip': profile.is_vip,
                'total_bookings': profile.total_bookings,
                'total_spent_dollars': profile.total_spent_dollars,
                'last_booking_at': profile.last_booking_at,
                'created_at': profile.created_at,
                'notes': profile.notes,
                'recent_bookings': [{
                    'id': str(booking.id),
                    'booking_number': booking.booking_number,
                    'service_type': booking.get_service_type_display(),
                    'status': booking.status,
                    'total_price_dollars': booking.total_price_dollars,
                    'created_at': booking.created_at
                } for booking in recent_bookings],
                'saved_addresses': [{
                    'id': str(addr.id),
                    'address_line_1': addr.address_line_1,
                    'city': addr.city,
                    'state': addr.state,
                    'is_primary': addr.times_used > 0
                } for addr in saved_addrs]
            })
        
        return Response({
            'customers': customer_data,
            'total_count': customers.count(),
            'filters': {
                'search': search,
                'vip': vip
            }
        })


@method_decorator(ratelimit(key='user', rate='15/m', method='GET', block=True), name='get')
class CustomerDetailView(APIView):
    """Staff view for individual customer details with rate limiting"""
    permission_classes = [IsStaffMember]

    def get(self, request, customer_id):
        try:
            user = User.objects.get(id=customer_id, customer_profile__isnull=False)
            profile = user.customer_profile
        except User.DoesNotExist:
            return Response({'error': 'Customer not found'}, status=status.HTTP_404_NOT_FOUND)
        
        # Log viewing customer data
        StaffAction.log_action(
            staff_user=request.user,
            action_type='view_customer',
            description=f'Viewed customer {user.get_full_name()} ({user.email})',
            request=request,
            customer_id=user.id
        )
        
        # Get all bookings
        all_bookings = user.bookings.filter(deleted_at__isnull=True).order_by('-created_at')
        
        return Response({
            'id': user.id,
            'name': user.get_full_name(),
            'email': user.email,
            'phone': profile.phone,
            'is_vip': profile.is_vip,
            'total_bookings': profile.total_bookings,
            'total_spent_dollars': profile.total_spent_dollars,
            'last_booking_at': profile.last_booking_at,
            'created_at': profile.created_at,
            'notes': profile.notes,
            'recent_bookings': [{
                'id': str(booking.id),
                'booking_number': booking.booking_number,
                'service_type': booking.get_service_type_display(),
                'status': booking.status,
                'total_price_dollars': booking.total_price_dollars,
                'created_at': booking.created_at
            } for booking in all_bookings],
            'saved_addresses': [{
                'id': str(addr.id),
                'address_line_1': addr.address_line_1,
                'address_line_2': addr.address_line_2,
                'city': addr.city,
                'state': addr.state,
                'zip_code': addr.zip_code,
                'is_primary': addr.times_used > 0
            } for addr in user.saved_addresses.filter(is_active=True)]
        })


@method_decorator(ratelimit(key='user', rate='5/m', method='PATCH', block=True), name='patch')
class CustomerNotesUpdateView(APIView):
    """Update customer notes with rate limiting - staff only"""
    permission_classes = [IsStaffMember]

    def patch(self, request, customer_id):
        try:
            user = User.objects.get(id=customer_id, customer_profile__isnull=False)
            profile = user.customer_profile
        except User.DoesNotExist:
            return Response({'error': 'Customer not found'}, status=status.HTTP_404_NOT_FOUND)
        
        notes = request.data.get('notes', '')
        old_notes = profile.notes
        
        profile.notes = notes
        profile.save()
        
        # Log notes update
        StaffAction.log_action(
            staff_user=request.user,
            action_type='modify_customer',
            description=f'Updated notes for customer {user.get_full_name()}',
            request=request,
            customer_id=user.id
        )
        
        return Response({
            'message': 'Customer notes updated successfully',
            'notes': profile.notes
        })


@method_decorator(ratelimit(key='user', rate='30/m', method='GET', block=True), name='get')
class BookingManagementView(APIView):
    """Enhanced staff booking management with rate limiting and date range support"""
    permission_classes = [IsStaffMember]

    def get(self, request):
        """List all bookings with enhanced filtering including date ranges"""
        
        # Get query parameters
        status_filter = request.query_params.get('status', None)
        date_filter = request.query_params.get('date', None)
        start_date = request.query_params.get('start_date', None)
        end_date = request.query_params.get('end_date', None)
        search = request.query_params.get('search', None)
        
        # ✅ OPTIMIZED: Added select_related to avoid N+1 queries
        bookings = Booking.objects.filter(
            deleted_at__isnull=True
        ).select_related(
            'customer',
            'customer__customer_profile',
            'guest_checkout',
            'mini_move_package',
            'pickup_address',
            'delivery_address'
        ).order_by('-created_at')
        
        if status_filter:
            bookings = bookings.filter(status=status_filter)
        
        if date_filter:
            bookings = bookings.filter(pickup_date=date_filter)
        
        # Date range filtering for calendar
        if start_date and end_date:
            bookings = bookings.filter(
                pickup_date__gte=start_date,
                pickup_date__lte=end_date
            )
        elif start_date:
            bookings = bookings.filter(pickup_date__gte=start_date)
        elif end_date:
            bookings = bookings.filter(pickup_date__lte=end_date)
        
        if search:
            bookings = bookings.filter(
                Q(booking_number__icontains=search) |
                Q(customer__email__icontains=search) |
                Q(guest_checkout__email__icontains=search) |
                Q(customer__first_name__icontains=search) |
                Q(customer__last_name__icontains=search) |
                Q(guest_checkout__first_name__icontains=search) |
                Q(guest_checkout__last_name__icontains=search)
            )
        
        # Serialize bookings
        booking_data = []
        for booking in bookings[:50]:  # Limit to 50 results
            booking_data.append({
                'id': str(booking.id),
                'booking_number': booking.booking_number,
                'customer_name': booking.get_customer_name(),
                'customer_email': booking.get_customer_email(),
                'service_type': booking.get_service_type_display(),
                'pickup_date': booking.pickup_date,
                'pickup_time': booking.get_pickup_time_display(),
                'status': booking.get_status_display(),
                'total_price_dollars': booking.total_price_dollars,
                'payment_status': self._get_payment_status(booking),
                'created_at': booking.created_at,
                'coi_required': booking.coi_required
            })
        
        return Response({
            'bookings': booking_data,
            'total_count': bookings.count(),
            'filters': {
                'status': status_filter,
                'date': date_filter,
                'start_date': start_date,
                'end_date': end_date,
                'search': search
            }
        })
    
    def _get_payment_status(self, booking):
        """Get payment status for booking"""
        payment = booking.payments.first()
        return payment.status if payment else 'not_created'

@method_decorator(ratelimit(key='user', rate='20/m', method='GET', block=True), name='get')
@method_decorator(ratelimit(key='user', rate='10/m', method='PATCH', block=True), name='patch')
class BookingDetailView(APIView):
    """Staff view for individual booking details and management with rate limiting"""
    permission_classes = [IsStaffMember]

    def get(self, request, booking_id):
        try:
            booking = Booking.objects.select_related(
                'customer', 'customer__customer_profile',
                'mini_move_package', 'guest_checkout',
                'pickup_address', 'delivery_address',
                'discount_code'
            ).prefetch_related('specialty_items').get(id=booking_id, deleted_at__isnull=True)
        except Booking.DoesNotExist:
            return Response({'error': 'Booking not found'}, status=status.HTTP_404_NOT_FOUND)
        
        # Log viewing booking data
        StaffAction.log_action(
            staff_user=request.user,
            action_type='view_booking',
            description=f'Viewed booking {booking.booking_number}',
            request=request,
            booking_id=booking.id
        )
        
        # Get payment information
        payment = booking.payments.first()
        payment_data = None
        if payment:
            payment_data = {
                'id': str(payment.id),
                'status': payment.status,
                'amount_dollars': payment.amount_dollars,
                'stripe_payment_intent_id': payment.stripe_payment_intent_id,
                'processed_at': payment.processed_at,
                'failure_reason': payment.failure_reason
            }
        
        # Get refund information
        refunds_data = []
        if payment:
            refunds = Refund.objects.filter(payment=payment).order_by('-created_at')
            refunds_data = RefundSerializer(refunds, many=True).data
        
        # Get customer information
        customer_data = None
        if booking.customer:
            customer_data = {
                'id': booking.customer.id,
                'name': booking.customer.get_full_name(),
                'email': booking.customer.email,
                'phone': getattr(booking.customer.customer_profile, 'phone', ''),
                'is_vip': getattr(booking.customer.customer_profile, 'is_vip', False),
                'total_bookings': getattr(booking.customer.customer_profile, 'total_bookings', 0),
                'total_spent_dollars': getattr(booking.customer.customer_profile, 'total_spent_dollars', 0)
            }
        
        # Get service-specific details
        service_details = self._get_service_details(booking)
        
        return Response({
            'booking': {
                'id': str(booking.id),
                'booking_number': booking.booking_number,
                'service_type': booking.service_type,
                'service_type_display': booking.get_service_type_display(),
                'status': booking.status,
                'pickup_date': booking.pickup_date,
                'pickup_time': booking.pickup_time,
                'pickup_time_display': booking.get_pickup_time_display(),
                'specific_pickup_hour': booking.specific_pickup_hour,
                'pickup_address': {
                    'address_line_1': booking.pickup_address.address_line_1,
                    'address_line_2': booking.pickup_address.address_line_2,
                    'city': booking.pickup_address.city,
                    'state': booking.pickup_address.state,
                    'zip_code': booking.pickup_address.zip_code
                },
                'delivery_address': {
                    'address_line_1': booking.delivery_address.address_line_1,
                    'address_line_2': booking.delivery_address.address_line_2,
                    'city': booking.delivery_address.city,
                    'state': booking.delivery_address.state,
                    'zip_code': booking.delivery_address.zip_code
                },
                'special_instructions': booking.special_instructions,
                'coi_required': booking.coi_required,
                'is_outside_core_area': booking.is_outside_core_area,
                
                # PRICING FIELDS
                'base_price_dollars': booking.base_price_dollars,
                'surcharge_dollars': booking.surcharge_dollars,
                'same_day_surcharge_dollars': booking.same_day_surcharge_dollars,
                'coi_fee_dollars': booking.coi_fee_dollars,
                'organizing_total_dollars': booking.organizing_total_dollars,
                'organizing_tax_dollars': booking.organizing_tax_dollars,
                'geographic_surcharge_dollars': booking.geographic_surcharge_dollars,
                'time_window_surcharge_dollars': booking.time_window_surcharge_dollars,
                'total_price_dollars': booking.total_price_dollars,

                # DISCOUNT FIELDS
                'discount_amount_dollars': booking.discount_amount_dollars,
                'pre_discount_total_dollars': booking.pre_discount_total_dollars,
                'discount_code_name': booking.discount_code.code if booking.discount_code else None,
                'discount_description': booking.discount_code.discount_value_display if booking.discount_code else None,
                
                'pricing_breakdown': booking.get_pricing_breakdown(),
                'service_details': service_details,
                'created_at': booking.created_at,
                'updated_at': booking.updated_at
            },
            'customer': customer_data,
            'guest_checkout': {
                'first_name': booking.guest_checkout.first_name if booking.guest_checkout else None,
                'last_name': booking.guest_checkout.last_name if booking.guest_checkout else None,
                'email': booking.guest_checkout.email if booking.guest_checkout else None,
                'phone': booking.guest_checkout.phone if booking.guest_checkout else None
            } if booking.guest_checkout else None,
            'payment': payment_data,
            'refunds': refunds_data
        })
    
    def _get_service_details(self, booking):
        """Get detailed service-specific information"""
        from apps.services.models import OrganizingService
        
        details = {}
        
        # Mini Move details
        if booking.service_type == 'mini_move' and booking.mini_move_package:
            details['mini_move'] = {
                'package_name': booking.mini_move_package.name,
                'package_type': booking.mini_move_package.package_type,
                'description': booking.mini_move_package.description,
                'max_items': booking.mini_move_package.max_items,
                'max_weight_per_item_lbs': booking.mini_move_package.max_weight_per_item_lbs,
                'coi_included': booking.mini_move_package.coi_included,
                'priority_scheduling': booking.mini_move_package.priority_scheduling,
                'protective_wrapping': booking.mini_move_package.protective_wrapping,
                'base_price_dollars': booking.mini_move_package.base_price_dollars,
            }
            
            # Organizing services
            if booking.include_packing or booking.include_unpacking:
                organizing_data = {
                    'include_packing': booking.include_packing,
                    'include_unpacking': booking.include_unpacking,
                }
                
                tier = booking.mini_move_package.package_type
                
                if booking.include_packing:
                    packing_service = OrganizingService.objects.filter(
                        mini_move_tier=tier,
                        is_packing_service=True,
                        is_active=True
                    ).first()
                    if packing_service:
                        organizing_data['packing_service'] = {
                            'name': packing_service.name,
                            'price_dollars': packing_service.price_dollars,
                            'duration_hours': packing_service.duration_hours,
                            'organizer_count': packing_service.organizer_count,
                            'supplies_allowance': packing_service.supplies_allowance_dollars,
                        }
                
                if booking.include_unpacking:
                    unpacking_service = OrganizingService.objects.filter(
                        mini_move_tier=tier,
                        is_packing_service=False,
                        is_active=True
                    ).first()
                    if unpacking_service:
                        organizing_data['unpacking_service'] = {
                            'name': unpacking_service.name,
                            'price_dollars': unpacking_service.price_dollars,
                            'duration_hours': unpacking_service.duration_hours,
                            'organizer_count': unpacking_service.organizer_count,
                            'supplies_allowance': unpacking_service.supplies_allowance_dollars,
                        }
                
                details['organizing_services'] = organizing_data
        
        # Specialty Item details
        elif booking.service_type == 'specialty_item' and booking.specialty_items.exists():
            details['specialty_items'] = [
                {
                    'id': str(item.id),
                    'name': item.name,
                    'item_type': item.item_type,
                    'description': item.description,
                    'price_dollars': item.price_dollars,
                    'special_handling': item.special_handling
                }
                for item in booking.specialty_items.all()
            ]
        
        # Standard Delivery details
        elif booking.service_type == 'standard_delivery':
            details['standard_delivery'] = {
                'item_count': booking.standard_delivery_item_count or 0,
                'is_same_day': booking.is_same_day_delivery,
            }
            # Include specialty items if any
            if booking.specialty_items.exists():
                details['specialty_items'] = [
                    {
                        'id': str(item.id),
                        'name': item.name,
                        'price_dollars': item.price_dollars,
                    }
                    for item in booking.specialty_items.all()
                ]
        
        # BLADE Transfer details
        elif booking.service_type == 'blade_transfer':
            details['blade_transfer'] = {
                'airport': booking.blade_airport,
                'flight_date': booking.blade_flight_date,
                'flight_time': booking.blade_flight_time.strftime('%H:%M') if booking.blade_flight_time else None,
                'bag_count': booking.blade_bag_count,
                'ready_time': booking.blade_ready_time.strftime('%H:%M') if booking.blade_ready_time else None,
                'per_bag_price': 75,
            }
        
        return details
    
    def patch(self, request, booking_id):
        """Update booking status and details"""
        try:
            booking = Booking.objects.get(id=booking_id, deleted_at__isnull=True)
        except Booking.DoesNotExist:
            return Response({'error': 'Booking not found'}, status=status.HTTP_404_NOT_FOUND)
        
        # Get update data
        new_status = request.data.get('status')
        staff_notes = request.data.get('staff_notes', '')

        old_status = booking.status

        # Validate status transition
        if new_status and new_status != old_status:
            valid_statuses = [s[0] for s in Booking.STATUS_CHOICES]
            if new_status not in valid_statuses:
                return Response(
                    {'error': f'Invalid status: {new_status}'},
                    status=status.HTTP_400_BAD_REQUEST,
                )
            allowed = Booking.VALID_TRANSITIONS.get(old_status, [])
            if new_status not in allowed:
                return Response(
                    {'error': f'Cannot transition from {old_status} to {new_status}'},
                    status=status.HTTP_400_BAD_REQUEST,
                )

            booking.status = new_status
            booking.save(_skip_pricing=True)
            
            # Log status change
            StaffAction.log_action(
                staff_user=request.user,
                action_type='modify_booking',
                description=f'Changed booking {booking.booking_number} status from {old_status} to {new_status}. Notes: {staff_notes}',
                request=request,
                booking_id=booking.id
            )
        
        return Response({
            'message': 'Booking updated successfully',
            'booking': {
                'id': str(booking.id),
                'booking_number': booking.booking_number,
                'status': booking.status,
                'updated_at': booking.updated_at
            }
        })


@method_decorator(ensure_csrf_cookie, name='dispatch')
class StaffCSRFTokenView(APIView):
    """Get CSRF token for staff portal - public to allow login to work"""
    permission_classes = [permissions.AllowAny]

    def get(self, request):
        return Response({
            'csrf_token': get_token(request)
        })


@method_decorator(ratelimit(key='user', rate='30/m', method='GET', block=True), name='get')
class StaffReportsView(APIView):
    """Staff reports and analytics API"""
    permission_classes = [IsStaffMember]

    def get(self, request):
        from django.db.models import Sum, Avg
        from django.db.models.functions import TruncDate, TruncMonth
        from django.utils import timezone
        from datetime import timedelta

        # Date ranges
        today = timezone.now().date()
        thirty_days_ago = today - timedelta(days=30)
        ninety_days_ago = today - timedelta(days=90)
        start_of_year = today.replace(month=1, day=1)

        # === REVENUE METRICS ===
        # Total revenue all time
        total_revenue_cents = Payment.objects.filter(status='succeeded').aggregate(
            total=Sum('amount_cents')
        )['total'] or 0

        # Revenue last 30 days
        revenue_30_days = Payment.objects.filter(
            status='succeeded',
            created_at__date__gte=thirty_days_ago
        ).aggregate(total=Sum('amount_cents'))['total'] or 0

        # Revenue by day (last 30 days) for chart
        daily_revenue = Payment.objects.filter(
            status='succeeded',
            created_at__date__gte=thirty_days_ago
        ).annotate(
            date=TruncDate('created_at')
        ).values('date').annotate(
            revenue=Sum('amount_cents')
        ).order_by('date')

        # Revenue by month (last 12 months) for chart
        monthly_revenue = Payment.objects.filter(
            status='succeeded',
            created_at__date__gte=today - timedelta(days=365)
        ).annotate(
            month=TruncMonth('created_at')
        ).values('month').annotate(
            revenue=Sum('amount_cents'),
            count=Count('id')
        ).order_by('month')

        # === BOOKING METRICS ===
        all_bookings = Booking.objects.filter(deleted_at__isnull=True)

        # Bookings by status
        bookings_by_status = {
            'pending': all_bookings.filter(status='pending').count(),
            'confirmed': all_bookings.filter(status='confirmed').count(),
            'paid': all_bookings.filter(status='paid').count(),
            'completed': all_bookings.filter(status='completed').count(),
            'cancelled': all_bookings.filter(status='cancelled').count(),
        }

        # Bookings by service type
        bookings_by_service = all_bookings.values('service_type').annotate(
            count=Count('id'),
            revenue=Sum('total_price_cents')
        ).order_by('-count')

        # Bookings last 30 days by day
        daily_bookings = all_bookings.filter(
            created_at__date__gte=thirty_days_ago
        ).annotate(
            date=TruncDate('created_at')
        ).values('date').annotate(
            count=Count('id')
        ).order_by('date')

        # Average booking value
        avg_booking_value = all_bookings.filter(
            status__in=['paid', 'completed']
        ).aggregate(avg=Avg('total_price_cents'))['avg'] or 0

        # === CUSTOMER METRICS ===
        total_customers = CustomerProfile.objects.count()
        vip_customers = CustomerProfile.objects.filter(is_vip=True).count()
        new_customers_30_days = CustomerProfile.objects.filter(
            created_at__date__gte=thirty_days_ago
        ).count()

        # Top customers by booking count
        top_customers = CustomerProfile.objects.annotate(
            booking_count=Count('user__bookings', filter=Q(user__bookings__deleted_at__isnull=True)),
            total_spent=Sum('user__bookings__total_price_cents', filter=Q(user__bookings__status__in=['paid', 'completed']))
        ).filter(booking_count__gt=0).order_by('-booking_count')[:10]

        # === PERFORMANCE METRICS ===
        # Completion rate
        completed = all_bookings.filter(status='completed').count()
        total_non_cancelled = all_bookings.exclude(status='cancelled').count()
        completion_rate = (completed / total_non_cancelled * 100) if total_non_cancelled > 0 else 0

        # Cancellation rate
        cancelled = all_bookings.filter(status='cancelled').count()
        total_all = all_bookings.count()
        cancellation_rate = (cancelled / total_all * 100) if total_all > 0 else 0

        return Response({
            'revenue': {
                'total_all_time': total_revenue_cents / 100,
                'last_30_days': revenue_30_days / 100,
                'average_booking_value': avg_booking_value / 100 if avg_booking_value else 0,
                'daily': [
                    {'date': str(d['date']), 'revenue': d['revenue'] / 100}
                    for d in daily_revenue
                ],
                'monthly': [
                    {'month': str(d['month'].strftime('%Y-%m')), 'revenue': d['revenue'] / 100, 'count': d['count']}
                    for d in monthly_revenue
                ],
            },
            'bookings': {
                'total': all_bookings.count(),
                'by_status': bookings_by_status,
                'by_service': [
                    {
                        'service_type': b['service_type'],
                        'count': b['count'],
                        'revenue': (b['revenue'] or 0) / 100
                    }
                    for b in bookings_by_service
                ],
                'daily': [
                    {'date': str(d['date']), 'count': d['count']}
                    for d in daily_bookings
                ],
            },
            'customers': {
                'total': total_customers,
                'vip': vip_customers,
                'new_last_30_days': new_customers_30_days,
                'top_customers': [
                    {
                        'name': f"{c.user.first_name} {c.user.last_name}",
                        'email': c.user.email,
                        'booking_count': c.booking_count,
                        'total_spent': (c.total_spent or 0) / 100,
                        'is_vip': c.is_vip
                    }
                    for c in top_customers
                ],
            },
            'performance': {
                'completion_rate': round(completion_rate, 1),
                'cancellation_rate': round(cancellation_rate, 1),
            },
            'generated_at': timezone.now().isoformat(),
        })
```

# ──── backend/apps/bookings/admin.py ────

```python
from django.contrib import admin
from django.utils.html import format_html
from .models import Booking, Address, GuestCheckout, BookingSpecialtyItem, DiscountCode, DiscountCodeUsage
from django.utils import timezone
from django.contrib import messages


class BookingSpecialtyItemInline(admin.TabularInline):
    """Inline admin for specialty items with quantities"""
    model = BookingSpecialtyItem
    extra = 1
    fields = ('specialty_item', 'quantity', 'get_subtotal')
    readonly_fields = ('get_subtotal',)
    
    def get_subtotal(self, obj):
        if obj.id:
            return f"${obj.subtotal_dollars}"
        return "—"
    get_subtotal.short_description = 'Subtotal'


@admin.register(Booking)
class BookingAdmin(admin.ModelAdmin):
    list_display = (
        'booking_number', 
        'get_customer_name', 
        'service_type', 
        'get_service_details',
        'get_organizing_services',
        'status', 
        'pickup_date', 
        'total_price_dollars',
        'visibility_status'
    )
    list_filter = (
        'service_type', 
        'status', 
        'pickup_date', 
        'coi_required', 
        'include_packing', 
        'include_unpacking',
        ('deleted_at', admin.EmptyFieldListFilter),
    )
    search_fields = ('booking_number', 'customer__email', 'guest_checkout__email')
    readonly_fields = (
        'booking_number', 'base_price_cents', 'surcharge_cents',
        'coi_fee_cents', 'organizing_total_cents', 'total_price_cents',
        'discount_amount_cents', 'pre_discount_total_cents',
        'created_at', 'updated_at'
    )
    
    inlines = [BookingSpecialtyItemInline]
    
    fieldsets = (
        ('Customer Info', {
            'fields': ('customer', 'guest_checkout')
        }),
        ('Service Selection', {
            'fields': (
                'service_type', 
                'mini_move_package', 
                'standard_delivery_item_count',
                'is_same_day_delivery',
            )
        }),
        ('Organizing Services', {
            'fields': ('include_packing', 'include_unpacking'),
            'classes': ('wide',),
            'description': 'Professional packing and unpacking services (Mini Moves only)'
        }),
        ('Booking Details', {
            'fields': ('pickup_date', 'pickup_time', 'pickup_address', 'delivery_address')
        }),
        ('Requirements', {
            'fields': ('special_instructions', 'coi_required')
        }),
        ('Calculated Pricing', {
            'fields': ('base_price_cents', 'surcharge_cents', 'coi_fee_cents', 'organizing_total_cents', 'total_price_cents'),
            'classes': ('collapse',)
        }),
        ('Discount', {
            'fields': ('discount_code', 'discount_amount_cents', 'pre_discount_total_cents'),
            'classes': ('collapse',)
        }),
        ('Status', {
            'fields': ('status',)
        }),
        ('System Info', {
            'fields': ('booking_number', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        })
    )
    
    actions = ['soft_delete_selected', 'restore_selected']
    
    def get_queryset(self, request):
        """Show all bookings when filter is used, otherwise show only active ones"""
        qs = super().get_queryset(request)
        return qs
        # If user is specifically filtering by deleted_at, show all results
     #   if 'deleted_at__isnull' in request.GET:
      #      return qs  # Let the filter handle it
        # Otherwise only show active bookings by default
       # return qs.filter(deleted_at__isnull=True)
    
    def get_customer_name(self, obj):
        return obj.get_customer_name()
    get_customer_name.short_description = 'Customer'
    
    def get_service_details(self, obj):
        if obj.service_type == 'mini_move' and obj.mini_move_package:
            return obj.mini_move_package.name
        elif obj.service_type == 'standard_delivery' and obj.standard_delivery_item_count:
            return f"{obj.standard_delivery_item_count} items"
        elif obj.service_type == 'specialty_item':
            booking_items = obj.bookingspecialtyitem_set.all()
            items_list = [f"{bi.quantity}x {bi.specialty_item.name}" for bi in booking_items[:2]]
            return ", ".join(items_list) + ("..." if len(booking_items) > 2 else "")
        return "Not configured"
    get_service_details.short_description = 'Service Details'
    
    def get_organizing_services(self, obj):
        """Show organizing services for this booking"""
        if obj.service_type != 'mini_move':
            return "—"
        
        services = []
        if obj.include_packing:
            services.append("📦 Packing")
        if obj.include_unpacking:
            services.append("📤 Unpacking")
        
        if services:
            services_text = " + ".join(services)
            return format_html(
                '<span style="color: #059669; font-weight: bold;">{}</span><br>'
                '<small style="color: #6b7280;">${}</small>',
                services_text,
                obj.organizing_total_dollars
            )
        return format_html('<span style="color: #9ca3af;">None</span>')
    get_organizing_services.short_description = 'Organizing Services'
    
    def visibility_status(self, obj):
        """Show if booking is visible in staff dashboard"""
        if obj.deleted_at:
            return format_html('<span style="color: red;">🙈 Hidden</span>')
        return format_html('<span style="color: green;">👁️ Visible</span>')
    visibility_status.short_description = 'Dashboard Status'
    
    def soft_delete_selected(self, request, queryset):
        count = queryset.filter(deleted_at__isnull=True).update(deleted_at=timezone.now())
        self.message_user(request, f'Hidden {count} bookings from staff dashboard')
    soft_delete_selected.short_description = "Hide selected bookings from dashboard"
    
    def restore_selected(self, request, queryset):
        count = queryset.filter(deleted_at__isnull=False).update(deleted_at=None)
        self.message_user(request, f'Restored {count} bookings to dashboard')
    restore_selected.short_description = "Restore hidden bookings"


class DiscountCodeUsageInline(admin.TabularInline):
    model = DiscountCodeUsage
    extra = 0
    readonly_fields = ('customer_email', 'booking', 'used_at')
    can_delete = False

    def has_add_permission(self, request, obj=None):
        return False


@admin.register(DiscountCode)
class DiscountCodeAdmin(admin.ModelAdmin):
    list_display = (
        'code', 'discount_type', 'get_discount_display', 'is_active',
        'times_used', 'max_uses', 'valid_until', 'get_service_types',
    )
    list_filter = ('discount_type', 'is_active')
    search_fields = ('code', 'description')
    readonly_fields = ('times_used', 'created_at', 'updated_at')
    inlines = [DiscountCodeUsageInline]

    fieldsets = (
        ('Code Details', {
            'fields': ('code', 'description', 'discount_type', 'discount_value', 'is_active')
        }),
        ('Restrictions', {
            'fields': (
                'max_uses', 'max_uses_per_customer',
                'valid_from', 'valid_until',
                'minimum_order_cents', 'maximum_discount_cents',
                'allowed_service_types',
            )
        }),
        ('Usage', {
            'fields': ('times_used', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        }),
    )

    def get_discount_display(self, obj):
        return obj.discount_value_display
    get_discount_display.short_description = 'Discount'

    def get_service_types(self, obj):
        if not obj.allowed_service_types:
            return "All"
        return ", ".join(obj.allowed_service_types)
    get_service_types.short_description = 'Service Types'


@admin.register(Address)
class AddressAdmin(admin.ModelAdmin):
    list_display = ('address_line_1', 'city', 'state', 'customer', 'created_at')
    list_filter = ('state', 'city')
    search_fields = ('address_line_1', 'city', 'customer__email')


@admin.register(GuestCheckout)
class GuestCheckoutAdmin(admin.ModelAdmin):
    list_display = ('first_name', 'last_name', 'email', 'phone', 'created_at')
    search_fields = ('first_name', 'last_name', 'email')
    readonly_fields = ('created_at',)
```

# ──── backend/apps/bookings/apps.py ────

```python
from django.apps import AppConfig


class BookingsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'apps.bookings'

    def ready(self):
        # Ensure signal handlers are registered
        import apps.bookings.signals  # noqa: F401
```

# ──── backend/apps/bookings/models.py ────

```python
# backend/apps/bookings/models.py
import uuid
from django.db import models, transaction
from django.utils import timezone
from django.contrib.auth.models import User
from django.core.validators import RegexValidator
from datetime import timedelta, time


def check_same_day_restriction(pickup_date):
    """
    Check if booking falls into restricted same-day window
    
    Rules:
    1. If pickup_date is today → BLOCKED
    2. If booking time is after 6 PM and pickup_date is tomorrow → BLOCKED
    
    Returns: (is_blocked: bool, error_message: str or None)
    """
    if not pickup_date:
        return False, None
    
    now = timezone.localtime(timezone.now())  # ✅ This gets EST time (13:54 = 1:54 PM)
    booking_date = now.date()
    booking_time = now.time()
    cutoff_time = time(18, 0)  # 6:00 PM
    next_day = booking_date + timedelta(days=1)
    
    # Rule 1: Same day pickup
    if pickup_date == booking_date:
        return True, "Same-day bookings must be arranged through Tote Taxi Customer Service. Please call (631) 595-5100."
    
    # Rule 2: After 6 PM for next day
    if booking_time >= cutoff_time and pickup_date == next_day:
        return True, "Bookings made after 6 PM for next-day service must be arranged through Tote Taxi Customer Service. Please call (631) 595-5100."
    
    return False, None


class Address(models.Model):
    """Address for pickup/delivery - can be saved by customer or one-time"""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    customer = models.ForeignKey(
        User, 
        on_delete=models.CASCADE, 
        null=True, 
        blank=True,
        related_name='booking_addresses'
    )
    
    address_line_1 = models.CharField(max_length=200)
    address_line_2 = models.CharField(max_length=200, blank=True)
    city = models.CharField(max_length=100)
    state = models.CharField(max_length=2, choices=[
        ('NY', 'New York'),
        ('CT', 'Connecticut'), 
        ('NJ', 'New Jersey'),
    ])
    zip_code = models.CharField(max_length=10)
    
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'bookings_address'
        indexes = [
            models.Index(fields=['customer']),
            models.Index(fields=['zip_code']),
        ]
    
    def __str__(self):
        return f"{self.address_line_1}, {self.city}, {self.state} {self.zip_code}"


class GuestCheckout(models.Model):
    """Guest customer info for non-authenticated bookings"""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    first_name = models.CharField(max_length=100)
    last_name = models.CharField(max_length=100)
    email = models.EmailField()
    phone = models.CharField(
        max_length=20, 
        validators=[RegexValidator(regex=r'^\+?1?\d{9,15}$')]
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'bookings_guest_checkout'
        indexes = [
            models.Index(fields=['email']),
        ]
    
    def __str__(self):
        return f"{self.first_name} {self.last_name} ({self.email})"


class DiscountCode(models.Model):
    """Discount/promo codes for bookings"""

    DISCOUNT_TYPE_CHOICES = [
        ('percentage', 'Percentage'),
        ('fixed', 'Fixed Amount'),
    ]

    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    code = models.CharField(max_length=50, unique=True, db_index=True)
    description = models.CharField(max_length=200, blank=True)

    discount_type = models.CharField(max_length=10, choices=DISCOUNT_TYPE_CHOICES)
    discount_value = models.PositiveIntegerField(
        help_text="Percentage (e.g. 20 for 20%) or fixed amount in cents (e.g. 5000 for $50)"
    )

    max_uses = models.PositiveIntegerField(
        null=True, blank=True,
        help_text="Maximum total uses. Null = unlimited."
    )
    max_uses_per_customer = models.PositiveIntegerField(
        default=1,
        help_text="Maximum uses per customer/email address"
    )
    valid_from = models.DateTimeField(default=timezone.now)
    valid_until = models.DateTimeField(
        null=True, blank=True,
        help_text="Expiration date. Null = never expires."
    )
    minimum_order_cents = models.PositiveIntegerField(
        default=0,
        help_text="Minimum order total (pre-discount) in cents"
    )
    maximum_discount_cents = models.PositiveIntegerField(
        null=True, blank=True,
        help_text="Cap the discount amount (for percentage codes). Null = no cap."
    )

    allowed_service_types = models.JSONField(
        default=list, blank=True,
        help_text="Service types this code applies to. Empty = all services."
    )

    is_active = models.BooleanField(default=True)
    times_used = models.PositiveIntegerField(default=0)

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        db_table = 'bookings_discount_code'

    def __str__(self):
        if self.discount_type == 'percentage':
            return f"{self.code} - {self.discount_value}% off"
        return f"{self.code} - ${self.discount_value / 100:.2f} off"

    @property
    def discount_value_display(self):
        if self.discount_type == 'percentage':
            return f"{self.discount_value}%"
        return f"${self.discount_value / 100:.2f}"

    def is_valid(self):
        """Check if discount code is currently valid (ignoring per-customer limits)"""
        if not self.is_active:
            return False, "This discount code is no longer active."

        now = timezone.now()
        if self.valid_from and now < self.valid_from:
            return False, "This discount code is not yet active."
        if self.valid_until and now > self.valid_until:
            return False, "This discount code has expired."
        if self.max_uses is not None and self.times_used >= self.max_uses:
            return False, "This discount code has reached its usage limit."

        return True, None

    def is_valid_for_customer(self, email):
        """Check if a specific customer/email can use this code"""
        is_valid, error = self.is_valid()
        if not is_valid:
            return False, error

        usage_count = self.usages.filter(customer_email__iexact=email).count()
        if usage_count >= self.max_uses_per_customer:
            return False, "You have already used this discount code."

        return True, None

    def is_valid_for_service(self, service_type):
        """Check if code applies to a specific service type"""
        if not self.allowed_service_types:
            return True
        return service_type in self.allowed_service_types

    def calculate_discount(self, subtotal_cents):
        """Calculate discount amount in cents for a given subtotal"""
        if self.discount_type == 'percentage':
            discount = int(subtotal_cents * self.discount_value / 100)
            if self.maximum_discount_cents is not None:
                discount = min(discount, self.maximum_discount_cents)
        else:
            discount = self.discount_value

        return min(discount, subtotal_cents)

    def record_usage(self, email, booking=None):
        """Record that this code was used"""
        DiscountCodeUsage.objects.create(
            discount_code=self,
            customer_email=email,
            booking=booking,
        )
        self.times_used = models.F('times_used') + 1
        self.save(update_fields=['times_used'])
        self.refresh_from_db(fields=['times_used'])


class DiscountCodeUsage(models.Model):
    """Track per-customer discount code usage"""
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    discount_code = models.ForeignKey(
        DiscountCode, on_delete=models.CASCADE, related_name='usages'
    )
    customer_email = models.EmailField()
    booking = models.ForeignKey(
        'Booking', on_delete=models.SET_NULL, null=True, blank=True
    )
    used_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        db_table = 'bookings_discount_code_usage'
        indexes = [
            models.Index(fields=['discount_code', 'customer_email'], name='discount_usage_customer_idx'),
        ]

    def __str__(self):
        return f"{self.discount_code.code} used by {self.customer_email}"


class BookingSpecialtyItem(models.Model):
    """Through model to track quantity of each specialty item per booking"""
    booking = models.ForeignKey('Booking', on_delete=models.CASCADE)
    specialty_item = models.ForeignKey('services.SpecialtyItem', on_delete=models.PROTECT)
    quantity = models.PositiveIntegerField(default=1)
    
    class Meta:
        db_table = 'bookings_booking_specialty_item'
        unique_together = ('booking', 'specialty_item')
        ordering = ['specialty_item__name']
    
    def __str__(self):
        return f"{self.booking.booking_number} - {self.quantity}x {self.specialty_item.name}"
    
    @property
    def subtotal_cents(self):
        return self.specialty_item.price_cents * self.quantity
    
    @property
    def subtotal_dollars(self):
        return self.subtotal_cents / 100


class Booking(models.Model):
    """Core booking - works with customer OR guest checkout - WITH SERVICES INTEGRATION + BLADE"""
    
    STATUS_CHOICES = [
        ('pending', 'Pending'),
        ('confirmed', 'Confirmed'),
        ('paid', 'Paid'),
        ('completed', 'Completed'),
        ('cancelled', 'Cancelled'),
    ]

    VALID_TRANSITIONS = {
        'pending': ['confirmed', 'paid', 'cancelled'],
        'confirmed': ['paid', 'cancelled'],
        'paid': ['completed', 'cancelled'],
        'completed': [],  # terminal
        'cancelled': [],  # terminal
    }

    SERVICE_TYPE_CHOICES = [
        ('mini_move', 'Mini Move'),
        ('standard_delivery', 'Standard Delivery'),
        ('specialty_item', 'Specialty Item'),
        ('blade_transfer', 'Airport Transfer'),
    ]
    
    PICKUP_TIME_CHOICES = [
        ('morning', '8 AM - 11 AM'),
        ('morning_specific', 'Specific 1-hour window (surcharge applies)'),
        ('no_time_preference', 'No time preference (available for certain packages)'),
    ]
    
    BLADE_AIRPORT_CHOICES = [
        ('JFK', 'JFK International Airport'),
        ('EWR', 'Newark Liberty International Airport'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    booking_number = models.CharField(max_length=20, unique=True, blank=True)
    
    customer = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name='bookings'
    )
    guest_checkout = models.OneToOneField(
        GuestCheckout,
        on_delete=models.CASCADE,
        null=True,
        blank=True,
        related_name='booking'
    )
    
    service_type = models.CharField(max_length=20, choices=SERVICE_TYPE_CHOICES)
    
    # Mini Move fields
    mini_move_package = models.ForeignKey(
        'services.MiniMovePackage',
        on_delete=models.PROTECT,
        null=True,
        blank=True,
        help_text="Selected mini move package (Petite/Standard/Full)"
    )
    include_packing = models.BooleanField(
        default=False,
        help_text="Include professional packing service for this Mini Move tier"
    )
    include_unpacking = models.BooleanField(
        default=False,
        help_text="Include professional unpacking service for this Mini Move tier"
    )
    
    # Standard Delivery fields
    standard_delivery_item_count = models.PositiveIntegerField(
        null=True,
        blank=True,
        help_text="Number of items for standard delivery"
    )
    is_same_day_delivery = models.BooleanField(
        default=False,
        help_text="Same-day delivery (flat $360 rate)"
    )
    specialty_items = models.ManyToManyField(
        'services.SpecialtyItem',
        through='BookingSpecialtyItem',
        blank=True,
        help_text="Selected specialty items with quantities"
    )
    
    # BLADE Airport Transfer fields
    blade_airport = models.CharField(
        max_length=3,
        choices=BLADE_AIRPORT_CHOICES,
        null=True,
        blank=True,
        help_text="Destination airport for BLADE transfer"
    )
    blade_flight_date = models.DateField(
        null=True, 
        blank=True,
        help_text="Date of BLADE flight"
    )
    blade_flight_time = models.TimeField(
        null=True, 
        blank=True,
        help_text="Time of BLADE flight departure"
    )
    blade_bag_count = models.PositiveIntegerField(
        null=True, 
        blank=True,
        help_text="Number of bags for BLADE transfer (minimum 2)"
    )
    blade_ready_time = models.TimeField(
        null=True, 
        blank=True,
        help_text="Auto-calculated: when bags must be ready for pickup"
    )
    
    # Address and scheduling
    pickup_address = models.ForeignKey(
        Address, 
        on_delete=models.PROTECT, 
        related_name='pickup_bookings'
    )
    delivery_address = models.ForeignKey(
        Address, 
        on_delete=models.PROTECT, 
        related_name='delivery_bookings'
    )
    
    pickup_date = models.DateField()
    pickup_time = models.CharField(
        max_length=30,
        choices=PICKUP_TIME_CHOICES,
        default='morning'
    )
    
    specific_pickup_hour = models.PositiveSmallIntegerField(
        null=True,
        blank=True,
        choices=[
            (8, '8:00 AM - 9:00 AM'),
            (9, '9:00 AM - 10:00 AM'),
            (10, '10:00 AM - 11:00 AM'),
        ],
        help_text="Specific hour for 1-hour window pickup"
    )
    
    special_instructions = models.TextField(blank=True)
    coi_required = models.BooleanField(default=False)
    
    is_outside_core_area = models.BooleanField(
        default=False,
        help_text="True if pickup/delivery is 30+ miles from Manhattan"
    )
    
    # Pricing fields
    base_price_cents = models.PositiveBigIntegerField(default=0)
    surcharge_cents = models.PositiveBigIntegerField(default=0)
    same_day_surcharge_cents = models.PositiveBigIntegerField(
        default=0,
        help_text="Same-day delivery surcharge ($360)"
    )
    coi_fee_cents = models.PositiveBigIntegerField(default=0)
    organizing_total_cents = models.PositiveBigIntegerField(
        default=0,
        help_text="Total cost for packing and unpacking services"
    )
    geographic_surcharge_cents = models.PositiveBigIntegerField(
        default=0,
        help_text="$175 surcharge for 30+ miles from Manhattan"
    )
    time_window_surcharge_cents = models.PositiveBigIntegerField(
        default=0,
        help_text="Surcharge for specific 1-hour window"
    )
    organizing_tax_cents = models.PositiveBigIntegerField(
        default=0,
        help_text="Tax on organizing services"
    )
    total_price_cents = models.PositiveBigIntegerField(default=0)

    # Discount fields
    discount_code = models.ForeignKey(
        'DiscountCode',
        on_delete=models.SET_NULL,
        null=True, blank=True,
        related_name='bookings',
    )
    discount_amount_cents = models.PositiveBigIntegerField(default=0)
    pre_discount_total_cents = models.PositiveBigIntegerField(default=0)

    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='pending')

    deleted_at = models.DateTimeField(null=True, blank=True)
    reminder_sent_at = models.DateTimeField(null=True, blank=True, help_text='When 24hr reminder email was sent')

    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'bookings_booking'
        constraints = [
            models.CheckConstraint(
                check=(
                    models.Q(customer__isnull=False, guest_checkout__isnull=True) |
                    models.Q(customer__isnull=True, guest_checkout__isnull=False)
                ),
                name='booking_exactly_one_customer_type'
            )
        ]
        indexes = [
            models.Index(fields=['booking_number'], name='bookings_booking_number_idx'),
            models.Index(fields=['pickup_date', 'status'], name='bookings_pickup_status_idx'),
            models.Index(fields=['customer', 'created_at'], name='bookings_customer_created_idx'),
            models.Index(fields=['status', 'pickup_date'], name='bookings_status_pickup_idx'),
            models.Index(fields=['created_at'], name='bookings_created_idx'),
            models.Index(fields=['service_type'], name='bookings_service_type_idx'),
        ]
    
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        # Track original status so signals can detect real transitions (L17)
        self._original_status = self.status

    def save(self, *args, **kwargs):
        skip_pricing = kwargs.pop('_skip_pricing', False)

        # Generate booking number if new
        if not self.booking_number:
            with transaction.atomic():
                last_booking = (
                    Booking.objects
                    .filter(booking_number__isnull=False)
                    .select_for_update()
                    .order_by('-booking_number')
                    .first()
                )
                if last_booking and last_booking.booking_number:
                    last_num = int(last_booking.booking_number.split('-')[1])
                    next_num = last_num + 1
                else:
                    next_num = 1
                self.booking_number = f"TT-{next_num:06d}"

        if not skip_pricing:
            # ========== AUTO-SET GEOGRAPHIC SURCHARGE ==========
            if self.pickup_address and self.delivery_address:
                from .zip_codes import validate_service_area

                # Validate pickup ZIP
                pickup_valid, pickup_surcharge, _, _ = validate_service_area(
                    self.pickup_address.zip_code
                )

                # Validate delivery ZIP
                delivery_valid, delivery_surcharge, _, _ = validate_service_area(
                    self.delivery_address.zip_code
                )

                # Apply surcharge if EITHER address is in surcharge zone
                self.is_outside_core_area = pickup_surcharge or delivery_surcharge
            # ========== END AUTO-SET GEOGRAPHIC SURCHARGE ==========

            self.calculate_pricing()

        super().save(*args, **kwargs)
        # Keep _original_status in sync so the signal detects the next transition
        self._original_status = self.status

    def __str__(self):
        customer_name = self.get_customer_name()
        return f"{self.booking_number} - {customer_name} - ${self.total_price_dollars}"
    
    def get_customer_name(self):
        if self.customer:
            return self.customer.get_full_name()
        elif self.guest_checkout:
            return f"{self.guest_checkout.first_name} {self.guest_checkout.last_name}"
        return "Unknown"
    
    def get_customer_email(self):
        if self.customer:
            return self.customer.email
        elif self.guest_checkout:
            return self.guest_checkout.email
        return None
    
    @property
    def total_price_dollars(self):
        return self.total_price_cents / 100
    
    @property
    def base_price_dollars(self):
        return self.base_price_cents / 100
    
    @property
    def surcharge_dollars(self):
        return self.surcharge_cents / 100
    
    @property
    def same_day_surcharge_dollars(self):
        return self.same_day_surcharge_cents / 100
    
    @property
    def coi_fee_dollars(self):
        return self.coi_fee_cents / 100
    
    @property
    def organizing_total_dollars(self):
        return self.organizing_total_cents / 100
    
    @property
    def geographic_surcharge_dollars(self):
        return self.geographic_surcharge_cents / 100
    
    @property
    def time_window_surcharge_dollars(self):
        return self.time_window_surcharge_cents / 100
    
    @property
    def organizing_tax_dollars(self):
        return self.organizing_tax_cents / 100

    @property
    def discount_amount_dollars(self):
        return self.discount_amount_cents / 100

    @property
    def pre_discount_total_dollars(self):
        return self.pre_discount_total_cents / 100
            
    def get_pickup_time_display(self):
        """
        Override Django's auto-generated method to include specific hour.
        Returns formatted pickup time with actual hour window when applicable.
        """
        if self.pickup_time == 'morning_specific' and self.specific_pickup_hour is not None:
            start = self.specific_pickup_hour
            end = start + 1
            
            # Format hours (handle 12 PM properly)
            def format_hour(h):
                if h == 12:
                    return "12:00 PM"
                elif h > 12:
                    return f"{h - 12}:00 PM"
                else:
                    return f"{h}:00 AM"
            
            return f"{format_hour(start)} - {format_hour(end)} (1-hour window)"
        
        # Use Django's default display for other choices
        return dict(self.PICKUP_TIME_CHOICES).get(self.pickup_time, self.pickup_time)
    
    
    def calculate_blade_ready_time(self):
        """Calculate BLADE ready time based on flight time"""
        if self.service_type == 'blade_transfer' and self.blade_flight_time:
            from datetime import time
            if self.blade_flight_time < time(13, 0):
                self.blade_ready_time = time(5, 0)
            else:
                self.blade_ready_time = time(10, 0)
    
    def calculate_organizing_costs(self):
        """Calculate organizing service costs based on Mini Move tier"""
        if self.service_type != 'mini_move' or not self.mini_move_package:
            return 0
        
        from apps.services.models import OrganizingService
        
        total_organizing_cents = 0
        tier = self.mini_move_package.package_type
        
        if self.include_packing:
            try:
                packing_service = OrganizingService.objects.get(
                    mini_move_tier=tier,
                    is_packing_service=True,
                    is_active=True
                )
                total_organizing_cents += packing_service.price_cents
            except OrganizingService.DoesNotExist:
                pass
        
        if self.include_unpacking:
            try:
                unpacking_service = OrganizingService.objects.get(
                    mini_move_tier=tier,
                    is_packing_service=False,
                    is_active=True
                )
                total_organizing_cents += unpacking_service.price_cents
            except OrganizingService.DoesNotExist:
                pass
        
        return total_organizing_cents
    
    def calculate_coi_fee(self):
        """Calculate COI fee - $50 for Standard Delivery, Specialty Items, and Petite Mini Moves"""
        if not self.coi_required:
            return 0
        
        # $50 COI fee for Standard Delivery and Specialty Items
        if self.service_type in ['standard_delivery', 'specialty_item']:
            return 5000
        
        # Mini Move COI logic
        if self.service_type == 'mini_move' and self.mini_move_package:
            if self.mini_move_package.package_type == 'petite':
                return 5000
            elif not self.mini_move_package.coi_included:
                return self.mini_move_package.coi_fee_cents
        
        return 0
    
    def calculate_geographic_surcharge(self):
        """
        Calculate $175 surcharge for EACH address 30+ miles from Manhattan.
        If both pickup AND delivery are outside core area, charges $350 total.
        """
        if not self.pickup_address or not self.delivery_address:
            return 0

        from .zip_codes import validate_service_area

        surcharge_count = 0

        # Check pickup address
        _, pickup_surcharge, _, _ = validate_service_area(
            self.pickup_address.zip_code
        )
        if pickup_surcharge:
            surcharge_count += 1

        # Check delivery address
        _, delivery_surcharge, _, _ = validate_service_area(
            self.delivery_address.zip_code
        )
        if delivery_surcharge:
            surcharge_count += 1

        # $175 per out-of-zone address
        return 17500 * surcharge_count
    
    def calculate_time_window_surcharge(self):
        """Calculate $175 surcharge for 1-hour window selection"""
        if self.pickup_time == 'morning_specific':
            if self.service_type == 'mini_move' and self.mini_move_package:
                if self.mini_move_package.package_type == 'standard':
                    return 17500
                elif self.mini_move_package.package_type == 'full':
                    return 0
        return 0
    
    def calculate_organizing_tax(self):
        """Calculate tax on organizing services - 8.25%"""
        if self.organizing_total_cents > 0:
            return int(self.organizing_total_cents * 0.0825)
        return 0
    
    def calculate_pricing(self):
        """Calculate total pricing using services pricing engine + BLADE support"""
        from apps.services.models import StandardDeliveryConfig, calculate_surcharges_for_date
        
        self.base_price_cents = 0
        self.surcharge_cents = 0
        self.same_day_surcharge_cents = 0
        self.coi_fee_cents = 0
        self.organizing_total_cents = 0
        self.geographic_surcharge_cents = 0
        self.time_window_surcharge_cents = 0
        self.organizing_tax_cents = 0
        
        # BLADE pricing
        if self.service_type == 'blade_transfer':
            if self.blade_bag_count:
                per_bag_price = 7500  # $75 per bag in cents
                self.base_price_cents = self.blade_bag_count * per_bag_price
                self.base_price_cents = max(self.base_price_cents, 15000)
            
            self.calculate_blade_ready_time()
        
        # Mini Move pricing
        elif self.service_type == 'mini_move' and self.mini_move_package:
            self.base_price_cents = self.mini_move_package.base_price_cents
            
            self.organizing_total_cents = self.calculate_organizing_costs()
            self.organizing_tax_cents = self.calculate_organizing_tax()
            self.coi_fee_cents = self.calculate_coi_fee()
            
            if self.pickup_date:
                self.surcharge_cents = calculate_surcharges_for_date(
                    self.base_price_cents,
                    self.pickup_date,
                    self.service_type
                )

            self.geographic_surcharge_cents = self.calculate_geographic_surcharge()
            self.time_window_surcharge_cents = self.calculate_time_window_surcharge()

        # Standard Delivery pricing
        elif self.service_type == 'standard_delivery':
            config = StandardDeliveryConfig.objects.filter(is_active=True).first()
            if config:
                if self.standard_delivery_item_count and self.standard_delivery_item_count > 0:
                    item_total = config.price_per_item_cents * self.standard_delivery_item_count
                    self.base_price_cents = max(item_total, config.minimum_charge_cents)
                else:
                    self.base_price_cents = 0

                if self.specialty_items.exists():
                    specialty_total = 0
                    for booking_item in self.bookingspecialtyitem_set.all():
                        specialty_total += booking_item.subtotal_cents
                    self.base_price_cents += specialty_total

                # Apply same-day delivery surcharge
                if self.is_same_day_delivery:
                    self.same_day_surcharge_cents = config.same_day_flat_rate_cents
            
            # Weekend/peak date surcharges
            if self.pickup_date:
                self.surcharge_cents = calculate_surcharges_for_date(
                    self.base_price_cents,
                    self.pickup_date,
                    self.service_type
                )

            self.geographic_surcharge_cents = self.calculate_geographic_surcharge()
            self.coi_fee_cents = self.calculate_coi_fee()

        # Specialty Item pricing
        elif self.service_type == 'specialty_item':
            specialty_total = 0
            for booking_item in self.bookingspecialtyitem_set.all():
                specialty_total += booking_item.subtotal_cents
            self.base_price_cents = specialty_total
            
            # Apply same-day delivery surcharge for specialty items
            if self.is_same_day_delivery:
                config = StandardDeliveryConfig.objects.filter(is_active=True).first()
                if config:
                    self.same_day_surcharge_cents = config.same_day_flat_rate_cents
            
            # Apply weekend/peak date surcharges
            if self.pickup_date:
                self.surcharge_cents = calculate_surcharges_for_date(
                    self.base_price_cents,
                    self.pickup_date,
                    self.service_type
                )

            self.geographic_surcharge_cents = self.calculate_geographic_surcharge()
            self.coi_fee_cents = self.calculate_coi_fee()
        
        # Calculate total
        pre_discount = (
            self.base_price_cents +
            self.surcharge_cents +
            self.same_day_surcharge_cents +
            self.coi_fee_cents +
            self.organizing_total_cents +
            self.organizing_tax_cents +
            self.geographic_surcharge_cents +
            self.time_window_surcharge_cents
        )
        self.pre_discount_total_cents = pre_discount

        if self.discount_code_id and self.discount_amount_cents > 0:
            self.total_price_cents = max(0, pre_discount - self.discount_amount_cents)
        else:
            self.total_price_cents = pre_discount
    
    def get_pricing_breakdown(self):
        """Return detailed pricing breakdown for display"""
        breakdown = {
            'base_price_dollars': self.base_price_dollars,
            'surcharge_dollars': self.surcharge_dollars,
            'same_day_surcharge_dollars': self.same_day_surcharge_dollars,
            'coi_fee_dollars': self.coi_fee_dollars,
            'organizing_total_dollars': self.organizing_total_dollars,
            'organizing_tax_dollars': self.organizing_tax_dollars,
            'geographic_surcharge_dollars': self.geographic_surcharge_dollars,
            'time_window_surcharge_dollars': self.time_window_surcharge_dollars,
            'total_price_dollars': self.total_price_dollars,
            'service_type': self.get_service_type_display(),
        }
        
        if self.discount_amount_cents > 0:
            breakdown['discount_amount_dollars'] = self.discount_amount_dollars
            breakdown['pre_discount_total_dollars'] = self.pre_discount_total_dollars
            if self.discount_code:
                breakdown['discount_code'] = self.discount_code.code
                breakdown['discount_description'] = self.discount_code.discount_value_display

        if self.organizing_total_cents > 0:
            breakdown['organizing_services'] = self.get_organizing_services_breakdown()

        if self.service_type == 'blade_transfer':
            breakdown['blade_details'] = {
                'airport': self.blade_airport,
                'bag_count': self.blade_bag_count,
                'per_bag_price': 75,
                'flight_date': self.blade_flight_date.isoformat() if self.blade_flight_date else None,
                'flight_time': self.blade_flight_time.isoformat() if self.blade_flight_time else None,
                'ready_time': self.blade_ready_time.isoformat() if self.blade_ready_time else None,
            }
        
        return breakdown
    
    def get_organizing_services_breakdown(self):
        """Get detailed breakdown of organizing services"""
        if self.service_type != 'mini_move' or not self.mini_move_package:
            return {}
        
        from apps.services.models import OrganizingService
        
        services = []
        tier = self.mini_move_package.package_type
        
        if self.include_packing:
            try:
                packing_service = OrganizingService.objects.get(
                    mini_move_tier=tier,
                    is_packing_service=True,
                    is_active=True
                )
                services.append({
                    'name': packing_service.name,
                    'price_dollars': packing_service.price_dollars,
                    'duration_hours': packing_service.duration_hours,
                    'organizer_count': packing_service.organizer_count,
                    'supplies_allowance': packing_service.supplies_allowance_dollars
                })
            except OrganizingService.DoesNotExist:
                pass
        
        if self.include_unpacking:
            try:
                unpacking_service = OrganizingService.objects.get(
                    mini_move_tier=tier,
                    is_packing_service=False,
                    is_active=True
                )
                services.append({
                    'name': unpacking_service.name,
                    'price_dollars': unpacking_service.price_dollars,
                    'duration_hours': unpacking_service.duration_hours,
                    'organizer_count': unpacking_service.organizer_count,
                    'supplies_allowance': 0
                })
            except OrganizingService.DoesNotExist:
                pass
        
        return services
```

# ──── backend/apps/bookings/pricing_utils.py ────

```python
"""
Pricing utility functions for bookings.
Separated from views.py to avoid circular imports.
"""


def calculate_geographic_surcharge_from_zips(pickup_zip, delivery_zip, fallback_is_outside=False):
    """
    Calculate $175 surcharge for EACH address outside core service area.
    Returns surcharge in cents: 0, 17500, or 35000.

    If ZIP codes not provided, falls back to is_outside_core_area boolean (legacy).
    """
    from .zip_codes import validate_service_area

    surcharge_count = 0

    if pickup_zip or delivery_zip:
        # New behavior: check each ZIP independently
        if pickup_zip:
            _, pickup_surcharge, _, _ = validate_service_area(pickup_zip)
            if pickup_surcharge:
                surcharge_count += 1

        if delivery_zip:
            _, delivery_surcharge, _, _ = validate_service_area(delivery_zip)
            if delivery_surcharge:
                surcharge_count += 1
    elif fallback_is_outside:
        # Legacy fallback: boolean flag (charges only once)
        surcharge_count = 1

    return 17500 * surcharge_count
```

# ──── backend/apps/bookings/serializers.py ────

```python
# backend/apps/bookings/serializers.py
from rest_framework import serializers
from django.contrib.auth.models import User
from django.utils import timezone
from datetime import timedelta, time as dt_time
from .models import Booking, Address, GuestCheckout, BookingSpecialtyItem
from .pricing_utils import calculate_geographic_surcharge_from_zips
from apps.services.models import MiniMovePackage, SpecialtyItem, OrganizingService, StandardDeliveryConfig, calculate_surcharges_for_date


class AddressSerializer(serializers.ModelSerializer):
    class Meta:
        model = Address
        fields = (
            'id', 'address_line_1', 'address_line_2', 
            'city', 'state', 'zip_code'
        )


class GuestCheckoutSerializer(serializers.ModelSerializer):
    class Meta:
        model = GuestCheckout
        fields = ('first_name', 'last_name', 'email', 'phone')


class OrganizingServiceDetailSerializer(serializers.ModelSerializer):
    """Detailed organizing service info for booking responses"""
    price_dollars = serializers.ReadOnlyField()
    supplies_allowance_dollars = serializers.ReadOnlyField()
    
    class Meta:
        model = OrganizingService
        fields = (
            'id', 'service_type', 'name', 'description',
            'price_dollars', 'duration_hours', 'organizer_count',
            'supplies_allowance_dollars', 'is_packing_service'
        )


class BookingSerializer(serializers.ModelSerializer):
    customer_name = serializers.SerializerMethodField()
    customer_email = serializers.SerializerMethodField()
    pickup_address = AddressSerializer(read_only=True)
    delivery_address = AddressSerializer(read_only=True)
    guest_checkout = GuestCheckoutSerializer(read_only=True)
    total_price_dollars = serializers.ReadOnlyField()
    organizing_total_dollars = serializers.ReadOnlyField()
    pricing_breakdown = serializers.SerializerMethodField()
    organizing_services_breakdown = serializers.SerializerMethodField()
    
    pickup_date = serializers.DateField(format='%Y-%m-%d')
    blade_flight_date = serializers.DateField(format='%Y-%m-%d', allow_null=True)
    
    class Meta:
        model = Booking
        fields = (
            'id', 'booking_number', 'customer_name', 'customer_email',
            'service_type', 'pickup_date', 'pickup_time', 'specific_pickup_hour', 'status',
            'pickup_address', 'delivery_address', 'guest_checkout',
            'special_instructions', 'coi_required', 'is_outside_core_area',
            'include_packing', 'include_unpacking',
            'blade_airport', 'blade_flight_date', 'blade_flight_time', 
            'blade_bag_count', 'blade_ready_time',
            'total_price_dollars', 'organizing_total_dollars',
            'pricing_breakdown', 'organizing_services_breakdown', 'created_at'
        )
    
    def get_customer_name(self, obj):
        return obj.get_customer_name()
    
    def get_customer_email(self, obj):
        return obj.get_customer_email()
    
    def get_pricing_breakdown(self, obj):
        return obj.get_pricing_breakdown()
    
    def get_organizing_services_breakdown(self, obj):
        return obj.get_organizing_services_breakdown()


class BookingStatusSerializer(serializers.ModelSerializer):
    customer_name = serializers.SerializerMethodField()
    pickup_address = AddressSerializer(read_only=True)
    delivery_address = AddressSerializer(read_only=True)
    total_price_dollars = serializers.ReadOnlyField()
    organizing_total_dollars = serializers.ReadOnlyField()
    
    pickup_date = serializers.DateField(format='%Y-%m-%d')
    blade_flight_date = serializers.DateField(format='%Y-%m-%d', allow_null=True)
    
    class Meta:
        model = Booking
        fields = (
            'booking_number', 'customer_name', 'service_type', 
            'pickup_date', 'pickup_time', 'specific_pickup_hour', 'status',
            'pickup_address', 'delivery_address',
            'include_packing', 'include_unpacking',
            'blade_airport', 'blade_flight_date', 'blade_flight_time', 
            'blade_bag_count', 'blade_ready_time',
            'total_price_dollars', 'organizing_total_dollars', 'created_at'
        )
    
    def get_customer_name(self, obj):
        return obj.get_customer_name()


class PricingPreviewSerializer(serializers.Serializer):
    service_type = serializers.ChoiceField(choices=[
        ('mini_move', 'Mini Move'),
        ('standard_delivery', 'Standard Delivery'),
        ('specialty_item', 'Specialty Item'),
        ('blade_transfer', 'BLADE Airport Transfer'),
    ])
    pickup_date = serializers.DateField()
    
    # Mini Move fields
    mini_move_package_id = serializers.UUIDField(required=False)
    coi_required = serializers.BooleanField(required=False, default=False)
    include_packing = serializers.BooleanField(required=False, default=False)
    include_unpacking = serializers.BooleanField(required=False, default=False)
    
    pickup_time = serializers.ChoiceField(
        choices=[
            ('morning', '8 AM - 11 AM'),
            ('morning_specific', 'Specific 1-hour window'),
            ('no_time_preference', 'No time preference'),
        ],
        required=False,
        default='morning'
    )
    specific_pickup_hour = serializers.IntegerField(required=False, min_value=8, max_value=10)
    is_outside_core_area = serializers.BooleanField(required=False, default=False)
    # ZIP codes for accurate geographic surcharge calculation ($175 per out-of-zone address)
    pickup_zip_code = serializers.CharField(required=False, max_length=10)
    delivery_zip_code = serializers.CharField(required=False, max_length=10)
    
    # Standard Delivery fields
    standard_delivery_item_count = serializers.IntegerField(required=False, min_value=0)
    is_same_day_delivery = serializers.BooleanField(required=False, default=False)
    
    specialty_items = serializers.ListField(
        child=serializers.DictField(),
        required=False,
        allow_empty=True,
        help_text="List of {item_id: UUID, quantity: int}"
    )
    
    # BLADE fields
    blade_airport = serializers.ChoiceField(
        choices=[('JFK', 'JFK'), ('EWR', 'EWR')],
        required=False
    )
    blade_flight_date = serializers.DateField(required=False)
    blade_flight_time = serializers.TimeField(required=False)
    blade_bag_count = serializers.IntegerField(required=False, min_value=2)

    # Discount code (optional)
    discount_code = serializers.CharField(required=False, max_length=50, allow_blank=True)
    discount_email = serializers.EmailField(required=False, allow_blank=True)

    def validate_specialty_items(self, value):
        """Validate specialty items list with quantities"""
        if not value:
            return []
        
        for item in value:
            if 'item_id' not in item or 'quantity' not in item:
                raise serializers.ValidationError(
                    "Each specialty item must have 'item_id' and 'quantity'"
                )
            if item['quantity'] < 1:
                raise serializers.ValidationError("Quantity must be at least 1")
        
        return value
    
    def validate(self, attrs):
        service_type = attrs.get('service_type')
        
        # BLADE validation
        if service_type == 'blade_transfer':
            if not attrs.get('blade_airport'):
                raise serializers.ValidationError({'blade_airport': 'Airport selection required'})
            if not attrs.get('blade_flight_date'):
                raise serializers.ValidationError({'blade_flight_date': 'Flight date required'})
            if not attrs.get('blade_flight_time'):
                raise serializers.ValidationError({'blade_flight_time': 'Flight time required'})
            if not attrs.get('blade_bag_count'):
                raise serializers.ValidationError({'blade_bag_count': 'Bag count required'})
            
            if attrs.get('blade_bag_count', 0) < 2:
                raise serializers.ValidationError({'blade_bag_count': 'Minimum 2 bags'})
        
        # Standard Delivery validation
        elif service_type == 'standard_delivery':
            item_count = attrs.get('standard_delivery_item_count', 0)
            specialty_items = attrs.get('specialty_items', [])
            
            if item_count == 0 and len(specialty_items) == 0:
                raise serializers.ValidationError({
                    'standard_delivery': 'At least one item required'
                })
        
        return attrs


class GuestPaymentIntentSerializer(serializers.Serializer):
    """
    Serializer for creating payment intent BEFORE guest booking
    ✅ NOW SUPPORTS QUANTITIES
    """
    
    # Guest customer info
    first_name = serializers.CharField(max_length=100)
    last_name = serializers.CharField(max_length=100)
    email = serializers.EmailField()
    phone = serializers.CharField(max_length=20)
    
    service_type = serializers.ChoiceField(choices=[
        ('mini_move', 'Mini Move'),
        ('standard_delivery', 'Standard Delivery'),
        ('specialty_item', 'Specialty Item'),
        ('blade_transfer', 'BLADE Airport Transfer'),
    ])
    
    # Service-specific fields
    mini_move_package_id = serializers.UUIDField(required=False, allow_null=True)
    include_packing = serializers.BooleanField(default=False)
    include_unpacking = serializers.BooleanField(default=False)
    standard_delivery_item_count = serializers.IntegerField(required=False, min_value=0)
    is_same_day_delivery = serializers.BooleanField(default=False)
    
    specialty_items = serializers.ListField(
        child=serializers.DictField(),
        required=False,
        allow_empty=True,
        help_text="List of {item_id: UUID, quantity: int}"
    )
    
    # BLADE fields
    blade_airport = serializers.ChoiceField(choices=[('JFK', 'JFK'), ('EWR', 'EWR')], required=False)
    blade_flight_date = serializers.DateField(required=False)
    blade_flight_time = serializers.TimeField(required=False)
    blade_bag_count = serializers.IntegerField(required=False, min_value=2)
    
    pickup_date = serializers.DateField()
    pickup_time = serializers.ChoiceField(choices=[
        ('morning', '8 AM - 11 AM'),
        ('morning_specific', 'Specific 1-hour window'),
        ('no_time_preference', 'No time preference'),
    ], required=False)
    specific_pickup_hour = serializers.IntegerField(required=False, allow_null=True)
    
    coi_required = serializers.BooleanField(default=False)
    is_outside_core_area = serializers.BooleanField(default=False)
    # ZIP codes for accurate geographic surcharge calculation ($175 per out-of-zone address)
    pickup_zip_code = serializers.CharField(required=False, max_length=10)
    delivery_zip_code = serializers.CharField(required=False, max_length=10)

    # Discount code (optional)
    discount_code = serializers.CharField(required=False, max_length=50, allow_blank=True)

    def validate_specialty_items(self, value):
        """Validate specialty items with quantities"""
        if not value:
            return []

        for item in value:
            if 'item_id' not in item or 'quantity' not in item:
                raise serializers.ValidationError(
                    "Each specialty item must have 'item_id' and 'quantity'"
                )
            if item['quantity'] < 1:
                raise serializers.ValidationError("Quantity must be at least 1")

        return value

    def validate(self, attrs):
        service_type = attrs['service_type']

        if service_type == 'blade_transfer':
            if not all([attrs.get('blade_airport'), attrs.get('blade_flight_date'),
                       attrs.get('blade_flight_time'), attrs.get('blade_bag_count')]):
                raise serializers.ValidationError("All BLADE fields required")

            if attrs.get('blade_bag_count', 0) < 2:
                raise serializers.ValidationError("Minimum 2 bags")

        elif service_type == 'mini_move':
            if not attrs.get('mini_move_package_id'):
                raise serializers.ValidationError("Package ID required")

        elif service_type == 'standard_delivery':
            item_count = attrs.get('standard_delivery_item_count', 0)
            specialty_items = attrs.get('specialty_items', [])

            if item_count == 0 and len(specialty_items) == 0:
                raise serializers.ValidationError("At least one item required")

        elif service_type == 'specialty_item':
            if not attrs.get('specialty_items'):
                raise serializers.ValidationError("Specialty items required")

        # Calculate pricing
        attrs['calculated_total_cents'] = self._calculate_total_price(attrs)

        return attrs
    
    def _calculate_total_price(self, data):
        """
        Calculate total price WITH QUANTITIES
        ✅ OPTIMIZED: Bulk fetch specialty items to avoid N+1 queries
        """
        service_type = data['service_type']
        total_cents = 0
        
        # BLADE pricing
        if service_type == 'blade_transfer':
            bag_count = data.get('blade_bag_count', 0)
            total_cents = max(bag_count * 7500, 15000)

        # Mini Move pricing
        elif service_type == 'mini_move':
            try:
                package = MiniMovePackage.objects.get(id=data['mini_move_package_id'])
                total_cents = package.base_price_cents
                
                if data.get('coi_required') and not package.coi_included:
                    total_cents += package.coi_fee_cents
                
                # Organizing services
                organizing_total = 0
                if data.get('include_packing'):
                    packing = OrganizingService.objects.filter(
                        mini_move_tier=package.package_type,
                        is_packing_service=True,
                        is_active=True
                    ).first()
                    if packing:
                        organizing_total += packing.price_cents
                
                if data.get('include_unpacking'):
                    unpacking = OrganizingService.objects.filter(
                        mini_move_tier=package.package_type,
                        is_packing_service=False,
                        is_active=True
                    ).first()
                    if unpacking:
                        organizing_total += unpacking.price_cents
                
                if organizing_total > 0:
                    total_cents += organizing_total + int(organizing_total * 0.0825)

                # Geographic surcharge: $175 per out-of-zone address (max $350)
                geographic_surcharge = calculate_geographic_surcharge_from_zips(
                    data.get('pickup_zip_code'),
                    data.get('delivery_zip_code'),
                    fallback_is_outside=data.get('is_outside_core_area', False)
                )
                total_cents += geographic_surcharge

                if data.get('pickup_time') == 'morning_specific' and package.package_type == 'standard':
                    total_cents += 17500

            except MiniMovePackage.DoesNotExist:
                raise serializers.ValidationError("Invalid package")

        # Standard Delivery pricing - ✅ OPTIMIZED WITH BULK FETCH
        elif service_type == 'standard_delivery':
            config = StandardDeliveryConfig.objects.filter(is_active=True).first()
            if config:
                item_count = data.get('standard_delivery_item_count', 0)
                if item_count > 0:
                    item_total = config.price_per_item_cents * item_count
                    total_cents = max(item_total, config.minimum_charge_cents)

                # ✅ OPTIMIZED: Bulk fetch specialty items (was N+1 query)
                specialty_items_data = data.get('specialty_items', [])
                if specialty_items_data:
                    # Extract all item IDs
                    item_ids = [item_data['item_id'] for item_data in specialty_items_data]

                    # Single query to fetch all items
                    items_dict = {
                        str(item.id): item
                        for item in SpecialtyItem.objects.filter(id__in=item_ids, is_active=True)
                    }

                    # Calculate totals
                    for item_data in specialty_items_data:
                        item_id = str(item_data['item_id'])
                        if item_id in items_dict:
                            item = items_dict[item_id]
                            quantity = item_data['quantity']
                            total_cents += item.price_cents * quantity

                if data.get('is_same_day_delivery'):
                    total_cents += config.same_day_flat_rate_cents

                if data.get('coi_required'):
                    total_cents += 5000

                # Geographic surcharge: $175 per out-of-zone address (max $350)
                geographic_surcharge = calculate_geographic_surcharge_from_zips(
                    data.get('pickup_zip_code'),
                    data.get('delivery_zip_code'),
                    fallback_is_outside=data.get('is_outside_core_area', False)
                )
                total_cents += geographic_surcharge

        # Specialty Item pricing - ✅ OPTIMIZED WITH BULK FETCH
        elif service_type == 'specialty_item':
            specialty_items_data = data.get('specialty_items', [])
            
            if specialty_items_data:
                # ✅ OPTIMIZED: Bulk fetch specialty items (was N+1 query)
                item_ids = [item_data['item_id'] for item_data in specialty_items_data]
                
                # Single query to fetch all items
                items_dict = {
                    str(item.id): item 
                    for item in SpecialtyItem.objects.filter(id__in=item_ids, is_active=True)
                }
                
                # Calculate totals
                for item_data in specialty_items_data:
                    item_id = str(item_data['item_id'])
                    if item_id in items_dict:
                        item = items_dict[item_id]
                        quantity = item_data['quantity']
                        total_cents += item.price_cents * quantity
            
            if data.get('is_same_day_delivery'):
                config = StandardDeliveryConfig.objects.filter(is_active=True).first()
                if config:
                    total_cents += config.same_day_flat_rate_cents
            
            if data.get('coi_required'):
                total_cents += 5000

            # Geographic surcharge: $175 per out-of-zone address (max $350)
            geographic_surcharge = calculate_geographic_surcharge_from_zips(
                data.get('pickup_zip_code'),
                data.get('delivery_zip_code'),
                fallback_is_outside=data.get('is_outside_core_area', False)
            )
            total_cents += geographic_surcharge

        # Weekend/peak date surcharges (peak dates override weekends)
        if service_type != 'blade_transfer' and data.get('pickup_date'):
            surcharge_amount = calculate_surcharges_for_date(
                total_cents,
                data['pickup_date'],
                service_type
            )
            total_cents += surcharge_amount

        # Apply discount code if provided
        discount_code_str = (data.get('discount_code') or '').strip()
        if discount_code_str:
            from .models import DiscountCode as DiscountCodeModel
            try:
                discount = DiscountCodeModel.objects.get(code__iexact=discount_code_str)
                email = data.get('email', '')
                is_valid, _ = discount.is_valid_for_customer(email)

                if is_valid and discount.is_valid_for_service(data['service_type']):
                    if total_cents >= discount.minimum_order_cents:
                        discount_amount = discount.calculate_discount(total_cents)
                        data['_discount_amount_cents'] = discount_amount
                        data['_discount_code_id'] = str(discount.id)
                        total_cents = max(0, total_cents - discount_amount)
            except DiscountCodeModel.DoesNotExist:
                pass

        return total_cents


class GuestBookingCreateSerializer(serializers.Serializer):
    """
    Create booking for guest AFTER payment succeeds
    ✅ NOW SUPPORTS QUANTITIES
    """
    
    payment_intent_id = serializers.CharField(required=True)
    
    # Guest info
    first_name = serializers.CharField(max_length=100)
    last_name = serializers.CharField(max_length=100)
    email = serializers.EmailField()
    phone = serializers.CharField(max_length=20)
    
    service_type = serializers.ChoiceField(choices=[
        ('mini_move', 'Mini Move'),
        ('standard_delivery', 'Standard Delivery'),
        ('specialty_item', 'Specialty Item'),
        ('blade_transfer', 'BLADE Airport Transfer'),
    ])
    
    mini_move_package_id = serializers.UUIDField(required=False)
    standard_delivery_item_count = serializers.IntegerField(required=False, min_value=0)
    is_same_day_delivery = serializers.BooleanField(default=False)
    
    specialty_items = serializers.ListField(
        child=serializers.DictField(),
        required=False,
        allow_empty=True
    )
    
    include_packing = serializers.BooleanField(default=False)
    include_unpacking = serializers.BooleanField(default=False)
    
    # BLADE fields
    blade_airport = serializers.ChoiceField(choices=[('JFK', 'JFK'), ('EWR', 'EWR')], required=False)
    blade_flight_date = serializers.DateField(required=False)
    blade_flight_time = serializers.TimeField(required=False)
    blade_bag_count = serializers.IntegerField(required=False, min_value=2)
    
    pickup_date = serializers.DateField()
    pickup_time = serializers.ChoiceField(choices=[
        ('morning', '8 AM - 11 AM'),
        ('morning_specific', 'Specific 1-hour window'),
        ('no_time_preference', 'No time preference'),
    ], default='morning')
    specific_pickup_hour = serializers.IntegerField(required=False, min_value=8, max_value=10)
    
    is_outside_core_area = serializers.BooleanField(default=False)
    
    pickup_address = serializers.DictField()
    delivery_address = serializers.DictField()
    
    special_instructions = serializers.CharField(required=False, allow_blank=True)
    coi_required = serializers.BooleanField(default=False)

    # Discount code (optional)
    discount_code = serializers.CharField(required=False, max_length=50, allow_blank=True)

    def validate_pickup_address(self, value):
        required_fields = ['address_line_1', 'city', 'state', 'zip_code']
        for field in required_fields:
            if field not in value:
                raise serializers.ValidationError(f"Missing: {field}")
        
        from .zip_codes import validate_service_area
        
        zip_code = value.get('zip_code')
        is_serviceable, requires_surcharge, zone, error = validate_service_area(zip_code)
        
        if not is_serviceable:
            raise serializers.ValidationError(error)
        
        return value

    def validate_delivery_address(self, value):
        required_fields = ['address_line_1', 'city', 'state', 'zip_code']
        for field in required_fields:
            if field not in value:
                raise serializers.ValidationError(f"Missing: {field}")
        
        if self.initial_data.get('service_type') == 'blade_transfer':
            return value
        
        from .zip_codes import validate_service_area
        
        zip_code = value.get('zip_code')
        is_serviceable, requires_surcharge, zone, error = validate_service_area(zip_code)
        
        if not is_serviceable:
            raise serializers.ValidationError(error)
        
        return value
    
    def validate_specialty_items(self, value):
        if not value:
            return []
        
        for item in value:
            if 'item_id' not in item or 'quantity' not in item:
                raise serializers.ValidationError(
                    "Each item needs 'item_id' and 'quantity'"
                )
            if item['quantity'] < 1:
                raise serializers.ValidationError("Quantity must be >= 1")
        
        return value
    
    def validate(self, attrs):
        service_type = attrs['service_type']
        pickup_time = attrs.get('pickup_time', 'morning')
        
        if pickup_time == 'morning_specific' and not attrs.get('specific_pickup_hour'):
            raise serializers.ValidationError("specific_pickup_hour required")
        
        # BLADE validation
        if service_type == 'blade_transfer':
            if not all([attrs.get('blade_airport'), attrs.get('blade_flight_date'), 
                       attrs.get('blade_flight_time'), attrs.get('blade_bag_count')]):
                raise serializers.ValidationError("All BLADE fields required")
            
            if attrs.get('blade_bag_count', 0) < 2:
                raise serializers.ValidationError("Minimum 2 bags")
        
        # Mini Move validation
        elif service_type == 'mini_move':
            if not attrs.get('mini_move_package_id'):
                raise serializers.ValidationError("Package ID required")
        
        # Standard Delivery validation
        elif service_type == 'standard_delivery':
            item_count = attrs.get('standard_delivery_item_count', 0)
            specialty_items = attrs.get('specialty_items', [])
            
            if item_count == 0 and len(specialty_items) == 0:
                raise serializers.ValidationError("At least one item required")
        
        elif service_type == 'specialty_item':
            if not attrs.get('specialty_items'):
                raise serializers.ValidationError("Specialty items required")
        
        return attrs
    
    def create(self, validated_data):
        payment_intent_id = validated_data.pop('payment_intent_id')
        
        # Create guest checkout
        guest_checkout = GuestCheckout.objects.create(
            first_name=validated_data['first_name'],
            last_name=validated_data['last_name'],
            email=validated_data['email'],
            phone=validated_data['phone']
        )
        
        # Create addresses
        pickup_address_data = validated_data.pop('pickup_address')
        pickup_address = Address.objects.create(**pickup_address_data)
        
        delivery_address_data = validated_data.pop('delivery_address')
        delivery_address = Address.objects.create(**delivery_address_data)
        
        # Extract specialty items BEFORE creating booking
        specialty_items_data = validated_data.pop('specialty_items', [])
        
        # Create booking
        booking = Booking.objects.create(
            guest_checkout=guest_checkout,
            service_type=validated_data['service_type'],
            pickup_date=validated_data['pickup_date'],
            pickup_time=validated_data['pickup_time'],
            specific_pickup_hour=validated_data.get('specific_pickup_hour'),
            pickup_address=pickup_address,
            delivery_address=delivery_address,
            special_instructions=validated_data.get('special_instructions', ''),
            coi_required=validated_data.get('coi_required', False),
            is_outside_core_area=validated_data.get('is_outside_core_area', False),
            standard_delivery_item_count=validated_data.get('standard_delivery_item_count'),
            is_same_day_delivery=validated_data.get('is_same_day_delivery', False),
            include_packing=validated_data.get('include_packing', False),
            include_unpacking=validated_data.get('include_unpacking', False),
            blade_airport=validated_data.get('blade_airport'),
            blade_flight_date=validated_data.get('blade_flight_date'),
            blade_flight_time=validated_data.get('blade_flight_time'),
            blade_bag_count=validated_data.get('blade_bag_count'),
            status='pending',
        )
        
        # Handle mini move package
        if validated_data['service_type'] == 'mini_move':
            try:
                package = MiniMovePackage.objects.get(id=validated_data['mini_move_package_id'])
                booking.mini_move_package = package
            except MiniMovePackage.DoesNotExist:
                raise serializers.ValidationError("Invalid package")
        
        # ✅ OPTIMIZED: Bulk fetch specialty items (was N+1 query)
        if specialty_items_data:
            booking.save()  # Save first to get ID
            
            # Bulk fetch all specialty items in one query
            item_ids = [item_data['item_id'] for item_data in specialty_items_data]
            items_dict = {
                str(item.id): item 
                for item in SpecialtyItem.objects.filter(id__in=item_ids)
            }
            
            # Create BookingSpecialtyItem records
            for item_data in specialty_items_data:
                item_id = str(item_data['item_id'])
                if item_id in items_dict:
                    BookingSpecialtyItem.objects.create(
                        booking=booking,
                        specialty_item=items_dict[item_id],
                        quantity=item_data['quantity']
                    )
        
        # Save to recalculate pricing with package + specialty items set
        booking.save()

        # Apply discount code AFTER save so pre_discount_total_cents is correct
        discount_code_str = (validated_data.get('discount_code') or '').strip()
        if discount_code_str:
            from .models import DiscountCode as DiscountCodeModel
            try:
                discount = DiscountCodeModel.objects.get(code__iexact=discount_code_str)
                email = validated_data['email']
                is_valid, _ = discount.is_valid_for_customer(email)

                if is_valid and discount.is_valid_for_service(validated_data['service_type']):
                    discount_amount = discount.calculate_discount(booking.pre_discount_total_cents)
                    booking.discount_code = discount
                    booking.discount_amount_cents = discount_amount
                    discount.record_usage(email=email, booking=booking)
                    booking.save()
            except DiscountCodeModel.DoesNotExist:
                pass

        return booking
```

# ──── backend/apps/bookings/signals.py ────

```python
import logging
from django.db.models.signals import pre_save
from django.dispatch import receiver
from apps.bookings.models import Booking
from apps.customers.emails import (
    send_booking_status_update_email,
    send_booking_confirmation_email,
    send_review_request_email,
)

logger = logging.getLogger(__name__)


@receiver(pre_save, sender=Booking)
def booking_status_changed(sender, instance, **kwargs):
    """
    Send emails when a booking's status changes.
    - Always send status-update email on change.
    - Additionally send confirmation when becoming 'paid' or 'confirmed'.
    """
    if not instance.pk:
        # New booking being created; no "old" status to compare here.
        return

    try:
        old = Booking.objects.get(pk=instance.pk)
    except Booking.DoesNotExist:
        # Shouldn't happen for existing pk, but guard anyway.
        return

    old_status = old.status
    new_status = instance.status

    if old_status == new_status:
        return

    logger.info(f"📧 Booking {old.booking_number} status changed: {old_status} → {new_status}")
    # Status update notification to customer
    try:
        send_booking_status_update_email(instance, old_status, new_status)
    except Exception as e:
        logger.error(f"Failed to send status update email for {instance.booking_number}: {e}", exc_info=True)

    # Confirmation on transition to paid/confirmed
    if new_status in ('paid', 'confirmed'):
        try:
            send_booking_confirmation_email(instance)
        except Exception as e:
            logger.error(f"Failed to send confirmation for {instance.booking_number}: {e}", exc_info=True)

    # Review request on completion
    if new_status == 'completed':
        try:
            send_review_request_email(instance)
        except Exception as e:
            logger.error(f"Failed to send review request for {instance.booking_number}: {e}", exc_info=True)
```

# ──── backend/apps/bookings/tasks.py ────

```python
# apps/bookings/tasks.py
from celery import shared_task
from django.utils import timezone
from datetime import timedelta
import logging

logger = logging.getLogger(__name__)


@shared_task
def send_booking_reminders():
    """
    Send 24-hour reminder emails for upcoming bookings.
    Runs every hour via Celery Beat.
    """
    from apps.bookings.models import Booking
    from apps.customers.emails import send_booking_reminder_email
    
    try:
        # Calculate target time: 24 hours from now (with 1-hour window)
        now = timezone.now()
        target_start = now + timedelta(hours=23)
        target_end = now + timedelta(hours=25)
        
        logger.info(f'Checking for bookings between {target_start} and {target_end}')
        
        # Find confirmed bookings that:
        # 1. Pickup is in 23-25 hours
        # 2. Haven't received reminder yet
        # 3. Not cancelled/completed
        bookings = Booking.objects.filter(
            status__in=['pending', 'paid', 'confirmed'],
            pickup_date__gte=target_start.date(),
            pickup_date__lte=target_end.date(),
            reminder_sent_at__isnull=True,
            deleted_at__isnull=True
        )
        
        sent_count = 0
        failed_count = 0
        
        for booking in bookings:
            # Double-check the booking is really in the 24hr window
            # (pickup_date is date-only, so we check against date)
            if booking.pickup_date == target_start.date() or booking.pickup_date == target_end.date():
                logger.info(f'Sending reminder for booking {booking.booking_number}')
                
                if send_booking_reminder_email(booking):
                    sent_count += 1
                else:
                    failed_count += 1
        
        logger.info(f'✓ Reminder task complete: {sent_count} sent, {failed_count} failed')
        return {
            'sent': sent_count,
            'failed': failed_count,
            'checked_range': f'{target_start} to {target_end}'
        }
        
    except Exception as e:
        logger.error(f'Error in send_booking_reminders task: {e}', exc_info=True)
        return {'error': str(e)}
```

# ──── backend/apps/bookings/urls.py ────

```python
# backend/apps/bookings/urls.py
from django.urls import path
from . import views

# Public booking API patterns - no authentication required
urlpatterns = [
    # Service information
    path('services/', views.ServiceCatalogView.as_view(), name='service-catalog'),
    path('pricing-preview/', views.PricingPreviewView.as_view(), name='pricing-preview'),
    path('availability/', views.CalendarAvailabilityView.as_view(), name='calendar-availability'),
    
    # Organizing service endpoints
    path('services/mini-moves-with-organizing/', views.ServiceCatalogWithOrganizingView.as_view(), name='mini-moves-with-organizing'),
    path('services/organizing-by-tier/', views.OrganizingServicesByTierView.as_view(), name='organizing-by-tier'),
    path('services/organizing/<uuid:service_id>/', views.OrganizingServiceDetailView.as_view(), name='organizing-service-detail'),
    
    # Payment intent creation (BEFORE booking)
    path('create-payment-intent/', views.CreateGuestPaymentIntentView.as_view(), name='create-guest-payment-intent'),
    
    # Guest booking (requires payment_intent_id)
    path('guest-booking/', views.GuestBookingCreateView.as_view(), name='guest-booking-create'),
    
    # Booking status lookup (UUID only — non-guessable)
    path('booking-status/<str:booking_lookup>/', views.BookingStatusView.as_view(), name='booking-status'),
    
    # ZIP code validation endpoint
    path('validate-zip/', views.ValidateZipCodeView.as_view(), name='validate-zip'),

    # Discount code validation
    path('validate-discount/', views.ValidateDiscountCodeView.as_view(), name='validate-discount'),
]

```

# ──── backend/apps/bookings/views.py ────

```python
# backend/apps/bookings/views.py
from rest_framework import generics, status, permissions
from rest_framework.decorators import api_view, permission_classes
from rest_framework.response import Response
from rest_framework.views import APIView
from django.shortcuts import get_object_or_404
from django.utils import timezone
from collections import defaultdict
from datetime import date, timedelta, time as dt_time
import logging
import json
import stripe
from django.conf import settings

from .models import Booking, Address, GuestCheckout, check_same_day_restriction
from apps.payments.models import Payment
from .serializers import (
    BookingSerializer,
    GuestBookingCreateSerializer,
    GuestPaymentIntentSerializer,
    BookingStatusSerializer,
    PricingPreviewSerializer,
    AddressSerializer
)
from apps.services.models import (
    MiniMovePackage, 
    StandardDeliveryConfig, 
    SpecialtyItem, 
    OrganizingService,
    SurchargeRule
)
from apps.services.serializers import (
    ServiceCatalogSerializer,
    MiniMovePackageSerializer,
    OrganizingServiceSerializer,
    StandardDeliveryConfigSerializer,
    SpecialtyItemSerializer,
    MiniMoveWithOrganizingSerializer,
    OrganizingServicesByTierSerializer
)
from apps.payments.services import StripePaymentService
from .pricing_utils import calculate_geographic_surcharge_from_zips
from django.utils.decorators import method_decorator
from django_ratelimit.decorators import ratelimit

logger = logging.getLogger(__name__)

# Initialize Stripe
stripe.api_key = settings.STRIPE_SECRET_KEY


class ServiceCatalogView(APIView):
    """Get all available services including organizing services - no authentication required"""
    permission_classes = [permissions.AllowAny]
    
    def get(self, request):
        organizing_services = OrganizingService.objects.filter(
            is_active=True
        ).order_by('mini_move_tier', 'is_packing_service')
        
        mini_move_packages = MiniMovePackage.objects.filter(
            is_active=True
        ).order_by('base_price_cents')
        
        specialty_items = SpecialtyItem.objects.filter(is_active=True)
        standard_config = StandardDeliveryConfig.objects.filter(is_active=True).first()
        
        response_data = {
            'mini_move_packages': MiniMovePackageSerializer(mini_move_packages, many=True).data,
            'organizing_services': OrganizingServiceSerializer(organizing_services, many=True).data,
            'specialty_items': SpecialtyItemSerializer(specialty_items, many=True).data,
            'standard_delivery': StandardDeliveryConfigSerializer(standard_config).data if standard_config else None
        }
        
        return Response(response_data)


class ServiceCatalogWithOrganizingView(APIView):
    """Get Mini Move packages with their organizing options - optimized for booking wizard"""
    permission_classes = [permissions.AllowAny]
    
    def get(self, request):
        serializer = MiniMoveWithOrganizingSerializer()
        return Response({
            'mini_moves_with_organizing': serializer.to_representation(None)
        })


class OrganizingServicesByTierView(APIView):
    """Get organizing services grouped by Mini Move tier - for easy frontend consumption"""
    permission_classes = [permissions.AllowAny]
    
    def get(self, request):
        serializer = OrganizingServicesByTierSerializer()
        return Response(serializer.to_representation(None))


class PricingPreviewView(APIView):
    """Calculate pricing for booking selection including organizing services + BLADE - no authentication required"""
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        serializer = PricingPreviewSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        service_type = serializer.validated_data['service_type']
        pickup_date = serializer.validated_data['pickup_date']
        
        # ========== SAME-DAY RESTRICTION CHECK ==========
        if pickup_date:
            is_blocked, error_message = check_same_day_restriction(pickup_date)
            if is_blocked:
                return Response({
                    'error': 'same_day_restriction',
                    'message': error_message,
                    'contact_phone': '(631) 595-5100',
                    'pickup_date': str(pickup_date)
                }, status=status.HTTP_400_BAD_REQUEST)
        # ========== END RESTRICTION CHECK ==========
        
        base_price_cents = 0
        surcharge_cents = 0
        coi_fee_cents = 0
        organizing_total_cents = 0
        organizing_tax_cents = 0
        geographic_surcharge_cents = 0
        time_window_surcharge_cents = 0
        same_day_fee_cents = 0
        details = {}
        
        # BLADE pricing
        if service_type == 'blade_transfer':
            bag_count = serializer.validated_data.get('blade_bag_count', 0)
            
            if bag_count < 2:
                return Response({
                    'error': 'BLADE service requires minimum 2 bags'
                }, status=status.HTTP_400_BAD_REQUEST)
            
            per_bag_price = 7500  # $75 in cents
            base_price_cents = bag_count * per_bag_price
            base_price_cents = max(base_price_cents, 15000)  # $150 minimum
            
            # Calculate ready time
            flight_time = serializer.validated_data.get('blade_flight_time')
            if flight_time:
                if flight_time < dt_time(13, 0):
                    ready_time = dt_time(5, 0)
                else:
                    ready_time = dt_time(10, 0)
                
                details['ready_time'] = ready_time.isoformat()
            
            details['airport'] = serializer.validated_data.get('blade_airport')
            details['bag_count'] = bag_count
            details['per_bag_price'] = 75
            details['flight_date'] = serializer.validated_data.get('blade_flight_date').isoformat() if serializer.validated_data.get('blade_flight_date') else None
            details['flight_time'] = serializer.validated_data.get('blade_flight_time').isoformat() if serializer.validated_data.get('blade_flight_time') else None
        
        # Mini Move pricing
        elif service_type == 'mini_move':
            package_id = serializer.validated_data.get('mini_move_package_id')
            if package_id:
                try:
                    package = MiniMovePackage.objects.get(id=package_id, is_active=True)
                    base_price_cents = package.base_price_cents
                    details['package_name'] = package.name
                    details['package_tier'] = package.package_type
                    
                    coi_required = serializer.validated_data.get('coi_required', False)
                    if coi_required and not package.coi_included:
                        coi_fee_cents = package.coi_fee_cents
                        details['coi_required'] = True
                    
                    include_packing = serializer.validated_data.get('include_packing', False)
                    include_unpacking = serializer.validated_data.get('include_unpacking', False)
                    
                    organizing_services_breakdown = []
                    
                    if include_packing:
                        packing_service = OrganizingService.objects.filter(
                            mini_move_tier=package.package_type,
                            is_packing_service=True,
                            is_active=True
                        ).first()
                        
                        if packing_service:
                            organizing_total_cents += packing_service.price_cents
                            organizing_services_breakdown.append({
                                'service': 'packing',
                                'name': packing_service.name,
                                'price_dollars': packing_service.price_dollars,
                                'duration_hours': packing_service.duration_hours,
                                'organizer_count': packing_service.organizer_count,
                                'supplies_allowance_dollars': packing_service.supplies_allowance_dollars
                            })
                        else:
                            logger.warning(f"Packing service not found for tier {package.package_type}")
                            return Response({
                                'error': f'Packing service not available for {package.package_type} tier'
                            }, status=status.HTTP_400_BAD_REQUEST)
                    
                    if include_unpacking:
                        unpacking_service = OrganizingService.objects.filter(
                            mini_move_tier=package.package_type,
                            is_packing_service=False,
                            is_active=True
                        ).first()
                        
                        if unpacking_service:
                            organizing_total_cents += unpacking_service.price_cents
                            organizing_services_breakdown.append({
                                'service': 'unpacking',
                                'name': unpacking_service.name,
                                'price_dollars': unpacking_service.price_dollars,
                                'duration_hours': unpacking_service.duration_hours,
                                'organizer_count': unpacking_service.organizer_count,
                                'supplies_allowance_dollars': 0
                            })
                        else:
                            logger.warning(f"Unpacking service not found for tier {package.package_type}")
                            return Response({
                                'error': f'Unpacking service not available for {package.package_type} tier'
                            }, status=status.HTTP_400_BAD_REQUEST)
                    
                    if organizing_total_cents > 0:
                        organizing_tax_cents = int(organizing_total_cents * 0.0825)
                    
                    pickup_time = serializer.validated_data.get('pickup_time', 'morning')
                    if pickup_time == 'morning_specific' and package.package_type == 'standard':
                        time_window_surcharge_cents = 17500
                    
                    # Calculate geographic surcharge ($175 per out-of-zone address)
                    geographic_surcharge_cents = calculate_geographic_surcharge_from_zips(
                        serializer.validated_data.get('pickup_zip_code'),
                        serializer.validated_data.get('delivery_zip_code'),
                        fallback_is_outside=serializer.validated_data.get('is_outside_core_area', False)
                    )
                    
                    if organizing_services_breakdown:
                        details['organizing_services'] = organizing_services_breakdown
                    
                except MiniMovePackage.DoesNotExist:
                    return Response({'error': 'Invalid mini move package'}, status=status.HTTP_400_BAD_REQUEST)
        
        # Standard Delivery pricing
        elif service_type == 'standard_delivery':
            if serializer.validated_data.get('include_packing') or serializer.validated_data.get('include_unpacking'):
                return Response({
                    'error': 'Organizing services are only available for Mini Move bookings'
                }, status=status.HTTP_400_BAD_REQUEST)
            
            item_count = serializer.validated_data.get('standard_delivery_item_count', 0)
            specialty_items_data = serializer.validated_data.get('specialty_items', [])
            is_same_day = serializer.validated_data.get('is_same_day_delivery', False)
            
            config = StandardDeliveryConfig.objects.filter(is_active=True).first()
            if config:
                if item_count > 0:
                    item_total = config.price_per_item_cents * item_count
                    base_price_cents = max(item_total, config.minimum_charge_cents)

                    details['item_count'] = item_count
                    details['per_item_rate'] = config.price_per_item_cents / 100
                    details['minimum_charge'] = config.minimum_charge_cents / 100
                else:
                    base_price_cents = 0

                # Calculate specialty items with quantities
                if specialty_items_data:
                    specialty_items_list = []
                    specialty_total_cents = 0

                    for item_data in specialty_items_data:
                        item_id = item_data.get('item_id')
                        quantity = item_data.get('quantity', 1)

                        try:
                            specialty_item = SpecialtyItem.objects.get(id=item_id, is_active=True)
                            item_total = specialty_item.price_cents * quantity
                            specialty_total_cents += item_total

                            specialty_items_list.append({
                                'name': specialty_item.name,
                                'price_dollars': specialty_item.price_dollars,
                                'quantity': quantity,
                                'subtotal_dollars': item_total / 100
                            })
                        except SpecialtyItem.DoesNotExist:
                            logger.warning(f"Specialty item {item_id} not found")
                            continue

                    base_price_cents += specialty_total_cents
                    details['specialty_items'] = specialty_items_list

                if is_same_day:
                    same_day_fee_cents = config.same_day_flat_rate_cents
                    details['is_same_day'] = True
                    details['same_day_rate'] = config.same_day_flat_rate_cents / 100
            
            # Apply geographic surcharge for Standard Delivery ($175 per out-of-zone address)
            geographic_surcharge_cents = calculate_geographic_surcharge_from_zips(
                serializer.validated_data.get('pickup_zip_code'),
                serializer.validated_data.get('delivery_zip_code'),
                fallback_is_outside=serializer.validated_data.get('is_outside_core_area', False)
            )
            
            # Apply COI fee for Standard Delivery
            coi_required = serializer.validated_data.get('coi_required', False)
            if coi_required:
                coi_fee_cents = 5000
        
        # Specialty Item pricing with quantities
        elif service_type == 'specialty_item':
            if serializer.validated_data.get('include_packing') or serializer.validated_data.get('include_unpacking'):
                return Response({
                    'error': 'Organizing services are only available for Mini Move bookings'
                }, status=status.HTTP_400_BAD_REQUEST)
            
            specialty_items_data = serializer.validated_data.get('specialty_items', [])
            
            if specialty_items_data:
                specialty_items_list = []
                specialty_total_cents = 0
                
                for item_data in specialty_items_data:
                    item_id = item_data.get('item_id')
                    quantity = item_data.get('quantity', 1)
                    
                    try:
                        specialty_item = SpecialtyItem.objects.get(id=item_id, is_active=True)
                        item_total = specialty_item.price_cents * quantity
                        specialty_total_cents += item_total
                        
                        specialty_items_list.append({
                            'name': specialty_item.name,
                            'price_dollars': specialty_item.price_dollars,
                            'quantity': quantity,
                            'subtotal_dollars': item_total / 100
                        })
                    except SpecialtyItem.DoesNotExist:
                        logger.warning(f"Specialty item {item_id} not found")
                        continue
                
                base_price_cents = specialty_total_cents
                details['specialty_items'] = specialty_items_list
            
            # Apply same-day delivery for specialty items
            is_same_day = serializer.validated_data.get('is_same_day_delivery', False)
            if is_same_day:
                config = StandardDeliveryConfig.objects.filter(is_active=True).first()
                if config:
                    same_day_fee_cents = config.same_day_flat_rate_cents
                    details['is_same_day'] = True
                    details['same_day_rate'] = config.same_day_flat_rate_cents / 100
            
            # Apply geographic surcharge for Specialty Items ($175 per out-of-zone address)
            geographic_surcharge_cents = calculate_geographic_surcharge_from_zips(
                serializer.validated_data.get('pickup_zip_code'),
                serializer.validated_data.get('delivery_zip_code'),
                fallback_is_outside=serializer.validated_data.get('is_outside_core_area', False)
            )
            
            # Apply COI fee for Specialty Items
            coi_required = serializer.validated_data.get('coi_required', False)
            if coi_required:
                coi_fee_cents = 5000
        
        # Apply surcharges (NOT for BLADE)
        if service_type != 'blade_transfer' and pickup_date and base_price_cents > 0:
            active_surcharges = SurchargeRule.objects.filter(is_active=True)
            surcharge_details = []
            
            for surcharge in active_surcharges:
                surcharge_amount = surcharge.calculate_surcharge(base_price_cents, pickup_date, service_type)
                if surcharge_amount > 0:
                    surcharge_cents += surcharge_amount
                    surcharge_details.append({
                        'name': surcharge.name,
                        'amount_dollars': surcharge_amount / 100,
                        'reason': surcharge.description
                    })
            
            if surcharge_details:
                details['surcharges'] = surcharge_details
        
        total_price_cents = (
            base_price_cents +
            same_day_fee_cents +
            surcharge_cents +
            coi_fee_cents +
            organizing_total_cents +
            organizing_tax_cents +
            geographic_surcharge_cents +
            time_window_surcharge_cents
        )

        # Apply discount code if provided
        discount_amount_cents = 0
        discount_info = None

        discount_code_str = (serializer.validated_data.get('discount_code') or '').strip()
        discount_email = (serializer.validated_data.get('discount_email') or '').strip()

        if discount_code_str and discount_email:
            from .models import DiscountCode
            try:
                discount = DiscountCode.objects.get(code__iexact=discount_code_str)
                is_valid, _ = discount.is_valid_for_customer(discount_email)

                if is_valid and discount.is_valid_for_service(service_type):
                    if total_price_cents >= discount.minimum_order_cents:
                        discount_amount_cents = discount.calculate_discount(total_price_cents)
                        discount_info = {
                            'code': discount.code,
                            'discount_type': discount.discount_type,
                            'discount_description': discount.discount_value_display,
                            'discount_amount_dollars': discount_amount_cents / 100,
                        }
            except DiscountCode.DoesNotExist:
                pass

        final_total_cents = max(0, total_price_cents - discount_amount_cents)

        return Response({
            'service_type': service_type,
            'pricing': {
                'base_price_dollars': base_price_cents / 100,
                'same_day_delivery_dollars': same_day_fee_cents / 100,
                'surcharge_dollars': surcharge_cents / 100,
                'coi_fee_dollars': coi_fee_cents / 100,
                'organizing_total_dollars': organizing_total_cents / 100,
                'organizing_tax_dollars': organizing_tax_cents / 100,
                'geographic_surcharge_dollars': geographic_surcharge_cents / 100,
                'time_window_surcharge_dollars': time_window_surcharge_cents / 100,
                'total_price_dollars': final_total_cents / 100,
                'pre_discount_total_dollars': total_price_cents / 100 if discount_amount_cents > 0 else None,
                'discount_amount_dollars': discount_amount_cents / 100 if discount_amount_cents > 0 else 0,
            },
            'details': details,
            'discount': discount_info,
            'pickup_date': pickup_date
        })


class CalendarAvailabilityView(APIView):
    """Calendar availability data.
    - Public requests: dates, counts, surcharges only (no PII).
    - Staff requests: full booking details for the staff dashboard calendar.
    """
    permission_classes = [permissions.AllowAny]

    def get(self, request):
        start_date = request.query_params.get('start_date', date.today())
        if isinstance(start_date, str):
            try:
                start_date = date.fromisoformat(start_date)
            except ValueError:
                return Response(
                    {'error': 'Invalid start_date format. Use YYYY-MM-DD.'},
                    status=status.HTTP_400_BAD_REQUEST,
                )

        end_date_param = request.query_params.get('end_date')
        if end_date_param:
            try:
                end_date = date.fromisoformat(end_date_param)
            except ValueError:
                return Response(
                    {'error': 'Invalid end_date format. Use YYYY-MM-DD.'},
                    status=status.HTTP_400_BAD_REQUEST,
                )
        else:
            end_date = start_date + timedelta(days=60)

        is_staff = (
            request.user.is_authenticated
            and hasattr(request.user, 'staff_profile')
        )

        # Bulk-fetch all bookings in date range (single query instead of N)
        bookings_qs = Booking.objects.filter(
            pickup_date__gte=start_date,
            pickup_date__lte=end_date,
            deleted_at__isnull=True,
        )
        if is_staff:
            bookings_qs = bookings_qs.select_related(
                'customer', 'guest_checkout', 'mini_move_package',
            )

        # Group bookings by date in Python
        bookings_by_date = defaultdict(list)
        for b in bookings_qs:
            bookings_by_date[b.pickup_date].append(b)

        # Fetch surcharge rules once (instead of per-day)
        surcharge_rules = list(SurchargeRule.objects.filter(is_active=True))

        availability = []
        current_date = start_date

        while current_date <= end_date:
            surcharges = [
                {
                    'name': rule.name,
                    'type': rule.surcharge_type,
                    'description': rule.description,
                }
                for rule in surcharge_rules
                if rule.applies_to_date(current_date)
            ]

            day_data = {
                'date': current_date.isoformat(),
                'available': True,
                'is_weekend': current_date.weekday() >= 5,
                'surcharges': surcharges,
            }

            day_bookings = bookings_by_date.get(current_date, [])

            if is_staff:
                day_data['bookings'] = [
                    {
                        'id': str(b.id),
                        'booking_number': b.booking_number,
                        'customer_name': b.get_customer_name(),
                        'service_type': b.get_service_type_display(),
                        'pickup_time': b.get_pickup_time_display(),
                        'status': b.status,
                        'total_price_dollars': b.total_price_dollars,
                        'coi_required': b.coi_required,
                    }
                    for b in day_bookings
                ]
            else:
                day_data['booking_count'] = len(day_bookings)

            availability.append(day_data)
            current_date += timedelta(days=1)

        return Response({
            'availability': availability,
            'start_date': start_date.isoformat(),
            'end_date': end_date.isoformat(),
        })


@method_decorator(ratelimit(key='ip', rate='10/h', method='POST', block=True), name='post')
class CreateGuestPaymentIntentView(APIView):
    """
    Create payment intent BEFORE guest booking
    This separates payment from booking creation to avoid pending bookings
    """
    permission_classes = [permissions.AllowAny]

    def post(self, request):
        logger.info("Guest payment intent request received")
        
        serializer = GuestPaymentIntentSerializer(data=request.data)
        
        if not serializer.is_valid():
            logger.warning(f"Guest payment intent validation failed: {serializer.errors}")
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        # Get calculated total from serializer
        validated_data = serializer.validated_data
        amount_cents = validated_data['calculated_total_cents']
        customer_email = validated_data.get('email')
        
        # Handle free orders (100% discount)
        if amount_cents == 0:
            logger.info(f"Free order via discount for guest {customer_email}")
            return Response({
                'client_secret': None,
                'payment_intent_id': 'free_order',
                'amount_dollars': 0
            }, status=status.HTTP_200_OK)

        try:
            # Create Stripe payment intent
            metadata = {
                'service_type': validated_data['service_type'],
                'customer_email': customer_email,
            }
            if validated_data.get('_discount_code_id'):
                metadata['discount_code_id'] = validated_data['_discount_code_id']
                metadata['discount_amount_cents'] = str(validated_data.get('_discount_amount_cents', 0))

            payment_intent = stripe.PaymentIntent.create(
                amount=amount_cents,
                currency='usd',
                payment_method_types=['card'],
                metadata=metadata
            )

            logger.info(f"Payment intent created: {payment_intent.id} for ${amount_cents / 100}")

            return Response({
                'client_secret': payment_intent.client_secret,
                'payment_intent_id': payment_intent.id,
                'amount_dollars': amount_cents / 100
            }, status=status.HTTP_200_OK)

        except stripe.error.StripeError as e:
            logger.error(f"Stripe error creating payment intent: {str(e)}")
            return Response(
                {'error': 'Payment initialization failed'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )


class GuestBookingCreateView(generics.CreateAPIView):
    """
    Create booking for guest AFTER payment succeeds
    Requires payment_intent_id and verifies payment before creating booking
    """
    serializer_class = GuestBookingCreateSerializer
    permission_classes = [permissions.AllowAny]
    
    def create(self, request, *args, **kwargs):
        logger.info(f"Guest booking create request - Service: {request.data.get('service_type')}, Email: {request.data.get('email')}")

        # Verify payment_intent_id is provided
        payment_intent_id = request.data.get('payment_intent_id')
        if not payment_intent_id:
            return Response(
                {'error': 'payment_intent_id is required'},
                status=status.HTTP_400_BAD_REQUEST
            )

        is_free_order = (payment_intent_id == 'free_order')

        if not is_free_order:
            # ========== C2: PaymentIntent reuse prevention ==========
            if Payment.objects.filter(
                stripe_payment_intent_id=payment_intent_id,
                booking__isnull=False,
            ).exists():
                logger.warning(f"PI reuse attempt: {payment_intent_id}")
                return Response(
                    {'error': 'This payment has already been used for a booking'},
                    status=status.HTTP_400_BAD_REQUEST,
                )

            # Verify payment with Stripe
            try:
                payment_intent = stripe.PaymentIntent.retrieve(payment_intent_id)

                if payment_intent.status != 'succeeded':
                    logger.warning(f"Payment not succeeded: {payment_intent.status}")
                    return Response(
                        {'error': 'Payment has not succeeded'},
                        status=status.HTTP_400_BAD_REQUEST
                    )

                logger.info(f"Payment verified: {payment_intent_id} - ${payment_intent.amount / 100}")

            except stripe.error.StripeError as e:
                logger.error(f"Stripe verification failed: {str(e)}")
                return Response(
                    {'error': 'Payment verification failed'},
                    status=status.HTTP_400_BAD_REQUEST
                )

        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        # ========== SAME-DAY RESTRICTION CHECK ==========
        pickup_date = serializer.validated_data.get('pickup_date')
        if pickup_date:
            is_blocked, error_message = check_same_day_restriction(pickup_date)
            if is_blocked:
                return Response({
                    'error': 'same_day_restriction',
                    'message': error_message,
                    'contact_phone': '(631) 595-5100'
                }, status=status.HTTP_400_BAD_REQUEST)
        # ========== END RESTRICTION CHECK ==========

        booking = serializer.save()

        if is_free_order:
            # Verify the booking total is actually $0
            if booking.total_price_cents != 0:
                logger.error(
                    f"Free order claimed but total is {booking.total_price_cents} "
                    f"for {booking.booking_number}"
                )
                booking.status = 'cancelled'
                booking.save()
                return Response(
                    {'error': 'Free order verification failed'},
                    status=status.HTTP_400_BAD_REQUEST,
                )
            # Create $0 payment record for audit trail
            Payment.objects.create(
                booking=booking,
                amount_cents=0,
                stripe_payment_intent_id='free_order',
                stripe_charge_id='',
                status='succeeded',
                processed_at=timezone.now(),
            )
        else:
            # ========== C1: Payment amount verification ==========
            if payment_intent.amount != booking.total_price_cents:
                logger.error(
                    f"Payment amount mismatch: PI={payment_intent.amount}, "
                    f"booking={booking.total_price_cents} for {booking.booking_number}"
                )
                booking.status = 'cancelled'
                booking.save()
                return Response(
                    {'error': 'Payment amount does not match booking total'},
                    status=status.HTTP_400_BAD_REQUEST,
                )

            # ========== C2b: Create Payment record for guest booking ==========
            charge_id = getattr(payment_intent, 'latest_charge', None)
            if not isinstance(charge_id, str):
                charge_id = ''
            Payment.objects.create(
                booking=booking,
                amount_cents=payment_intent.amount,
                stripe_payment_intent_id=payment_intent_id,
                stripe_charge_id=charge_id,
                status='succeeded',
                processed_at=timezone.now(),
            )

        # Update booking status to paid since payment already succeeded
        booking.status = 'paid'
        booking.save()

        logger.info(f"Guest booking created: {booking.booking_number} - {booking.service_type} - ${booking.total_price_dollars}")

        response_data = {
            'message': 'Booking created successfully',
            'booking': {
                'id': str(booking.id),
                'booking_number': booking.booking_number,
                'total_price_dollars': booking.total_price_dollars,
                'service_type': booking.service_type,
                'status': booking.status,
            }
        }

        # Add BLADE-specific response data
        if booking.service_type == 'blade_transfer':
            response_data['booking']['blade_details'] = {
                'airport': booking.blade_airport,
                'bag_count': booking.blade_bag_count,
                'flight_date': booking.blade_flight_date.isoformat() if booking.blade_flight_date else None,
                'ready_time': booking.blade_ready_time.isoformat() if booking.blade_ready_time else None,
            }

        return Response(response_data, status=status.HTTP_201_CREATED)


class BookingStatusView(APIView):
    """Get booking status by UUID — non-guessable, no PII leak."""
    permission_classes = [permissions.AllowAny]

    def get(self, request, booking_lookup):
        try:
            # Accept UUID only (non-guessable). Sequential TT-XXXXXX is rejected.
            import uuid as _uuid
            try:
                booking_uuid = _uuid.UUID(str(booking_lookup))
            except ValueError:
                return Response(
                    {'error': 'Booking not found'},
                    status=status.HTTP_404_NOT_FOUND,
                )

            booking = Booking.objects.get(id=booking_uuid, deleted_at__isnull=True)
            return Response({
                'booking_number': booking.booking_number,
                'service_type': booking.service_type,
                'status': booking.status,
                'pickup_date': booking.pickup_date.isoformat(),
            })
        except Booking.DoesNotExist:
            return Response(
                {'error': 'Booking not found'},
                status=status.HTTP_404_NOT_FOUND,
            )


class OrganizingServiceDetailView(APIView):
    """Get detailed info about a specific organizing service - no authentication required"""
    permission_classes = [permissions.AllowAny]
    
    def get(self, request, service_id):
        try:
            organizing_service = OrganizingService.objects.get(id=service_id, is_active=True)
            serializer = OrganizingServiceSerializer(organizing_service)
            return Response(serializer.data)
        except OrganizingService.DoesNotExist:
            return Response(
                {'error': 'Organizing service not found'}, 
                status=status.HTTP_404_NOT_FOUND
            )


@method_decorator(ratelimit(key='ip', rate='20/h', method='POST', block=True), name='post')
class ValidateDiscountCodeView(APIView):
    """Validate a discount code and return discount details."""
    permission_classes = [permissions.AllowAny]

    def post(self, request):
        from .models import DiscountCode

        code = (request.data.get('code') or '').strip().upper()
        email = (request.data.get('email') or '').strip().lower()
        service_type = request.data.get('service_type', '')
        subtotal_cents = request.data.get('subtotal_cents', 0)

        if not code:
            return Response(
                {'error': 'Discount code is required'},
                status=status.HTTP_400_BAD_REQUEST
            )

        if not email:
            return Response(
                {'error': 'Email is required for discount validation'},
                status=status.HTTP_400_BAD_REQUEST
            )

        try:
            discount = DiscountCode.objects.get(code__iexact=code)
        except DiscountCode.DoesNotExist:
            return Response(
                {'error': 'Invalid discount code'},
                status=status.HTTP_404_NOT_FOUND
            )

        is_valid, error = discount.is_valid_for_customer(email)
        if not is_valid:
            return Response({'error': error}, status=status.HTTP_400_BAD_REQUEST)

        if service_type and not discount.is_valid_for_service(service_type):
            return Response(
                {'error': f'This discount code does not apply to {service_type} bookings'},
                status=status.HTTP_400_BAD_REQUEST
            )

        if subtotal_cents and discount.minimum_order_cents > 0:
            if int(subtotal_cents) < discount.minimum_order_cents:
                return Response(
                    {'error': f'Minimum order of ${discount.minimum_order_cents / 100:.2f} required for this code'},
                    status=status.HTTP_400_BAD_REQUEST
                )

        discount_amount_cents = discount.calculate_discount(int(subtotal_cents)) if subtotal_cents else 0

        return Response({
            'valid': True,
            'code': discount.code,
            'discount_type': discount.discount_type,
            'discount_value': discount.discount_value,
            'discount_description': discount.discount_value_display,
            'discount_amount_cents': discount_amount_cents,
            'discount_amount_dollars': discount_amount_cents / 100,
            'minimum_order_cents': discount.minimum_order_cents,
            'allowed_service_types': discount.allowed_service_types,
        })


class ValidateZipCodeView(APIView):
    """
    Public endpoint to validate a single ZIP code.
    Returns service area information without requiring authentication.
    """
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        from .zip_codes import validate_service_area
        
        zip_code = request.data.get('zip_code')
        
        if not zip_code:
            return Response(
                {'error': 'ZIP code is required'}, 
                status=status.HTTP_400_BAD_REQUEST
            )
        
        is_serviceable, requires_surcharge, zone, error = validate_service_area(zip_code)
        
        return Response({
            'is_serviceable': is_serviceable,
            'requires_surcharge': requires_surcharge,
            'zone': zone,
            'error': error,
            'zip_code': zip_code.split('-')[0].strip()
        })
```

# ──── backend/apps/bookings/zip_codes.py ────

```python
# apps/bookings/zip_codes.py
"""
ToteTaxi Geographic ZIP Code System
Validates service areas and determines surcharge requirements
"""

# Zone 1: CORE AREA (Standard Pricing - No Surcharge)
CORE_AREA_ZIPS = {
    'manhattan': [
        '10001', '10002', '10003', '10004', '10005', '10006', '10007', '10009', '10010', '10011',
        '10012', '10013', '10014', '10016', '10017', '10018', '10019', '10020', '10021', '10022',
        '10023', '10024', '10025', '10026', '10027', '10028', '10029', '10030', '10031', '10032',
        '10033', '10034', '10035', '10036', '10038', '10039', '10040', '10044', '10065', '10069',
        '10075', '10103', '10110', '10111', '10112', '10115', '10119', '10128', '10152', '10153',
        '10154', '10162', '10165', '10167', '10168', '10169', '10170', '10171', '10172', '10173',
        '10174', '10177', '10199', '10271', '10278', '10279', '10280', '10281', '10282'
    ],
    
    'hamptons_west': [
        '11972',  # Speonk
        '11946',  # Hampton Bays
        '11959',  # Quogue
        '11977',  # Westhampton
        '11978',  # Westhampton Beach
        '11968',  # Southampton
        '11976',  # Water Mill
        '11932',  # Bridgehampton
        '11962',  # Sagaponack
        '11963',  # Sag Harbor
        '11975',  # Wainscott
        '11937',  # East Hampton
    ],
    
    'brooklyn': [
        '11201', '11203', '11204', '11205', '11206', '11207', '11208', '11209', '11210', '11211',
        '11212', '11213', '11214', '11215', '11216', '11217', '11218', '11219', '11220', '11221',
        '11222', '11223', '11224', '11225', '11226', '11228', '11229', '11230', '11231', '11232',
        '11233', '11234', '11235', '11236', '11237', '11238', '11239', '11241', '11242', '11243',
        '11245', '11247', '11249', '11251', '11252', '11256'
    ]
}

# Zone 2: SURCHARGE AREA (+$175 Distance Fee)
SURCHARGE_AREA_ZIPS = {
    'essex_county_nj': [
        '07003', '07004', '07006', '07007', '07009', '07017', '07018', '07019', '07021', '07028',
        '07039', '07040', '07041', '07042', '07043', '07044', '07050', '07051', '07052', '07068',
        '07078', '07079', '07101', '07102', '07103', '07104', '07105', '07106', '07107', '07108',
        '07109', '07110', '07111', '07112', '07114', '07175', '07184', '07188', '07189', '07191',
        '07192', '07193', '07195', '07198', '07199'
    ],
    
    'union_county_nj': [
        '07016', '07023', '07027', '07033', '07036', '07060', '07062', '07063', '07065', '07066',
        '07076', '07081', '07083', '07088', '07090', '07092', '07201', '07202', '07203', '07204',
        '07205', '07206', '07208', '07901', '07974'
    ],
    
    'morris_county_nj': [
        '07005', '07035', '07054', '07801', '07834', '07856', '07866', '07869', '07928', '07932',
        '07936', '07940', '07950', '07960', '07981'
    ],
    
    'hudson_county_nj': [
        '07002', '07030', '07032', '07047', '07086', '07087', '07093', '07094', '07302', '07304',
        '07305', '07306', '07307', '07310'
    ],
    
    'fairfield_county_ct': [
        '06604', '06605', '06606', '06607', '06608', '06610', '06611', '06612', '06614', '06615',
        '06807', '06820', '06824', '06825', '06830', '06831', '06840', '06850', '06851', '06853',
        '06854', '06855', '06877', '06880', '06883', '06897', '06901', '06902', '06903', '06905',
        '06906', '06907'
    ],
    
    'new_haven_county_ct': [
        '06401', '06418', '06460', '06477', '06484', '06510', '06511', '06512', '06513', '06515',
        '06516', '06519'
    ],
    
    'hamptons_east': [
        '11930',  # Amagansett
        '11954',  # Montauk
        '11964',  # Shelter Island
    ]
}

# Flatten for fast lookup (O(1) set operations)
CORE_AREA_ZIPS_FLAT = set()
for region_zips in CORE_AREA_ZIPS.values():
    CORE_AREA_ZIPS_FLAT.update(region_zips)

SURCHARGE_AREA_ZIPS_FLAT = set()
for region_zips in SURCHARGE_AREA_ZIPS.values():
    SURCHARGE_AREA_ZIPS_FLAT.update(region_zips)


def validate_service_area(zip_code):
    """
    Validate ZIP code and determine surcharge requirement.
    
    Args:
        zip_code (str): ZIP code to validate (can include -XXXX extension)
    
    Returns:
        tuple: (is_serviceable, requires_surcharge, zone_name, error_message)
        
    Examples:
        >>> validate_service_area('10001')
        (True, False, 'core', None)
        
        >>> validate_service_area('07101')
        (True, True, 'surcharge', None)
        
        >>> validate_service_area('11354')
        (False, False, None, 'Sorry, we don\'t service ZIP code 11354...')
    """
    if not zip_code:
        return False, False, None, "ZIP code is required"
    
    # Clean ZIP (remove -XXXX extension if present)
    clean_zip = zip_code.split('-')[0].strip()
    
    # Check core area (no surcharge)
    if clean_zip in CORE_AREA_ZIPS_FLAT:
        return True, False, "core", None
    
    # Check surcharge area (+$175)
    if clean_zip in SURCHARGE_AREA_ZIPS_FLAT:
        return True, True, "surcharge", None
    
    # Not serviceable
    error_msg = (
        f"Sorry, we don't currently service ZIP code {clean_zip}. "
        f"We serve Manhattan, the Hamptons, Brooklyn, and select areas in NJ and CT."
    )
    return False, False, None, error_msg


def get_service_areas():
    """
    Return all service areas for frontend display or admin reference.
    
    Returns:
        dict: Dictionary with core and surcharge area ZIP codes
    """
    return {
        'core_areas': CORE_AREA_ZIPS,
        'surcharge_areas': SURCHARGE_AREA_ZIPS,
        'stats': {
            'core_count': len(CORE_AREA_ZIPS_FLAT),
            'surcharge_count': len(SURCHARGE_AREA_ZIPS_FLAT),
            'total_serviceable': len(CORE_AREA_ZIPS_FLAT) + len(SURCHARGE_AREA_ZIPS_FLAT)
        }
    }
```

# ──── backend/apps/bookings/management/commands/wipe_all_bookings.py ────

```python
from django.core.management.base import BaseCommand
from django.db import transaction
from django.contrib.auth.models import User
from apps.bookings.models import Booking, Address, GuestCheckout
from apps.payments.models import Payment, Refund, PaymentAudit
from apps.logistics.models import OnfleetTask
from apps.customers.models import CustomerProfile

class Command(BaseCommand):
    help = 'PRODUCTION: Wipe ALL bookings (customer + guest) and related data'
    
    def add_arguments(self, parser):
        parser.add_argument(
            '--dry-run',
            action='store_true',
            help='Show what would be deleted without actually deleting'
        )
        parser.add_argument(
            '--yes-i-am-sure',
            action='store_true',
            help='Required confirmation flag for production deletion'
        )
        parser.add_argument(
            '--keep-addresses',
            action='store_true',
            help='Keep Address records (only delete bookings/payments)'
        )
    
    def handle(self, *args, **options):
        dry_run = options['dry_run']
        confirmed = options['yes_i_am_sure']
        keep_addresses = options['keep_addresses']
        
        # Safety check
        if not confirmed and not dry_run:
            self.stdout.write(
                self.style.ERROR(
                    '\n❌ SAFETY CHECK FAILED\n'
                    'You must pass --yes-i-am-sure to delete production data\n'
                    'Example: python manage.py wipe_all_bookings --yes-i-am-sure\n'
                )
            )
            return
        
        # Display current counts
        self.stdout.write(self.style.WARNING('\n' + '='*60))
        self.stdout.write(self.style.WARNING('  PRODUCTION DATABASE WIPE - CURRENT STATE'))
        self.stdout.write(self.style.WARNING('='*60))
        
        counts = self._get_current_counts()
        self._display_counts(counts)
        
        # Display what will happen
        self.stdout.write('\n' + '='*60)
        self.stdout.write(self.style.WARNING('  DELETION PLAN'))
        self.stdout.write('='*60)
        self.stdout.write('\n📋 Order of deletion (respects PROTECT relationships):')
        self.stdout.write('   1. ❌ Payment Audits')
        self.stdout.write('   2. ❌ Refunds (PROTECT on Payment)')
        self.stdout.write('   3. ❌ Payments (PROTECT on Booking)')
        self.stdout.write('   4. ❌ Bookings (CASCADE to OnfleetTask, GuestCheckout)')
        if not keep_addresses:
            self.stdout.write('   5. ❌ Addresses')
        else:
            self.stdout.write('   5. ✅ Addresses (keeping per --keep-addresses)')
        self.stdout.write('\n✅ User accounts will be PRESERVED')
        self.stdout.write('✅ CustomerProfiles will be PRESERVED (stats will reset)')
        self.stdout.write('✅ Service catalog will be PRESERVED\n')
        
        if dry_run:
            self.stdout.write(
                self.style.WARNING('\n🔍 DRY RUN MODE - No data will be deleted\n')
            )
            return
        
        # Confirm one more time
        self.stdout.write(
            self.style.ERROR(
                f'\n⚠️  FINAL WARNING: About to delete {counts["bookings"]} bookings '
                f'and {counts["payments"]} payments from PRODUCTION!\n'
            )
        )
        
        # Perform deletion
        self.stdout.write(self.style.WARNING('\n🗑️  Starting deletion process...\n'))
        
        deleted_counts = {}
        
        try:
            with transaction.atomic():
                # Step 1: Delete PaymentAudits (no PROTECT, just CASCADE)
                deleted_counts['payment_audits'], _ = PaymentAudit.objects.all().delete()
                self.stdout.write(
                    self.style.SUCCESS(f'   ✅ Deleted {deleted_counts["payment_audits"]} payment audit records')
                )
                
                # Step 2: Delete Refunds (PROTECT on Payment, must go first)
                deleted_counts['refunds'], _ = Refund.objects.all().delete()
                self.stdout.write(
                    self.style.SUCCESS(f'   ✅ Deleted {deleted_counts["refunds"]} refunds')
                )
                
                # Step 3: Delete Payments (PROTECT on Booking, must go second)
                deleted_counts['payments'], _ = Payment.objects.all().delete()
                self.stdout.write(
                    self.style.SUCCESS(f'   ✅ Deleted {deleted_counts["payments"]} payments')
                )
                
                # Step 4: Delete Bookings (CASCADE deletes OnfleetTask + GuestCheckout)
                deleted_counts['bookings'], _ = Booking.objects.all().delete()
                self.stdout.write(
                    self.style.SUCCESS(
                        f'   ✅ Deleted {deleted_counts["bookings"]} bookings '
                        f'(auto-deleted OnfleetTasks + GuestCheckouts via CASCADE)'
                    )
                )
                
                # Step 5: Optionally delete Addresses
                if not keep_addresses:
                    deleted_counts['addresses'], _ = Address.objects.all().delete()
                    self.stdout.write(
                        self.style.SUCCESS(f'   ✅ Deleted {deleted_counts["addresses"]} addresses')
                    )
                else:
                    deleted_counts['addresses'] = 0
                    self.stdout.write(
                        self.style.WARNING(f'   ⏭️  Kept {counts["addresses"]} addresses (--keep-addresses flag)')
                    )
            
            # Success!
            self.stdout.write('\n' + '='*60)
            self.stdout.write(self.style.SUCCESS('  ✅ DELETION COMPLETED SUCCESSFULLY'))
            self.stdout.write('='*60)
            self._display_deleted_summary(deleted_counts, counts)
            
            # Reset customer stats
            self.stdout.write('\n📊 Resetting customer booking statistics...')
            reset_count = self._reset_customer_stats()
            self.stdout.write(
                self.style.SUCCESS(f'   ✅ Reset stats for {reset_count} customers\n')
            )
            
            # Final verification
            self.stdout.write('🔍 Verifying deletion...')
            final_counts = self._get_current_counts()
            if final_counts['bookings'] == 0 and final_counts['payments'] == 0:
                self.stdout.write(self.style.SUCCESS('   ✅ All bookings and payments removed'))
            else:
                self.stdout.write(
                    self.style.ERROR(
                        f'   ⚠️  Warning: {final_counts["bookings"]} bookings, '
                        f'{final_counts["payments"]} payments still remain'
                    )
                )
            
            self.stdout.write('\n' + '='*60)
            self.stdout.write(self.style.SUCCESS('  🎉 DATABASE WIPE COMPLETE'))
            self.stdout.write('='*60 + '\n')
            
        except Exception as e:
            self.stdout.write(
                self.style.ERROR(f'\n❌ ERROR during deletion: {str(e)}\n')
            )
            raise
    
    def _get_current_counts(self):
        """Get current record counts"""
        return {
            'payment_audits': PaymentAudit.objects.count(),
            'refunds': Refund.objects.count(),
            'payments': Payment.objects.count(),
            'bookings': Booking.objects.count(),
            'customer_bookings': Booking.objects.filter(customer__isnull=False).count(),
            'guest_bookings': Booking.objects.filter(guest_checkout__isnull=False).count(),
            'onfleet_tasks': OnfleetTask.objects.count(),
            'guest_checkouts': GuestCheckout.objects.count(),
            'addresses': Address.objects.count(),
            'users': User.objects.count(),
            'customer_profiles': CustomerProfile.objects.count(),
        }
    
    def _display_counts(self, counts):
        """Display current database state"""
        self.stdout.write('\n📊 Current Database State:')
        self.stdout.write(f'   🗑️  TO DELETE:')
        self.stdout.write(f'      • Bookings: {counts["bookings"]} total')
        self.stdout.write(f'        ├─ Customer bookings: {counts["customer_bookings"]}')
        self.stdout.write(f'        └─ Guest bookings: {counts["guest_bookings"]}')
        self.stdout.write(f'      • Payments: {counts["payments"]}')
        self.stdout.write(f'      • Refunds: {counts["refunds"]}')
        self.stdout.write(f'      • Payment Audits: {counts["payment_audits"]}')
        self.stdout.write(f'      • OnfleetTasks: {counts["onfleet_tasks"]} (CASCADE)')
        self.stdout.write(f'      • GuestCheckouts: {counts["guest_checkouts"]} (CASCADE)')
        self.stdout.write(f'      • Addresses: {counts["addresses"]}')
        
        self.stdout.write(f'\n   ✅ WILL PRESERVE:')
        self.stdout.write(f'      • User accounts: {counts["users"]}')
        self.stdout.write(f'      • Customer profiles: {counts["customer_profiles"]}')
        self.stdout.write(f'      • Service catalog (MiniMovePackages, SpecialtyItems, etc.)')
    
    def _display_deleted_summary(self, deleted, original):
        """Display deletion summary"""
        self.stdout.write('\n📋 Deletion Summary:')
        self.stdout.write(f'   ❌ Payment Audits: {deleted["payment_audits"]}/{original["payment_audits"]}')
        self.stdout.write(f'   ❌ Refunds: {deleted["refunds"]}/{original["refunds"]}')
        self.stdout.write(f'   ❌ Payments: {deleted["payments"]}/{original["payments"]}')
        self.stdout.write(f'   ❌ Bookings: {deleted["bookings"]}/{original["bookings"]}')
        self.stdout.write(f'      ├─ Customer bookings: {original["customer_bookings"]}')
        self.stdout.write(f'      └─ Guest bookings: {original["guest_bookings"]}')
        self.stdout.write(f'   ❌ OnfleetTasks: {original["onfleet_tasks"]} (auto-deleted via CASCADE)')
        self.stdout.write(f'   ❌ GuestCheckouts: {original["guest_checkouts"]} (auto-deleted via CASCADE)')
        if deleted.get('addresses', 0) > 0:
            self.stdout.write(f'   ❌ Addresses: {deleted["addresses"]}/{original["addresses"]}')
        
        self.stdout.write(f'\n   ✅ Users preserved: {original["users"]}')
        self.stdout.write(f'   ✅ Customer profiles preserved: {original["customer_profiles"]}')
    
    def _reset_customer_stats(self):
        """Reset customer booking statistics to zero"""
        reset_count = 0
        for profile in CustomerProfile.objects.all():
            profile.total_bookings = 0
            profile.total_spent_cents = 0
            profile.last_booking_at = None
            profile.save()
            reset_count += 1
        return reset_count
```

# ──── backend/apps/customers/admin.py ────

```python
from django.contrib import admin
from django.contrib.auth.models import User
from django.contrib.auth.admin import UserAdmin as BaseUserAdmin
from django.core.exceptions import ValidationError
from django.contrib import messages
from .models import CustomerProfile, SavedAddress, CustomerPaymentMethod


class CustomerProfileInline(admin.StackedInline):
    model = CustomerProfile
    can_delete = False
    verbose_name_plural = 'Customer Profile'
    readonly_fields = ('total_bookings', 'total_spent_cents', 'last_booking_at', 'created_at', 'updated_at')
    
    def save_model(self, request, obj, form, change):
        try:
            super().save_model(request, obj, form, change)
        except ValidationError as e:
            messages.error(request, f"Cannot save customer profile: {e}")
            raise


class CustomUserAdmin(BaseUserAdmin):
    inlines = (CustomerProfileInline,)
    
    def get_inline_instances(self, request, obj=None):
        """Only show CustomerProfile inline for users without staff profiles"""
        if obj and hasattr(obj, 'staff_profile'):
            return []
        return super().get_inline_instances(request, obj)


# Re-register UserAdmin
admin.site.unregister(User)
admin.site.register(User, CustomUserAdmin)


@admin.register(CustomerProfile)
class CustomerProfileAdmin(admin.ModelAdmin):
    list_display = ('user', 'user_email', 'total_bookings', 'total_spent_dollars', 'is_vip', 'last_booking_at', 'created_at')
    list_filter = ('is_vip', 'preferred_pickup_time', 'email_notifications', 'created_at')
    search_fields = ('user__email', 'user__first_name', 'user__last_name', 'phone')
    readonly_fields = ('total_bookings', 'total_spent_cents', 'last_booking_at', 'created_at', 'updated_at')
    
    def user_email(self, obj):
        return obj.user.email
    user_email.short_description = 'Email'
    user_email.admin_order_field = 'user__email'
    
    def save_model(self, request, obj, form, change):
        try:
            super().save_model(request, obj, form, change)
        except ValidationError as e:
            messages.error(request, f"Cannot save: {e}")
            raise


@admin.register(SavedAddress)
class SavedAddressAdmin(admin.ModelAdmin):
    list_display = ('user', 'nickname', 'city', 'state', 'times_used', 'is_active', 'created_at')
    list_filter = ('state', 'is_active', 'city', 'created_at')
    search_fields = ('user__email', 'nickname', 'city', 'address_line_1')
    readonly_fields = ('times_used', 'last_used_at', 'created_at', 'updated_at')
    
    def get_queryset(self, request):
        return super().get_queryset(request).select_related('user')


@admin.register(CustomerPaymentMethod)
class CustomerPaymentMethodAdmin(admin.ModelAdmin):
    list_display = ('user', 'display_name', 'is_default', 'is_active', 'created_at')
    list_filter = ('card_brand', 'is_default', 'is_active', 'created_at')
    search_fields = ('user__email', 'card_last_four')
    readonly_fields = ('stripe_payment_method_id', 'created_at')
    
    def get_queryset(self, request):
        return super().get_queryset(request).select_related('user')
    
    
```

# ──── backend/apps/customers/apps.py ────

```python
# apps/customers/apps.py
from django.apps import AppConfig

class CustomersConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'apps.customers'  # Change this from 'customers' to 'apps.customers'
```

# ──── backend/apps/customers/authentication.py ────

```python
from rest_framework.authentication import SessionAuthentication
from django.contrib.auth.models import User
from django.contrib.sessions.backends.db import SessionStore
import logging

logger = logging.getLogger(__name__)

class HybridAuthentication(SessionAuthentication):
    """
    Hybrid authentication for mobile compatibility.
    Tries session cookie first (desktop), falls back to X-Session-Id header (mobile).
    """
    
    def authenticate(self, request):
        # Try standard cookie-based session authentication
        user = getattr(request._request, 'user', None)
        
        if user and user.is_authenticated:
            # 🔧 FIX: Ensure related profiles are loaded
            try:
                user = User.objects.select_related('staff_profile', 'customer_profile').get(pk=user.pk)
            except User.DoesNotExist:
                return None
            return (user, None)
        
        # Mobile fallback: check for session ID in custom header
        session_key = request.META.get('HTTP_X_SESSION_ID')
        
        if not session_key:
            return None
        
        logger.info(f"Mobile auth attempt with session: {session_key[:4] + '***'}...")
        
        try:
            # Validate session exists and get user
            session = SessionStore(session_key=session_key)
            
            if not session.exists(session_key):
                logger.warning(f"Session does not exist: {session_key[:4] + '***'}...")
                return None
            
            user_id = session.get('_auth_user_id')
            
            if not user_id:
                logger.warning(f"No user_id in session: {session_key[:4] + '***'}...")
                return None
            
            # 🔧 FIX: Load user with related profiles
            user = User.objects.select_related('staff_profile', 'customer_profile').get(pk=user_id)
            logger.info(f"Mobile auth successful for user: {user.email}")
            return (user, None)
            
        except User.DoesNotExist:
            logger.error(f"User not found for session: {session_key[:4] + '***'}...")
            return None
        except Exception as e:
            logger.error(f"Mobile auth error: {str(e)}")
            return None
```

# ──── backend/apps/customers/booking_serializers.py ────

```python
# backend/apps/customers/booking_serializers.py
from rest_framework import serializers
from django.contrib.auth.models import User
from django.utils import timezone
from datetime import timedelta, time as dt_time
from apps.bookings.models import Booking, Address, BookingSpecialtyItem
from apps.bookings.pricing_utils import calculate_geographic_surcharge_from_zips
from apps.payments.models import Payment
from apps.payments.services import StripePaymentService
from .models import CustomerProfile, SavedAddress, CustomerPaymentMethod
import logging
from .serializers import SavedAddressSerializer
from apps.services.models import MiniMovePackage, SpecialtyItem, StandardDeliveryConfig, calculate_surcharges_for_date

logger = logging.getLogger(__name__)


class OnfleetTaskSerializer(serializers.Serializer):
    """Minimal Onfleet task info for customer delivery tracking"""
    task_type = serializers.CharField()
    tracking_url = serializers.URLField()
    status = serializers.CharField()
    worker_name = serializers.CharField(allow_blank=True)
    completed_at = serializers.DateTimeField(allow_null=True)
    started_at = serializers.DateTimeField(allow_null=True)


class PaymentIntentCreateSerializer(serializers.Serializer):
    """
    Serializer for creating payment intent BEFORE booking
    ✅ NOW SUPPORTS QUANTITIES
    """
    
    service_type = serializers.ChoiceField(choices=[
        ('mini_move', 'Mini Move'),
        ('standard_delivery', 'Standard Delivery'),
        ('specialty_item', 'Specialty Item'),
        ('blade_transfer', 'BLADE Airport Transfer'),
    ])
    
    # Service-specific fields
    mini_move_package_id = serializers.UUIDField(required=False, allow_null=True)
    include_packing = serializers.BooleanField(default=False)
    include_unpacking = serializers.BooleanField(default=False)
    standard_delivery_item_count = serializers.IntegerField(required=False, min_value=0)
    is_same_day_delivery = serializers.BooleanField(default=False)
    
    # ✅ NEW: Specialty items with quantities
    specialty_items = serializers.ListField(
        child=serializers.DictField(),
        required=False,
        allow_empty=True,
        help_text="List of {item_id: UUID, quantity: int}"
    )
    
    # BLADE fields
    blade_airport = serializers.ChoiceField(choices=[('JFK', 'JFK'), ('EWR', 'EWR')], required=False)
    blade_flight_date = serializers.DateField(required=False)
    blade_flight_time = serializers.TimeField(required=False)
    blade_bag_count = serializers.IntegerField(required=False, min_value=2)
    
    pickup_date = serializers.DateField()
    pickup_time = serializers.ChoiceField(choices=[
        ('morning', '8 AM - 11 AM'),
        ('morning_specific', 'Specific 1-hour window'),
        ('no_time_preference', 'No time preference'),
    ], required=False)
    specific_pickup_hour = serializers.IntegerField(required=False, allow_null=True)
    
    customer_email = serializers.EmailField(required=False)

    coi_required = serializers.BooleanField(default=False)
    is_outside_core_area = serializers.BooleanField(default=False)
    # ZIP codes for accurate geographic surcharge calculation ($175 per out-of-zone address)
    pickup_zip_code = serializers.CharField(required=False, max_length=10)
    delivery_zip_code = serializers.CharField(required=False, max_length=10)

    # Discount code (optional)
    discount_code = serializers.CharField(required=False, max_length=50, allow_blank=True)

    def validate_specialty_items(self, value):
        """Validate specialty items with quantities"""
        if not value:
            return []
        
        for item in value:
            if 'item_id' not in item or 'quantity' not in item:
                raise serializers.ValidationError(
                    "Each specialty item must have 'item_id' and 'quantity'"
                )
            if item['quantity'] < 1:
                raise serializers.ValidationError("Quantity must be at least 1")
        
        return value
    
    def validate(self, attrs):
        service_type = attrs['service_type']
        
        if service_type == 'blade_transfer':
            if not all([attrs.get('blade_airport'), attrs.get('blade_flight_date'), 
                       attrs.get('blade_flight_time'), attrs.get('blade_bag_count')]):
                raise serializers.ValidationError("All BLADE fields are required")
            
            if attrs.get('blade_bag_count', 0) < 2:
                raise serializers.ValidationError("BLADE service requires minimum 2 bags")
        
        elif service_type == 'mini_move':
            if not attrs.get('mini_move_package_id'):
                raise serializers.ValidationError("mini_move_package_id is required")
        
        elif service_type == 'standard_delivery':
            item_count = attrs.get('standard_delivery_item_count', 0)
            specialty_items = attrs.get('specialty_items', [])
            
            if item_count == 0 and len(specialty_items) == 0:
                raise serializers.ValidationError("At least one item required")
        
        elif service_type == 'specialty_item':
            if not attrs.get('specialty_items'):
                raise serializers.ValidationError("specialty_items is required")
        
        # Calculate pricing
        attrs['calculated_total_cents'] = self._calculate_total_price(attrs)
        
        return attrs
    
    def _calculate_total_price(self, data):
        """Calculate total price in cents WITH QUANTITIES"""
        service_type = data['service_type']
        total_cents = 0
        
        # BLADE pricing
        if service_type == 'blade_transfer':
            bag_count = data.get('blade_bag_count', 0)
            per_bag_price = 7500  # $75
            total_cents = max(bag_count * per_bag_price, 15000)  # $150 min

        # Mini Move pricing
        elif service_type == 'mini_move':
            try:
                package = MiniMovePackage.objects.get(id=data['mini_move_package_id'])
                total_cents = package.base_price_cents
                
                if data.get('coi_required') and not package.coi_included:
                    total_cents += package.coi_fee_cents
                
                # Organizing services
                if data.get('include_packing') or data.get('include_unpacking'):
                    from apps.services.models import OrganizingService
                    organizing_total = 0
                    
                    if data.get('include_packing'):
                        packing = OrganizingService.objects.filter(
                            mini_move_tier=package.package_type,
                            is_packing_service=True,
                            is_active=True
                        ).first()
                        if packing:
                            organizing_total += packing.price_cents
                    
                    if data.get('include_unpacking'):
                        unpacking = OrganizingService.objects.filter(
                            mini_move_tier=package.package_type,
                            is_packing_service=False,
                            is_active=True
                        ).first()
                        if unpacking:
                            organizing_total += unpacking.price_cents
                    
                    if organizing_total > 0:
                        total_cents += organizing_total + int(organizing_total * 0.0825)

                # Geographic surcharge: $175 per out-of-zone address (max $350)
                geographic_surcharge = calculate_geographic_surcharge_from_zips(
                    data.get('pickup_zip_code'),
                    data.get('delivery_zip_code'),
                    fallback_is_outside=data.get('is_outside_core_area', False)
                )
                total_cents += geographic_surcharge

                if data.get('pickup_time') == 'morning_specific' and package.package_type == 'standard':
                    total_cents += 17500
                
            except MiniMovePackage.DoesNotExist:
                raise serializers.ValidationError("Invalid package")
        
        # Standard Delivery pricing - ✅ WITH QUANTITIES
        elif service_type == 'standard_delivery':
            try:
                config = StandardDeliveryConfig.objects.filter(is_active=True).first()
                if config:
                    item_count = data.get('standard_delivery_item_count', 0)
                    if item_count > 0:
                        item_total = config.price_per_item_cents * item_count
                        total_cents = max(item_total, config.minimum_charge_cents)
                    
                    # ✅ Specialty items WITH QUANTITIES
                    specialty_items_data = data.get('specialty_items', [])
                    if specialty_items_data:
                        for item_data in specialty_items_data:
                            try:
                                item = SpecialtyItem.objects.get(id=item_data['item_id'])
                                quantity = item_data['quantity']
                                total_cents += item.price_cents * quantity
                            except SpecialtyItem.DoesNotExist:
                                pass
                    
                    if data.get('is_same_day_delivery'):
                        total_cents += config.same_day_flat_rate_cents

                    if data.get('coi_required'):
                        total_cents += 5000

                    # Geographic surcharge: $175 per out-of-zone address (max $350)
                    geographic_surcharge = calculate_geographic_surcharge_from_zips(
                        data.get('pickup_zip_code'),
                        data.get('delivery_zip_code'),
                        fallback_is_outside=data.get('is_outside_core_area', False)
                    )
                    total_cents += geographic_surcharge

            except StandardDeliveryConfig.DoesNotExist:
                raise serializers.ValidationError("Standard delivery not configured")
        
        # Specialty Item pricing - ✅ WITH QUANTITIES
        elif service_type == 'specialty_item':
            specialty_items_data = data.get('specialty_items', [])
            for item_data in specialty_items_data:
                try:
                    item = SpecialtyItem.objects.get(id=item_data['item_id'])
                    quantity = item_data['quantity']
                    total_cents += item.price_cents * quantity
                except SpecialtyItem.DoesNotExist:
                    pass
            
            if data.get('is_same_day_delivery'):
                try:
                    config = StandardDeliveryConfig.objects.filter(is_active=True).first()
                    if config:
                        total_cents += config.same_day_flat_rate_cents
                except StandardDeliveryConfig.DoesNotExist:
                    pass
            
            if data.get('coi_required'):
                total_cents += 5000

            # Geographic surcharge: $175 per out-of-zone address (max $350)
            geographic_surcharge = calculate_geographic_surcharge_from_zips(
                data.get('pickup_zip_code'),
                data.get('delivery_zip_code'),
                fallback_is_outside=data.get('is_outside_core_area', False)
            )
            total_cents += geographic_surcharge

        # Weekend/peak date surcharges (peak dates override weekends)
        if service_type != 'blade_transfer' and data.get('pickup_date'):
            surcharge_amount = calculate_surcharges_for_date(
                total_cents,
                data['pickup_date'],
                service_type
            )
            total_cents += surcharge_amount

        # Apply discount code if provided
        discount_code_str = (data.get('discount_code') or '').strip()
        if discount_code_str:
            from apps.bookings.models import DiscountCode as DiscountCodeModel
            try:
                discount = DiscountCodeModel.objects.get(code__iexact=discount_code_str)
                email = data.get('customer_email', '')
                # Fall back to user context email
                if not email and self.context.get('user'):
                    email = self.context['user'].email
                is_valid, _ = discount.is_valid_for_customer(email)

                if is_valid and discount.is_valid_for_service(data['service_type']):
                    if total_cents >= discount.minimum_order_cents:
                        discount_amount = discount.calculate_discount(total_cents)
                        data['_discount_amount_cents'] = discount_amount
                        data['_discount_code_id'] = str(discount.id)
                        total_cents = max(0, total_cents - discount_amount)
            except DiscountCodeModel.DoesNotExist:
                pass

        return total_cents


class AuthenticatedBookingCreateSerializer(serializers.Serializer):
    """
    Create booking AFTER payment succeeds
    ✅ NOW SUPPORTS QUANTITIES
    """
    
    payment_intent_id = serializers.CharField(required=True)
    
    service_type = serializers.ChoiceField(choices=[
        ('mini_move', 'Mini Move'),
        ('standard_delivery', 'Standard Delivery'),
        ('specialty_item', 'Specialty Item'),
        ('blade_transfer', 'BLADE Airport Transfer'),
    ])
    
    mini_move_package_id = serializers.UUIDField(required=False, allow_null=True)
    include_packing = serializers.BooleanField(default=False)
    include_unpacking = serializers.BooleanField(default=False)
    standard_delivery_item_count = serializers.IntegerField(required=False, min_value=0)
    is_same_day_delivery = serializers.BooleanField(default=False)
    
    # ✅ NEW: Specialty items with quantities
    specialty_items = serializers.ListField(
        child=serializers.DictField(),
        required=False,
        allow_empty=True
    )
    
    # BLADE fields
    blade_airport = serializers.ChoiceField(choices=[('JFK', 'JFK'), ('EWR', 'EWR')], required=False)
    blade_flight_date = serializers.DateField(required=False)
    blade_flight_time = serializers.TimeField(required=False)
    blade_bag_count = serializers.IntegerField(required=False, min_value=2)
    
    pickup_date = serializers.DateField()
    pickup_time = serializers.ChoiceField(choices=[
        ('morning', '8 AM - 11 AM'),
        ('morning_specific', 'Specific 1-hour window'),
        ('no_time_preference', 'No time preference'),
    ], required=False)
    specific_pickup_hour = serializers.IntegerField(required=False, allow_null=True)
    
    # Address selection
    pickup_address_id = serializers.UUIDField(required=False)
    delivery_address_id = serializers.UUIDField(required=False)
    new_pickup_address = serializers.DictField(required=False)
    new_delivery_address = serializers.DictField(required=False)
    
    # Save addresses
    save_pickup_address = serializers.BooleanField(default=False)
    save_delivery_address = serializers.BooleanField(default=False)
    pickup_address_nickname = serializers.CharField(required=False, max_length=50)
    delivery_address_nickname = serializers.CharField(required=False, max_length=50)
    
    special_instructions = serializers.CharField(required=False, allow_blank=True)
    coi_required = serializers.BooleanField(default=False)

    # Discount code (optional)
    discount_code = serializers.CharField(required=False, max_length=50, allow_blank=True)

    def validate_specialty_items(self, value):
        if not value:
            return []

        for item in value:
            if 'item_id' not in item or 'quantity' not in item:
                raise serializers.ValidationError(
                    "Each item needs 'item_id' and 'quantity'"
                )
            if item['quantity'] < 1:
                raise serializers.ValidationError("Quantity must be >= 1")

        return value

    def validate(self, attrs):
        user = self.context['user']
        service_type = attrs['service_type']
        
        # BLADE validation
        if service_type == 'blade_transfer':
            if not all([attrs.get('blade_airport'), attrs.get('blade_flight_date'), 
                       attrs.get('blade_flight_time'), attrs.get('blade_bag_count')]):
                raise serializers.ValidationError("All BLADE fields required")
            
            if attrs.get('blade_bag_count', 0) < 2:
                raise serializers.ValidationError("Minimum 2 bags")
        
        # Mini Move validation
        elif service_type == 'mini_move':
            if not attrs.get('mini_move_package_id'):
                raise serializers.ValidationError("Package ID required")
        
        # Standard Delivery validation
        elif service_type == 'standard_delivery':
            item_count = attrs.get('standard_delivery_item_count', 0)
            specialty_items = attrs.get('specialty_items', [])
            
            if item_count == 0 and len(specialty_items) == 0:
                raise serializers.ValidationError("At least one item required")
        
        elif service_type == 'specialty_item':
            if not attrs.get('specialty_items'):
                raise serializers.ValidationError("Specialty items required")
        
        # Address validation
        if not (attrs.get('pickup_address_id') or attrs.get('new_pickup_address')):
            raise serializers.ValidationError("pickup address required")
        
        if not (attrs.get('delivery_address_id') or attrs.get('new_delivery_address')):
            raise serializers.ValidationError("delivery address required")
        
        # Validate saved addresses belong to user
        if attrs.get('pickup_address_id'):
            if not user.saved_addresses.filter(id=attrs['pickup_address_id'], is_active=True).exists():
                raise serializers.ValidationError("Invalid pickup address")
        
        if attrs.get('delivery_address_id'):
            if not user.saved_addresses.filter(id=attrs['delivery_address_id'], is_active=True).exists():
                raise serializers.ValidationError("Invalid delivery address")
        
        # Use customer's preferred pickup time if not specified
        if not attrs.get('pickup_time'):
            attrs['pickup_time'] = user.customer_profile.preferred_pickup_time
        
        return attrs
    
    def create(self, validated_data):
        user = self.context['user']
        
        payment_intent_id = validated_data.pop('payment_intent_id')
        
        # Handle addresses
        pickup_address = self._get_or_create_address(
            user,
            validated_data.get('pickup_address_id'),
            validated_data.get('new_pickup_address'),
            validated_data.get('save_pickup_address', False),
            validated_data.get('pickup_address_nickname')
        )
        
        delivery_address = self._get_or_create_address(
            user,
            validated_data.get('delivery_address_id'),
            validated_data.get('new_delivery_address'),
            validated_data.get('save_delivery_address', False),
            validated_data.get('delivery_address_nickname')
        )
        
        # Extract specialty items BEFORE creating booking
        specialty_items_data = validated_data.pop('specialty_items', [])
        
        # Create booking
        booking = Booking.objects.create(
            customer=user,
            service_type=validated_data['service_type'],
            pickup_date=validated_data['pickup_date'],
            pickup_time=validated_data.get('pickup_time', 'morning'),
            specific_pickup_hour=validated_data.get('specific_pickup_hour'),
            pickup_address=pickup_address,
            delivery_address=delivery_address,
            special_instructions=validated_data.get('special_instructions', ''),
            coi_required=validated_data.get('coi_required', False),
            include_packing=validated_data.get('include_packing', False),
            include_unpacking=validated_data.get('include_unpacking', False),
            standard_delivery_item_count=validated_data.get('standard_delivery_item_count'),
            is_same_day_delivery=validated_data.get('is_same_day_delivery', False),
            blade_airport=validated_data.get('blade_airport'),
            blade_flight_date=validated_data.get('blade_flight_date'),
            blade_flight_time=validated_data.get('blade_flight_time'),
            blade_bag_count=validated_data.get('blade_bag_count'),
            status='pending',
        )
        
        # Handle mini move package
        if validated_data['service_type'] == 'mini_move':
            try:
                package = MiniMovePackage.objects.get(id=validated_data['mini_move_package_id'])
                booking.mini_move_package = package
            except MiniMovePackage.DoesNotExist:
                raise serializers.ValidationError("Invalid package")
        
        # ✅ Handle specialty items WITH QUANTITIES
        if specialty_items_data:
            booking.save()  # Save first to get ID
            for item_data in specialty_items_data:
                try:
                    item = SpecialtyItem.objects.get(id=item_data['item_id'])
                    BookingSpecialtyItem.objects.create(
                        booking=booking,
                        specialty_item=item,
                        quantity=item_data['quantity']
                    )
                except SpecialtyItem.DoesNotExist:
                    pass

        # Save to recalculate pricing with package + specialty items set
        booking.save()

        # Apply discount code AFTER save so pre_discount_total_cents is correct
        discount_code_str = (validated_data.get('discount_code') or '').strip()
        if discount_code_str:
            from apps.bookings.models import DiscountCode as DiscountCodeModel
            try:
                discount = DiscountCodeModel.objects.get(code__iexact=discount_code_str)
                email = user.email
                is_valid, _ = discount.is_valid_for_customer(email)

                if is_valid and discount.is_valid_for_service(validated_data['service_type']):
                    discount_amount = discount.calculate_discount(booking.pre_discount_total_cents)
                    booking.discount_code = discount
                    booking.discount_amount_cents = discount_amount
                    discount.record_usage(email=email, booking=booking)
                    booking.save()
            except DiscountCodeModel.DoesNotExist:
                pass

        return booking
    
    def _get_or_create_address(self, user, address_id, new_address_data, save_address, nickname):
        """Get existing saved address or create new one"""
        if address_id:
            saved_address = user.saved_addresses.get(id=address_id, is_active=True)
            
            address = Address.objects.create(
                customer=user,
                address_line_1=saved_address.address_line_1,
                address_line_2=saved_address.address_line_2,
                city=saved_address.city,
                state=saved_address.state,
                zip_code=saved_address.zip_code
            )
            
            saved_address.mark_used()
            return address
        
        elif new_address_data:
            address = Address.objects.create(
                customer=user,
                **new_address_data
            )
            
            if save_address:
                import uuid
                unique_nickname = nickname or f"Address {str(uuid.uuid4())[:8]}"

                # Avoid duplicate nickname constraint violation on booking retry
                if SavedAddress.objects.filter(user=user, nickname=unique_nickname).exists():
                    unique_nickname = f"{unique_nickname} ({str(uuid.uuid4())[:4]})"

                SavedAddress.objects.create(
                    user=user,
                    nickname=unique_nickname,
                    address_line_1=new_address_data['address_line_1'],
                    address_line_2=new_address_data.get('address_line_2', ''),
                    city=new_address_data['city'],
                    state=new_address_data['state'],
                    zip_code=new_address_data['zip_code'],
                    delivery_instructions=new_address_data.get('delivery_instructions', ''),
                    times_used=1
                )
            
            return address


class CustomerBookingDetailSerializer(serializers.ModelSerializer):
    """Detailed booking information for authenticated customers"""
    
    customer_name = serializers.SerializerMethodField()
    pickup_address = serializers.SerializerMethodField()
    delivery_address = serializers.SerializerMethodField()
    total_price_dollars = serializers.ReadOnlyField()
    pricing_breakdown = serializers.SerializerMethodField()
    payment_status = serializers.SerializerMethodField()
    can_rebook = serializers.SerializerMethodField()
    onfleet_tasks = serializers.SerializerMethodField()
    
    pickup_date = serializers.DateField(format='%Y-%m-%d')
    blade_flight_date = serializers.DateField(format='%Y-%m-%d', allow_null=True)
    
    class Meta:
        model = Booking
        fields = (
            'id', 'booking_number', 'customer_name', 
            'service_type', 'pickup_date', 'pickup_time', 'status',
            'pickup_address', 'delivery_address',
            'special_instructions', 'coi_required',
            'blade_airport', 'blade_flight_date', 'blade_flight_time', 
            'blade_bag_count', 'blade_ready_time',
            'total_price_dollars', 'pricing_breakdown',
            'payment_status', 'can_rebook', 
            'onfleet_tasks',
            'created_at', 'updated_at'
        )
    
    def get_customer_name(self, obj):
        return obj.get_customer_name()
    
    def get_pickup_address(self, obj):
        return {
            'address_line_1': obj.pickup_address.address_line_1,
            'address_line_2': obj.pickup_address.address_line_2,
            'city': obj.pickup_address.city,
            'state': obj.pickup_address.state,
            'zip_code': obj.pickup_address.zip_code
        }
    
    def get_delivery_address(self, obj):
        return {
            'address_line_1': obj.delivery_address.address_line_1,
            'address_line_2': obj.delivery_address.address_line_2,
            'city': obj.delivery_address.city,
            'state': obj.delivery_address.state,
            'zip_code': obj.delivery_address.zip_code
        }
    
    def get_pricing_breakdown(self, obj):
        return obj.get_pricing_breakdown()
    
    def get_payment_status(self, obj):
        payment = obj.payments.first()
        return payment.status if payment else 'not_created'
    
    def get_can_rebook(self, obj):
        return obj.status in ['completed', 'paid']
    
    def get_onfleet_tasks(self, obj):
        """Return onfleet tasks for delivery tracking"""
        tasks = obj.onfleet_tasks.all().order_by('task_type')
        return OnfleetTaskSerializer(tasks, many=True).data


class QuickBookingSerializer(serializers.Serializer):
    """Serializer for quickly rebooking with minimal changes"""
    pickup_date = serializers.DateField()
    pickup_time = serializers.ChoiceField(
        choices=[
            ('morning', '8 AM - 11 AM'),
            ('morning_specific', 'Specific 1-hour window'),
            ('no_time_preference', 'No time preference'),
        ],
        required=False
    )
    is_same_day_delivery = serializers.BooleanField(default=False)
    special_instructions = serializers.CharField(required=False, allow_blank=True)
    coi_required = serializers.BooleanField(required=False)
```

# ──── backend/apps/customers/booking_views.py ────

```python
# backend/apps/customers/booking_views.py
from rest_framework import generics, status, permissions
from rest_framework.decorators import api_view, permission_classes
from rest_framework.response import Response
from rest_framework.views import APIView
from django.shortcuts import get_object_or_404
from django.utils import timezone
from django.conf import settings
import logging
import json
import stripe

from .models import CustomerProfile, SavedAddress, CustomerPaymentMethod
from apps.bookings.models import Booking, Address, check_same_day_restriction  # ← ADDED IMPORT
from apps.payments.models import Payment
from apps.payments.services import StripePaymentService
from .emails import send_booking_confirmation_email
from .serializers import SavedAddressSerializer
from .booking_serializers import (
    AuthenticatedBookingCreateSerializer,
    CustomerBookingDetailSerializer,
    QuickBookingSerializer,
    PaymentIntentCreateSerializer
)
from django.utils.decorators import method_decorator
from django_ratelimit.decorators import ratelimit

logger = logging.getLogger(__name__)

# Initialize Stripe
stripe.api_key = settings.STRIPE_SECRET_KEY


@method_decorator(ratelimit(key='ip', rate='10/h', method='POST', block=True), name='post')
class CreatePaymentIntentView(APIView):
    """
    Create payment intent BEFORE booking
    This separates payment from booking creation to avoid pending bookings
    """
    permission_classes = [permissions.AllowAny]

    def post(self, request):
        logger.info("Payment intent request received")
        
        serializer = PaymentIntentCreateSerializer(
            data=request.data,
            context={'user': request.user if request.user.is_authenticated else None}
        )
        
        if not serializer.is_valid():
            logger.warning(f"Payment intent validation failed: {serializer.errors}")
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
        
        # Calculate total amount from validated data
        validated_data = serializer.validated_data
        amount_cents = validated_data['calculated_total_cents']
        customer_email = validated_data.get('customer_email')
        
        # Handle free orders (100% discount)
        if amount_cents == 0:
            logger.info(f"Free order via discount for {customer_email}")
            return Response({
                'client_secret': None,
                'payment_intent_id': 'free_order',
                'amount_dollars': 0
            }, status=status.HTTP_200_OK)

        try:
            # Create Stripe payment intent
            metadata = {
                'service_type': validated_data['service_type'],
                'customer_email': customer_email,
            }
            if validated_data.get('_discount_code_id'):
                metadata['discount_code_id'] = validated_data['_discount_code_id']
                metadata['discount_amount_cents'] = str(validated_data.get('_discount_amount_cents', 0))

            payment_intent = stripe.PaymentIntent.create(
                amount=amount_cents,
                currency='usd',
                payment_method_types=['card'],
                metadata=metadata
            )

            logger.info(f"Payment intent created: {payment_intent.id} for ${amount_cents / 100}")

            return Response({
                'client_secret': payment_intent.client_secret,
                'payment_intent_id': payment_intent.id,
                'amount_dollars': amount_cents / 100
            }, status=status.HTTP_200_OK)

        except stripe.error.StripeError as e:
            logger.error(f"Stripe error creating payment intent: {str(e)}")
            return Response(
                {'error': 'Payment initialization failed'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )


class CustomerBookingCreateView(APIView):
    """
    Create booking AFTER payment succeeds
    Requires payment_intent_id and verifies payment before creating booking
    """
    permission_classes = [permissions.IsAuthenticated]
    
    def post(self, request):
        logger.info(f"Booking create request from user: {request.user.email}")

        # Ensure user has customer profile
        if not hasattr(request.user, 'customer_profile'):
            logger.warning(f"User {request.user.email} has no customer profile")
            return Response(
                {'error': 'This is not a customer account'},
                status=status.HTTP_403_FORBIDDEN
            )

        # Verify payment_intent_id is provided
        payment_intent_id = request.data.get('payment_intent_id')
        if not payment_intent_id:
            return Response(
                {'error': 'payment_intent_id is required'},
                status=status.HTTP_400_BAD_REQUEST
            )

        is_free_order = (payment_intent_id == 'free_order')

        if not is_free_order:
            # ========== C2: PaymentIntent reuse prevention ==========
            if Payment.objects.filter(
                stripe_payment_intent_id=payment_intent_id,
                booking__isnull=False,
            ).exists():
                logger.warning(f"PI reuse attempt by {request.user.email}: {payment_intent_id}")
                return Response(
                    {'error': 'This payment has already been used for a booking'},
                    status=status.HTTP_400_BAD_REQUEST,
                )

            # Verify payment with Stripe
            try:
                payment_intent = stripe.PaymentIntent.retrieve(payment_intent_id)

                if payment_intent.status != 'succeeded':
                    logger.warning(f"Payment not succeeded for {request.user.email}: {payment_intent.status}")
                    return Response(
                        {'error': 'Payment has not succeeded'},
                        status=status.HTTP_400_BAD_REQUEST
                    )

                logger.info(f"Payment verified: {payment_intent_id} - ${payment_intent.amount / 100}")

            except stripe.error.StripeError as e:
                logger.error(f"Stripe verification failed: {str(e)}")
                return Response(
                    {'error': 'Payment verification failed'},
                    status=status.HTTP_400_BAD_REQUEST
                )

        serializer = AuthenticatedBookingCreateSerializer(
            data=request.data,
            context={'user': request.user}
        )

        if not serializer.is_valid():
            logger.warning(f"Booking validation failed for {request.user.email}: {serializer.errors}")
            return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

        # ========== SAME-DAY RESTRICTION CHECK ==========
        pickup_date = serializer.validated_data.get('pickup_date')
        if pickup_date:
            is_blocked, error_message = check_same_day_restriction(pickup_date)
            if is_blocked:
                return Response({
                    'error': 'same_day_restriction',
                    'message': error_message,
                    'contact_phone': '(631) 595-5100'
                }, status=status.HTTP_400_BAD_REQUEST)
        # ========== END RESTRICTION CHECK ==========

        try:
            booking = serializer.save()
            logger.info(f"Booking created: {booking.booking_number} by {request.user.email}")

            if is_free_order:
                # Verify the booking total is actually $0
                if booking.total_price_cents != 0:
                    logger.error(
                        f"Free order claimed but total is {booking.total_price_cents} "
                        f"for {booking.booking_number}"
                    )
                    booking.status = 'cancelled'
                    booking.save()
                    return Response(
                        {'error': 'Free order verification failed'},
                        status=status.HTTP_400_BAD_REQUEST,
                    )
                # Create $0 payment record for audit trail
                Payment.objects.create(
                    booking=booking,
                    customer=request.user,
                    amount_cents=0,
                    stripe_payment_intent_id='free_order',
                    stripe_charge_id='',
                    status='succeeded',
                    processed_at=timezone.now(),
                )
            else:
                # ========== C1: Payment amount verification ==========
                if payment_intent.amount != booking.total_price_cents:
                    logger.error(
                        f"Payment amount mismatch: PI={payment_intent.amount}, "
                        f"booking={booking.total_price_cents} for {booking.booking_number}"
                    )
                    booking.status = 'cancelled'
                    booking.save()
                    return Response(
                        {'error': 'Payment amount does not match booking total'},
                        status=status.HTTP_400_BAD_REQUEST,
                    )

                # Create payment record
                charge_id = getattr(payment_intent, 'latest_charge', None)
                if not isinstance(charge_id, str):
                    charge_id = ''
                Payment.objects.create(
                    booking=booking,
                    customer=request.user,
                    amount_cents=payment_intent.amount,
                    stripe_payment_intent_id=payment_intent_id,
                    stripe_charge_id=charge_id,
                    status='succeeded',
                    processed_at=timezone.now(),
                )

            logger.info(f"Payment record created for booking {booking.booking_number}")

            # Update booking status to paid since payment already succeeded
            booking.status = 'paid'
            booking.save()

        except Exception as e:
            logger.error(f"Error creating booking for {request.user.email}: {str(e)}", exc_info=True)
            return Response(
                {'error': 'An error occurred while creating the booking'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR,
            )

        response_data = {
            'message': 'Booking created successfully',
            'booking': CustomerBookingDetailSerializer(booking).data
        }

        return Response(response_data, status=status.HTTP_201_CREATED)


class QuickRebookView(APIView):
    """Quickly rebook a previous booking with minimal changes"""
    permission_classes = [permissions.IsAuthenticated]
    
    def post(self, request, booking_id):
        try:
            original_booking = Booking.objects.get(
                id=booking_id,
                customer=request.user,
                deleted_at__isnull=True
            )
        except Booking.DoesNotExist:
            return Response(
                {'error': 'Original booking not found'}, 
                status=status.HTTP_404_NOT_FOUND
            )
        
        serializer = QuickBookingSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        # Calculate pricing for payment intent
        new_booking_data = {
            'service_type': original_booking.service_type,
            'mini_move_package_id': str(original_booking.mini_move_package.id) if original_booking.mini_move_package else None,
            'standard_delivery_item_count': original_booking.standard_delivery_item_count,
            'is_same_day_delivery': serializer.validated_data.get('is_same_day_delivery', False),
            'pickup_date': serializer.validated_data['pickup_date'],
            'coi_required': serializer.validated_data.get('coi_required', original_booking.coi_required),
        }
        
        return Response({
            'message': 'Ready to create payment',
            'booking_data': new_booking_data
        }, status=status.HTTP_200_OK)


class CustomerBookingDetailView(generics.RetrieveAPIView):
    """Get detailed booking information for authenticated customer"""
    serializer_class = CustomerBookingDetailSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        return self.request.user.bookings.filter(
            deleted_at__isnull=True
        ).select_related(
            'mini_move_package',
            'pickup_address',
            'delivery_address',
            'guest_checkout'
        ).prefetch_related(
            'specialty_items',
            'onfleet_tasks'
        )
    
    def get_object(self):
        booking_id = self.kwargs.get('booking_id')
        return get_object_or_404(self.get_queryset(), id=booking_id)


class CustomerDashboardView(APIView):
    """Enhanced customer dashboard with booking insights"""
    permission_classes = [permissions.IsAuthenticated]
    
    def get(self, request):
        if not hasattr(request.user, 'customer_profile'):
            return Response(
                {'error': 'This is not a customer account'}, 
                status=status.HTTP_403_FORBIDDEN
            )
        
        customer_profile = request.user.customer_profile
        
        all_bookings = request.user.bookings.filter(
            deleted_at__isnull=True,
            status__in=['paid', 'confirmed', 'completed']
        ).select_related(
            'mini_move_package',
            'pickup_address',
            'delivery_address',
            'guest_checkout'
        ).prefetch_related(
            'specialty_items',
            'onfleet_tasks'
        ).order_by('-created_at')
        
        recent_bookings = all_bookings[:5]
        
        pending_bookings = all_bookings.filter(status__in=['confirmed']).count()
        completed_bookings = all_bookings.filter(status='completed').count()
        
        saved_addresses = request.user.saved_addresses.filter(is_active=True)
        payment_methods = request.user.payment_methods.filter(is_active=True)
        
        popular_addresses = saved_addresses.order_by('-times_used')[:3]
        
        return Response({
            'customer_profile': {
                'name': request.user.get_full_name(),
                'email': request.user.email,
                'phone': customer_profile.phone,
                'is_vip': customer_profile.is_vip,
                'total_bookings': customer_profile.total_bookings,
                'total_spent_dollars': customer_profile.total_spent_dollars,
                'last_booking_at': customer_profile.last_booking_at
            },
            'booking_summary': {
                'pending_bookings': pending_bookings,
                'completed_bookings': completed_bookings,
                'total_bookings': all_bookings.count()
            },
            'recent_bookings': CustomerBookingDetailSerializer(recent_bookings, many=True).data,
            'saved_addresses_count': saved_addresses.count(),
            'payment_methods_count': payment_methods.count(),
            'popular_addresses': SavedAddressSerializer(popular_addresses, many=True).data
        })


class BookingPreferencesView(APIView):
    """Manage customer booking preferences"""
    permission_classes = [permissions.IsAuthenticated]
    
    def get(self, request):
        customer_profile = request.user.customer_profile
        
        return Response({
            'preferred_pickup_time': customer_profile.preferred_pickup_time,
            'email_notifications': customer_profile.email_notifications,
            'sms_notifications': customer_profile.sms_notifications,
            'default_addresses': {
                'most_used_pickup': self._get_most_used_address('pickup'),
                'most_used_delivery': self._get_most_used_address('delivery')
            }
        })
    
    def _get_most_used_address(self, address_type):
        """Return the most-used saved address.

        Note: address_type is accepted for labeling but not filtered —
        SavedAddress has no address_type field.
        """
        most_used = self.request.user.saved_addresses.filter(
            is_active=True
        ).order_by('-times_used').first()
        return SavedAddressSerializer(most_used).data if most_used else None
```

# ──── backend/apps/customers/emails.py ────

```python
import logging
from datetime import timedelta
from django.conf import settings
from django.core.mail import send_mail, EmailMessage
from django.template.loader import render_to_string
from django.utils import timezone

logger = logging.getLogger(__name__)

# Google review URL for Tote Taxi Southampton
GOOGLE_REVIEW_URL = 'https://search.google.com/local/writereview?placeid=ChIJK7UwwRDB0UIRP6hrsPW6ZMk'


def generate_ics_calendar_invite(booking):
    """Generate an .ics calendar file for the booking pickup"""
    from datetime import datetime, time

    # Need pickup_date at minimum
    if not booking.pickup_date:
        return None

    # Determine the pickup hour based on pickup_time field
    if booking.pickup_time == 'morning_specific' and booking.specific_pickup_hour:
        # Use the specific hour selected
        pickup_hour = booking.specific_pickup_hour
    else:
        # Default to start of morning window (8 AM)
        pickup_hour = 8

    # Combine date and time
    pickup_dt = timezone.make_aware(
        datetime.combine(booking.pickup_date, time(pickup_hour, 0)),
        timezone.get_current_timezone()
    )

    # Event duration: 30 minutes
    end_dt = pickup_dt + timedelta(minutes=30)

    # Format dates for ICS (UTC format)
    def format_ics_date(dt):
        import datetime as dt_module
        # Convert to UTC if timezone-aware
        if timezone.is_aware(dt):
            dt = dt.astimezone(dt_module.timezone.utc)
        return dt.strftime('%Y%m%dT%H%M%SZ')

    start_str = format_ics_date(pickup_dt)
    end_str = format_ics_date(end_dt)
    now_str = format_ics_date(timezone.now())

    # Build location string from pickup_address ForeignKey
    pickup_addr = booking.pickup_address
    location_str = ''
    if pickup_addr:
        location_str = pickup_addr.address_line_1 or ''
        if pickup_addr.city:
            location_str += f', {pickup_addr.city}'
        if pickup_addr.state:
            location_str += f', {pickup_addr.state}'
        if pickup_addr.zip_code:
            location_str += f' {pickup_addr.zip_code}'

    # Build description
    description = f'Tote Taxi Pickup\\n\\nBooking: {booking.booking_number}\\n'
    delivery_addr = booking.delivery_address
    if delivery_addr and delivery_addr.address_line_1:
        description += f'Delivery to: {delivery_addr.address_line_1}'
        if delivery_addr.city:
            description += f', {delivery_addr.city}'
        description += '\\n'
    description += '\\nQuestions? Call (631) 595-5100 or email info@totetaxi.com'

    # Generate unique ID for the event
    uid = f'{booking.booking_number}@totetaxi.com'

    ics_content = f"""BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Tote Taxi//Booking System//EN
CALSCALE:GREGORIAN
METHOD:REQUEST
BEGIN:VEVENT
UID:{uid}
DTSTAMP:{now_str}
DTSTART:{start_str}
DTEND:{end_str}
SUMMARY:Tote Taxi Pickup - {booking.booking_number}
DESCRIPTION:{description}
LOCATION:{location_str}
STATUS:CONFIRMED
SEQUENCE:0
END:VEVENT
END:VCALENDAR"""

    return ics_content


def send_welcome_email(user):
    """Send welcome email to newly registered customer"""
    try:
        subject = 'Welcome to Tote Taxi!'
        context = {
            'user_name': user.get_full_name() or user.email,
            'email': user.email,
        }
        message = render_to_string('emails/welcome.txt', context)

        send_mail(
            subject=subject,
            message=message,
            from_email=settings.DEFAULT_FROM_EMAIL,
            recipient_list=[user.email],
            fail_silently=False,
        )
        logger.info(f'Welcome email sent to {user.email}')
        return True
    except Exception as e:
        logger.error(f'Failed to send welcome email to {user.email}: {str(e)}', exc_info=True)
        return False


def send_password_reset_email(user, reset_token, reset_url):
    """Send password reset email"""
    try:
        subject = 'Reset Your Tote Taxi Password'
        context = {
            'user_name': user.get_full_name() or user.email,
            'reset_url': reset_url,
            'reset_token': reset_token,
        }
        message = render_to_string('emails/password_reset.txt', context)

        send_mail(
            subject=subject,
            message=message,
            from_email=settings.DEFAULT_FROM_EMAIL,
            recipient_list=[user.email],
            fail_silently=False,
        )
        logger.info(f'Password reset email sent to {user.email}')
        return True
    except Exception as e:
        logger.error(f'Failed to send password reset email to {user.email}: {str(e)}', exc_info=True)
        return False


def send_booking_confirmation_email(booking):
    """
    Send booking confirmation email with calendar invite:
    - To: customer
    - BCC: internal list (BOOKING_EMAIL_BCC)
    - Attachment: .ics calendar invite for pickup
    """
    try:
        subject = f'Booking Confirmation - {booking.booking_number}'
        context = {
            'booking': booking,
            'customer_name': booking.get_customer_name(),
            'customer_email': booking.get_customer_email(),
        }
        message = render_to_string('emails/booking_confirmation.txt', context)

        to_addr = [booking.get_customer_email()]
        bcc_list = getattr(settings, 'BOOKING_EMAIL_BCC', [])

        email = EmailMessage(
            subject=subject,
            body=message,
            from_email=settings.DEFAULT_FROM_EMAIL,
            to=to_addr,
            bcc=bcc_list,
        )
        email.content_subtype = 'plain'

        # Generate and attach calendar invite
        ics_content = generate_ics_calendar_invite(booking)
        if ics_content:
            email.attach(
                f'totetaxi-pickup-{booking.booking_number}.ics',
                ics_content,
                'text/calendar'
            )
            logger.info(f'Calendar invite attached to confirmation for {booking.booking_number}')

        email.send(fail_silently=False)

        logger.info(
            f'Booking confirmation sent for {booking.booking_number} '
            f"(bcc={','.join(bcc_list) if bcc_list else 'none'})"
        )
        return True
    except Exception as e:
        logger.error(
            f'Failed to send booking confirmation for {booking.booking_number}: {str(e)}',
            exc_info=True
        )
        return False


def send_booking_status_update_email(booking, old_status, new_status):
    """Send email when booking status changes"""
    try:
        subject = f'Booking Update - {booking.booking_number}'
        context = {
            'booking': booking,
            'customer_name': booking.get_customer_name(),
            'old_status': old_status,
            'new_status': new_status,
        }
        message = render_to_string('emails/booking_status_update.txt', context)

        send_mail(
            subject=subject,
            message=message,
            from_email=settings.DEFAULT_FROM_EMAIL,
            recipient_list=[booking.get_customer_email()],
            fail_silently=False,
        )
        logger.info(f'Status update email sent for {booking.booking_number}')
        return True
    except Exception as e:
        logger.error(f'Failed to send status update for {booking.booking_number}: {str(e)}', exc_info=True)
        return False


def send_email_verification(user, token, verify_url):
    """Send email verification link"""
    try:
        subject = 'Verify Your Tote Taxi Account'
        context = {
            'user_name': user.get_full_name() or user.email,
            'verify_url': verify_url,
        }
        message = render_to_string('emails/email_verification.txt', context)

        send_mail(
            subject=subject,
            message=message,
            from_email=settings.DEFAULT_FROM_EMAIL,
            recipient_list=[user.email],
            fail_silently=False,
        )
        logger.info(f'Verification email sent to {user.email}')
        return True
    except Exception as e:
        logger.error(f'Failed to send verification email to {user.email}: {str(e)}', exc_info=True)
        return False


def send_booking_reminder_email(booking):
    """Send 24-hour reminder email before pickup with calendar invite attachment"""
    try:
        # Already sent?
        if booking.reminder_sent_at:
            logger.info(f'Reminder already sent for {booking.booking_number} at {booking.reminder_sent_at}')
            return False

        # Tracking if available
        has_tracking = False
        tracking_url = ''
        if hasattr(booking, 'onfleet_tasks'):
            pickup_task = booking.onfleet_tasks.filter(task_type='pickup').first()
            if pickup_task and pickup_task.tracking_url:
                has_tracking = True
                tracking_url = pickup_task.tracking_url

        subject = f'Reminder: Your Tote Taxi Pickup is Tomorrow! - {booking.booking_number}'
        context = {
            'booking': booking,
            'customer_name': booking.get_customer_name(),
            'has_tracking': has_tracking,
            'tracking_url': tracking_url,
        }
        message = render_to_string('emails/booking_reminder.txt', context)

        # Create email with potential attachment
        email = EmailMessage(
            subject=subject,
            body=message,
            from_email=settings.DEFAULT_FROM_EMAIL,
            to=[booking.get_customer_email()],
        )

        # Generate and attach calendar invite
        ics_content = generate_ics_calendar_invite(booking)
        if ics_content:
            email.attach(
                f'totetaxi-pickup-{booking.booking_number}.ics',
                ics_content,
                'text/calendar'
            )
            logger.info(f'Calendar invite attached for {booking.booking_number}')

        email.send(fail_silently=False)

        booking.reminder_sent_at = timezone.now()
        booking.save(update_fields=['reminder_sent_at'])

        logger.info(f'✓ Reminder email sent for {booking.booking_number}')
        return True

    except Exception as e:
        logger.error(f'Failed to send reminder for {booking.booking_number}: {str(e)}', exc_info=True)
        return False


def send_review_request_email(booking):
    """Send post-delivery email requesting Google review"""
    try:
        # Don't send if already sent
        if hasattr(booking, 'review_request_sent_at') and booking.review_request_sent_at:
            logger.info(f'Review request already sent for {booking.booking_number}')
            return False

        subject = f'How was your Tote Taxi experience? - {booking.booking_number}'
        context = {
            'booking': booking,
            'customer_name': booking.get_customer_name(),
            'review_url': GOOGLE_REVIEW_URL,
        }
        message = render_to_string('emails/review_request.txt', context)

        send_mail(
            subject=subject,
            message=message,
            from_email=settings.DEFAULT_FROM_EMAIL,
            recipient_list=[booking.get_customer_email()],
            fail_silently=False,
        )

        # Mark as sent if field exists
        if hasattr(booking, 'review_request_sent_at'):
            booking.review_request_sent_at = timezone.now()
            booking.save(update_fields=['review_request_sent_at'])

        logger.info(f'✓ Review request email sent for {booking.booking_number}')
        return True

    except Exception as e:
        logger.error(f'Failed to send review request for {booking.booking_number}: {str(e)}', exc_info=True)
        return False
```

# ──── backend/apps/customers/models.py ────

```python
import uuid
from django.contrib.auth.models import User
from django.db import models
from django.db.models import F
from django.core.validators import RegexValidator
from django.core.exceptions import ValidationError
from django.utils import timezone
import secrets
from datetime import timedelta

class EmailVerificationToken(models.Model):
    """Email verification tokens for new registrations"""
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='email_verification')
    token = models.CharField(max_length=100, unique=True)
    created_at = models.DateTimeField(auto_now_add=True)
    expires_at = models.DateTimeField()
    verified = models.BooleanField(default=False)
    
    class Meta:
        # ✅ OPTIMIZED: Added indexes for token lookups
        indexes = [
            models.Index(fields=['token'], name='email_verify_token_idx'),
            models.Index(fields=['verified', 'expires_at'], name='email_verify_status_idx'),
        ]
    
    @classmethod
    def create_token(cls, user):
        """Create verification token"""
        token = secrets.token_urlsafe(32)
        expires_at = timezone.now() + timedelta(hours=48)
        return cls.objects.create(
            user=user,
            token=token,
            expires_at=expires_at
        )
    
    def is_valid(self):
        """Check if token is still valid"""
        from django.utils import timezone
        return not self.verified and timezone.now() < self.expires_at

class PasswordResetToken(models.Model):
    """Password reset tokens with expiry"""
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='password_reset_tokens')
    token = models.CharField(max_length=100, unique=True)
    created_at = models.DateTimeField(auto_now_add=True)
    expires_at = models.DateTimeField()
    used = models.BooleanField(default=False)
    
    class Meta:
        ordering = ['-created_at']
        # ✅ OPTIMIZED: Added indexes for password reset
        indexes = [
            models.Index(fields=['token'], name='password_reset_token_idx'),
            models.Index(fields=['user', 'used'], name='password_reset_user_idx'),
        ]
    
    def __str__(self):
        return f'Reset token for {self.user.email}'
    
    @classmethod
    def create_token(cls, user):
        """Create a new password reset token, invalidating any existing unused tokens."""
        cls.objects.filter(user=user, used=False).update(used=True)
        token = secrets.token_urlsafe(32)
        expires_at = timezone.now() + timedelta(hours=24)
        return cls.objects.create(
            user=user,
            token=token,
            expires_at=expires_at
        )
    
    def is_valid(self):
        """Check if token is still valid"""
        return not self.used and timezone.now() < self.expires_at

class CustomerProfile(models.Model):
    """Customer profile linked to Django's User model"""
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='customer_profile')
    
    # Customer-specific fields
    phone = models.CharField(
        max_length=20, 
        validators=[RegexValidator(regex=r'^\+?1?\d{9,15}$')],
        blank=True
    )
    stripe_customer_id = models.CharField(max_length=100, blank=True)
    
    # Booking statistics
    total_bookings = models.PositiveIntegerField(default=0)
    total_spent_cents = models.PositiveBigIntegerField(default=0)
    last_booking_at = models.DateTimeField(null=True, blank=True)
    
    # Customer preferences - UPDATED: Only morning pickup time
    preferred_pickup_time = models.CharField(
        max_length=30,
        choices=[
            ('morning', '8 AM - 11 AM'),
            ('morning_specific', 'Specific 1-hour window'),
            ('no_time_preference', 'No time preference'),
        ],
        default='morning'
    )
    
    email_notifications = models.BooleanField(default=True)
    sms_notifications = models.BooleanField(default=False)
    is_vip = models.BooleanField(default=False)
    notes = models.TextField(blank=True, help_text="Internal notes for staff")
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'customers_profile'
        # ✅ OPTIMIZED: Added indexes for customer queries
        indexes = [
            models.Index(fields=['user'], name='customer_profile_user_idx'),
            models.Index(fields=['stripe_customer_id'], name='customer_stripe_idx'),
            models.Index(fields=['is_vip'], name='customer_vip_idx'),
        ]
    
    def clean(self):
        """Prevent hybrid accounts - users cannot have both staff and customer profiles"""
        if self.user and hasattr(self.user, 'staff_profile'):
            raise ValidationError(
                f"User {self.user.email} already has a staff profile. "
                "Users cannot have both staff and customer profiles."
            )
    
    def save(self, *args, **kwargs):
        self.full_clean()
        super().save(*args, **kwargs)
    
    def __str__(self):
        return f"Profile: {self.user.get_full_name()}"
    
    @property
    def total_spent_dollars(self):
        return self.total_spent_cents / 100
    
    def add_booking_stats(self, booking_total_cents):
        """Update customer statistics after booking completion.

        Uses F() expressions for atomic updates to prevent race conditions.
        """
        CustomerProfile.objects.filter(pk=self.pk).update(
            total_bookings=F('total_bookings') + 1,
            total_spent_cents=F('total_spent_cents') + booking_total_cents,
            last_booking_at=timezone.now(),
        )
        self.refresh_from_db()

    @classmethod
    def ensure_single_profile_type(cls, user):
        """Ensure user only has one type of profile"""
        if hasattr(user, 'staff_profile') and hasattr(user, 'customer_profile'):
            raise ValidationError(
                f"User {user.email} cannot have both staff and customer profiles. "
                "Please remove one profile type."
            )


class SavedAddress(models.Model):
    """Customer's saved addresses"""
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='saved_addresses')
    
    nickname = models.CharField(max_length=50)
    address_line_1 = models.CharField(max_length=200)
    address_line_2 = models.CharField(max_length=200, blank=True)
    city = models.CharField(max_length=100)
    state = models.CharField(max_length=2, choices=[
        ('NY', 'New York'),
        ('CT', 'Connecticut'), 
        ('NJ', 'New Jersey'),
    ])
    zip_code = models.CharField(max_length=10)
    delivery_instructions = models.TextField(blank=True)
    
    times_used = models.PositiveIntegerField(default=0)
    last_used_at = models.DateTimeField(null=True, blank=True)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'customers_saved_address'
        constraints = [
            models.UniqueConstraint(
                fields=['user', 'nickname'], 
                name='unique_customer_address_nickname'
            )
        ]
        # ✅ OPTIMIZED: Added indexes for address queries
        indexes = [
            models.Index(fields=['user', 'is_active'], name='saved_addr_user_active_idx'),  # Booking flow
            models.Index(fields=['times_used'], name='saved_addr_usage_idx'),  # Popular addresses
            models.Index(fields=['user', 'last_used_at'], name='saved_addr_recent_idx'),  # Recent addresses
        ]
    
    def __str__(self):
        return f"{self.user.get_full_name()} - {self.nickname}"
    
    @property
    def formatted_address(self):
        parts = [
            self.address_line_1,
            self.address_line_2,
            f"{self.city}, {self.state} {self.zip_code}"
        ]
        return ', '.join(filter(None, parts))
    
    def mark_used(self):
        self.times_used += 1
        self.last_used_at = timezone.now()
        self.save()


class CustomerPaymentMethod(models.Model):
    """Customer's saved payment methods"""
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='payment_methods')
    
    stripe_payment_method_id = models.CharField(max_length=100, unique=True)
    card_brand = models.CharField(max_length=20)
    card_last_four = models.CharField(max_length=4)
    card_exp_month = models.PositiveSmallIntegerField()
    card_exp_year = models.PositiveSmallIntegerField()
    is_default = models.BooleanField(default=False)
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'customers_payment_method'
        # ✅ OPTIMIZED: Added indexes for payment method queries
        indexes = [
            models.Index(fields=['user', 'is_active'], name='payment_method_user_idx'),
            models.Index(fields=['stripe_payment_method_id'], name='payment_method_stripe_idx'),
        ]
    
    def __str__(self):
        return f"{self.user.get_full_name()} - {self.card_brand} ****{self.card_last_four}"
    
    @property
    def display_name(self):
        return f"{self.card_brand.title()} ending in {self.card_last_four}"
    
    def save(self, *args, **kwargs):
        if self.is_default:
            CustomerPaymentMethod.objects.filter(
                user=self.user, 
                is_default=True
            ).exclude(id=self.id).update(is_default=False)
        super().save(*args, **kwargs)
```

# ──── backend/apps/customers/serializers.py ────

```python
from rest_framework import serializers
from django.contrib.auth.models import User
from django.contrib.auth import authenticate
from django.core.exceptions import ValidationError
from .models import CustomerProfile, SavedAddress, CustomerPaymentMethod


class UserSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = ('id', 'username', 'email', 'first_name', 'last_name', 'date_joined')
        read_only_fields = ('id', 'username', 'date_joined')


class CustomerProfileSerializer(serializers.ModelSerializer):
    user = UserSerializer(read_only=True)
    total_spent_dollars = serializers.ReadOnlyField()
    
    class Meta:
        model = CustomerProfile
        fields = (
            'id', 'user', 'phone', 'total_bookings', 'total_spent_cents', 
            'total_spent_dollars', 'last_booking_at', 'preferred_pickup_time',
            'email_notifications', 'sms_notifications', 'is_vip'
        )
        read_only_fields = ('id', 'total_bookings', 'total_spent_cents', 'last_booking_at', 'is_vip')


class CustomerRegistrationSerializer(serializers.Serializer):
    email = serializers.EmailField()
    password = serializers.CharField(min_length=8, write_only=True)
    password_confirm = serializers.CharField(write_only=True)
    first_name = serializers.CharField(max_length=150)
    last_name = serializers.CharField(max_length=150)
    phone = serializers.CharField(max_length=20, required=False, allow_blank=True)
    
    def validate(self, attrs):
        if attrs['password'] != attrs['password_confirm']:
            raise serializers.ValidationError("Passwords don't match")
        
        # Check if email already exists
        if User.objects.filter(email__iexact=attrs['email']).exists():
            existing_user = User.objects.get(email__iexact=attrs['email'])
            if hasattr(existing_user, 'staff_profile'):
                raise serializers.ValidationError("This email is already registered as a staff account. Please use a different email.")
            else:
                raise serializers.ValidationError("User with this email already exists")
        
        return attrs
    
    def create(self, validated_data):
        # Remove password_confirm from validated_data
        validated_data.pop('password_confirm')
        phone = validated_data.pop('phone', '')
        
        try:
            # Create User (use email as username for customers)
            user = User.objects.create_user(
                username=validated_data['email'],
                email=validated_data['email'],
                password=validated_data['password'],
                first_name=validated_data['first_name'],
                last_name=validated_data['last_name']
            )
            
            # Create CustomerProfile with validation
            CustomerProfile.objects.create(
                user=user,
                phone=phone
            )
            
            return user
            
        except ValidationError as e:
            # Clean up user if profile creation fails
            if 'user' in locals():
                user.delete()
            raise serializers.ValidationError(str(e))


class CustomerLoginSerializer(serializers.Serializer):
    email = serializers.EmailField()
    password = serializers.CharField(write_only=True)
    
    def validate(self, attrs):
        email = attrs.get('email')
        password = attrs.get('password')
        
        if email and password:
            # Authenticate using email (stored as username for customers)
            user = authenticate(username=email, password=password)
            
            if user:
                if not user.is_active:
                    raise serializers.ValidationError("User account is disabled")
                
                # Ensure user has a customer profile (not staff)
                if not hasattr(user, 'customer_profile'):
                    if hasattr(user, 'staff_profile'):
                        raise serializers.ValidationError("This is a staff account. Please use the staff login.")
                    else:
                        raise serializers.ValidationError("This is not a customer account")
                
                # Additional hybrid account check
                try:
                    CustomerProfile.ensure_single_profile_type(user)
                except ValidationError as e:
                    raise serializers.ValidationError(str(e))
                
                attrs['user'] = user
                return attrs
            else:
                raise serializers.ValidationError("Invalid email or password")
        else:
            raise serializers.ValidationError("Must include email and password")


class SavedAddressSerializer(serializers.ModelSerializer):
    formatted_address = serializers.ReadOnlyField()
    
    class Meta:
        model = SavedAddress
        fields = (
            'id', 'nickname', 'address_line_1', 'address_line_2', 
            'city', 'state', 'zip_code', 'delivery_instructions',
            'formatted_address', 'times_used', 'last_used_at', 'is_active'
        )
        read_only_fields = ('id', 'times_used', 'last_used_at')


class CustomerPaymentMethodSerializer(serializers.ModelSerializer):
    display_name = serializers.ReadOnlyField()
    
    class Meta:
        model = CustomerPaymentMethod
        fields = (
            'id', 'stripe_payment_method_id', 'card_brand', 'card_last_four',
            'card_exp_month', 'card_exp_year', 'display_name', 'is_default', 'is_active'
        )
        read_only_fields = ('id', 'stripe_payment_method_id')
```

# ──── backend/apps/customers/urls.py ────

```python
# backend/apps/customers/urls.py
from django.urls import path
from . import views, booking_views

# API patterns with both authentication and booking functionality
urlpatterns = [
    # CSRF token endpoint
    path('csrf-token/', views.CSRFTokenView.as_view(), name='csrf-token'),
    
    # Authentication endpoints
    path('auth/register/', views.CustomerRegistrationView.as_view(), name='customer-register'),
    path('auth/login/', views.CustomerLoginView.as_view(), name='customer-login'),
    path('auth/logout/', views.CustomerLogoutView.as_view(), name='customer-logout'),
    path('auth/user/', views.CurrentUserView.as_view(), name='current-user'),
    
    # Password reset endpoints
    path('auth/password-reset/', views.PasswordResetRequestView.as_view(), name='password-reset-request'),
    path('auth/password-reset/confirm/', views.PasswordResetConfirmView.as_view(), name='password-reset-confirm'),
    
    # Profile management
    path('profile/', views.CustomerProfileView.as_view(), name='customer-profile'),
    path('addresses/', views.SavedAddressListCreateView.as_view(), name='saved-addresses'),
    path('addresses/<uuid:pk>/', views.SavedAddressDetailView.as_view(), name='saved-address-detail'),
    
    # Enhanced customer dashboard and preferences
    path('dashboard/', booking_views.CustomerDashboardView.as_view(), name='customer-dashboard'),
    path('preferences/', booking_views.BookingPreferencesView.as_view(), name='booking-preferences'),
    
    # Authenticated booking management
    path('bookings/', views.CustomerBookingListView.as_view(), name='customer-bookings'),
    
    # ✅ NEW: Payment intent creation (BEFORE booking)
    path('bookings/create-payment-intent/', booking_views.CreatePaymentIntentView.as_view(), name='create-payment-intent'),
    
    # Booking creation (NOW requires payment_intent_id)
    path('bookings/create/', booking_views.CustomerBookingCreateView.as_view(), name='customer-booking-create'),
    path('bookings/<uuid:booking_id>/', booking_views.CustomerBookingDetailView.as_view(), name='customer-booking-detail'),
    path('bookings/<uuid:booking_id>/rebook/', booking_views.QuickRebookView.as_view(), name='quick-rebook'),
    
    # Staff-only customer notes management
    path('<int:customer_id>/notes/', views.CustomerNotesUpdateView.as_view(), name='customer-notes-update'),
    path('auth/verify-email/', views.EmailVerificationView.as_view(), name='email-verification'),
    path('auth/resend-verification/', views.ResendVerificationView.as_view(), name='resend-verification'),
    path('contact/', views.ContactFormView.as_view(), name='contact-form'),

]
```

# ──── backend/apps/customers/views.py ────

```python
from rest_framework import generics, status, permissions
from django.conf import settings
from rest_framework.decorators import api_view, permission_classes
from rest_framework.response import Response
from rest_framework.views import APIView
from django.contrib.auth import login, logout
from django.contrib.auth.models import User
from django.middleware.csrf import get_token
from django.views.decorators.csrf import ensure_csrf_cookie, csrf_exempt
from django.utils.decorators import method_decorator
from django.core.exceptions import ValidationError
from django_ratelimit.decorators import ratelimit
from django.core.mail import send_mail
import logging

logger = logging.getLogger(__name__)

from .emails import send_welcome_email, send_password_reset_email, send_email_verification
from .models import CustomerProfile, SavedAddress, PasswordResetToken, EmailVerificationToken
from apps.accounts.permissions import IsStaffMember
from apps.accounts.models import StaffAction
from .serializers import (
    CustomerRegistrationSerializer, 
    CustomerLoginSerializer,
    CustomerProfileSerializer,
    UserSerializer,
    SavedAddressSerializer
)


@method_decorator(ratelimit(key='ip', rate='5/m', method='POST', block=True), name='create')
@method_decorator(ratelimit(key='header:user-agent', rate='10/m', method='POST', block=True), name='create')
@method_decorator(ensure_csrf_cookie, name='dispatch')
class CustomerRegistrationView(generics.CreateAPIView):
    """Register new customer account - requires email verification"""
    serializer_class = CustomerRegistrationSerializer
    permission_classes = [permissions.AllowAny]
    
    def create(self, request, *args, **kwargs):
        serializer = self.get_serializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        email = serializer.validated_data['email']
        try:
            existing_user = User.objects.get(email__iexact=email)
            if hasattr(existing_user, 'staff_profile'):
                return Response(
                    {'error': 'This email is already registered as a staff account. Please use a different email or contact support.'},
                    status=status.HTTP_400_BAD_REQUEST
                )
            # If user exists but not verified, resend verification
            if not existing_user.is_active and hasattr(existing_user, 'email_verification'):
                verification_token = existing_user.email_verification
                if not verification_token.verified:
                    # Resend verification email
                    frontend_url = settings.FRONTEND_URL or 'https://totetaxi.netlify.app'
                    verify_url = f'{frontend_url}/verify-email?token={verification_token.token}'
                    send_email_verification(existing_user, verification_token.token, verify_url)
                    return Response({
                        'message': 'A verification email has been sent. Please check your inbox.'
                    }, status=status.HTTP_200_OK)
        except User.DoesNotExist:
            pass
        
        try:
            # Create inactive user
            user = serializer.save()
            user.is_active = False  # Inactive until email verified
            user.save()
            
            # Create verification token
            verification_token = EmailVerificationToken.create_token(user)
            
            # Send verification email
            frontend_url = settings.FRONTEND_URL or 'https://totetaxi.netlify.app'
            verify_url = f'{frontend_url}/verify-email?token={verification_token.token}'
            send_email_verification(user, verification_token.token, verify_url)
            
        except ValidationError as e:
            return Response(
                {'error': str(e)},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        return Response({
            'message': 'Registration successful! Please check your email to verify your account.',
            'email': user.email
        }, status=status.HTTP_201_CREATED)
@method_decorator(ratelimit(key='ip', rate='10/m', method='POST', block=True), name='post')
@method_decorator(ratelimit(key='header:user-agent', rate='15/m', method='POST', block=True), name='post')
@method_decorator(ensure_csrf_cookie, name='dispatch')
class CustomerLoginView(APIView):
    """Customer login endpoint with profile type validation and rate limiting"""
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        serializer = CustomerLoginSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        user = serializer.validated_data['user']
        
        # Ensure user has customer profile (not staff)
        if not hasattr(user, 'customer_profile'):
            if hasattr(user, 'staff_profile'):
                return Response(
                    {'error': 'This is a staff account. Please use the staff login.'},
                    status=status.HTTP_403_FORBIDDEN
                )
            else:
                return Response(
                    {'error': 'Account does not have a customer profile.'},
                    status=status.HTTP_403_FORBIDDEN
                )
        
        # Additional security: Check for hybrid accounts
        try:
            CustomerProfile.ensure_single_profile_type(user)
        except ValidationError as e:
            return Response(
                {'error': str(e)},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        login(request, user)
        
        return Response({
            'message': 'Login successful',
            'user': UserSerializer(user).data,
            'customer_profile': CustomerProfileSerializer(user.customer_profile).data,
            'session_id': request.session.session_key,
            'csrf_token': get_token(request)
        })
    
@method_decorator(ratelimit(key='ip', rate='10/h', method='POST', block=True), name='post')
class EmailVerificationView(APIView):
    """Verify email with token"""
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        token = request.data.get('token', '').strip()
        
        if not token:
            return Response(
                {'error': 'Verification token is required'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            verification = EmailVerificationToken.objects.get(token=token)
            
            if not verification.is_valid():
                return Response(
                    {'error': 'This verification link has expired. Please register again.'},
                    status=status.HTTP_400_BAD_REQUEST
                )
            
            # Activate user
            user = verification.user
            user.is_active = True
            user.save()
            
            # Mark as verified
            verification.verified = True
            verification.save()
            
            # Send welcome email now
            send_welcome_email(user)
            
            return Response({
                'message': 'Email verified successfully! You can now log in.',
                'email': user.email
            })
            
        except EmailVerificationToken.DoesNotExist:
            return Response(
                {'error': 'Invalid verification link.'},
                status=status.HTTP_400_BAD_REQUEST
            )

@method_decorator(ratelimit(key='ip', rate='3/h', method='POST', block=True), name='post')
class ResendVerificationView(APIView):
    """Resend verification email - rate limited to prevent abuse"""
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        email = request.data.get('email', '').strip().lower()
        
        if not email:
            return Response(
                {'error': 'Email is required'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            user = User.objects.get(email__iexact=email)
            
            # Check if user is already active
            if user.is_active:
                return Response({
                    'message': 'This account is already verified. Please log in.'
                })
            
            # Check if user has staff profile (shouldn't happen but safety check)
            if hasattr(user, 'staff_profile'):
                return Response({
                    'message': 'If an unverified account exists with this email, a new verification link has been sent.'
                })
            
            # Check if verification token exists
            try:
                verification = user.email_verification
                
                # If still valid, resend same token
                if verification.is_valid():
                    frontend_url = settings.FRONTEND_URL or 'https://totetaxi.netlify.app'
                    verify_url = f'{frontend_url}/verify-email?token={verification.token}'
                    send_email_verification(user, verification.token, verify_url)
                else:
                    # Token expired, create new one
                    verification.delete()
                    new_verification = EmailVerificationToken.create_token(user)
                    frontend_url = settings.FRONTEND_URL or 'https://totetaxi.netlify.app'
                    verify_url = f'{frontend_url}/verify-email?token={new_verification.token}'
                    send_email_verification(user, new_verification.token, verify_url)
                    
            except EmailVerificationToken.DoesNotExist:
                # No verification token exists, create new one
                new_verification = EmailVerificationToken.create_token(user)
                frontend_url = settings.FRONTEND_URL or 'https://totetaxi.netlify.app'
                verify_url = f'{frontend_url}/verify-email?token={new_verification.token}'
                send_email_verification(user, new_verification.token, verify_url)
            
            return Response({
                'message': 'If an unverified account exists with this email, a new verification link has been sent.'
            })
            
        except User.DoesNotExist:
            # Don't reveal if user doesn't exist (security)
            return Response({
                'message': 'If an unverified account exists with this email, a new verification link has been sent.'
            })

@method_decorator(ratelimit(key='user_or_ip', rate='20/m', method='POST', block=True), name='post')
@method_decorator(csrf_exempt, name='dispatch')
class CustomerLogoutView(APIView):
    """Enhanced customer logout endpoint with complete session cleanup and rate limiting"""
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        # Always logout, even if not authenticated (cleanup)
        logout(request)
        
        # Force session cleanup
        if hasattr(request, 'session'):
            request.session.flush()
        
        response = Response({'message': 'Logout successful'})
        
        # Clear all possible auth cookies
        auth_cookies = ['sessionid', 'csrftoken']
        for cookie_name in auth_cookies:
            response.delete_cookie(cookie_name)
            # Also try with domain
            response.delete_cookie(cookie_name, domain='.totetaxi.com')
        
        return response


@method_decorator(ratelimit(key='user', rate='60/m', method='GET', block=True), name='get')
class CurrentUserView(APIView):
    """Get current authenticated user info with profile validation and rate limiting"""
    permission_classes = [permissions.IsAuthenticated]
    
    def get(self, request):
        # Ensure profile integrity
        try:
            CustomerProfile.ensure_single_profile_type(request.user)
        except ValidationError as e:
            return Response({'error': str(e)}, status=status.HTTP_400_BAD_REQUEST)
        
        if hasattr(request.user, 'customer_profile'):
            return Response({
                'user': UserSerializer(request.user).data,
                'customer_profile': CustomerProfileSerializer(request.user.customer_profile).data,
                'csrf_token': get_token(request)
            })
        else:
            return Response({'error': 'Not a customer account'}, status=status.HTTP_403_FORBIDDEN)


@method_decorator(ratelimit(key='ip', rate='100/m', method='GET', block=True), name='get')
class CSRFTokenView(APIView):
    """Get CSRF token for authenticated requests with rate limiting"""
    permission_classes = [permissions.AllowAny]
    
    @method_decorator(ensure_csrf_cookie)
    def get(self, request):
        return Response({
            'csrf_token': get_token(request)
        })


@method_decorator(ratelimit(key='user', rate='30/m', method=['GET', 'PATCH'], block=True), name='dispatch')
class CustomerProfileView(generics.RetrieveUpdateAPIView):
    """Customer profile management with validation and rate limiting"""
    serializer_class = CustomerProfileSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_object(self):
        # Check if user has a customer profile
        if not hasattr(self.request.user, 'customer_profile'):
            from rest_framework.exceptions import NotFound
            raise NotFound("User does not have a customer profile")

        # Ensure profile integrity
        try:
            CustomerProfile.ensure_single_profile_type(self.request.user)
        except ValidationError as e:
            from rest_framework.exceptions import NotFound
            raise NotFound(str(e))

        return self.request.user.customer_profile


@method_decorator(ratelimit(key='user', rate='20/m', method=['GET', 'POST'], block=True), name='dispatch')
class SavedAddressListCreateView(generics.ListCreateAPIView):
    """List and create saved addresses with rate limiting"""
    serializer_class = SavedAddressSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        return self.request.user.saved_addresses.filter(is_active=True)
    
    def perform_create(self, serializer):
        serializer.save(user=self.request.user)


@method_decorator(ratelimit(key='user', rate='15/m', method=['GET', 'PATCH', 'DELETE'], block=True), name='dispatch')
class SavedAddressDetailView(generics.RetrieveUpdateDestroyAPIView):
    """Retrieve, update, delete saved address with rate limiting"""
    serializer_class = SavedAddressSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        return self.request.user.saved_addresses.all()


@method_decorator(ratelimit(key='user', rate='30/m', method='GET', block=True), name='get')
class CustomerBookingListView(generics.ListAPIView):
    """Customer booking history with rate limiting"""
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        return self.request.user.bookings.filter(
            deleted_at__isnull=True
        ).order_by('-created_at')
    
    def get(self, request, *args, **kwargs):
        bookings = self.get_queryset()
        booking_data = []
        
        for booking in bookings:
            booking_data.append({
                'id': str(booking.id),
                'booking_number': booking.booking_number,
                'service_type': booking.get_service_type_display(),
                'status': booking.get_status_display(),
                'pickup_date': booking.pickup_date,
                'total_price': booking.total_price_dollars,
                'created_at': booking.created_at
            })
        
        return Response({
            'bookings': booking_data,
            'total_count': len(booking_data)
        })


@method_decorator(ratelimit(key='user', rate='5/m', method='PATCH', block=True), name='patch')
class CustomerNotesUpdateView(APIView):
    """Update customer notes with rate limiting - staff only"""
    permission_classes = [IsStaffMember]

    def patch(self, request, customer_id):
        try:
            customer_user = User.objects.get(id=customer_id)
            customer_profile = customer_user.customer_profile
        except (User.DoesNotExist, CustomerProfile.DoesNotExist):
            return Response({'error': 'Customer not found'}, status=status.HTTP_404_NOT_FOUND)
        
        notes = request.data.get('notes', '')
        customer_profile.notes = notes
        customer_profile.save()

        StaffAction.log_action(
            staff_user=request.user,
            action_type='modify_customer',
            description=f'Updated notes for customer {customer_user.get_full_name()}',
            request=request,
            customer_id=customer_profile.id,
        )

        return Response({
            'message': 'Customer notes updated successfully',
            'notes': customer_profile.notes
        })


@method_decorator(ratelimit(key='user', rate='20/m', method='GET', block=True), name='get')
class CustomerDashboardView(APIView):
    """Enhanced customer dashboard with booking insights and rate limiting"""
    permission_classes = [permissions.IsAuthenticated]
    
    def get(self, request):
        if not hasattr(request.user, 'customer_profile'):
            return Response(
                {'error': 'This is not a customer account'}, 
                status=status.HTTP_403_FORBIDDEN
            )
        
        customer_profile = request.user.customer_profile
        
        all_bookings = request.user.bookings.filter(deleted_at__isnull=True).order_by('-created_at')
        recent_bookings = all_bookings[:5]

        # Upcoming = paid bookings with future pickup date (not yet completed/cancelled)
        from django.utils import timezone
        today = timezone.now().date()
        upcoming_bookings = all_bookings.filter(
            status='paid',
            pickup_date__gte=today
        ).count()
        completed_bookings = all_bookings.filter(status='completed').count()
        
        saved_addresses = request.user.saved_addresses.filter(is_active=True)
        payment_methods = request.user.payment_methods.filter(is_active=True)
        
        popular_addresses = saved_addresses.order_by('-times_used')[:3]
        
        # ✅ FIX: Serialize the recent bookings properly
        from .booking_serializers import CustomerBookingDetailSerializer
        
        return Response({
            'customer_profile': {
                'name': request.user.get_full_name(),
                'email': request.user.email,
                'phone': customer_profile.phone,
                'is_vip': customer_profile.is_vip,
                'total_bookings': customer_profile.total_bookings,
                'total_spent_dollars': customer_profile.total_spent_dollars,
                'last_booking_at': customer_profile.last_booking_at
            },
            'booking_summary': {
                'pending_bookings': upcoming_bookings,
                'completed_bookings': completed_bookings,
                'total_bookings': all_bookings.count()
            },
            'recent_bookings': CustomerBookingDetailSerializer(recent_bookings, many=True).data,  # ✅ FIXED!
            'saved_addresses_count': saved_addresses.count(),
            'payment_methods_count': payment_methods.count(),
            'popular_addresses': SavedAddressSerializer(popular_addresses, many=True).data
        })

@method_decorator(ratelimit(key='user', rate='15/m', method='GET', block=True), name='get')
class BookingPreferencesView(APIView):
    """Manage customer booking preferences with rate limiting"""
    permission_classes = [permissions.IsAuthenticated]
    
    def get(self, request):
        customer_profile = request.user.customer_profile
        
        return Response({
            'preferred_pickup_time': customer_profile.preferred_pickup_time,
            'email_notifications': customer_profile.email_notifications,
            'sms_notifications': customer_profile.sms_notifications,
            'default_addresses': {
                'most_used_pickup': self._get_most_used_address('pickup'),
                'most_used_delivery': self._get_most_used_address('delivery')
            }
        })
    
    def _get_most_used_address(self, address_type):
        """Return the most-used saved address.

        Note: address_type is accepted for labeling but not filtered —
        SavedAddress has no address_type field.
        """
        most_used = self.request.user.saved_addresses.filter(
            is_active=True
        ).order_by('-times_used').first()
        return SavedAddressSerializer(most_used).data if most_used else None

# Add these imports at the top

# Add these new views at the end of the file

@method_decorator(csrf_exempt, name='dispatch')  # ← ADD THIS LINE
@method_decorator(ratelimit(key='ip', rate='10/h', method='POST', block=True), name='post')  # ← CHANGED from 3/h to 10/h
class PasswordResetRequestView(APIView):
    """Request password reset - sends email with reset link"""
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        email = request.data.get('email', '').strip().lower()
        
        if not email:
            return Response(
                {'error': 'Email is required'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            user = User.objects.get(email__iexact=email)
            
            # Only allow password reset for customer accounts
            if not hasattr(user, 'customer_profile'):
                # Don't reveal if account exists
                return Response({
                    'message': 'If an account exists with this email, you will receive password reset instructions.'
                })
            
            # Create reset token
            reset_token_obj = PasswordResetToken.create_token(user)
            
            # Build reset URL (frontend URL)
            frontend_url = settings.FRONTEND_URL or 'https://totetaxi.netlify.app'
            reset_url = f'{frontend_url}/reset-password?token={reset_token_obj.token}'
            
            # Send email
            send_password_reset_email(user, reset_token_obj.token, reset_url)
            
            return Response({
                'message': 'If an account exists with this email, you will receive password reset instructions.'
            })
            
        except User.DoesNotExist:
            # Don't reveal if account doesn't exist (security best practice)
            return Response({
                'message': 'If an account exists with this email, you will receive password reset instructions.'
            })
        
# 2. Password Reset Confirm View - Around line 405
@method_decorator(csrf_exempt, name='dispatch')  # ← ADD THIS LINE
@method_decorator(ratelimit(key='ip', rate='10/h', method='POST', block=True), name='post')  # ← CHANGED from 5/h to 10/h
class PasswordResetConfirmView(APIView):
    """Confirm password reset with token"""
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        token = request.data.get('token', '').strip()
        new_password = request.data.get('new_password', '')
        
        if not token or not new_password:
            return Response(
                {'error': 'Token and new password are required'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        if len(new_password) < 8:
            return Response(
                {'error': 'Password must be at least 8 characters'},
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            reset_token = PasswordResetToken.objects.get(token=token)
            
            if not reset_token.is_valid():
                return Response(
                    {'error': 'This reset link has expired or been used. Please request a new one.'},
                    status=status.HTTP_400_BAD_REQUEST
                )
            
            # Reset the password
            user = reset_token.user
            user.set_password(new_password)
            user.save()
            
            # Mark token as used
            reset_token.used = True
            reset_token.save()
            
            # Invalidate all other sessions
            if hasattr(user, 'session_set'):
                user.session_set.all().delete()
            
            return Response({
                'message': 'Password reset successful. You can now log in with your new password.'
            })
            
        except PasswordResetToken.DoesNotExist:
            return Response(
                {'error': 'Invalid reset link. Please request a new one.'},
                status=status.HTTP_400_BAD_REQUEST
            )
        


@method_decorator(ratelimit(key='ip', rate='5/h', method='POST', block=True), name='post')
@method_decorator(ensure_csrf_cookie, name='dispatch')
class ContactFormView(APIView):
    """
    Contact form endpoint - sends email to info@totetaxi.com
    Rate limited to 5 submissions per hour per IP to prevent spam
    """
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        # Get form data
        name = request.data.get('name', '').strip()
        email = request.data.get('email', '').strip()
        phone = request.data.get('phone', '').strip()
        subject_type = request.data.get('subject', 'General')
        message = request.data.get('message', '').strip()
        website = request.data.get('website', '').strip()  # Honeypot field
        recaptcha_token = request.data.get('recaptcha_token', '').strip()

        # Honeypot check - if filled, it's likely a bot
        if website:
            # Silently reject - don't let bots know they failed
            logger.warning(f'Honeypot triggered for contact form from IP: {request.META.get("REMOTE_ADDR")}')
            return Response({
                'message': 'Thank you for contacting us! We will respond within 24 hours.'
            }, status=status.HTTP_200_OK)

        # Verify reCAPTCHA token
        if recaptcha_token:
            recaptcha_secret = settings.RECAPTCHA_SECRET_KEY
            if recaptcha_secret:
                try:
                    import requests
                    recaptcha_response = requests.post(
                        'https://www.google.com/recaptcha/api/siteverify',
                        data={
                            'secret': recaptcha_secret,
                            'response': recaptcha_token,
                        },
                        timeout=5
                    )
                    recaptcha_result = recaptcha_response.json()

                    # Check if verification was successful and score is acceptable
                    if not recaptcha_result.get('success'):
                        logger.warning(f'reCAPTCHA verification failed: {recaptcha_result}')
                        return Response(
                            {'error': 'reCAPTCHA verification failed. Please try again.'},
                            status=status.HTTP_400_BAD_REQUEST
                        )

                    # Check score (v3 returns score 0.0-1.0, lower = more bot-like)
                    score = recaptcha_result.get('score', 0.0)
                    if score < 0.5:
                        logger.warning(f'Low reCAPTCHA score ({score}) for contact form from IP: {request.META.get("REMOTE_ADDR")}')
                        return Response(
                            {'error': 'Suspicious activity detected. Please try again.'},
                            status=status.HTTP_400_BAD_REQUEST
                        )

                except Exception as e:
                    logger.error(f'reCAPTCHA verification error: {str(e)}')
                    # Continue without reCAPTCHA if verification fails

        # Validate required fields
        errors = {}
        if not name:
            errors['name'] = 'Name is required'
        if not email:
            errors['email'] = 'Email is required'
        if not message:
            errors['message'] = 'Message is required'

        if errors:
            return Response({'errors': errors}, status=status.HTTP_400_BAD_REQUEST)
        
        # Build email content
        email_subject = f'Contact Form: {subject_type} - {name}'
        email_body = f"""
New contact form submission from Tote Taxi website:

Name: {name}
Email: {email}
Phone: {phone or 'Not provided'}
Subject: {subject_type}

Message:
{message}

---
This message was sent from the Tote Taxi contact form.
Reply directly to: {email}
"""
        
        try:
            # Send email to info@totetaxi.com
            send_mail(
                subject=email_subject,
                message=email_body,
                from_email=settings.DEFAULT_FROM_EMAIL,
                recipient_list=['info@totetaxi.com'],
                fail_silently=False,
            )
            
            return Response({
                'message': 'Thank you for contacting us! We will respond within 24 hours.'
            }, status=status.HTTP_200_OK)
            
        except Exception as e:
            logger.error(f'Failed to send contact form email: {str(e)}')
            return Response(
                {'error': 'Failed to send message. Please try again or email us directly at info@totetaxi.com'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )
```

# ──── backend/apps/customers/management/commands/clean_delete_user.py ────

```python
from django.core.management.base import BaseCommand
from django.contrib.auth.models import User
from apps.bookings.models import Booking, GuestCheckout
from apps.payments.models import Payment
from django.db import transaction


class Command(BaseCommand):
    help = 'Completely delete a user and all associated data for clean testing'
    
    def add_arguments(self, parser):
        parser.add_argument('email', type=str, help='Email of user to delete')
        parser.add_argument(
            '--dry-run', 
            action='store_true',
            help='Show what would be deleted without actually deleting'
        )
    
    def handle(self, *args, **options):
        email = options['email']
        dry_run = options['dry_run']
        
        if dry_run:
            self.stdout.write(self.style.WARNING(f"DRY RUN - No data will actually be deleted"))
        
        self.stdout.write(f"🔍 Searching for user: {email}")
        
        # Track what we'll delete
        deletion_summary = {
            'users': 0,
            'bookings': 0,
            'payments': 0,
            'guest_checkouts': 0,
            'saved_addresses': 0,
            'payment_methods': 0
        }
        
        with transaction.atomic():
            # Find authenticated user
            try:
                user = User.objects.get(email__iexact=email)
                self.stdout.write(f"✅ Found user: {user.get_full_name()} (ID: {user.id})")
                
                # Check profile type
                if hasattr(user, 'customer_profile'):
                    self.stdout.write("   👤 Customer Profile")
                    deletion_summary['saved_addresses'] = user.saved_addresses.count()
                    deletion_summary['payment_methods'] = user.payment_methods.count()
                
                if hasattr(user, 'staff_profile'):
                    self.stdout.write("   👮 Staff Profile")
                
                # Count bookings
                user_bookings = user.bookings.all()
                deletion_summary['bookings'] = user_bookings.count()
                
                # Count payments
                booking_ids = [str(b.id) for b in user_bookings]
                user_payments = Payment.objects.filter(booking_id__in=booking_ids)
                deletion_summary['payments'] = user_payments.count()
                
                if not dry_run:
                    # Delete user (cascades to profile, bookings, addresses, etc.)
                    user.delete()
                    deletion_summary['users'] = 1
                    self.stdout.write(self.style.SUCCESS(f"✅ Deleted authenticated user and cascaded data"))
                else:
                    self.stdout.write(f"   Would delete user and {deletion_summary['bookings']} bookings")
            
            except User.DoesNotExist:
                self.stdout.write("❌ No authenticated user found with that email")
            
            # Find guest checkout records
            guest_checkouts = GuestCheckout.objects.filter(email__iexact=email)
            deletion_summary['guest_checkouts'] = guest_checkouts.count()
            
            if guest_checkouts.exists():
                self.stdout.write(f"✅ Found {guest_checkouts.count()} guest checkout records")
                
                if not dry_run:
                    # Delete associated bookings first, then guest records
                    for guest in guest_checkouts:
                        if hasattr(guest, 'booking') and guest.booking:
                            guest.booking.delete()
                    guest_checkouts.delete()
                    self.stdout.write(self.style.SUCCESS("✅ Deleted guest checkout records"))
                else:
                    self.stdout.write(f"   Would delete {guest_checkouts.count()} guest records")
            
            # Raise exception to rollback if dry run
            if dry_run:
                self.stdout.write(self.style.WARNING("DRY RUN - Rolling back transaction"))
                raise transaction.TransactionManagementError("Dry run - rollback")
        
        # Print summary
        self.stdout.write("\n" + "="*50)
        if dry_run:
            self.stdout.write(self.style.WARNING("📋 WOULD DELETE:"))
        else:
            self.stdout.write(self.style.SUCCESS("📋 DELETED:"))
        
        self.stdout.write(f"   👤 Users: {deletion_summary['users']}")
        self.stdout.write(f"   📦 Bookings: {deletion_summary['bookings']}")  
        self.stdout.write(f"   💳 Payments: {deletion_summary['payments']}")
        self.stdout.write(f"   👻 Guest Checkouts: {deletion_summary['guest_checkouts']}")
        self.stdout.write(f"   📍 Saved Addresses: {deletion_summary['saved_addresses']}")
        self.stdout.write(f"   💰 Payment Methods: {deletion_summary['payment_methods']}")
        
        if not dry_run:
            self.stdout.write(self.style.SUCCESS(f"\n🧹 Email {email} completely cleaned from system"))
        else:
            self.stdout.write(self.style.WARNING(f"\n🔍 Run without --dry-run to actually delete"))
```

# ──── backend/apps/logistics/admin.py ────

```python

```

# ──── backend/apps/logistics/apps.py ────

```python
# apps/logistics/apps.py
from django.apps import AppConfig


class LogisticsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'apps.logistics'
    verbose_name = 'Logistics'
```

# ──── backend/apps/logistics/models.py ────

```python
# apps/logistics/models.py
import uuid
from django.db import models
from django.utils import timezone
import logging

logger = logging.getLogger(__name__)


class OnfleetTask(models.Model):
    """
    Onfleet task tracking - 2 tasks per booking (pickup + dropoff)
    Each task triggers separate SMS to recipient
    """
    
    TASK_TYPE_CHOICES = [
        ('pickup', 'Pickup'),
        ('dropoff', 'Dropoff'),
    ]
    
    STATUS_CHOICES = [
        ('created', 'Created'),
        ('assigned', 'Assigned to Driver'),
        ('active', 'Driver En Route'),
        ('completed', 'Completed'),
        ('failed', 'Failed'),
        ('deleted', 'Deleted'),
    ]
    
    ENVIRONMENT_CHOICES = [
        ('sandbox', 'Sandbox'),
        ('production', 'Production'),
    ]
    
    # Primary identifiers
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Core relationship - NOW supports multiple tasks per booking
    booking = models.ForeignKey(
        'bookings.Booking',
        on_delete=models.CASCADE,
        related_name='onfleet_tasks'  # Changed from onfleet_task (singular)
    )
    
    # NEW: Task type and linking
    task_type = models.CharField(
        max_length=10,
        choices=TASK_TYPE_CHOICES,
        help_text="Pickup or Dropoff task"
    )
    
    linked_task = models.ForeignKey(
        'self',
        null=True,
        blank=True,
        on_delete=models.SET_NULL,
        related_name='dependent_tasks',
        help_text="For dropoff tasks, links to the pickup task"
    )
    
    # Onfleet identifiers
    onfleet_task_id = models.CharField(max_length=100, unique=True)
    onfleet_short_id = models.CharField(max_length=20, blank=True)
    tracking_url = models.URLField(max_length=500, blank=True)
    
    # NEW: Environment tracking
    environment = models.CharField(
        max_length=20,
        choices=ENVIRONMENT_CHOICES,
        default='sandbox'
    )
    
    # NEW: Recipient (who receives SMS for THIS task)
    recipient_name = models.CharField(max_length=255, blank=True)
    recipient_phone = models.CharField(max_length=20, blank=True)
    
    # Status tracking
    status = models.CharField(
        max_length=20,
        choices=STATUS_CHOICES,
        default='created'
    )
    
    # NEW: Worker/driver info
    worker_id = models.CharField(max_length=255, blank=True)
    worker_name = models.CharField(max_length=255, blank=True)
    
    # NEW: Timing
    estimated_arrival = models.DateTimeField(null=True, blank=True)
    started_at = models.DateTimeField(null=True, blank=True)
    completed_at = models.DateTimeField(null=True, blank=True)
    
    # NEW: Proof of delivery
    signature_url = models.URLField(blank=True)
    photo_urls = models.JSONField(default=list, blank=True)
    delivery_notes = models.TextField(blank=True)
    
    # NEW: Failure tracking
    failure_reason = models.CharField(max_length=100, blank=True)
    failure_notes = models.TextField(blank=True)
    
    # Timestamps
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    last_synced = models.DateTimeField(null=True, blank=True)
    
    class Meta:
        db_table = 'logistics_onfleet_task'
        verbose_name = 'Onfleet Task'
        verbose_name_plural = 'Onfleet Tasks'
        ordering = ['-created_at']
        indexes = [
            models.Index(fields=['booking', 'task_type']),
            models.Index(fields=['onfleet_task_id']),
            models.Index(fields=['status', 'environment']),
            models.Index(fields=['created_at']),
        ]
        # NEW: Ensure one pickup and one dropoff per booking
        constraints = [
            models.UniqueConstraint(
                fields=['booking', 'task_type'],
                name='unique_task_type_per_booking'
            )
        ]
    
    def __str__(self):
        return f"{self.task_type.upper()} - {self.booking.booking_number} ({self.status})"
    
    def is_pickup(self):
        return self.task_type == 'pickup'
    
    def is_dropoff(self):
        return self.task_type == 'dropoff'
    
    def sync_status_from_onfleet(self, onfleet_state):
        """Convert Onfleet state (0-3) to our status"""
        state_mapping = {
            0: 'created',    # unassigned
            1: 'assigned',   # assigned to driver
            2: 'active',     # driver started
            3: 'completed'   # delivery done
        }
        
        old_status = self.status
        self.status = state_mapping.get(onfleet_state, 'failed')
        self.last_synced = timezone.now()
        self.save()
        
        # ONLY mark booking complete when DROPOFF task completes
        if old_status != 'completed' and self.status == 'completed' and self.is_dropoff():
            self._mark_booking_completed()
    
    def _mark_booking_completed(self):
        """Update ToteTaxi booking when DROPOFF delivery completes.

        NOTE: Customer stats (total_bookings, total_spent_cents) are
        incremented in payments/services.py when payment succeeds.
        Do NOT increment them here — that causes double-counting (C5 fix).
        """
        try:
            if self.booking.status in ['confirmed', 'paid', 'in_progress']:
                self.booking.status = 'completed'
                self.booking.save(_skip_pricing=True)
                logger.info(f"✓ Booking {self.booking.booking_number} marked completed")

        except Exception as e:
            logger.error(f"Error updating booking completion: {e}")


# UPDATED Signal - now creates 2 tasks instead of 1
from django.db.models.signals import post_save
from django.dispatch import receiver

@receiver(post_save, sender='bookings.Booking')
def create_onfleet_tasks_on_payment(sender, instance, created, **kwargs):
    """
    Auto-create Onfleet tasks when booking status transitions to paid/confirmed.
    Only fires on actual status changes, not every save. Creates 2 tasks: pickup + dropoff.
    """
    if instance.status not in ['paid', 'confirmed']:
        return

    # Only act on real transitions (new booking or status actually changed)
    original = getattr(instance, '_original_status', None)
    if not created and original == instance.status:
        return

    # Check if tasks already exist
    if instance.onfleet_tasks.exists():
        logger.debug(f"Tasks already exist for booking {instance.booking_number}")
        return

    try:
        from .services import ToteTaxiOnfleetIntegration
        integration = ToteTaxiOnfleetIntegration()
        pickup, dropoff = integration.create_tasks_for_booking(instance)

        if pickup and dropoff:
            logger.info(f"✓ Created 2 Onfleet tasks for booking {instance.booking_number}")
        else:
            logger.error(f"✗ Failed to create tasks for booking {instance.booking_number}")

    except Exception as e:
        logger.error(f"Error in Onfleet signal: {e}", exc_info=True)
```

# ──── backend/apps/logistics/services.py ────

```python
import logging
import re
import time
from datetime import datetime, timedelta, time as dt_time
from typing import Dict, Optional, Tuple

import requests
from django.conf import settings
from django.utils import timezone

logger = logging.getLogger(__name__)


def parse_street_address(address_line_1: str) -> Tuple[str, str]:
    """Parse a full street address into street number and street name for Onfleet."""
    if not address_line_1:
        return "", ""
    
    address_line_1 = address_line_1.strip()
    pattern = r'^(\d+(?:[A-Z]|[-\s]*[A-Z]|[-\s]*\d+/\d+)?)\s+(.+)'
    match = re.match(pattern, address_line_1, re.IGNORECASE)
    
    if match:
        return match.group(1).strip(), match.group(2).strip()
    else:
        return "", address_line_1


class OnfleetService:
    """Low-level Onfleet API wrapper"""

    def __init__(self):
        self.api_key = getattr(settings, 'ONFLEET_API_KEY', '')
        self.base_url = 'https://onfleet.com/api/v2'
        self.mock_mode = getattr(settings, 'ONFLEET_MOCK_MODE', True)
        self.environment = getattr(settings, 'ONFLEET_ENVIRONMENT', 'sandbox')

    def _make_request(self, method: str, endpoint: str, data: dict = None) -> dict:
        """Make authenticated request to Onfleet API"""
        if self.mock_mode:
            return self._mock_response(method, endpoint, data)

        url = f"{self.base_url}/{endpoint}"
        auth = (self.api_key, '')
        headers = {'Content-Type': 'application/json'}

        try:
            if method == 'GET':
                response = requests.get(url, auth=auth, headers=headers)
            elif method == 'POST':
                response = requests.post(url, auth=auth, headers=headers, json=data)
            elif method == 'PUT':
                response = requests.put(url, auth=auth, headers=headers, json=data)
            elif method == 'DELETE':
                response = requests.delete(url, auth=auth, headers=headers)

            response.raise_for_status()
            return response.json()

        except requests.RequestException as e:
            error_detail = ''
            if hasattr(e, 'response') and e.response is not None:
                try:
                    error_detail = e.response.json()
                except Exception:
                    error_detail = e.response.text

            logger.error(f"Onfleet API error ({method} {endpoint}): {e}")
            logger.error(f"Error details: {error_detail}")
            logger.error(f"Request data: {data}")
            raise

    def _mock_response(self, method: str, endpoint: str, data: dict = None) -> dict:
        """Mock responses for development"""
        if endpoint == 'tasks' and method == 'POST':
            task_metadata = data.get('metadata', [])
            booking_number = next((m['value'] for m in task_metadata if m.get('name') == 'booking_number'), 'unknown')
            task_type = next((m['value'] for m in task_metadata if m.get('name') == 'task_type'), 'unknown')

            mock_id = f'mock_{task_type}_{hash(booking_number) % 10000:04d}'

            return {
                'id': mock_id,
                'shortId': f'mt{hash(booking_number) % 1000:03d}',
                'trackingURL': f'https://onf.lt/mock{hash(f"{booking_number}{task_type}") % 10000:04d}',
                'state': 0,
                'worker': None,
                'merchant': 'mock_org_id',
                'creator': 'mock_admin_id',
                'pickupTask': data.get('pickupTask', False),
                'dependencies': data.get('dependencies', [])
            }

        elif endpoint == 'organization':
            return {
                'id': 'mock_org_id',
                'name': f'ToteTaxi ({self.environment.upper()} - MOCK MODE)',
                'activeTasks': 5,
                'workers': [
                    {'id': 'mock_worker_1', 'name': 'Test Driver 1', 'onDuty': True},
                    {'id': 'mock_worker_2', 'name': 'Test Driver 2', 'onDuty': False}
                ]
            }

        elif endpoint.startswith('workers/'):
            return {
                'id': endpoint.split('/')[-1],
                'name': 'Test Driver',
                'onDuty': True
            }

        return {'success': True, 'mock': True}

    def create_task(self, task_data: dict) -> dict:
        return self._make_request('POST', 'tasks', task_data)

    def get_organization_info(self) -> dict:
        return self._make_request('GET', 'organization')

    def get_worker(self, worker_id: str) -> dict:
        return self._make_request('GET', f'workers/{worker_id}')


class ToteTaxiOnfleetIntegration:
    """High-level integration manager for ToteTaxi + Onfleet"""

    def __init__(self):
        self.onfleet = OnfleetService()

    def create_tasks_for_booking(self, booking) -> Tuple[Optional['OnfleetTask'], Optional['OnfleetTask']]:
        from .models import OnfleetTask

        try:
            existing = OnfleetTask.objects.filter(booking=booking)
            if existing.exists():
                logger.warning(f"Booking {booking.booking_number} already has Onfleet tasks")
                return existing.filter(task_type='pickup').first(), existing.filter(task_type='dropoff').first()

            logger.info(f"Creating Onfleet tasks for booking {booking.booking_number}")

            pickup_response = self._create_pickup_task(booking)
            logger.info(f"✓ Pickup task created: {pickup_response['id']}")

            dropoff_response = self._create_dropoff_task(booking, depends_on=pickup_response['id'])
            logger.info(f"✓ Dropoff task created: {dropoff_response['id']}")

            db_pickup = OnfleetTask.objects.create(
                booking=booking,
                task_type='pickup',
                environment=self.onfleet.environment,
                onfleet_task_id=pickup_response['id'],
                onfleet_short_id=pickup_response.get('shortId', ''),
                tracking_url=pickup_response.get('trackingURL', ''),
                recipient_name=booking.get_customer_name(),
                recipient_phone=self._format_phone(self._get_customer_phone(booking)),
                status=self._map_onfleet_state(pickup_response.get('state', 0)),
                worker_id=pickup_response.get('worker', '') or '',
                worker_name=self._get_worker_name(pickup_response.get('worker'))
            )

            db_dropoff = OnfleetTask.objects.create(
                booking=booking,
                task_type='dropoff',
                environment=self.onfleet.environment,
                onfleet_task_id=dropoff_response['id'],
                onfleet_short_id=dropoff_response.get('shortId', ''),
                tracking_url=dropoff_response.get('trackingURL', ''),
                recipient_name=self._get_dropoff_recipient_name(booking),
                recipient_phone=self._format_phone(self._get_dropoff_recipient_phone(booking)),
                linked_task=db_pickup,
                status=self._map_onfleet_state(dropoff_response.get('state', 0)),
                worker_id=dropoff_response.get('worker', '') or '',
                worker_name=self._get_worker_name(dropoff_response.get('worker'))
            )

            logger.info(f"✓ Onfleet tasks saved to database: {db_pickup.id}, {db_dropoff.id}")
            return db_pickup, db_dropoff

        except Exception as e:
            logger.error(f"Failed to create Onfleet tasks: {e}", exc_info=True)
            return None, None

    def _map_onfleet_state(self, state: int) -> str:
        return {
            0: 'created',
            1: 'assigned',
            2: 'active',
            3: 'completed',
        }.get(state, 'created')

    def _get_worker_name(self, worker_id_or_obj) -> str:
        if not worker_id_or_obj:
            return ''
        if isinstance(worker_id_or_obj, dict):
            return worker_id_or_obj.get('name', '')
        try:
            worker = self.onfleet.get_worker(worker_id_or_obj)
            return worker.get('name', '')
        except Exception as e:
            logger.warning(f"Could not fetch worker name for {worker_id_or_obj}: {e}")
            return ''

    def _create_pickup_task(self, booking) -> dict:
        pickup_datetime = self._get_pickup_datetime(booking)
        window_start = pickup_datetime - timedelta(minutes=30)
        window_end = pickup_datetime + timedelta(minutes=30)

        street_number, street_name = parse_street_address(booking.pickup_address.address_line_1)

        task_data = {
            'destination': {
                'address': {
                    'number': street_number,
                    'street': street_name,
                    'apartment': getattr(booking.pickup_address, 'address_line_2', '') or '',
                    'city': booking.pickup_address.city,
                    'state': booking.pickup_address.state,
                    'postalCode': booking.pickup_address.zip_code,
                    'country': 'USA'
                }
            },
            'recipients': [{
                'name': booking.get_customer_name(),
                'phone': self._format_phone(self._get_customer_phone(booking)),
                'notes': booking.special_instructions or ''
            }],
            'completeAfter': int(window_start.timestamp() * 1000),
            'completeBefore': int(window_end.timestamp() * 1000),
            'pickupTask': True,
            'autoAssign': {'mode': 'off'},
            'notes': self._format_task_notes(booking, 'pickup'),
            'metadata': [
                {'name': 'booking_number', 'type': 'string', 'value': booking.booking_number},
                {'name': 'task_type', 'type': 'string', 'value': 'pickup'},
                {'name': 'service_type', 'type': 'string', 'value': booking.service_type}
            ]
        }
        return self.onfleet.create_task(task_data)

    def _create_dropoff_task(self, booking, depends_on: str) -> dict:
        dropoff_datetime = self._get_dropoff_datetime(booking)
        window_start = dropoff_datetime - timedelta(minutes=30)
        window_end = dropoff_datetime + timedelta(hours=1)

        street_number, street_name = parse_street_address(booking.delivery_address.address_line_1)

        task_data = {
            'destination': {
                'address': {
                    'number': street_number,
                    'street': street_name,
                    'apartment': getattr(booking.delivery_address, 'address_line_2', '') or '',
                    'city': booking.delivery_address.city,
                    'state': booking.delivery_address.state,
                    'postalCode': booking.delivery_address.zip_code,
                    'country': 'USA'
                }
            },
            'recipients': [{
                'name': self._get_dropoff_recipient_name(booking),
                'phone': self._format_phone(self._get_dropoff_recipient_phone(booking)),
                'notes': booking.special_instructions or ''
            }],
            'completeAfter': int(window_start.timestamp() * 1000),
            'completeBefore': int(window_end.timestamp() * 1000),
            'pickupTask': False,
            'dependencies': [depends_on],
            'autoAssign': {'mode': 'off'},
            'notes': self._format_task_notes(booking, 'dropoff'),
            'metadata': [
                {'name': 'booking_number', 'type': 'string', 'value': booking.booking_number},
                {'name': 'task_type', 'type': 'string', 'value': 'dropoff'},
                {'name': 'service_type', 'type': 'string', 'value': booking.service_type}
            ]
        }
        return self.onfleet.create_task(task_data)

    def _get_pickup_datetime(self, booking) -> datetime:
        if booking.service_type == 'blade_transfer' and getattr(booking, 'blade_ready_time', None):
            pickup_time_obj = booking.blade_ready_time
        elif booking.pickup_time == 'morning_specific' and getattr(booking, 'specific_pickup_hour', None):
            pickup_time_obj = dt_time(hour=booking.specific_pickup_hour, minute=0)
        else:
            pickup_times = {
                'morning': dt_time(8, 0),
                'afternoon': dt_time(14, 0),
                'evening': dt_time(18, 0),
                'night': dt_time(22, 0)
            }
            pickup_time_obj = pickup_times.get(booking.pickup_time, dt_time(8, 0))

        return timezone.make_aware(
            datetime.combine(booking.pickup_date, pickup_time_obj),
            timezone.get_current_timezone()
        )

    def _get_dropoff_datetime(self, booking) -> datetime:
        pickup = self._get_pickup_datetime(booking)
        return pickup + timedelta(hours=2)

    def _format_task_notes(self, booking, task_type: str) -> str:
        base_notes = f"ToteTaxi Booking: {booking.booking_number}\n"
        base_notes += f"Service: {booking.get_service_type_display()}\n"
        base_notes += f"Task: {task_type.upper()}\n"

        if booking.service_type == 'blade_transfer':
            if task_type == 'pickup':
                base_notes += f"Origin: Customer Location\n"
                base_notes += f"Destination: {booking.blade_airport} ({booking.blade_flight_time})\n"
                base_notes += f"Bags: {booking.blade_bag_count}\n"
                base_notes += f"Flight Date: {booking.blade_flight_date}\n"
            else:
                base_notes += f"Airport: {booking.blade_airport}\n"
                base_notes += f"Flight Time: {booking.blade_flight_time}\n"
                base_notes += f"Bags: {booking.blade_bag_count}\n"
        else:
            base_notes += f"Item: {getattr(booking, 'item_description', 'See details')}"

        return base_notes

    def _get_blade_contact(self, airport_code: str) -> Tuple[str, str]:
        blade_contacts = {
            'JFK': ('JFK Terminal', '+17184569876'),
            'EWR': ('Newark Terminal', '+19739876543'),
            'LGA': ('LaGuardia Terminal', '+17185551234')
        }
        return blade_contacts.get(airport_code, ('BLADE Terminal', '+12125551234'))

    def _get_customer_phone(self, booking) -> str:
        try:
            if getattr(booking, 'customer', None) and getattr(booking.customer, 'profile', None):
                return booking.customer.profile.phone or ''
            if getattr(booking, 'guest_checkout', None):
                return booking.guest_checkout.phone or ''
            return ''
        except Exception as e:
            logger.warning(f"Could not get customer phone: {e}")
            return ''

    def _format_phone(self, phone_str: str) -> str:
        if not phone_str:
            return '+1234567890'
        digits = ''.join(c for c in phone_str if c.isdigit())
        if len(digits) == 10:
            return f'+1{digits}'
        if len(digits) == 11 and digits[0] == '1':
            return f'+{digits}'
        return f'+{digits}' if not phone_str.startswith('+') else phone_str

    def _get_dropoff_recipient_phone(self, booking) -> str:
        if booking.service_type == 'blade_transfer':
            _, blade_phone = self._get_blade_contact(booking.blade_airport)
            return blade_phone
        return self._get_customer_phone(booking)

    def _get_dropoff_recipient_name(self, booking) -> str:
        if booking.service_type == 'blade_transfer':
            blade_name, _ = self._get_blade_contact(booking.blade_airport)
            return f"BLADE Team - {blade_name}"
        return booking.get_customer_name()

    def handle_webhook(self, webhook_data: dict) -> bool:
        from .models import OnfleetTask

        try:
            task_id = webhook_data.get('taskId') or webhook_data.get('data', {}).get('task', {}).get('id')
            if not task_id:
                logger.warning("Webhook received without task ID")
                logger.debug(f"Webhook payload: {webhook_data}")
                return False

            # Retry logic to handle race condition where webhook arrives
            # before DB transaction commits the OnfleetTask record
            onfleet_task = None
            max_retries = 5
            retry_delays = [0.1, 0.3, 0.5, 1.0, 2.0]  # exponential backoff

            for attempt in range(max_retries):
                try:
                    onfleet_task = OnfleetTask.objects.get(onfleet_task_id=task_id)
                    break  # Found it, exit retry loop
                except OnfleetTask.DoesNotExist:
                    if attempt < max_retries - 1:
                        delay = retry_delays[attempt]
                        logger.info(
                            f"Task {task_id} not found in database, "
                            f"retry {attempt + 1}/{max_retries} in {delay}s"
                        )
                        time.sleep(delay)
                    else:
                        logger.warning(f"Task not found in database after {max_retries} retries: {task_id}")
                        return False

            if not onfleet_task:
                return False

            trigger_id = webhook_data.get('triggerId')
            task_obj = webhook_data.get('data', {}).get('task', {})

            if trigger_id == 0:
                onfleet_task.status = 'active'
                onfleet_task.started_at = timezone.now()
                worker = task_obj.get('worker')
                if worker:
                    if isinstance(worker, dict):
                        onfleet_task.worker_id = worker.get('id', '')
                        onfleet_task.worker_name = worker.get('name', '')
                    else:
                        onfleet_task.worker_id = worker
                        onfleet_task.worker_name = self._get_worker_name(worker)
                onfleet_task.save()
                logger.info(f"Task started: {task_id} ({onfleet_task.task_type})")

            elif trigger_id == 3:
                onfleet_task.status = 'completed'
                onfleet_task.completed_at = timezone.now()
                completion = task_obj.get('completionDetails', {})
                onfleet_task.signature_url = completion.get('signatureUploadId', '')
                onfleet_task.photo_urls = [p.get('uploadId', '') for p in completion.get('photoUploadIds', [])]
                onfleet_task.delivery_notes = completion.get('notes', '')
                onfleet_task.save()

                if onfleet_task.task_type == 'dropoff':
                    booking = onfleet_task.booking
                    booking.status = 'completed'
                    booking.save(_skip_pricing=True)
                    logger.info(f"✓ Booking {booking.booking_number} completed")

                logger.info(f"Task completed: {task_id} ({onfleet_task.task_type})")

            elif trigger_id == 4:
                onfleet_task.status = 'failed'
                completion = task_obj.get('completionDetails', {})
                onfleet_task.failure_reason = completion.get('failureReason', '')
                onfleet_task.failure_notes = completion.get('failureNotes', '')
                onfleet_task.save()
                logger.error(f"Task failed: {task_id} - {onfleet_task.failure_reason}")

            elif trigger_id == 8:
                onfleet_task.status = 'deleted'
                onfleet_task.save()
                logger.warning(f"Task deleted: {task_id}")

            elif trigger_id == 1:
                eta_ts = task_obj.get('estimatedCompletionTime')
                if eta_ts:
                    onfleet_task.estimated_arrival = datetime.fromtimestamp(eta_ts / 1000, tz=timezone.get_current_timezone())
                    onfleet_task.save()
                    logger.info(f"Task ETA updated: {task_id}")

            elif trigger_id == 9:
                onfleet_task.status = 'assigned'
                worker = task_obj.get('worker') or webhook_data.get('data', {}).get('worker')
                if worker:
                    if isinstance(worker, dict):
                        onfleet_task.worker_id = worker.get('id', '')
                        onfleet_task.worker_name = worker.get('name', '')
                    else:
                        onfleet_task.worker_id = worker
                        onfleet_task.worker_name = self._get_worker_name(worker)
                onfleet_task.save()
                logger.info(f"Task assigned: {task_id} to {onfleet_task.worker_name}")

            elif trigger_id == 10:
                onfleet_task.status = 'created'
                onfleet_task.worker_id = ''
                onfleet_task.worker_name = ''
                onfleet_task.save()
                logger.info(f"Task unassigned: {task_id}")

            elif trigger_id == 7:
                # taskUpdated - fires when task is updated (assignment, feedback, attachments)
                # Update worker info if present
                worker = task_obj.get('worker') or webhook_data.get('data', {}).get('worker')
                if worker:
                    if isinstance(worker, dict):
                        onfleet_task.worker_id = worker.get('id', '')
                        onfleet_task.worker_name = worker.get('name', '')
                    else:
                        onfleet_task.worker_id = worker
                        onfleet_task.worker_name = self._get_worker_name(worker)

                # Update ETA if present
                eta_ts = task_obj.get('estimatedCompletionTime')
                if eta_ts:
                    onfleet_task.estimated_arrival = datetime.fromtimestamp(
                        eta_ts / 1000, tz=timezone.get_current_timezone()
                    )

                # Update state if present
                state = task_obj.get('state')
                if state is not None:
                    onfleet_task.status = self._map_onfleet_state(state)

                onfleet_task.save()
                logger.info(f"Task updated: {task_id} ({onfleet_task.task_type})")

            else:
                logger.info(f"Unhandled webhook trigger: {trigger_id} for task {task_id}")

            return True

        except Exception as e:
            logger.error(f"Webhook processing error: {e}", exc_info=True)
            logger.error(f"Webhook data: {webhook_data}")
            return False

    def get_dashboard_summary(self) -> dict:
        from .models import OnfleetTask
        from datetime import date

        try:
            today = date.today()
            onfleet_tasks = OnfleetTask.objects.filter(created_at__date=today, environment=self.onfleet.environment)
            onfleet_org = self.onfleet.get_organization_info()

            # Task counts for summary
            active_count = onfleet_tasks.filter(status__in=['assigned', 'active']).count()
            tasks_today = onfleet_tasks.count()
            completed_today = onfleet_tasks.filter(status='completed').count()
            pending_count = onfleet_tasks.filter(status='created').count()

            # Calculate completion rate
            completion_rate = 0
            if tasks_today > 0:
                completion_rate = round((completed_today / tasks_today) * 100, 1)

            return {
                # Top-level stats for frontend dashboard cards
                'active_tasks': active_count,
                'tasks_today': tasks_today,
                'completed_today': completed_today,
                'pending_tasks': pending_count,
                'completion_rate': completion_rate,
                # Detailed breakdowns
                'onfleet_stats': {
                    'active_tasks': onfleet_org.get('activeTasks', 0),
                    'available_workers': len([w for w in onfleet_org.get('workers', []) if w.get('onDuty')]),
                    'organization_name': onfleet_org.get('name', 'Unknown')
                },
                'integration_stats': {
                    'tasks_created_today': tasks_today,
                    'pickup_tasks': onfleet_tasks.filter(task_type='pickup').count(),
                    'dropoff_tasks': onfleet_tasks.filter(task_type='dropoff').count(),
                },
                'environment': self.onfleet.environment,
                'mock_mode': self.onfleet.mock_mode
            }

        except Exception as e:
            logger.error(f"Error getting dashboard summary: {e}")
            return {
                'error': 'Failed to fetch logistics data',
                'active_tasks': 0,
                'tasks_today': 0,
                'completed_today': 0,
                'pending_tasks': 0,
                'completion_rate': 0,
                'environment': self.onfleet.environment,
                'mock_mode': self.onfleet.mock_mode
            }

    def create_delivery_task(self, booking):
        pickup, dropoff = self.create_tasks_for_booking(booking)
        return pickup
```

# ──── backend/apps/logistics/urls.py ────

```python
# apps/logistics/urls.py
from django.urls import path
from . import views

app_name = 'logistics'

urlpatterns = [
    # Staff dashboard endpoints
    path('summary/', views.LogisticsSummaryView.as_view(), name='logistics-summary'),
    path('sync/', views.sync_onfleet_status, name='sync-onfleet'),
    path('tasks/', views.TaskStatusView.as_view(), name='task-status'),
    path('create-task/', views.create_task_manually, name='create-task'),
    
    # Webhook endpoint (for Onfleet to call)
    path('webhook/', views.OnfleetWebhookView.as_view(), name='onfleet-webhook'),
]
```

# ──── backend/apps/logistics/views.py ────

```python
# apps/logistics/views.py
from rest_framework import status
from rest_framework.decorators import api_view, permission_classes
from rest_framework.response import Response
from rest_framework.views import APIView
from django.utils import timezone
from django.views.decorators.csrf import csrf_exempt
from django.utils.decorators import method_decorator
from django.http import HttpResponse
import hmac
import hashlib
import logging
from django.conf import settings as django_settings

from .services import ToteTaxiOnfleetIntegration
from .models import OnfleetTask
from apps.accounts.permissions import IsStaffMember

logger = logging.getLogger(__name__)


class LogisticsSummaryView(APIView):
    """Simple logistics overview for staff dashboard"""
    permission_classes = [IsStaffMember]

    def get(self, request):
        try:
            integration = ToteTaxiOnfleetIntegration()
            summary = integration.get_dashboard_summary()
            
            return Response({
                'success': True,
                'data': summary,
                'timestamp': timezone.now()
            })
            
        except Exception as e:
            logger.error(f"Error in logistics summary: {e}")
            return Response({
                'error': 'Failed to fetch logistics data',
            }, status=500)


@api_view(['POST'])
@permission_classes([IsStaffMember])
def sync_onfleet_status(request):
    """Manual sync button for staff dashboard.

    TODO: Fetch real-time status from Onfleet API for each task.
    Currently a stub — updates last_synced timestamp only.
    """
    from datetime import timedelta as _td

    try:
        recent_tasks = OnfleetTask.objects.filter(
            status__in=['created', 'assigned', 'active'],
            created_at__gte=timezone.now() - _td(days=7),
        )

        synced_count = 0
        for task in recent_tasks:
            task.last_synced = timezone.now()
            task.save()
            synced_count += 1

        return Response({
            'success': True,
            'message': f'Synced {synced_count} tasks (timestamps only — real sync not yet implemented)',
            'synced_count': synced_count,
            'timestamp': timezone.now(),
        })

    except Exception as e:
        logger.error(f"Sync error: {e}")
        return Response({
            'error': 'Sync failed'
        }, status=500)


@api_view(['POST'])
@permission_classes([IsStaffMember])
def create_task_manually(request):
    """Manually create Onfleet task for a booking"""
    booking_id = request.data.get('booking_id')
    if not booking_id:
        return Response({'error': 'booking_id required'}, status=400)
    
    try:
        from apps.bookings.models import Booking
        booking = Booking.objects.get(id=booking_id, deleted_at__isnull=True)
        
        integration = ToteTaxiOnfleetIntegration()
        pickup, dropoff = integration.create_tasks_for_booking(booking)
        
        if pickup and dropoff:
            return Response({
                'success': True,
                'message': f'Created Onfleet tasks for {booking.booking_number}',
                'pickup_task': {
                    'id': str(pickup.id),
                    'onfleet_task_id': pickup.onfleet_task_id,
                    'tracking_url': pickup.tracking_url,
                },
                'dropoff_task': {
                    'id': str(dropoff.id),
                    'onfleet_task_id': dropoff.onfleet_task_id,
                    'tracking_url': dropoff.tracking_url,
                }
            })
        else:
            return Response({
                'error': 'Failed to create Onfleet tasks'
            }, status=500)
            
    except Exception as e:
        logger.error(f"Manual task creation error: {e}")
        return Response({
            'error': 'Task creation failed'
        }, status=500)


@method_decorator(csrf_exempt, name='dispatch')
class OnfleetWebhookView(APIView):
    """
    Handle Onfleet webhook notifications
    
    Onfleet webhook flow:
    1. Verification: GET /webhook?check=value → respond with value (plain text)
    2. Events: POST /webhook with JSON payload → process and return 200 OK
    """
    permission_classes = []  # Webhooks don't use session auth
    authentication_classes = []  # No authentication required
    
    def get(self, request):
        """
        Handle Onfleet's webhook verification (sent as GET request)
        Onfleet sends: GET /webhook/?check=some-random-value
        We respond with: 200 OK, plain text "some-random-value"
        """
        check_value = request.query_params.get('check') or request.GET.get('check')
        
        if not check_value:
            logger.warning("Webhook verification failed: no check parameter")
            return Response({'error': 'Missing check parameter'}, status=400)
        
        logger.info(f"✅ Onfleet webhook verification successful: {check_value}")
        return HttpResponse(check_value, content_type='text/plain', status=200)
    
    def _verify_signature(self, request):
        """Verify Onfleet HMAC-SHA512 webhook signature."""
        secret = getattr(django_settings, 'ONFLEET_WEBHOOK_SECRET', '')
        if not secret:
            logger.error("ONFLEET_WEBHOOK_SECRET not configured")
            return False

        signature = request.META.get('HTTP_X_ONFLEET_SIGNATURE', '')
        if not signature:
            logger.warning("Onfleet webhook missing X-Onfleet-Signature header")
            return False

        expected = hmac.new(
            secret.encode('utf-8'),
            request.body,
            hashlib.sha512,
        ).hexdigest()

        return hmac.compare_digest(signature, expected)

    def post(self, request):
        """
        Handle actual webhook events from Onfleet

        ✅ CRITICAL: Always return 200 OK for webhook processing
        Even if processing fails, return 200 to prevent Onfleet retries
        """
        # ========== C3: Verify webhook signature ==========
        if not self._verify_signature(request):
            return Response(
                {'error': 'Invalid webhook signature'},
                status=status.HTTP_401_UNAUTHORIZED,
            )

        try:
            webhook_data = request.data
            trigger_id = webhook_data.get('triggerId')
            task_id = webhook_data.get('taskId')
            
            logger.info(f"📨 Onfleet webhook received - Trigger: {trigger_id}, Task: {task_id}")
            
            # Process the webhook
            integration = ToteTaxiOnfleetIntegration()
            success = integration.handle_webhook(webhook_data)
            
            # ✅ FIX: Always return 200 OK, regardless of processing result
            # This prevents Onfleet from retrying failed webhooks
            response_data = {
                'success': success,
                'trigger_id': trigger_id,
                'task_id': task_id,
                'timestamp': timezone.now(),
                'message': 'Webhook processed successfully' if success else 'Webhook processing failed but acknowledged'
            }
            
            if success:
                logger.info(f"✅ Webhook processed successfully - Trigger: {trigger_id}")
            else:
                logger.warning(f"⚠️  Webhook processing failed but acknowledged - Trigger: {trigger_id}")
            
            return Response(response_data, status=200)  # ✅ Always 200
                
        except Exception as e:
            logger.error(f"❌ Webhook error: {e}", exc_info=True)
            
            # ✅ Even on exception, return 200 to prevent retries
            return Response({
                'success': False,
                'error': 'Webhook processing failed',
                'timestamp': timezone.now()
            }, status=200)  # ✅ Still 200, not 500


class TaskStatusView(APIView):
    """Get status of Onfleet tasks"""
    permission_classes = [IsStaffMember]

    def get(self, request):
        # Get query params
        booking_id = request.query_params.get('booking_id')
        date_filter = request.query_params.get('date')
        
        try:
            tasks = OnfleetTask.objects.all()
            
            if booking_id:
                tasks = tasks.filter(booking_id=booking_id)
            
            if date_filter:
                tasks = tasks.filter(created_at__date=date_filter)
            
            tasks = tasks.select_related('booking').order_by('-created_at')[:50]
            
            task_data = []
            for task in tasks:
                task_data.append({
                    'id': str(task.id),
                    'booking_number': task.booking.booking_number,
                    'customer_name': task.booking.get_customer_name(),
                    'task_type': task.task_type,
                    'onfleet_task_id': task.onfleet_task_id,
                    'onfleet_short_id': task.onfleet_short_id,
                    'tracking_url': task.tracking_url,
                    'recipient_name': task.recipient_name,
                    'recipient_phone': task.recipient_phone,
                    'status': task.status,
                    'worker_name': task.worker_name,
                    'environment': task.environment,
                    'created_at': task.created_at,
                    'last_synced': task.last_synced,
                    'linked_to': str(task.linked_task.id) if task.linked_task else None
                })
            
            return Response({
                'success': True,
                'tasks': task_data,
                'count': len(task_data)
            })
            
        except Exception as e:
            logger.error(f"Error fetching tasks: {e}")
            return Response({
                'error': 'Failed to fetch tasks',
            }, status=500)
```

# ──── backend/apps/payments/admin.py ────

```python
from django.contrib import admin
from django.utils.html import format_html
from .models import Payment, Refund, PaymentAudit

@admin.register(Payment)
class PaymentAdmin(admin.ModelAdmin):
    list_display = (
        'booking', 
        'get_customer_name', 
        'amount_dollars', 
        'status', 
        'get_status_badge',
        'created_at',
        'processed_at'
    )
    list_filter = ('status', 'created_at', 'processed_at')
    search_fields = (
        'booking__booking_number', 
        'customer__email', 
        'stripe_payment_intent_id',
        'stripe_charge_id'
    )
    readonly_fields = ('created_at', 'updated_at', 'processed_at')
    
    fieldsets = (
        ('Booking & Customer', {
            'fields': ('booking', 'customer')
        }),
        ('Payment Details', {
            'fields': ('amount_cents', 'status', 'failure_reason')
        }),
        ('Stripe Integration', {
            'fields': ('stripe_payment_intent_id', 'stripe_charge_id')
        }),
        ('Timestamps', {
            'fields': ('processed_at', 'created_at', 'updated_at'),
            'classes': ('collapse',)
        })
    )
    
    def get_customer_name(self, obj):
        if obj.customer:
            return obj.customer.full_name
        else:
            return obj.booking.get_customer_name()
    get_customer_name.short_description = 'Customer'
    
    def get_status_badge(self, obj):
        colors = {
            'pending': 'orange',
            'succeeded': 'green',
            'failed': 'red',
            'refunded': 'blue'
        }
        color = colors.get(obj.status, 'gray')
        return format_html(
            '<span style="color: {}; font-weight: bold;">{}</span>',
            color,
            obj.get_status_display()
        )
    get_status_badge.short_description = 'Status'

@admin.register(Refund)
class RefundAdmin(admin.ModelAdmin):
    list_display = (
        'payment',
        'get_booking_number',
        'amount_dollars',
        'status',
        'get_status_badge',
        'requested_by',
        'approved_by',
        'created_at'
    )
    list_filter = ('status', 'created_at', 'approved_at')
    search_fields = (
        'payment__booking__booking_number',
        'reason',
        'requested_by__email',
        'approved_by__email'
    )
    readonly_fields = ('created_at', 'approved_at', 'completed_at')
    
    fieldsets = (
        ('Refund Details', {
            'fields': ('payment', 'amount_cents', 'reason')
        }),
        ('Approval Workflow', {
            'fields': ('status', 'requested_by', 'approved_by')
        }),
        ('Stripe Integration', {
            'fields': ('stripe_refund_id',)
        }),
        ('Timestamps', {
            'fields': ('approved_at', 'completed_at', 'created_at'),
            'classes': ('collapse',)
        })
    )
    
    actions = ['approve_refunds', 'deny_refunds']
    
    def get_booking_number(self, obj):
        return obj.payment.booking.booking_number
    get_booking_number.short_description = 'Booking #'
    
    def get_status_badge(self, obj):
        colors = {
            'requested': 'orange',
            'approved': 'green',
            'denied': 'red',
            'completed': 'blue'
        }
        color = colors.get(obj.status, 'gray')
        return format_html(
            '<span style="color: {}; font-weight: bold;">{}</span>',
            color,
            obj.get_status_display()
        )
    get_status_badge.short_description = 'Status'
    
    def approve_refunds(self, request, queryset):
        """Bulk approve refunds (only if user is admin)"""
        if not request.user.can_approve_refunds:
            self.message_user(request, 'Only admin users can approve refunds.', level='ERROR')
            return
        
        approved_count = 0
        for refund in queryset.filter(status='requested'):
            try:
                refund.approve(request.user)
                approved_count += 1
            except ValueError as e:
                self.message_user(request, str(e), level='ERROR')
        
        if approved_count > 0:
            self.message_user(
                request, 
                f'Successfully approved {approved_count} refund(s).'
            )
    approve_refunds.short_description = "Approve selected refunds"
    
    def deny_refunds(self, request, queryset):
        """Bulk deny refunds"""
        if not request.user.can_approve_refunds:
            self.message_user(request, 'Only admin users can deny refunds.', level='ERROR')
            return
        
        denied_count = queryset.filter(status='requested').update(status='denied')
        self.message_user(
            request, 
            f'Successfully denied {denied_count} refund(s).'
        )
    deny_refunds.short_description = "Deny selected refunds"

@admin.register(PaymentAudit)
class PaymentAuditAdmin(admin.ModelAdmin):
    list_display = ('action', 'get_short_description', 'user', 'created_at')
    list_filter = ('action', 'created_at')
    search_fields = ('description', 'user__email')
    readonly_fields = ('created_at',)
    
    fieldsets = (
        ('Action Details', {
            'fields': ('action', 'description')
        }),
        ('Related Records', {
            'fields': ('payment', 'refund')
        }),
        ('User & Timestamp', {
            'fields': ('user', 'created_at')
        })
    )
    
    def get_short_description(self, obj):
        return obj.description[:50] + ('...' if len(obj.description) > 50 else '')
    get_short_description.short_description = 'Description'
    
    # Make it mostly read-only (audit logs shouldn't be edited)
    def has_add_permission(self, request):
        return False
    
    def has_change_permission(self, request, obj=None):
        return False
    
    def has_delete_permission(self, request, obj=None):
        return request.user.is_superuser  # Only superusers can delete audit logs
```

# ──── backend/apps/payments/apps.py ────

```python
from django.apps import AppConfig


class PaymentsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'apps.payments'
```

# ──── backend/apps/payments/models.py ────

```python
# backend/apps/payments/models.py
import uuid
from django.db import models
from django.utils import timezone
from django.contrib.auth.models import User


class Payment(models.Model):
    """Payment records for bookings - simple Stripe integration"""
    
    STATUS_CHOICES = [
        ('pending', 'Pending'),
        ('succeeded', 'Succeeded'),
        ('failed', 'Failed'),
        ('refunded', 'Refunded'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Link to booking
    booking = models.ForeignKey(
        'bookings.Booking',
        on_delete=models.PROTECT,
        related_name='payments'
    )
    
    # Customer (if authenticated)
    customer = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True,
        blank=True,
        related_name='payments'
    )
    
    # Payment amount
    amount_cents = models.PositiveBigIntegerField()
    
    # Stripe integration
    stripe_payment_intent_id = models.CharField(max_length=200, blank=True)
    stripe_charge_id = models.CharField(max_length=200, blank=True)
    
    # Status
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='pending')
    failure_reason = models.TextField(blank=True)
    
    # Timestamps
    processed_at = models.DateTimeField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'payments_payment'
        # ✅ OPTIMIZED: Added indexes for critical queries
        indexes = [
            models.Index(fields=['stripe_payment_intent_id'], name='payments_stripe_intent_idx'),  # Webhook lookups
            models.Index(fields=['booking'], name='payments_booking_idx'),  # Booking detail views
            models.Index(fields=['customer', 'created_at'], name='payments_customer_created_idx'),  # Customer dashboard
            models.Index(fields=['status'], name='payments_status_idx'),  # Admin filtering
            models.Index(fields=['created_at'], name='payments_created_idx'),  # Ordering
        ]
    
    def __str__(self):
        return f"{self.booking.booking_number} - ${self.amount_dollars} ({self.status})"
    
    @property
    def amount_dollars(self):
        return self.amount_cents / 100


class Refund(models.Model):
    """Refund requests with simple approval workflow"""
    
    STATUS_CHOICES = [
        ('requested', 'Requested'),
        ('approved', 'Approved'),
        ('denied', 'Denied'),
        ('completed', 'Completed'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Original payment
    payment = models.ForeignKey(
        Payment,
        on_delete=models.PROTECT,
        related_name='refunds'
    )
    
    # Refund details
    amount_cents = models.PositiveBigIntegerField()
    reason = models.TextField()
    
    # Approval workflow
    requested_by = models.ForeignKey(
        User,
        on_delete=models.PROTECT,
        related_name='requested_refunds'
    )
    approved_by = models.ForeignKey(
        User,
        on_delete=models.PROTECT,
        null=True,
        blank=True,
        related_name='approved_refunds'
    )
    
    # Status and Stripe
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='requested')
    stripe_refund_id = models.CharField(max_length=200, blank=True)
    
    # Timestamps
    approved_at = models.DateTimeField(null=True, blank=True)
    completed_at = models.DateTimeField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'payments_refund'
        # ✅ OPTIMIZED: Added indexes for refund queries
        indexes = [
            models.Index(fields=['payment'], name='refunds_payment_idx'),
            models.Index(fields=['status'], name='refunds_status_idx'),
            models.Index(fields=['created_at'], name='refunds_created_idx'),
        ]
    
    def __str__(self):
        return f"Refund ${self.amount_dollars} for {self.payment.booking.booking_number}"
    
    @property
    def amount_dollars(self):
        return self.amount_cents / 100
    
    def approve(self, admin_user):
        """Admin approves refund"""
        self.status = 'approved'
        self.approved_by = admin_user
        self.approved_at = timezone.now()
        self.save()


class PaymentAudit(models.Model):
    """Basic audit log for financial compliance"""
    
    ACTION_CHOICES = [
        ('payment_created', 'Payment Created'),
        ('payment_succeeded', 'Payment Succeeded'),
        ('payment_failed', 'Payment Failed'),
        ('refund_requested', 'Refund Requested'),
        ('refund_approved', 'Refund Approved'),
        ('refund_completed', 'Refund Completed'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # What happened
    action = models.CharField(max_length=30, choices=ACTION_CHOICES)
    description = models.TextField()
    
    # Related records
    payment = models.ForeignKey(Payment, on_delete=models.CASCADE, null=True, blank=True)
    refund = models.ForeignKey(Refund, on_delete=models.CASCADE, null=True, blank=True)
    
    # Who did it (staff user)
    user = models.ForeignKey(
        User,
        on_delete=models.SET_NULL,
        null=True,
        blank=True
    )
    
    created_at = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        db_table = 'payments_audit'
        ordering = ['-created_at']
        # ✅ OPTIMIZED: Added indexes for audit queries
        indexes = [
            models.Index(fields=['payment'], name='audit_payment_idx'),
            models.Index(fields=['action'], name='audit_action_idx'),
            models.Index(fields=['created_at'], name='audit_created_idx'),
        ]
    
    def __str__(self):
        return f"{self.action} - {self.created_at}"
    
    @classmethod
    def log(cls, action, description, payment=None, refund=None, user=None):
        """Simple audit logging"""
        return cls.objects.create(
            action=action,
            description=description,
            payment=payment,
            refund=refund,
            user=user
        )
```

# ──── backend/apps/payments/serializers.py ────

```python
from rest_framework import serializers
from django.db import models as db_models
from .models import Payment, Refund
from apps.bookings.models import Booking


class PaymentIntentCreateSerializer(serializers.Serializer):
    """Serializer for creating payment intent"""
    booking_id = serializers.UUIDField()
    customer_email = serializers.EmailField(required=False)
    
    def validate_booking_id(self, value):
        try:
            booking = Booking.objects.get(id=value, deleted_at__isnull=True)
            if booking.status in ['paid', 'completed']:
                raise serializers.ValidationError("Booking is already paid")
            return value
        except Booking.DoesNotExist:
            raise serializers.ValidationError("Booking not found")


class PaymentSerializer(serializers.ModelSerializer):
    amount_dollars = serializers.ReadOnlyField()
    booking_number = serializers.SerializerMethodField()
    customer_name = serializers.SerializerMethodField()
    total_refunded_cents = serializers.SerializerMethodField()
    total_refunded_dollars = serializers.SerializerMethodField()

    class Meta:
        model = Payment
        fields = (
            'id', 'booking_number', 'customer_name', 'amount_cents',
            'amount_dollars', 'status', 'stripe_payment_intent_id',
            'stripe_charge_id', 'failure_reason', 'processed_at', 'created_at',
            'total_refunded_cents', 'total_refunded_dollars',
        )
        read_only_fields = ('id', 'created_at')

    def get_booking_number(self, obj):
        return obj.booking.booking_number

    def get_customer_name(self, obj):
        return obj.booking.get_customer_name()

    def get_total_refunded_cents(self, obj):
        return obj.refunds.filter(status='completed').aggregate(
            total=db_models.Sum('amount_cents')
        )['total'] or 0

    def get_total_refunded_dollars(self, obj):
        return self.get_total_refunded_cents(obj) / 100


class PaymentConfirmSerializer(serializers.Serializer):
    """Serializer for payment confirmation webhook"""
    payment_intent_id = serializers.CharField()
    status = serializers.ChoiceField(choices=['succeeded', 'failed'])
    failure_reason = serializers.CharField(required=False, allow_blank=True)


class RefundCreateSerializer(serializers.Serializer):
    """Serializer for creating refunds"""
    payment_id = serializers.UUIDField()
    amount_cents = serializers.IntegerField(min_value=1)
    reason = serializers.CharField(max_length=500)
    
    def validate_payment_id(self, value):
        try:
            payment = Payment.objects.get(id=value, status='succeeded')
            return value
        except Payment.DoesNotExist:
            raise serializers.ValidationError("Payment not found or not succeeded")
    
    def validate(self, attrs):
        try:
            payment = Payment.objects.get(id=attrs['payment_id'])
            if attrs['amount_cents'] > payment.amount_cents:
                raise serializers.ValidationError("Refund amount cannot exceed payment amount")
        except Payment.DoesNotExist:
            pass  # Already handled in validate_payment_id
        return attrs


class RefundSerializer(serializers.ModelSerializer):
    amount_dollars = serializers.ReadOnlyField()
    payment_booking_number = serializers.SerializerMethodField()
    requested_by_name = serializers.SerializerMethodField()
    approved_by_name = serializers.SerializerMethodField()
    
    class Meta:
        model = Refund
        fields = (
            'id', 'payment_booking_number', 'amount_cents', 'amount_dollars',
            'reason', 'status', 'requested_by_name', 'approved_by_name',
            'approved_at', 'completed_at', 'created_at'
        )
        read_only_fields = ('id', 'created_at')
    
    def get_payment_booking_number(self, obj):
        return obj.payment.booking.booking_number
    
    def get_requested_by_name(self, obj):
        return obj.requested_by.get_full_name() if obj.requested_by else None
    
    def get_approved_by_name(self, obj):
        return obj.approved_by.get_full_name() if obj.approved_by else None
```

# ──── backend/apps/payments/services.py ────

```python
# backend/apps/payments/services.py
import stripe
import logging
from django.conf import settings
from django.utils import timezone
from decimal import Decimal

from .models import Payment, PaymentAudit
from apps.bookings.models import Booking

logger = logging.getLogger(__name__)

stripe.api_key = settings.STRIPE_SECRET_KEY


class StripePaymentService:
    """Service layer for Stripe payment processing"""
    
    @staticmethod
    def create_payment_intent(booking, customer_email=None):
        """Create Stripe PaymentIntent for a booking"""
        try:
            intent = stripe.PaymentIntent.create(
                amount=int(booking.total_price_cents),
                currency='usd',
                metadata={
                    'booking_id': str(booking.id),
                    'booking_number': booking.booking_number,
                },
                receipt_email=customer_email or (booking.customer.email if hasattr(booking, 'customer') and booking.customer else None),
            )
            
            payment = Payment.objects.create(
                booking=booking,
                customer=booking.customer if hasattr(booking, 'customer') and booking.customer else None,
                amount_cents=booking.total_price_cents,
                stripe_payment_intent_id=intent.id,
                status='pending'
            )
            
            PaymentAudit.log(
                action='payment_created',
                description=f'PaymentIntent created for booking {booking.booking_number}',
                payment=payment,
                user=None
            )
            
            return {
                'payment': payment,
                'client_secret': intent.client_secret,
                'payment_intent_id': intent.id
            }
            
        except stripe.error.StripeError as e:
            raise Exception(f"Stripe error: {str(e)}")
        except Exception as e:
            raise Exception(f"Failed to create PaymentIntent: {str(e)}")
    
    @staticmethod
    def confirm_payment(payment_intent_id):
        """Verify payment with Stripe and update records - CRITICAL: Updates customer stats"""
        try:
            intent = stripe.PaymentIntent.retrieve(payment_intent_id)
            
            payment = Payment.objects.get(stripe_payment_intent_id=payment_intent_id)
            
            if intent.status == 'succeeded':
                payment.status = 'succeeded'
                payment.stripe_charge_id = intent.latest_charge if hasattr(intent, 'latest_charge') else ''
                payment.processed_at = timezone.now()
                payment.save()
                
                booking = payment.booking
                if booking.status == 'pending':
                    booking.status = 'paid'
                    booking.save(_skip_pricing=True)
                
                try:
                    if booking.customer and hasattr(booking.customer, 'customer_profile'):
                        booking.customer.customer_profile.add_booking_stats(
                            booking.total_price_cents
                        )
                        logger.info(f"Updated customer stats: {booking.customer.get_full_name()} - +${booking.total_price_dollars}")
                except Exception as stats_error:
                    logger.warning(f"Failed to update customer stats: {stats_error}")
                
                PaymentAudit.log(
                    action='payment_succeeded',
                    description=f'Payment confirmed for booking {booking.booking_number}',
                    payment=payment,
                    user=None
                )
                
                return payment
            else:
                payment.status = 'failed'
                payment.failure_reason = f"Payment status: {intent.status}"
                payment.save()
                raise Exception(f"Payment not successful: {intent.status}")
            
        except Payment.DoesNotExist:
            raise Exception("Payment not found")
        except stripe.error.StripeError as e:
            raise Exception(f"Stripe error: {str(e)}")
    
    @staticmethod
    def create_refund(payment, amount_cents, reason, requested_by_user):
        """Create refund for a payment"""
        from .models import Refund
        
        try:
            refund = stripe.Refund.create(
                payment_intent=payment.stripe_payment_intent_id,
                amount=amount_cents,
                reason='requested_by_customer',
            )
            
            refund_record = Refund.objects.create(
                payment=payment,
                amount_cents=amount_cents,
                reason=reason,
                requested_by=requested_by_user,
                stripe_refund_id=refund.id,
                status='completed'
            )
            
            payment.status = 'refunded'
            payment.save()
            
            PaymentAudit.log(
                action='refund_completed',
                description=f'Refund completed for payment {payment.id}',
                payment=payment,
                refund=refund_record,
                user=requested_by_user
            )
            
            return refund_record
            
        except stripe.error.StripeError as e:
            raise Exception(f"Stripe refund error: {str(e)}")
```

# ──── backend/apps/payments/tasks.py ────

```python
import logging
from celery import shared_task
from django.utils import timezone

logger = logging.getLogger(__name__)


@shared_task(bind=True, max_retries=5, default_retry_delay=1)
def process_payment_succeeded(self, event_data):
    """Process payment_intent.succeeded webhook event asynchronously.

    Replaces the synchronous time.sleep() retry loop that blocked gunicorn workers.
    Uses Celery's built-in retry with exponential backoff.
    """
    from apps.payments.models import Payment, PaymentAudit
    from apps.accounts.models import StaffProfile, StaffAction
    from apps.payments.views import _get_system_staff_user

    payment_intent = event_data['data']['object']
    payment_intent_id = payment_intent['id']
    event_id = event_data['id']

    try:
        payment = Payment.objects.select_related('booking').get(
            stripe_payment_intent_id=payment_intent_id
        )
    except Payment.DoesNotExist:
        logger.info(
            f"Webhook task: Payment not found for {payment_intent_id}, "
            f"retry {self.request.retries}/{self.max_retries}"
        )
        raise self.retry(countdown=min(2 ** self.request.retries, 30))

    # Skip if already processed
    if payment.status == 'succeeded':
        logger.info(f"Webhook task: Payment {payment.id} already succeeded")
        return {'status': 'already_succeeded'}

    # Update payment status
    payment.status = 'succeeded'
    payment.stripe_charge_id = payment_intent.get('latest_charge', '')
    payment.processed_at = timezone.now()
    payment.save()

    # Update booking status
    booking = payment.booking
    if booking.status == 'pending':
        old_status = booking.status
        booking.status = 'paid'
        booking.save(_skip_pricing=True)

        logger.info(
            f"Webhook task: Booking {booking.booking_number} "
            f"status updated: {old_status} -> {booking.status}"
        )

        StaffAction.objects.create(
            staff_user=_get_system_staff_user(),
            action_type='modify_booking',
            description=(
                f"Booking {booking.booking_number} automatically confirmed via Stripe webhook. "
                f"Payment: ${payment.amount_dollars:.2f}"
            ),
            ip_address='127.0.0.1',
            user_agent='Stripe Webhook',
            booking_id=booking.id,
        )

    PaymentAudit.log(
        action='payment_succeeded',
        description=(
            f"Payment succeeded for booking {booking.booking_number} "
            f"via Stripe webhook (Event: {event_id})"
        ),
        payment=payment,
        user=None,
    )

    logger.info(
        f"Webhook task: Successfully processed payment for "
        f"booking {booking.booking_number}"
    )

    return {'status': 'success', 'booking_number': booking.booking_number}


@shared_task(bind=True, max_retries=5, default_retry_delay=1)
def process_payment_failed(self, event_data):
    """Process payment_intent.payment_failed webhook event asynchronously."""
    from apps.payments.models import Payment, PaymentAudit

    payment_intent = event_data['data']['object']
    payment_intent_id = payment_intent['id']

    try:
        payment = Payment.objects.select_related('booking').get(
            stripe_payment_intent_id=payment_intent_id
        )
    except Payment.DoesNotExist:
        logger.info(
            f"Webhook task: Payment not found for failed {payment_intent_id}, "
            f"retry {self.request.retries}/{self.max_retries}"
        )
        raise self.retry(countdown=min(2 ** self.request.retries, 30))

    # Update payment to failed
    payment.status = 'failed'
    payment.failure_reason = payment_intent.get(
        'last_payment_error', {}
    ).get('message', 'Payment failed')
    payment.save()

    # Keep booking as pending so customer can retry
    booking = payment.booking
    if booking.status != 'pending':
        booking.status = 'pending'
        booking.save(_skip_pricing=True)

    PaymentAudit.log(
        action='payment_failed',
        description=(
            f"Payment failed for booking {booking.booking_number}. "
            f"Reason: {payment.failure_reason}"
        ),
        payment=payment,
        user=None,
    )

    logger.warning(
        f"Webhook task: Payment failed for booking {booking.booking_number}. "
        f"Reason: {payment.failure_reason}"
    )

    return {'status': 'payment_failed', 'booking_number': booking.booking_number}
```

# ──── backend/apps/payments/urls.py ────

```python
# backend/apps/payments/urls.py
from django.urls import path
from django.conf import settings
from . import views

urlpatterns = [
    # Public payment endpoints
    path('create-intent/', views.PaymentIntentCreateView.as_view(), name='payment-intent-create'),
    path('status/<str:booking_lookup>/', views.PaymentStatusView.as_view(), name='payment-status'),
    path('webhook/', views.StripeWebhookView.as_view(), name='stripe-webhook'),
    path('confirm/', views.PaymentConfirmView.as_view(), name='payment-confirm'),
    
    # Staff endpoints
    path('payments/', views.PaymentListView.as_view(), name='payment-list'),
    path('refunds/', views.RefundListView.as_view(), name='refund-list'),
    path('refunds/create/', views.RefundCreateView.as_view(), name='refund-create'),
    path('refunds/process/', views.RefundProcessView.as_view(), name='refund-process'),
]

# Mock endpoints (only available in DEBUG mode)
if settings.DEBUG:
    urlpatterns.append(
        path('mock-confirm/', views.MockPaymentConfirmView.as_view(), name='mock-payment-confirm')
    )
```

# ──── backend/apps/payments/views.py ────

```python
# backend/apps/payments/views.py
import stripe
import logging
from rest_framework import generics, status, permissions
from rest_framework.decorators import api_view, permission_classes
from rest_framework.response import Response
from rest_framework.views import APIView
from django.shortcuts import get_object_or_404
from django.views.decorators.csrf import csrf_exempt
from django.utils.decorators import method_decorator
from django.http import HttpResponse
from django.conf import settings
from django.core.cache import cache
from django.db import transaction, models
from django.contrib.auth import get_user_model

from django_ratelimit.decorators import ratelimit

from .models import Payment, Refund
from .serializers import (
    PaymentIntentCreateSerializer,
    PaymentSerializer,
    PaymentConfirmSerializer,
    RefundCreateSerializer,
    RefundSerializer
)
from .services import StripePaymentService
from apps.bookings.models import Booking
from apps.accounts.models import StaffProfile
from apps.accounts.permissions import IsStaffMember

logger = logging.getLogger(__name__)


def _get_system_staff_user():
    """
    Ensure we have a system staff user for webhook-originated actions.
    Prevents IntegrityError when StaffAction.staff_user is NOT NULL.
    """
    User = get_user_model()
    user, _ = User.objects.get_or_create(
        username='system_webhook',
        defaults={'email': 'system@totetaxi.com', 'is_active': True}
    )
    StaffProfile.objects.get_or_create(
        user=user,
        defaults={'role': 'staff', 'phone': '0000000000'}
    )
    return user


@method_decorator(ratelimit(key='ip', rate='10/h', method='POST', block=True), name='post')
class PaymentIntentCreateView(APIView):
    """Create Stripe PaymentIntent for a booking - no authentication required for guest bookings"""
    permission_classes = [permissions.AllowAny]

    def post(self, request):
        serializer = PaymentIntentCreateSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        booking_id = serializer.validated_data['booking_id']
        customer_email = serializer.validated_data.get('customer_email')
        
        try:
            booking = Booking.objects.get(id=booking_id, deleted_at__isnull=True)
            
            # Check if payment already exists
            existing_payment = Payment.objects.filter(booking=booking).first()
            if existing_payment and existing_payment.status == 'succeeded':
                return Response(
                    {'error': 'Booking is already paid'}, 
                    status=status.HTTP_400_BAD_REQUEST
                )
            
            # Create PaymentIntent
            payment_data = StripePaymentService.create_payment_intent(
                booking=booking,
                customer_email=customer_email
            )
            
            return Response({
                'payment_intent_id': payment_data['payment_intent_id'],
                'client_secret': payment_data['client_secret'],
                'amount_cents': booking.total_price_cents,
                'amount_dollars': booking.total_price_dollars,
                'booking_number': booking.booking_number
            })
            
        except Booking.DoesNotExist:
            return Response(
                {'error': 'Booking not found'}, 
                status=status.HTTP_404_NOT_FOUND
            )
        except Exception as e:
            logger.error(f"Error creating payment intent: {str(e)}", exc_info=True)
            return Response(
                {'error': 'Failed to create payment intent'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )


class PaymentStatusView(APIView):
    """Check payment status by booking UUID — non-guessable, minimal data."""
    permission_classes = [permissions.AllowAny]

    def get(self, request, booking_lookup):
        import uuid as _uuid
        try:
            booking_uuid = _uuid.UUID(str(booking_lookup))
        except ValueError:
            return Response(
                {'error': 'Booking not found'},
                status=status.HTTP_404_NOT_FOUND,
            )

        try:
            booking = Booking.objects.get(id=booking_uuid, deleted_at__isnull=True)
            payment = Payment.objects.filter(booking=booking).first()

            if not payment:
                return Response({
                    'payment_status': 'not_created',
                    'booking_status': booking.status,
                })

            return Response({
                'payment_status': payment.status,
                'booking_status': booking.status,
            })

        except Booking.DoesNotExist:
            return Response(
                {'error': 'Booking not found'},
                status=status.HTTP_404_NOT_FOUND,
            )


@method_decorator(csrf_exempt, name='dispatch')
class StripeWebhookView(APIView):
    """
    Production webhook handler for Stripe events
    - Verifies webhook signatures
    - Handles payment_intent.succeeded and payment_intent.payment_failed
    - Idempotent (won't process same event twice)
    - Comprehensive logging and audit trail
    """
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        payload = request.body
        sig_header = request.META.get('HTTP_STRIPE_SIGNATURE')
        
        # Verify webhook signature
        try:
            event = stripe.Webhook.construct_event(
                payload, 
                sig_header, 
                settings.STRIPE_WEBHOOK_SECRET
            )
        except ValueError:
            logger.error("Webhook: Invalid payload")
            return Response(
                {'error': 'Invalid payload'}, 
                status=status.HTTP_400_BAD_REQUEST
            )
        except stripe.error.SignatureVerificationError:
            logger.error("Webhook: Invalid signature")
            return Response(
                {'error': 'Invalid signature'}, 
                status=status.HTTP_400_BAD_REQUEST
            )
        
        # Extract event data
        event_id = event['id']
        event_type = event['type']
        
        # Idempotency check - prevent processing same event twice
        cache_key = f'stripe_event_{event_id}'
        if cache.get(cache_key):
            logger.info(f"Webhook: Event {event_id} already processed, skipping")
            return Response({'status': 'already_processed'}, status=status.HTTP_200_OK)
        
        # Mark event as processed (cache for 72 hours to match Stripe's retry window)
        cache.set(cache_key, True, timeout=259200)
        
        logger.info(f"Webhook: Processing event {event_id} of type {event_type}")
        
        # Handle different event types
        if event_type == 'payment_intent.succeeded':
            return self._handle_payment_succeeded(event)
        elif event_type == 'payment_intent.payment_failed':
            return self._handle_payment_failed(event)
        else:
            logger.info(f"Webhook: Unhandled event type {event_type}")
            return Response({'status': 'ignored'}, status=status.HTTP_200_OK)
    
    def _handle_payment_succeeded(self, event):
        """Dispatch payment succeeded processing to Celery task.

        The task handles retry logic via Celery's built-in retry mechanism
        instead of blocking the gunicorn worker with time.sleep().
        """
        from apps.payments.tasks import process_payment_succeeded
        try:
            process_payment_succeeded.delay(dict(event))
        except Exception:
            logger.exception("Failed to dispatch payment succeeded task")
        return Response({'status': 'processing'}, status=status.HTTP_200_OK)

    def _handle_payment_failed(self, event):
        """Dispatch payment failed processing to Celery task."""
        from apps.payments.tasks import process_payment_failed
        try:
            process_payment_failed.delay(dict(event))
        except Exception:
            logger.exception("Failed to dispatch payment failed task")
        return Response({'status': 'processing'}, status=status.HTTP_200_OK)


class MockPaymentConfirmView(APIView):
    """Mock payment confirmation for testing - disable in production"""
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        serializer = PaymentConfirmSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)
        
        payment_intent_id = serializer.validated_data['payment_intent_id']
        status_value = serializer.validated_data['status']
        
        try:
            if status_value == 'succeeded':
                # Confirm payment (updates Payment record)
                payment = StripePaymentService.confirm_payment(payment_intent_id)
                
                if payment and payment.booking:
                    # Update booking status from pending to paid
                    if payment.booking.status == 'pending':
                        payment.booking.status = 'paid'
                        payment.booking.save(_skip_pricing=True)
                        logger.info(f"Mock payment: Booking {payment.booking.booking_number} status updated to 'paid'")
                
                return Response({
                    'message': 'Payment confirmed successfully',
                    'payment': PaymentSerializer(payment).data,
                    'booking_status': payment.booking.status if payment else 'unknown'
                })
            else:
                # Handle failed payment
                payment = Payment.objects.get(stripe_payment_intent_id=payment_intent_id)
                payment.status = 'failed'
                payment.failure_reason = serializer.validated_data.get('failure_reason', 'Payment failed')
                payment.save()
                
                # Keep booking as pending for failed payments
                payment.booking.status = 'pending'
                payment.booking.save(_skip_pricing=True)
                
                return Response({
                    'message': 'Payment marked as failed',
                    'payment': PaymentSerializer(payment).data,
                    'booking_status': payment.booking.status
                })
                
        except Payment.DoesNotExist:
            return Response(
                {'error': 'Payment not found'}, 
                status=status.HTTP_404_NOT_FOUND
            )
        except Exception as e:
            logger.error(f"Mock payment error: {str(e)}", exc_info=True)
            return Response(
                {'error': 'Payment processing failed'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )


class PaymentConfirmView(APIView):
    """Confirm payment after Stripe processes it - called from frontend"""
    permission_classes = [permissions.AllowAny]
    
    def post(self, request):
        payment_intent_id = request.data.get('payment_intent_id')
        
        if not payment_intent_id:
            return Response(
                {'error': 'payment_intent_id is required'}, 
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            # Service handles payment update, booking status, customer stats
            payment = StripePaymentService.confirm_payment(payment_intent_id)
            
            if not payment:
                return Response(
                    {'error': 'Payment confirmation failed'}, 
                    status=status.HTTP_500_INTERNAL_SERVER_ERROR
                )
            
            return Response({
                'message': 'Payment confirmed successfully',
                'booking_status': payment.booking.status if payment.booking else None,
                'payment_status': payment.status
            })
            
        except Payment.DoesNotExist:
            return Response(
                {'error': 'Payment not found'}, 
                status=status.HTTP_404_NOT_FOUND
            )
        except Exception as e:
            logger.error(f"Payment confirm error: {str(e)}", exc_info=True)
            return Response(
                {'error': 'Payment confirmation failed'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )


# Staff payment management views
class PaymentListView(generics.ListAPIView):
    """List all payments - staff only"""
    serializer_class = PaymentSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        if not hasattr(self.request.user, 'staff_profile'):
            return Payment.objects.none()
        return Payment.objects.select_related(
            'booking', 'booking__customer', 'booking__guest_checkout',
        ).order_by('-created_at')


class RefundListView(generics.ListAPIView):
    """List all refunds - staff only, optionally filter by booking"""
    serializer_class = RefundSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        if not hasattr(self.request.user, 'staff_profile'):
            return Refund.objects.none()
        
        queryset = Refund.objects.select_related(
            'payment__booking', 'requested_by', 'approved_by'
        ).order_by('-created_at')
        
        # Filter by booking if provided
        booking_id = self.request.query_params.get('booking_id')
        if booking_id:
            queryset = queryset.filter(payment__booking__id=booking_id)
        
        # Filter by payment if provided
        payment_id = self.request.query_params.get('payment_id')
        if payment_id:
            queryset = queryset.filter(payment__id=payment_id)
        
        return queryset


class RefundCreateView(generics.CreateAPIView):
    """Create refund request - staff only"""
    serializer_class = RefundCreateSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def perform_create(self, serializer):
        if not hasattr(self.request.user, 'staff_profile'):
            raise permissions.PermissionDenied('Not a staff account')
        
        serializer.save(requested_by=self.request.user)


class RefundProcessView(APIView):
    """Process refund immediately - staff only (direct refund, no approval)"""
    permission_classes = [IsStaffMember]

    def post(self, request):
        # Validate input
        payment_id = request.data.get('payment_id')
        amount_cents = request.data.get('amount_cents')
        reason = request.data.get('reason', 'No reason provided').strip()
        
        if not payment_id or not amount_cents:
            return Response(
                {'error': 'payment_id and amount_cents are required'}, 
                status=status.HTTP_400_BAD_REQUEST
            )
        
        try:
            amount_cents = int(amount_cents)
            if amount_cents <= 0:
                raise ValueError("Amount must be positive")
        except (ValueError, TypeError):
            return Response(
                {'error': 'Invalid amount_cents'}, 
                status=status.HTTP_400_BAD_REQUEST
            )
        
        # REMOVED THE 10 CHARACTER MINIMUM CHECK
        
        try:
            # Get payment
            payment = Payment.objects.select_related('booking').get(id=payment_id)
            
            # Validate payment status
            if payment.status != 'succeeded':
                return Response(
                    {'error': f'Cannot refund payment with status: {payment.status}'}, 
                    status=status.HTTP_400_BAD_REQUEST
                )
            
            # Validate amount
            if amount_cents > payment.amount_cents:
                return Response(
                    {'error': f'Refund amount cannot exceed payment amount (${payment.amount_dollars})'}, 
                    status=status.HTTP_400_BAD_REQUEST
                )
            
            # Check if already refunded
            existing_refunds_total = Refund.objects.filter(
                payment=payment,
                status='completed'
            ).aggregate(total=models.Sum('amount_cents'))['total'] or 0
            
            if existing_refunds_total + amount_cents > payment.amount_cents:
                remaining = payment.amount_cents - existing_refunds_total
                return Response(
                    {'error': f'Only ${remaining/100:.2f} remaining to refund'}, 
                    status=status.HTTP_400_BAD_REQUEST
                )
            
            # Process refund via Stripe
            with transaction.atomic():
                refund = StripePaymentService.create_refund(
                    payment=payment,
                    amount_cents=amount_cents,
                    reason=reason,
                    requested_by_user=request.user
                )
                
                logger.info(
                    f"Refund processed by {request.user.get_full_name()}: "
                    f"${amount_cents/100:.2f} for booking {payment.booking.booking_number}"
                )
            
            # Return success with refund details
            return Response({
                'message': 'Refund processed successfully',
                'refund': RefundSerializer(refund).data
            }, status=status.HTTP_201_CREATED)
            
        except Payment.DoesNotExist:
            return Response(
                {'error': 'Payment not found'}, 
                status=status.HTTP_404_NOT_FOUND
            )
        except Exception as e:
            logger.error(f"Refund processing error: {str(e)}", exc_info=True)
            return Response(
                {'error': 'Refund processing failed'},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )
```

# ──── backend/apps/services/admin.py ────

```python
# backend/apps/services/admin.py
from django.contrib import admin
from django.utils.html import format_html
from .models import (
    MiniMovePackage, 
    OrganizingService,
    StandardDeliveryConfig, 
    SpecialtyItem, 
    SurchargeRule
)


@admin.register(MiniMovePackage)
class MiniMovePackageAdmin(admin.ModelAdmin):
    list_display = ('name', 'package_type', 'base_price_dollars', 'max_items', 'coi_included', 'is_most_popular', 'is_active', 'get_organizing_services')
    list_filter = ('package_type', 'coi_included', 'is_most_popular', 'is_active')
    search_fields = ('name', 'description')
    ordering = ('base_price_cents',)
    
    fieldsets = (
        ('Package Details', {
            'fields': ('package_type', 'name', 'description', 'is_most_popular', 'is_active')
        }),
        ('Pricing', {
            'fields': ('base_price_cents', 'coi_included', 'coi_fee_cents')
        }),
        ('Limits & Features', {
            'fields': ('max_items', 'max_weight_per_item_lbs', 'priority_scheduling', 'protective_wrapping')
        })
    )
    
    def get_organizing_services(self, obj):
        organizing_services = OrganizingService.objects.filter(
            mini_move_tier=obj.package_type,
            is_active=True
        )
        if organizing_services.exists():
            services = []
            for service in organizing_services:
                service_type = "📦 Packing" if service.is_packing_service else "📤 Unpacking"
                services.append(f"{service_type}: ${service.price_dollars}")
            return format_html("<br>".join(services))
        return "❌ No organizing services"
    get_organizing_services.short_description = 'Available Organizing Services'


@admin.register(OrganizingService)
class OrganizingServiceAdmin(admin.ModelAdmin):
    list_display = (
        'name', 
        'get_tier_badge', 
        'get_service_type_badge', 
        'price_dollars', 
        'duration_hours', 
        'organizer_count',
        'supplies_allowance_dollars',
        'is_active'
    )
    list_filter = ('mini_move_tier', 'is_packing_service', 'is_active')
    search_fields = ('name', 'description')
    ordering = ('mini_move_tier', 'is_packing_service', 'price_cents')
    
    fieldsets = (
        ('Service Details', {
            'fields': ('service_type', 'mini_move_tier', 'name', 'description', 'is_active')
        }),
        ('Pricing & Specs', {
            'fields': ('price_cents', 'duration_hours', 'organizer_count')
        }),
        ('Service Classification', {
            'fields': ('is_packing_service', 'supplies_allowance_cents')
        })
    )
    
    readonly_fields = ('service_type',)
    
    def get_tier_badge(self, obj):
        colors = {
            'petite': '#fbbf24',
            'standard': '#3b82f6',
            'full': '#10b981'
        }
        color = colors.get(obj.mini_move_tier, '#6b7280')
        return format_html(
            '<span style="background: {}; color: white; padding: 2px 8px; border-radius: 4px; font-weight: bold;">{}</span>',
            color,
            obj.mini_move_tier.title()
        )
    get_tier_badge.short_description = 'Move Tier'
    
    def get_service_type_badge(self, obj):
        if obj.is_packing_service:
            return format_html(
                '<span style="color: #059669;">📦 Packing</span>'
            )
        else:
            return format_html(
                '<span style="color: #0284c7;">📤 Unpacking</span>'
            )
    get_service_type_badge.short_description = 'Service Type'
    
    def save_model(self, request, obj, form, change):
        service_prefix = f"{obj.mini_move_tier}_"
        service_suffix = "packing" if obj.is_packing_service else "unpacking"
        obj.service_type = service_prefix + service_suffix
        super().save_model(request, obj, form, change)


@admin.register(StandardDeliveryConfig)
class StandardDeliveryConfigAdmin(admin.ModelAdmin):
    list_display = ('price_per_item_dollars', 'minimum_items', 'minimum_charge_dollars', 'same_day_flat_rate_dollars', 'is_active')
    fieldsets = (
        ('Per-Item Pricing', {
            'fields': ('price_per_item_cents', 'minimum_items', 'minimum_charge_cents')
        }),
        ('Same-Day Delivery', {
            'fields': ('same_day_flat_rate_cents',)
        }),
        ('Constraints', {
            'fields': ('max_weight_per_item_lbs', 'is_active')
        })
    )
    
    def same_day_flat_rate_dollars(self, obj):
        return f"${obj.same_day_flat_rate_cents / 100:.0f}"
    same_day_flat_rate_dollars.short_description = 'Same-Day Rate'


# apps/services/admin.py

@admin.register(SpecialtyItem)
class SpecialtyItemAdmin(admin.ModelAdmin):
    list_display = ('name', 'item_type', 'price_dollars', 'special_handling', 'is_active')
    list_filter = ('item_type', 'special_handling', 'is_active')
    search_fields = ('name', 'description')
    
    # ✅ ADD THIS: Bulk actions
    actions = ['mark_as_inactive', 'mark_as_active']
    
    fieldsets = (
        ('Item Details', {
            'fields': ('item_type', 'name', 'description', 'is_active')
        }),
        ('Pricing', {
            'fields': ('price_cents',)
        }),
        ('Requirements', {
            'fields': ('special_handling',)
        })
    )
    
    # ✅ ADD THESE METHODS:
    @admin.action(description='Mark selected items as inactive')
    def mark_as_inactive(self, request, queryset):
        updated = queryset.update(is_active=False)
        self.message_user(request, f'{updated} specialty item(s) marked as inactive.')
    
    @admin.action(description='Mark selected items as active')
    def mark_as_active(self, request, queryset):
        updated = queryset.update(is_active=True)
        self.message_user(request, f'{updated} specialty item(s) marked as active.')
        
@admin.register(SurchargeRule)
class SurchargeRuleAdmin(admin.ModelAdmin):
    list_display = ('name', 'surcharge_type', 'applies_to_service_type', 'calculation_type', 'get_surcharge_display', 'get_applies_to', 'is_active')
    list_filter = ('surcharge_type', 'applies_to_service_type', 'calculation_type', 'is_active', 'applies_saturday', 'applies_sunday')
    search_fields = ('name', 'description')
    
    fieldsets = (
        ('Rule Details', {
            'fields': ('surcharge_type', 'name', 'description', 'applies_to_service_type', 'is_active')
        }),
        ('Calculation', {
            'fields': ('calculation_type', 'percentage', 'fixed_amount_cents')
        }),
        ('Date Rules', {
            'fields': ('specific_date', 'start_date', 'end_date', 'applies_saturday', 'applies_sunday'),
            'description': 'Set specific date OR date range OR weekend days'
        })
    )
    
    def get_surcharge_display(self, obj):
        if obj.calculation_type == 'percentage' and obj.percentage:
            return format_html('<span style="color: #059669; font-weight: bold;">{}%</span>', obj.percentage)
        elif obj.calculation_type == 'fixed_amount' and obj.fixed_amount_cents:
            return format_html('<span style="color: #dc2626; font-weight: bold;">${}</span>', obj.fixed_amount_cents / 100)
        return "❌ Not configured"
    get_surcharge_display.short_description = 'Surcharge Amount'
    
    def get_applies_to(self, obj):
        applies_to = []
        if obj.specific_date:
            applies_to.append(f"📅 {obj.specific_date}")
        if obj.start_date and obj.end_date:
            applies_to.append(f"📆 {obj.start_date} → {obj.end_date}")
        if obj.applies_saturday:
            applies_to.append("🗓️ Saturdays")
        if obj.applies_sunday:
            applies_to.append("🗓️ Sundays")

        if applies_to:
            return format_html("<br>".join(applies_to))
        return "❓ No dates set"
    get_applies_to.short_description = 'Applies To'


admin.site.site_header = "ToteTaxi Admin"
admin.site.site_title = "ToteTaxi Admin Portal"
admin.site.index_title = "Welcome to ToteTaxi Administration"
```

# ──── backend/apps/services/apps.py ────

```python
from django.apps import AppConfig


class ServicesConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'apps.services'
```

# ──── backend/apps/services/models.py ────

```python
# backend/apps/services/models.py
import uuid
from django.db import models
from django.utils import timezone
from decimal import Decimal


class MiniMovePackage(models.Model):
    """Mini Move service packages from homework: Petite, Standard, Full"""
    
    PACKAGE_TYPES = [
        ('petite', 'Petite'),
        ('standard', 'Standard'), 
        ('full', 'Full Move'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Package details
    package_type = models.CharField(max_length=20, choices=PACKAGE_TYPES, unique=True)
    name = models.CharField(max_length=50)
    description = models.TextField()
    
    # Pricing
    base_price_cents = models.PositiveBigIntegerField()
    
    # Item limits
    max_items = models.PositiveIntegerField(
        null=True, 
        blank=True,
        help_text="Maximum items allowed (null = unlimited for Full Move)"
    )
    max_weight_per_item_lbs = models.PositiveIntegerField(default=50)
    
    # COI handling
    coi_included = models.BooleanField(default=False)
    coi_fee_cents = models.PositiveBigIntegerField(
        default=5000,  # $50
        help_text="COI fee in cents if not included"
    )
    
    # Features
    priority_scheduling = models.BooleanField(default=False)
    protective_wrapping = models.BooleanField(default=False)
    
    # Marketing
    is_most_popular = models.BooleanField(default=False)
    is_active = models.BooleanField(default=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'services_mini_move_package'
        ordering = ['base_price_cents']
    
    def __str__(self):
        return f"{self.name} - ${self.base_price_dollars}"
    
    @property
    def base_price_dollars(self):
        return self.base_price_cents / 100
    
    @property
    def coi_fee_dollars(self):
        return self.coi_fee_cents / 100


class OrganizingService(models.Model):
    """Professional packing/unpacking services tied to Mini Move tiers"""
    
    ORGANIZING_TYPES = [
        ('petite_packing', 'Petite Packing'),
        ('standard_packing', 'Standard Packing'),
        ('full_packing', 'Full Packing'),
        ('petite_unpacking', 'Petite Unpacking'),
        ('standard_unpacking', 'Standard Unpacking'),
        ('full_unpacking', 'Full Unpacking'),
    ]
    
    MINI_MOVE_TIERS = [
        ('petite', 'Petite'),
        ('standard', 'Standard'),
        ('full', 'Full'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Service details
    service_type = models.CharField(max_length=30, choices=ORGANIZING_TYPES, unique=True)
    mini_move_tier = models.CharField(max_length=20, choices=MINI_MOVE_TIERS)
    name = models.CharField(max_length=100)
    description = models.TextField(blank=True)
    
    # Pricing
    price_cents = models.PositiveBigIntegerField()
    
    # Service specs
    duration_hours = models.PositiveIntegerField()
    organizer_count = models.PositiveIntegerField()
    supplies_allowance_cents = models.PositiveBigIntegerField(
        default=0,
        help_text="Supplies allowance in cents (packing services only)"
    )
    
    # Service type classification
    is_packing_service = models.BooleanField(
        help_text="True for packing services (with supplies), False for unpacking (organizing only)"
    )
    
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'services_organizing_service'
        ordering = ['mini_move_tier', 'is_packing_service', 'price_cents']
    
    def __str__(self):
        return f"{self.name} - ${self.price_dollars}"
    
    @property
    def price_dollars(self):
        return self.price_cents / 100
    
    @property
    def supplies_allowance_dollars(self):
        return self.supplies_allowance_cents / 100
    
    def can_be_added_to_mini_move(self, mini_move_package_type):
        """Check if this organizing service can be added to a specific mini move tier"""
        return self.mini_move_tier == mini_move_package_type


class StandardDeliveryConfig(models.Model):
    """Configuration for Standard Delivery pricing from homework"""
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Per-item pricing
    price_per_item_cents = models.PositiveBigIntegerField(
        default=9500,  # $95
        help_text="Price per item in cents"
    )
    
    # Minimums
    minimum_items = models.PositiveIntegerField(
        default=3,
        help_text="Minimum number of items for delivery"
    )
    minimum_charge_cents = models.PositiveBigIntegerField(
        default=28500,  # $285
        help_text="Minimum delivery charge in cents"
    )
    
    # Same-day delivery
    same_day_flat_rate_cents = models.PositiveBigIntegerField(
        default=36000,  # $360
        help_text="Flat rate for same-day delivery"
    )
    
    # Item constraints
    max_weight_per_item_lbs = models.PositiveIntegerField(
        default=50,
        help_text="Maximum weight per item in pounds"
    )
    
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'services_standard_delivery_config'
    
    def __str__(self):
        return f"Standard Delivery - ${self.price_per_item_dollars}/item"
    
    @property
    def price_per_item_dollars(self):
        return self.price_per_item_cents / 100
    
    @property
    def minimum_charge_dollars(self):
        return self.minimum_charge_cents / 100
    
    def calculate_total(self, item_count, is_same_day=False):
        """Calculate total for standard delivery"""
        # FIXED: Calculate base delivery cost first
        item_total = self.price_per_item_cents * item_count
        base_cost = max(item_total, self.minimum_charge_cents)
        
        # FIXED: ADD same-day surcharge on top of base cost
        if is_same_day:
            return base_cost + self.same_day_flat_rate_cents
        
        return base_cost


class SpecialtyItem(models.Model):
    """Specialty items - NOW FULLY DYNAMIC (no hardcoded choices)"""
    
    # ✅ REMOVED: ITEM_TYPES constant - items are now fully configurable
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Item details
    item_type = models.CharField(
        max_length=30, 
        unique=True,
        help_text="Unique identifier for this specialty item (e.g., 'bicycle', 'kayak')"
    )
    name = models.CharField(max_length=100)
    description = models.TextField(blank=True)
    
    # Pricing
    price_cents = models.PositiveBigIntegerField()
    
    # Requirements
    special_handling = models.BooleanField(default=True)
    
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'services_specialty_item'
    
    def __str__(self):
        return f"{self.name} - ${self.price_dollars}"
    
    @property
    def price_dollars(self):
        return self.price_cents / 100


class SurchargeRule(models.Model):
    """Weekend, holiday, and peak date surcharges from homework"""
    
    SURCHARGE_TYPES = [
        ('weekend', 'Peak Date Surcharge'),
        ('holiday', 'Peak Date Surcharge'),
        ('peak_date', 'Peak Date Surcharge'),
    ]
    
    CALCULATION_TYPES = [
        ('percentage', 'Percentage'),
        ('fixed_amount', 'Fixed Amount'),
    ]
    
    SERVICE_TYPE_CHOICES = [
        ('all', 'All Services'),
        ('mini_move', 'Mini Moves Only'),
        ('standard_delivery', 'Standard Delivery Only'),
        ('specialty_item', 'Specialty Items Only'),
    ]
    
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    
    # Surcharge details
    surcharge_type = models.CharField(max_length=20, choices=SURCHARGE_TYPES)
    name = models.CharField(max_length=100)
    description = models.TextField(blank=True)
    
    # Service type filter
    applies_to_service_type = models.CharField(
        max_length=20,
        choices=SERVICE_TYPE_CHOICES,
        default='all',
        help_text='Which service types this surcharge applies to'
    )
    
    # Calculation
    calculation_type = models.CharField(max_length=20, choices=CALCULATION_TYPES)
    percentage = models.DecimalField(
        max_digits=5, 
        decimal_places=2, 
        null=True, 
        blank=True,
        help_text="Percentage surcharge (e.g., 15.00 for 15%)"
    )
    fixed_amount_cents = models.PositiveBigIntegerField(
        null=True,
        blank=True,
        help_text="Fixed surcharge amount in cents"
    )
    
    # Date rules - supports single date OR date range
    specific_date = models.DateField(
        null=True,
        blank=True,
        help_text="Single specific date (use this OR start/end date range)"
    )
    start_date = models.DateField(
        null=True,
        blank=True,
        help_text="Start of date range (inclusive)"
    )
    end_date = models.DateField(
        null=True,
        blank=True,
        help_text="End of date range (inclusive)"
    )

    # Day of week rules (for weekend surcharges)
    applies_saturday = models.BooleanField(default=False)
    applies_sunday = models.BooleanField(default=False)
    
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'services_surcharge_rule'
    
    def __str__(self):
        return self.name
    
    def calculate_surcharge(self, base_amount_cents, booking_date, service_type=None):
        """Calculate surcharge for given base amount, date, and service type"""
        if not self.is_active:
            return 0
        
        if not self.applies_to_date(booking_date):
            return 0
        
        if self.applies_to_service_type != 'all':
            if service_type != self.applies_to_service_type:
                return 0
        
        if self.calculation_type == 'percentage' and self.percentage:
            return int(base_amount_cents * (self.percentage / 100))
        elif self.calculation_type == 'fixed_amount' and self.fixed_amount_cents:
            return self.fixed_amount_cents
        
        return 0
    
    def applies_to_date(self, booking_date):
        """Check if surcharge rule applies to given date"""
        # Check single specific date
        if self.specific_date and self.specific_date == booking_date:
            return True

        # Check date range (inclusive)
        if self.start_date and self.end_date:
            if self.start_date <= booking_date <= self.end_date:
                return True

        # Check weekend days
        weekday = booking_date.weekday()
        if weekday == 5 and self.applies_saturday:
            return True
        if weekday == 6 and self.applies_sunday:
            return True

        return False

    def is_peak_date_rule(self):
        """Check if this rule is a peak date (specific date or date range) vs weekend"""
        return bool(self.specific_date or (self.start_date and self.end_date))

    def is_weekend_rule(self):
        """Check if this rule is a weekend rule"""
        return self.applies_saturday or self.applies_sunday


def calculate_surcharges_for_date(base_amount_cents, booking_date, service_type):
    """
    Calculate total surcharges for a booking date.

    Peak date surcharges OVERRIDE weekend surcharges (don't stack).
    If a date has a peak date surcharge, weekend surcharge is skipped.

    Returns:
        int: Total surcharge in cents
    """
    active_surcharges = SurchargeRule.objects.filter(is_active=True)

    # Separate peak date rules from weekend rules
    peak_date_rules = []
    weekend_rules = []

    for rule in active_surcharges:
        if rule.is_peak_date_rule():
            peak_date_rules.append(rule)
        elif rule.is_weekend_rule():
            weekend_rules.append(rule)

    # Check if any peak date rule applies to this date and service type
    peak_surcharge = 0
    peak_date_applies = False

    for rule in peak_date_rules:
        if rule.applies_to_date(booking_date):
            amount = rule.calculate_surcharge(base_amount_cents, booking_date, service_type)
            if amount > 0:
                peak_surcharge += amount
                peak_date_applies = True

    # If peak date applies, return only peak surcharge (skip weekend)
    if peak_date_applies:
        return peak_surcharge

    # Otherwise, calculate weekend surcharge
    weekend_surcharge = 0
    for rule in weekend_rules:
        weekend_surcharge += rule.calculate_surcharge(base_amount_cents, booking_date, service_type)

    return weekend_surcharge
    
```

# ──── backend/apps/services/serializers.py ────

```python
# backend/apps/services/serializers.py
from rest_framework import serializers
from .models import (
    MiniMovePackage, 
    OrganizingService, 
    StandardDeliveryConfig, 
    SpecialtyItem, 
    SurchargeRule
)


class MiniMovePackageSerializer(serializers.ModelSerializer):
    base_price_dollars = serializers.ReadOnlyField()
    coi_fee_dollars = serializers.ReadOnlyField()
    
    class Meta:
        model = MiniMovePackage
        fields = (
            'id', 'package_type', 'name', 'description',
            'base_price_dollars', 'max_items', 'coi_included', 'coi_fee_dollars',
            'is_most_popular', 'priority_scheduling', 'protective_wrapping'
        )


class OrganizingServiceSerializer(serializers.ModelSerializer):
    price_dollars = serializers.ReadOnlyField()
    supplies_allowance_dollars = serializers.ReadOnlyField()
    
    class Meta:
        model = OrganizingService
        fields = (
            'id', 'service_type', 'mini_move_tier', 'name', 'description',
            'price_dollars', 'duration_hours', 'organizer_count',
            'supplies_allowance_dollars', 'is_packing_service'
        )


class SpecialtyItemSerializer(serializers.ModelSerializer):
    price_dollars = serializers.ReadOnlyField()
    
    class Meta:
        model = SpecialtyItem
        fields = (
            'id', 'item_type', 'name', 'description', 'price_dollars',
            'special_handling'
        )


class StandardDeliveryConfigSerializer(serializers.ModelSerializer):
    price_per_item_dollars = serializers.ReadOnlyField()
    minimum_charge_dollars = serializers.ReadOnlyField()
    same_day_flat_rate_dollars = serializers.SerializerMethodField()
    
    class Meta:
        model = StandardDeliveryConfig
        fields = (
            'price_per_item_dollars', 'minimum_items', 'minimum_charge_dollars',
            'same_day_flat_rate_dollars', 'max_weight_per_item_lbs'
        )
    
    def get_same_day_flat_rate_dollars(self, obj):
        return obj.same_day_flat_rate_cents / 100


class SurchargeRuleSerializer(serializers.ModelSerializer):
    fixed_amount_dollars = serializers.SerializerMethodField()
    
    class Meta:
        model = SurchargeRule
        fields = (
            'id', 'surcharge_type', 'name', 'description',
            'calculation_type', 'percentage', 'fixed_amount_dollars',
            'specific_date', 'applies_saturday', 'applies_sunday'
        )
    
    def get_fixed_amount_dollars(self, obj):
        return obj.fixed_amount_cents / 100 if obj.fixed_amount_cents else None


class ServiceCatalogSerializer(serializers.Serializer):
    """Complete service catalog with all available services and organizing options"""
    
    mini_move_packages = MiniMovePackageSerializer(many=True, read_only=True)
    organizing_services = OrganizingServiceSerializer(many=True, read_only=True)
    standard_delivery = StandardDeliveryConfigSerializer(read_only=True)
    specialty_items = SpecialtyItemSerializer(many=True, read_only=True)
    
    surcharge_rules = SurchargeRuleSerializer(many=True, read_only=True, required=False)


class OrganizingServicesByTierSerializer(serializers.Serializer):
    """Organizing services grouped by Mini Move tier for easy frontend consumption"""
    
    def to_representation(self, instance):
        organizing_services = OrganizingService.objects.filter(is_active=True)
        
        result = {}
        for tier in ['petite', 'standard', 'full']:
            tier_services = organizing_services.filter(mini_move_tier=tier)
            packing_service = tier_services.filter(is_packing_service=True).first()
            unpacking_service = tier_services.filter(is_packing_service=False).first()
            
            result[tier] = {
                'packing': OrganizingServiceSerializer(packing_service).data if packing_service else None,
                'unpacking': OrganizingServiceSerializer(unpacking_service).data if unpacking_service else None
            }
        
        return result


class MiniMoveWithOrganizingSerializer(serializers.Serializer):
    """Mini Move packages with their available organizing services"""
    
    def to_representation(self, instance):
        packages = MiniMovePackage.objects.filter(is_active=True).order_by('base_price_cents')
        
        result = []
        for package in packages:
            organizing_services = OrganizingService.objects.filter(
                mini_move_tier=package.package_type,
                is_active=True
            )
            
            packing_service = organizing_services.filter(is_packing_service=True).first()
            unpacking_service = organizing_services.filter(is_packing_service=False).first()
            
            package_data = MiniMovePackageSerializer(package).data
            package_data['organizing_options'] = {
                'packing': OrganizingServiceSerializer(packing_service).data if packing_service else None,
                'unpacking': OrganizingServiceSerializer(unpacking_service).data if unpacking_service else None
            }
            
            result.append(package_data)
        
        return result
```

# ──── backend/apps/services/views.py ────

```python
# services/views.py
from django.shortcuts import render

# Create your views here.
```

# ──── backend/apps/services/management/commands/create_2026_surcharges.py ────

```python
# backend/apps/services/management/commands/create_2026_surcharges.py
"""
Management command to create 2026 peak date surcharge rules.

Usage:
    python manage.py create_2026_surcharges
    python manage.py create_2026_surcharges --dry-run  # Preview without creating
"""
from datetime import date
from django.core.management.base import BaseCommand
from apps.services.models import SurchargeRule


class Command(BaseCommand):
    help = 'Create 2026 peak date surcharge rules for Mini Moves ($175) and Standard Delivery ($50)'

    def add_arguments(self, parser):
        parser.add_argument(
            '--dry-run',
            action='store_true',
            help='Preview what would be created without actually creating',
        )

    def handle(self, *args, **options):
        dry_run = options['dry_run']

        # Define the surcharge dates for 2026
        # Format: (name, specific_date OR (start_date, end_date))
        surcharge_dates = [
            ('Memorial Day', date(2026, 5, 25)),
            ('June 30th', date(2026, 6, 30)),
            ('July 1st', date(2026, 7, 1)),
            ('July 4th', date(2026, 7, 4)),
            ('July 31st', date(2026, 7, 31)),
            ('August 31st', date(2026, 8, 31)),
            ('Labor Day', date(2026, 9, 7)),
            # US Open is a date range
            ('US Open Week', (date(2026, 9, 14), date(2026, 9, 22))),
        ]

        # Service type configs: (service_type, amount_cents, name_suffix)
        service_configs = [
            ('mini_move', 17500, 'Mini Move'),      # $175
            ('standard_delivery', 5000, 'Standard Delivery'),  # $50
        ]

        created_count = 0
        skipped_count = 0

        for date_name, date_value in surcharge_dates:
            for service_type, amount_cents, service_name in service_configs:
                # Determine if it's a range or single date
                if isinstance(date_value, tuple):
                    start_date, end_date = date_value
                    specific_date = None
                    rule_name = f"{date_name} - {service_name} Surcharge"
                else:
                    start_date = None
                    end_date = None
                    specific_date = date_value
                    rule_name = f"{date_name} - {service_name} Surcharge"

                # Check if rule already exists
                exists = SurchargeRule.objects.filter(name=rule_name).exists()

                if exists:
                    self.stdout.write(
                        self.style.WARNING(f'  SKIP: "{rule_name}" already exists')
                    )
                    skipped_count += 1
                    continue

                if dry_run:
                    if start_date and end_date:
                        self.stdout.write(
                            self.style.SUCCESS(
                                f'  WOULD CREATE: "{rule_name}" - ${amount_cents/100:.0f} '
                                f'({start_date} → {end_date})'
                            )
                        )
                    else:
                        self.stdout.write(
                            self.style.SUCCESS(
                                f'  WOULD CREATE: "{rule_name}" - ${amount_cents/100:.0f} '
                                f'({specific_date})'
                            )
                        )
                else:
                    SurchargeRule.objects.create(
                        surcharge_type='peak_date',
                        name=rule_name,
                        description=f'Peak date surcharge for {date_name}',
                        applies_to_service_type=service_type,
                        calculation_type='fixed_amount',
                        fixed_amount_cents=amount_cents,
                        specific_date=specific_date,
                        start_date=start_date,
                        end_date=end_date,
                        is_active=True,
                    )
                    if start_date and end_date:
                        self.stdout.write(
                            self.style.SUCCESS(
                                f'  CREATED: "{rule_name}" - ${amount_cents/100:.0f} '
                                f'({start_date} → {end_date})'
                            )
                        )
                    else:
                        self.stdout.write(
                            self.style.SUCCESS(
                                f'  CREATED: "{rule_name}" - ${amount_cents/100:.0f} '
                                f'({specific_date})'
                            )
                        )

                created_count += 1

        self.stdout.write('')
        if dry_run:
            self.stdout.write(
                self.style.WARNING(
                    f'DRY RUN: Would create {created_count} rules, skip {skipped_count}'
                )
            )
        else:
            self.stdout.write(
                self.style.SUCCESS(
                    f'Done! Created {created_count} rules, skipped {skipped_count}'
                )
            )
```

# ──── backend/config/asgi.py ────

```python
"""
ASGI config for config project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_asgi_application()
```

# ──── backend/config/celery.py ────

```python
import os
from celery import Celery

# Set the default Django settings module for the 'celery' program.
os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

app = Celery('totetaxi')

# Using a string here means the worker doesn't have to serialize
# the configuration object to child processes.
app.config_from_object('django.conf:settings', namespace='CELERY')

# Load task modules from all registered Django apps.
app.autodiscover_tasks()

@app.task(bind=True, ignore_result=True)
def debug_task(self):
    print(f'Request: {self.request!r}')
```

# ──── backend/config/settings.py ────

```python
import os
import sys
import environ
from pathlib import Path
from celery.schedules import crontab
import logging
import sentry_sdk
from sentry_sdk.integrations.django import DjangoIntegration
from sentry_sdk.integrations.celery import CeleryIntegration
from sentry_sdk.integrations.redis import RedisIntegration
from sentry_sdk.integrations.logging import LoggingIntegration



BASE_DIR = Path(__file__).resolve().parent.parent

env = environ.Env(
    DEBUG=(bool, False),
)

# Only load .env locally; Fly.io uses real env vars
if not os.environ.get('FLY_APP_NAME') and (BASE_DIR / '.env').exists():
    environ.Env.read_env(BASE_DIR / '.env')

if os.environ.get('FLY_APP_NAME'):
    SECRET_KEY = env('SECRET_KEY')  # Required in production — no fallback
else:
    SECRET_KEY = env('SECRET_KEY', default='django-insecure-local-dev-only')
DEBUG = env('DEBUG', default=False)
FLY_APP_NAME = env('FLY_APP_NAME', default='')

SENTRY_DSN = env('SENTRY_DSN', default='')
SENTRY_ENVIRONMENT = env('SENTRY_ENVIRONMENT', default='development')
TESTING = 'test' in sys.argv or ('pytest' in sys.argv[0] if sys.argv else False)

def filter_sentry_events(event, hint):
    """Filter out certain events from being sent to Sentry"""
    if 'exc_info' in hint:
        exc_type, exc_value, tb = hint['exc_info']
        if exc_type.__name__ == 'DisallowedHost':
            return None
    
    if 'log_record' in hint:
        record = hint['log_record']
        if 'Not Found:' in record.getMessage():
            return None
    
    return event

if SENTRY_DSN and not TESTING:
    sentry_sdk.init(
        dsn=SENTRY_DSN,
        environment=SENTRY_ENVIRONMENT,
        integrations=[
            DjangoIntegration(
                transaction_style='url',
                middleware_spans=True,
                signals_spans=True,
                cache_spans=True,
            ),
            CeleryIntegration(
                monitor_beat_tasks=True,
                propagate_traces=True,
            ),
            RedisIntegration(),
            LoggingIntegration(
                level=logging.INFO,
                event_level=logging.ERROR
            ),
        ],
        traces_sample_rate=1.0 if DEBUG else 0.1,
        release=env('SENTRY_RELEASE', default=None),
        before_send=filter_sentry_events,
        attach_stacktrace=True,
        send_default_pii=False,
        max_breadcrumbs=50,
        debug=DEBUG,
    )

ALLOWED_HOSTS = env.list('ALLOWED_HOSTS', default=['localhost', '127.0.0.1', '0.0.0.0'])
if FLY_APP_NAME:
    ALLOWED_HOSTS.extend([
        f'{FLY_APP_NAME}.fly.dev',
        f'{FLY_APP_NAME}.internal',
        '.fly.dev',
        'api.totetaxi.com',
    ])

DJANGO_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
]

THIRD_PARTY_APPS = [
    'rest_framework',
    'corsheaders',
    'django_celery_beat',
    'drf_yasg',
    'django_ratelimit',
]

LOCAL_APPS = [
    'apps.accounts',
    'apps.bookings',
    'apps.services',
    'apps.payments',
    'apps.logistics',
    'apps.customers',
]

INSTALLED_APPS = DJANGO_APPS + THIRD_PARTY_APPS + LOCAL_APPS

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.security.SecurityMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'config.urls'

TEMPLATES = [{
    'BACKEND': 'django.template.backends.django.DjangoTemplates',
    'DIRS': [BASE_DIR / 'templates'],
    'APP_DIRS': True,
    'OPTIONS': {
        'context_processors': [
            'django.template.context_processors.debug',
            'django.template.context_processors.request',
            'django.contrib.auth.context_processors.auth',
            'django.contrib.messages.context_processors.messages',
        ],
    },
}]

WSGI_APPLICATION = 'config.wsgi.application'

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': env('DB_NAME', default='totetaxi'),
        'USER': env('DB_USER', default='postgres'),
        'PASSWORD': env('DB_PASSWORD', default='postgres'),
        'HOST': env('DB_HOST', default='db'),
        'PORT': env('DB_PORT', default='5432'),
    }
}
database_url = env('DATABASE_URL', default=None)
if database_url:
    import dj_database_url
    DATABASES['default'] = dj_database_url.config(
        default=database_url,
        conn_max_age=600,
        conn_health_checks=True,
    )

CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': env('REDIS_URL', default='redis://redis:6379/1'),
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
            'IGNORE_EXCEPTIONS': True,
        }
    }
}

RATELIMIT_USE_CACHE = 'default'
RATELIMIT_ENABLE = True

AUTH_PASSWORD_VALIDATORS = [
    {'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'},
    {'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator'},
    {'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator'},
    {'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator'},
]

LANGUAGE_CODE = 'en-us'
TIME_ZONE = 'America/New_York'
USE_I18N = True
USE_TZ = True

STATIC_URL = '/static/'
STATIC_ROOT = BASE_DIR / 'staticfiles'
STATICFILES_DIRS = []
if (BASE_DIR / 'static').exists():
    STATICFILES_DIRS.append(BASE_DIR / 'static')
STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'

MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'apps.customers.authentication.HybridAuthentication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ],
    'DEFAULT_RENDERER_CLASSES': [
        'rest_framework.renderers.JSONRenderer',
    ] + (['rest_framework.renderers.BrowsableAPIRenderer'] if DEBUG else []),
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 20,
}

CORS_ALLOWED_ORIGINS = env.list('CORS_ALLOWED_ORIGINS', default=[
    'http://localhost:3000',
    'http://127.0.0.1:3000',
    'https://totetaxi.netlify.app',
])
if FLY_APP_NAME:
    CORS_ALLOWED_ORIGINS.append(f'https://{FLY_APP_NAME}.fly.dev')

CORS_ALLOW_CREDENTIALS = True
CORS_ALLOW_HEADERS = [
    'accept', 'accept-encoding', 'authorization', 'content-type', 'dnt',
    'origin', 'user-agent', 'x-csrftoken', 'x-requested-with', 'x-session-id',
]

CSRF_COOKIE_SECURE = not DEBUG
CSRF_COOKIE_HTTPONLY = False
CSRF_COOKIE_SAMESITE = 'Lax' if DEBUG else 'None'
CSRF_TRUSTED_ORIGINS = env.list('CSRF_TRUSTED_ORIGINS', default=[
    'http://localhost:3000',
    'http://127.0.0.1:3000',
    'https://totetaxi.netlify.app',
])
if FLY_APP_NAME:
    CSRF_TRUSTED_ORIGINS.extend([f'https://{FLY_APP_NAME}.fly.dev'])

SESSION_COOKIE_SECURE = not DEBUG
SESSION_COOKIE_SAMESITE = 'Lax' if DEBUG else 'None'
SESSION_COOKIE_AGE = 60 * 60 * 24 * 30
SESSION_EXPIRE_AT_BROWSER_CLOSE = False
SESSION_SAVE_EVERY_REQUEST = True
SESSION_COOKIE_NAME = 'totetaxi_sessionid'
SESSION_ENGINE = 'django.contrib.sessions.backends.db'

# EMAIL — use OS env first (Fly secrets), then .env
EMAIL_BACKEND = os.environ.get('EMAIL_BACKEND') or env('EMAIL_BACKEND', default='django.core.mail.backends.console.EmailBackend')
EMAIL_HOST = os.environ.get('EMAIL_HOST') or env('EMAIL_HOST', default='localhost')
EMAIL_PORT = int(os.environ.get('EMAIL_PORT', env.int('EMAIL_PORT', default=587)))
EMAIL_USE_TLS = (os.environ.get('EMAIL_USE_TLS', '') or '').lower() in ('true', '1', 'yes') if os.environ.get('EMAIL_USE_TLS') else env.bool('EMAIL_USE_TLS', default=True)
EMAIL_HOST_USER = os.environ.get('EMAIL_HOST_USER') or env('EMAIL_HOST_USER', default='')
EMAIL_HOST_PASSWORD = os.environ.get('EMAIL_HOST_PASSWORD') or env('EMAIL_HOST_PASSWORD', default='')
DEFAULT_FROM_EMAIL = os.environ.get('DEFAULT_FROM_EMAIL') or env('DEFAULT_FROM_EMAIL', default='ToteTaxi <noreply@totetaxi.com>')

# ⬇️ NEW: BCC list for booking confirmations (comma-separated env)
BOOKING_EMAIL_BCC = env.list('BOOKING_EMAIL_BCC', default=[])

# reCAPTCHA v3 settings for spam prevention
RECAPTCHA_SECRET_KEY = os.environ.get('RECAPTCHA_SECRET_KEY') or env('RECAPTCHA_SECRET_KEY', default='')

FRONTEND_URL = env('FRONTEND_URL', default='https://totetaxi.netlify.app')

CELERY_BROKER_URL = env('REDIS_URL', default='redis://redis:6379/0')
CELERY_RESULT_BACKEND = env('REDIS_URL', default='redis://redis:6379/0')
CELERY_ACCEPT_CONTENT = ['application/json']
CELERY_TASK_SERIALIZER = 'json'
CELERY_RESULT_SERIALIZER = 'json'
CELERY_TIMEZONE = TIME_ZONE

if not DEBUG:
    SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
    SECURE_SSL_REDIRECT = True
    SECURE_BROWSER_XSS_FILTER = True
    SECURE_CONTENT_TYPE_NOSNIFF = True
    SECURE_HSTS_INCLUDE_SUBDOMAINS = True
    SECURE_HSTS_SECONDS = 31536000
    SECURE_HSTS_PRELOAD = True
    SESSION_COOKIE_SECURE = True
    CSRF_COOKIE_SECURE = True

LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {'format': '{levelname} {asctime} {module} {message}', 'style': '{'},
    },
    'handlers': {'console': {'class': 'logging.StreamHandler', 'formatter': 'verbose'}},
    'root': {'handlers': ['console'], 'level': 'INFO'},
    'loggers': {
        'django': {'handlers': ['console'], 'level': env('DJANGO_LOG_LEVEL', default='INFO'), 'propagate': False},
        'django.request': {'handlers': ['console'], 'level': 'DEBUG', 'propagate': False},
        'django_ratelimit': {'handlers': ['console'], 'level': 'INFO', 'propagate': False},
    },
}

# Stripe
STRIPE_SECRET_KEY = env('STRIPE_SECRET_KEY', default='')
STRIPE_PUBLISHABLE_KEY = env('STRIPE_PUBLISHABLE_KEY', default='')
STRIPE_WEBHOOK_SECRET = env('STRIPE_WEBHOOK_SECRET', default='')

# Onfleet
ONFLEET_API_KEY = env('ONFLEET_API_KEY', default='')
ONFLEET_MOCK_MODE = env.bool('ONFLEET_MOCK_MODE', default=True)
ONFLEET_ENVIRONMENT = env('ONFLEET_ENVIRONMENT', default='sandbox')
ONFLEET_WEBHOOK_SECRET = env('ONFLEET_WEBHOOK_SECRET', default='')

BLADE_PHONE_NUMBER = env('BLADE_PHONE_NUMBER', default='+1234567890')

CELERY_BEAT_SCHEDULE = {
    'send-booking-reminders-hourly': {
        'task': 'apps.bookings.tasks.send_booking_reminders',
        'schedule': crontab(minute=0),
        'options': {'expires': 3600}
    },
}# Replace your TESTING section cache configuration with this:
# ADD THIS TO YOUR config/settings.py - COMPLETE TESTING SECTION

# ============================================================================
# TEST CONFIGURATION
# ============================================================================
# Detect if we're running tests
TESTING = 'test' in sys.argv or ('pytest' in sys.argv[0] if sys.argv else False)

if TESTING:
    # Use faster in-memory SQLite for tests
    DATABASES = {
        'default': {
            'ENGINE': 'django.db.backends.sqlite3',
            'NAME': ':memory:',
        }
    }

    # Disable password hashing for faster tests
    PASSWORD_HASHERS = [
        'django.contrib.auth.hashers.MD5PasswordHasher',
    ]

    # Use console email backend for tests
    EMAIL_BACKEND = 'django.core.mail.backends.console.EmailBackend'

    # Make Celery tasks run synchronously during tests
    CELERY_TASK_ALWAYS_EAGER = True
    CELERY_TASK_EAGER_PROPAGATES = True

    # Disable ratelimit logic
    RATELIMIT_ENABLE = False
    
    # Use Redis for tests (different DB number) - required by django-ratelimit
    CACHES = {
        'default': {
            'BACKEND': 'django_redis.cache.RedisCache',
            'LOCATION': env('REDIS_URL', default='redis://redis:6379/2'),  # DB 2 for tests
            'OPTIONS': {
                'CLIENT_CLASS': 'django_redis.client.DefaultClient',
                'IGNORE_EXCEPTIONS': True,
            }
        }
    }

    # ✅ Force Onfleet mock mode during tests
    ONFLEET_MOCK_MODE = True
    ONFLEET_ENVIRONMENT = 'sandbox'

    # Relax cookie security for test client
    CSRF_COOKIE_SECURE = False
    SESSION_COOKIE_SECURE = False
```

# ──── backend/config/urls.py ────

```python
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),

    # Public + customer
    path('api/customer/', include('apps.customers.urls')),
    path('api/public/', include('apps.bookings.urls')),

    # Payments (includes Stripe webhook)
    path('api/payments/', include('apps.payments.urls')),

    # Staff
    path('api/staff/', include('apps.accounts.urls')),
    path('api/staff/logistics/', include('apps.logistics.urls')),
]
```

# ──── backend/config/wsgi.py ────

```python
"""
WSGI config for config project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_wsgi_application()
```

# ──── backend/scripts/entrypoint.sh ────

```bash
#!/bin/bash
set -e

echo "Starting ToteTaxi Backend..."

# CRITICAL FIX: Unset docker-compose DB variables on Fly.io
unset DB_HOST
unset DB_NAME
unset DB_USER
unset DB_PASSWORD
unset DB_PORT

# Wait for database if DB_HOST is set (won't happen after unset)
if [ -n "$DB_HOST" ]; then
    echo "Waiting for postgres at $DB_HOST:${DB_PORT:-5432}..."
    while ! pg_isready -h "$DB_HOST" -p "${DB_PORT:-5432}" -U "${DB_USER:-postgres}"; do
      sleep 1
    done
    echo "PostgreSQL is ready!"
fi

# Run migrations
echo "Running database migrations..."
python manage.py migrate --no-input

# Collect static files (in case not done in Dockerfile)
echo "Collecting static files..."
python manage.py collectstatic --no-input --clear || true

# Create cache table if needed
python manage.py createcachetable || true

# Create superuser if specified (optional)
if [ -n "$DJANGO_SUPERUSER_EMAIL" ] && [ -n "$DJANGO_SUPERUSER_PASSWORD" ]; then
    echo "Creating superuser..."
    python manage.py shell -c "
from django.contrib.auth import get_user_model
User = get_user_model()
if not User.objects.filter(email='$DJANGO_SUPERUSER_EMAIL').exists():
    User.objects.create_superuser('$DJANGO_SUPERUSER_EMAIL', '$DJANGO_SUPERUSER_EMAIL', '$DJANGO_SUPERUSER_PASSWORD')
    print('Superuser created')
else:
    print('Superuser already exists')
" || true
fi

echo "Starting application..."
exec "$@"
```


============================================================
  FRONTEND
============================================================

# ──── frontend/next-env.d.ts ────

```typescript
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.
```

# ──── frontend/next.config.ts ────

```typescript
// frontend/next.config.ts - UPDATE YOUR FILE TO LOOK LIKE THIS:

import { withSentryConfig } from '@sentry/nextjs';
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  typescript: {
    ignoreBuildErrors: true,
  },

  // Security headers - protect against common web attacks
  async headers() {
    return [
      {
        // Apply to all routes
        source: '/(.*)',
        headers: [
          {
            // Prevent embedding in iframes (clickjacking protection)
            key: 'X-Frame-Options',
            value: 'DENY'
          },
          {
            // Prevent MIME type sniffing attacks
            key: 'X-Content-Type-Options', 
            value: 'nosniff'
          },
          {
            // Control referrer information leakage
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin'
          },
          {
            // XSS protection (backup for older browsers)
            key: 'X-XSS-Protection',
            value: '1; mode=block'
          },
          {
            // FIXED: Allow payment APIs for Stripe, disable others
            key: 'Permissions-Policy',
            value: 'camera=(), microphone=(), geolocation=()'
            // Removed payment=() to allow Stripe to work
          },
          {
            // Force HTTPS (only in production)
            key: 'Strict-Transport-Security',
            value: process.env.NODE_ENV === 'production' 
              ? 'max-age=31536000; includeSubDomains; preload' 
              : ''
          }
        ]
      }
    ]
  },

  // Production optimizations
  compiler: {
    // Remove console.logs in production (keep errors/warnings)
    removeConsole: process.env.NODE_ENV === 'production' ? {
      exclude: ['error', 'warn']
    } : false
  },

  // Remove source maps in production (security)
  productionBrowserSourceMaps: false,

  // Image optimization
  images: {
    domains: ['totetaxi.com', 'api.totetaxi.com'],
    formats: ['image/webp', 'image/avif']
  },

  // Strict mode for better React practices
  reactStrictMode: true,

  // Security-focused experimental features
  experimental: {
    // Enable modern bundling
    esmExternals: true
  }
};

const sentryWebpackPluginOptions = {
  // Only upload source maps in production
  silent: true,
  widenClientFileUpload: true,
  hideSourceMaps: true,
  disableLogger: true,
  automaticVercelMonitors: true,
};

// Export with Sentry configuration
export default withSentryConfig(nextConfig, {
  // For all available options, see:
  // https://www.npmjs.com/package/@sentry/webpack-plugin#options

  org: "matthew-raynor",

  project: "totetaxi-next",

  // Only print logs for uploading source maps in CI
  silent: !process.env.CI,

  // For all available options, see:
  // https://docs.sentry.io/platforms/javascript/guides/nextjs/manual-setup/

  // Upload a larger set of source maps for prettier stack traces (increases build time)
  widenClientFileUpload: true,

  // Uncomment to route browser requests to Sentry through a Next.js rewrite to circumvent ad-blockers.
  // This can increase your server load as well as your hosting bill.
  // Note: Check that the configured route will not match with your Next.js middleware, otherwise reporting of client-
  // side errors will fail.
  // tunnelRoute: "/monitoring",

  // Automatically tree-shake Sentry logger statements to reduce bundle size
  disableLogger: true,

  // Enables automatic instrumentation of Vercel Cron Monitors. (Does not yet work with App Router route handlers.)
  // See the following for more information:
  // https://docs.sentry.io/product/crons/
  // https://vercel.com/docs/cron-jobs
  automaticVercelMonitors: true
});
```

# ──── frontend/package.json ────

```json
{
  "name": "frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint",
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:e2e:headed": "playwright test --headed",
    "test:e2e:debug": "playwright test --debug"
  },
  "dependencies": {
    "@headlessui/react": "^2.2.7",
    "@heroicons/react": "^2.2.0",
    "@hookform/resolvers": "^3.10.0",
    "@sentry/nextjs": "^10.22.0",
    "@sentry/profiling-node": "^10.22.0",
    "@sentry/react": "^10.22.0",
    "@stripe/react-stripe-js": "^4.0.2",
    "@stripe/stripe-js": "^7.9.0",
    "@tanstack/react-query": "^5.87.1",
    "@tanstack/react-query-devtools": "^5.87.1",
    "axios": "^1.11.0",
    "clsx": "^2.1.1",
    "next": "^16.0.10",
    "react": "19.1.0",
    "react-dom": "19.1.0",
    "react-google-autocomplete": "^2.7.5",
    "react-hook-form": "^7.62.0",
    "tailwind-merge": "^2.6.0",
    "use-places-autocomplete": "^4.0.1",
    "zod": "^3.25.76",
    "zustand": "^4.5.7"
  },
  "devDependencies": {
    "@eslint/eslintrc": "^3",
    "@playwright/test": "^1.56.0",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "autoprefixer": "^10.4.21",
    "eslint": "^9",
    "eslint-config-next": "15.5.0",
    "postcss": "^8.5.6",
    "tailwindcss": "^3.4.17",
    "typescript": "^5"
  }
}
```

# ──── frontend/playwright.config.ts ────

```typescript
// frontend/playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    viewport: { width: 2560, height: 1600 }, // ✅ MASSIVE viewport - modal won't be cut off
    deviceScaleFactor: 1, // No zoom
  },

  projects: [
    {
      name: 'chromium',
      use: { 
        ...devices['Desktop Chrome'],
        viewport: { width: 2560, height: 1600 }, // Override device viewport
      },
    },
  ],

  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
    timeout: 120000,
  },
});
```

# ──── frontend/postcss.config.js ────

```javascript
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
}
```

# ──── frontend/postcss.config.mjs ────

```
const config = {
  plugins: ["@tailwindcss/postcss"],
};

export default config;
```

# ──── frontend/sentry.client.config.ts ────

```typescript
// frontend/sentry.client.config.ts
import * as Sentry from "@sentry/nextjs";

if (process.env.NEXT_PUBLIC_SENTRY_DSN) {
  Sentry.init({
    dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
    environment: process.env.NEXT_PUBLIC_SENTRY_ENVIRONMENT || 'development',
    tracesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
    replaysSessionSampleRate: 0.1,
    replaysOnErrorSampleRate: 1.0,
    profilesSampleRate: process.env.NODE_ENV === 'production' ? 0.1 : 1.0,
    release: process.env.NEXT_PUBLIC_SENTRY_RELEASE,
    debug: false,
    beforeSend(event) {
      if (event.exception) {
        const error = event.exception.values?.[0];
        if (error?.type === 'ChunkLoadError') {
          return null;
        }
      }
      return event;
    },
  });
}
```

# ──── frontend/sentry.edge.config.ts ────

```typescript
// This file configures the initialization of Sentry for edge features (middleware, edge routes, and so on).
// The config you add here will be used whenever one of the edge features is loaded.
// Note that this config is unrelated to the Vercel Edge Runtime and is also required when running locally.
// https://docs.sentry.io/platforms/javascript/guides/nextjs/

import * as Sentry from "@sentry/nextjs";

if (process.env.NEXT_PUBLIC_SENTRY_DSN) {
  Sentry.init({
    dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,

    // Define how likely traces are sampled. Adjust this value in production, or use tracesSampler for greater control.
    tracesSampleRate: 1,

    // Enable logs to be sent to Sentry
    enableLogs: true,

    // Enable sending user PII (Personally Identifiable Information)
    // https://docs.sentry.io/platforms/javascript/guides/nextjs/configuration/options/#sendDefaultPii
    sendDefaultPii: true,
  });
}
```

# ──── frontend/sentry.server.config.ts ────

```typescript
// This file configures the initialization of Sentry on the server.
// The config you add here will be used whenever the server handles a request.
// https://docs.sentry.io/platforms/javascript/guides/nextjs/

import * as Sentry from "@sentry/nextjs";

if (process.env.NEXT_PUBLIC_SENTRY_DSN) {
  Sentry.init({
    dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,

    // Define how likely traces are sampled. Adjust this value in production, or use tracesSampler for greater control.
    tracesSampleRate: 1,

    // Enable logs to be sent to Sentry
    enableLogs: true,

    // Enable sending user PII (Personally Identifiable Information)
    // https://docs.sentry.io/platforms/javascript/guides/nextjs/configuration/options/#sendDefaultPii
    sendDefaultPii: true,
  });
}
```

# ──── frontend/tailwind.config.js ────

```javascript
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./src/pages/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/components/**/*.{js,ts,jsx,tsx,mdx}",
    "./src/app/**/*.{js,ts,jsx,tsx,mdx}",
  ],
  theme: {
    extend: {
      fontFamily: {
        serif: ['var(--font-playfair)', 'serif'],
        sans: ['var(--font-inter)', 'sans-serif'],
      },
      colors: {
        navy: {
          50: '#f0f4f8',
          100: '#d9e2ec',
          200: '#bcccdc',
          300: '#9fb3c8',
          400: '#829ab1',
          500: '#627d98',
          600: '#486581',
          700: '#334e68',
          800: '#243b53',
          900: '#1a365d',
        },
        gold: {
          50: '#fffdf7',
          100: '#fef7e0',
          200: '#fdecc0',
          300: '#fbdb94',
          400: '#f7c365',
          500: '#d69e2e',
          600: '#b7791f',
          700: '#975a16',
          800: '#744210',
          900: '#5f370e',
        },
        cream: {
          50: '#fefcf3',
          100: '#fef7e0',
          200: '#fdecc0',
          300: '#fbdb94',
          400: '#f7c365',
          500: '#f1a545',
          600: '#d69e2e',
          700: '#b7791f',
          800: '#975a16',
          900: '#744210',
        }
      },
      container: {
        center: true,
        padding: "2rem",
        screens: {
          "2xl": "1400px",
        },
      },
    },
  },
  plugins: [],
}
```

# ──── frontend/tsconfig.json ────

```json
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": [
      "dom",
      "dom.iterable",
      "esnext"
    ],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": [
        "./src/*"
      ]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
```

# ──── frontend/src/instrumentation-client.ts ────

```typescript
// This file configures the initialization of Sentry on the client.
// The added config here will be used whenever a users loads a page in their browser.
// https://docs.sentry.io/platforms/javascript/guides/nextjs/

import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: "https://2d9a44516c49300f04125ed8775c7450@o4509753799409664.ingest.us.sentry.io/4510246779420672",

  // Add optional integrations for additional features
  integrations: [
    Sentry.replayIntegration(),
  ],

  // Define how likely traces are sampled. Adjust this value in production, or use tracesSampler for greater control.
  tracesSampleRate: 1,
  // Enable logs to be sent to Sentry
  enableLogs: true,

  // Define how likely Replay events are sampled.
  // This sets the sample rate to be 10%. You may want this to be 100% while
  // in development and sample at a lower rate in production
  replaysSessionSampleRate: 0.1,

  // Define how likely Replay events are sampled when an error occurs.
  replaysOnErrorSampleRate: 1.0,

  // Enable sending user PII (Personally Identifiable Information)
  // https://docs.sentry.io/platforms/javascript/guides/nextjs/configuration/options/#sendDefaultPii
  sendDefaultPii: true,
});

export const onRouterTransitionStart = Sentry.captureRouterTransitionStart;
```

# ──── frontend/src/app/global-error.tsx ────

```tsx
"use client";

import * as Sentry from "@sentry/nextjs";
import NextError from "next/error";
import { useEffect } from "react";

export default function GlobalError({ error }: { error: Error & { digest?: string } }) {
  useEffect(() => {
    Sentry.captureException(error);
  }, [error]);

  return (
    <html>
      <body>
        {/* `NextError` is the default Next.js error page component. Its type
        definition requires a `statusCode` prop. However, since the App Router
        does not expose status codes for errors, we simply pass 0 to render a
        generic error message. */}
        <NextError statusCode={0} />
      </body>
    </html>
  );
}
```

# ──── frontend/src/app/globals.css ────

```css
@tailwind base;
@tailwind components;
@tailwind utilities;

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: var(--font-inter), Arial, Helvetica, sans-serif;
}

/* Custom utility classes for luxury design */
@layer components {
  .luxury-card-shadow {
    @apply shadow-lg shadow-navy-900/10 hover:shadow-xl hover:shadow-navy-900/20 transition-shadow duration-300;
  }
  
  .gradient-gold {
    @apply bg-gradient-to-r from-gold-400 to-gold-600;
  }
}
```

# ──── frontend/src/app/layout.tsx ────

```tsx
// frontend/src/app/layout.tsx
import type { Metadata } from "next";
import { Inter, Playfair_Display } from "next/font/google";
import "./globals.css";
import { ClientProviders } from "@/components/providers/client-providers";

const inter = Inter({ subsets: ["latin"], variable: '--font-inter' });
const playfair = Playfair_Display({ subsets: ["latin"], variable: '--font-playfair' });

// This is what controls your social media previews
export const metadata: Metadata = {
  title: {
    default: "Tote Taxi - Premium Door-to-Door Delivery Service",
    template: "%s | Tote Taxi"
  },
  description: "Tote Taxi delivers your luggage and belongings stress-free between NYC, the Hamptons, South Florida, and all major airports. From suitcases to surfboards, Pelotons to pop-up props.",
  keywords: ["luggage delivery", "door-to-door service", "NYC", "Hamptons", "Florida", "airport delivery", "luxury transport"],
  
  // Open Graph (Facebook, LinkedIn, etc.)
  openGraph: {
    type: "website",
    locale: "en_US",
    url: "https://totetaxi.com",
    siteName: "Tote Taxi",
    title: "Tote Taxi - Premium Door-to-Door Delivery Service",
    description: "Stress-free delivery between NYC, the Hamptons, and South Florida. We handle everything from suitcases to surfboards.",
    images: [
      {
        url: "https://totetaxi.com/assets/images/totetaxilogo.png",
        width: 1200,
        height: 630,
        alt: "Tote Taxi - Premium Delivery Service",
      },
      {
        url: "https://totetaxi.com/assets/images/hero-large.jpg",
        width: 1200,
        height: 630,
        alt: "Tote Taxi luxury delivery service",
      }
    ],
  },
  
  // Twitter Card
  twitter: {
    card: "summary_large_image",
    title: "Tote Taxi - Premium Door-to-Door Delivery",
    description: "Stress-free delivery between NYC, the Hamptons, and South Florida.",
    images: ["https://totetaxi.com/assets/images/totetaxilogo.png"],
  },
  
  // Additional SEO
  robots: {
    index: true,
    follow: true,
    googleBot: {
      index: true,
      follow: true,
      'max-video-preview': -1,
      'max-image-preview': 'large',
      'max-snippet': -1,
    },
  },
  
  category: "business",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en" className={`${inter.variable} ${playfair.variable}`}>
      <body className={inter.className}>
        <ClientProviders>
          {children}
        </ClientProviders>
      </body>
    </html>
  );
}
```

# ──── frontend/src/app/page.tsx ────

```tsx
// src/app/page.tsx
'use client';

import { useState } from 'react';
import { MainLayout } from '@/components/layout/main-layout';
import { BookingWizard } from '@/components/booking';
import { Modal } from '@/components/ui/modal';
import { Button } from '@/components/ui/button';
import {
  HeroSection,
  HowItWorksSection,
  WhatWeTransportSection,
  ServiceAreasSection,
  TestimonialsSection,
  JFKAnnouncementPopup
} from '@/components/marketing';
import { ServiceShowcase } from '@/components/marketing/service-showcase';

export default function Home() {
  const [showBookingWizard, setShowBookingWizard] = useState(false);

  const openBookingWizard = () => {
    setShowBookingWizard(true);
  };

  const closeBookingWizard = () => {
    setShowBookingWizard(false);
  };

  return (
    <>
      <MainLayout onBookNowClick={openBookingWizard}>
        <HeroSection onBookNowClick={openBookingWizard} />
        <HowItWorksSection />
        <WhatWeTransportSection />
        <ServiceShowcase />
        <ServiceAreasSection />
        <TestimonialsSection />
        
        {/* Partnerships */}
        <section className="py-16 bg-cream-50">
          <div className="container mx-auto px-4">
            <div className="text-center mb-12">
              <h2 className="text-3xl font-serif font-bold text-navy-900 mb-4">
                Trusted Partners
              </h2>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
              <div className="text-center">
                <h3 className="font-medium text-navy-900 mb-2">BLADE</h3>
                <p className="text-navy-600 text-sm">Official luggage delivery partner for helicopter transfers</p>
              </div>
              <div className="text-center">
                <h3 className="font-medium text-navy-900 mb-2">Hampton Jitney</h3>
                <p className="text-navy-600 text-sm">Travel light on the Jitney, we handle your luggage</p>
              </div>
              <div className="text-center">
                <h3 className="font-medium text-navy-900 mb-2">Cultured Magazine</h3>
                <p className="text-navy-600 text-sm">Trusted delivery partner</p>
              </div>
              <div className="text-center">
                <h3 className="font-medium text-navy-900 mb-2">Luggage Free</h3>
                <p className="text-navy-600 text-sm">Partner in luggage logistics</p>
              </div>
            </div>
          </div>
        </section>

        {/* Final CTA */}
        <section className="py-16 bg-navy-900 text-white">
          <div className="container mx-auto px-4 text-center">
            <h2 className="text-3xl font-serif font-bold mb-4">
              Ready to Travel Hands-Free?
            </h2>
            <p className="text-xl text-navy-200 mb-8 max-w-2xl mx-auto">
              Join thousands of satisfied customers who trust Tote Taxi for stress-free delivery service.
            </p>
            <Button 
              variant="secondary" 
              size="lg"
              onClick={openBookingWizard}
            >
              Book Now
            </Button>
          </div>
        </section>
      </MainLayout>

      <Modal
        isOpen={showBookingWizard}
        onClose={closeBookingWizard}
        size="full"
        className="max-w-6xl"
        showCloseButton={true}
      >
        <BookingWizard />
      </Modal>

      {/* JFK Route Announcement Popup */}
      <JFKAnnouncementPopup onBookAirportTransfer={openBookingWizard} />
    </>
  );
}
```

# ──── frontend/src/app/about/page.tsx ────

```tsx
// frontend/src/app/about/page.tsx - Real Tote Taxi story
import { MainLayout } from '@/components/layout/main-layout';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import Link from 'next/link';

export default function AboutPage() {
  return (
    <MainLayout>
      <div className="container mx-auto px-4 py-16">
        {/* Hero Section */}
        <div className="text-center mb-16">
          <h1 className="text-4xl md:text-5xl font-serif font-bold text-navy-900 mb-6">
            Welcome to Tote Taxi
          </h1>
          <p className="text-xl text-navy-700 max-w-3xl mx-auto">
            A door-to-door delivery, storage, courier, and mini moving service serving the Hamptons, 
            NYC, all major NY airports, Connecticut, and South Florida.
          </p>
        </div>

        {/* What We Do */}
        <section className="mb-20">
          <Card variant="luxury">
            <CardHeader>
              <h2 className="text-3xl font-serif font-bold text-navy-900 text-center">
                What We Do + Where We Go
              </h2>
            </CardHeader>
            <CardContent>
              <div className="space-y-6">
                <p className="text-navy-700 text-lg">
                  Tote Taxi offers a luxury <strong>multi-arm delivery service</strong> with additional{' '}
                  <strong>custom service offerings</strong> for people traveling to and from{' '}
                  <strong>New York</strong>, <strong>the Hamptons</strong>, <strong>South Florida</strong>{' '}
                  (Palm Beach, Boca Raton, Miami, Jupiter, Fort Lauderdale, and more), and{' '}
                  <strong>all major NYC airports</strong> (JFK, LGA, and EWR).
                </p>
                
                <div className="bg-gold-50 border border-gold-200 rounded-lg p-6">
                  <h3 className="font-medium text-navy-900 mb-3">We Carry It All</h3>
                  <p className="text-navy-700">
                    Same-day, door-to-door service for <strong>luggage, golf clubs, shopping bags, bikes, 
                    exercise equipment, baby gear, pet supplies, clothing, forgotten items, small furniture, 
                    accessories, and so much more.</strong>
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>
        </section>

        {/* Our Philosophy */}
        <section className="mb-20">
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
            <div>
              <h2 className="text-3xl font-serif font-bold text-navy-900 mb-6">
                We Are Hands-On... So You Can Be Hands-Off
              </h2>
              <div className="space-y-4 text-navy-700">
                <p>
                  <strong>Convenience is a luxury.</strong> Don't want to take everything back with you? 
                  We offer day, weekend, and seasonal storage options – whether it's for a short trip 
                  or winter storage for your summer gear and essentials.
                </p>
                <p>
                  Every family needs a <strong>Mini Move</strong>. Tote Taxi offers the ability to pack 
                  whatever you need and get it quickly to your summer home and back to the city at the 
                  end of the season.
                </p>
                <p>
                  Do you need help packing? We are happy to recommend any one of our packing partners 
                  to ensure a clutter-free summer vacation. We truly tote it all – treating your items 
                  as if they were our own.
                </p>
              </div>
            </div>
            
            <Card variant="elevated">
              <CardContent>
                <div className="text-center">
                  <h3 className="text-xl font-medium text-navy-900 mb-4">
                    A Trusted Luxury Delivery Service
                  </h3>
                  <p className="text-navy-700 mb-6">
                    Our professional same-day luxe courier service is perfect for forgotten or 
                    last-minute items. We also offer an array of <strong>custom services upon request</strong>.
                  </p>
                  <p className="text-navy-600 text-sm">
                    Providing seamless assistance and expert guidance, Tote Taxi elevates the travel experience – the haute courier.
                  </p>
                </div>
              </CardContent>
            </Card>
          </div>
        </section>

        {/* Founder Story */}
        <section className="mb-20">
          <Card variant="luxury">
            <CardHeader>
              <h2 className="text-3xl font-serif font-bold text-navy-900 text-center">
                About Our Founder
              </h2>
            </CardHeader>
            <CardContent>
              <div className="max-w-3xl mx-auto">
                <h3 className="text-xl font-medium text-navy-900 mb-4 text-center">
                  Meet Danielle!
                </h3>
                
                <div className="space-y-4 text-navy-700">
                  <p>
                    Hello! It's a pleasure to meet you.
                  </p>
                  <p>
                    I started this business because I wanted a seamless way to get my suitcase 
                    (which was packed with too many shoes) to and from the Hamptons and NYC.
                  </p>
                  <p>
                    Are you flying with BLADE and need your golf bags waiting for you at Sebonack? 
                    Are you spending a Sunday at Surf Lodge and need a place to store your luggage 
                    for the day? Or, maybe you are spending the summer in the Hamptons and want to 
                    bring your Peloton?
                  </p>
                  <p>
                    Are you in the Hamptons and need a dress delivered to you for an event from 
                    Bergdorf Goodman last minute? Did you leave something small, but absolutely 
                    essential in the city? Let us help!
                  </p>
                  <p>
                    Whatever the case may be, we are here to help get your things where they need 
                    to go and with the utmost professional care.
                  </p>
                  <p className="text-center font-medium text-navy-900">
                    Thank you for the opportunity to serve you – see you at the beach!
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>
        </section>

        {/* Company Timeline */}
        <section className="mb-20">
          <h2 className="text-3xl font-serif font-bold text-navy-900 text-center mb-12">
            Our Journey
          </h2>
          <div className="space-y-8">
            <Card variant="elevated">
              <CardContent>
                <div className="flex items-center">
                  <div className="w-16 h-16 bg-navy-900 text-white rounded-full flex items-center justify-center text-xl font-bold mr-6">
                    2016
                  </div>
                  <div>
                    <h3 className="text-lg font-medium text-navy-900">Founded</h3>
                    <p className="text-navy-700">Danielle Candela founded Tote Taxi to solve the stress of traveling with cumbersome luggage between Manhattan and the Hamptons.</p>
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card variant="elevated">
              <CardContent>
                <div className="flex items-center">
                  <div className="w-16 h-16 bg-navy-900 text-white rounded-full flex items-center justify-center text-xl font-bold mr-6">
                    2018
                  </div>
                  <div>
                    <h3 className="text-lg font-medium text-navy-900">Official Launch</h3>
                    <p className="text-navy-700">Tote Taxi officially launched operations, focusing on convenience, style, and peace of mind for luxury travelers.</p>
                  </div>
                </div>
              </CardContent>
            </Card>

            <Card variant="elevated">
              <CardContent>
                <div className="flex items-center">
                  <div className="w-16 h-16 bg-navy-900 text-white rounded-full flex items-center justify-center text-xl font-bold mr-6">
                    2024
                  </div>
                  <div>
                    <h3 className="text-lg font-medium text-navy-900">Expanded Service</h3>
                    <p className="text-navy-700">Now serving NYC, Hamptons, Connecticut, South Florida, and all major NYC airports with partnerships including BLADE and Cultured Magazine.</p>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        </section>

        {/* CTA */}
        <div className="text-center">
          <h2 className="text-2xl font-serif font-bold text-navy-900 mb-4">
            Ready to Experience Hands-Free Travel?
          </h2>
          <p className="text-navy-700 mb-8 max-w-2xl mx-auto">
            Join thousands of satisfied clients who trust Tote Taxi for seamless delivery service. 
            From forgotten essentials to seasonal moves, we handle it all with professional care.
          </p>
          <div className="flex flex-col sm:flex-row gap-4 justify-center">
            <Link href="/book">
              <Button variant="primary" size="lg">
                Book Your Move
              </Button>
            </Link>
            <Link href="/contact">
              <Button variant="outline" size="lg">
                Contact Our Team
              </Button>
            </Link>
          </div>
        </div>
      </div>
    </MainLayout>
  );
}
```

# ──── frontend/src/app/api/sentry-example-api/route.ts ────

```typescript
import { NextResponse } from "next/server";

export const dynamic = "force-dynamic";
class SentryExampleAPIError extends Error {
  constructor(message: string | undefined) {
    super(message);
    this.name = "SentryExampleAPIError";
  }
}
// A faulty API route to test Sentry's error monitoring
export function GET() {
  throw new SentryExampleAPIError("This error is raised on the backend called by the example page.");
  return NextResponse.json({ data: "Testing Sentry Error..." });
}
```

# ──── frontend/src/app/book/page.tsx ────

```tsx
'use client';
// frontend/src/app/book/page.tsx
import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { BookingWizard } from '@/components/booking';
import { MainLayout } from '@/components/layout/main-layout';
import { Modal } from '@/components/ui/modal';
import { useAuthStore } from '@/stores/auth-store';

export default function BookPage() {
  const [showBookingWizard, setShowBookingWizard] = useState(false);
  const { isAuthenticated } = useAuthStore();
  const router = useRouter();

  useEffect(() => {
    setShowBookingWizard(true);
  }, []);

  const closeBookingWizard = () => {
    setShowBookingWizard(false);
    // Redirect authenticated users to dashboard, guests to home
    if (isAuthenticated) {
      router.push('/dashboard');
    } else {
      router.push('/');
    }
  };

  return (
    <MainLayout>
      <div className="min-h-screen bg-gradient-to-br from-cream-50 to-cream-100 flex items-center justify-center">
        <div className="text-center">
          <h1 className="text-3xl font-serif font-bold text-navy-900 mb-4">
            Book Your Luxury Move
          </h1>
          <p className="text-navy-700">Loading booking wizard...</p>
        </div>
      </div>

      <Modal
        isOpen={showBookingWizard}
        onClose={closeBookingWizard}
        size="xl"
        showCloseButton={true}
        className="max-h-[90vh] overflow-y-auto"
      >
        <div className="bg-gradient-to-br from-cream-50 to-cream-100 min-h-full">
          <BookingWizard onComplete={closeBookingWizard} />
        </div>
      </Modal>
    </MainLayout>
  );
}
```

# ──── frontend/src/app/contact/page.tsx ────

```tsx
// frontend/src/app/contact/page.tsx
'use client';

import { useState, useEffect } from 'react';
import { MainLayout } from '@/components/layout/main-layout';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { apiClient } from '@/lib/api-client';
import Link from 'next/link';
import Script from 'next/script';

declare global {
  interface Window {
    grecaptcha: any;
  }
}

export default function ContactPage() {
  const [formData, setFormData] = useState({
    name: '',
    email: '',
    phone: '',
    subject: '',
    message: '',
    website: '', // Honeypot field
  });

  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitted, setSubmitted] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [recaptchaLoaded, setRecaptchaLoaded] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);
    setError(null);

    try {
      // Check if honeypot field is filled (bot detection)
      if (formData.website) {
        // Silently reject - don't let bots know they failed
        setSubmitted(true);
        return;
      }

      // Get reCAPTCHA token
      let recaptchaToken = '';
      if (recaptchaLoaded && window.grecaptcha) {
        try {
          recaptchaToken = await window.grecaptcha.execute(
            process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY,
            { action: 'contact_form' }
          );
        } catch (recaptchaError) {
          console.error('reCAPTCHA error:', recaptchaError);
          // Continue without token - backend will handle it
        }
      }

      // Submit form with reCAPTCHA token
      await apiClient.post('/api/customer/contact/', {
        ...formData,
        recaptcha_token: recaptchaToken,
      });
      setSubmitted(true);
    } catch (err: any) {
      setError(err.response?.data?.error || 'Failed to send message. Please try again or email us directly.');
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>) => {
    setFormData({
      ...formData,
      [e.target.name]: e.target.value
    });
  };

  if (submitted) {
    return (
      <MainLayout>
        <div className="container mx-auto px-4 py-16">
          <div className="max-w-2xl mx-auto text-center">
            <div className="text-6xl mb-6">📦</div>
            <h1 className="text-3xl font-serif font-bold text-navy-900 mb-6">
              We'll Get Back to You ASAP!
            </h1>
            <Card variant="luxury">
              <CardContent>
                <p className="text-navy-700 mb-6">
                  Your message has been received. Our team will respond within 24 hours 
                  to help with your delivery needs.
                </p>
                <div className="flex flex-col sm:flex-row gap-4 justify-center">
                  <Link href="/book">
                    <Button variant="primary">
                      Book a Delivery
                    </Button>
                  </Link>
                  <Link href="/">
                    <Button variant="outline">
                      Return Home
                    </Button>
                  </Link>
                </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </MainLayout>
    );
  }

  return (
    <>
      <Script
        src={`https://www.google.com/recaptcha/api.js?render=${process.env.NEXT_PUBLIC_RECAPTCHA_SITE_KEY}`}
        onLoad={() => setRecaptchaLoaded(true)}
        strategy="lazyOnload"
      />
      <MainLayout>
        <div className="container mx-auto px-4 py-16">
        {/* Hero Section */}
        <div className="text-center mb-16">
          <h1 className="text-4xl md:text-5xl font-serif font-bold text-navy-900 mb-6">
            Contact Us
          </h1>
          <p className="text-xl text-navy-700 max-w-3xl mx-auto mb-4">
            Have questions about our services? Our team is here to help.
          </p>
          <p className="text-lg text-navy-600">
            Be sure to check out our <Link href="/faq" className="text-navy-900 hover:underline font-medium">FAQ</Link> for quick answers.
          </p>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-12">
          {/* Contact Form */}
          <div>
            <Card variant="elevated">
              <CardHeader>
                <h2 className="text-2xl font-serif font-bold text-navy-900">
                  Send Us a Message
                </h2>
                <p className="text-navy-700">
                  Fill out the form below and we'll respond within 24 hours.
                </p>
              </CardHeader>
              <CardContent>
                {error && (
                  <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                    {error}
                  </div>
                )}
                
                <form onSubmit={handleSubmit} className="space-y-6">
                  {/* Full Name */}
                  <div>
                    <label htmlFor="name" className="block text-sm font-medium text-navy-900 mb-1">
                      Full Name <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      id="name"
                      name="name"
                      value={formData.name}
                      onChange={handleChange}
                      required
                      placeholder="Your Name"
                      className="w-full px-4 py-3 text-base border border-gray-300 rounded-md shadow-sm focus:border-navy-500 focus:ring-navy-500 text-gray-900 bg-white"
                    />
                  </div>

                  {/* Email */}
                  <div>
                    <label htmlFor="email" className="block text-sm font-medium text-navy-900 mb-1">
                      Email Address <span className="text-red-500">*</span>
                    </label>
                    <input
                      type="email"
                      id="email"
                      name="email"
                      value={formData.email}
                      onChange={handleChange}
                      required
                      placeholder="you@email.com"
                      className="w-full px-4 py-3 text-base border border-gray-300 rounded-md shadow-sm focus:border-navy-500 focus:ring-navy-500 text-gray-900 bg-white"
                    />
                  </div>

                  {/* Phone */}
                  <div>
                    <label htmlFor="phone" className="block text-sm font-medium text-navy-900 mb-1">
                      Phone Number (Optional)
                    </label>
                    <input
                      type="tel"
                      id="phone"
                      name="phone"
                      value={formData.phone}
                      onChange={handleChange}
                      placeholder="(631) 555-1234"
                      className="w-full px-4 py-3 text-base border border-gray-300 rounded-md shadow-sm focus:border-navy-500 focus:ring-navy-500 text-gray-900 bg-white"
                    />
                  </div>

                  {/* Subject */}
                  <div>
                    <label htmlFor="subject" className="block text-sm font-medium text-navy-900 mb-1">
                      Subject <span className="text-red-500">*</span>
                    </label>
                    <select
                      id="subject"
                      name="subject"
                      value={formData.subject}
                      onChange={handleChange}
                      required
                      className="w-full px-4 py-3 text-base border border-gray-300 rounded-md shadow-sm focus:border-navy-500 focus:ring-navy-500 text-gray-900 bg-white"
                    >
                      <option value="">Select a subject</option>
                      <option value="General">General Inquiry</option>
                      <option value="Booking Question">Booking Question</option>
                      <option value="BLADE">BLADE Airport Transfer</option>
                      <option value="Custom Quote">Custom Quote</option>
                      <option value="Issue">Issue with Service</option>
                      <option value="Other">Other</option>
                    </select>
                  </div>

                  {/* Message */}
                  <div>
                    <label htmlFor="message" className="block text-sm font-medium text-navy-900 mb-1">
                      Message <span className="text-red-500">*</span>
                    </label>
                    <textarea
                      id="message"
                      name="message"
                      value={formData.message}
                      onChange={handleChange}
                      required
                      rows={5}
                      placeholder="Tell us about your needs..."
                      className="w-full px-4 py-3 text-base border border-gray-300 rounded-md shadow-sm focus:border-navy-500 focus:ring-navy-500 text-gray-900 bg-white resize-vertical"
                    />
                  </div>

                  {/* Honeypot field - hidden from humans, visible to bots */}
                  <div className="absolute left-[-9999px]" aria-hidden="true">
                    <label htmlFor="website">
                      Website (leave blank)
                    </label>
                    <input
                      type="text"
                      id="website"
                      name="website"
                      value={formData.website}
                      onChange={handleChange}
                      tabIndex={-1}
                      autoComplete="off"
                    />
                  </div>

                  <Button
                    type="submit"
                    variant="primary"
                    size="lg"
                    disabled={isSubmitting}
                    className="w-full"
                  >
                    {isSubmitting ? 'Sending...' : 'Send Message'}
                  </Button>
                </form>
              </CardContent>
            </Card>
          </div>

          {/* Contact Information */}
          <div className="space-y-8">
            {/* Direct Contact */}
            <Card variant="luxury">
              <CardHeader>
                <h3 className="text-xl font-serif font-bold text-navy-900">
                  Get in Touch Directly
                </h3>
              </CardHeader>
              <CardContent>
                <div className="space-y-6">
                  <div>
                    <h4 className="font-medium text-navy-900 mb-2">Email</h4>
                    <p className="text-navy-700">
                      <a href="mailto:info@totetaxi.com" className="hover:underline text-lg">
                        info@totetaxi.com
                      </a>
                    </p>
                  </div>

                  <div>
                    <h4 className="font-medium text-navy-900 mb-2">Phone</h4>
                    <p className="text-navy-700">
                      <a href="tel:+16315955100" className="hover:underline text-lg">
                        (631) 595-5100
                      </a>
                    </p>
                    <p className="text-sm text-navy-600 mt-1">
                      Available for immediate assistance
                    </p>
                  </div>

                  <div>
                    <h4 className="font-medium text-navy-900 mb-2">Business Hours</h4>
                    <p className="text-navy-700 text-sm">
                      Monday - Friday: 8 AM - 6 PM EST<br />
                      Saturday - Sunday: 9 AM - 5 PM EST
                    </p>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Service Areas */}
            <Card variant="elevated">
              <CardHeader>
                <h3 className="text-xl font-serif font-bold text-navy-900">
                  Our Service Areas
                </h3>
              </CardHeader>
              <CardContent>
                <p className="text-navy-700 mb-4">
                  <strong>Tote Taxi provides premium delivery service</strong> covering:
                </p>
                <ul className="space-y-2 text-navy-700">
                  <li>• <strong>Manhattan</strong> ↔ <strong>The Hamptons</strong></li>
                  <li>• <strong>Manhattan</strong> ↔ <strong>North Fork</strong></li>
                  <li>• <strong>Manhattan</strong> ↔ <strong>Connecticut</strong></li>
                  <li>• <strong>NYC Airports</strong> (JFK, LGA, EWR)</li>
                </ul>
                <p className="text-sm text-navy-600 mt-4">
                  <strong>Extended service available</strong> within 30 miles of Manhattan for an additional fee.
                </p>
              </CardContent>
            </Card>

            {/* Quick Booking CTA */}
            <Card variant="luxury">
              <CardContent>
                <div className="text-center">
                  <h3 className="text-lg font-medium text-navy-900 mb-3">
                    Ready to Book?
                  </h3>
                  <p className="text-navy-700 text-sm mb-4">
                    Skip the contact form and start your delivery booking directly.
                  </p>
                  <Link href="/book">
                    <Button variant="primary" className="w-full">
                      Book Now
                    </Button>
                  </Link>
                </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
      </MainLayout>
    </>
  );
}
```

# ──── frontend/src/app/dashboard/page.tsx ────

```tsx
// frontend/src/app/dashboard/page.tsx  
'use client';

import { useEffect, Suspense } from 'react';
import { useAuthStore } from '@/stores/auth-store';
import { useRouter, useSearchParams } from 'next/navigation';
import { MainLayout } from '@/components/layout/main-layout';
import { DashboardOverview } from '@/components/dashboard/dashboard-overview';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';

function DashboardContent() {
  const { user, isAuthenticated } = useAuthStore();
  const router = useRouter();
  const searchParams = useSearchParams();
  const isWelcome = searchParams.get('welcome') === 'true';

  useEffect(() => {
    if (!isAuthenticated) {
      router.push('/login');
    }
  }, [isAuthenticated, router]);

  if (!isAuthenticated || !user) {
    return (
      <MainLayout>
        <div className="min-h-screen bg-gradient-to-br from-cream-50 to-cream-100 flex items-center justify-center">
          <div className="text-navy-700">Loading...</div>
        </div>
      </MainLayout>
    );
  }

  return (
    <MainLayout>
      <div className="min-h-screen bg-gradient-to-br from-cream-50 to-cream-100 py-12">
        <div className="container mx-auto px-4 max-w-6xl">
          {/* Welcome Banner for New Users */}
          {isWelcome && (
            <Card variant="luxury" className="mb-8 border-gold-200 bg-gradient-to-r from-gold-50 to-cream-50">
              <CardContent className="p-8 text-center">
                <h2 className="text-2xl font-serif font-bold text-navy-900 mb-3">
                  Welcome to ToteTaxi, {user.first_name}! 🎉
                </h2>
                <p className="text-navy-700 mb-6 max-w-2xl mx-auto">
                  Your account is ready. Experience white-glove moving and delivery service.
                </p>
                <Button 
                  variant="primary" 
                  size="lg"
                  onClick={() => router.push('/book')}
                >
                  Book Your First Move
                </Button>
              </CardContent>
            </Card>
          )}

          {/* Header */}
          <div className="mb-8">
            <h1 className="text-4xl font-serif font-bold text-navy-900 mb-2">
              Welcome back, {user.first_name}!
            </h1>
            <p className="text-navy-600">
              Your ToteTaxi dashboard
            </p>
          </div>

          {/* Dashboard Content */}
          <DashboardOverview />

          {/* Quick Actions */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
            <Card className="hover:shadow-lg transition-shadow">
              <CardContent className="p-8 text-center">
                <div className="text-4xl mb-4">🚚</div>
                <h3 className="text-xl font-semibold text-navy-900 mb-3">
                  Book a Move
                </h3>
                <p className="text-sm text-navy-600 mb-6">
                  Schedule your next luxury delivery
                </p>
                <Button 
                  variant="primary" 
                  onClick={() => router.push('/book')}
                  className="w-full"
                >
                  Book Now
                </Button>
              </CardContent>
            </Card>

            <Card className="hover:shadow-lg transition-shadow">
              <CardContent className="p-8 text-center">
                <div className="text-4xl mb-4">📍</div>
                <h3 className="text-xl font-semibold text-navy-900 mb-3">
                  Manage Addresses
                </h3>
                <p className="text-sm text-navy-600 mb-6">
                  Save locations for faster booking
                </p>
                <Button 
                  variant="outline" 
                  className="w-full"
                  onClick={() => alert('Address management coming soon!')}
                >
                  Manage Addresses
                </Button>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </MainLayout>
  );
}

export default function DashboardPage() {
  return (
    <Suspense fallback={
      <MainLayout>
        <div className="min-h-screen bg-gradient-to-br from-cream-50 to-cream-100 flex items-center justify-center">
          <div className="text-navy-700">Loading...</div>
        </div>
      </MainLayout>
    }>
      <DashboardContent />
    </Suspense>
  );
}
```

# ──── frontend/src/app/dashboard/bookings/page.tsx ────

```tsx
// frontend/src/app/dashboard/bookings/page.tsx
'use client';

import { useEffect } from 'react';
import { useAuthStore } from '@/stores/auth-store';
import { useRouter } from 'next/navigation';
import { MainLayout } from '@/components/layout/main-layout';
import { BookingHistory } from '@/components/dashboard/booking-history';
import { Button } from '@/components/ui/button';
import { ArrowLeftIcon } from '@heroicons/react/24/outline';

export default function BookingHistoryPage() {
  const { isAuthenticated } = useAuthStore();
  const router = useRouter();

  useEffect(() => {
    if (!isAuthenticated) {
      router.push('/login');
    }
  }, [isAuthenticated, router]);

  if (!isAuthenticated) {
    return null;
  }

  return (
    <MainLayout>
      <div className="min-h-screen bg-gradient-to-br from-cream-50 to-cream-100 py-8">
        <div className="container mx-auto px-4 max-w-6xl">
          {/* Back Button */}
          <Button
            variant="ghost"
            onClick={() => router.push('/dashboard')}
            className="mb-6"
          >
            <ArrowLeftIcon className="h-4 w-4 mr-2" />
            Back to Dashboard
          </Button>

          <BookingHistory />
        </div>
      </div>
    </MainLayout>
  );
}
```

# ──── frontend/src/app/dashboard/bookings/[id]/page.tsx ────

```tsx
'use client';

import { useEffect } from 'react';
import { useQuery } from '@tanstack/react-query';
import { useParams, useRouter } from 'next/navigation';
import { useAuthStore } from '@/stores/auth-store';
import { apiClient } from '@/lib/api-client';
import { MainLayout } from '@/components/layout/main-layout';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import type { BookingWithTracking } from '@/types';
import { 
  ArrowLeftIcon, 
  MapPinIcon,
  CalendarIcon,
  ClockIcon,
  CurrencyDollarIcon,
  TruckIcon,
  InformationCircleIcon
} from '@heroicons/react/24/outline';

export default function BookingDetailPage() {
  const params = useParams();
  const router = useRouter();
  const { isAuthenticated } = useAuthStore();
  const bookingId = params.id as string;

  useEffect(() => {
    if (!isAuthenticated) {
      router.push('/login');
    }
  }, [isAuthenticated, router]);

  const { data: booking, isLoading, error } = useQuery<BookingWithTracking>({
    queryKey: ['booking', bookingId],
    queryFn: async () => {
      const response = await apiClient.get(`/api/customer/bookings/${bookingId}/`);
      return response.data;
    },
    enabled: isAuthenticated && !!bookingId
  });

  if (isLoading || !isAuthenticated) {
    return (
      <MainLayout>
        <div className="min-h-screen flex items-center justify-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-navy-900"></div>
        </div>
      </MainLayout>
    );
  }

  if (error || !booking) {
    return (
      <MainLayout>
        <div className="container mx-auto px-4 py-16">
          <Card>
            <CardContent className="text-center py-12">
              <p className="text-red-600 mb-4">Failed to load booking details</p>
              <Button onClick={() => router.push('/dashboard')}>
                Return to Dashboard
              </Button>
            </CardContent>
          </Card>
        </div>
      </MainLayout>
    );
  }

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed': return 'bg-green-100 text-green-800';
      case 'paid': return 'bg-blue-100 text-blue-800';
      case 'confirmed': return 'bg-purple-100 text-purple-800';
      case 'pending': return 'bg-amber-100 text-amber-800';
      case 'cancelled': return 'bg-red-100 text-red-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  const getTaskStatusBadge = (status: string) => {
    switch (status) {
      case 'created':
        return <span className="text-xs bg-gray-100 text-gray-700 px-2 py-0.5 rounded">Unassigned</span>;
      case 'assigned':
        return <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded">Driver Assigned</span>;
      case 'active':
        return (
          <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded inline-flex items-center gap-1">
            <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
            In Progress
          </span>
        );
      case 'completed':
        return <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">✓ Completed</span>;
      case 'failed':
        return <span className="text-xs bg-red-100 text-red-700 px-2 py-0.5 rounded">Failed</span>;
      default:
        return null;
    }
  };

  const pickupTask = booking.onfleet_tasks?.find(t => t.task_type === 'pickup');
  const dropoffTask = booking.onfleet_tasks?.find(t => t.task_type === 'dropoff');
  const hasAnyActiveTask = booking.onfleet_tasks?.some(t => t.status === 'active') || false;

  return (
    <MainLayout>
      <div className="container mx-auto px-4 py-8">
        <div className="mb-6">
          <Button 
            variant="ghost" 
            size="sm"
            onClick={() => router.push('/dashboard')}
            className="mb-4"
          >
            <ArrowLeftIcon className="w-4 h-4 mr-2" />
            Back to Dashboard
          </Button>
          
          <div className="flex justify-between items-start">
            <div>
              <h1 className="text-3xl font-serif font-bold text-navy-900">
                Booking #{booking.booking_number}
              </h1>
              <p className="text-navy-600 mt-2">
                {booking.service_type.replace('_', ' ').toUpperCase()}
              </p>
            </div>
            
            <span className={`px-4 py-2 rounded-full text-sm font-medium ${getStatusColor(booking.status)}`}>
              {booking.status.toUpperCase()}
            </span>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="lg:col-span-2 space-y-6">
            {booking.onfleet_tasks && booking.onfleet_tasks.length > 0 && (
              <Card>
                <CardHeader>
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <TruckIcon className="w-5 h-5 text-navy-600" />
                      <h3 className="text-lg font-medium text-navy-900">Delivery Tracking</h3>
                    </div>
                    {hasAnyActiveTask && (
                      <span className="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full inline-flex items-center gap-1">
                        <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        Live Tracking Available
                      </span>
                    )}
                  </div>
                </CardHeader>
                <CardContent className="space-y-6">
                  <div className="bg-amber-50 border border-amber-200 rounded-lg p-4">
                    <div className="flex items-start gap-3">
                      <InformationCircleIcon className="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" />
                      <div className="flex-1">
                        <h4 className="font-semibold text-amber-900 text-sm mb-1">
                          📍 Live Tracking Information
                        </h4>
                        <p className="text-xs text-amber-800">
                          Tracking links become active when your driver starts each task. 
                          You&apos;ll receive SMS notifications when pickup and delivery begin.
                        </p>
                      </div>
                    </div>
                  </div>

                  {pickupTask && (
                    <div className="border-l-4 border-blue-500 pl-4 py-2">
                      <div className="flex items-center justify-between mb-3">
                        <div>
                          <div className="flex items-center gap-2 mb-1">
                            <span className="text-gray-700 font-medium">📦 Pickup</span>
                            {getTaskStatusBadge(pickupTask.status)}
                          </div>
                          {pickupTask.worker_name && (
                            <p className="text-sm text-gray-600">Driver: {pickupTask.worker_name}</p>
                          )}
                        </div>
                        
                        {pickupTask.tracking_url && (
                          <a
                            href={pickupTask.tracking_url}
                            target="_blank"
                            rel="noopener noreferrer"
                            className={`inline-flex items-center gap-2 px-4 py-2 rounded-lg transition-colors ${
                              pickupTask.status === 'active'
                                ? 'bg-blue-600 text-white hover:bg-blue-700'
                                : 'bg-blue-100 text-blue-700 hover:bg-blue-200'
                            }`}
                          >
                            Track Pickup →
                          </a>
                        )}
                      </div>
                      
                      {pickupTask.status === 'created' && (
                        <p className="text-xs text-gray-500 italic">
                          Waiting for driver assignment
                        </p>
                      )}
                      {pickupTask.status === 'assigned' && (
                        <p className="text-xs text-gray-500 italic">
                          Driver assigned. Tracking available once task starts.
                        </p>
                      )}
                      {pickupTask.status === 'active' && (
                        <p className="text-xs text-green-600 font-medium">
                          🚗 Driver is on the way! Click above for live tracking.
                        </p>
                      )}
                      {pickupTask.status === 'completed' && pickupTask.completed_at && (
                        <p className="text-xs text-gray-500">
                          Completed: {new Date(pickupTask.completed_at).toLocaleString()}
                        </p>
                      )}
                    </div>
                  )}

                  {dropoffTask && (
                    <div className="border-l-4 border-green-500 pl-4 py-2">
                      <div className="flex items-center justify-between mb-3">
                        <div>
                          <div className="flex items-center gap-2 mb-1">
                            <span className="text-gray-700 font-medium">
                              {booking.service_type === 'blade_transfer' ? '🚁 BLADE Delivery' : '🚚 Delivery'}
                            </span>
                            {getTaskStatusBadge(dropoffTask.status)}
                          </div>
                          {dropoffTask.worker_name && (
                            <p className="text-sm text-gray-600">Driver: {dropoffTask.worker_name}</p>
                          )}
                        </div>
                        
                        {dropoffTask.tracking_url && (
                          <a
                            href={dropoffTask.tracking_url}
                            target="_blank"
                            rel="noopener noreferrer"
                            className={`inline-flex items-center gap-2 px-4 py-2 rounded-lg transition-colors ${
                              dropoffTask.status === 'active'
                                ? 'bg-green-600 text-white hover:bg-green-700'
                                : 'bg-green-100 text-green-700 hover:bg-green-200'
                            }`}
                          >
                            Track Delivery →
                          </a>
                        )}
                      </div>
                      
                      {dropoffTask.status === 'created' && (
                        <p className="text-xs text-gray-500 italic">
                          Waiting for driver assignment
                        </p>
                      )}
                      {dropoffTask.status === 'assigned' && pickupTask?.status !== 'completed' && (
                        <p className="text-xs text-gray-500 italic">
                          Available after pickup is completed
                        </p>
                      )}
                      {dropoffTask.status === 'assigned' && pickupTask?.status === 'completed' && (
                        <p className="text-xs text-gray-500 italic">
                          Driver assigned. Tracking available once delivery starts.
                        </p>
                      )}
                      {dropoffTask.status === 'active' && (
                        <p className="text-xs text-green-600 font-medium">
                          🚗 Driver is delivering now! Click above for live tracking.
                        </p>
                      )}
                      {dropoffTask.status === 'completed' && dropoffTask.completed_at && (
                        <p className="text-xs text-gray-500">
                          Delivered: {new Date(dropoffTask.completed_at).toLocaleString()}
                        </p>
                      )}
                    </div>
                  )}

                  <div className="p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <p className="text-sm text-gray-700">
                      <strong>📱 SMS Notifications:</strong> You&apos;ll receive text updates when your driver 
                      starts pickup and delivery tasks.
                    </p>
                  </div>
                </CardContent>
              </Card>
            )}
            
            <Card>
              <CardHeader>
                <h3 className="text-lg font-medium text-navy-900">Service Details</h3>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="flex items-start space-x-3">
                  <CalendarIcon className="w-5 h-5 text-navy-600 mt-0.5" />
                  <div>
                    <p className="text-sm font-medium text-navy-900">Pickup Date</p>
                    <p className="text-navy-700">
                      {new Date(booking.pickup_date + 'T00:00:00').toLocaleDateString('en-US', {        
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                      })}
                    </p>
                  </div>
                </div>
                
                <div className="flex items-start space-x-3">
                  <ClockIcon className="w-5 h-5 text-navy-600 mt-0.5" />
                  <div>
                    <p className="text-sm font-medium text-navy-900">Pickup Time</p>
                    <p className="text-navy-700">{booking.pickup_time}</p>
                  </div>
                </div>
                
                {booking.special_instructions && (
                  <div className="border-t pt-3">
                    <p className="text-sm font-medium text-navy-900 mb-1">Special Instructions</p>
                    <p className="text-navy-700 text-sm">{booking.special_instructions}</p>
                  </div>
                )}
                
                <div className="flex flex-wrap gap-2 pt-2">
                  {booking.coi_required && (
                    <span className="px-3 py-1 bg-orange-100 text-orange-800 text-xs font-medium rounded-full">
                      COI Required
                    </span>
                  )}
                </div>
              </CardContent>
            </Card>
            
            <Card>
              <CardHeader>
                <h3 className="text-lg font-medium text-navy-900">Addresses</h3>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <div className="flex items-center space-x-2 mb-2">
                      <MapPinIcon className="w-5 h-5 text-blue-600" />
                      <h4 className="font-medium text-navy-900">Pickup</h4>
                    </div>
                    <div className="text-navy-700 text-sm">
                      <p>{booking.pickup_address.address_line_1}</p>
                      {booking.pickup_address.address_line_2 && (
                        <p>{booking.pickup_address.address_line_2}</p>
                      )}
                      <p>
                        {booking.pickup_address.city}, {booking.pickup_address.state}{' '}
                        {booking.pickup_address.zip_code}
                      </p>
                    </div>
                  </div>
                  
                  <div>
                    <div className="flex items-center space-x-2 mb-2">
                      <MapPinIcon className="w-5 h-5 text-green-600" />
                      <h4 className="font-medium text-navy-900">
                        {booking.service_type === 'blade_transfer' ? 'BLADE Delivery' : 'Delivery'}
                      </h4>
                    </div>
                    <div className="text-navy-700 text-sm">
                      <p>{booking.delivery_address.address_line_1}</p>
                      {booking.delivery_address.address_line_2 && (
                        <p>{booking.delivery_address.address_line_2}</p>
                      )}
                      <p>
                        {booking.delivery_address.city}, {booking.delivery_address.state}{' '}
                        {booking.delivery_address.zip_code}
                      </p>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
          
          <div className="space-y-6">
            <Card>
              <CardHeader>
                <div className="flex items-center space-x-2">
                  <CurrencyDollarIcon className="w-5 h-5 text-navy-600" />
                  <h3 className="text-lg font-medium text-navy-900">Pricing</h3>
                </div>
              </CardHeader>
              <CardContent>
                <div className="space-y-2 text-sm">
                  {(booking.pricing_breakdown?.base_price_dollars ?? 0) > 0 && (
                    <div className="flex justify-between">
                      <span className="text-navy-700">Base Price:</span>
                      <span className="font-medium text-navy-900">
                        ${(booking.pricing_breakdown?.base_price_dollars ?? 0).toFixed(2)}
                      </span>
                    </div>
                  )}
                  
                  {(booking.pricing_breakdown?.surcharge_dollars ?? 0) > 0 && (
                    <div className="flex justify-between">
                      <span className="text-navy-700">Surcharges:</span>
                      <span className="font-medium text-navy-900">
                        ${(booking.pricing_breakdown?.surcharge_dollars ?? 0).toFixed(2)}
                      </span>
                    </div>
                  )}
                  
                  {(booking.pricing_breakdown?.coi_fee_dollars ?? 0) > 0 && (
                    <div className="flex justify-between">
                      <span className="text-navy-700">COI Fee:</span>
                      <span className="font-medium text-navy-900">
                        ${(booking.pricing_breakdown?.coi_fee_dollars ?? 0).toFixed(2)}
                      </span>
                    </div>
                  )}

                  {(booking.pricing_breakdown?.same_day_surcharge_dollars ?? 0) > 0 && (
                    <div className="flex justify-between">
                      <span className="text-navy-700">Same-Day Delivery:</span>
                      <span className="font-medium text-navy-900">
                        +${booking.pricing_breakdown.same_day_surcharge_dollars.toFixed(2)}
                      </span>
                    </div>
                  )}

                  {(booking.pricing_breakdown?.organizing_total_dollars ?? 0) > 0 && (
                    <div className="flex justify-between">
                      <span className="text-navy-700">Organizing Services:</span>
                      <span className="font-medium text-navy-900">
                        +${booking.pricing_breakdown.organizing_total_dollars.toFixed(2)}
                      </span>
                    </div>
                  )}

                  {(booking.pricing_breakdown?.geographic_surcharge_dollars ?? 0) > 0 && (
                    <div className="flex justify-between">
                      <span className="text-navy-700">Geographic Surcharge:</span>
                      <span className="font-medium text-navy-900">
                        +${booking.pricing_breakdown.geographic_surcharge_dollars.toFixed(2)}
                      </span>
                    </div>
                  )}

                  {(booking.pricing_breakdown?.time_window_surcharge_dollars ?? 0) > 0 && (
                    <div className="flex justify-between">
                      <span className="text-navy-700">Time Window Surcharge:</span>
                      <span className="font-medium text-navy-900">
                        +${booking.pricing_breakdown.time_window_surcharge_dollars.toFixed(2)}
                      </span>
                    </div>
                  )}

                  {(booking.pricing_breakdown?.discount_amount_dollars ?? 0) > 0 && (
                    <>
                      <div className="flex justify-between border-t pt-2 mt-2">
                        <span className="text-navy-700">Subtotal:</span>
                        <span className="font-medium text-navy-900">
                          ${booking.pricing_breakdown.pre_discount_total_dollars.toFixed(2)}
                        </span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-green-700">
                          Discount ({booking.pricing_breakdown.discount_description || booking.pricing_breakdown.discount_code}):
                        </span>
                        <span className="font-medium text-green-700">
                          -${booking.pricing_breakdown.discount_amount_dollars.toFixed(2)}
                        </span>
                      </div>
                    </>
                  )}

                  <div className={`pt-2 mt-2 ${(booking.pricing_breakdown?.discount_amount_dollars ?? 0) > 0 ? '' : 'border-t'}`}>
                    <div className="flex justify-between text-lg">
                      <span className="font-bold text-navy-900">Total:</span>
                      <span className="font-bold text-navy-900">
                        ${booking.total_price_dollars.toFixed(2)}
                      </span>
                    </div>
                  </div>
                </div>
                
                <div className="mt-4 pt-4 border-t">
                  <p className="text-xs text-navy-600">
                    Booked on {new Date(booking.created_at).toLocaleDateString()}
                  </p>
                </div>
              </CardContent>
            </Card>
            
            {booking.can_rebook && (
              <Button
                variant="outline"
                className="w-full"
                onClick={() => router.push(`/book?rebook=${booking.id}`)}
              >
                Book Again
              </Button>
            )}
          </div>
        </div>
      </div>
    </MainLayout>
  );
}
```

# ──── frontend/src/app/dashboard/settings/page.tsx ────

```tsx
// frontend/src/app/dashboard/settings/page.tsx
'use client';

import { useState, useEffect } from 'react';
import { useAuthStore } from '@/stores/auth-store';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { apiClient } from '@/lib/api-client';
import { MainLayout } from '@/components/layout/main-layout';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { useRouter } from 'next/navigation';
import { ArrowLeftIcon, CheckCircleIcon } from '@heroicons/react/24/outline';

// Phone number formatting utility
const formatPhoneNumber = (value: string): string => {
  // Remove all non-digits
  const numbers = value.replace(/\D/g, '');
  
  // Format as (XXX)XXX-XXXX
  if (numbers.length === 0) return '';
  if (numbers.length <= 3) return `(${numbers}`;
  if (numbers.length <= 6) return `(${numbers.slice(0, 3)})${numbers.slice(3)}`;
  return `(${numbers.slice(0, 3)})${numbers.slice(3, 6)}-${numbers.slice(6, 10)}`;
};

// Extract just numbers for API
const unformatPhoneNumber = (formatted: string): string => {
  return formatted.replace(/\D/g, '');
};

export default function SettingsPage() {
  const { user, customerProfile, isAuthenticated, updateProfile } = useAuthStore();
  const router = useRouter();
  const queryClient = useQueryClient();

  const [phone, setPhone] = useState('');
  const [showSuccess, setShowSuccess] = useState(false);
  const [hasChanges, setHasChanges] = useState(false);

  // Initialize phone from customer profile
  useEffect(() => {
    if (customerProfile?.phone) {
      setPhone(formatPhoneNumber(customerProfile.phone));
    }
  }, [customerProfile]);

  // Check if phone has changed
  useEffect(() => {
    if (!customerProfile) return;
    
    const currentPhone = unformatPhoneNumber(phone);
    const originalPhone = customerProfile.phone?.replace(/\D/g, '') || '';
    
    setHasChanges(currentPhone !== originalPhone && currentPhone.length === 10);
  }, [phone, customerProfile]);

  const handlePhoneChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const formatted = formatPhoneNumber(e.target.value);
    setPhone(formatted);
  };

  const updateProfileMutation = useMutation({
    mutationFn: async (phoneNumber: string) => {
      const response = await apiClient.patch('/api/customer/profile/', {
        phone: phoneNumber
      });
      return response.data;
    },
    onSuccess: (data) => {
      queryClient.invalidateQueries({ queryKey: ['customer', 'dashboard'] });
      queryClient.invalidateQueries({ queryKey: ['customer', 'profile'] });
      
      if (data.customer_profile) {
        updateProfile(data.customer_profile);
      }
      
      setShowSuccess(true);
      setHasChanges(false);
      setTimeout(() => setShowSuccess(false), 3000);
    },
    onError: (error: any) => {
      const errorMessage = error.response?.data?.error || 'Failed to update phone number. Please try again.';
      alert(errorMessage);
    },
  });

  const handleSave = () => {
    if (!hasChanges) return;
    
    const phoneNumbers = unformatPhoneNumber(phone);
    
    // Validate phone number
    if (phoneNumbers.length !== 10) {
      alert('Please enter a valid 10-digit phone number');
      return;
    }
    
    updateProfileMutation.mutate(phoneNumbers);
  };

  const handleReset = () => {
    if (customerProfile?.phone) {
      setPhone(formatPhoneNumber(customerProfile.phone));
    } else {
      setPhone('');
    }
  };

  useEffect(() => {
    if (!isAuthenticated) {
      router.push('/login');
    }
  }, [isAuthenticated, router]);

  if (!isAuthenticated || !user) {
    return null;
  }

  return (
    <MainLayout>
      <div className="min-h-screen bg-gradient-to-br from-cream-50 to-cream-100 py-8">
        <div className="container mx-auto px-4 max-w-2xl">
          {/* Header */}
          <div className="mb-8">
            <Button
              variant="ghost"
              onClick={() => router.push('/dashboard')}
              className="mb-4"
            >
              <ArrowLeftIcon className="h-4 w-4 mr-2" />
              Back to Dashboard
            </Button>
            <h1 className="text-3xl font-serif font-bold text-navy-900">
              Account Settings
            </h1>
            <p className="text-navy-600 mt-1">
              Manage your account information
            </p>
          </div>

          {/* Success Message */}
          {showSuccess && (
            <Card className="mb-6 border-green-200 bg-green-50">
              <CardContent className="p-4 flex items-center">
                <CheckCircleIcon className="h-5 w-5 text-green-600 mr-3" />
                <p className="text-green-800 font-medium">Phone number updated successfully!</p>
              </CardContent>
            </Card>
          )}

          {/* Personal Information */}
          <Card className="mb-6">
            <CardHeader>
              <h2 className="text-xl font-semibold text-navy-900">Personal Information</h2>
              <p className="text-sm text-navy-600 mt-1">
                Your account details
              </p>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-navy-700 mb-1">
                    First Name
                  </label>
                  <Input
                    value={user.first_name || ''}
                    disabled
                    className="bg-gray-50 text-gray-600 cursor-not-allowed"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-navy-700 mb-1">
                    Last Name
                  </label>
                  <Input
                    value={user.last_name || ''}
                    disabled
                    className="bg-gray-50 text-gray-600 cursor-not-allowed"
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-navy-700 mb-1">
                  Email Address
                </label>
                <Input
                  value={user.email || ''}
                  disabled
                  className="bg-gray-50 text-gray-600 cursor-not-allowed"
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-navy-700 mb-1">
                  Phone Number
                </label>
                <Input
                  type="tel"
                  value={phone}
                  onChange={handlePhoneChange}
                  placeholder="(123)456-7890"
                  maxLength={13}
                  className="focus:ring-navy-500 focus:border-navy-500"
                />
                <p className="text-xs text-navy-500 mt-1">
                  Format: (123)456-7890
                </p>
              </div>

              <div className="pt-4 border-t border-gray-200">
                <p className="text-sm text-navy-600">
                  <strong>Need to change your name or email?</strong>
                  <br />
                  Contact support at{' '}
                  <a 
                    href="mailto:support@totetaxi.com" 
                    className="text-blue-600 hover:underline font-medium"
                  >
                    support@totetaxi.com
                  </a>
                </p>
              </div>
            </CardContent>
          </Card>

          {/* Action Buttons */}
          <div className="flex items-center justify-between gap-4">
            <Button
              variant="outline"
              onClick={handleReset}
              disabled={!hasChanges || updateProfileMutation.isPending}
            >
              Reset
            </Button>
            <Button
              variant="primary"
              onClick={handleSave}
              disabled={!hasChanges || updateProfileMutation.isPending}
              className="min-w-[150px]"
            >
              {updateProfileMutation.isPending ? 'Saving...' : 'Save Changes'}
            </Button>
          </div>
        </div>
      </div>
    </MainLayout>
  );
}
```

# ──── frontend/src/app/faq/page.tsx ────

```tsx
// frontend/src/app/faq/page.tsx - Real Tote Taxi FAQ content
'use client';

import { useState } from 'react';
import { MainLayout } from '@/components/layout/main-layout';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import Link from 'next/link';

interface FAQItem {
  question: string;
  answer: string;
  category: 'general' | 'service' | 'mini-moves' | 'booking';
}

const faqData: FAQItem[] = [
  // General
  {
    category: 'general',
    question: 'What areas do you currently service?',
    answer: 'We currently service the Hamptons, NYC and surrounding areas (by zipcode), and South Florida (by zipcode). If you don\'t see your zipcode or location listed as an option, you can always contact us for a custom quote. Certain zip codes surrounding our service areas may be an additional fee.'
  },
  {
    category: 'general',
    question: 'Do you handle airport baggage transportation?',
    answer: 'Yes. We deliver to JFK, LGA, EWR & Westchester FBO\'s. Please contact us for specific arrangements.'
  },
  {
    category: 'general',
    question: 'What about insurance coverage?',
    answer: 'Our total liability for items lost or damaged is half the purchase price of each item up to $150. For additional coverage, $100 extra covers your order for $1,000. TOTE TAXI assumes no responsibility for: money, negotiable papers, securities, business documents, irreplaceable books, manuscripts, photographic or electronic equipment, computers, jewelry, watches, eyeglasses, silverware, china, precious metals, heirlooms, furs, tobacco products, antiques, artifacts, paintings and other works of art, medicines, human organs, commercial items, cosmetics, samples, or any similar valuable or fragile items.'
  },
  {
    category: 'general',
    question: 'Do I need to tip the driver?',
    answer: 'Tipping is not required, but is greatly appreciated by the drivers.'
  },
  {
    category: 'general',
    question: 'Do you offer any discounts?',
    answer: 'We can offer a discount if you are paying via bank transfer, cash, or if you refer someone who books Tote Taxi. Please call or email for more information.'
  },
  {
    category: 'general',
    question: 'Do you offer daily luggage storage?',
    answer: 'Yes, this service is offered at 395 County Road, 39A. It\'s $20/day. Please call or email us to schedule.'
  },
  
  // Service Details
  {
    category: 'service',
    question: 'What happens if I\'m late to give my bag? How long will you wait?',
    answer: 'If there is a problem we will call/text you directly. Tote Taxi will wait up to 10 minutes to receive the bag. If the delivery is missed you will be charged an additional $20.'
  },
  {
    category: 'service',
    question: 'Can I leave my bag outside my door if I\'m not home?',
    answer: 'Yes. If you are not home, please leave the items in a safe place. Use the instruction form to inform us of pickup/delivery instructions.'
  },
  {
    category: 'service',
    question: 'I\'m staying in a hotel - where should I leave my bag?',
    answer: 'Go ahead and leave it at the front desk – the hotel will give you a claim ticket. Please respond to your confirmation email with a photo of the claim ticket.'
  },
  {
    category: 'service',
    question: 'Do you have a drop-off or pick-up location?',
    answer: 'Everything is delivered door-to-door. If you need this option, our office is at 395 County Road 39A, Southampton, NY 11968. Contact us for details.'
  },
  {
    category: 'service',
    question: 'Where will the driver meet me?',
    answer: 'Please have the person handing us the bag meet us on the first floor. We will contact you directly when we have arrived at your address.'
  },
  {
    category: 'service',
    question: 'Do I have to label my bag?',
    answer: 'Yes, please label the bag with the name on the order. We also highly recommend that you number your pieces (example: #3 of 5 pieces). Labels are available upon request.'
  },
  {
    category: 'service',
    question: 'When will my bag arrive in NYC/The Hamptons?',
    answer: 'Items are picked up in the mornings between 8am-11:30am and delivered before 6pm. When the driver is headed to your pickup/drop-off you will receive tracking information.'
  },
  {
    category: 'service',
    question: 'Do you offer local Hamptons service from retail stores?',
    answer: 'As a traditional courier, we can pick up and deliver items for you around the Hamptons.'
  },
  
  // Mini Moves
  {
    category: 'mini-moves',
    question: 'What is a mini move?',
    answer: 'A mini-move is a luxurious and worry-free solution for transporting a larger amount of luggage and other small items in a carefree way — to and from your destination in NYC, the Hamptons, and South Florida.'
  },
  {
    category: 'mini-moves',
    question: 'What is the difference between a Mini Move, Petite Move, and a Full Move?',
    answer: 'We suggest move types based on the number of individuals in a family: • Petite Move: Ideal for a family of 3- with 8-15 pieces • Mini Move (Standard): Our most popular option, ideal for a family of 5- with 15-30 pieces • Full Move: For larger families of 6+ with 50-60 pieces. Note: mini move packages do not include Peloton transport.'
  },
  {
    category: 'mini-moves',
    question: 'What do I need to know about transporting a Peloton?',
    answer: 'We ask that you please remove the screen from the bike before transport.'
  },
  {
    category: 'mini-moves',
    question: 'I have an item that is not listed on the website - how do I know how much it will cost?',
    answer: 'If you have a custom order please email us at info@totetaxi.com or call 631-595-5100. We work on custom orders and can provide a quote based on your specific needs.'
  },
  {
    category: 'mini-moves',
    question: 'Are there any additional fees with the Mini Move?',
    answer: 'There can be additional fees: if you give us more items than originally stated, if your items are not ready for pickup and/or drivers are required to wait more than 30 minutes (on either end) an hourly rate will accrue and be added to the Mini Move.'
  },
  {
    category: 'mini-moves',
    question: 'Can you provide us with a COI (Certificate of Insurance)?',
    answer: 'Yes, please send a sample COI for the building to info@totetaxi.com. It is $50 extra. We need to know when the pickup is scheduled if the building requires a COI.'
  },
  
  // Booking
  {
    category: 'booking',
    question: 'If I want to add a bag last minute can I?',
    answer: 'Tote Taxi can take as many bags as needed/requested by the client. Please inform the messenger of the change - we\'ll be able to properly document the delivery request in our system. The card on file will be billed for any additional items.'
  },
  {
    category: 'booking',
    question: 'What is your cancellation policy?',
    answer: 'You must cancel within 48 hours of booking for a full refund. This does not apply for holiday weekends or sold-out dates. Credit will be issued for any cancellations.'
  },
  {
    category: 'booking',
    question: 'How do I edit my order?',
    answer: 'Please email us at orders@totetaxi.com. We will gladly assist you with any changes.'
  }
];

const categories = {
  general: 'General Information',
  service: 'Service Details',
  'mini-moves': 'Mini Moves',
  booking: 'Booking & Orders'
};

export default function FAQPage() {
  const [activeCategory, setActiveCategory] = useState<string>('general');
  const [openQuestions, setOpenQuestions] = useState<Set<number>>(new Set());

  const toggleQuestion = (index: number) => {
    const newOpenQuestions = new Set(openQuestions);
    if (newOpenQuestions.has(index)) {
      newOpenQuestions.delete(index);
    } else {
      newOpenQuestions.add(index);
    }
    setOpenQuestions(newOpenQuestions);
  };

  const filteredFAQs = faqData.filter(faq => faq.category === activeCategory);

  return (
    <MainLayout>
      <div className="container mx-auto px-4 py-16">
        {/* Hero Section */}
        <div className="text-center mb-16">
          <h1 className="text-4xl md:text-5xl font-serif font-bold text-navy-900 mb-6">
            Frequently Asked Questions
          </h1>
          <p className="text-xl text-navy-700 max-w-3xl mx-auto mb-4">
            Everything you need to know about Tote Taxi's delivery service.
          </p>
          <p className="text-lg text-navy-600">
            Can't find what you're looking for? <Link href="/contact" className="text-navy-900 hover:underline">Contact us</Link> for personalized assistance.
          </p>
        </div>

        {/* Category Filter */}
        <div className="flex flex-wrap justify-center gap-4 mb-12">
          {Object.entries(categories).map(([key, label]) => (
            <button
              key={key}
              onClick={() => setActiveCategory(key)}
              className={`px-6 py-3 rounded-lg font-medium transition-all ${
                activeCategory === key
                  ? 'bg-navy-900 text-white'
                  : 'bg-white text-navy-700 border border-gray-200 hover:border-navy-300'
              }`}
            >
              {label}
            </button>
          ))}
        </div>

        {/* FAQ Content */}
        <div className="max-w-4xl mx-auto mb-16">
          <div className="space-y-4">
            {filteredFAQs.map((faq, index) => (
              <Card key={index} variant="elevated">
                <CardContent>
                  <button
                    onClick={() => toggleQuestion(index)}
                    className="w-full text-left py-4 flex justify-between items-start"
                  >
                    <h3 className="text-lg font-medium text-navy-900 pr-4">
                      {faq.question}
                    </h3>
                    <span className={`text-navy-900 transition-transform flex-shrink-0 ${
                      openQuestions.has(index) ? 'rotate-180' : ''
                    }`}>
                      ↓
                    </span>
                  </button>
                  {openQuestions.has(index) && (
                    <div className="pb-4 pt-2 border-t border-gray-100">
                      <div className="text-navy-700 leading-relaxed whitespace-pre-line">
                        {faq.answer}
                      </div>
                    </div>
                  )}
                </CardContent>
              </Card>
            ))}
          </div>
        </div>

        {/* Important Notes */}
        <section className="mb-16">
          <h2 className="text-2xl font-serif font-bold text-navy-900 text-center mb-8">
            Important Information
          </h2>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
            <Card variant="default" className="border-red-200 bg-red-50">
              <CardContent>
                <h3 className="font-medium text-navy-900 mb-3">Liability Limitations</h3>
                <p className="text-navy-700 text-sm leading-relaxed">
                  In consideration of the rate charged, it is agreed that the value of shipments 
                  is not greater than $150.00 unless a greater value is declared and insurance 
                  purchased at the time the order is placed. All claims for loss or damage must 
                  be submitted verbally within 24 hours and in writing by certified mail within 
                  30 days of pickup or delivery.
                </p>
              </CardContent>
            </Card>

            <Card variant="default" className="border-gold-200 bg-gold-50">
              <CardContent>
                <h3 className="font-medium text-navy-900 mb-3">Office Location</h3>
                <div className="text-navy-700 text-sm">
                  <p className="mb-2"><strong>395 County Road 39A</strong></p>
                  <p className="mb-2">Southampton, NY 11968</p>
                  <p className="mb-2">Daily luggage storage available: $20/day</p>
                  <p>Contact us to arrange pickup/drop-off</p>
                </div>
              </CardContent>
            </Card>
          </div>
        </section>

        {/* Items We Cannot Transport */}
        <section className="mb-16">
          <Card variant="elevated">
            <CardContent>
              <h2 className="text-2xl font-serif font-bold text-navy-900 mb-6 text-center">
                Items We Cannot Transport
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <h3 className="font-medium text-navy-900 mb-3">Prohibited Items Include:</h3>
                  <ul className="space-y-1 text-navy-700 text-sm">
                    <li>• Dangerous goods or hazardous materials</li>
                    <li>• Explosives, fireworks, flammable goods</li>
                    <li>• Cash, coins, currency, negotiable instruments</li>
                    <li>• Human or animal remains</li>
                    <li>• Lottery tickets and gambling devices</li>
                    <li>• Pornographic materials</li>
                    <li>• Tobacco products and cigarettes</li>
                    <li>• Prescription drugs (with limited exceptions)</li>
                  </ul>
                </div>
                <div>
                  <h3 className="font-medium text-navy-900 mb-3">Additional Restrictions:</h3>
                  <ul className="space-y-1 text-navy-700 text-sm">
                    <li>• Perishable foods requiring refrigeration</li>
                    <li>• Live plants and cut flowers</li>
                    <li>• Containers of liquids over 8 gallons</li>
                    <li>• Used gasoline tanks or gasoline-powered devices</li>
                    <li>• Packages that are wet, leaking, or emit odors</li>
                    <li>• Items requiring special licenses or permits</li>
                    <li>• Merchandise from sanctioned countries</li>
                    <li>• Switchblades and certain knives</li>
                  </ul>
                </div>
              </div>
              <p className="text-center text-navy-600 text-sm mt-6">
                If you're unsure about an item, please contact us before booking.
              </p>
            </CardContent>
          </Card>
        </section>

        {/* Still Have Questions */}
        <div className="text-center">
          <Card variant="luxury">
            <CardContent>
              <h2 className="text-2xl font-serif font-bold text-navy-900 mb-4">
                Still Have Questions?
              </h2>
              <p className="text-navy-700 mb-6 max-w-2xl mx-auto">
                Our Customer Service Team is available to help with any questions. 
                We're here to make your delivery experience seamless.
              </p>
              <div className="flex flex-col sm:flex-row gap-4 justify-center">
                <Link href="/contact">
                  <Button variant="primary" size="lg">
                    Contact Us
                  </Button>
                </Link>
                <Link href="mailto:info@totetaxi.com">
                  <Button variant="outline" size="lg">
                    Email: info@totetaxi.com
                  </Button>
                </Link>
                <Link href="tel:631-595-5100">
                  <Button variant="outline" size="lg">
                    Call: 631-595-5100
                  </Button>
                </Link>
              </div>
            </CardContent>
          </Card>
        </div>
      </div>
    </MainLayout>
  );
}
```

# ──── frontend/src/app/forgot-password/page.tsx ────

```tsx
'use client';
// frontend/src/app/forgot-password/page.tsx
import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { apiClient } from '@/lib/api-client';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';

export default function ForgotPasswordPage() {
  const router = useRouter();
  const [email, setEmail] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isSubmitted, setIsSubmitted] = useState(false);
  const [error, setError] = useState('');

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    
    if (!email) {
      setError('Please enter your email address');
      return;
    }

    setIsLoading(true);

    try {
      await apiClient.post('/api/customer/auth/password-reset/', {
        email: email.toLowerCase().trim()
      });
      
      setIsSubmitted(true);
    } catch (error: any) {
      setError(error.response?.data?.error || 'Failed to send reset email. Please try again.');
    } finally {
      setIsLoading(false);
    }
  };

  if (isSubmitted) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-cream-50 py-12 px-4">
        <Card variant="elevated" className="max-w-md w-full">
          <CardContent className="p-8 text-center">
            <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
              </svg>
            </div>
            <h2 className="text-2xl font-serif font-bold text-navy-900 mb-2">
              Check Your Email
            </h2>
            <p className="text-navy-600 mb-6">
              If an account exists with <strong>{email}</strong>, you will receive password reset instructions shortly.
            </p>
            <p className="text-sm text-navy-500 mb-6">
              Didn't receive the email? Check your spam folder or try again.
            </p>
            <Button
              variant="outline"
              size="lg"
              onClick={() => router.push('/login')}
              className="w-full"
            >
              Back to Login
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-cream-50 py-12 px-4">
      <div className="max-w-md w-full">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-serif font-bold text-navy-900 mb-2">
            Forgot Password?
          </h1>
          <p className="text-navy-600">
            Enter your email and we'll send you instructions to reset your password.
          </p>
        </div>

        <Card variant="elevated">
          <CardContent className="p-6">
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label htmlFor="email" className="block text-sm font-medium text-navy-900 mb-1">
                  Email Address
                </label>
                <Input
                  id="email"
                  type="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  placeholder="your.email@example.com"
                  disabled={isLoading}
                  autoFocus
                />
              </div>

              {error && (
                <div className="bg-red-50 border border-red-200 rounded-md p-3">
                  <p className="text-red-700 text-sm">{error}</p>
                </div>
              )}

              <Button
                type="submit"
                variant="primary"
                size="lg"
                className="w-full"
                disabled={isLoading}
              >
                {isLoading ? 'Sending...' : 'Send Reset Instructions'}
              </Button>

              <div className="text-center">
                <button
                  type="button"
                  onClick={() => router.push('/login')}
                  className="text-sm text-navy-600 hover:text-navy-900"
                >
                  Back to Login
                </button>
              </div>
            </form>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
```

# ──── frontend/src/app/login/page.tsx ────

```tsx
// frontend/src/app/login/page.tsx
import { MainLayout } from '@/components/layout/main-layout';
import { LoginForm } from '@/components/auth/login-form';

export default function LoginPage() {
  return (
    <MainLayout>
      <div className="min-h-screen bg-gradient-to-br from-cream-50 to-cream-100 py-16">
        <div className="container mx-auto px-4">
          <LoginForm />
        </div>
      </div>
    </MainLayout>
  );
}
```

# ──── frontend/src/app/partnerships/page.tsx ────

```tsx
// frontend/src/app/partnerships/page.tsx
import { MainLayout } from '@/components/layout/main-layout';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import Link from 'next/link';

export default function PartnershipsPage() {
  return (
    <MainLayout>
      <div className="container mx-auto px-4 py-16">
        {/* Hero Section */}
        <div className="text-center mb-16">
          <h1 className="text-4xl md:text-5xl font-serif font-bold text-navy-900 mb-6">
            Partner with Tote Taxi
          </h1>
          <p className="text-xl text-navy-700 max-w-3xl mx-auto">
            We collaborate with premier brands to create seamless, elevated experiences for our clients. From luxury fashion to hospitality, our partnerships enhance the Hamptons lifestyle.
          </p>
        </div>

        {/* Current Partners */}
        <section className="mb-16">
          <h2 className="text-3xl font-serif font-bold text-navy-900 text-center mb-12">
            Our Partners
          </h2>

          <div className="space-y-8">
            {/* Blade */}
            <Card variant="luxury">
              <CardHeader>
                <h3 className="text-2xl font-serif font-bold text-navy-900">
                  BLADE
                </h3>
                <p className="text-navy-600">Urban Air Mobility Partner</p>
              </CardHeader>
              <CardContent>
                <p className="text-navy-700 mb-4">
                  Tote Taxi is the official luggage delivery partner for Blade fliers. We transport belongings while you fly, eliminating weight restrictions and making your journey effortless. Featured partner since 2019.
                </p>
                <a 
                  href="https://www.blade.com" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  className="text-navy-600 hover:text-navy-900 underline"
                >
                  Visit Blade →
                </a>
              </CardContent>
            </Card>

            {/* Dora Maar */}
            <Card variant="luxury">
              <CardHeader>
                <h3 className="text-2xl font-serif font-bold text-navy-900">
                  DORA MAAR
                </h3>
                <p className="text-navy-600">Luxury Fashion Partner</p>
              </CardHeader>
              <CardContent>
                <p className="text-navy-700 mb-4">
                  Same-day delivery of luxury pre-owned fashion and home pieces from Dora Maar's curated collection directly to the Hamptons. We bring high-end shopping to your doorstep.
                </p>
                <p className="text-navy-600 italic mb-4">
                  "We love working with Tote Taxi — our customers don't know the phrase 'over-packing,' and neither do we! We are all about fun and fashion."
                </p>
                <a 
                  href="https://dora-maar.com" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  className="text-navy-600 hover:text-navy-900 underline"
                >
                  Visit Dora Maar →
                </a>
              </CardContent>
            </Card>

            {/* Red Horse Market */}
            <Card variant="luxury">
              <CardHeader>
                <h3 className="text-2xl font-serif font-bold text-navy-900">
                  RED HORSE MARKET
                </h3>
                <p className="text-navy-600">Welcome Package Partner</p>
              </CardHeader>
              <CardContent>
                <p className="text-navy-700 mb-4">
                  We've partnered with Red Horse Market to offer curated welcome packages with local favorites and essentials for families arriving at their Hamptons homes.
                </p>
                <p className="text-navy-600 italic mb-4">
                  "Collaborating with Tote Taxi ensures that renters and homeowners can kick off their time here with essentials and snacks while they settle in." — Christian Pineda, General Manager
                </p>
              </CardContent>
            </Card>

            {/* Hamptons Organizers */}
            <Card variant="luxury">
              <CardHeader>
                <h3 className="text-2xl font-serif font-bold text-navy-900">
                  HAMPTONS ORGANIZERS
                </h3>
                <p className="text-navy-600">Professional Organization Services</p>
              </CardHeader>
              <CardContent>
                <p className="text-navy-700 mb-4">
                  Tote Taxi partners with Hamptons Organizers for clients who need packing, unpacking, and home setup assistance. We handle the logistics while they handle the organization.
                </p>
                <p className="text-navy-600 italic">
                  "We handle the preparation of the house for the season and for everyone involved. Landlords rave about Tote Taxi's short-term storage service." — Lindsay McLoughlin, Founder
                </p>
              </CardContent>
            </Card>

            {/* Hampton Jitney */}
            <Card variant="luxury">
              <CardHeader>
                <h3 className="text-2xl font-serif font-bold text-navy-900">
                  HAMPTON JITNEY
                </h3>
                <p className="text-navy-600">Transportation Partner</p>
              </CardHeader>
              <CardContent>
                <p className="text-navy-700 mb-4">
                  Travel light on the Jitney while Tote Taxi handles your luggage. Our partnership with Hampton Jitney lets you enjoy a comfortable bus ride without worrying about bulky bags — we'll deliver your belongings directly to your destination.
                </p>
                <a
                  href="https://www.hamptonjitney.com"
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-navy-600 hover:text-navy-900 underline"
                >
                  Visit Hampton Jitney →
                </a>
              </CardContent>
            </Card>

            {/* Other Partners */}
            <Card variant="elevated">
              <CardHeader>
                <h3 className="text-2xl font-serif font-bold text-navy-900">
                  Additional Partners
                </h3>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  <div>
                    <h4 className="font-medium text-navy-900">Saint James Iced Tea</h4>
                    <p className="text-navy-700 text-sm">Co-branded sprinter van partnership</p>
                  </div>
                  <div>
                    <h4 className="font-medium text-navy-900">grüns</h4>
                    <p className="text-navy-700 text-sm">Wellness brand collaboration</p>
                  </div>
                  <div>
                    <h4 className="font-medium text-navy-900">Tote Camps</h4>
                    <p className="text-navy-700 text-sm">Summer camp trunk delivery from White Plains, Paramus, Bethesda, and Cherry Hill</p>
                  </div>
                </div>
              </CardContent>
            </Card>
          </div>
        </section>

        {/* Partnership Benefits */}
        <section className="mb-16">
          <Card variant="luxury">
            <CardHeader>
              <h2 className="text-3xl font-serif font-bold text-navy-900 text-center">
                Why Partner with Tote Taxi?
              </h2>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="flex gap-3">
                  <div className="text-2xl">✓</div>
                  <div>
                    <h3 className="font-medium text-navy-900 mb-1">Access to Affluent Clientele</h3>
                    <p className="text-navy-700 text-sm">Reach high-net-worth families traveling between Manhattan and the Hamptons</p>
                  </div>
                </div>
                <div className="flex gap-3">
                  <div className="text-2xl">✓</div>
                  <div>
                    <h3 className="font-medium text-navy-900 mb-1">Co-Marketing Opportunities</h3>
                    <p className="text-navy-700 text-sm">Featured in our communications, social media, and client touchpoints</p>
                  </div>
                </div>
                <div className="flex gap-3">
                  <div className="text-2xl">✓</div>
                  <div>
                    <h3 className="font-medium text-navy-900 mb-1">Seamless Service Integration</h3>
                    <p className="text-navy-700 text-sm">We handle logistics so your brand delivers exceptional experiences</p>
                  </div>
                </div>
                <div className="flex gap-3">
                  <div className="text-2xl">✓</div>
                  <div>
                    <h3 className="font-medium text-navy-900 mb-1">Luxury Lifestyle Alignment</h3>
                    <p className="text-navy-700 text-sm">Partner with a trusted name in Hamptons luxury services</p>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </section>

        {/* CTA */}
        <section>
          <Card variant="elevated">
            <CardContent>
              <div className="text-center py-8">
                <h2 className="text-2xl font-serif font-bold text-navy-900 mb-4">
                  Interested in Partnering with Tote Taxi?
                </h2>
                <p className="text-navy-700 mb-6 max-w-2xl mx-auto">
                  We're always looking for like-minded luxury brands to create exceptional experiences for our mutual clients.
                </p>
                <div className="flex flex-col sm:flex-row gap-4 justify-center mb-6">
                  <Link href="/contact">
                    <Button variant="primary" size="lg">
                      Contact Us About Partnerships
                    </Button>
                  </Link>
                </div>
                <div className="text-navy-600">
                  <p>Email: <a href="mailto:partnerships@totetaxi.com" className="underline hover:text-navy-900">partnerships@totetaxi.com</a></p>
                  <p>Phone: <a href="tel:631-595-5100" className="underline hover:text-navy-900">631-595-5100</a></p>
                </div>
              </div>
            </CardContent>
          </Card>
        </section>
      </div>
    </MainLayout>
  );
}
```

# ──── frontend/src/app/press/page.tsx ────

```tsx
// frontend/src/app/press/page.tsx
import { MainLayout } from '@/components/layout/main-layout';
import { Card, CardContent, CardHeader } from '@/components/ui/card';

export default function PressPage() {
  return (
    <MainLayout>
      <div className="container mx-auto px-4 py-16">
        {/* Hero Section */}
        <div className="text-center mb-16">
          <h1 className="text-4xl md:text-5xl font-serif font-bold text-navy-900 mb-6">
            Tote Taxi in the Media
          </h1>
          <p className="text-xl text-navy-700 max-w-3xl mx-auto">
            Leading publications have featured Tote Taxi's innovative approach to luxury courier services and seasonal relocation.
          </p>
        </div>

        {/* Featured Press */}
        <section className="mb-12">
          <h2 className="text-3xl font-serif font-bold text-navy-900 text-center mb-8">
            Featured Coverage
          </h2>
          <Card variant="luxury">
            <CardContent>
              <div className="space-y-4">
                <PressLink 
                  publication="The New York Times"
                  title="Tote Taxi Brings Convenience to Hamptons Delivery"
                  date="July 2025"
                  url="https://www.nytimes.com/2025/07/18/style/tote-taxi-hamptons-delivery.html"
                />
                <PressLink 
                  publication="Vogue Business"
                  title="How Luxury Brands Reached Peak Hamptons This Summer"
                  url="https://www.voguebusiness.com/story/fashion/how-luxury-brands-reached-peak-hamptons-this-summer"
                />
                <PressLink 
                  publication="Business Insider"
                  title="A Day in the Life of Tote Taxi's Hamptons Service"
                  date="August 2020"
                  url="https://www.businessinsider.com/tote-taxi-hamptons-service-day-in-the-life-2020-8"
                />
                <PressLink 
                  publication="Newsday"
                  title="Tote Taxi Founder Danielle Candela on Building a Hamptons Essential"
                  date="2024"
                  url="https://www.newsday.com/business/tote-taxi-danielle-candela-jyujtn2g"
                />
              </div>
            </CardContent>
          </Card>
        </section>

        {/* All Press Coverage */}
        <section className="mb-12">
          <h2 className="text-3xl font-serif font-bold text-navy-900 text-center mb-8">
            All Press Coverage
          </h2>
          <Card variant="elevated">
            <CardContent>
              <div className="space-y-3">
                <PressLink 
                  publication="James Lane Post"
                  title="Tote Taxi Offers Expanded Lifestyle Services & One-Stop Shopping For Clients"
                  date="June 2025"
                  url="https://jameslanepost.com/tote-taxi-offers-expanded-lifestyle-services-one-stop-shopping-for-clients/06/11/2025/Hamptons-News-Happenings"
                />
                <PressLink 
                  publication="Hamptons Magazine"
                  title="Hamptons Delivery Service: Tote Taxi & Dora Maar Partnership"
                  url="https://mlhamptons.com/hamptons-delivery-service-tote-taxi-dora-maar"
                />
                <PressLink 
                  publication="Blade"
                  title="Move Your Belongings Back to the City This Fall with Tote Taxi"
                  url="https://www.blade.com/mini-moves"
                />
                <PressLink 
                  publication="Palm Beach Daily News"
                  title="Tote Taxi Luxury Courier Service Gains Foothold in Palm Beach"
                  url="https://www.palmbeachdailynews.com/restricted/?return=https%3A%2F%2Fwww.palmbeachdailynews.com%2Fstory%2Fnews%2Flocal%2F2022%2F04%2F25%2Ftote-taxi-luxury-courier-service-gains-foothold-palm-beach%2F9468481002%2F"
                />
                <PressLink 
                  publication="Bella Mag"
                  title="Dora Maar Announces Partnership with Tote Taxi for Summer Curation"
                  url="https://bellamag.co/dora-maar-announces-partnership-with-tote-taxi-for-summer-curation-hamptons-delivery/"
                />
                <PressLink 
                  publication="James Lane Post"
                  title="Tote Taxi Founder Danielle Candela Talks Entrepreneurial Journey"
                  date="August 2022"
                  url="https://jameslanepost.com/tote-taxi-founder-danielle-candela-talks-entrepreneurial-journey/08/29/2022/Hamptons-News-Happenings"
                />
                <PressLink 
                  publication="New York Post"
                  title="The Most Ridiculous Things Tote Taxi Has Hauled to the Hamptons"
                  date="May 2019"
                  url="https://nypost.com/2019/05/23/the-most-ridiculous-things-tote-taxi-has-hauled-to-the-hamptons/"
                />
                <PressLink 
                  publication="Hamptons Social"
                  title="Tote Taxi: The Hamptons' Essential Courier Service"
                  url="https://hamptons-social.com/tote-taxi/"
                />
                <PressLink 
                  publication="27 East"
                  title="Tote Taxi Teams Up with Heart of the Hamptons for Holiday Season"
                  url="https://www.27east.com/southampton-press/tote-taxi-teams-up-with-heart-of-the-hamptons-for-holiday-season-1591468/"
                />
                <PressLink 
                  publication="Dora Maar"
                  title="Tote Taxi Same-Day Hamptons Delivery Partnership"
                  url="https://dora-maar.com/pages/tote-taxi-same-day-hamptons-delivery"
                />
                <PressLink 
                  publication="Curbed"
                  title="Tote Taxi: Hamptons Courier Service Launches"
                  date="June 2018"
                  url="https://hamptons.curbed.com/2018/6/13/17439038/tote-taxi-hamptons-courier-service"
                />
                <PressLink 
                  publication="Dan's Papers"
                  title="Tote Taxi Takes Wheel on Door-to-Door Courier Service in the Hamptons"
                  date="June 2018"
                  url="https://www.danspapers.com/2018/06/tote-taxi-door-to-door-courier-service-hamptons/"
                />
                <PressLink 
                  publication="hamptons.com"
                  title="Tote Taxi Wins Inaugural RipTide $ink or $wim"
                  url="https://hamptons.com/community-community-news-24070-tote-taxi-wins-inaugural-riptide-ink-or-wim-html/"
                />
                <PressLink 
                  publication="Medium"
                  title="Pop Quiz Monday with Danielle Candela, Founder & CEO at Tote Taxi"
                  url="https://medium.com/artlegends/pop-quiz-monday-with-danielle-candela-founder-ceo-at-tote-taxi-4cc3d56b5d61"
                />
                <PressLink 
                  publication="Pure Wow"
                  title="Tote Taxi Courier Service: Hamptons Travel Made Easy"
                  url="https://www.purewow.com/travel/tote-taxi-courier-hamptons"
                />
                <PressLink 
                  publication="Newsday"
                  title="Tote Taxi: Hamptons Courier Service Launches"
                  url="https://www.newsday.com/news/tote-taxi-hamptons-courier-service-s47623"
                />
              </div>
            </CardContent>
          </Card>
        </section>

        {/* Awards */}
        <section className="mb-12">
          <Card variant="luxury">
            <CardHeader>
              <h2 className="text-3xl font-serif font-bold text-navy-900 text-center">
                Awards & Recognition
              </h2>
            </CardHeader>
            <CardContent>
              <div className="text-center">
                <div className="inline-block bg-gold-100 border-2 border-gold-400 rounded-lg p-6">
                  <div className="text-4xl mb-2">🏆</div>
                  <h3 className="text-xl font-bold text-navy-900 mb-2">
                    RipTide $ink or $wim Winner
                  </h3>
                  <p className="text-navy-700">
                    First place in Southampton's premier startup pitch competition (2017)
                  </p>
                  <p className="text-navy-600 text-sm mt-2">
                    $15,000 prize + mentorship from leading East End business leaders
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>
        </section>

        {/* Media Contact */}
        <section>
          <Card variant="elevated">
            <CardContent>
              <div className="text-center">
                <h2 className="text-2xl font-serif font-bold text-navy-900 mb-4">
                  Media Inquiries
                </h2>
                <p className="text-navy-700 mb-4">
                  For press inquiries, please contact:
                </p>
                <p className="text-navy-900 font-medium">
                  Email: <a href="mailto:press@totetaxi.com" className="text-navy-600 hover:text-navy-900 underline">press@totetaxi.com</a>
                </p>
                <p className="text-navy-900 font-medium">
                  Phone: <a href="tel:631-595-5100" className="text-navy-600 hover:text-navy-900 underline">631-595-5100</a>
                </p>
              </div>
            </CardContent>
          </Card>
        </section>
      </div>
    </MainLayout>
  );
}

// Helper component for press links
function PressLink({ publication, title, date, url }: { 
  publication: string; 
  title: string; 
  date?: string;
  url: string;
}) {
  return (
    <div className="border-b border-gray-200 pb-3 last:border-0">
      <a 
        href={url}
        target="_blank"
        rel="noopener noreferrer"
        className="group block hover:bg-gold-50 rounded p-2 -m-2 transition-colors"
      >
        <div className="flex justify-between items-start gap-4">
          <div className="flex-1">
            <span className="font-medium text-navy-900 group-hover:text-navy-600">
              {publication}
            </span>
            <span className="text-navy-700"> — {title}</span>
          </div>
          {date && (
            <span className="text-sm text-navy-500 whitespace-nowrap">{date}</span>
          )}
        </div>
        <span className="text-xs text-navy-500 group-hover:text-navy-700">
          Read Article →
        </span>
      </a>
    </div>
  );
}
```

# ──── frontend/src/app/register/page.tsx ────

```tsx
// frontend/src/app/register/page.tsx
import { MainLayout } from '@/components/layout/main-layout';
import { RegisterForm } from '@/components/auth/register-form';

export default function RegisterPage() {
  return (
    <MainLayout>
      <div className="min-h-screen bg-gradient-to-br from-cream-50 to-cream-100 py-16">
        <div className="container mx-auto px-4">
          <RegisterForm />
        </div>
      </div>
    </MainLayout>
  );
}
```

# ──── frontend/src/app/reset-password/page.tsx ────

```tsx
'use client';
// frontend/src/app/reset-password/page.tsx

import { Suspense, useState } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { apiClient } from '@/lib/api-client';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';

// Extract component that uses useSearchParams
function ResetPasswordContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const token = searchParams.get('token');

  const [password, setPassword] = useState('');
  const [confirmPassword, setConfirmPassword] = useState('');
  const [isLoading, setIsLoading] = useState(false);
  const [isSuccess, setIsSuccess] = useState(false);
  const [error, setError] = useState('');

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');

    if (!token) {
      setError('Invalid reset link. Please request a new password reset.');
      return;
    }

    if (password.length < 8) {
      setError('Password must be at least 8 characters long');
      return;
    }

    if (password !== confirmPassword) {
      setError('Passwords do not match');
      return;
    }

    setIsLoading(true);

    try {
      await apiClient.post('/api/customer/auth/password-reset/confirm/', {
        token,
        new_password: password
      });

      setIsSuccess(true);
    } catch (error: any) {
      setError(
        error.response?.data?.error || 
        'Failed to reset password. The link may be expired or invalid.'
      );
    } finally {
      setIsLoading(false);
    }
  };

  if (!token) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-cream-50 py-12 px-4">
        <Card variant="elevated" className="max-w-md w-full">
          <CardContent className="p-8 text-center">
            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </div>
            <h2 className="text-2xl font-serif font-bold text-navy-900 mb-2">
              Invalid Reset Link
            </h2>
            <p className="text-navy-600 mb-6">
              This password reset link is invalid or has expired.
            </p>
            <Button
              variant="primary"
              size="lg"
              onClick={() => router.push('/forgot-password')}
              className="w-full"
            >
              Request New Reset Link
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (isSuccess) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-cream-50 py-12 px-4">
        <Card variant="elevated" className="max-w-md w-full">
          <CardContent className="p-8 text-center">
            <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <h2 className="text-2xl font-serif font-bold text-navy-900 mb-2">
              Password Reset Successful!
            </h2>
            <p className="text-navy-600 mb-6">
              Your password has been successfully reset. You can now log in with your new password.
            </p>
            <Button
              variant="primary"
              size="lg"
              onClick={() => router.push('/login')}
              className="w-full"
            >
              Go to Login
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-cream-50 py-12 px-4">
      <div className="max-w-md w-full">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-serif font-bold text-navy-900 mb-2">
            Reset Your Password
          </h1>
          <p className="text-navy-600">
            Enter your new password below.
          </p>
        </div>

        <Card variant="elevated">
          <CardContent className="p-6">
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label htmlFor="password" className="block text-sm font-medium text-navy-900 mb-1">
                  New Password
                </label>
                <Input
                  id="password"
                  type="password"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  placeholder="Enter new password"
                  disabled={isLoading}
                  autoFocus
                />
                <p className="text-xs text-navy-500 mt-1">
                  Must be at least 8 characters long
                </p>
              </div>

              <div>
                <label htmlFor="confirmPassword" className="block text-sm font-medium text-navy-900 mb-1">
                  Confirm New Password
                </label>
                <Input
                  id="confirmPassword"
                  type="password"
                  value={confirmPassword}
                  onChange={(e) => setConfirmPassword(e.target.value)}
                  placeholder="Confirm new password"
                  disabled={isLoading}
                />
              </div>

              {error && (
                <div className="bg-red-50 border border-red-200 rounded-md p-3">
                  <p className="text-red-700 text-sm">{error}</p>
                </div>
              )}

              <Button
                type="submit"
                variant="primary"
                size="lg"
                className="w-full"
                disabled={isLoading}
              >
                {isLoading ? 'Resetting Password...' : 'Reset Password'}
              </Button>

              <div className="text-center">
                <button
                  type="button"
                  onClick={() => router.push('/login')}
                  className="text-sm text-navy-600 hover:text-navy-900 transition-colors"
                >
                  Back to Login
                </button>
              </div>
            </form>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}

// Loading fallback component
function ResetPasswordLoading() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-cream-50 py-12 px-4">
      <Card variant="elevated" className="max-w-md w-full">
        <CardContent className="p-8 text-center">
          <div className="w-16 h-16 border-4 border-navy-900 border-t-transparent rounded-full animate-spin mx-auto mb-4" />
          <h2 className="text-2xl font-serif font-bold text-navy-900 mb-2">
            Loading...
          </h2>
          <p className="text-navy-600">
            Please wait...
          </p>
        </CardContent>
      </Card>
    </div>
  );
}

// Main page component with Suspense wrapper
export default function ResetPasswordPage() {
  return (
    <Suspense fallback={<ResetPasswordLoading />}>
      <ResetPasswordContent />
    </Suspense>
  );
}
```

# ──── frontend/src/app/sentry-example-page/page.tsx ────

```tsx
"use client";

import Head from "next/head";
import * as Sentry from "@sentry/nextjs";
import { useState, useEffect } from "react";

class SentryExampleFrontendError extends Error {
  constructor(message: string | undefined) {
    super(message);
    this.name = "SentryExampleFrontendError";
  }
}

export default function Page() {
  const [hasSentError, setHasSentError] = useState(false);
  const [isConnected, setIsConnected] = useState(true);
  
  useEffect(() => {
    async function checkConnectivity() {
      const result = await Sentry.diagnoseSdkConnectivity();
      setIsConnected(result !== 'sentry-unreachable');
    }
    checkConnectivity();
  }, []);

  return (
    <div>
      <Head>
        <title>sentry-example-page</title>
        <meta name="description" content="Test Sentry for your Next.js app!" />
      </Head>

      <main>
        <div className="flex-spacer" />
        <svg height="40" width="40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M21.85 2.995a3.698 3.698 0 0 1 1.353 1.354l16.303 28.278a3.703 3.703 0 0 1-1.354 5.053 3.694 3.694 0 0 1-1.848.496h-3.828a31.149 31.149 0 0 0 0-3.09h3.815a.61.61 0 0 0 .537-.917L20.523 5.893a.61.61 0 0 0-1.057 0l-3.739 6.494a28.948 28.948 0 0 1 9.63 10.453 28.988 28.988 0 0 1 3.499 13.78v1.542h-9.852v-1.544a19.106 19.106 0 0 0-2.182-8.85 19.08 19.08 0 0 0-6.032-6.829l-1.85 3.208a15.377 15.377 0 0 1 6.382 12.484v1.542H3.696A3.694 3.694 0 0 1 0 34.473c0-.648.17-1.286.494-1.849l2.33-4.074a8.562 8.562 0 0 1 2.689 1.536L3.158 34.17a.611.611 0 0 0 .538.917h8.448a12.481 12.481 0 0 0-6.037-9.09l-1.344-.772 4.908-8.545 1.344.77a22.16 22.16 0 0 1 7.705 7.444 22.193 22.193 0 0 1 3.316 10.193h3.699a25.892 25.892 0 0 0-3.811-12.033 25.856 25.856 0 0 0-9.046-8.796l-1.344-.772 5.269-9.136a3.698 3.698 0 0 1 3.2-1.849c.648 0 1.285.17 1.847.495Z" fill="currentcolor"/>
        </svg>
        <h1>
          sentry-example-page
        </h1>

        <p className="description">
          Click the button below, and view the sample error on the Sentry <a target="_blank" href="https://matthew-raynor.sentry.io/issues/?project=4510246779420672">Issues Page</a>.
          For more details about setting up Sentry, <a target="_blank"
           href="https://docs.sentry.io/platforms/javascript/guides/nextjs/">read our docs</a>.
        </p>

        <button
          type="button"
          onClick={async () => {
            await Sentry.startSpan({
              name: 'Example Frontend/Backend Span',
              op: 'test'
            }, async () => {
              const res = await fetch("/api/sentry-example-api");
              if (!res.ok) {
                setHasSentError(true);
              }
            });
            throw new SentryExampleFrontendError("This error is raised on the frontend of the example page.");
          }}
          disabled={!isConnected}
        >
          <span>
            Throw Sample Error
          </span>
        </button>

        {hasSentError ? (
          <p className="success">
            Error sent to Sentry.
          </p>
        ) : !isConnected ? (
          <div className="connectivity-error">
            <p>It looks like network requests to Sentry are being blocked, which will prevent errors from being captured. Try disabling your ad-blocker to complete the test.</p>
          </div>
        ) : (
          <div className="success_placeholder" />
        )}

        <div className="flex-spacer" />
      
      </main>

      <style>{`
        main {
          display: flex;
          min-height: 100vh;
          flex-direction: column;
          justify-content: center;
          align-items: center;
          gap: 16px;
          padding: 16px;
          font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
        }

        h1 {
          padding: 0px 4px;
          border-radius: 4px;
          background-color: rgba(24, 20, 35, 0.03);
          font-family: monospace;
          font-size: 20px;
          line-height: 1.2;
        }

        p {
          margin: 0;
          font-size: 20px;
        }

        a {
          color: #6341F0;
          text-decoration: underline;
          cursor: pointer;

          @media (prefers-color-scheme: dark) {
            color: #B3A1FF;
          }
        }

        button {
          border-radius: 8px;
          color: white;
          cursor: pointer;
          background-color: #553DB8;
          border: none;
          padding: 0;
          margin-top: 4px;

          & > span {
            display: inline-block;
            padding: 12px 16px;
            border-radius: inherit;
            font-size: 20px;
            font-weight: bold;
            line-height: 1;
            background-color: #7553FF;
            border: 1px solid #553DB8;
            transform: translateY(-4px);
          }

          &:hover > span {
            transform: translateY(-8px);
          }

          &:active > span {
            transform: translateY(0);
          }

          &:disabled {
	            cursor: not-allowed;
	            opacity: 0.6;
	
	            & > span {
	              transform: translateY(0);
	              border: none
	            }
	          }
        }

        .description {
          text-align: center;
          color: #6E6C75;
          max-width: 500px;
          line-height: 1.5;
          font-size: 20px;

          @media (prefers-color-scheme: dark) {
            color: #A49FB5;
          }
        }

        .flex-spacer {
          flex: 1;
        }

        .success {
          padding: 12px 16px;
          border-radius: 8px;
          font-size: 20px;
          line-height: 1;
          background-color: #00F261;
          border: 1px solid #00BF4D;
          color: #181423;
        }

        .success_placeholder {
          height: 46px;
        }

        .connectivity-error {
          padding: 12px 16px;
          background-color: #E50045;
          border-radius: 8px;
          width: 500px;
          color: #FFFFFF;
          border: 1px solid #A80033;
          text-align: center;
          margin: 0;
        }
        
        .connectivity-error a {
          color: #FFFFFF;
          text-decoration: underline;
        }
      `}</style>
    </div>
  );
}
```

# ──── frontend/src/app/services/page.tsx ────

```tsx
// frontend/src/app/services/page.tsx
'use client';

import { useQuery } from '@tanstack/react-query';
import { useRouter } from 'next/navigation';
import { apiClient } from '@/lib/api-client';
import { MainLayout } from '@/components/layout/main-layout';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import Link from 'next/link';
import { useBookingWizard } from '@/stores/booking-store';
import type { ServiceCatalog } from '@/types';

export default function ServicesPage() {
  const router = useRouter();
  const { updateBookingData, resetWizard } = useBookingWizard();

  const { data: services, isLoading } = useQuery({
    queryKey: ['services', 'catalog'],
    queryFn: async (): Promise<ServiceCatalog> => {
      const response = await apiClient.get('/api/public/services/');
      return response.data;
    }
  });

  // Handler for selecting a mini move package
  const handleSelectPackage = (pkg: { id: string; package_type: string }) => {
    console.log('Button clicked! Package:', pkg);
    resetWizard();
    updateBookingData({
      service_type: 'mini_move',
      mini_move_package_id: pkg.id,
      package_type: pkg.package_type as 'petite' | 'standard' | 'full',
    });
    router.push('/book');
  };

  // Handler for standard delivery
  const handleSelectStandardDelivery = () => {
    resetWizard();
    updateBookingData({
      service_type: 'standard_delivery',
    });
    router.push('/book');
  };

  if (isLoading) {
    return (
      <MainLayout>
        <div className="container mx-auto px-4 py-16">
          <div className="animate-pulse space-y-8">
            <div className="h-12 bg-navy-200 rounded w-1/2 mx-auto"></div>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
              {[1, 2, 3].map(i => (
                <div key={i} className="h-64 bg-navy-200 rounded"></div>
              ))}
            </div>
          </div>
        </div>
      </MainLayout>
    );
  }

  return (
    <MainLayout>
      <div className="container mx-auto px-4 py-16">
        {/* Hero Section */}
        <div className="text-center mb-16">
          <h1 className="text-4xl md:text-5xl font-serif font-bold text-navy-900 mb-6">
            Our Luxury Services
          </h1>
          <p className="text-xl text-navy-700 max-w-3xl mx-auto">
            From weekend essentials to full seasonal relocations, we provide white-glove service 
            tailored to your Manhattan-to-Hamptons lifestyle.
          </p>
        </div>

        {/* Mini Moves - Featured Section */}
        <section className="mb-20">
          <div className="text-center mb-12">
            <h2 className="text-3xl font-serif font-bold text-navy-900 mb-4">Mini Moves</h2>
            <p className="text-lg text-navy-700 max-w-2xl mx-auto">
              Complete packages designed for seasonal relocation. Everything you need for your Hamptons move, 
              professionally handled from door to door.
            </p>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
            {services?.mini_move_packages?.map((pkg) => (
              <Card 
                key={pkg.id} 
                variant={pkg.is_most_popular ? "luxury" : "elevated"}
                className="relative"
              >
                {pkg.is_most_popular && (
                  <div className="absolute -top-3 left-1/2 transform -translate-x-1/2">
                    <span className="bg-gold-500 text-navy-900 px-4 py-1 rounded-full text-sm font-medium">
                      Most Popular
                    </span>
                  </div>
                )}
                
                <CardHeader>
                  <div className="text-center">
                    <h3 className="text-2xl font-serif font-bold text-navy-900 mb-2">
                      {pkg.name}
                    </h3>
                    <div className="text-4xl font-bold text-navy-900 mb-4">
                      ${pkg.base_price_dollars}
                    </div>
                    {pkg.max_items && (
                      <p className="text-navy-600">Up to {pkg.max_items} items</p>
                    )}
                  </div>
                </CardHeader>
                
                <CardContent>
                  <p className="text-navy-700 mb-6">{pkg.description}</p>
                  
                  <div className="space-y-3 mb-8">
                    <h4 className="font-medium text-navy-900">What's Included:</h4>
                    <ul className="space-y-2">
                      <li className="flex items-center text-sm text-navy-700">
                        <span className="text-green-500 mr-3">✓</span>
                        Door-to-door pickup and delivery
                      </li>
                      <li className="flex items-center text-sm text-navy-700">
                        <span className="text-green-500 mr-3">✓</span>
                        Professional handling and care
                      </li>
                      {pkg.protective_wrapping && (
                        <li className="flex items-center text-sm text-navy-700">
                          <span className="text-green-500 mr-3">✓</span>
                          Premium protective wrapping
                        </li>
                      )}
                      {pkg.coi_included && (
                        <li className="flex items-center text-sm text-navy-700">
                          <span className="text-green-500 mr-3">✓</span>
                          Certificate of Insurance included
                        </li>
                      )}
                      {pkg.priority_scheduling && (
                        <li className="flex items-center text-sm text-navy-700">
                          <span className="text-green-500 mr-3">✓</span>
                          Priority scheduling
                        </li>
                      )}
                    </ul>
                  </div>
                  
                  <Button
                    variant={pkg.is_most_popular ? "primary" : "outline"}
                    className="w-full"
                    onClick={() => handleSelectPackage(pkg)}
                  >
                    Select {pkg.name}
                  </Button>
                </CardContent>
              </Card>
            ))}
          </div>

          {/* Organizing Services Add-On */}
          <Card variant="luxury" className="mb-8">
            <CardHeader>
              <h3 className="text-xl font-serif font-bold text-navy-900 text-center">
                Professional Organizing Services
              </h3>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                  <h4 className="font-medium text-navy-900 mb-3">Professional Packing</h4>
                  <p className="text-navy-700 text-sm mb-4">
                    Our expert team carefully packs your belongings at your Manhattan location 
                    using premium materials and techniques to ensure everything arrives pristine.
                  </p>
                  <ul className="space-y-1 text-sm text-navy-600">
                    <li>• Premium packing materials included</li>
                    <li>• Careful handling of delicate items</li>
                    <li>• Efficient space optimization</li>
                  </ul>
                </div>
                <div>
                  <h4 className="font-medium text-navy-900 mb-3">Professional Unpacking</h4>
                  <p className="text-navy-700 text-sm mb-4">
                    Arrive to your Hamptons home with everything unpacked and organized exactly 
                    how you want it. We handle the setup so you can start enjoying your retreat.
                  </p>
                  <ul className="space-y-1 text-sm text-navy-600">
                    <li>• Complete unpacking and setup</li>
                    <li>• Organized placement of belongings</li>
                    <li>• Removal of all packing materials</li>
                  </ul>
                </div>
              </div>
            </CardContent>
          </Card>
        </section>

        {/* Standard Delivery */}
        {services?.standard_delivery && (
          <section className="mb-20">
            <div className="text-center mb-12">
              <h2 className="text-3xl font-serif font-bold text-navy-900 mb-4">Standard Delivery</h2>
              <p className="text-lg text-navy-700 max-w-2xl mx-auto">
                Individual item delivery for when you need specific items transported quickly and safely.
              </p>
            </div>

            <div className="max-w-4xl mx-auto">
              <Card variant="elevated">
                <CardContent>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div>
                      <div className="text-3xl font-bold text-navy-900 mb-2">
                        ${services.standard_delivery.price_per_item_dollars} per item
                      </div>
                      <p className="text-navy-600 mb-4">
                        Minimum {services.standard_delivery.minimum_items} items • 
                        ${services.standard_delivery.minimum_charge_dollars} minimum charge
                      </p>
                      
                      <div className="space-y-3">
                        <h4 className="font-medium text-navy-900">Perfect for:</h4>
                        <ul className="space-y-2 text-sm text-navy-700">
                          <li>• Individual clothing items</li>
                          <li>• Documents and files</li>
                          <li>• Small electronics</li>
                          <li>• Seasonal items under {services.standard_delivery.max_weight_per_item_lbs} lbs</li>
                        </ul>
                      </div>
                    </div>
                    
                    <div>
                      <div className="bg-gold-50 border border-gold-200 rounded-lg p-6">
                        <h4 className="font-medium text-navy-900 mb-3">Same-Day Delivery</h4>
                        <div className="text-2xl font-bold text-navy-900 mb-2">
                          ${services.standard_delivery.same_day_flat_rate_dollars}
                        </div>
                        <p className="text-sm text-navy-700 mb-4">
                          Need it today? We offer same-day delivery for urgent items.
                        </p>
                        <ul className="space-y-1 text-xs text-navy-600">
                          <li>• Order by 10 AM for same-day delivery</li>
                          <li>• Available Thursday through Monday</li>
                          <li>• Subject to availability</li>
                        </ul>
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>
          </section>
        )}

        {/* Specialty Items */}
        {services?.specialty_items && services.specialty_items.length > 0 && (
          <section className="mb-20">
            <div className="text-center mb-12">
              <h2 className="text-3xl font-serif font-bold text-navy-900 mb-4">Specialty Items</h2>
              <p className="text-lg text-navy-700 max-w-2xl mx-auto">
                Premium handling for your most valuable and unique items. Each specialty item receives 
                custom care and attention.
              </p>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              {services.specialty_items.map((item) => (
                <Card key={item.id} variant="default">
                  <CardContent>
                    <div className="text-center">
                      <h4 className="text-lg font-medium text-navy-900 mb-2">{item.name}</h4>
                      <div className="text-2xl font-bold text-navy-900 mb-3">
                        ${item.price_dollars}
                      </div>
                      <p className="text-navy-600 text-sm mb-4">{item.description}</p>
                      
                      {item.special_handling && (
                        <div className="mb-4">
                          <span className="inline-block bg-gold-100 text-gold-800 text-xs px-3 py-1 rounded-full">
                            Special Handling Included
                          </span>
                        </div>
                      )}
                      
                      {item.requires_van_schedule && (
                        <p className="text-xs text-navy-500">
                          * Requires scheduled van delivery
                        </p>
                      )}
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>
          </section>
        )}

        {/* Service Areas */}
        <section className="mb-20">
          <Card variant="elevated">
            <CardHeader>
              <h2 className="text-2xl font-serif font-bold text-navy-900 text-center">Service Areas</h2>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                <div>
                  <h3 className="font-medium text-navy-900 mb-3">Pickup Locations</h3>
                  <ul className="space-y-2 text-navy-700">
                    <li>• Manhattan (All neighborhoods)</li>
                    <li>• Brooklyn (Select areas)</li>
                    <li>• Long Island City</li>
                    <li>• Hoboken & Jersey City</li>
                  </ul>
                </div>
                <div>
                  <h3 className="font-medium text-navy-900 mb-3">Delivery Destinations</h3>
                  <ul className="space-y-2 text-navy-700">
                    <li>• East Hampton</li>
                    <li>• Southampton & Water Mill</li>
                    <li>• Bridgehampton & Sagaponack</li>
                    <li>• Westhampton Beach</li>
                    <li>• Sag Harbor & North Haven</li>
                    <li>• Montauk</li>
                  </ul>
                </div>
              </div>
              <div className="text-center mt-6">
                <p className="text-sm text-navy-600">
                  Don't see your location? <Link href="/contact" className="text-navy-900 hover:underline">Contact us</Link> for custom service options.
                </p>
              </div>
            </CardContent>
          </Card>
        </section>

        {/* CTA Section */}
        <div className="text-center">
          <h2 className="text-2xl font-serif font-bold text-navy-900 mb-4">
            Ready to Experience White-Glove Service?
          </h2>
          <p className="text-navy-700 mb-8 max-w-2xl mx-auto">
            Book your luxury move today and discover why discerning clients trust ToteTaxi 
            for their Manhattan-to-Hamptons transport needs.
          </p>
          <Link href="/book">
            <Button variant="primary" size="lg">
              Start Your Booking
            </Button>
          </Link>
        </div>
      </div>
    </MainLayout>
  );
}
```

# ──── frontend/src/app/staff/bookings/page.tsx ────

```tsx
// frontend/src/app/staff/bookings/page.tsx
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useStaffAuthStore } from '@/stores/staff-auth-store';
import { StaffLayout } from '@/components/staff/staff-layout';
import { BookingManagement } from '@/components/staff/booking-management';

export default function StaffBookingsPage() {
  const { isAuthenticated, isLoading } = useStaffAuthStore();
  const router = useRouter();

  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      router.push('/staff/login');
    }
  }, [isAuthenticated, isLoading, router]);

  if (isLoading || !isAuthenticated) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-navy-900"></div>
      </div>
    );
  }

  return (
    <StaffLayout>
      <BookingManagement />
    </StaffLayout>
  );
}
```

# ──── frontend/src/app/staff/bookings/[id]/page.tsx ────

```tsx
'use client';

import { useEffect, useState } from 'react';
import { useRouter, useParams } from 'next/navigation';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useStaffAuthStore } from '@/stores/staff-auth-store';
import { StaffLayout } from '@/components/staff/staff-layout';
import { RefundModal } from '@/components/staff/refund-modal';
import { apiClient } from '@/lib/api-client';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Select } from '@/components/ui/select';
import type { Payment, Refund } from '@/types';

interface Address {
  address_line_1: string;
  address_line_2: string;
  city: string;
  state: string;
  zip_code: string;
}

interface ServiceDetails {
  mini_move?: {
    package_name: string;
    package_type: string;
    description: string;
    max_items: number | null;
    max_weight_per_item_lbs: number;
    coi_included: boolean;
    priority_scheduling: boolean;
    protective_wrapping: boolean;
    base_price_dollars: number;
  };
  organizing_services?: {
    include_packing: boolean;
    include_unpacking: boolean;
    packing_service?: {
      name: string;
      price_dollars: number;
      duration_hours: number;
      organizer_count: number;
      supplies_allowance: number;
    };
    unpacking_service?: {
      name: string;
      price_dollars: number;
      duration_hours: number;
      organizer_count: number;
      supplies_allowance: number;
    };
  };
  specialty_items?: Array<{
    id: string;
    name: string;
    item_type: string;
    description: string;
    price_dollars: number;
    special_handling: boolean;
  }>;
  standard_delivery?: {
    item_count: number;
    is_same_day: boolean;
  };
  blade_transfer?: {
    airport: string;
    flight_date: string;
    flight_time: string;
    bag_count: number;
    ready_time: string;
    per_bag_price: number;
  };
}

interface BookingFormData {
  status: string;
  pickup_date: string;
  pickup_time: string;
  special_instructions: string;
  coi_required: boolean;
  pickup_address: Address;
  delivery_address: Address;
}

export default function BookingDetailPage() {
  const { isAuthenticated, isLoading } = useStaffAuthStore();
  const router = useRouter();
  const params = useParams();
  const bookingId = params.id as string;
  const queryClient = useQueryClient();

  const [isEditing, setIsEditing] = useState(false);
  const [showRefundModal, setShowRefundModal] = useState(false);
  
  const [formData, setFormData] = useState<BookingFormData>({
    status: '',
    pickup_date: '',
    pickup_time: '',
    special_instructions: '',
    coi_required: false,
    pickup_address: {
      address_line_1: '',
      address_line_2: '',
      city: '',
      state: '',
      zip_code: ''
    },
    delivery_address: {
      address_line_1: '',
      address_line_2: '',
      city: '',
      state: '',
      zip_code: ''
    }
  });

  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      router.push('/staff/login');
    }
  }, [isAuthenticated, isLoading, router]);

  const { data: booking, isLoading: bookingLoading } = useQuery({
    queryKey: ['staff', 'booking', bookingId],
    queryFn: async () => {
      const response = await apiClient.get(`/api/staff/bookings/${bookingId}/`);
      return response.data;
    },
    enabled: !!bookingId && isAuthenticated
  });

  const { data: refundsData } = useQuery({
    queryKey: ['staff', 'refunds', bookingId],
    queryFn: async () => {
      const response = await apiClient.get(`/api/payments/refunds/?booking_id=${bookingId}`);
      return Array.isArray(response.data) ? response.data : response.data.results || [];
    },
    enabled: !!bookingId && isAuthenticated && !!booking?.payment
  });

  const updateBookingMutation = useMutation({
    mutationFn: async (updates: Partial<BookingFormData>) => {
      const response = await apiClient.patch(`/api/staff/bookings/${bookingId}/`, updates);
      return response.data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['staff', 'booking', bookingId] });
      setIsEditing(false);
    }
  });

  useEffect(() => {
    if (booking?.booking) {
      setFormData({
        status: booking.booking.status || '',
        pickup_date: booking.booking.pickup_date || '',
        pickup_time: booking.booking.pickup_time || '',
        special_instructions: booking.booking.special_instructions || '',
        coi_required: booking.booking.coi_required || false,
        pickup_address: booking.booking.pickup_address || {
          address_line_1: '',
          address_line_2: '',
          city: '',
          state: '',
          zip_code: ''
        },
        delivery_address: booking.booking.delivery_address || {
          address_line_1: '',
          address_line_2: '',
          city: '',
          state: '',
          zip_code: ''
        }
      });
    }
  }, [booking]);

  const handleSave = () => {
    const updates: Partial<BookingFormData> = {};
    if (formData.status !== booking?.booking?.status) updates.status = formData.status;
    if (formData.pickup_date !== booking?.booking?.pickup_date) updates.pickup_date = formData.pickup_date;
    if (formData.pickup_time !== booking?.booking?.pickup_time) updates.pickup_time = formData.pickup_time;
    if (formData.special_instructions !== booking?.booking?.special_instructions) updates.special_instructions = formData.special_instructions;
    if (formData.coi_required !== booking?.booking?.coi_required) updates.coi_required = formData.coi_required;

    if (Object.keys(updates).length > 0) {
      updateBookingMutation.mutate(updates);
    } else {
      setIsEditing(false);
    }
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed': return 'bg-green-100 text-green-800';
      case 'paid': return 'bg-blue-100 text-blue-800';
      case 'confirmed': return 'bg-purple-100 text-purple-800';
      case 'pending': return 'bg-amber-100 text-amber-800';
      case 'cancelled': return 'bg-red-100 text-red-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  const getPaymentStatusColor = (status: string) => {
    switch (status) {
      case 'succeeded': return 'bg-green-100 text-green-800';
      case 'refunded': return 'bg-orange-100 text-orange-800';
      case 'pending': return 'bg-amber-100 text-amber-800';
      case 'failed': return 'bg-red-100 text-red-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  const statusOptions = [
    { value: 'pending', label: 'Pending' },
    { value: 'confirmed', label: 'Confirmed' },
    { value: 'paid', label: 'Paid' },
    { value: 'completed', label: 'Completed' },
    { value: 'cancelled', label: 'Cancelled' },
  ];

  const pickupTimeOptions = [
    { value: 'morning', label: '8 AM - 11 AM' },
    { value: 'morning_specific', label: 'Specific 1-hour window' },
    { value: 'no_time_preference', label: 'No time preference' },
  ];

  if (isLoading || !isAuthenticated || bookingLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-navy-900"></div>
      </div>
    );
  }

  const serviceDetails: ServiceDetails = booking?.booking?.service_details || {};

  return (
    <StaffLayout>
      <div className="space-y-6">
        {/* Enhanced Header */}
        <div className="flex justify-between items-start">
          <div>
            <h1 className="text-3xl font-serif font-bold text-navy-900">
              Booking #{booking?.booking?.booking_number}
            </h1>
            <div className="flex items-center gap-3 mt-3">
              <span className={`px-3 py-1.5 rounded-full text-sm font-medium ${getStatusColor(booking?.booking?.status)}`}>
                {booking?.booking?.status}
              </span>
              {booking?.payment && (
                <span className={`px-3 py-1.5 rounded-full text-sm font-medium ${getPaymentStatusColor(booking.payment.status)}`}>
                  {booking.payment.status === 'refunded' ? '↩️ Refunded' : 
                   booking.payment.status === 'succeeded' ? '✓ Paid' : 
                   booking.payment.status}
                </span>
              )}
              <span className="text-navy-600">
                {booking?.booking?.service_type_display} • ${booking?.booking?.total_price_dollars}
              </span>
            </div>
          </div>
          
          <div className="flex items-center space-x-3">
            {!isEditing ? (
              <Button variant="primary" onClick={() => setIsEditing(true)}>
                Edit Booking
              </Button>
            ) : (
              <>
                <Button variant="outline" onClick={() => setIsEditing(false)}>
                  Cancel
                </Button>
                <Button 
                  variant="primary" 
                  onClick={handleSave}
                  disabled={updateBookingMutation.isPending}
                >
                  {updateBookingMutation.isPending ? 'Saving...' : 'Save Changes'}
                </Button>
              </>
            )}
            
            <Button variant="outline" onClick={() => router.back()}>
              ← Back
            </Button>
          </div>
        </div>

        {booking && (
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Service Details with Schedule */}
            <Card>
              <CardHeader>
                <h3 className="text-lg font-medium text-navy-900">Service Details</h3>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="text-sm">
                  <strong className="text-navy-900">Service Type:</strong> 
                  <span className="ml-2 text-navy-800">{booking.booking?.service_type_display}</span>
                </div>

                {/* Schedule Section */}
                <div className="border-t pt-3 space-y-2">
                  <div className="font-semibold text-navy-900 text-sm">Schedule</div>
                  {isEditing ? (
                    <>
                      <Input
                        label="Pickup Date"
                        type="date"
                        value={formData.pickup_date}
                        onChange={(e) => setFormData(prev => ({ ...prev, pickup_date: e.target.value }))}
                      />
                      <Select
                        label="Pickup Time"
                        options={pickupTimeOptions}
                        value={formData.pickup_time}
                        onChange={(e) => setFormData(prev => ({ ...prev, pickup_time: e.target.value }))}
                      />
                      <div>
                        <label className="block text-sm font-medium text-navy-900 mb-1">
                          Special Instructions
                        </label>
                        <textarea
                          value={formData.special_instructions}
                          onChange={(e) => setFormData(prev => ({ ...prev, special_instructions: e.target.value }))}
                          rows={3}
                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-navy-500 focus:border-navy-500 text-gray-900"
                        />
                      </div>
                      <div className="flex items-center">
                        <input
                          type="checkbox"
                          id="coi_required"
                          checked={formData.coi_required}
                          onChange={(e) => setFormData(prev => ({ ...prev, coi_required: e.target.checked }))}
                          className="mr-2"
                        />
                        <label htmlFor="coi_required" className="text-sm text-navy-900">
                          COI Required
                        </label>
                      </div>
                    </>
                  ) : (
                    <>
                      <div className="text-sm text-navy-800"><strong className="text-navy-900">Date:</strong> {new Date(booking.booking?.pickup_date + 'T00:00:00').toLocaleDateString()}</div>
                      {booking.booking?.special_instructions && (
                        <div className="text-sm text-navy-800"><strong className="text-navy-900">Instructions:</strong> {booking.booking.special_instructions}</div>
                      )}
                      <div className="flex flex-wrap gap-2">
                        {booking.booking?.coi_required && (
                          <span className="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded font-medium">COI Required</span>
                        )}
                        {booking.booking?.is_outside_core_area && (
                          <span className="text-xs bg-amber-100 text-amber-800 px-2 py-1 rounded font-medium">Outside Core Area</span>
                        )}
                      </div>
                    </>
                  )}
                </div>

                {/* Mini Move Details */}
                {serviceDetails.mini_move && (
                  <div className="border-t pt-3 space-y-2 text-sm">
                    <div className="font-semibold text-navy-900">Mini Move Package: {serviceDetails.mini_move.package_name}</div>
                    <div className="text-navy-700">{serviceDetails.mini_move.description}</div>
                    <div className="grid grid-cols-2 gap-2 text-xs text-navy-600 mt-2">
                      <div>Max Items: {serviceDetails.mini_move.max_items || 'Unlimited'}</div>
                      <div>Max Weight: {serviceDetails.mini_move.max_weight_per_item_lbs} lbs</div>
                      <div>Base Price: ${serviceDetails.mini_move.base_price_dollars}</div>
                    </div>
                    <div className="flex flex-wrap gap-1 mt-2">
                      {serviceDetails.mini_move.coi_included && (
                        <span className="text-xs bg-green-100 text-green-800 px-2 py-0.5 rounded">COI Included</span>
                      )}
                      {serviceDetails.mini_move.priority_scheduling && (
                        <span className="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded">Priority</span>
                      )}
                      {serviceDetails.mini_move.protective_wrapping && (
                        <span className="text-xs bg-purple-100 text-purple-800 px-2 py-0.5 rounded">Protected</span>
                      )}
                    </div>
                  </div>
                )}

                {/* Organizing Services */}
                {serviceDetails.organizing_services && (
                  <div className="border-t pt-3 space-y-2 text-sm">
                    <div className="font-semibold text-navy-900">Organizing Services</div>
                    
                    {serviceDetails.organizing_services.packing_service && (
                      <div className="bg-green-50 p-2 rounded space-y-1">
                        <div className="flex items-center text-green-700 font-medium">
                          <span className="mr-2">✓</span> {serviceDetails.organizing_services.packing_service.name}
                        </div>
                        <div className="text-xs text-navy-600 ml-5">
                          ${serviceDetails.organizing_services.packing_service.price_dollars} • 
                          {serviceDetails.organizing_services.packing_service.duration_hours}h • 
                          {serviceDetails.organizing_services.packing_service.organizer_count} organizer(s)
                        </div>
                      </div>
                    )}
                    
                    {serviceDetails.organizing_services.unpacking_service && (
                      <div className="bg-green-50 p-2 rounded space-y-1">
                        <div className="flex items-center text-green-700 font-medium">
                          <span className="mr-2">✓</span> {serviceDetails.organizing_services.unpacking_service.name}
                        </div>
                        <div className="text-xs text-navy-600 ml-5">
                          ${serviceDetails.organizing_services.unpacking_service.price_dollars} • 
                          {serviceDetails.organizing_services.unpacking_service.duration_hours}h • 
                          {serviceDetails.organizing_services.unpacking_service.organizer_count} organizer(s)
                        </div>
                      </div>
                    )}
                    
                    {booking.booking?.organizing_total_dollars && (
                      <div className="text-navy-800 font-medium mt-2">
                        Total: ${booking.booking.organizing_total_dollars}
                      </div>
                    )}
                  </div>
                )}

                {/* Specialty Items */}
                {serviceDetails.specialty_items && serviceDetails.specialty_items.length > 0 && (
                  <div className="border-t pt-3 space-y-2">
                    <div className="font-semibold text-navy-900 text-sm">Specialty Items</div>
                    {serviceDetails.specialty_items.map((item) => (
                      <div key={item.id} className="bg-gray-50 p-2 rounded">
                        <div className="font-medium text-sm text-navy-900">{item.name}</div>
                        <div className="text-xs text-navy-600">{item.description}</div>
                        <div className="text-xs mt-1 flex justify-between items-center">
                          <span className="font-semibold text-navy-900">${item.price_dollars}</span>
                          {item.special_handling && (
                            <span className="text-xs bg-orange-100 text-orange-800 px-1.5 py-0.5 rounded">Special Handling</span>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                {/* Standard Delivery */}
                {serviceDetails.standard_delivery && (
                  <div className="border-t pt-3 space-y-2 text-sm">
                    <div className="font-semibold text-navy-900">Standard Delivery</div>
                    <div className="text-navy-800">Item Count: {serviceDetails.standard_delivery.item_count}</div>
                    {serviceDetails.standard_delivery.is_same_day && (
                      <div className="text-orange-600 font-medium">Same-Day Delivery</div>
                    )}
                  </div>
                )}

                {/* BLADE Transfer */}
                {serviceDetails.blade_transfer && (
                  <div className="border-t pt-3 space-y-2 text-sm">
                    <div className="font-semibold text-navy-900">BLADE Airport Transfer</div>
                    <div className="space-y-1 text-navy-800">
                      <div>Airport: <strong>{serviceDetails.blade_transfer.airport}</strong></div>
                      <div>Flight: {new Date(serviceDetails.blade_transfer.flight_date + 'T00:00:00').toLocaleDateString()} at {serviceDetails.blade_transfer.flight_time}</div>
                      <div>Bags: {serviceDetails.blade_transfer.bag_count} @ ${serviceDetails.blade_transfer.per_bag_price}/bag</div>
                      {serviceDetails.blade_transfer.ready_time && (
                        <div>Ready: {serviceDetails.blade_transfer.ready_time}</div>
                      )}
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>

            {/* Customer Information with booking link */}
            <Card>
              <CardHeader>
                <h3 className="text-lg font-medium text-navy-900">Customer Information</h3>
              </CardHeader>
              <CardContent className="space-y-3">
                {booking.customer && (
                  <>
                    <div className="text-navy-800"><strong className="text-navy-900">Name:</strong> {booking.customer.name}</div>
                    <div className="text-navy-800"><strong className="text-navy-900">Email:</strong> {booking.customer.email}</div>
                    <div className="text-navy-800"><strong className="text-navy-900">Phone:</strong> {booking.customer.phone}</div>
                    <div className="text-navy-800">
                      <strong className="text-navy-900">VIP Status:</strong> 
                      <span className={`ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                        booking.customer.is_vip ? 'bg-gold-100 text-gold-800' : 'bg-gray-100 text-gray-800'
                      }`}>
                        {booking.customer.is_vip ? 'VIP Customer' : 'Standard Customer'}
                      </span>
                    </div>
                    
                    <div className="pt-2 space-y-2">
                      <Button 
                        variant="outline" 
                        size="sm"
                        onClick={() => router.push(`/staff/customers/${booking.customer.id}`)}
                        className="w-full"
                      >
                        View Customer Profile
                      </Button>
                      
                      {booking.customer.total_bookings > 1 && (
                        <button
                          onClick={() => router.push(`/staff/bookings?customer=${booking.customer.id}`)}
                          className="text-sm text-navy-600 hover:text-navy-800 underline w-full text-center"
                        >
                          View all {booking.customer.total_bookings} bookings by this customer
                        </button>
                      )}
                    </div>
                  </>
                )}
                {booking.guest_checkout && (
                  <>
                    <div className="text-navy-800"><strong className="text-navy-900">Name:</strong> {booking.guest_checkout.first_name} {booking.guest_checkout.last_name}</div>
                    <div className="text-navy-800"><strong className="text-navy-900">Email:</strong> {booking.guest_checkout.email}</div>
                    <div className="text-navy-800"><strong className="text-navy-900">Phone:</strong> {booking.guest_checkout.phone}</div>
                    <div className="text-navy-600 text-sm">Guest Customer (no account)</div>
                  </>
                )}
              </CardContent>
            </Card>

            {/* Pricing Breakdown - FIXED */}
            <Card>
              <CardHeader>
                <h3 className="text-lg font-medium text-navy-900">Pricing Breakdown</h3>
              </CardHeader>
              <CardContent>
                <div className="space-y-2 text-sm">
                  
                  {/* Standard Delivery - Show items breakdown */}
                  {booking.booking?.service_type === 'standard_delivery' && serviceDetails.standard_delivery && (
                    <>
                      {/* Regular delivery items */}
                      {serviceDetails.standard_delivery.item_count > 0 && (
                        <div className="flex justify-between">
                          <span className="text-navy-900">
                            Standard Delivery ({serviceDetails.standard_delivery.item_count} items):
                          </span>
                          <span className="text-navy-900 font-medium">
                            ${Math.max((serviceDetails.standard_delivery.item_count * 95), 285)}
                          </span>
                        </div>
                      )}
                      
                      {/* Specialty items */}
                      {serviceDetails.specialty_items && serviceDetails.specialty_items.map((item) => (
                        <div key={item.id} className="flex justify-between">
                          <span className="text-navy-900">{item.name} (Specialty):</span>
                          <span className="text-navy-900 font-medium">${item.price_dollars}</span>
                        </div>
                      ))}
                    </>
                  )}

                  {/* Mini Move - Show base price */}
                  {booking.booking?.service_type === 'mini_move' && (
                    <div className="flex justify-between">
                      <span className="text-navy-900">Base Price:</span>
                      <span className="text-navy-900 font-medium">${booking.booking?.base_price_dollars || 0}</span>
                    </div>
                  )}

                  {/* Specialty Item Only */}
                  {booking.booking?.service_type === 'specialty_item' && serviceDetails.specialty_items && (
                    <>
                      {serviceDetails.specialty_items.map((item) => (
                        <div key={item.id} className="flex justify-between">
                          <span className="text-navy-900">{item.name}:</span>
                          <span className="text-navy-900 font-medium">${item.price_dollars}</span>
                        </div>
                      ))}
                    </>
                  )}

                  {/* BLADE */}
                  {booking.booking?.service_type === 'blade_transfer' && serviceDetails.blade_transfer && (
                    <div className="flex justify-between">
                      <span className="text-navy-900">
                        BLADE Transfer ({serviceDetails.blade_transfer.bag_count} bags × $75):
                      </span>
                      <span className="text-navy-900 font-medium">${booking.booking?.base_price_dollars || 0}</span>
                    </div>
                  )}

                  {/* Same-Day Surcharge */}
                  {booking.booking?.same_day_surcharge_dollars > 0 && (
                    <div className="flex justify-between">
                      <span className="text-navy-900">Same-Day Delivery:</span>
                      <span className="text-navy-900 font-medium">+${booking.booking.same_day_surcharge_dollars}</span>
                    </div>
                  )}

                  {/* Peak Date Surcharges */}
                  {booking.booking?.surcharge_dollars > 0 && (
                    <div className="flex justify-between">
                      <span className="text-navy-900">Peak Date Surcharge:</span>
                      <span className="text-navy-900 font-medium">+${booking.booking.surcharge_dollars}</span>
                    </div>
                  )}

                  {/* COI Fee */}
                  {booking.booking?.coi_fee_dollars > 0 && (
                    <div className="flex justify-between">
                      <span className="text-navy-900">COI Fee:</span>
                      <span className="text-navy-900 font-medium">+${booking.booking.coi_fee_dollars}</span>
                    </div>
                  )}

                  {/* Organizing Total */}
                  {booking.booking?.organizing_total_dollars > 0 && (
                    <div className="flex justify-between">
                      <span className="text-navy-900">Organizing Services:</span>
                      <span className="text-navy-900 font-medium">+${booking.booking.organizing_total_dollars}</span>
                    </div>
                  )}

                  {/* Geographic Surcharge */}
                  {booking.booking?.geographic_surcharge_dollars > 0 && (
                    <div className="flex justify-between">
                      <span className="text-navy-900">Geographic Surcharge:</span>
                      <span className="text-navy-900 font-medium">+${booking.booking.geographic_surcharge_dollars}</span>
                    </div>
                  )}

                  {/* Time Window Surcharge */}
                  {booking.booking?.time_window_surcharge_dollars > 0 && (
                    <div className="flex justify-between">
                      <span className="text-navy-900">Time Window Surcharge:</span>
                      <span className="text-navy-900 font-medium">+${booking.booking.time_window_surcharge_dollars}</span>
                    </div>
                  )}

                  {/* Discount */}
                  {booking.booking?.discount_amount_dollars > 0 && (
                    <>
                      <div className="flex justify-between border-t pt-2 mt-2">
                        <span className="text-navy-900">Subtotal:</span>
                        <span className="text-navy-900 font-medium">${booking.booking.pre_discount_total_dollars}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-green-700">
                          Discount ({booking.booking.discount_description || booking.booking.discount_code_name}):
                        </span>
                        <span className="text-green-700 font-medium">-${booking.booking.discount_amount_dollars}</span>
                      </div>
                    </>
                  )}

                  {/* Total */}
                  <div className={`flex justify-between text-lg font-bold pt-2 mt-2 ${booking.booking?.discount_amount_dollars > 0 ? '' : 'border-t'}`}>
                    <span className="text-navy-900">Total:</span>
                    <span className="text-navy-900">${booking.booking?.total_price_dollars}</span>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Addresses - Always visible, side-by-side */}
            <Card>
              <CardHeader>
                <h3 className="text-lg font-medium text-navy-900">Addresses</h3>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <h4 className="font-medium text-navy-900 mb-2">Pickup Address</h4>
                    <div className="text-navy-800 text-sm">
                      <div>{booking.booking?.pickup_address?.address_line_1}</div>
                      {booking.booking?.pickup_address?.address_line_2 && (
                        <div>{booking.booking.pickup_address.address_line_2}</div>
                      )}
                      <div>
                        {booking.booking?.pickup_address?.city}, {booking.booking?.pickup_address?.state} {booking.booking?.pickup_address?.zip_code}
                      </div>
                    </div>
                  </div>
                  
                  <div>
                    <h4 className="font-medium text-navy-900 mb-2">Delivery Address</h4>
                    <div className="text-navy-800 text-sm">
                      <div>{booking.booking?.delivery_address?.address_line_1}</div>
                      {booking.booking?.delivery_address?.address_line_2 && (
                        <div>{booking.booking.delivery_address.address_line_2}</div>
                      )}
                      <div>
                        {booking.booking?.delivery_address?.city}, {booking.booking?.delivery_address?.state} {booking.booking?.delivery_address?.zip_code}
                      </div>
                    </div>
                  </div>
                </div>
              </CardContent>
            </Card>

            {/* Enhanced Payment Information */}
            {booking.payment && (
              <Card className="lg:col-span-2">
                <CardHeader>
                  <div className="flex justify-between items-center">
                    <h3 className="text-lg font-medium text-navy-900">Payment Information</h3>
                    {booking.payment.status === 'succeeded' && (
                      <Button
                        variant="primary"
                        size="sm"
                        onClick={() => setShowRefundModal(true)}
                      >
                        Issue Refund
                      </Button>
                    )}
                  </div>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-3 gap-4 text-navy-800">
                    <div>
                      <strong className="text-navy-900">Status:</strong>{' '}
                      <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ml-2 ${getPaymentStatusColor(booking.payment.status)}`}>
                        {booking.payment.status}
                      </span>
                    </div>
                    <div><strong className="text-navy-900">Amount:</strong> ${booking.payment.amount_dollars}</div>
                    <div><strong className="text-navy-900">Payment ID:</strong> <span className="text-xs font-mono">{booking.payment.id}</span></div>
                  </div>

                  {booking.payment.processed_at && (
                    <div className="text-sm text-navy-600">
                      Processed: {new Date(booking.payment.processed_at).toLocaleString()}
                    </div>
                  )}

                  {refundsData && refundsData.length > 0 && (
                    <div className="border-t pt-4 mt-4">
                      <h4 className="font-medium text-navy-900 mb-3">Refund History</h4>
                      <div className="space-y-2">
                        {refundsData.map((refund: Refund) => (
                          <div key={refund.id} className="bg-orange-50 border border-orange-200 rounded-md p-3">
                            <div className="flex justify-between items-start mb-2">
                              <div>
                                <span className="font-medium text-navy-900">${refund.amount_dollars}</span>
                                <span className={`ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${
                                  refund.status === 'completed'
                                    ? 'bg-green-100 text-green-800'
                                    : 'bg-amber-100 text-amber-800'
                                }`}>
                                  {refund.status}
                                </span>
                              </div>
                              <span className="text-xs text-navy-600">
                                {new Date(refund.created_at).toLocaleDateString()}
                              </span>
                            </div>
                            <p className="text-sm text-navy-700 mb-1">
                              <strong>Reason:</strong> {refund.reason}
                            </p>
                            <p className="text-xs text-navy-600">
                              By: {refund.requested_by_name}
                            </p>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                </CardContent>
              </Card>
            )}

            {/* Activity Log */}
            <Card className="lg:col-span-2">
              <CardHeader>
                <h3 className="text-lg font-medium text-navy-900">Activity Timeline</h3>
              </CardHeader>
              <CardContent>
                <div className="space-y-3 text-sm">
                  {booking.booking?.created_at && (
                    <div className="flex items-start">
                      <div className="w-32 text-navy-600 flex-shrink-0">
                        {new Date(booking.booking.created_at).toLocaleDateString()}
                      </div>
                      <div className="text-navy-800">
                        Booking created by {booking.customer?.name || 'Guest'}
                      </div>
                    </div>
                  )}
                  
                  {booking.payment?.processed_at && (
                    <div className="flex items-start">
                      <div className="w-32 text-navy-600 flex-shrink-0">
                        {new Date(booking.payment.processed_at).toLocaleDateString()}
                      </div>
                      <div className="text-navy-800">
                        Payment received (${booking.payment.amount_dollars})
                      </div>
                    </div>
                  )}
                  
                  {refundsData?.map((refund: Refund) => (
                    <div key={refund.id} className="flex items-start">
                      <div className="w-32 text-navy-600 flex-shrink-0">
                        {new Date(refund.created_at).toLocaleDateString()}
                      </div>
                      <div className="text-navy-800">
                        Refund processed by {refund.requested_by_name} (${refund.amount_dollars})
                      </div>
                    </div>
                  ))}
                  
                  {booking.booking?.updated_at && booking.booking.updated_at !== booking.booking.created_at && (
                    <div className="flex items-start">
                      <div className="w-32 text-navy-600 flex-shrink-0">
                        {new Date(booking.booking.updated_at).toLocaleDateString()}
                      </div>
                      <div className="text-navy-800">
                        Booking updated
                      </div>
                    </div>
                  )}
                </div>
              </CardContent>
            </Card>
          </div>
        )}

        {/* Refund Modal */}
        {booking.payment && (
          <RefundModal
            isOpen={showRefundModal}
            onClose={() => setShowRefundModal(false)}
            payment={booking.payment}
            bookingNumber={booking.booking?.booking_number || ''}
          />
        )}
      </div>
    </StaffLayout>
  );
}
```

# ──── frontend/src/app/staff/calendar/page.tsx ────

```tsx
// frontend/src/app/staff/calendar/page.tsx
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useStaffAuthStore } from '@/stores/staff-auth-store';
import { StaffLayout } from '@/components/staff/staff-layout';
import { BookingCalendar } from '@/components/staff/booking-calendar'; // ADD THIS

export default function StaffCalendarPage() {
  const { isAuthenticated, isLoading } = useStaffAuthStore();
  const router = useRouter();

  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      router.push('/staff/login');
    }
  }, [isAuthenticated, isLoading, router]);

  if (isLoading || !isAuthenticated) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-navy-900"></div>
      </div>
    );
  }

  return (
    <StaffLayout>
      <BookingCalendar /> {/* CHANGE THIS */}
    </StaffLayout>
  );
}
```

# ──── frontend/src/app/staff/customers/page.tsx ────

```tsx
// frontend/src/app/staff/customers/page.tsx
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useStaffAuthStore } from '@/stores/staff-auth-store';
import { StaffLayout } from '@/components/staff/staff-layout';
import { CustomerManagement } from '@/components/staff/customer-management';

export default function StaffCustomersPage() {
  const { isAuthenticated, isLoading } = useStaffAuthStore();
  const router = useRouter();

  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      router.push('/staff/login');
    }
  }, [isAuthenticated, isLoading, router]);

  if (isLoading || !isAuthenticated) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-navy-900"></div>
      </div>
    );
  }

  return (
    <StaffLayout>
      <CustomerManagement />
    </StaffLayout>
  );
}
```

# ──── frontend/src/app/staff/customers/[id]/page.tsx ────

```tsx
'use client';

import { useEffect, useState } from 'react';
import { useRouter, useParams } from 'next/navigation';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { useStaffAuthStore } from '@/stores/staff-auth-store';
import { StaffLayout } from '@/components/staff/staff-layout';
import { apiClient } from '@/lib/api-client';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';

export default function CustomerDetailPage() {
  const { isAuthenticated, isLoading } = useStaffAuthStore();
  const router = useRouter();
  const params = useParams();
  const customerId = params.id as string;
  const queryClient = useQueryClient();

  const [isEditingNotes, setIsEditingNotes] = useState(false);
  const [notes, setNotes] = useState('');

  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      router.push('/staff/login');
    }
  }, [isAuthenticated, isLoading, router]);

  const { data: customer, isLoading: customerLoading } = useQuery({
    queryKey: ['staff', 'customer', customerId],
    queryFn: async () => {
      const response = await apiClient.get(`/api/staff/customers/${customerId}/`);
      return response.data;
    },
    enabled: !!customerId && isAuthenticated
  });

  const updateNotesMutation = useMutation({
    mutationFn: async (newNotes: string) => {
      const response = await apiClient.patch(`/api/staff/customers/${customerId}/notes/`, {
        notes: newNotes
      });
      return response.data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['staff', 'customer', customerId] });
      setIsEditingNotes(false);
    }
  });

  useEffect(() => {
    if (customer?.notes) {
      setNotes(customer.notes);
    }
  }, [customer]);

  const handleSaveNotes = () => {
    updateNotesMutation.mutate(notes);
  };

  if (isLoading || !isAuthenticated || customerLoading) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-navy-900"></div>
      </div>
    );
  }

  if (!customer) {
    return (
      <StaffLayout>
        <div className="text-center py-12">
          <h1 className="text-2xl font-bold text-navy-900">Customer Not Found</h1>
          <p className="text-navy-600 mt-2">The requested customer could not be found.</p>
          <Button 
            variant="primary" 
            onClick={() => router.push('/staff/customers')}
            className="mt-4"
          >
            Back to Customers
          </Button>
        </div>
      </StaffLayout>
    );
  }

  return (
    <StaffLayout>
      <div className="space-y-6">
        {/* Header */}
        <div className="flex justify-between items-center">
          <div>
            <h1 className="text-2xl font-serif font-bold text-navy-900">{customer.name}</h1>
            <p className="text-navy-600 mt-1">{customer.email}</p>
          </div>
          <Button variant="outline" onClick={() => router.push('/staff/customers')}>
            ← Back to Customers
          </Button>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Customer Information */}
          <Card>
            <CardHeader>
              <h3 className="text-lg font-medium text-navy-900">Customer Information</h3>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="text-navy-800"><strong className="text-navy-900">Name:</strong> {customer.name}</div>
              <div className="text-navy-800"><strong className="text-navy-900">Email:</strong> {customer.email}</div>
              <div className="text-navy-800"><strong className="text-navy-900">Phone:</strong> {customer.phone}</div>
              <div className="text-navy-800">
                <strong className="text-navy-900">VIP Status:</strong> 
                <span className={`ml-2 inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                  customer.is_vip ? 'bg-gold-100 text-gold-800' : 'bg-gray-100 text-gray-800'
                }`}>
                  {customer.is_vip ? 'VIP Customer' : 'Standard Customer'}
                </span>
              </div>
              <div className="text-navy-800"><strong className="text-navy-900">Member Since:</strong> {new Date(customer.created_at).toLocaleDateString()}</div>
            </CardContent>
          </Card>

          {/* Customer Stats */}
          <Card>
            <CardHeader>
              <h3 className="text-lg font-medium text-navy-900">Customer Stats</h3>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div className="text-center p-4 bg-navy-50 rounded-lg">
                  <div className="text-2xl font-bold text-navy-900">{customer.total_bookings}</div>
                  <div className="text-sm text-navy-600">Total Bookings</div>
                </div>
                <div className="text-center p-4 bg-green-50 rounded-lg">
                  <div className="text-2xl font-bold text-green-700">${customer.total_spent_dollars}</div>
                  <div className="text-sm text-navy-600">Total Spent</div>
                </div>
              </div>
              {customer.last_booking_at && (
                <div className="text-navy-800">
                  <strong className="text-navy-900">Last Booking:</strong> {new Date(customer.last_booking_at).toLocaleDateString()}
                </div>
              )}
            </CardContent>
          </Card>

          {/* Customer Notes */}
          <Card className="lg:col-span-2">
            <CardHeader>
              <div className="flex justify-between items-center">
                <h3 className="text-lg font-medium text-navy-900">Customer Notes</h3>
                {!isEditingNotes && (
                  <Button 
                    variant="outline" 
                    size="sm"
                    onClick={() => setIsEditingNotes(true)}
                  >
                    {customer.notes ? 'Edit Notes' : 'Add Notes'}
                  </Button>
                )}
              </div>
            </CardHeader>
            <CardContent>
              {isEditingNotes ? (
                <div className="space-y-4">
                  <textarea
                    value={notes}
                    onChange={(e) => setNotes(e.target.value)}
                    placeholder="Add notes about this customer..."
                    rows={4}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-navy-500 focus:border-navy-500 text-gray-900"
                  />
                  <div className="flex space-x-2">
                    <Button 
                      variant="primary" 
                      onClick={handleSaveNotes}
                      disabled={updateNotesMutation.isPending}
                    >
                      {updateNotesMutation.isPending ? 'Saving...' : 'Save Notes'}
                    </Button>
                    <Button variant="outline" onClick={() => setIsEditingNotes(false)}>
                      Cancel
                    </Button>
                  </div>
                </div>
              ) : (
                <div className="text-navy-800">
                  {customer.notes || (
                    <em className="text-navy-500">No notes added yet. Click Edit to add customer notes.</em>
                  )}
                </div>
              )}
            </CardContent>
          </Card>

          {/* Saved Addresses */}
          {customer.saved_addresses && customer.saved_addresses.length > 0 && (
            <Card className="lg:col-span-2">
              <CardHeader>
                <h3 className="text-lg font-medium text-navy-900">Saved Addresses</h3>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {customer.saved_addresses.map((address: any, index: number) => (
                    <div key={address.id} className="p-4 border border-gray-200 rounded-lg">
                      <div className="text-navy-800">
                        <div className="font-medium">Address {index + 1}</div>
                        <div>{address.address_line_1}</div>
                        {address.address_line_2 && <div>{address.address_line_2}</div>}
                        <div>{address.city}, {address.state} {address.zip_code}</div>
                        {address.is_primary && (
                          <div className="text-sm text-green-600 mt-1">Primary Address</div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          )}

          {/* Recent Bookings */}
          {customer.recent_bookings && customer.recent_bookings.length > 0 && (
            <Card className="lg:col-span-2">
              <CardHeader>
                <h3 className="text-lg font-medium text-navy-900">Recent Bookings</h3>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  {customer.recent_bookings.map((booking: any) => (
                    <div key={booking.id} className="flex justify-between items-center p-3 border border-gray-200 rounded-lg">
                      <div>
                        <div className="font-medium text-navy-900">{booking.booking_number}</div>
                        <div className="text-sm text-navy-600">
                          {booking.service_type} • {new Date(booking.created_at).toLocaleDateString()}
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="font-medium text-navy-900">${booking.total_price_dollars}</div>
                        <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                          booking.status === 'completed' 
                            ? 'bg-green-100 text-green-800'
                            : booking.status === 'paid'
                            ? 'bg-blue-100 text-blue-800'
                            : 'bg-amber-100 text-amber-800'
                        }`}>
                          {booking.status}
                        </span>
                      </div>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => router.push(`/staff/bookings/${booking.id}`)}
                      >
                        View Booking
                      </Button>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          )}
        </div>
      </div>
    </StaffLayout>
  );
}
```

# ──── frontend/src/app/staff/dashboard/page.tsx ────

```tsx
// frontend/src/app/staff/customers/page.tsx
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useStaffAuthStore } from '@/stores/staff-auth-store';
import { StaffLayout } from '@/components/staff/staff-layout';
import { StaffDashboardOverview } from '@/components/staff/staff-dashboard-overview';

export default function StaffDashboardPage() {
  const { isAuthenticated, isLoading } = useStaffAuthStore();
  const router = useRouter();

  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      router.push('/staff/login');
    }
  }, [isAuthenticated, isLoading, router]);

  if (isLoading || !isAuthenticated) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-navy-900"></div>
      </div>
    );
  }

  return (
    <StaffLayout>
      <StaffDashboardOverview />
    </StaffLayout>
  );
}
```

# ──── frontend/src/app/staff/login/page.tsx ────

```tsx
// frontend/src/app/staff/login/page.tsx
import { StaffLoginForm } from '@/components/staff/staff-login-form';

export default function StaffLoginPage() {
  return <StaffLoginForm />;
}
```

# ──── frontend/src/app/staff/logistics/page.tsx ────

```tsx
// frontend/src/app/staff/logistics/page.tsx
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useStaffAuthStore } from '@/stores/staff-auth-store';
import { StaffLayout } from '@/components/staff/staff-layout';
import { LogisticsManagement } from '@/components/staff/logistics-management';

export default function StaffLogisticsPage() {
  const { isAuthenticated, isLoading } = useStaffAuthStore();
  const router = useRouter();

  useEffect(() => {
    if (!isLoading && !isAuthenticated) {
      router.push('/staff/login');
    }
  }, [isAuthenticated, isLoading, router]);

  if (isLoading || !isAuthenticated) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-navy-900"></div>
      </div>
    );
  }

  return (
    <StaffLayout>
      <LogisticsManagement />
    </StaffLayout>
  );
}
```

# ──── frontend/src/app/staff/reports/page.tsx ────

```tsx
// frontend/src/app/staff/reports/page.tsx
'use client';

import { useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useQuery } from '@tanstack/react-query';
import { useStaffAuthStore } from '@/stores/staff-auth-store';
import { StaffLayout } from '@/components/staff/staff-layout';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { apiClient } from '@/lib/api-client';
import {
  CurrencyDollarIcon,
  CalendarDaysIcon,
  UserGroupIcon,
  ArrowTrendingUpIcon,
  ArrowTrendingDownIcon,
  CheckCircleIcon,
  XCircleIcon,
} from '@heroicons/react/24/outline';

interface ReportsData {
  revenue: {
    total_all_time: number;
    last_30_days: number;
    average_booking_value: number;
    daily: Array<{ date: string; revenue: number }>;
    monthly: Array<{ month: string; revenue: number; count: number }>;
  };
  bookings: {
    total: number;
    by_status: {
      pending: number;
      confirmed: number;
      paid: number;
      completed: number;
      cancelled: number;
    };
    by_service: Array<{ service_type: string; count: number; revenue: number }>;
    daily: Array<{ date: string; count: number }>;
  };
  customers: {
    total: number;
    vip: number;
    new_last_30_days: number;
    top_customers: Array<{
      name: string;
      email: string;
      booking_count: number;
      total_spent: number;
      is_vip: boolean;
    }>;
  };
  performance: {
    completion_rate: number;
    cancellation_rate: number;
  };
  generated_at: string;
}

const SERVICE_LABELS: Record<string, string> = {
  mini_move: 'Mini Move',
  standard_delivery: 'Standard Delivery',
  specialty_item: 'Specialty Item',
  blade_transfer: 'BLADE Transfer',
};

function formatCurrency(amount: number): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(amount);
}

function SimpleBarChart({ data, valueKey, labelKey, color = 'bg-navy-600' }: {
  data: Array<Record<string, any>>;
  valueKey: string;
  labelKey: string;
  color?: string;
}) {
  if (!data || data.length === 0) {
    return <p className="text-navy-500 text-sm">No data available</p>;
  }

  const maxValue = Math.max(...data.map(d => d[valueKey] || 0));

  return (
    <div className="space-y-2">
      {data.slice(-10).map((item, index) => (
        <div key={index} className="flex items-center gap-3">
          <span className="text-xs text-navy-600 w-20 truncate">
            {labelKey === 'date' ? new Date(item[labelKey]).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : item[labelKey]}
          </span>
          <div className="flex-1 h-6 bg-gray-100 rounded overflow-hidden">
            <div
              className={`h-full ${color} transition-all duration-300`}
              style={{ width: `${maxValue > 0 ? (item[valueKey] / maxValue) * 100 : 0}%` }}
            />
          </div>
          <span className="text-xs font-medium text-navy-900 w-16 text-right">
            {typeof item[valueKey] === 'number' && valueKey.includes('revenue')
              ? formatCurrency(item[valueKey])
              : item[valueKey]}
          </span>
        </div>
      ))}
    </div>
  );
}

export default function StaffReportsPage() {
  const { isAuthenticated, isLoading: authLoading } = useStaffAuthStore();
  const router = useRouter();

  const { data: reports, isLoading, error } = useQuery({
    queryKey: ['staff', 'reports'],
    queryFn: async (): Promise<ReportsData> => {
      const response = await apiClient.get('/api/staff/reports/');
      return response.data;
    },
    enabled: isAuthenticated,
    staleTime: 5 * 60 * 1000, // 5 minutes
  });

  useEffect(() => {
    if (!authLoading && !isAuthenticated) {
      router.push('/staff/login');
    }
  }, [isAuthenticated, authLoading, router]);

  if (authLoading || !isAuthenticated) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-navy-900"></div>
      </div>
    );
  }

  if (isLoading) {
    return (
      <StaffLayout>
        <div className="space-y-6">
          <h1 className="text-2xl font-serif font-bold text-navy-900">Reports & Analytics</h1>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            {[...Array(4)].map((_, i) => (
              <Card key={i} className="animate-pulse">
                <CardContent className="p-6">
                  <div className="h-4 bg-gray-200 rounded mb-2 w-24"></div>
                  <div className="h-8 bg-gray-200 rounded w-32"></div>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>
      </StaffLayout>
    );
  }

  if (error) {
    return (
      <StaffLayout>
        <div className="space-y-6">
          <h1 className="text-2xl font-serif font-bold text-navy-900">Reports & Analytics</h1>
          <Card>
            <CardContent className="p-6">
              <p className="text-red-600">Failed to load reports. Please try again.</p>
            </CardContent>
          </Card>
        </div>
      </StaffLayout>
    );
  }

  return (
    <StaffLayout>
      <div className="space-y-6">
        <div className="flex justify-between items-center">
          <h1 className="text-2xl font-serif font-bold text-navy-900">Reports & Analytics</h1>
          <p className="text-sm text-navy-500">
            Last updated: {reports ? new Date(reports.generated_at).toLocaleString() : '-'}
          </p>
        </div>

        {/* Key Metrics */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-navy-600">Total Revenue</p>
                  <p className="text-2xl font-bold text-navy-900">
                    {formatCurrency(reports?.revenue.total_all_time || 0)}
                  </p>
                </div>
                <div className="p-3 bg-green-100 rounded-full">
                  <CurrencyDollarIcon className="h-6 w-6 text-green-600" />
                </div>
              </div>
              <p className="text-xs text-navy-500 mt-2">
                Last 30 days: {formatCurrency(reports?.revenue.last_30_days || 0)}
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-navy-600">Total Bookings</p>
                  <p className="text-2xl font-bold text-navy-900">
                    {reports?.bookings.total || 0}
                  </p>
                </div>
                <div className="p-3 bg-blue-100 rounded-full">
                  <CalendarDaysIcon className="h-6 w-6 text-blue-600" />
                </div>
              </div>
              <p className="text-xs text-navy-500 mt-2">
                Avg value: {formatCurrency(reports?.revenue.average_booking_value || 0)}
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-navy-600">Total Customers</p>
                  <p className="text-2xl font-bold text-navy-900">
                    {reports?.customers.total || 0}
                  </p>
                </div>
                <div className="p-3 bg-purple-100 rounded-full">
                  <UserGroupIcon className="h-6 w-6 text-purple-600" />
                </div>
              </div>
              <p className="text-xs text-navy-500 mt-2">
                VIP: {reports?.customers.vip || 0} | New (30d): {reports?.customers.new_last_30_days || 0}
              </p>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm text-navy-600">Completion Rate</p>
                  <p className="text-2xl font-bold text-navy-900">
                    {reports?.performance.completion_rate || 0}%
                  </p>
                </div>
                <div className="p-3 bg-emerald-100 rounded-full">
                  <CheckCircleIcon className="h-6 w-6 text-emerald-600" />
                </div>
              </div>
              <p className="text-xs text-navy-500 mt-2">
                Cancellation: {reports?.performance.cancellation_rate || 0}%
              </p>
            </CardContent>
          </Card>
        </div>

        {/* Charts Row */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Daily Revenue */}
          <Card>
            <CardHeader>
              <h3 className="text-lg font-semibold text-navy-900">Daily Revenue (Last 30 Days)</h3>
            </CardHeader>
            <CardContent>
              <SimpleBarChart
                data={reports?.revenue.daily || []}
                valueKey="revenue"
                labelKey="date"
                color="bg-green-500"
              />
            </CardContent>
          </Card>

          {/* Daily Bookings */}
          <Card>
            <CardHeader>
              <h3 className="text-lg font-semibold text-navy-900">Daily Bookings (Last 30 Days)</h3>
            </CardHeader>
            <CardContent>
              <SimpleBarChart
                data={reports?.bookings.daily || []}
                valueKey="count"
                labelKey="date"
                color="bg-blue-500"
              />
            </CardContent>
          </Card>
        </div>

        {/* Bookings Breakdown Row */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Bookings by Status */}
          <Card>
            <CardHeader>
              <h3 className="text-lg font-semibold text-navy-900">Bookings by Status</h3>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                {reports?.bookings.by_status && Object.entries(reports.bookings.by_status).map(([status, count]) => (
                  <div key={status} className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <span className={`w-3 h-3 rounded-full ${
                        status === 'completed' ? 'bg-green-500' :
                        status === 'paid' ? 'bg-blue-500' :
                        status === 'confirmed' ? 'bg-yellow-500' :
                        status === 'pending' ? 'bg-orange-500' :
                        'bg-red-500'
                      }`} />
                      <span className="text-sm text-navy-700 capitalize">{status}</span>
                    </div>
                    <span className="text-sm font-semibold text-navy-900">{count}</span>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>

          {/* Bookings by Service Type */}
          <Card>
            <CardHeader>
              <h3 className="text-lg font-semibold text-navy-900">Revenue by Service</h3>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                {reports?.bookings.by_service?.map((service) => (
                  <div key={service.service_type} className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-navy-900">
                        {SERVICE_LABELS[service.service_type] || service.service_type}
                      </p>
                      <p className="text-xs text-navy-500">{service.count} bookings</p>
                    </div>
                    <span className="text-sm font-semibold text-green-600">
                      {formatCurrency(service.revenue)}
                    </span>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Top Customers */}
        <Card>
          <CardHeader>
            <h3 className="text-lg font-semibold text-navy-900">Top Customers</h3>
          </CardHeader>
          <CardContent>
            {reports?.customers.top_customers && reports.customers.top_customers.length > 0 ? (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="border-b border-gray-200">
                      <th className="text-left py-3 px-4 text-sm font-semibold text-navy-900">Customer</th>
                      <th className="text-left py-3 px-4 text-sm font-semibold text-navy-900">Email</th>
                      <th className="text-center py-3 px-4 text-sm font-semibold text-navy-900">Bookings</th>
                      <th className="text-right py-3 px-4 text-sm font-semibold text-navy-900">Total Spent</th>
                      <th className="text-center py-3 px-4 text-sm font-semibold text-navy-900">Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    {reports.customers.top_customers.map((customer, index) => (
                      <tr key={index} className="border-b border-gray-100 hover:bg-gray-50">
                        <td className="py-3 px-4 text-sm text-navy-900">{customer.name}</td>
                        <td className="py-3 px-4 text-sm text-navy-600">{customer.email}</td>
                        <td className="py-3 px-4 text-sm text-navy-900 text-center">{customer.booking_count}</td>
                        <td className="py-3 px-4 text-sm font-semibold text-green-600 text-right">
                          {formatCurrency(customer.total_spent)}
                        </td>
                        <td className="py-3 px-4 text-center">
                          {customer.is_vip ? (
                            <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gold-100 text-gold-800">
                              VIP
                            </span>
                          ) : (
                            <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                              Regular
                            </span>
                          )}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            ) : (
              <p className="text-navy-500 text-sm">No customer data available</p>
            )}
          </CardContent>
        </Card>

        {/* Monthly Revenue */}
        <Card>
          <CardHeader>
            <h3 className="text-lg font-semibold text-navy-900">Monthly Revenue (Last 12 Months)</h3>
          </CardHeader>
          <CardContent>
            {reports?.revenue.monthly && reports.revenue.monthly.length > 0 ? (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead>
                    <tr className="border-b border-gray-200">
                      <th className="text-left py-3 px-4 text-sm font-semibold text-navy-900">Month</th>
                      <th className="text-right py-3 px-4 text-sm font-semibold text-navy-900">Revenue</th>
                      <th className="text-right py-3 px-4 text-sm font-semibold text-navy-900">Transactions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {reports.revenue.monthly.map((month, index) => (
                      <tr key={index} className="border-b border-gray-100 hover:bg-gray-50">
                        <td className="py-3 px-4 text-sm text-navy-900">
                          {new Date(month.month + '-01').toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                        </td>
                        <td className="py-3 px-4 text-sm font-semibold text-green-600 text-right">
                          {formatCurrency(month.revenue)}
                        </td>
                        <td className="py-3 px-4 text-sm text-navy-600 text-right">{month.count}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            ) : (
              <p className="text-navy-500 text-sm">No monthly data available</p>
            )}
          </CardContent>
        </Card>
      </div>
    </StaffLayout>
  );
}
```

# ──── frontend/src/app/terms/page.tsx ────

```tsx
// frontend/src/app/terms/page.tsx
import { MainLayout } from '@/components/layout/main-layout';
import { Card, CardContent, CardHeader } from '@/components/ui/card';

export default function TermsPage() {
  return (
    <MainLayout>
      <div className="container mx-auto px-4 py-12 max-w-4xl">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-serif font-bold text-navy-900 mb-4">
            Terms of Service
          </h1>
          <p className="text-navy-600">
            Effective Date: January 2024 • Last Updated: January 2024
          </p>
        </div>

        <Card variant="elevated">
          <CardContent className="space-y-6 text-navy-700">
            
            <section>
              <h2 className="text-xl font-bold text-navy-900 mb-3">General Terms</h2>
              <p className="mb-4">
                <strong>PLEASE READ THESE TERMS AND CONDITIONS (THE "TERMS AND CONDITIONS") CAREFULLY.</strong> 
                By using Tote Taxi and/or the Tote Taxi Website, you are agreeing to be bound by these Terms and Conditions. 
                If you do not agree to the Terms and Conditions, do not use Tote Taxi's services or the Tote Taxi Website.
              </p>
              
              <p className="mb-4">
                Tote Taxi LLC ("Tote Taxi") may revise and update these Terms and Conditions at any time without notice. 
                Your continued usage of the Tote Taxi Website after any such change or update will mean you accept those changes or updates.
              </p>
              
              <p className="mb-4">
                Any aspect of the Tote Taxi Website may be changed, supplemented, deleted or updated without notice at the sole discretion of Tote Taxi.
              </p>
            </section>

            <section>
              <h2 className="text-xl font-bold text-navy-900 mb-3">Service Limitations</h2>
              <p className="mb-4">
                <strong>Tote Taxi will not accept for transport luggage or packages in excess of $150.00 in value.</strong> 
                Tote Taxi's inadvertent acceptance of any luggage or package in excess of $150.00 shall not negate 
                Tote Taxi's limitation of liability stated herein.
              </p>
              
              <p className="mb-4">
                By delivering luggage or package to, or causing luggage or package to be delivered to, Tote Taxi for transport, 
                you represent that the luggage or package does not contain any illegal substances, any liquids, or any hazardous materials, 
                and does not exceed $150.00 in value.
              </p>
              
              <p className="mb-4">
                Tote Taxi reserves the right to reject any luggage or packages that are damaged or are improperly packed.
              </p>
            </section>

            <section>
              <h2 className="text-xl font-bold text-navy-900 mb-3">Limitation of Liability</h2>
              <p className="mb-4">
                TO THE EXTENT NOT PROHIBITED BY APPLICABLE LAW, IN NO EVENT SHALL TOTE TAXI BE LIABLE FOR PERSONAL INJURY, 
                OR ANY INCIDENTAL, SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES WHATSOEVER, REGARDLESS OF THE THEORY OF LIABILITY 
                (CONTRACT, TORT OR OTHERWISE) EVEN IF Tote Taxi HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.
              </p>
              
              <p className="mb-4">
                In no event shall Tote Taxi's total liability to you for all damages (other than as may be required by applicable law 
                in cases involving personal injury) exceed $150.00.
              </p>
            </section>

            <section>
              <h2 className="text-xl font-bold text-navy-900 mb-3">Intellectual Property</h2>
              <p className="mb-4">
                Any and all intellectual property rights associated with Tote Taxi and with the Tote Taxi Website and its contents 
                are the sole property of Tote Taxi, its affiliates or third parties.
              </p>
              
              <p className="mb-4">
                The Tote Taxi Website is protected by copyright and other laws in both the United States and other countries. 
                Elements of the Tote Taxi Website are also protected by trade dress, trade secret, unfair competition, 
                and other laws and may not be copied or imitated in whole or in part.
              </p>
            </section>

            <section>
              <h2 className="text-xl font-bold text-navy-900 mb-3">Privacy</h2>
              <p className="mb-4">
                At all times your information will be treated in accordance with Tote Taxi's Privacy Policy, 
                which is incorporated by reference into these Terms and Conditions.
              </p>
              
              <p className="mb-4">
                You agree that Tote Taxi and its agents may collect, maintain, process and use diagnostic, technical, 
                usage and related information, that is gathered periodically to facilitate the provision of updates, 
                product support and other services to you related to Tote Taxi.
              </p>
            </section>

            <section>
              <h2 className="text-xl font-bold text-navy-900 mb-3">Governing Law</h2>
              <p className="mb-4">
                Regardless of its place of negotiation, execution, or performance, you agree that these Terms and Conditions 
                are governed by and shall be construed in accordance with the internal substantive laws of the State of New York.
              </p>
              
              <p className="mb-4">
                Each party agrees to the exclusive jurisdiction of the state and federal courts in and for Suffolk County, 
                New York for any litigation or other dispute resolution relating in any way to these Terms and Conditions.
              </p>
            </section>

            <section>
              <h2 className="text-xl font-bold text-navy-900 mb-3">Contact Information</h2>
              <p className="mb-4">
                If you have any questions about these Terms of Service, please contact us at:
              </p>
              <div className="bg-cream-50 p-4 rounded-lg">
                <p className="font-medium text-navy-900">Tote Taxi LLC</p>
                <p>Email: legal@totetaxi.com</p>
                <p>Phone: (555) TOTE-TAXI</p>
              </div>
            </section>

          </CardContent>
        </Card>
      </div>
    </MainLayout>
  );
}
```

# ──── frontend/src/app/verify-email/page.tsx ────

```tsx
'use client';
// frontend/src/app/verify-email/page.tsx
import { Suspense, useEffect, useState } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { apiClient } from '@/lib/api-client';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';

// Extract the component that uses useSearchParams
function VerifyEmailContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const token = searchParams.get('token');
  
  const [status, setStatus] = useState<'verifying' | 'success' | 'error'>('verifying');
  const [errorMessage, setErrorMessage] = useState('');
  const [email, setEmail] = useState('');
  const [isResending, setIsResending] = useState(false);

  useEffect(() => {
    if (!token) {
      setStatus('error');
      setErrorMessage('No verification token provided.');
      return;
    }

    const verifyEmail = async () => {
      try {
        const response = await apiClient.post('/api/customer/auth/verify-email/', {
          token
        });

        setStatus('success');
        setEmail(response.data.email);
      } catch (error: any) {
        setStatus('error');
        setErrorMessage(
          error.response?.data?.error || 
          'Verification failed. The link may be expired or invalid.'
        );
      }
    };

    verifyEmail();
  }, [token]);

  const handleResendVerification = async () => {
    if (!email) return;
    
    setIsResending(true);
    try {
      await apiClient.post('/api/customer/auth/resend-verification/', {
        email
      });
      setErrorMessage('A new verification email has been sent. Please check your inbox.');
    } catch (error) {
      setErrorMessage('Failed to resend verification email. Please try again later.');
    } finally {
      setIsResending(false);
    }
  };

  return (
    <Card variant="elevated" className="max-w-md w-full">
      <CardContent className="p-8 text-center">
        {status === 'verifying' && (
          <>
            <div className="w-16 h-16 border-4 border-navy-900 border-t-transparent rounded-full animate-spin mx-auto mb-4" />
            <h2 className="text-2xl font-serif font-bold text-navy-900 mb-2">
              Verifying Your Email
            </h2>
            <p className="text-navy-600">
              Please wait while we verify your account...
            </p>
          </>
        )}

        {status === 'success' && (
          <>
            <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <h2 className="text-2xl font-serif font-bold text-navy-900 mb-2">
              Email Verified!
            </h2>
            <p className="text-navy-600 mb-6">
              Your account has been successfully verified. You can now log in and start booking.
            </p>
            <Button
              variant="primary"
              size="lg"
              onClick={() => router.push('/login')}
              className="w-full"
            >
              Go to Login
            </Button>
          </>
        )}

        {status === 'error' && (
          <>
            <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg className="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
              </svg>
            </div>
            <h2 className="text-2xl font-serif font-bold text-navy-900 mb-2">
              Verification Failed
            </h2>
            <p className="text-red-600 mb-6">
              {errorMessage}
            </p>
            
            {email && (
              <Button
                variant="primary"
                size="lg"
                onClick={handleResendVerification}
                disabled={isResending}
                className="w-full mb-3"
              >
                {isResending ? 'Sending...' : 'Resend Verification Email'}
              </Button>
            )}
            
            <Button
              variant="outline"
              size="lg"
              onClick={() => router.push('/register')}
              className="w-full"
            >
              Back to Registration
            </Button>
          </>
        )}
      </CardContent>
    </Card>
  );
}

// Loading fallback component
function VerifyEmailLoading() {
  return (
    <Card variant="elevated" className="max-w-md w-full">
      <CardContent className="p-8 text-center">
        <div className="w-16 h-16 border-4 border-navy-900 border-t-transparent rounded-full animate-spin mx-auto mb-4" />
        <h2 className="text-2xl font-serif font-bold text-navy-900 mb-2">
          Loading...
        </h2>
        <p className="text-navy-600">
          Please wait...
        </p>
      </CardContent>
    </Card>
  );
}

// Main page component with Suspense wrapper
export default function VerifyEmailPage() {
  return (
    <div className="min-h-screen flex items-center justify-center bg-cream-50 py-12 px-4">
      <Suspense fallback={<VerifyEmailLoading />}>
        <VerifyEmailContent />
      </Suspense>
    </div>
  );
}
```

# ──── frontend/src/components/auth/index.ts ────

```typescript

```

# ──── frontend/src/components/auth/login-form.tsx ────

```tsx
// frontend/src/components/auth/login-form.tsx
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { useAuthStore } from '@/stores/auth-store';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { apiClient } from '@/lib/api-client';

export function LoginForm() {
  const router = useRouter();
  const { login, isLoading } = useAuthStore();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [rememberMe, setRememberMe] = useState(false);
  const [apiError, setApiError] = useState('');
  const [needsVerification, setNeedsVerification] = useState(false);

  const onSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setApiError('');
    setNeedsVerification(false);

    try {
      const result = await login(email.toLowerCase().trim(), password);

      if (result.success) {
        // Save remember me preference
        if (rememberMe) {
          localStorage.setItem('totetaxi-remember-email', email.toLowerCase().trim());
        } else {
          localStorage.removeItem('totetaxi-remember-email');
        }

        router.push('/dashboard');
      } else {
        // Handle specific error types
        const errorMsg = result.error || 'Login failed';
        
        if (errorMsg.includes('verify') || errorMsg.includes('not active')) {
          setNeedsVerification(true);
          setApiError('Please verify your email before logging in. Check your inbox for the verification link.');
        } else if (errorMsg.includes('staff account')) {
          setApiError('This is a staff account. Please use the staff login at /staff/login');
        } else if (errorMsg.includes('Invalid') || errorMsg.includes('credentials')) {
          setApiError('Invalid email or password. Please try again.');
        } else {
          setApiError(errorMsg);
        }
      }
    } catch (error: any) {
      console.error('Login error:', error);
      
      // Handle rate limiting
      if (error.response?.status === 429) {
        setApiError('Too many login attempts. Please wait a few minutes and try again.');
      } else {
        setApiError('An unexpected error occurred. Please try again.');
      }
    }
  };

  const handleResendVerification = async () => {
    try {
      await apiClient.post('/api/customer/auth/resend-verification/', {
        email: email.toLowerCase().trim()
      });
      setApiError('Verification email sent! Please check your inbox.');
      setNeedsVerification(false);
    } catch (error) {
      setApiError('Failed to resend verification email. Please try again later.');
    }
  };

  return (
    <div className="w-full max-w-md mx-auto">
      <Card variant="luxury">
        <CardHeader>
          <h2 className="text-2xl font-serif font-bold text-navy-900 text-center">
            Welcome Back
          </h2>
          <p className="text-navy-700 text-center">
            Sign in to your ToteTaxi account
          </p>
        </CardHeader>

        <CardContent>
          <form onSubmit={onSubmit} className="space-y-4">
            <div>
              <label htmlFor="email" className="block text-sm font-medium text-navy-900 mb-1">
                Email Address
              </label>
              <Input
                id="email"
                type="email"
                value={email}
                onChange={(e) => {
                  setEmail(e.target.value.toLowerCase());
                  setApiError('');
                  setNeedsVerification(false);
                }}
                placeholder="your@email.com"
                disabled={isLoading}
                autoComplete="email"
              />
            </div>

            <div>
              <label htmlFor="password" className="block text-sm font-medium text-navy-900 mb-1">
                Password
              </label>
              <div className="relative">
                <Input
                  id="password"
                  type={showPassword ? 'text' : 'password'}
                  value={password}
                  onChange={(e) => {
                    setPassword(e.target.value);
                    setApiError('');
                    setNeedsVerification(false);
                  }}
                  placeholder="Enter your password"
                  disabled={isLoading}
                  autoComplete="current-password"
                  className="pr-10"
                />
                <button
                  type="button"
                  onClick={() => setShowPassword(!showPassword)}
                  className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                  tabIndex={-1}
                >
                  {showPassword ? (
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                    </svg>
                  ) : (
                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                  )}
                </button>
              </div>
            </div>

            <div className="flex items-center justify-between">
              <label className="flex items-center">
                <input
                  type="checkbox"
                  checked={rememberMe}
                  onChange={(e) => setRememberMe(e.target.checked)}
                  className="w-4 h-4 text-navy-600 border-gray-300 rounded focus:ring-navy-500"
                />
                <span className="ml-2 text-sm text-navy-700">Remember me</span>
              </label>

              <button
                type="button"
                onClick={() => router.push('/forgot-password')}
                className="text-sm text-navy-600 hover:text-navy-900 hover:underline"
              >
                Forgot password?
              </button>
            </div>

            {apiError && (
              <div className="bg-red-50 border border-red-200 rounded-md p-3">
                <p className="text-red-700 text-sm">{apiError}</p>
                {needsVerification && (
                  <button
                    type="button"
                    onClick={handleResendVerification}
                    className="text-red-800 hover:text-red-900 underline text-sm mt-2"
                  >
                    Resend verification email
                  </button>
                )}
              </div>
            )}

            <Button
              type="submit"
              variant="primary"
              size="lg"
              className="w-full"
              disabled={isLoading}
            >
              {isLoading ? 'Signing In...' : 'Sign In'}
            </Button>

            <div className="text-center pt-4 border-t border-cream-200">
              <p className="text-sm text-navy-600">
                Don&apos;t have an account?{' '}
                <button
                  type="button"
                  onClick={() => router.push('/register')}
                  className="text-navy-900 hover:underline font-medium"
                >
                  Create Account
                </button>
              </p>
            </div>
          </form>
        </CardContent>
      </Card>
    </div>
  );
}
```

# ──── frontend/src/components/auth/register-form.tsx ────

```tsx
'use client';
// frontend/src/components/auth/register-form.tsx
import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { apiClient } from '@/lib/api-client';

export function RegisterForm() {
  const router = useRouter();
  const [isLoading, setIsLoading] = useState(false);
  const [isSuccess, setIsSuccess] = useState(false);
  const [apiError, setApiError] = useState('');
  
  const [formData, setFormData] = useState({
    first_name: '',
    last_name: '',
    email: '',
    phone: '',
    password: '',
    password_confirm: ''
  });
  
  const [errors, setErrors] = useState<Record<string, string>>({});
  const [touched, setTouched] = useState<Record<string, boolean>>({});

  const handleChange = (field: string, value: string) => {
    setFormData(prev => ({ ...prev, [field]: value }));
    if (errors[field]) {
      setErrors(prev => ({ ...prev, [field]: '' }));
    }
  };

  const handleBlur = (field: string) => {
    setTouched(prev => ({ ...prev, [field]: true }));
    validateField(field);
  };

  const validateField = (field: string) => {
    const value = formData[field as keyof typeof formData];
    let error = '';

    switch (field) {
      case 'first_name':
        if (!value.trim()) error = 'First name is required';
        break;
      case 'last_name':
        if (!value.trim()) error = 'Last name is required';
        break;
      case 'email':
        if (!value.trim()) {
          error = 'Email is required';
        } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
          error = 'Please enter a valid email address';
        }
        break;
      case 'phone':
        const cleanPhone = value.replace(/\D/g, '');
        if (!cleanPhone) {
          error = 'Phone number is required';
        } else if (cleanPhone.length < 10) {
          error = 'Phone number must be at least 10 digits';
        }
        break;
      case 'password':
        if (!value) {
          error = 'Password is required';
        } else if (value.length < 8) {
          error = 'Password must be at least 8 characters';
        }
        break;
      case 'password_confirm':
        if (!value) {
          error = 'Please confirm your password';
        } else if (value !== formData.password) {
          error = 'Passwords do not match';
        }
        break;
    }

    setErrors(prev => ({ ...prev, [field]: error }));
    return !error;
  };

  const validateAll = () => {
    const fields = ['first_name', 'last_name', 'email', 'phone', 'password', 'password_confirm'];
    const allValid = fields.map(field => validateField(field)).every(Boolean);
    fields.forEach(field => setTouched(prev => ({ ...prev, [field]: true })));
    return allValid;
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setApiError('');

    if (!validateAll()) {
      return;
    }

    setIsLoading(true);

    try {
      // Strip phone formatting - only send digits
      const cleanPhone = formData.phone.replace(/\D/g, '');
      
      await apiClient.post('/api/customer/auth/register/', {
        first_name: formData.first_name,
        last_name: formData.last_name,
        email: formData.email.toLowerCase().trim(),
        phone: cleanPhone, // Send clean phone
        password: formData.password,
        password_confirm: formData.password_confirm
      });
      
      setIsSuccess(true);
    } catch (error: any) {
      setApiError(error.response?.data?.error || 'Registration failed. Please try again.');
    } finally {
      setIsLoading(false);
    }
  };

  if (isSuccess) {
    return (
      <Card variant="elevated" className="max-w-md w-full">
        <CardContent className="p-8 text-center">
          <div className="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg className="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
          </div>
          <h2 className="text-2xl font-serif font-bold text-navy-900 mb-2">
            Check Your Email
          </h2>
          <p className="text-navy-600 mb-4">
            We've sent a verification link to <strong>{formData.email}</strong>
          </p>
          <p className="text-sm text-navy-500 mb-6">
            Click the link in the email to verify your account and complete registration.
          </p>
          <div className="space-y-3">
            <p className="text-xs text-navy-500">
              Didn't receive the email?
            </p>
            <Button
              variant="outline"
              size="lg"
              onClick={async () => {
                try {
                  await apiClient.post('/api/customer/auth/resend-verification/', {
                    email: formData.email
                  });
                  setApiError('Verification email resent! Please check your inbox.');
                } catch (error) {
                  setApiError('Failed to resend email. Please try again later.');
                }
              }}
              className="w-full"
            >
              Resend Verification Email
            </Button>
          </div>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card variant="elevated">
      <CardContent className="p-6">
        <form onSubmit={handleSubmit} className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <Input
              label="First Name"
              value={formData.first_name}
              onChange={(e) => handleChange('first_name', e.target.value)}
              onBlur={() => handleBlur('first_name')}
              error={touched.first_name ? errors.first_name : ''}
              placeholder="John"
              required
            />

            <Input
              label="Last Name"
              value={formData.last_name}
              onChange={(e) => handleChange('last_name', e.target.value)}
              onBlur={() => handleBlur('last_name')}
              error={touched.last_name ? errors.last_name : ''}
              placeholder="Doe"
              required
            />
          </div>

          <Input
            label="Email Address"
            type="email"
            value={formData.email}
            onChange={(e) => handleChange('email', e.target.value.toLowerCase())}
            onBlur={() => handleBlur('email')}
            error={touched.email ? errors.email : ''}
            placeholder="john.doe@example.com"
            required
            realTimeValidation={false}
          />

          <Input
            label="Phone Number"
            type="tel"
            mask="phone"  // Add this
            value={formData.phone}
            onChange={(e) => handleChange('phone', e.target.value)}
            onBlur={() => handleBlur('phone')}
            error={touched.phone ? errors.phone : ''}
            placeholder="(555) 123-4567"
            required
            realTimeValidation={false}
          />

          <Input
            label="Password"
            type="password"
            value={formData.password}
            onChange={(e) => handleChange('password', e.target.value)}
            onBlur={() => handleBlur('password')}
            error={touched.password ? errors.password : ''}
            placeholder="••••••••"
            helper="Must be at least 8 characters"
            required
          />

          <Input
            label="Confirm Password"
            type="password"
            value={formData.password_confirm}
            onChange={(e) => handleChange('password_confirm', e.target.value)}
            onBlur={() => handleBlur('password_confirm')}
            error={touched.password_confirm ? errors.password_confirm : ''}
            placeholder="••••••••"
            required
          />

          {apiError && (
            <div className="bg-red-50 border border-red-200 rounded-md p-3">
              <p className="text-red-700 text-sm">{apiError}</p>
            </div>
          )}

          <Button
            type="submit"
            variant="primary"
            size="lg"
            className="w-full"
            disabled={isLoading}
          >
            {isLoading ? 'Creating Account...' : 'Create Account'}
          </Button>

          <div className="text-center text-sm">
            <span className="text-navy-600">Already have an account? </span>
            <button
              type="button"
              onClick={() => router.push('/login')}
              className="text-navy-900 font-medium hover:underline"
            >
              Log in
            </button>
          </div>
        </form>
      </CardContent>
    </Card>
  );
}
```

# ──── frontend/src/components/auth/user-menu.tsx ────

```tsx
// frontend/src/components/auth/user-menu.tsx
'use client';

import { useState, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { useAuthStore } from '@/stores/auth-store';
import { useClickAway } from '@/hooks/use-click-away';
import { 
  ChevronDownIcon, 
  UserIcon, 
  Cog6ToothIcon, 
  ArrowRightOnRectangleIcon,
  PlusIcon,
  ExclamationTriangleIcon
} from '@heroicons/react/24/outline';

interface UserMenuProps {
  variant?: 'header' | 'mobile';
}

export function UserMenu({ variant = 'header' }: UserMenuProps) {
  const { user, customerProfile, logout, secureReset } = useAuthStore();
  const [isOpen, setIsOpen] = useState(false);
  const router = useRouter();
  const dropdownRef = useRef<HTMLDivElement>(null);

  useClickAway(dropdownRef, () => setIsOpen(false));

  const handleLogout = async () => {
    try {
      console.log('User menu logout initiated');
      await logout();
      router.push('/');
      setIsOpen(false);
    } catch (error) {
      console.error('Logout error:', error);
      // Fallback to secure reset if logout fails
      secureReset();
      router.push('/');
      setIsOpen(false);
    }
  };

  const handleSecureReset = () => {
    console.log('SECURITY: User initiated secure reset');
    secureReset();
    router.push('/');
    if (typeof window !== 'undefined') {
      window.location.reload();
    }
  };

  const menuItems = [
    {
      label: 'Book a Move',
      icon: PlusIcon,
      onClick: () => {
        router.push('/book');
        setIsOpen(false);
      },
      primary: true
    },
    {
      label: 'Dashboard',
      icon: UserIcon,
      onClick: () => {
        router.push('/dashboard');
        setIsOpen(false);
      }
    },
    {
      label: 'Account Settings',
      icon: Cog6ToothIcon,
      onClick: () => {
        router.push('/dashboard/settings'); // ✅ FIXED: Navigate to settings
        setIsOpen(false);
      }
    },
    {
      label: 'Sign Out',
      icon: ArrowRightOnRectangleIcon,
      onClick: handleLogout,
      danger: true
    },
    // Debug option - remove in production
    ...(process.env.NODE_ENV === 'development' ? [{
      label: 'Secure Reset (Debug)',
      icon: ExclamationTriangleIcon,
      onClick: handleSecureReset,
      danger: true
    }] : [])
  ];

  if (!user) return null;

  if (variant === 'mobile') {
    return (
      <div className="space-y-2 pt-4 border-t border-gray-200">
        <div className="px-4 py-3 bg-gray-50 rounded-lg mx-4">
          <p className="font-medium text-navy-900">{user.first_name} {user.last_name}</p>
          <p className="text-sm text-navy-600">{user.email}</p>
          {/* ✅ FIXED: Only show VIP badge, removed total spent */}
          <div className="flex items-center gap-2 mt-2">
            {customerProfile?.is_vip && (
              <span className="inline-block px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full">
                VIP
              </span>
            )}
            {customerProfile && customerProfile.total_bookings > 0 && (
              <span className="inline-block px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">
                {customerProfile.total_bookings} bookings
              </span>
            )}
          </div>
        </div>

        {menuItems.map((item) => {
          const Icon = item.icon;
          return (
            <button
              key={item.label}
              onClick={item.onClick}
              className={`w-full flex items-center px-4 py-3 text-left hover:bg-gray-50 transition-colors ${
                item.primary 
                  ? 'text-blue-600 hover:text-blue-700 font-medium' 
                  : item.danger 
                  ? 'text-red-600 hover:text-red-700' 
                  : 'text-navy-700 hover:text-navy-900'
              }`}
            >
              <Icon className="h-5 w-5 mr-3" />
              {item.label}
            </button>
          );
        })}
      </div>
    );
  }

  return (
    <div className="relative" ref={dropdownRef}>
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="flex items-center space-x-2 text-navy-700 hover:text-navy-900 transition-colors py-2 px-3 rounded-lg hover:bg-gray-50"
      >
        <div className="text-right">
          <div className="text-sm font-medium">{user.first_name}</div>
          {customerProfile?.is_vip && (
            <div className="text-xs text-yellow-600">VIP</div>
          )}
        </div>
        <ChevronDownIcon className={`h-4 w-4 transition-transform ${isOpen ? 'rotate-180' : ''}`} />
      </button>

      {isOpen && (
        <div className="absolute right-0 mt-2 w-56 bg-white rounded-lg shadow-lg ring-1 ring-black ring-opacity-5 z-50 border border-gray-200">
          <div className="py-1">
            {/* ✅ FIXED: Removed total spent, cleaner header */}
            <div className="px-4 py-3 border-b border-gray-100 bg-gray-50">
              <p className="font-medium text-navy-900">{user.first_name} {user.last_name}</p>
              <p className="text-sm text-navy-600">{user.email}</p>
              {customerProfile?.is_vip && (
                <div className="flex items-center gap-2 mt-2">
                  <span className="inline-block px-2 py-1 text-xs bg-yellow-100 text-yellow-800 rounded-full">
                    VIP Member
                  </span>
                </div>
              )}
            </div>

            {menuItems.map((item, index) => {
              const Icon = item.icon;
              return (
                <button
                  key={item.label}
                  onClick={item.onClick}
                  className={`w-full flex items-center px-4 py-2 text-left hover:bg-gray-50 transition-colors ${
                    item.primary 
                      ? 'text-blue-600 hover:text-blue-700 font-medium' 
                      : item.danger 
                      ? 'text-red-600 hover:text-red-700' 
                      : 'text-navy-700 hover:text-navy-900'
                  } ${index === menuItems.length - 1 || (index === menuItems.length - 2 && process.env.NODE_ENV === 'development') ? 'border-t border-gray-100 mt-1' : ''}`}
                >
                  <Icon className="h-5 w-5 mr-3" />
                  {item.label}
                </button>
              );
            })}
          </div>
        </div>
      )}
    </div>
  );
}
```

# ──── frontend/src/components/booking/address-step.tsx ────

```tsx
'use client';

import { useEffect, useState } from 'react';
import { useBookingWizard, type BookingAddress } from '@/stores/booking-store';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { apiClient } from '@/lib/api-client';
import { GoogleAddressInput } from './google-address-input';
import { parseGooglePlace } from '@/lib/google-places-utils';

const STATES = [
  { value: 'NY', label: 'New York' },
  { value: 'CT', label: 'Connecticut' },
  { value: 'NJ', label: 'New Jersey' },
];

const AIRPORT_ADDRESSES = {
  JFK: {
    address_line_1: 'JFK International Airport',
    address_line_2: '',
    city: 'Jamaica',
    state: 'NY' as const,
    zip_code: '11430'
  },
  EWR: {
    address_line_1: 'Newark Liberty International Airport',
    address_line_2: '',
    city: 'Newark',
    state: 'NJ' as const,
    zip_code: '07114'
  }
};

interface AddressFormProps {
  title: string;
  address: BookingAddress | undefined;
  onAddressChange: (address: BookingAddress) => void;
  errors: Record<string, string>;
  readOnly?: boolean;
  onZipChange?: (zip: string) => void;
  validationMessage?: {
    type: 'error' | 'warning' | 'success';
    message: string;
  } | null;
  isValidating?: boolean;
}

function AddressForm({ 
  title, 
  address, 
  onAddressChange, 
  errors, 
  readOnly = false,
  onZipChange,
  validationMessage,
  isValidating = false
}: AddressFormProps) {
  const handleFieldChange = (field: keyof BookingAddress, value: string) => {
    if (readOnly) return;
    
    onAddressChange({
      ...address,
      [field]: value
    } as BookingAddress);
  };

  const handleZipChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    handleFieldChange('zip_code', value);
    
    if (onZipChange && value.length === 5) {
      onZipChange(value);
    }
  };

  return (
    <Card variant="elevated" className="p-8">
      <CardHeader className="p-0 pb-6">
        <h3 className="text-lg font-medium text-navy-900">{title}</h3>
        {readOnly && (
          <p className="text-sm text-navy-600 mt-1">
            Airport address is automatically set based on your flight selection.
          </p>
        )}
      </CardHeader>
      
      <CardContent className="p-0">
        <div className="space-y-6">
          <GoogleAddressInput
            label="Street Address"
            value={address?.address_line_1 || ''}
            onChange={(value) => handleFieldChange('address_line_1', value)}
            onPlaceSelected={(place) => {
              const parsed = parseGooglePlace(place);
              
              if (parsed) {
                onAddressChange({
                  ...address,
                  ...parsed
                } as BookingAddress);
                
                if (onZipChange && parsed.zip_code) {
                  requestAnimationFrame(() => {
                    onZipChange(parsed.zip_code!);
                  });
                }
              }
            }}
            error={errors.address_line_1}
            placeholder="Start typing your address..."
            required
            disabled={readOnly}
          />
                    
          <Input
            label="Apartment, Suite, etc. (Optional)"
            value={address?.address_line_2 || ''}
            onChange={(e) => handleFieldChange('address_line_2', e.target.value)}
            placeholder="Apt 4B, Suite 200"
            disabled={readOnly}
          />
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <Input
              label="City"
              value={address?.city || ''}
              onChange={(e) => handleFieldChange('city', e.target.value)}
              error={errors.city}
              placeholder="New York"
              required
              disabled={readOnly}
            />
            
            <div className="space-y-2">
              <label className="block text-sm font-medium text-navy-900">
                State <span className="text-red-500">*</span>
              </label>
              <select
                value={address?.state || ''}
                onChange={(e) => handleFieldChange('state', e.target.value as 'NY' | 'CT' | 'NJ')}
                className={`w-full px-4 py-3 text-base border border-gray-300 rounded-md shadow-sm focus:border-navy-500 focus:ring-navy-500 text-gray-900 ${
                  readOnly ? 'bg-gray-100 cursor-not-allowed' : 'bg-white'
                }`}
                required
                disabled={readOnly}
              >
                <option value="" className="text-gray-400">Select State</option>
                {STATES.map(state => (
                  <option key={state.value} value={state.value} className="text-gray-900">
                    {state.label}
                  </option>
                ))}
              </select>
            </div>
          </div>
          
          <div className="relative">
            <Input
              label="ZIP Code"
              mask="zip"
              value={address?.zip_code || ''}
              onChange={handleZipChange}
              error={errors.zip_code}
              placeholder="10001"
              required
              disabled={readOnly}
            />
            {isValidating && (
              <div className="absolute right-3 top-9 text-sm text-navy-500">
                Validating...
              </div>
            )}
          </div>
          
          {validationMessage && (
            <div className={`p-3 rounded-lg text-sm ${
              validationMessage.type === 'error' 
                ? 'bg-red-50 text-red-800 border border-red-200' 
                : validationMessage.type === 'warning'
                ? 'bg-amber-50 text-amber-800 border border-amber-200'
                : 'bg-green-50 text-green-800 border border-green-200'
            }`}>
              {validationMessage.message}
            </div>
          )}
        </div>
      </CardContent>
    </Card>
  );
}

export function AddressStep() {
  const { bookingData, updateBookingData, nextStep, errors, setError, clearError } = useBookingWizard();
  const [pickupValidation, setPickupValidation] = useState<{
    type: 'error' | 'warning' | 'success';
    message: string;
  } | null>(null);
  const [deliveryValidation, setDeliveryValidation] = useState<{
    type: 'error' | 'warning' | 'success';
    message: string;
  } | null>(null);
  const [pickupValidating, setPickupValidating] = useState(false);
  const [deliveryValidating, setDeliveryValidating] = useState(false);
  const [pickupDebounce, setPickupDebounce] = useState<NodeJS.Timeout | null>(null);
  const [deliveryDebounce, setDeliveryDebounce] = useState<NodeJS.Timeout | null>(null);
  const [isRecalculating, setIsRecalculating] = useState(false);

  const isBlade = bookingData.service_type === 'blade_transfer';

  useEffect(() => {
    if (isBlade && bookingData.blade_airport) {
      const airportAddress = AIRPORT_ADDRESSES[bookingData.blade_airport];
      updateBookingData({ delivery_address: airportAddress });
    }
  }, [isBlade, bookingData.blade_airport, updateBookingData]); // ✅ Complete
  
  const validateZipCode = async (
    zipCode: string, 
    addressType: 'pickup' | 'delivery'
  ): Promise<boolean> => {
    if (!zipCode || zipCode.length < 5) return false;
    
    const setValidation = addressType === 'pickup' ? setPickupValidation : setDeliveryValidation;
    const setValidating = addressType === 'pickup' ? setPickupValidating : setDeliveryValidating;
    
    setValidating(true);
    setValidation(null);
    
    try {
      console.log(`🔍 Validating ${addressType} ZIP:`, zipCode);
      const response = await apiClient.post('/api/public/validate-zip/', { 
        zip_code: zipCode 
      });
      
      console.log(`📦 ZIP validation response for ${addressType}:`, response.data);
      
      const { is_serviceable, requires_surcharge, error } = response.data;
      
      if (!is_serviceable) {
        setValidation({
          type: 'error',
          message: error || 'This ZIP code is not in our service area.'
        });
        return false;
      }
      
      if (requires_surcharge) {
        console.log(`🚨 ${addressType} ZIP ${zipCode} REQUIRES SURCHARGE - Setting is_outside_core_area = true`);
        updateBookingData({ is_outside_core_area: true });
        setValidation({
          type: 'warning',
          message: '⚠️ This address includes a $175 distance surcharge.'
        });
        return true;
      }
      
      const otherAddressType = addressType === 'pickup' ? 'delivery' : 'pickup';
      const otherValidation = addressType === 'pickup' ? deliveryValidation : pickupValidation;
      
      if (!otherValidation || otherValidation.type !== 'warning') {
        console.log('✅ Both addresses in core area - clearing surcharge flag');
        updateBookingData({ is_outside_core_area: false });
      } else {
        console.log('⚠️ Other address still has surcharge - keeping flag true');
      }
      
      setValidation({
        type: 'success',
        message: '✓ This address is in our standard service area.'
      });
      return true;
      
    } catch (error) {
      console.error('ZIP validation error:', error);
      return true;
    } finally {
      setValidating(false);
    }
  };

  const handlePickupZipChange = (zipCode: string) => {
    if (pickupDebounce) {
      clearTimeout(pickupDebounce);
    }
    
    setPickupValidation(null);
    
    if (zipCode.length === 5) {
      const timeout = setTimeout(() => {
        validateZipCode(zipCode, 'pickup');
      }, 500);
      
      setPickupDebounce(timeout);
    }
  };

  const handleDeliveryZipChange = (zipCode: string) => {
    if (isBlade) return;
    
    if (deliveryDebounce) {
      clearTimeout(deliveryDebounce);
    }
    
    setDeliveryValidation(null);
    
    if (zipCode.length === 5) {
      const timeout = setTimeout(() => {
        validateZipCode(zipCode, 'delivery');
      }, 500);
      
      setDeliveryDebounce(timeout);
    }
  };

  const handlePickupChange = (address: BookingAddress) => {
    updateBookingData({ pickup_address: address });
    if (address.address_line_1) clearError('pickup_address');
    if (address.city) clearError('pickup_city');
    if (address.zip_code) clearError('pickup_zip');
  };

  const handleDeliveryChange = (address: BookingAddress) => {
    if (isBlade) return;
    
    updateBookingData({ delivery_address: address });
    if (address.address_line_1) clearError('delivery_address');
    if (address.city) clearError('delivery_city');
    if (address.zip_code) clearError('delivery_zip');
  };

  const handleContinue = async () => {
    console.log('═══════════════════════════════════════');
    console.log('🚀 ADDRESS STEP - CONTINUE CLICKED');
    console.log('Service Type:', bookingData.service_type);
    console.log('═══════════════════════════════════════');
    
    if (pickupValidation?.type === 'error' || deliveryValidation?.type === 'error') {
      setError('general', 'Please enter valid service area addresses.');
      return;
    }

    const pickup = bookingData.pickup_address;
    const delivery = bookingData.delivery_address;
    let hasErrors = false;

    if (!pickup?.address_line_1) {
      setError('pickup_address', 'Pickup address is required');
      hasErrors = true;
    }
    if (!pickup?.city) {
      setError('pickup_city', 'Pickup city is required');
      hasErrors = true;
    }
    if (!pickup?.zip_code) {
      setError('pickup_zip', 'Pickup ZIP code is required');
      hasErrors = true;
    }

    if (!isBlade) {
      if (!delivery?.address_line_1) {
        setError('delivery_address', 'Delivery address is required');
        hasErrors = true;
      }
      if (!delivery?.city) {
        setError('delivery_city', 'Delivery city is required');
        hasErrors = true;
      }
      if (!delivery?.zip_code) {
        setError('delivery_zip', 'Delivery ZIP code is required');
        hasErrors = true;
      }
    }

    if (hasErrors) {
      console.log('❌ Validation errors, stopping');
      return;
    }

    // ✅ ONLY recalculate for mini_move, standard_delivery, and specialty_item
    if (bookingData.service_type !== 'blade_transfer') {
      setIsRecalculating(true);
      try {
        const payload: any = {
          service_type: bookingData.service_type,
          pickup_date: bookingData.pickup_date,
          // Send ZIP codes for accurate geographic surcharge calculation ($175 per out-of-zone address)
          pickup_zip_code: pickup?.zip_code,
          delivery_zip_code: delivery?.zip_code,
          // Keep is_outside_core_area as fallback for backwards compatibility
          is_outside_core_area: bookingData.is_outside_core_area || false,
        };

        if (bookingData.service_type === 'mini_move') {
          payload.mini_move_package_id = bookingData.mini_move_package_id;
          payload.include_packing = bookingData.include_packing || false;
          payload.include_unpacking = bookingData.include_unpacking || false;
          payload.pickup_time = bookingData.pickup_time;
          payload.specific_pickup_hour = bookingData.specific_pickup_hour;
          payload.coi_required = bookingData.coi_required || false;
        } else if (bookingData.service_type === 'standard_delivery') {
          payload.standard_delivery_item_count = bookingData.standard_delivery_item_count || 0;
          payload.is_same_day_delivery = bookingData.is_same_day_delivery || false;
          payload.specialty_items = bookingData.specialty_items || []; // ✅ FIXED
        } else if (bookingData.service_type === 'specialty_item') {
          payload.specialty_items = bookingData.specialty_items || []; // ✅ FIXED
        }

        console.log('📤 SENDING PRICING REQUEST:', JSON.stringify(payload, null, 2));
        const response = await apiClient.post('/api/public/pricing-preview/', payload);
        
        console.log('📥 PRICING RESPONSE:', JSON.stringify(response.data.pricing, null, 2));
        
        updateBookingData({ pricing_data: response.data.pricing });
        console.log('✅ Pricing saved to store');
        
      } catch (error: any) {
        console.error('❌ Failed to recalculate pricing:', error);
        console.error('Error response:', error.response?.data);
        setError('general', 'Failed to calculate pricing. Please try again.');
        setIsRecalculating(false);
        return;
      }
      setIsRecalculating(false);
    }
    
    console.log('═══════════════════════════════════════');
    nextStep();
  };

  return (
    <div className="space-y-8">
      <AddressForm
        title="Pickup Address"
        address={bookingData.pickup_address}
        onAddressChange={handlePickupChange}
        errors={errors}
        onZipChange={handlePickupZipChange}
        validationMessage={pickupValidation}
        isValidating={pickupValidating}
      />

      {!isBlade && (
        <AddressForm
          title="Delivery Address"
          address={bookingData.delivery_address}
          onAddressChange={handleDeliveryChange}
          errors={errors}
          onZipChange={handleDeliveryZipChange}
          validationMessage={deliveryValidation}
          isValidating={deliveryValidating}
        />
      )}

      {isBlade && bookingData.delivery_address && (
        <AddressForm
          title="Delivery Address (Airport)"
          address={bookingData.delivery_address}
          onAddressChange={handleDeliveryChange}
          errors={{}}
          readOnly={true}
        />
      )}

      {errors.general && (
        <div className="p-4 bg-red-50 text-red-800 rounded-lg border border-red-200">
          {errors.general}
        </div>
      )}

      <div className="flex justify-end pt-4">
        <Button
          onClick={handleContinue}
          disabled={isRecalculating}
          size="lg"
        >
          {isRecalculating ? 'Recalculating Pricing...' : 'Continue to Review & Payment →'}
        </Button>
      </div>
    </div>
  );
}
```

# ──── frontend/src/components/booking/auth-choice-step.tsx ────

```tsx
// frontend/src/components/booking/auth-choice-step.tsx
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useQueryClient } from '@tanstack/react-query';
import { useAuthStore } from '@/stores/auth-store';
import { useBookingWizard } from '@/stores/booking-store';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { apiClient } from '@/lib/api-client';

export function AuthChoiceStep() {
  const { isAuthenticated, user, login } = useAuthStore();
  const { nextStep, initializeForUser, setCurrentStep } = useBookingWizard();
  const queryClient = useQueryClient();
  const router = useRouter();
  
  const [mode, setMode] = useState<'guest' | 'login' | null>(null);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [showPassword, setShowPassword] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState('');
  const [needsVerification, setNeedsVerification] = useState(false);

  useEffect(() => {
    if (isAuthenticated && user) {
      console.log('Already authenticated, skipping to service selection');
      localStorage.removeItem('totetaxi-booking-wizard');
      initializeForUser(user.id.toString(), false);
      setCurrentStep(1);
    }
  }, [isAuthenticated, user, initializeForUser, setCurrentStep]);

  const handleGuestContinue = () => {
    initializeForUser('guest', true);
    nextStep();
  };

  const handleLogin = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsLoading(true);
    setError('');
    setNeedsVerification(false);
    
    try {
      queryClient.clear();
      console.log('Cleared React Query cache before login');
      
      const result = await login(email.toLowerCase().trim(), password);
      
      if (result.success) {
        localStorage.removeItem('totetaxi-booking-wizard');
        initializeForUser(result.user?.id?.toString(), false);
        setCurrentStep(1);
      } else {
        const errorMsg = result.error || 'Login failed';
        
        if (errorMsg.includes('verify') || errorMsg.includes('not active')) {
          setNeedsVerification(true);
          setError('Please verify your email before logging in. Check your inbox for the verification link.');
        } else if (errorMsg.includes('staff account')) {
          setError('This is a staff account. Please use the staff login.');
        } else if (errorMsg.includes('Invalid') || errorMsg.includes('credentials')) {
          setError('Invalid email or password. Please try again.');
        } else {
          setError(errorMsg);
        }
      }
    } catch (err: any) {
      if (err.response?.status === 429) {
        setError('Too many login attempts. Please wait a few minutes and try again.');
      } else {
        setError('Login failed. Please try again.');
      }
    } finally {
      setIsLoading(false);
    }
  };

  const handleResendVerification = async () => {
    try {
      await apiClient.post('/api/customer/auth/resend-verification/', {
        email: email.toLowerCase().trim()
      });
      setError('Verification email sent! Please check your inbox.');
      setNeedsVerification(false);
    } catch (error) {
      setError('Failed to resend verification email. Please try again later.');
    }
  };

  if (!mode) {
    return (
      <div className="space-y-6">
        <div className="text-center">
          <h3 className="text-lg font-medium text-navy-900 mb-2">How would you like to continue?</h3>
          <p className="text-navy-700">Choose your preferred booking method</p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto">
          <Card className="cursor-pointer hover:ring-2 hover:ring-gray-300 transition-all" onClick={handleGuestContinue}>
            <CardContent className="p-6 text-center">
              <div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg className="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              </div>
              <h4 className="font-medium text-navy-900 mb-2">Continue as Guest</h4>
              <p className="text-sm text-navy-700 mb-4">Quick checkout without creating an account</p>
              <Button 
                variant="outline" 
                className="w-full"
              >
                Continue as Guest
              </Button>
            </CardContent>
          </Card>

          <Card className="cursor-pointer hover:ring-2 hover:ring-navy-500 transition-all" onClick={() => setMode('login')}>
            <CardContent className="p-6 text-center">
              <div className="w-12 h-12 bg-navy-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg className="w-6 h-6 text-navy-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                </svg>
              </div>
              <h4 className="font-medium text-navy-900 mb-2">Sign In</h4>
              <p className="text-sm text-navy-700 mb-4">Access your saved addresses and booking history</p>
              <Button 
                variant="primary" 
                className="w-full"
              >
                Sign In
              </Button>
            </CardContent>
          </Card>
        </div>

        <div className="text-center mt-6">
          <p className="text-sm text-navy-600">
            Don&apos;t have an account?{' '}
            <button
              type="button"
              onClick={() => router.push('/register')}
              className="text-navy-900 hover:underline font-medium"
            >
              Create one here
            </button>
          </p>
        </div>
      </div>
    );
  }

  if (mode === 'login') {
    return (
      <div className="space-y-6 max-w-md mx-auto">
        <div className="flex items-center justify-between">
          <h3 className="text-lg font-medium text-navy-900">Sign In to Your Account</h3>
          <Button variant="ghost" onClick={() => setMode(null)}>← Back</Button>
        </div>

        {error && (
          <div className="bg-red-50 border border-red-200 rounded-md p-4">
            <p className="text-red-700 text-sm">{error}</p>
            {needsVerification && (
              <button
                type="button"
                onClick={handleResendVerification}
                className="text-red-800 hover:text-red-900 underline text-sm mt-2"
              >
                Resend verification email
              </button>
            )}
          </div>
        )}

        <form onSubmit={handleLogin} className="space-y-4">
          <div>
            <label htmlFor="email" className="block text-sm font-medium text-navy-900 mb-1">
              Email Address
            </label>
            <Input
              id="email"
              type="email"
              value={email}
              onChange={(e) => {
                setEmail(e.target.value.toLowerCase());
                setError('');
                setNeedsVerification(false);
              }}
              placeholder="your@email.com"
              disabled={isLoading}
              autoComplete="email"
            />
          </div>

          <div>
            <label htmlFor="password" className="block text-sm font-medium text-navy-900 mb-1">
              Password
            </label>
            <div className="relative">
              <Input
                id="password"
                type={showPassword ? 'text' : 'password'}
                value={password}
                onChange={(e) => {
                  setPassword(e.target.value);
                  setError('');
                  setNeedsVerification(false);
                }}
                placeholder="Enter your password"
                disabled={isLoading}
                autoComplete="current-password"
                className="pr-10"
              />
              <button
                type="button"
                onClick={() => setShowPassword(!showPassword)}
                className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                tabIndex={-1}
              >
                {showPassword ? (
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                  </svg>
                ) : (
                  <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                )}
              </button>
            </div>
            <div className="text-right mt-1">
              <button
                type="button"
                onClick={() => router.push('/forgot-password')}
                className="text-sm text-navy-600 hover:text-navy-900 hover:underline"
              >
                Forgot password?
              </button>
            </div>
          </div>

          <div className="flex gap-3 pt-2">
            <Button 
              type="submit"
              variant="primary" 
              disabled={isLoading || !email || !password}
              className="flex-1"
            >
              {isLoading ? 'Signing In...' : 'Sign In & Continue'}
            </Button>
            <Button 
              type="button"
              variant="outline" 
              onClick={handleGuestContinue}
              className="flex-1"
            >
              Guest Instead
            </Button>
          </div>
        </form>

        <div className="text-center pt-4 border-t border-cream-200">
          <p className="text-sm text-navy-600">
            Don&apos;t have an account?{' '}
            <button
              type="button"
              onClick={() => router.push('/register')}
              className="text-navy-900 hover:underline font-medium"
            >
              Create one here
            </button>
          </p>
        </div>
      </div>
    );
  }

  return null;
}
```

# ──── frontend/src/components/booking/booking-wizard.tsx ────

```tsx
// frontend/src/components/booking/booking-wizard.tsx
'use client';

import { useEffect, useState } from 'react';
import { useRouter } from 'next/navigation';
import { useBookingWizard } from '@/stores/booking-store';
import { useAuthStore } from '@/stores/auth-store';
import { Button } from '@/components/ui/button';
import { AuthChoiceStep } from './auth-choice-step';
import { ServiceSelectionStep } from './service-selection-step';
import { DateTimeStep } from './date-time-step';
import { AddressStep } from './address-step';
import { CustomerInfoStep } from './customer-info-step';
import { ReviewPaymentStep } from './review-payment-step';

const STEPS = [
  { number: 0, title: 'Get Started', component: AuthChoiceStep },
  { number: 1, title: 'Select Service', component: ServiceSelectionStep },
  { number: 2, title: 'Date & Time', component: DateTimeStep },
  { number: 3, title: 'Addresses', component: AddressStep },
  { number: 4, title: 'Your Info', component: CustomerInfoStep },
  { number: 5, title: 'Review & Pay', component: ReviewPaymentStep },
];

interface BookingWizardProps {
  onComplete?: () => void;
}

export function BookingWizard({ onComplete }: BookingWizardProps) {
  const [mounted, setMounted] = useState(false);
  const {
    currentStep,
    nextStep,
    previousStep,
    canProceedToStep,
    resetWizard,
    initializeForUser,
    isGuestMode,
    isBookingComplete,
    completedBookingNumber
  } = useBookingWizard();
  
  const { isAuthenticated, user, logout, clearSessionIfIncognito } = useAuthStore();

  useEffect(() => {
    setMounted(true);
  }, []);

  useEffect(() => {
    if (isBookingComplete && completedBookingNumber) {
      const timer = setTimeout(() => {
        console.log('Booking complete, closing wizard');
        resetWizard();
        if (onComplete) {
          onComplete();
        }
      }, 3000);
      
      return () => clearTimeout(timer);
    }
  }, [isBookingComplete, completedBookingNumber, resetWizard, onComplete]);

  useEffect(() => {
    if (!mounted) return;
    clearSessionIfIncognito();
  }, [mounted, clearSessionIfIncognito]);

  useEffect(() => {
    if (!mounted) return;
    
    if (isBookingComplete && completedBookingNumber) {
      console.log('Success screen active, skipping initialization');
      return;
    }
    
    if (isAuthenticated && user) {
      console.log('Wizard: User authenticated, initializing for user', user.id);
      initializeForUser(user.id.toString(), false);
    } else {
      console.log('Wizard: No user, initializing as guest');
      initializeForUser('guest', true);
    }
  }, [mounted, isAuthenticated, user, initializeForUser, isBookingComplete, completedBookingNumber]);

  // Step 4 skip for authenticated users is handled in the store's
  // nextStep/previousStep — no useEffect needed (L14 fix).

  if (!mounted) {
    return (
      <div className="flex items-center justify-center p-8">
        <div className="text-navy-900">Loading...</div>
      </div>
    );
  }

  if (isBookingComplete && completedBookingNumber) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center px-4">
        <div className="max-w-md w-full text-center space-y-6">
          <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg className="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
          </div>
          <h3 className="text-xl font-serif font-bold text-navy-900 mb-2">
            Booking Confirmed!
          </h3>
          <p className="text-navy-700 mb-4">
            Your booking {completedBookingNumber} has been created successfully.
          </p>
          <p className="text-sm text-navy-600">
            You'll receive a confirmation email shortly.
          </p>
        </div>
      </div>
    );
  }

  const CurrentStepComponent = STEPS.find(step => step.number === currentStep)?.component;

  const getDisplaySteps = () => {
    let steps = STEPS.slice(1);
    
    if (!isGuestMode && isAuthenticated) {
      steps = steps.filter(step => step.number !== 4);
    }
    
    return steps.map((step, index) => ({
      ...step,
      displayNumber: index + 1,
      actualStep: step.number
    }));
  };

  const displaySteps = getDisplaySteps();
  const maxSteps = isGuestMode ? 5 : 4;

  const handleStartOver = async () => {
    await logout();
    resetWizard();
  };

  const getStepTitle = () => {
    const step = STEPS.find(s => s.number === currentStep);
    return step?.title || 'Unknown Step';
  };

  const getCurrentDisplayStep = () => {
    if (currentStep === 0) return 0;
    if (!isGuestMode && currentStep > 4) return currentStep - 1;
    return currentStep;
  };

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Sticky Header */}
      <div className="sticky top-0 bg-white border-b border-gray-200 z-10">
        <div className="max-w-5xl mx-auto px-4 py-4">
          <div className="text-center">
            <h1 className="text-2xl md:text-3xl font-serif font-bold text-navy-900">
              Book Your Luxury Move
            </h1>
            <p className="text-navy-700 mt-1">
              From Manhattan to the Hamptons with premium care
            </p>
            {isAuthenticated && currentStep > 0 && (
              <p className="text-sm text-green-600 mt-2">
                ✓ Logged in as {user?.first_name} {user?.last_name}
              </p>
            )}
          </div>

          {/* Mobile Progress Dots */}
          {currentStep > 0 && (
            <div className="flex items-center justify-center mt-4 md:hidden">
              <div className="flex space-x-2">
                {displaySteps.map((step) => (
                  <div
                    key={step.actualStep}
                    className={`w-3 h-3 rounded-full ${
                      currentStep === step.actualStep 
                        ? 'bg-navy-900' 
                        : currentStep > step.actualStep
                        ? 'bg-green-500'
                        : 'bg-gray-300'
                    }`}
                  />
                ))}
              </div>
              <span className="ml-3 text-sm text-gray-600">
                Step {getCurrentDisplayStep()} of {maxSteps}
              </span>
            </div>
          )}
        </div>
      </div>

      {/* Desktop Progress Bar */}
      {currentStep > 0 && (
        <div className="hidden md:block bg-white border-b border-gray-100">
          <div className="max-w-5xl mx-auto px-4 py-6">
            <div className="flex items-center justify-between">
              {displaySteps.map((step, index) => (
                <div key={step.actualStep} className="flex items-center">
                  <div className={`
                    w-10 h-10 rounded-full flex items-center justify-center text-sm font-medium transition-all
                    ${currentStep === step.actualStep 
                      ? 'bg-navy-900 text-white' 
                      : currentStep > step.actualStep
                      ? 'bg-green-500 text-white'
                      : 'bg-gray-200 text-gray-500'
                    }
                  `}>
                    {currentStep > step.actualStep ? '✓' : step.displayNumber}
                  </div>
                  
                  <span className={`
                    ml-3 text-sm font-medium
                    ${currentStep === step.actualStep ? 'text-navy-900' : 'text-navy-600'}
                  `}>
                    {step.title}
                  </span>
                  
                  {index < displaySteps.length - 1 && (
                    <div className={`
                      h-0.5 w-16 mx-6
                      ${currentStep > step.actualStep ? 'bg-green-500' : 'bg-gray-200'}
                    `} />
                  )}
                </div>
              ))}
            </div>
          </div>
        </div>
      )}

      {/* Main Content - No Card Wrapper */}
      <div className="max-w-5xl mx-auto px-4 py-6 md:py-8">
        <div className="space-y-8">
          <div>
            <h2 className="text-xl md:text-2xl font-serif font-bold text-navy-900 mb-6">
              {currentStep === 0 ? 'Get Started' : `Step ${getCurrentDisplayStep()}: ${getStepTitle()}`}
            </h2>
            
            {CurrentStepComponent && <CurrentStepComponent />}
          </div>
        </div>
      </div>

      {/* Sticky Bottom Navigation */}
      {currentStep > 0 && (
        <div className="sticky bottom-0 bg-white border-t border-gray-200 z-10">
          <div className="max-w-5xl mx-auto px-4 py-4">
            <div className="flex justify-between items-center">
              <div className="flex items-center space-x-4">
                {currentStep > 1 && (
                  <Button 
                    variant="outline" 
                    onClick={previousStep}
                  >
                    ← Previous
                  </Button>
                )}
                <Button 
                  variant="ghost" 
                  onClick={handleStartOver}
                  className="text-navy-600"
                >
                  Start Over
                </Button>
              </div>
              
              <div>
                {currentStep < maxSteps && canProceedToStep(currentStep + 1) && (
                  <Button 
                    variant="primary" 
                    onClick={nextStep}
                    size="lg"
                  >
                    Continue →
                  </Button>
                )}
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
```

# ──── frontend/src/components/booking/customer-info-step.tsx ────

```tsx
// frontend/src/components/booking/customer-info-step.tsx
'use client';

import { useEffect, useState } from 'react';
import { useBookingWizard } from '@/stores/booking-store';
import { useAuthStore } from '@/stores/auth-store';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';

export function CustomerInfoStep() {
  const { bookingData, updateBookingData, nextStep, errors, setError, clearError, isGuestMode } = useBookingWizard();
  const { isAuthenticated, user } = useAuthStore();

  // ✅ FIX: Single useEffect with proper dependencies - no infinite loop
  useEffect(() => {
    console.log('🔍 CustomerInfoStep mounted/updated');
    console.log('  - isAuthenticated:', isAuthenticated);
    console.log('  - isGuestMode:', isGuestMode);
    console.log('  - hasUser:', !!user);
    
    // ✅ If authenticated and NOT in guest mode, skip this step immediately
    if (isAuthenticated && !isGuestMode) {
      console.log('✅ Skipping customer info step - authenticated user');
      nextStep();
    }
  }, [isAuthenticated, isGuestMode, nextStep, user]); // ✅ Proper dependencies

  // ✅ Don't render anything for authenticated users
  if (isAuthenticated && !isGuestMode) {
    console.log('🚫 CustomerInfoStep - returning null (authenticated, not guest)');
    return null;
  }

  const [formData, setFormData] = useState({
    first_name: bookingData.customer_info?.first_name || '',
    last_name: bookingData.customer_info?.last_name || '',
    email: bookingData.customer_info?.email || '',
    phone: bookingData.customer_info?.phone || '',
  });

  const handleFieldChange = (field: string, value: string) => {
    const newFormData = { ...formData, [field]: value };
    setFormData(newFormData);
    
    updateBookingData({
      customer_info: newFormData
    });
    
    clearError(field);
  };

  const validateAndContinue = () => {
    let hasErrors = false;

    if (!formData.first_name.trim()) {
      setError('first_name', 'First name is required');
      hasErrors = true;
    }
    
    if (!formData.last_name.trim()) {
      setError('last_name', 'Last name is required');
      hasErrors = true;
    }
    
    if (!formData.email.trim()) {
      setError('email', 'Email is required');
      hasErrors = true;
    } else if (!/\S+@\S+\.\S+/.test(formData.email)) {
      setError('email', 'Please enter a valid email address');
      hasErrors = true;
    }
    
    const cleanPhone = formData.phone.replace(/\D/g, '');
    if (!cleanPhone) {
      setError('phone', 'Phone number is required');
      hasErrors = true;
    } else if (cleanPhone.length < 10) {
      setError('phone', 'Phone number must be at least 10 digits');
      hasErrors = true;
    }

    if (!hasErrors) {
      nextStep();
    }
  };

  const canContinue = 
    formData.first_name.trim() &&
    formData.last_name.trim() &&
    formData.email.trim() &&
    formData.phone.replace(/\D/g, '').length >= 10;

  return (
    <div className="space-y-8">
      <div className="text-center">
        <h3 className="text-lg font-medium text-navy-900 mb-2">Contact Information</h3>
        <p className="text-navy-700">
          We'll use this information to coordinate your pickup and delivery.
        </p>
      </div>

      <Card variant="elevated" className="p-8">
        <CardContent className="p-0">
          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <Input
                label="First Name"
                value={formData.first_name}
                onChange={(e) => handleFieldChange('first_name', e.target.value)}
                error={errors.first_name}
                placeholder="John"
                required
                realTimeValidation={false}
              />
              
              <Input
                label="Last Name"
                value={formData.last_name}
                onChange={(e) => handleFieldChange('last_name', e.target.value)}
                error={errors.last_name}
                placeholder="Smith"
                required
                realTimeValidation={false}
              />
            </div>
            
            <Input
              label="Email Address"
              type="email"
              value={formData.email}
              onChange={(e) => handleFieldChange('email', e.target.value.toLowerCase())}
              error={errors.email}
              placeholder="john.smith@email.com"
              helper="We'll send confirmation and tracking updates to this email"
              required
              realTimeValidation={true}
            />
            
            <Input
              label="Phone Number"
              type="tel"
              mask="phone"
              value={formData.phone}
              onChange={(e) => handleFieldChange('phone', e.target.value)}
              error={errors.phone}
              placeholder="(555) 123-4567"
              helper="For pickup and delivery coordination"
              required
              realTimeValidation={true}
            />
          </div>
        </CardContent>
      </Card>

      <Card variant="default" className="border-gold-200 bg-gold-50 p-6">
        <CardContent className="p-0">
          <div className="flex items-start">
            <div className="text-gold-600 mr-3 mt-1">🔒</div>
            <div>
              <h4 className="font-medium text-navy-900 mb-1">Privacy & Security</h4>
              <p className="text-sm text-navy-700">
                Your information is encrypted and secure. We'll only use it to provide your ToteTaxi service 
                and send important updates about your booking. We never sell or share your personal data.
              </p>
            </div>
          </div>
        </CardContent>
      </Card>

      <div className="text-center">
        <p className="text-sm text-navy-600">
          Already have an account? 
          <button className="text-navy-900 hover:underline ml-1">
            Sign in for faster checkout
          </button>
        </p>
      </div>

      <div className="flex justify-end">
        <Button 
          variant="primary" 
          onClick={validateAndContinue}
          disabled={!canContinue}
          size="lg"
        >
          Continue to Review & Payment →
        </Button>
      </div>
    </div>
  );
}
```

# ──── frontend/src/components/booking/date-time-step.tsx ────

```tsx
// frontend/src/components/booking/date-time-step.tsx
'use client';

import { useState, useEffect } from 'react';
import { useQuery, useMutation } from '@tanstack/react-query';
import { apiClient } from '@/lib/api-client';
import { useBookingWizard } from '@/stores/booking-store';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';

interface AvailabilityDay {
  date: string;
  available: boolean;
  is_weekend: boolean;
  surcharges: Array<{
    name: string;
    type: string;
    description: string;
  }>;
}

interface PricingPreview {
  service_type: string;
  pricing: {
    base_price_dollars: number;
    same_day_delivery_dollars: number;
    surcharge_dollars: number;
    coi_fee_dollars: number;
    organizing_total_dollars: number;
    organizing_tax_dollars: number;
    geographic_surcharge_dollars: number;
    time_window_surcharge_dollars: number;
    total_price_dollars: number;
  };
  details: {
    specialty_items?: Array<{
      name: string;
      price_dollars: number;
      quantity: number;
      subtotal_dollars: number;
    }>;
    ready_time?: string;
  };
  pickup_date: string;
}

type PickupTime = 'morning' | 'morning_specific' | 'no_time_preference';

export function DateTimeStep() {
  const { bookingData, updateBookingData, nextStep } = useBookingWizard();
  const [selectedDate, setSelectedDate] = useState<string>(bookingData.pickup_date || '');
  const [selectedTime, setSelectedTime] = useState<PickupTime>(bookingData.pickup_time || 'morning');
  const [specificHour, setSpecificHour] = useState<number>(8);
  const [currentMonth, setCurrentMonth] = useState(new Date());
  
  // ========== NEW: Same-Day Restriction State ==========
  const [showRestrictionModal, setShowRestrictionModal] = useState(false);
  const [restrictionMessage, setRestrictionMessage] = useState('');
  // ========== END NEW STATE ==========

  const { data: availability } = useQuery({
    queryKey: ['availability', 'calendar'],
    queryFn: async () => {
      const response = await apiClient.get('/api/public/availability/');
      return response.data.availability as AvailabilityDay[];
    },
    enabled: bookingData.service_type !== 'blade_transfer'
  });

  const pricingMutation = useMutation({
    mutationFn: async (): Promise<PricingPreview> => {
      const payload: any = {
        service_type: bookingData.service_type,
        pickup_date: bookingData.service_type === 'blade_transfer' 
          ? bookingData.blade_flight_date 
          : selectedDate,
      };

      if (bookingData.service_type === 'blade_transfer') {
        payload.blade_airport = bookingData.blade_airport;
        payload.blade_flight_date = bookingData.blade_flight_date;
        payload.blade_flight_time = bookingData.blade_flight_time;
        payload.blade_bag_count = bookingData.blade_bag_count;
      } else if (bookingData.service_type === 'mini_move') {
        payload.mini_move_package_id = bookingData.mini_move_package_id;
        payload.include_packing = bookingData.include_packing;
        payload.include_unpacking = bookingData.include_unpacking;
        payload.pickup_time = selectedTime;
        payload.specific_pickup_hour = selectedTime === 'morning_specific' ? specificHour : undefined;
        payload.coi_required = bookingData.coi_required || false;
        payload.is_outside_core_area = bookingData.is_outside_core_area || false;
      } else if (bookingData.service_type === 'standard_delivery') {
        payload.standard_delivery_item_count = bookingData.standard_delivery_item_count;
        payload.is_same_day_delivery = bookingData.is_same_day_delivery;
        payload.specialty_items = bookingData.specialty_items;
        payload.coi_required = bookingData.coi_required || false;
        payload.is_outside_core_area = bookingData.is_outside_core_area || false;
      } else if (bookingData.service_type === 'specialty_item') {
        payload.specialty_items = bookingData.specialty_items;
        payload.is_same_day_delivery = bookingData.is_same_day_delivery;
        payload.coi_required = bookingData.coi_required || false;
        payload.is_outside_core_area = bookingData.is_outside_core_area || false;
      }

      const response = await apiClient.post('/api/public/pricing-preview/', payload);
      return response.data;
    },
    // ========== NEW: Handle Same-Day Restriction Error ==========
    onError: (error: any) => {
      if (error.response?.data?.error === 'same_day_restriction') {
        setRestrictionMessage(error.response.data.message);
        setShowRestrictionModal(true);
        // Clear the selected date
        setSelectedDate('');
        updateBookingData({ pickup_date: '' });
      }
    }
    // ========== END NEW ERROR HANDLING ==========
  });

  // ========== NEW: Same-Day Restriction Check Function ==========
  const checkSameDayRestriction = (selectedDate: Date): boolean => {
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const tomorrow = new Date(today);
    tomorrow.setDate(tomorrow.getDate() + 1);
    const selectedDay = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), selectedDate.getDate());
    
    // Rule 1: Selected date is today
    if (selectedDay.getTime() === today.getTime()) {
      setRestrictionMessage("Same-day bookings must be arranged through Tote Taxi Customer Service. Please call (631) 595-5100.");
      return true;
    }
    
    // Rule 2: Current time is after 6 PM and selected date is tomorrow
    const currentHour = now.getHours();
    if (currentHour >= 18 && selectedDay.getTime() === tomorrow.getTime()) {
      setRestrictionMessage("Bookings made after 6 PM for next-day service must be arranged through Tote Taxi Customer Service. Please call (631) 595-5100.");
      return true;
    }
    
    return false;
  };
  // ========== END NEW FUNCTION ==========

  useEffect(() => {
    if (bookingData.service_type === 'blade_transfer') {
      if (bookingData.blade_airport && bookingData.blade_flight_date && 
          bookingData.blade_flight_time && bookingData.blade_bag_count) {
        pricingMutation.mutate();
      }
      return;
    }

    if (selectedDate && bookingData.service_type) {
      if (bookingData.service_type === 'mini_move' && !bookingData.mini_move_package_id) {
        return;
      }
      // Standard delivery can have item count OR specialty items (or both)
      if (bookingData.service_type === 'standard_delivery') {
        const hasItemCount = (bookingData.standard_delivery_item_count ?? 0) > 0;
        const hasSpecialtyItems = bookingData.specialty_items && bookingData.specialty_items.length > 0;
        if (!hasItemCount && !hasSpecialtyItems) {
          return;
        }
      }
      if (bookingData.service_type === 'specialty_item' && (!bookingData.specialty_items || bookingData.specialty_items.length === 0)) {
        return;
      }

      pricingMutation.mutate();
    }
  }, [selectedDate, selectedTime, specificHour, bookingData.service_type, bookingData.mini_move_package_id, bookingData.standard_delivery_item_count, bookingData.specialty_items]);

  useEffect(() => {
    if (pricingMutation.data?.pricing) {
      updateBookingData({ pricing_data: pricingMutation.data.pricing });
      
      if (bookingData.service_type === 'blade_transfer' && pricingMutation.data.details?.ready_time) {
        updateBookingData({ blade_ready_time: pricingMutation.data.details.ready_time });
      }
    }
  }, [pricingMutation.data, updateBookingData]);

  // ========== UPDATED: handleDateSelect with Restriction Check ==========
  const handleDateSelect = (date: string) => {
    const selectedDateObj = new Date(date + 'T00:00:00');
    
    // Check restriction BEFORE setting the date
    if (checkSameDayRestriction(selectedDateObj)) {
      setShowRestrictionModal(true);
      return; // Don't set the date
    }
    
    // Normal flow - set the date
    setSelectedDate(date);
    updateBookingData({ pickup_date: date });
    
    if (bookingData.service_type === 'specialty_item' && bookingData.specialty_items?.length) {
      setTimeout(() => pricingMutation.mutate(), 100);
    }
  };
  // ========== END UPDATED FUNCTION ==========

  const handleTimeSelect = (time: PickupTime) => {
    setSelectedTime(time);
    const newHour = time === 'morning_specific' ? specificHour : undefined;
    
    updateBookingData({ 
      pickup_time: time,
      specific_pickup_hour: newHour
    });
    
    if (selectedDate && bookingData.service_type) {
      setTimeout(() => pricingMutation.mutate(), 100);
    }
  };

  const handleSpecificHourSelect = (hour: number) => {
    setSpecificHour(hour);
    updateBookingData({ specific_pickup_hour: hour });
    
    if (selectedDate && bookingData.service_type && selectedTime === 'morning_specific') {
      setTimeout(() => pricingMutation.mutate(), 100);
    }
  };

  const handleContinue = () => {
    if (bookingData.service_type === 'standard_delivery') {
      const itemCount = bookingData.standard_delivery_item_count || 0;
      const hasSpecialtyItems = bookingData.specialty_items && bookingData.specialty_items.length > 0;
      
      if (itemCount === 0 && hasSpecialtyItems) {
        updateBookingData({
          service_type: 'specialty_item',
          standard_delivery_item_count: undefined,
        });
      }
    }
    
    if (pricingMutation.data?.pricing) {
      updateBookingData({ pricing_data: pricingMutation.data.pricing });
    }
    
    nextStep();
  };

  const getMonthDays = () => {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const startDate = new Date(firstDay);
    const dayOfWeek = startDate.getDay();
    startDate.setDate(startDate.getDate() - dayOfWeek);
    
    const endDate = new Date(lastDay);
    const lastDayOfWeek = endDate.getDay();
    const daysToAdd = 6 - lastDayOfWeek;
    endDate.setDate(endDate.getDate() + daysToAdd);
    
    const days = [];
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
      const isCurrentMonth = d.getMonth() === month;
      const isPastDate = d < today;
      
      if (isCurrentMonth && !isPastDate) {
        days.push(new Date(d));
      } else if (isCurrentMonth || !isPastDate) {
        days.push(new Date(d));
      } else {
        days.push(null);
      }
    }
    return days;
  };

  const formatDate = (date: Date) => {
    return date.toISOString().split('T')[0];
  };

  const getDayInfo = (date: Date) => {
    const dateStr = formatDate(date);
    return availability?.find(day => day.date === dateStr);
  };

  const getPackageType = () => {
    if (bookingData.service_type !== 'mini_move' || !bookingData.mini_move_package_id) {
      return null;
    }
    return bookingData.package_type;
  };

  const packageType = getPackageType();
  const canContinue = bookingData.service_type === 'blade_transfer' 
    ? !!(pricingMutation.data?.pricing)
    : bookingData.service_type === 'specialty_item'
      ? !!(selectedDate && pricingMutation.data?.pricing)
      : !!(selectedDate && selectedTime);

  if (bookingData.service_type === 'blade_transfer') {
    return (
      <div className="space-y-8">
        <Card variant="luxury" className="p-6">
          <CardContent className="p-0">
            <h3 className="text-lg font-medium text-navy-900 mb-6">Flight Summary</h3>
            
            <div className="space-y-4">
              <div className="flex justify-between items-center">
                <span className="text-navy-700">Airport:</span>
                <span className="font-semibold text-navy-900">
                  {bookingData.blade_airport === 'JFK' ? 'JFK International' : 'Newark Liberty (EWR)'}
                </span>
              </div>
              
              <div className="flex justify-between items-center">
                <span className="text-navy-700">Flight Date:</span>
                <span className="font-semibold text-navy-900">
                  {bookingData.blade_flight_date && new Date(bookingData.blade_flight_date + 'T00:00:00').toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  })}
                </span>
              </div>
              
              <div className="flex justify-between items-center">
                <span className="text-navy-700">Flight Departure:</span>
                <span className="font-semibold text-navy-900">
                  {bookingData.blade_flight_time && new Date(`2000-01-01T${bookingData.blade_flight_time}`).toLocaleTimeString('en-US', {
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                  })}
                </span>
              </div>
              
              <div className="flex justify-between items-center">
                <span className="text-navy-700">Number of Bags:</span>
                <span className="font-semibold text-navy-900">{bookingData.blade_bag_count}</span>
              </div>
              
              <div className="border-t border-gray-200 pt-4 mt-4">
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <div className="flex justify-between items-center">
                    <span className="font-medium text-blue-900">Bags Ready Time:</span>
                    <span className="text-xl font-bold text-blue-900">
                      {pricingMutation.data?.details?.ready_time && 
                        new Date(`2000-01-01T${pricingMutation.data.details.ready_time}`).toLocaleTimeString('en-US', {
                          hour: 'numeric',
                          minute: '2-digit',
                          hour12: true
                        })
                      }
                    </span>
                  </div>
                  <p className="text-sm text-blue-700 mt-2">
                    Your bags must be packed and ready for pickup at your NYC address by this time.
                  </p>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>

        {pricingMutation.data?.pricing && (
          <Card variant="luxury" className="p-8">
            <CardContent className="p-0">
              <h3 className="text-lg font-medium text-navy-900 mb-6">Pricing Summary</h3>
              <div className="space-y-4">
                <div className="flex justify-between items-center">
                  <span className="text-navy-900 font-medium">
                    {bookingData.blade_bag_count} bags × $75:
                  </span>
                  <span className="text-navy-900 font-semibold">${pricingMutation.data.pricing.base_price_dollars}</span>
                </div>

                <div className="border-t border-gray-200 pt-4">
                  <div className="flex justify-between items-center">
                    <span className="text-lg font-bold text-navy-900">Total:</span>
                    <span className="text-xl font-bold text-navy-900">${pricingMutation.data.pricing.total_price_dollars}</span>
                  </div>
                </div>
                
                <div className="bg-green-50 border border-green-200 rounded-lg p-3 mt-4">
                  <p className="text-sm text-green-800">
                    <strong>No surcharges!</strong> Airport transfer pricing is straightforward with no weekend, geographic, or time window fees.
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>
        )}

        <Card variant="default" className="p-6">
          <CardContent className="p-0">
            <div className="space-y-3">
              <p className="text-sm font-medium text-navy-900">Post-Service Charges (if applicable):</p>
              <ul className="text-sm text-navy-700 space-y-2">
                <li>• Overweight bags (over 50 lbs): $120 per bag</li>
                <li>• Wait time over 10 minutes: $50 per 30 minutes</li>
              </ul>
              <p className="text-xs text-navy-500 mt-2">
                These charges are assessed after service completion and are not included in the booking total.
              </p>
            </div>
          </CardContent>
        </Card>

        <div className="flex justify-end pt-4">
          <Button
            onClick={handleContinue}
            disabled={!canContinue || pricingMutation.isPending}
            size="lg"
          >
            {pricingMutation.isPending ? 'Calculating...' : 'Continue to Addresses →'}
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-8">
      <div>
        <div className="flex justify-between items-center mb-6">
          <Button 
            variant="outline" 
            onClick={() => {
              const prev = new Date(currentMonth);
              prev.setMonth(prev.getMonth() - 1);
              const today = new Date();
              if (prev.getFullYear() > today.getFullYear() || 
                  (prev.getFullYear() === today.getFullYear() && prev.getMonth() >= today.getMonth())) {
                setCurrentMonth(prev);
              }
            }}
            disabled={currentMonth.getMonth() === new Date().getMonth() && currentMonth.getFullYear() === new Date().getFullYear()}
          >
            ← Previous
          </Button>
          <h3 className="text-xl font-medium text-navy-900">
            {currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
          </h3>
          <Button 
            variant="outline" 
            onClick={() => {
              const next = new Date(currentMonth);
              next.setMonth(next.getMonth() + 1);
              setCurrentMonth(next);
            }}
          >
            Next →
          </Button>
        </div>

        <h3 className="text-lg font-medium text-navy-900 mb-6">Select Date</h3>
        
        <div className="grid grid-cols-7 gap-1 md:gap-4 mb-2">
          {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
            <div key={day} className="text-center text-sm font-medium text-navy-600 p-2">
              {day}
            </div>
          ))}
        </div>
        
        <div className="grid grid-cols-7 gap-1 md:gap-4">
          {getMonthDays().map((date, index) => {
            if (!date) {
              return <div key={`empty-${index}`} className="h-16 md:h-20" />;
            }
            
            const dateStr = formatDate(date);
            const dayInfo = getDayInfo(date);
            const isSelected = selectedDate === dateStr;
            const hasSurcharge = dayInfo?.surcharges && dayInfo.surcharges.length > 0;
            const isCurrentMonth = date.getMonth() === currentMonth.getMonth();
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const isPastDate = date < today;

            return (
              <button
                key={dateStr}
                onClick={() => isCurrentMonth && !isPastDate && handleDateSelect(dateStr)}
                disabled={!isCurrentMonth || isPastDate}
                className={`
                  p-2 md:p-4 text-sm md:text-base rounded-md border-2 transition-all 
                  h-16 md:h-20 flex flex-col items-center justify-center
                  ${!isCurrentMonth || isPastDate ? 'opacity-30 cursor-not-allowed' : ''}
                  ${isSelected 
                    ? 'bg-navy-900 text-white border-navy-900' 
                    : 'bg-white text-navy-900 border-gray-200 hover:border-navy-300 hover:bg-navy-50'
                  }
                `}
              >
                <div className="font-medium">{date.getDate()}</div>
                <div className="text-xs opacity-75">
                  {date.toLocaleDateString('en-US', { weekday: 'short' })}
                </div>
                {hasSurcharge && isCurrentMonth && !isPastDate && (
                  <div className="text-xs text-orange-600 mt-1">•</div>
                )}
              </button>
            );
          })}
        </div>
        
        <div className="flex items-center justify-center mt-4">
          <div className="flex items-center">
            <div className="w-3 h-3 bg-orange-100 rounded mr-2"></div>
            <span className="text-sm text-navy-600">Weekend surcharge applies</span>
          </div>
        </div>
      </div>

      {selectedDate && (
        <Card variant="default" className="p-6">
          <CardContent className="p-0">
            <div className="text-center">
              <h4 className="font-medium text-navy-900 mb-2">
                {new Date(selectedDate + 'T00:00:00').toLocaleDateString('en-US', { 
                  weekday: 'long', 
                  year: 'numeric', 
                  month: 'long', 
                  day: 'numeric' 
                })}
              </h4>
              {getDayInfo(new Date(selectedDate + 'T00:00:00'))?.surcharges
                ?.filter((surcharge) => {
                  if (bookingData.service_type === 'mini_move') {
                    return surcharge.description.includes('Mini Move');
                  } else if (bookingData.service_type === 'standard_delivery') {
                    return surcharge.description.includes('Standard Delivery');
                  }
                  return true;
                })
                .map((surcharge, index) => (
                  <div key={index} className="mt-2 text-sm text-orange-600">
                    <strong>Weekend surcharge applies:</strong>
                    <br />• {surcharge.description}
                  </div>
                ))}
            </div>
          </CardContent>
        </Card>
      )}

      {selectedDate && bookingData.service_type === 'mini_move' && (
        <div>
          <h3 className="text-lg font-medium text-navy-900 mb-6">Select Pickup Time</h3>
          <div className="space-y-4">
            
            <button
              onClick={() => handleTimeSelect('morning')}
              className={`w-full p-6 rounded-lg border-2 text-left transition-all ${
                selectedTime === 'morning'
                  ? 'border-navy-500 bg-navy-50'
                  : 'border-gray-200 hover:border-gray-300'
              }`}
            >
              <div className="font-medium text-navy-900">Morning (8 AM - 11 AM)</div>
              <div className="text-sm text-navy-600">Standard 3-hour pickup window</div>
            </button>

            {packageType === 'petite' && (
              <button
                onClick={() => handleTimeSelect('no_time_preference')}
                className={`w-full p-6 rounded-lg border-2 text-left transition-all ${
                  selectedTime === 'no_time_preference'
                    ? 'border-navy-500 bg-navy-50'
                    : 'border-gray-200 hover:border-gray-300'
                }`}
              >
                <div className="font-medium text-navy-900">Flexible Morning Timing</div>
                <div className="text-sm text-navy-600">8-11 AM pickup window - we'll coordinate the exact time with you</div>
              </button>
            )}

            {(packageType === 'standard' || packageType === 'full') && (
              <div
                className={`p-6 rounded-lg border-2 transition-all ${
                  selectedTime === 'morning_specific'
                    ? 'border-navy-500 bg-navy-50'
                    : 'border-gray-200'
                }`}
              >
                <button
                  onClick={() => handleTimeSelect('morning_specific')}
                  className="w-full text-left"
                >
                  <div className="font-medium text-navy-900">
                    Specific 1-Hour Window
                    {packageType === 'standard' && (
                      <span className="text-orange-600 ml-2">(+$175)</span>
                    )}
                    {packageType === 'full' && (
                      <span className="text-green-600 ml-2">(Free)</span>
                    )}
                  </div>
                  <div className="text-sm text-navy-600">Choose your preferred hour</div>
                </button>
                
                {selectedTime === 'morning_specific' && (
                  <div className="mt-4 grid grid-cols-3 gap-3">
                    {[8, 9, 10].map((hour) => (
                      <button
                        key={hour}
                        onClick={() => handleSpecificHourSelect(hour)}
                        className={`p-3 text-sm rounded border-2 transition-all ${
                          specificHour === hour
                            ? 'bg-navy-900 text-white border-navy-900'
                            : 'bg-white text-navy-900 border-gray-200 hover:border-navy-300'
                        }`}
                      >
                        {hour}:00 - {hour + 1}:00 AM
                      </button>
                    ))}
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
      )}

      {pricingMutation.data?.pricing && (
        <Card variant="luxury" className="p-8">
          <CardContent className="p-0">
            <h3 className="text-lg font-medium text-navy-900 mb-6">Pricing Summary</h3>
            <div className="space-y-4">
              
              {/* Standard Delivery - Itemized */}
              {bookingData.service_type === 'standard_delivery' && (
                <>
                  {(bookingData.standard_delivery_item_count ?? 0) > 0 && (
                    <div className="flex justify-between items-center">
                      <span className="text-navy-900 font-medium">
                        Standard Delivery ({bookingData.standard_delivery_item_count} items):
                      </span>
                      <span className="text-navy-900 font-semibold">
                        ${Math.max(((bookingData.standard_delivery_item_count ?? 0) * 95), 285)}
                      </span>
                    </div>
                  )}
                  
                  {pricingMutation.data?.details?.specialty_items?.map((item, index) => (
                    <div key={`specialty-${index}`} className="flex justify-between items-center">
                      <span className="text-navy-900 font-medium">
                        {item.quantity}x {item.name} (Specialty):
                      </span>
                      <span className="text-navy-900 font-semibold">${item.subtotal_dollars}</span>
                    </div>
                  ))}
                </>
              )}

              {/* Mini Move */}
              {bookingData.service_type === 'mini_move' && (
                <div className="flex justify-between items-center">
                  <span className="text-navy-900 font-medium">Mini Move Package:</span>
                  <span className="text-navy-900 font-semibold">${pricingMutation.data.pricing.base_price_dollars}</span>
                </div>
              )}

              {/* Specialty Item Only */}
              {bookingData.service_type === 'specialty_item' && pricingMutation.data?.details?.specialty_items && (
                <>
                  {pricingMutation.data.details.specialty_items.map((item, index) => (
                    <div key={`specialty-only-${index}`} className="flex justify-between items-center">
                      <span className="text-navy-900 font-medium">
                        {item.quantity}x {item.name}:
                      </span>
                      <span className="text-navy-900 font-semibold">${item.subtotal_dollars}</span>
                    </div>
                  ))}
                </>
              )}

              {/* Same-Day Delivery */}
              {(pricingMutation.data.pricing.same_day_delivery_dollars ?? 0) > 0 && (
                <div className="flex justify-between items-center">
                  <span className="text-navy-900 font-medium">Same-Day Delivery:</span>
                  <span className="text-navy-900 font-semibold">+${pricingMutation.data.pricing.same_day_delivery_dollars}</span>
                </div>
              )}

              {/* Peak Date Surcharge */}
              {(pricingMutation.data.pricing.surcharge_dollars ?? 0) > 0 && (
                <div className="flex justify-between items-center">
                  <span className="text-navy-900 font-medium">Peak Date Surcharge:</span>
                  <span className="text-navy-900 font-semibold">+${pricingMutation.data.pricing.surcharge_dollars}</span>
                </div>
              )}

              {/* COI Fee */}
              {(pricingMutation.data.pricing.coi_fee_dollars ?? 0) > 0 && (
                <div className="flex justify-between items-center">
                  <span className="text-navy-900 font-medium">COI Fee:</span>
                  <span className="text-navy-900 font-semibold">+${pricingMutation.data.pricing.coi_fee_dollars}</span>
                </div>
              )}

              {/* Organizing Services */}
              {(pricingMutation.data.pricing.organizing_total_dollars ?? 0) > 0 && (
                <div className="flex justify-between items-center">
                  <span className="text-navy-900 font-medium">Organizing Services:</span>
                  <span className="text-navy-900 font-semibold">+${pricingMutation.data.pricing.organizing_total_dollars}</span>
                </div>
              )}

              {/* Organizing Tax */}
              {(pricingMutation.data.pricing.organizing_tax_dollars ?? 0) > 0 && (
                <div className="flex justify-between items-center">
                  <span className="text-navy-900 font-medium">Tax (8.25%):</span>
                  <span className="text-navy-900 font-semibold">+${pricingMutation.data.pricing.organizing_tax_dollars}</span>
                </div>
              )}

              {/* Time Window Surcharge */}
              {(pricingMutation.data.pricing.time_window_surcharge_dollars ?? 0) > 0 && (
                <div className="flex justify-between items-center">
                  <span className="text-navy-900 font-medium">1-Hour Window:</span>
                  <span className="text-navy-900 font-semibold">+${pricingMutation.data.pricing.time_window_surcharge_dollars}</span>
                </div>
              )}

              {/* Geographic Surcharge */}
              {(pricingMutation.data.pricing.geographic_surcharge_dollars ?? 0) > 0 && (
                <div className="flex justify-between items-center">
                  <span className="text-navy-900 font-medium">Distance Surcharge:</span>
                  <span className="text-navy-900 font-semibold">+${pricingMutation.data.pricing.geographic_surcharge_dollars}</span>
                </div>
              )}

              {/* Total */}
              <div className="border-t border-gray-200 pt-4">
                <div className="flex justify-between items-center">
                  <span className="text-lg font-bold text-navy-900">Total:</span>
                  <span className="text-xl font-bold text-navy-900">${pricingMutation.data.pricing.total_price_dollars}</span>
                </div>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {selectedDate && bookingData.service_type !== 'blade_transfer' && (
        <Card variant="default" className="p-6">
          <CardContent className="p-0">
            <label className="flex items-center">
              <input
                type="checkbox"
                checked={bookingData.coi_required || false}
                onChange={(e) => updateBookingData({ coi_required: e.target.checked })}
                className="mr-3 h-4 w-4"
              />
              <div>
                <span className="font-medium text-navy-900">
                  Certificate of Insurance (COI) Required
                  {bookingData.service_type === 'mini_move' && packageType === 'petite' && (
                    <span className="text-orange-600 ml-2">(+$50)</span>
                  )}
                  {(bookingData.service_type === 'standard_delivery' || bookingData.service_type === 'specialty_item') && (
                    <span className="text-orange-600 ml-2">(+$50)</span>
                  )}
                </span>
                <p className="text-sm text-navy-600">
                  Required by some buildings. We'll handle the paperwork for you.
                </p>
              </div>
            </label>
          </CardContent>
        </Card>
      )}

      {/* ========== NEW: Same-Day Restriction Modal ========== */}
      {showRestrictionModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg max-w-md w-full p-6 shadow-xl">
            <h3 className="text-xl font-bold text-navy-900 mb-4">
              Same-Day Service Required
            </h3>
            
            <p className="text-navy-700 mb-4">
              {restrictionMessage}
            </p>
            
            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
              <p className="font-semibold text-navy-900 mb-1">
                Contact Tote Taxi Customer Service:
              </p>
              <a 
                href="tel:+16315955100" 
                className="text-2xl font-bold text-blue-600 hover:text-blue-800"
              >
                (631) 595-5100
              </a>
              <p className="text-sm text-navy-600 mt-2">
                Monday - Sunday, 9 AM - 6 PM
              </p>
            </div>
            
            <button
              onClick={() => setShowRestrictionModal(false)}
              className="w-full bg-navy-900 text-white py-3 rounded-lg hover:bg-navy-800 transition-colors font-medium"
            >
              Choose Different Date
            </button>
          </div>
        </div>
      )}
      {/* ========== END NEW MODAL ========== */}

      <div className="flex justify-end pt-4">
        <Button
          onClick={handleContinue}
          disabled={!canContinue}
          size="lg"
        >
          Continue to Addresses →
        </Button>
      </div>
    </div>
  );
}
```

# ──── frontend/src/components/booking/google-address-input.tsx ────

```tsx
// frontend/src/components/booking/google-address-input.tsx
'use client';

import Autocomplete from 'react-google-autocomplete';

interface GoogleAddressInputProps {
  label: string;
  value: string;
  onChange: (value: string) => void;
  onPlaceSelected: (place: google.maps.places.PlaceResult) => void;
  error?: string;
  placeholder?: string;
  required?: boolean;
  disabled?: boolean;
}

export function GoogleAddressInput({
  label,
  value,
  onChange,
  onPlaceSelected,
  error,
  placeholder,
  required,
  disabled
}: GoogleAddressInputProps) {
  return (
    <div className="space-y-2">
      <label className="block text-sm font-medium text-navy-900">
        {label} {required && <span className="text-red-500">*</span>}
      </label>
      
      <Autocomplete
        apiKey={process.env.NEXT_PUBLIC_GOOGLE_PLACES_API_KEY}
        onPlaceSelected={(place) => {
          console.log('✅ Place selected:', place);
          onPlaceSelected(place);
        }}
        onChange={(e: React.ChangeEvent<HTMLInputElement>) => onChange(e.target.value)}
        value={value}
        disabled={disabled}
        placeholder={placeholder}
        options={{
          types: ['address'],
          componentRestrictions: { country: 'us' },
          fields: ['address_components', 'formatted_address', 'geometry', 'place_id']
        }}
        className={`w-full px-4 py-3 text-base border rounded-md shadow-sm focus:border-navy-500 focus:ring-navy-500 text-gray-900 ${
          error ? 'border-red-500' : 'border-gray-300'
        } ${disabled ? 'bg-gray-100 cursor-not-allowed' : 'bg-white'}`}
      />
      
      {error && <p className="text-sm text-red-600">{error}</p>}
    </div>
  );
}
```

# ──── frontend/src/components/booking/index.ts ────

```typescript
// frontend/src/components/booking/index.ts
export { BookingWizard } from './booking-wizard';
export { ServiceSelectionStep } from './service-selection-step';
export { DateTimeStep } from './date-time-step';
export { AddressStep } from './address-step';
export { CustomerInfoStep } from './customer-info-step';
export { ReviewPaymentStep } from './review-payment-step';
```

# ──── frontend/src/components/booking/review-payment-step.tsx ────

```tsx
// frontend/src/components/booking/review-payment-step.tsx
'use client';

import { useState, useEffect, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { useMutation, useQueryClient, useQuery } from '@tanstack/react-query';
import { Elements, PaymentElement, useStripe, useElements } from '@stripe/react-stripe-js';
import { apiClient } from '@/lib/api-client';
import { getStripe } from '@/lib/stripe';
import { useBookingWizard } from '@/stores/booking-store';
import { useAuthStore } from '@/stores/auth-store';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { AxiosError } from 'axios';
import type { ServiceCatalog } from '@/types';
import { useDiscountCode } from '@/hooks/use-discount-code';

interface PaymentIntentResponse {
  client_secret: string;
  payment_intent_id: string;
  amount_dollars: number;
}

interface BookingResponse {
  message: string;
  booking: {
    id: string;
    booking_number: string;
    total_price_dollars: number;
    status: string;
  };
}

function CheckoutForm({ 
  clientSecret, 
  paymentIntentId,
  totalAmount, 
  onSuccess 
}: { 
  clientSecret: string;
  paymentIntentId: string;
  totalAmount: number;
  onSuccess: (paymentIntentId: string) => void;
}) {
  const stripe = useStripe();
  const elements = useElements();
  const [isProcessing, setIsProcessing] = useState(false);
  const [errorMessage, setErrorMessage] = useState<string>();

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!stripe || !elements) {
      return;
    }

    setIsProcessing(true);
    setErrorMessage(undefined);

    const { error, paymentIntent } = await stripe.confirmPayment({
      elements,
      confirmParams: {
        return_url: `${window.location.origin}/booking-success`,
      },
      redirect: 'if_required',
    });

    if (error) {
      setErrorMessage(error.message);
      setIsProcessing(false);
    } else if (paymentIntent && paymentIntent.status === 'succeeded') {
      console.log('✅ Payment succeeded:', paymentIntent.id);
      onSuccess(paymentIntentId);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-6">
      <div className="bg-navy-50 border border-navy-200 rounded-lg p-4">
        <div className="flex justify-between items-center">
          <span className="text-navy-700">Total Amount:</span>
          <span className="text-2xl font-bold text-navy-900">${totalAmount}</span>
        </div>
      </div>

      <PaymentElement />
      
      {errorMessage && (
        <div className="bg-red-50 border border-red-200 rounded-md p-3">
          <p className="text-red-800 text-sm">{errorMessage}</p>
        </div>
      )}

      <Button
        type="submit"
        disabled={!stripe || isProcessing}
        className="w-full"
        size="lg"
        variant="primary"
      >
        {isProcessing ? 'Processing Payment...' : `Pay $${totalAmount}`}
      </Button>

      <p className="text-xs text-center text-navy-600">
        Payments are processed securely through Stripe. Your card information is never stored on our servers.
      </p>
    </form>
  );
}

function getTimeDisplay(pickupTime: string | undefined, specificHour?: number) {
  switch (pickupTime) {
    case 'morning':
      return '8:00 AM - 11:00 AM';
    case 'morning_specific':
      return specificHour ? `${specificHour}:00 AM - ${specificHour + 1}:00 AM` : '8:00 AM - 11:00 AM';
    case 'no_time_preference':
      return 'Flexible timing - we\'ll coordinate with you';
    default:
      return '8:00 AM - 11:00 AM';
  }
}

// Hook to recalculate pricing when Review & Pay loads.
// Uses a ref to avoid stale closure over bookingData (L8 fix).
const useRecalculatePricing = () => {
  const { bookingData, updateBookingData } = useBookingWizard();
  const { user } = useAuthStore();
  const [isRecalculating, setIsRecalculating] = useState(false);
  const bookingDataRef = useRef(bookingData);
  bookingDataRef.current = bookingData;

  useEffect(() => {
    const recalculatePricing = async () => {
      if (isRecalculating) return;

      setIsRecalculating(true);
      const data = bookingDataRef.current;

      try {
        let pricingRequest: any = {
          service_type: data.service_type,
          pickup_date: data.service_type === 'blade_transfer'
            ? data.blade_flight_date
            : data.pickup_date,
          coi_required: data.coi_required || false,
          pickup_zip_code: data.pickup_address?.zip_code,
          delivery_zip_code: data.delivery_address?.zip_code,
          is_outside_core_area: data.is_outside_core_area || false,
        };

        if (data.service_type === 'mini_move') {
          pricingRequest.mini_move_package_id = data.mini_move_package_id;
          pricingRequest.include_packing = data.include_packing;
          pricingRequest.include_unpacking = data.include_unpacking;
          pricingRequest.pickup_time = data.pickup_time;
          pricingRequest.specific_pickup_hour = data.specific_pickup_hour;
        } else if (data.service_type === 'standard_delivery') {
          pricingRequest.standard_delivery_item_count = data.standard_delivery_item_count;
          pricingRequest.is_same_day_delivery = data.is_same_day_delivery;
          pricingRequest.specialty_items = data.specialty_items;
        } else if (data.service_type === 'specialty_item') {
          pricingRequest.specialty_items = data.specialty_items;
          pricingRequest.is_same_day_delivery = data.is_same_day_delivery;
        } else if (data.service_type === 'blade_transfer') {
          pricingRequest.blade_airport = data.blade_airport;
          pricingRequest.blade_flight_date = data.blade_flight_date;
          pricingRequest.blade_flight_time = data.blade_flight_time;
          pricingRequest.blade_bag_count = data.blade_bag_count;
        }

        // Include discount code if validated
        if (data.discount_code && data.discount_validated) {
          pricingRequest.discount_code = data.discount_code;
          pricingRequest.discount_email = user?.email || data.customer_info?.email || '';
        }

        const response = await apiClient.post('/api/public/pricing-preview/', pricingRequest);

        updateBookingData({
          pricing_data: response.data.pricing,
          blade_ready_time: response.data.details?.ready_time
        });
      } catch (error) {
        console.error('Failed to recalculate pricing:', error);
      } finally {
        setIsRecalculating(false);
      }
    };

    recalculatePricing();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [bookingData.discount_code, bookingData.discount_validated]);

  return isRecalculating;
};

// ✅ Component to display specialty items with quantities
function SpecialtyItemsList({ bookingData }: { bookingData: any }) {
  const { data: services } = useQuery({
    queryKey: ['services', 'catalog'],
    queryFn: async (): Promise<ServiceCatalog> => {
      const response = await apiClient.get('/api/public/services/');
      return response.data;
    }
  });

  if (!bookingData.specialty_items || bookingData.specialty_items.length === 0) {
    return null;
  }

  return (
    <div className="mt-2 space-y-1">
      {bookingData.specialty_items.map((item: { item_id: string; quantity: number }) => {
        const specialtyItem = services?.specialty_items.find(s => s.id === item.item_id);
        if (!specialtyItem) return null;
        
        return (
          <div key={item.item_id} className="text-sm text-navy-600">
            • {item.quantity}x {specialtyItem.name} (${(specialtyItem.price_dollars * item.quantity).toFixed(2)})
          </div>
        );
      })}
    </div>
  );
}

function DiscountCodeInput() {
  const [inputCode, setInputCode] = useState('');
  const { validateCode, removeCode, isValidating, error, success, appliedCode } = useDiscountCode();

  const handleApply = () => {
    validateCode(inputCode);
  };

  const handleRemove = () => {
    setInputCode('');
    removeCode();
  };

  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      handleApply();
    }
  };

  if (appliedCode) {
    return (
      <div className="flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-3">
        <div>
          <span className="text-green-800 font-medium">
            Code &quot;{appliedCode.code}&quot; applied
          </span>
          <span className="text-green-700 text-sm ml-2">
            ({appliedCode.discount_description} off)
          </span>
        </div>
        <button
          onClick={handleRemove}
          className="text-sm text-red-600 hover:text-red-800 underline"
        >
          Remove
        </button>
      </div>
    );
  }

  return (
    <div className="space-y-2">
      <div className="flex gap-2">
        <input
          type="text"
          value={inputCode}
          onChange={(e) => setInputCode(e.target.value.toUpperCase())}
          onKeyDown={handleKeyDown}
          placeholder="Enter discount code"
          className="flex-1 px-3 py-2 border border-gray-300 rounded-md text-sm text-navy-900 placeholder:text-navy-400 focus:ring-navy-500 focus:border-navy-500"
          maxLength={50}
        />
        <Button
          variant="outline"
          size="sm"
          onClick={handleApply}
          disabled={!inputCode.trim() || isValidating}
        >
          {isValidating ? 'Checking...' : 'Apply'}
        </Button>
      </div>
      {error && <p className="text-sm text-red-600">{error}</p>}
      {success && <p className="text-sm text-green-600">{success}</p>}
    </div>
  );
}

export function ReviewPaymentStep() {
  const { bookingData, resetWizard, setLoading, isLoading, setBookingComplete, previousStep, isGuestMode } = useBookingWizard();
  const { isAuthenticated, user } = useAuthStore();
  const queryClient = useQueryClient();
  const router = useRouter();
  
  const isPricingRecalculating = useRecalculatePricing();
  
  const [bookingComplete, setBookingCompleteLocal] = useState(false);
  const [bookingNumber, setBookingNumber] = useState<string>('');
  const [termsAccepted, setTermsAccepted] = useState(false);
  const [clientSecret, setClientSecret] = useState<string>('');
  const [paymentIntentId, setPaymentIntentId] = useState<string>('');
  const [showPayment, setShowPayment] = useState(false);
  const stripePromise = getStripe();

  // STEP 1: Create payment intent
  const createPaymentIntentMutation = useMutation({
    mutationFn: async (): Promise<PaymentIntentResponse> => {
      const endpoint = isAuthenticated 
        ? '/api/customer/bookings/create-payment-intent/'
        : '/api/public/create-payment-intent/';

      let paymentRequest: any = {
        service_type: bookingData.service_type,
        pickup_date: bookingData.service_type === 'blade_transfer'
          ? bookingData.blade_flight_date
          : bookingData.pickup_date,
        coi_required: bookingData.coi_required || false,
        // Send ZIP codes for accurate geographic surcharge calculation ($175 per out-of-zone address)
        pickup_zip_code: bookingData.pickup_address?.zip_code,
        delivery_zip_code: bookingData.delivery_address?.zip_code,
        // Keep is_outside_core_area as fallback for backwards compatibility
        is_outside_core_area: bookingData.is_outside_core_area || false,
      };

      if (bookingData.service_type === 'mini_move') {
        paymentRequest.mini_move_package_id = bookingData.mini_move_package_id;
        paymentRequest.include_packing = bookingData.include_packing;
        paymentRequest.include_unpacking = bookingData.include_unpacking;
        paymentRequest.pickup_time = bookingData.pickup_time;
        paymentRequest.specific_pickup_hour = bookingData.specific_pickup_hour;
      } else if (bookingData.service_type === 'standard_delivery') {
        paymentRequest.standard_delivery_item_count = bookingData.standard_delivery_item_count;
        paymentRequest.is_same_day_delivery = bookingData.is_same_day_delivery;
        paymentRequest.specialty_items = bookingData.specialty_items;
      } else if (bookingData.service_type === 'specialty_item') {
        paymentRequest.specialty_items = bookingData.specialty_items;
        paymentRequest.is_same_day_delivery = bookingData.is_same_day_delivery;
      } else if (bookingData.service_type === 'blade_transfer') {
        paymentRequest.blade_airport = bookingData.blade_airport;
        paymentRequest.blade_flight_date = bookingData.blade_flight_date;
        paymentRequest.blade_flight_time = bookingData.blade_flight_time;
        paymentRequest.blade_bag_count = bookingData.blade_bag_count;
      }

      if (!isAuthenticated && bookingData.customer_info?.email) {
        paymentRequest.email = bookingData.customer_info.email;
        paymentRequest.first_name = bookingData.customer_info.first_name;
        paymentRequest.last_name = bookingData.customer_info.last_name;
        paymentRequest.phone = bookingData.customer_info.phone;
      } else if (isAuthenticated && user?.email) {
        paymentRequest.customer_email = user.email;
      }

      // Include discount code if validated
      if (bookingData.discount_code && bookingData.discount_validated) {
        paymentRequest.discount_code = bookingData.discount_code;
      }

      console.log('💳 Creating payment intent:', paymentRequest);
      const response = await apiClient.post(endpoint, paymentRequest);
      console.log('✅ Payment intent created:', response.data);
      
      return response.data;
    },
    onSuccess: (data) => {
      console.log('💳 Payment intent successful:', data);

      // Free order — skip Stripe payment, go directly to booking
      if (data.payment_intent_id === 'free_order') {
        console.log('🎉 Free order — skipping payment');
        createBookingMutation.mutate('free_order');
        return;
      }

      setClientSecret(data.client_secret);
      setPaymentIntentId(data.payment_intent_id);
      setShowPayment(true);
      setLoading(false);
    },
    onError: (error: AxiosError | Error) => {
      console.error('❌ Payment intent failed:', error);
      setLoading(false);
      if ('response' in error && error.response) {
        console.error('Error response:', error.response.data);
      }
    }
  });

  // STEP 2: Create booking AFTER payment succeeds
  const createBookingMutation = useMutation({
    mutationFn: async (paymentIntentId: string): Promise<BookingResponse> => {
      const endpoint = isAuthenticated 
        ? '/api/customer/bookings/create/'
        : '/api/public/guest-booking/';

      let bookingRequest: any = {
        payment_intent_id: paymentIntentId,
        service_type: bookingData.service_type,
        pickup_date: bookingData.service_type === 'blade_transfer' 
          ? bookingData.blade_flight_date 
          : bookingData.pickup_date,
        pickup_time: bookingData.pickup_time,
        specific_pickup_hour: bookingData.specific_pickup_hour,
        special_instructions: bookingData.special_instructions,
        coi_required: bookingData.coi_required,
      };

      if (bookingData.service_type === 'mini_move') {
        bookingRequest.mini_move_package_id = bookingData.mini_move_package_id;
        bookingRequest.include_packing = bookingData.include_packing;
        bookingRequest.include_unpacking = bookingData.include_unpacking;
      } else if (bookingData.service_type === 'standard_delivery') {
        bookingRequest.standard_delivery_item_count = bookingData.standard_delivery_item_count;
        bookingRequest.is_same_day_delivery = bookingData.is_same_day_delivery;
        bookingRequest.specialty_items = bookingData.specialty_items;
      } else if (bookingData.service_type === 'specialty_item') {
        bookingRequest.specialty_items = bookingData.specialty_items;
        bookingRequest.is_same_day_delivery = bookingData.is_same_day_delivery;
      } else if (bookingData.service_type === 'blade_transfer') {
        bookingRequest.blade_airport = bookingData.blade_airport;
        bookingRequest.blade_flight_date = bookingData.blade_flight_date;
        bookingRequest.blade_flight_time = bookingData.blade_flight_time;
        bookingRequest.blade_bag_count = bookingData.blade_bag_count;
      }

      if (isAuthenticated) {
        const timestamp = new Date().toISOString().slice(11, 16);
        const dateStr = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        bookingRequest.new_pickup_address = bookingData.pickup_address;
        bookingRequest.new_delivery_address = bookingData.delivery_address;
        bookingRequest.save_pickup_address = true;
        bookingRequest.save_delivery_address = true;
        bookingRequest.pickup_address_nickname = `Pickup ${dateStr} ${timestamp}`;
        bookingRequest.delivery_address_nickname = `Delivery ${dateStr} ${timestamp}`;
      } else {
        bookingRequest.first_name = bookingData.customer_info?.first_name;
        bookingRequest.last_name = bookingData.customer_info?.last_name;
        bookingRequest.email = bookingData.customer_info?.email;
        bookingRequest.phone = bookingData.customer_info?.phone;
        bookingRequest.pickup_address = bookingData.pickup_address;
        bookingRequest.delivery_address = bookingData.delivery_address;
      }

      // Include discount code if validated
      if (bookingData.discount_code && bookingData.discount_validated) {
        bookingRequest.discount_code = bookingData.discount_code;
      }

      console.log('📦 Creating booking with payment:', bookingRequest);
      const response = await apiClient.post(endpoint, bookingRequest);
      console.log('✅ Booking created:', response.data);

      return response.data;
    },
    onSuccess: (data) => {
      console.log('✅ Booking creation successful:', data);
      setBookingNumber(data.booking.booking_number);
      setBookingCompleteLocal(true);
      setBookingComplete(data.booking.booking_number);
      setLoading(false);
      
      if (isAuthenticated) {
        queryClient.invalidateQueries({ queryKey: ['customer', 'dashboard'] });
        queryClient.invalidateQueries({ queryKey: ['customer', 'bookings'] });
      }
    },
    onError: (error: AxiosError | Error) => {
      console.error('❌ Booking creation failed:', error);
      setLoading(false);
      if ('response' in error && error.response) {
        console.error('Error response:', error.response.data);
      }
    }
  });

  const handleInitiatePayment = () => {
    if (!termsAccepted) {
      alert('Please accept the Terms of Service to continue.');
      return;
    }
    
    console.log('=== INITIATING PAYMENT FLOW ===');
    setLoading(true);
    createPaymentIntentMutation.mutate();
  };

  const handlePaymentSuccess = (paymentIntentId: string) => {
    console.log('💳 Payment successful, creating booking with payment ID:', paymentIntentId);
    setLoading(true);
    createBookingMutation.mutate(paymentIntentId);
  };

  const handleStartOver = () => {
    console.log('Starting over - resetting wizard');
    setBookingCompleteLocal(false);
    setBookingNumber('');
    setClientSecret('');
    setPaymentIntentId('');
    setShowPayment(false);
    resetWizard();
    router.push('/book');
  };

  const handlePreviousStep = () => {
    if (showPayment) {
      setShowPayment(false);
      setClientSecret('');
      setPaymentIntentId('');
    } else {
      previousStep();
    }
  };

  if (isPricingRecalculating) {
    return (
      <div className="flex items-center justify-center py-12">
        <div className="text-center">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-navy-900 mx-auto mb-4"></div>
          <p className="text-navy-700">Calculating final pricing...</p>
        </div>
      </div>
    );
  }

  if (bookingComplete) {
    return (
      <div className="text-center space-y-6">
        <div className="text-6xl mb-4">✅</div>
        
        <Card variant="luxury">
          <CardContent>
            <h3 className="text-2xl font-serif font-bold text-navy-900 mb-4">
              Payment Successful!
            </h3>
            
            <div className="space-y-3">
              <div className="bg-gold-50 border border-gold-200 rounded-lg p-4">
                <span className="text-sm text-gold-700">Your Booking Number</span>
                <div className="text-2xl font-bold text-navy-900">{bookingNumber}</div>
              </div>
              
              <p className="text-navy-700">
                {bookingData.service_type === 'blade_transfer'
                  ? 'Your airport transfer is confirmed and paid.'
                  : 'Your luxury move is confirmed and paid.'}
                {isAuthenticated ? (
                  ' Check your dashboard for booking details.'
                ) : (
                  <>
                    {' '}We'll send a confirmation email to{' '}
                    <strong>{bookingData.customer_info?.email || user?.email}</strong> with all the details.
                  </>
                )}
              </p>
            </div>
          </CardContent>
        </Card>

        <div className="space-y-4">
          <h4 className="text-lg font-medium text-navy-900">What's Next?</h4>
          
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
            <Card variant="default">
              <CardContent>
                <div className="text-center">
                  <div className="text-2xl mb-2">📧</div>
                  <h5 className="font-medium text-navy-900 mb-1">Confirmation Email</h5>
                  <p className="text-navy-600">Check your email for booking details and our team contact info.</p>
                </div>
              </CardContent>
            </Card>
            
            <Card variant="default">
              <CardContent>
                <div className="text-center">
                  <div className="text-2xl mb-2">📞</div>
                  <h5 className="font-medium text-navy-900 mb-1">Coordination Call</h5>
                  <p className="text-navy-600">
                    {bookingData.service_type === 'blade_transfer' 
                      ? 'We\'ll confirm your pickup details before your flight.' 
                      : 'We\'ll call 24 hours before pickup to confirm timing.'}
                  </p>
                </div>
              </CardContent>
            </Card>
            
            <Card variant="default">
              <CardContent>
                <div className="text-center">
                  <div className="text-2xl mb-2">🚛</div>
                  <h5 className="font-medium text-navy-900 mb-1">White Glove Service</h5>
                  <p className="text-navy-600">Our professional team handles everything with care.</p>
                </div>
              </CardContent>
            </Card>
          </div>
        </div>

        <div className="flex flex-col sm:flex-row justify-center gap-4">
          <Button variant="outline" onClick={handleStartOver}>
            Book Another Move
          </Button>
          <Button variant="primary" onClick={() => router.push(isAuthenticated ? '/dashboard' : '/')}>
            {isAuthenticated ? 'Back to Dashboard' : 'Back to Home'}
          </Button>
        </div>
      </div>
    );
  }

  if (showPayment && clientSecret && stripePromise) {
    return (
      <div className="space-y-6">
        <Card variant="luxury">
          <CardHeader>
            <h3 className="text-xl font-serif font-bold text-navy-900">Complete Payment</h3>
          </CardHeader>
          <CardContent>
            <Elements stripe={stripePromise} options={{ clientSecret }}>        
              <CheckoutForm 
                clientSecret={clientSecret}
                paymentIntentId={paymentIntentId}
                totalAmount={bookingData.pricing_data?.total_price_dollars || 0}
                onSuccess={handlePaymentSuccess}
              />
            </Elements>
          </CardContent>
        </Card>

        <div className="flex justify-between">
          <Button variant="outline" onClick={handlePreviousStep}>
            ← Back to Review
          </Button>
          <Button variant="outline" onClick={handleStartOver}>
            Start Over
          </Button>
        </div>
      </div>
    );
  }

  if (!isAuthenticated && (!bookingData.customer_info || !bookingData.customer_info.email)) {
    return (
      <div className="space-y-6">
        <Card className="border-red-200 bg-red-50">
          <CardContent>
            <h3 className="text-lg font-medium text-red-800 mb-2">Missing Customer Information</h3>
            <p className="text-red-700 mb-4">
              We need your contact information to complete this booking. Please go back and fill out the customer information step.
            </p>
            <Button variant="outline" onClick={handlePreviousStep}>
              ← Go Back to Customer Info
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <Card variant="luxury">
        <CardHeader>
          <h3 className="text-xl font-serif font-bold text-navy-900">Booking Summary</h3>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            <div>
              <h4 className="font-medium text-navy-900 mb-2">Service</h4>
              <p className="text-navy-700">
                {bookingData.service_type === 'mini_move' && 'Mini Move'}
                {bookingData.service_type === 'standard_delivery' && 'Standard Delivery'}
                {bookingData.service_type === 'specialty_item' && 'Specialty Items'}
                {bookingData.service_type === 'blade_transfer' && 'Airport Transfer'}
              </p>
              
              {/* ✅ Display specialty items with quantities */}
              <SpecialtyItemsList bookingData={bookingData} />
              
              {bookingData.include_packing && (
                <p className="text-sm text-navy-600">+ Professional Packing</p>
              )}
              {bookingData.include_unpacking && (
                <p className="text-sm text-navy-600">+ Professional Unpacking</p>
              )}
            </div>

            {bookingData.service_type === 'blade_transfer' ? (
              <>
                <div>
                  <h4 className="font-medium text-navy-900 mb-2">Flight Details</h4>
                  <p className="text-navy-700">
                    <strong>Airport:</strong> {bookingData.blade_airport === 'JFK' ? 'JFK International' : 'Newark Liberty (EWR)'}
                  </p>
                  <p className="text-navy-700">
                    <strong>Flight Date:</strong> {bookingData.blade_flight_date && new Date(bookingData.blade_flight_date + 'T00:00:00').toLocaleDateString('en-US', {
                      weekday: 'long',
                      year: 'numeric',
                      month: 'long',
                      day: 'numeric'
                    })}
                  </p>
                  <p className="text-navy-700">
                    <strong>Flight Time:</strong> {bookingData.blade_flight_time && new Date(`2000-01-01T${bookingData.blade_flight_time}`).toLocaleTimeString('en-US', {
                      hour: 'numeric',
                      minute: '2-digit',
                      hour12: true
                    })}
                  </p>
                  <p className="text-navy-700">
                    <strong>Bags:</strong> {bookingData.blade_bag_count}
                  </p>
                  <div className="mt-2 bg-blue-50 border border-blue-200 rounded p-2">
                    <p className="text-sm text-blue-800">
                      <strong>Pickup Ready Time:</strong> {bookingData.blade_ready_time && new Date(`2000-01-01T${bookingData.blade_ready_time}`).toLocaleTimeString('en-US', {
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                      })}
                    </p>
                  </div>
                </div>
              </>
            ) : (
              <div>
                <h4 className="font-medium text-navy-900 mb-2">Pickup Schedule</h4>
                <p className="text-navy-700">
                  {bookingData.pickup_date && new Date(bookingData.pickup_date + 'T00:00:00').toLocaleDateString('en-US', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                  })}
                </p>
                <p className="text-navy-600">
                  {getTimeDisplay(bookingData.pickup_time, bookingData.specific_pickup_hour)}
                </p>
              </div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <h4 className="font-medium text-navy-900 mb-2">
                  {bookingData.service_type === 'blade_transfer' ? 'Pickup Address (NYC)' : 'Pickup Address'}
                </h4>
                <div className="text-navy-700 text-sm">
                  <div>{bookingData.pickup_address?.address_line_1}</div>
                  {bookingData.pickup_address?.address_line_2 && (
                    <div>{bookingData.pickup_address.address_line_2}</div>
                  )}
                  <div>
                    {bookingData.pickup_address?.city}, {bookingData.pickup_address?.state} {bookingData.pickup_address?.zip_code}
                  </div>
                </div>
              </div>
              
              <div>
                <h4 className="font-medium text-navy-900 mb-2">
                  {bookingData.service_type === 'blade_transfer' ? 'Delivery (Airport)' : 'Delivery Address'}
                </h4>
                <div className="text-navy-700 text-sm">
                  {bookingData.service_type === 'blade_transfer' ? (
                    <div className="font-medium">
                      {bookingData.blade_airport === 'JFK' ? 'JFK International Airport' : 'Newark Liberty International Airport (EWR)'}
                    </div>
                  ) : (
                    <>
                      <div>{bookingData.delivery_address?.address_line_1}</div>
                      {bookingData.delivery_address?.address_line_2 && (
                        <div>{bookingData.delivery_address.address_line_2}</div>
                      )}
                      <div>
                        {bookingData.delivery_address?.city}, {bookingData.delivery_address?.state} {bookingData.delivery_address?.zip_code}
                      </div>
                    </>
                  )}
                </div>
              </div>
            </div>

            {!isAuthenticated && bookingData.customer_info && (
              <div>
                <h4 className="font-medium text-navy-900 mb-2">Contact Information</h4>
                <div className="text-navy-700">
                  <div>
                    {bookingData.customer_info.first_name} {bookingData.customer_info.last_name}
                  </div>
                  <div>{bookingData.customer_info.email}</div>
                  <div>{bookingData.customer_info.phone}</div>
                </div>
              </div>
            )}

            {bookingData.special_instructions && (
              <div>
                <h4 className="font-medium text-navy-900 mb-2">Special Instructions</h4>
                <p className="text-navy-700 text-sm bg-gray-50 p-3 rounded">
                  {bookingData.special_instructions}
                </p>
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      <Card variant="default" className="border-navy-200">
        <CardHeader>
          <h3 className="text-lg font-medium text-navy-900">Discount Code</h3>
        </CardHeader>
        <CardContent>
          <DiscountCodeInput />
        </CardContent>
      </Card>

      {bookingData.pricing_data && (
        <Card variant="elevated">
          <CardHeader>
            <h3 className="text-xl font-serif font-bold text-navy-900">Pricing</h3>
          </CardHeader>
          <CardContent>
            <div className="space-y-2">
              <div className="flex justify-between">
                <span className="text-navy-900 font-medium">
                  {bookingData.service_type === 'blade_transfer' && `${bookingData.blade_bag_count} bags × $75:`}
                  {bookingData.service_type === 'mini_move' && 'Mini Move Package:'}
                  {bookingData.service_type === 'standard_delivery' && 'Base Service:'}
                  {bookingData.service_type === 'specialty_item' && 'Specialty Items:'}
                </span>
                <span className="text-navy-900 font-semibold">${bookingData.pricing_data.base_price_dollars}</span>
              </div>
              
              {bookingData.pricing_data.same_day_delivery_dollars > 0 && (
                <div className="flex justify-between">
                  <span className="text-navy-900 font-medium">Same-Day Delivery:</span>
                  <span className="text-navy-900 font-semibold">+${bookingData.pricing_data.same_day_delivery_dollars}</span>
                </div>
              )}
              
              {bookingData.pricing_data.surcharge_dollars > 0 && (
                <div className="flex justify-between">
                  <span className="text-navy-900 font-medium">Peak Date Surcharge:</span>
                  <span className="text-navy-900 font-semibold">+${bookingData.pricing_data.surcharge_dollars}</span>
                </div>
              )}
              
              {bookingData.pricing_data.coi_fee_dollars > 0 && (
                <div className="flex justify-between">
                  <span className="text-navy-900 font-medium">COI Fee:</span>
                  <span className="text-navy-900 font-semibold">+${bookingData.pricing_data.coi_fee_dollars}</span>
                </div>
              )}
              
              {bookingData.pricing_data.organizing_total_dollars > 0 && (
                <div className="flex justify-between">
                  <span className="text-navy-900 font-medium">Organizing Services:</span>
                  <span className="text-navy-900 font-semibold">+${bookingData.pricing_data.organizing_total_dollars}</span>
                </div>
              )}

              {bookingData.pricing_data.organizing_tax_dollars > 0 && (
                <div className="flex justify-between">
                  <span className="text-navy-900 font-medium">Tax (8.25%):</span>
                  <span className="text-navy-900 font-semibold">+${bookingData.pricing_data.organizing_tax_dollars}</span>
                </div>
              )}

              {bookingData.pricing_data.time_window_surcharge_dollars > 0 && (
                <div className="flex justify-between">
                  <span className="text-navy-900 font-medium">1-Hour Window:</span>
                  <span className="text-navy-900 font-semibold">+${bookingData.pricing_data.time_window_surcharge_dollars}</span>
                </div>
              )}
              
              {bookingData.pricing_data.geographic_surcharge_dollars > 0 && (
                <div className="flex justify-between">
                  <span className="text-navy-900 font-medium">Distance Surcharge:</span>
                  <span className="text-navy-900 font-semibold">+${bookingData.pricing_data.geographic_surcharge_dollars}</span>
                </div>
              )}
              
              {(bookingData.pricing_data.discount_amount_dollars ?? 0) > 0 && (
                <div className="flex justify-between text-green-700">
                  <span className="font-medium">
                    Discount ({bookingData.discount_info?.discount_description}):
                  </span>
                  <span className="font-semibold">-${bookingData.pricing_data.discount_amount_dollars?.toFixed(2)}</span>
                </div>
              )}

              <hr className="border-gray-200" />

              <div className="flex justify-between text-xl font-bold">
                <span className="text-navy-900">Total:</span>
                <span className="text-navy-900">${bookingData.pricing_data.total_price_dollars.toFixed(2)}</span>
              </div>
              
              {bookingData.service_type === 'blade_transfer' && (
                <div className="mt-3 bg-green-50 border border-green-200 rounded-lg p-3">
                  <p className="text-sm text-green-800">
                    <strong>No surcharges!</strong> Airport transfer pricing is straightforward with no weekend, geographic, or time window fees.
                  </p>
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      )}

      <Card variant="default" className="border-navy-200">
        <CardHeader>
          <h3 className="text-lg font-medium text-navy-900">Terms of Service Agreement</h3>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            <div className="max-h-60 overflow-y-auto p-4 bg-gray-50 rounded text-xs text-navy-700 border leading-relaxed">
              <p className="font-bold mb-3 text-sm">PLEASE READ THESE TERMS AND CONDITIONS CAREFULLY</p>
              
              <p className="mb-3">
                BY USING Tote Taxi and/or the Tote Taxi Website, YOU ARE AGREEING TO BE BOUND BY THESE TERMS AND CONDITIONS. 
                IF YOU DO NOT AGREE TO THE TERMS AND CONDITIONS, DO NOT USE Tote Taxi'S SERVICES or the Tote Taxi Website.
              </p>

              <p className="font-semibold mb-2">General</p>
              <p className="mb-3">
                Tote Taxi LLC ("Tote Taxi") may revise and update these Terms and Conditions at any time without notice. 
                Your continued usage of the Tote Taxi Website after any such change or update will mean you accept those changes or updates.
              </p>

              <p className="mb-3">
                Any aspect of the Tote Taxi Website may be changed, supplemented, deleted or updated without notice at the sole discretion of Tote Taxi.
              </p>

              <p className="mb-3">
                Tote Taxi may establish or change its general practices and limits concerning Tote Taxi services in its sole discretion.
              </p>

              <p className="mb-3">
                Your violation of any of the Terms and Conditions may result in, among other things, the termination of your access to Tote Taxi's 
                services and/or the Tote Taxi Website.
              </p>

              <p className="font-semibold mb-2">Restrictions on Your Use of Tote Taxi</p>
              <p className="mb-3 font-medium text-orange-600">
                Tote Taxi will not accept for transport luggage or packages in excess of $150.00 in value. Tote Taxi's inadvertent acceptance 
                of any luggage or package in excess of $150.00 shall not negate Tote Taxi's limitation of liability stated herein.
              </p>

              <p className="mb-3">
                By delivering luggage or package to, or causing luggage or package to be delivered to, Tote Taxi for transport, you represent 
                that the luggage or package does not contain any illegal substances, any liquids, or any hazardous materials, and does not exceed $150.00 in value.
              </p>

              <p className="font-semibold mb-2">Limitation of Liability</p>
              <p className="mb-3">
                TO THE EXTENT NOT PROHIBITED BY APPLICABLE LAW, IN NO EVENT SHALL TOTE TAXI BE LIABLE FOR PERSONAL INJURY, OR ANY INCIDENTAL, 
                SPECIAL, INDIRECT OR CONSEQUENTIAL DAMAGES WHATSOEVER, REGARDLESS OF THE THEORY OF LIABILITY (CONTRACT, TORT OR OTHERWISE) EVEN 
                IF Tote Taxi HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.
              </p>

              <p className="mb-3">
                In no event shall Tote Taxi's total liability to you for all damages (other than as may be required by applicable law in cases 
                involving personal injury) exceed $150.00. The foregoing limitations will apply even if the above stated remedy fails of its essential purpose.
              </p>

              <p className="font-semibold mb-2">Controlling Law</p>
              <p className="mb-3">
                These Terms and Conditions are governed by and shall be construed in accordance with the internal substantive laws of the State of New York, 
                excluding any conflict-of-laws rule or principle that might refer the governance of the construction of the Terms and Conditions to the law 
                of another jurisdiction.
              </p>

              <p className="mb-3">
                Each party agrees to the exclusive jurisdiction of the state and federal courts in and for Suffolk County, New York for any litigation 
                or other dispute resolution relating in any way to these Terms and Conditions.
              </p>

              <p className="font-semibold mb-2 text-orange-600">Claims Deadline</p>
              <p className="mb-3 font-medium">
                YOU AGREE THAT ANY CLAIM OR CAUSE OF ACTION ARISING OUT OF OR RELATED TO YOUR USE OF THE TOTE TAXI WEBSITE OR SERVICES AND/OR 
                CONTENT MUST BE FILED WITHIN ONE (1) YEAR AFTER SUCH CLAIM OR CAUSE OF ACTION AROSE.
              </p>

              <p className="text-xs text-navy-500 mt-4 italic">
                Complete terms and conditions. Scroll to read all terms before accepting.
              </p>
            </div>
            
            <label className="flex items-start space-x-3 cursor-pointer">
              <input
                type="checkbox"
                checked={termsAccepted}
                onChange={(e) => setTermsAccepted(e.target.checked)}
                className="mt-1 h-4 w-4 text-navy-600 rounded border-gray-300 focus:ring-navy-500"
              />
              <div className="text-sm">
                <span className="text-navy-900 font-medium">
                  I acknowledge that I have read, understood, and agree to be bound by the Terms of Service.
                </span>
                <p className="text-navy-600 mt-1">
                  By checking this box, you confirm your acceptance of all terms and conditions, 
                  including the $150 liability limit, item restrictions, and one-year claims deadline.
                </p>
              </div>
            </label>
          </div>
        </CardContent>
      </Card>

      <div className="flex justify-between items-center pt-4">
        <Button 
          variant="outline" 
          onClick={handlePreviousStep}
        >
          ← Previous
        </Button>
        
        <Button 
          variant="primary" 
          size="lg"
          onClick={handleInitiatePayment}
          disabled={isLoading || createPaymentIntentMutation.isPending || !termsAccepted}
        >
          {isLoading || createPaymentIntentMutation.isPending ? 'Preparing Payment...' : 'Continue to Payment'}
        </Button>
      </div>
    </div>
  );
}
```

# ──── frontend/src/components/booking/service-selection-step.tsx ────

```tsx
// frontend/src/components/booking/service-selection-step.tsx
'use client';

import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { apiClient } from '@/lib/api-client';
import { useBookingWizard } from '@/stores/booking-store';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { ChevronDownIcon, ChevronUpIcon, MinusIcon, PlusIcon } from '@heroicons/react/24/outline';
import type { ServiceCatalog } from '@/types';

const TAX_RATE = 0.0825;

const ORGANIZING_SERVICES = {
  petite: {
    packing: {
      name: 'Petite Packing',
      description: '1/2 day (up to 4 hours) with 2 organizers. Includes garment bags, moving bags + additional packing supplies upon request (up to $250).',
      price: 1400,
      duration: 4,
      organizers: 2,
      supplies: 250
    },
    unpacking: {
      name: 'Petite Unpacking', 
      description: '1/2 day (up to 4 hours) with 2 organizers. Organizing light (no supplies).',
      price: 1130,
      duration: 4,
      organizers: 2,
      supplies: 0
    }
  },
  standard: {
    packing: {
      name: 'Standard Packing',
      description: '1 day (up to 8 hours) with 2 organizers. Includes garment bags, moving bags + additional packing supplies upon request (up to $250).',
      price: 2535,
      duration: 8,
      organizers: 2,
      supplies: 250
    },
    unpacking: {
      name: 'Standard Unpacking',
      description: '1 day (up to 8 hours) with 2 organizers. Organizing light (no supplies).',
      price: 2265,
      duration: 8,
      organizers: 2,
      supplies: 0
    }
  },
  full: {
    packing: {
      name: 'Full Packing',
      description: '1 day (up to 8 hours) with 4 organizers. Includes garment bags, moving bags + additional packing supplies upon request (up to $500).',
      price: 5070,
      duration: 8,
      organizers: 4,
      supplies: 500
    },
    unpacking: {
      name: 'Full Unpacking',
      description: '1 day (up to 8 hours) with 4 organizers. Organizing light (no supplies).',
      price: 4530,
      duration: 8,
      organizers: 4,
      supplies: 0
    }
  }
};

function calculateWithTax(price: number) {
  const tax = price * TAX_RATE;
  return {
    subtotal: price,
    tax: tax,
    total: price + tax
  };
}

export function ServiceSelectionStep() {
  const { bookingData, updateBookingData, updateSpecialtyItemQuantity, getSpecialtyItemQuantity, nextStep } = useBookingWizard();
  const [packingExpanded, setPackingExpanded] = useState(false);
  const [unpackingExpanded, setUnpackingExpanded] = useState(false);
  const [dateError, setDateError] = useState<string>('');
  const [timeError, setTimeError] = useState<string>('');

  console.log('SERVICE STEP - Current booking data:', bookingData);
  console.log('mini_move_package_id:', bookingData.mini_move_package_id);
  console.log('service_type:', bookingData.service_type);
  console.log('specialty_items:', bookingData.specialty_items);

  const { data: services, isLoading } = useQuery({
    queryKey: ['services', 'catalog'],
    queryFn: async (): Promise<ServiceCatalog> => {
      const response = await apiClient.get('/api/public/services/');
      return response.data;
    }
  });

  const validateBladeData = () => {
    setDateError('');
    setTimeError('');
    
    if (!bookingData.blade_airport) {
      return false;
    }
    
    if (!bookingData.blade_flight_date) {
      setDateError('Please select your flight date');
      return false;
    }
    
    const tomorrow = new Date();
    tomorrow.setHours(0, 0, 0, 0);
    tomorrow.setDate(tomorrow.getDate() + 1);
    
    const selected = new Date(bookingData.blade_flight_date + 'T00:00:00');
    
    if (selected < tomorrow) {
      setDateError('Flight must be booked at least 1 day in advance');
      return false;
    }
    
    if (!bookingData.blade_flight_time) {
      setTimeError('Please select your flight departure time');
      return false;
    }
    
    if (!bookingData.blade_bag_count || bookingData.blade_bag_count < 2) {
      return false;
    }
    
    return true;
  };

  const handleContinue = () => {
    if (bookingData.service_type === 'blade_transfer') {
      if (!validateBladeData()) {
        return;
      }
    }
    
    nextStep();
  };

  const handleMiniMoveSelect = (packageId: string) => {
    const selectedPackage = services?.mini_move_packages.find(pkg => pkg.id === packageId);
    
    console.log('SELECTING PACKAGE:', packageId);
    console.log('Package Type:', selectedPackage?.package_type);
    console.log('Package Name:', selectedPackage?.name);
    
    updateBookingData({
      service_type: 'mini_move',
      mini_move_package_id: packageId,
      package_type: selectedPackage?.package_type,
      standard_delivery_item_count: undefined,
      specialty_items: [],
      blade_airport: undefined,
      blade_flight_date: undefined,
      blade_flight_time: undefined,
      blade_bag_count: undefined,
    });
    
    console.log('Updated booking data - new state should have package_id:', packageId);
  };

  const handleOrganizingServiceToggle = (serviceType: 'packing' | 'unpacking', enabled: boolean) => {
    updateBookingData({
      [serviceType === 'packing' ? 'include_packing' : 'include_unpacking']: enabled
    });
    
    if (enabled) {
      if (serviceType === 'packing') {
        setPackingExpanded(true);
      } else {
        setUnpackingExpanded(true);
      }
    }
  };

  // ✅ NEW: Handle quantity changes for specialty items
// ✅ NEW: Handle quantity changes for specialty items
  const handleQuantityChange = (itemId: string, change: number) => {
    const currentQty = getSpecialtyItemQuantity(itemId);
    const newQty = Math.max(0, currentQty + change);
    
    console.log('🔄 Updating specialty item:', itemId, 'New quantity:', newQty);
    updateSpecialtyItemQuantity(itemId, newQty);
    
    // ✅ ADD THIS - Log bookingData after update
    setTimeout(() => {
      console.log('📦 BookingData after update:', bookingData);
      console.log('🎯 canContinue():', canContinue());
    }, 100);
  };
  const canContinue = () => {
      if (bookingData.service_type === 'mini_move') {
        return !!bookingData.mini_move_package_id;
      }
      
      if (bookingData.service_type === 'standard_delivery') {
        const itemCount = bookingData.standard_delivery_item_count || 0;
        const hasSpecialtyItems = (bookingData.specialty_items ?? []).some(item => item.quantity > 0); // ✅ FIXED
        return itemCount > 0 || hasSpecialtyItems;
      }
      
      if (bookingData.service_type === 'specialty_item') {
        return (bookingData.specialty_items ?? []).some(item => item.quantity > 0); // ✅ FIXED
      }
      
      if (bookingData.service_type === 'blade_transfer') {
        return !!(
          bookingData.blade_airport &&
          bookingData.blade_flight_date &&
          bookingData.blade_flight_time &&
          bookingData.blade_bag_count &&
          bookingData.blade_bag_count >= 2
        );
      }
      
      return false;
    };

  if (isLoading) {
    return (
      <div className="space-y-4">
        {[1, 2, 3].map(i => (
          <div key={i} className="animate-pulse">
            <div className="h-32 bg-navy-200 rounded-lg"></div>
          </div>
        ))}
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div>
        <h3 className="text-lg font-medium text-navy-900 mb-4">Choose Your Service</h3>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <button
            onClick={() => updateBookingData({ 
              service_type: 'mini_move',
              standard_delivery_item_count: undefined,
              specialty_items: [],
              blade_airport: undefined,
              blade_flight_date: undefined,
              blade_flight_time: undefined,
              blade_bag_count: undefined,
            })}
            className={`p-4 rounded-lg border-2 text-left transition-all ${
              bookingData.service_type === 'mini_move'
                ? 'border-navy-500 bg-navy-50'
                : 'border-gray-200 hover:border-gray-300'
            }`}
          >
            <h4 className="font-medium text-navy-900 mb-2">Mini Moves</h4>
            <p className="text-sm text-navy-600">Complete packages for seasonal relocation</p>
          </button>

          <button
            onClick={() => updateBookingData({ 
              service_type: 'standard_delivery',
              mini_move_package_id: undefined,
              package_type: undefined,
              include_packing: false,
              include_unpacking: false,
              blade_airport: undefined,
              blade_flight_date: undefined,
              blade_flight_time: undefined,
              blade_bag_count: undefined,
            })}
            className={`p-4 rounded-lg border-2 text-left transition-all ${
              bookingData.service_type === 'standard_delivery'
                ? 'border-navy-500 bg-navy-50'
                : 'border-gray-200 hover:border-gray-300'
            }`}
          >
            <h4 className="font-medium text-navy-900 mb-2">Standard Delivery</h4>
            <p className="text-sm text-navy-600">Regular items + specialty items</p>
          </button>

          <button
            onClick={() => updateBookingData({ 
              service_type: 'blade_transfer',
              mini_move_package_id: undefined,
              package_type: undefined,
              include_packing: false,
              include_unpacking: false,
              standard_delivery_item_count: undefined,
              specialty_items: [],
            })}
            className={`p-4 rounded-lg border-2 text-left transition-all ${
              bookingData.service_type === 'blade_transfer'
                ? 'border-navy-500 bg-navy-50'
                : 'border-gray-200 hover:border-gray-300'
            }`}
          >
            <h4 className="font-medium text-navy-900 mb-2">Airport Transfer</h4>
            <p className="text-sm text-navy-600">NYC → Airport luggage delivery</p>
            <p className="text-xs text-navy-500 mt-2">JFK/EWR</p>
          </button>
        </div>
      </div>

      {bookingData.service_type === 'mini_move' && services?.mini_move_packages && (
        <div>
          <h3 className="text-lg font-medium text-navy-900 mb-4">Select Package</h3>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            {services.mini_move_packages.map((pkg) => (
              <Card 
                key={pkg.id} 
                variant={bookingData.mini_move_package_id === pkg.id ? "luxury" : "default"}
                className="cursor-pointer"
                onClick={() => handleMiniMoveSelect(pkg.id)}
              >
                <CardHeader>
                  <div className="text-center">
                    <h4 className="font-medium text-navy-900">{pkg.name}</h4>
                    {pkg.is_most_popular && (
                      <span className="inline-block bg-gold-100 text-gold-800 text-xs px-2 py-1 rounded-full mt-1">
                        Most Popular
                      </span>
                    )}
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="text-center">
                    <div className="text-2xl font-bold text-navy-900 mb-2">
                      ${pkg.base_price_dollars}
                    </div>
                    <p className="text-navy-600 text-sm mb-3">{pkg.description}</p>
                    <p className="text-xs text-navy-500">
                      {pkg.max_items ? `Up to ${pkg.max_items} items` : 'Unlimited items'}
                    </p>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>

          {bookingData.mini_move_package_id && (
            <div>
              <h4 className="text-lg font-medium text-navy-900 mb-3">Professional Organizing Services</h4>
              <p className="text-sm text-navy-600 mb-4">
                Add professional packing and unpacking services. Click to view details and pricing.
              </p>
              
              {(() => {
                const selectedPackage = services.mini_move_packages.find(p => p.id === bookingData.mini_move_package_id);
                const tier = selectedPackage?.package_type;
                const organizingOptions = tier ? ORGANIZING_SERVICES[tier] : null;
                
                if (!organizingOptions) return null;

                return (
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <Card 
                      variant={bookingData.include_packing ? "luxury" : "default"}
                      className="transition-all"
                    >
                      <CardHeader>
                        <div className="flex items-center justify-between">
                          <div className="flex items-center space-x-3">
                            <input
                              type="checkbox"
                              checked={bookingData.include_packing || false}
                              onChange={(e) => handleOrganizingServiceToggle('packing', e.target.checked)}
                              className="h-4 w-4 text-navy-600 rounded"
                            />
                            <h5 className="font-semibold text-navy-900">{organizingOptions.packing.name}</h5>
                          </div>
                          <button
                            onClick={() => setPackingExpanded(!packingExpanded)}
                            className="text-navy-600 hover:text-navy-900"
                          >
                            {packingExpanded || bookingData.include_packing ? (
                              <ChevronUpIcon className="h-5 w-5" />
                            ) : (
                              <ChevronDownIcon className="h-5 w-5" />
                            )}
                          </button>
                        </div>
                        
                        {!packingExpanded && !bookingData.include_packing && (
                          <p className="text-sm text-navy-600 mt-2">
                            {organizingOptions.packing.duration} hours • {organizingOptions.packing.organizers} organizers • Supplies included
                          </p>
                        )}
                      </CardHeader>
                      
                      {(packingExpanded || bookingData.include_packing) && (
                        <CardContent>
                          <p className="text-sm text-navy-600 mb-4">{organizingOptions.packing.description}</p>
                          
                          <div className="space-y-2 text-sm">
                            <div className="flex justify-between">
                              <span className="text-navy-700">Duration:</span>
                              <span className="font-medium text-navy-900">{organizingOptions.packing.duration} hours</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-navy-700">Organizers:</span>
                              <span className="font-medium text-navy-900">{organizingOptions.packing.organizers} professionals</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-navy-700">Supplies:</span>
                              <span className="font-medium text-navy-900">${organizingOptions.packing.supplies} allowance</span>
                            </div>
                          </div>
                          
                          <div className="mt-4 pt-3 border-t border-gray-100">
                            {(() => {
                              const pricing = calculateWithTax(organizingOptions.packing.price);
                              return (
                                <div className="space-y-1">
                                  <div className="flex justify-between text-sm text-navy-900">
                                    <span>Service:</span>
                                    <span className="font-medium">${pricing.subtotal.toFixed(2)}</span>
                                  </div>
                                  <div className="flex justify-between text-sm text-navy-900">
                                    <span>Tax:</span>
                                    <span className="font-medium">${pricing.tax.toFixed(2)}</span>
                                  </div>
                                  <div className="flex justify-between font-bold text-navy-900 text-base">
                                    <span>Total:</span>
                                    <span>${pricing.total.toFixed(2)}</span>
                                  </div>
                                </div>
                              );
                            })()}
                          </div>
                        </CardContent>
                      )}
                    </Card>

                    <Card 
                      variant={bookingData.include_unpacking ? "luxury" : "default"}
                      className="transition-all"
                    >
                      <CardHeader>
                        <div className="flex items-center justify-between">
                          <div className="flex items-center space-x-3">
                            <input
                              type="checkbox"
                              checked={bookingData.include_unpacking || false}
                              onChange={(e) => handleOrganizingServiceToggle('unpacking', e.target.checked)}
                              className="h-4 w-4 text-navy-600 rounded"
                            />
                            <h5 className="font-semibold text-navy-900">{organizingOptions.unpacking.name}</h5>
                          </div>
                          <button
                            onClick={() => setUnpackingExpanded(!unpackingExpanded)}
                            className="text-navy-600 hover:text-navy-900"
                          >
                            {unpackingExpanded || bookingData.include_unpacking ? (
                              <ChevronUpIcon className="h-5 w-5" />
                            ) : (
                              <ChevronDownIcon className="h-5 w-5" />
                            )}
                          </button>
                        </div>
                        
                        {!unpackingExpanded && !bookingData.include_unpacking && (
                          <p className="text-sm text-navy-600 mt-2">
                            {organizingOptions.unpacking.duration} hours • {organizingOptions.unpacking.organizers} organizers • Organizing only
                          </p>
                        )}
                      </CardHeader>
                      
                      {(unpackingExpanded || bookingData.include_unpacking) && (
                        <CardContent>
                          <p className="text-sm text-navy-600 mb-4">{organizingOptions.unpacking.description}</p>
                          
                          <div className="space-y-2 text-sm">
                            <div className="flex justify-between">
                              <span className="text-navy-700">Duration:</span>
                              <span className="font-medium text-navy-900">{organizingOptions.unpacking.duration} hours</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-navy-700">Organizers:</span>
                              <span className="font-medium text-navy-900">{organizingOptions.unpacking.organizers} professionals</span>
                            </div>
                            <div className="flex justify-between">
                              <span className="text-navy-700">Supplies:</span>
                              <span className="font-medium text-navy-900">Organizing only</span>
                            </div>
                          </div>
                          
                          <div className="mt-4 pt-3 border-t border-gray-100">
                            {(() => {
                              const pricing = calculateWithTax(organizingOptions.unpacking.price);
                              return (
                                <div className="space-y-1">
                                  <div className="flex justify-between text-sm text-navy-900">
                                    <span>Service:</span>
                                    <span className="font-medium">${pricing.subtotal.toFixed(2)}</span>
                                  </div>
                                  <div className="flex justify-between text-sm text-navy-900">
                                    <span>Tax:</span>
                                    <span className="font-medium">${pricing.tax.toFixed(2)}</span>
                                  </div>
                                  <div className="flex justify-between font-bold text-navy-900 text-base">
                                    <span>Total:</span>
                                    <span>${pricing.total.toFixed(2)}</span>
                                  </div>
                                </div>
                              );
                            })()}
                          </div>
                        </CardContent>
                      )}
                    </Card>
                  </div>
                );
              })()}
            </div>
          )}
        </div>
      )}

      {bookingData.service_type === 'standard_delivery' && services?.standard_delivery && (
        <div className="space-y-6">
          <h3 className="text-lg font-medium text-navy-900 mb-4">Configure Your Delivery</h3>
          
          <Card variant="elevated">
            <CardHeader>
              <h4 className="font-medium text-navy-900">Regular Items (Optional)</h4>
            </CardHeader>
            <CardContent>
              <Input
                label="Number of Items"
                type="number"
                min={0}
                value={bookingData.standard_delivery_item_count?.toString() || '0'}
                onChange={(e) => {
                  const value = e.target.value;
                  if (value === '') {
                    updateBookingData({ standard_delivery_item_count: 0 });
                  } else {
                    const numValue = parseInt(value, 10);
                    if (!isNaN(numValue) && numValue >= 0) {
                      updateBookingData({ standard_delivery_item_count: numValue });
                    }
                  }
                }}
                placeholder="Enter 0 if booking specialty items only"
                helper={`$${services.standard_delivery.price_per_item_dollars} per item (under 50 lbs) • $${services.standard_delivery.minimum_charge_dollars} minimum applies to 1-3 items`}
              />
              
              <div className="mt-3 bg-gold-50 border border-gold-200 rounded-lg p-3">
                <p className="text-sm text-gold-800">
                  <strong>Note:</strong> Standard pricing applies to items under 50 lbs each. 
                  Overweight items may incur additional charges.
                </p>
              </div>
            </CardContent>
          </Card>

          {/* ✅ NEW: Specialty Items with Quantity Steppers */}
          <Card variant="elevated">
            <CardHeader>
              <h4 className="font-medium text-navy-900">Specialty Items (Optional)</h4>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                {services.specialty_items.map((item) => {
                  const quantity = getSpecialtyItemQuantity(item.id);
                  const isSelected = quantity > 0;
                  
                  return (
                    <div 
                      key={item.id}
                      data-specialty-item-id={item.id}  // ✅ ADD THIS LINE
                      className={`p-4 border rounded-lg transition-all ${
                        isSelected 
                          ? 'border-navy-500 bg-navy-50' 
                          : 'border-gray-200 hover:bg-gray-50'
                      }`}
                    >
                      <div className="flex items-center justify-between">
                        <div className="flex-1">
                          <div className="font-medium text-navy-900">{item.name}</div>
                          <div className="text-sm text-navy-600">{item.description}</div>
                          <div className="text-lg font-bold text-navy-900 mt-1">
                            ${item.price_dollars} each
                          </div>
                        </div>
                        
                        {/* ✅ Quantity Stepper */}
                        <div className="flex items-center space-x-3 ml-4">
                          <button
                            onClick={() => handleQuantityChange(item.id, -1)}
                            disabled={quantity === 0}
                            className={`p-2 rounded-lg border transition-all ${
                              quantity === 0
                                ? 'border-gray-200 text-gray-400 cursor-not-allowed'
                                : 'border-navy-500 text-navy-600 hover:bg-navy-50'
                            }`}
                          >
                            <MinusIcon className="h-4 w-4" />
                          </button>
                          
                          <span className="text-lg font-bold text-navy-900 w-8 text-center">
                            {quantity}
                          </span>
                          
                          <button
                            onClick={() => handleQuantityChange(item.id, 1)}
                            className="p-2 rounded-lg border border-navy-500 text-navy-600 hover:bg-navy-50 transition-all"
                          >
                            <PlusIcon className="h-4 w-4" />
                          </button>
                        </div>
                      </div>
                      
                      {/* ✅ Show subtotal if quantity > 0 */}
                      {quantity > 0 && (
                        <div className="mt-3 pt-3 border-t border-gray-200">
                          <div className="flex justify-between text-sm">
                            <span className="text-navy-700">Subtotal:</span>
                            <span className="font-bold text-navy-900">
                              ${(item.price_dollars * quantity).toFixed(2)}
                            </span>
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
              
              <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p className="text-sm text-blue-800">
                  <strong>Item not listed?</strong> Contact us for a custom quote: <strong>(631) 595-5100</strong>
                </p>
              </div>
            </CardContent>
          </Card>

          <Card variant="default">
            <CardContent>
              <label className="flex items-center">
                <input
                  type="checkbox"
                  checked={bookingData.is_same_day_delivery || false}
                  onChange={(e) => updateBookingData({ is_same_day_delivery: e.target.checked })}
                  className="mr-3"
                />
                <span className="text-navy-900 font-medium">
                  Same-Day Delivery (+$360)
                </span>
              </label>
            </CardContent>
          </Card>

          <Card variant="default">
            <CardContent>
              <label className="flex items-center">
                <input
                  type="checkbox"
                  checked={bookingData.coi_required || false}
                  onChange={(e) => updateBookingData({ coi_required: e.target.checked })}
                  className="mr-3 h-4 w-4"
                />
                <div>
                  <span className="font-medium text-navy-900">
                    Certificate of Insurance (COI) Required
                    <span className="text-orange-600 ml-2">(+$50)</span>
                  </span>
                  <p className="text-sm text-navy-600">
                    Required by some buildings. We'll handle the paperwork for you.
                  </p>
                </div>
              </label>
            </CardContent>
          </Card>
          {((bookingData.standard_delivery_item_count || 0) === 0 && 
            !(bookingData.specialty_items ?? []).some(item => item.quantity > 0)) && ( // ✅ FIXED
            <div className="bg-red-50 border border-red-200 rounded-lg p-4">
              <p className="text-sm text-red-800 font-medium">
                Please select at least one regular item or specialty item to continue.
              </p>
            </div>
          )}
        </div> 
      )}

      {bookingData.service_type === 'blade_transfer' && (
        <div className="space-y-6">
          <h3 className="text-lg font-medium text-navy-900 mb-4">Flight Details</h3>
          
          <Card variant="elevated">
            <CardHeader>
              <h4 className="font-medium text-navy-900">Airport Selection</h4>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-2 gap-4">
                <button
                  onClick={() => updateBookingData({ blade_airport: 'JFK' })}
                  className={`p-4 rounded-lg border-2 text-center transition-all ${
                    bookingData.blade_airport === 'JFK'
                      ? 'border-navy-500 bg-navy-50'
                      : 'border-gray-200 hover:border-gray-300'
                  }`}
                >
                  <div className="font-medium text-navy-900">JFK</div>
                  <div className="text-sm text-navy-600">John F. Kennedy</div>
                </button>
                
                <button
                  onClick={() => updateBookingData({ blade_airport: 'EWR' })}
                  className={`p-4 rounded-lg border-2 text-center transition-all ${
                    bookingData.blade_airport === 'EWR'
                      ? 'border-navy-500 bg-navy-50'
                      : 'border-gray-200 hover:border-gray-300'
                  }`}
                >
                  <div className="font-medium text-navy-900">EWR</div>
                  <div className="text-sm text-navy-600">Newark Liberty</div>
                </button>
              </div>
            </CardContent>
          </Card>

          <Card variant="elevated">
            <CardHeader>
              <h4 className="font-medium text-navy-900">Flight Information</h4>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <Input
                  label="Flight Date"
                  type="date"
                  value={bookingData.blade_flight_date || ''}
                  onChange={(e) => {
                    setDateError('');
                    updateBookingData({ blade_flight_date: e.target.value });
                  }}
                  min={(() => {
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    return tomorrow.toISOString().split('T')[0];
                  })()}
                  error={dateError}
                  helper={!dateError ? "Select your flight date (must be tomorrow or call us)" : undefined}
                  required
                />
                
                <Input
                  label="Flight Departure Time"
                  type="time"
                  value={bookingData.blade_flight_time || ''}
                  onChange={(e) => {
                    setTimeError('');
                    updateBookingData({ blade_flight_time: e.target.value });
                  }}
                  error={timeError}
                  helper={!timeError ? "Select your departure time" : undefined}
                  required
                />
                
                {bookingData.blade_flight_time && !timeError && (
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p className="text-sm text-blue-800">
                      <strong>Bags Ready Time:</strong> Your bags must be ready for pickup by{' '}
                      {parseInt(bookingData.blade_flight_time.split(':')[0]) < 13 ? '5:00 AM' : '10:00 AM'}
                    </p>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>

          <Card variant="elevated">
            <CardHeader>
              <h4 className="font-medium text-navy-900">Number of Bags</h4>
            </CardHeader>
            <CardContent>
              <Input
                label="Bag Count"
                type="number"
                min={2}
                value={bookingData.blade_bag_count?.toString() || ''}
                onChange={(e) => {
                  const value = parseInt(e.target.value, 10);
                  if (!isNaN(value) && value >= 0) {
                    updateBookingData({ blade_bag_count: value });
                  }
                }}
                placeholder="Enter number of bags"
                helper="$75 per bag • $150 minimum for up to 2 bags"
              />
              
              {bookingData.blade_bag_count && bookingData.blade_bag_count < 2 && (
                <div className="mt-3 bg-red-50 border border-red-200 rounded-lg p-3">
                  <p className="text-sm text-red-800 font-medium">
                    Airport transfer service requires a minimum of 2 bags
                  </p>
                </div>
              )}
              
              {bookingData.blade_bag_count && bookingData.blade_bag_count >= 2 && (
                <div className="mt-3 bg-green-50 border border-green-200 rounded-lg p-3">
                  <p className="text-sm text-green-800">
                    <strong>Estimated Price:</strong> ${Math.max(bookingData.blade_bag_count * 75, 150)}
                  </p>
                </div>
              )}
            </CardContent>
          </Card>

          <Card variant="default">
            <CardContent>
              <div className="space-y-3">
                <p className="text-sm font-medium text-navy-900">Important Information:</p>
                <ul className="text-sm text-navy-700 space-y-2">
                  <li>• NYC to airport only (one-way service)</li>
                  <li>• Book by 8:00 PM the night before your flight</li>
                  <li>• 2-bag minimum required</li>
                  <li>• Overweight bags (over 50 lbs): $100 per bag upon pickup</li>
                  <li>• Wait time over 10 minutes: $50 per 30 minutes</li>
                </ul>
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      <div className="flex justify-end pt-4">
        <Button
          onClick={handleContinue}
          disabled={!canContinue()}
          size="lg"
        >
          Continue to Date & Time →
        </Button>
      </div>
    </div>
  );
}
```

# ──── frontend/src/components/dashboard/booking-history.tsx ────

```tsx
// frontend/src/components/dashboard/booking-history.tsx
'use client';

import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { useRouter } from 'next/navigation';
import { apiClient } from '@/lib/api-client';
import { useAuthStore } from '@/stores/auth-store';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Select } from '@/components/ui/select';

interface Booking {
  id: string;
  booking_number: string;
  service_type: string;
  status: string;
  pickup_date: string;
  pickup_time?: string;
  pickup_address?: {
    address_line_1: string;
    city: string;
    state: string;
  };
  delivery_address?: {
    address_line_1: string;
    city: string;
    state: string;
  };
  total_price: number;
  created_at: string;
}

interface BookingHistoryResponse {
  bookings: Booking[];
  total_count: number;
}

export function BookingHistory() {
  const { user } = useAuthStore();
  const router = useRouter();
  const [searchTerm, setSearchTerm] = useState('');
  const [statusFilter, setStatusFilter] = useState('');

  const { data, isLoading, error, refetch } = useQuery({
    queryKey: ['customer', 'bookings', user?.id, searchTerm, statusFilter],
    queryFn: async (): Promise<BookingHistoryResponse> => {
      const params = new URLSearchParams();
      if (searchTerm) params.append('search', searchTerm);
      if (statusFilter) params.append('status', statusFilter);
      
      const response = await apiClient.get(`/api/customer/bookings/?${params}`);
      return response.data;
    },
    enabled: !!user?.id,
  });

  const getStatusColor = (status: string) => {
    switch (status.toLowerCase()) {
      case 'completed':
        return 'bg-green-100 text-green-800';
      case 'confirmed':
        return 'bg-blue-100 text-blue-800';
      case 'pending':
        return 'bg-yellow-100 text-yellow-800';
      case 'cancelled':
        return 'bg-red-100 text-red-800';
      default:
        return 'bg-gray-100 text-gray-800';
    }
  };

  const formatAddress = (address?: Booking['pickup_address']) => {
    if (!address) return 'Address not available';
    return `${address.address_line_1}, ${address.city}, ${address.state}`;
  };

  if (isLoading) {
    return (
      <Card>
        <CardHeader>
          <h2 className="text-xl font-semibold">Booking History</h2>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            {[...Array(3)].map((_, i) => (
              <div key={i} className="animate-pulse border border-gray-200 rounded-lg p-4">
                <div className="h-4 bg-gray-200 rounded mb-2"></div>
                <div className="h-3 bg-gray-200 rounded w-1/2"></div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    );
  }

  if (error) {
    return (
      <Card>
        <CardContent className="p-6 text-center">
          <p className="text-red-600 mb-4">Failed to load booking history</p>
          <Button variant="outline" onClick={() => refetch()}>
            Retry
          </Button>
        </CardContent>
      </Card>
    );
  }

  return (
    <Card>
      <CardHeader>
        <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
          <h2 className="text-xl font-semibold text-navy-900">Booking History</h2>
          <div className="text-sm text-navy-600">
            {data?.total_count || 0} total bookings
          </div>
        </div>

        <div className="flex flex-col sm:flex-row gap-4 mt-4">
          <div className="flex-1">
            <Input
              placeholder="Search bookings..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
            />
          </div>
          <Select
            value={statusFilter}
            onChange={(e) => setStatusFilter(e.target.value)}
            options={[
              { value: '', label: 'All Status' },
              { value: 'pending', label: 'Pending' },
              { value: 'confirmed', label: 'Confirmed' },
              { value: 'completed', label: 'Completed' },
              { value: 'cancelled', label: 'Cancelled' },
            ]}
          />
        </div>
      </CardHeader>

      <CardContent>
        {!data?.bookings || data.bookings.length === 0 ? (
          <div className="text-center py-8">
            <div className="text-6xl mb-4">📦</div>
            <h3 className="text-lg font-medium text-navy-900 mb-2">No bookings yet</h3>
            <p className="text-navy-600 mb-4">
              Start your ToteTaxi experience by booking your first move
            </p>
            <Button 
              variant="primary"
              onClick={() => router.push('/book')}
            >
              Book Your First Move
            </Button>
          </div>
        ) : (
          <div className="space-y-4">
            {data.bookings.map((booking) => (
              <div
                key={booking.id}
                className="border border-cream-200 rounded-lg p-6 hover:shadow-md transition-shadow"
              >
                <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                  <div className="flex-1">
                    <div className="flex items-center gap-4 mb-3">
                      <h3 className="font-semibold text-navy-900">
                        #{booking.booking_number}
                      </h3>
                      <span className={`px-2 py-1 rounded-full text-xs font-medium ${getStatusColor(booking.status)}`}>
                        {booking.status}
                      </span>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                      <div>
                        <p className="font-medium text-navy-700">Service</p>
                        <p className="text-navy-600">{booking.service_type}</p>
                      </div>
                      <div>
                        <p className="font-medium text-navy-700">Date & Time</p>
                        <p className="text-navy-600">
                          {new Date(booking.pickup_date + 'T00:00:00').toLocaleDateString()}
                          {booking.pickup_time && ` - ${booking.pickup_time}`}
                        </p>
                      </div>
                      {booking.pickup_address && (
                        <div>
                          <p className="font-medium text-navy-700">From</p>
                          <p className="text-navy-600">{formatAddress(booking.pickup_address)}</p>
                        </div>
                      )}
                      {booking.delivery_address && (
                        <div>
                          <p className="font-medium text-navy-700">To</p>
                          <p className="text-navy-600">{formatAddress(booking.delivery_address)}</p>
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="text-right">
                    <div className="text-2xl font-bold text-navy-900 mb-2">
                      ${booking.total_price}
                    </div>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => router.push(`/dashboard/bookings/${booking.id}`)}
                    >
                      View Details
                    </Button>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```

# ──── frontend/src/components/dashboard/dashboard-overview.tsx ────

```tsx
'use client';

import { useQuery } from '@tanstack/react-query';
import { apiClient } from '@/lib/api-client';
import { useAuthStore } from '@/stores/auth-store';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';
import { 
  CalendarIcon, 
  CheckCircleIcon,
  UserCircleIcon,
  ChevronRightIcon 
} from '@heroicons/react/24/outline';

interface DashboardData {
  customer_profile: {
    name: string;
    email: string;
    phone: string;
    is_vip: boolean;
    total_bookings: number;
    total_spent_dollars: number;
    last_booking_at: string | null;
  };
  booking_summary: {
    pending_bookings: number;
    completed_bookings: number;
    total_bookings: number;
  };
  recent_bookings: Array<{
    id: string;
    booking_number: string;
    customer_name: string;
    service_type: string;
    status: string;
    pickup_date: string;
    pickup_time: string;
    total_price_dollars: number;
    can_rebook: boolean;
    created_at: string;
  }>;
  saved_addresses_count: number;
  payment_methods_count: number;
}

export function DashboardOverview() {
  const { user } = useAuthStore();
  const router = useRouter();

  const { data: dashboardData, isLoading, error, refetch } = useQuery({
    queryKey: ['customer', 'dashboard', user?.id],
    queryFn: async (): Promise<DashboardData> => {
      const response = await apiClient.get('/api/customer/dashboard/');
      return response.data;
    },
    enabled: !!user?.id,
    staleTime: 1000 * 60 * 5,
    gcTime: 1000 * 60 * 10,
  });

  if (isLoading) {
    return (
      <div className="space-y-6">
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
          {[...Array(3)].map((_, i) => (
            <Card key={i} className="animate-pulse">
              <CardContent className="p-6">
                <div className="h-4 bg-gray-200 rounded mb-2"></div>
                <div className="h-8 bg-gray-200 rounded"></div>
              </CardContent>
            </Card>
          ))}
        </div>
      </div>
    );
  }

  if (error) {
    return (
      <Card>
        <CardContent className="p-6 text-center">
          <p className="text-red-600 mb-4">Failed to load dashboard</p>
          <Button variant="outline" onClick={() => refetch()}>
            Retry
          </Button>
        </CardContent>
      </Card>
    );
  }

  const profile = dashboardData?.customer_profile;
  const bookingSummary = dashboardData?.booking_summary;
  const recentBookings = dashboardData?.recent_bookings || [];

  return (
    <div className="space-y-6">
      {/* Key Stats - Clean 3-column */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        {/* Total Bookings */}
        <Card className="hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between mb-2">
              <CalendarIcon className="h-5 w-5 text-navy-500" />
              <span className="text-3xl font-bold text-navy-900">
                {bookingSummary?.total_bookings || 0}
              </span>
            </div>
            <p className="text-sm font-medium text-navy-600">Total Bookings</p>
            {profile?.last_booking_at && (
              <p className="text-xs text-navy-500 mt-1">
                Last: {new Date(profile.last_booking_at).toLocaleDateString()}
              </p>
            )}
          </CardContent>
        </Card>

        {/* Upcoming */}
        <Card className="hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between mb-2">
              <CheckCircleIcon className="h-5 w-5 text-blue-500" />
              <span className="text-3xl font-bold text-navy-900">
                {bookingSummary?.pending_bookings || 0}
              </span>
            </div>
            <p className="text-sm font-medium text-navy-600">Upcoming</p>
            <p className="text-xs text-navy-500 mt-1">
              {bookingSummary?.completed_bookings || 0} completed
            </p>
          </CardContent>
        </Card>

        {/* Account Status */}
        <Card className="hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between mb-2">
              <UserCircleIcon className="h-5 w-5 text-gold-500" />
              {profile?.is_vip ? (
                <span className="px-3 py-1 bg-gold-100 text-gold-800 rounded-full text-xs font-semibold">
                  VIP
                </span>
              ) : (
                <span className="px-3 py-1 bg-navy-100 text-navy-800 rounded-full text-xs font-semibold">
                  Standard
                </span>
              )}
            </div>
            <p className="text-sm font-medium text-navy-600">Account Status</p>
            <p className="text-xs text-navy-500 mt-1">
              {profile?.is_vip
                ? 'Priority access'
                : `${Math.max(0, 3 - (bookingSummary?.total_bookings || 0))} more for VIP`
              }
            </p>
          </CardContent>
        </Card>
      </div>

      {/* Recent Bookings */}
      {recentBookings.length > 0 && (
        <Card>
          <CardHeader className="flex flex-row items-center justify-between pb-3">
            <h3 className="text-lg font-semibold text-navy-900">Recent Bookings</h3>
            <Button 
              variant="ghost" 
              size="sm"
              onClick={() => router.push('/dashboard/bookings')}
              className="text-navy-600 hover:text-navy-900"
            >
              View All
              <ChevronRightIcon className="h-4 w-4 ml-1" />
            </Button>
          </CardHeader>
          <CardContent className="space-y-3">
            {recentBookings.slice(0, 3).map((booking) => (
              <div 
                key={booking.id} 
                className="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:border-navy-300 hover:shadow-sm transition-all cursor-pointer"
                onClick={() => router.push(`/dashboard/bookings/${booking.id}`)}
              >
                <div className="flex-1">
                  <div className="flex items-center gap-3 mb-1">
                    <p className="font-semibold text-navy-900">
                      #{booking.booking_number}
                    </p>
                    <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${
                      booking.status === 'completed' 
                        ? 'bg-green-100 text-green-700'
                        : booking.status === 'pending'
                        ? 'bg-yellow-100 text-yellow-700' 
                        : 'bg-blue-100 text-blue-700'
                    }`}>
                      {booking.status}
                    </span>
                  </div>
                  <p className="text-sm text-navy-600">{booking.service_type}</p>
                  <p className="text-xs text-navy-500 mt-1">
                    {new Date(booking.pickup_date + 'T00:00:00').toLocaleDateString()}
                  </p>
                </div>
                <div className="text-right">
                  <p className="text-lg font-bold text-navy-900">
                    ${booking.total_price_dollars}
                  </p>
                </div>
              </div>
            ))}
          </CardContent>
        </Card>
      )}

      {/* Empty State */}
      {recentBookings.length === 0 && (
        <Card>
          <CardContent className="p-12 text-center">
            <div className="text-6xl mb-4">📦</div>
            <h3 className="text-xl font-semibold text-navy-900 mb-2">
              No bookings yet
            </h3>
            <p className="text-navy-600 mb-6">
              Ready to experience luxury moving?
            </p>
            <Button 
              variant="primary" 
              size="lg"
              onClick={() => router.push('/book')}
            >
              Book Your First Move
            </Button>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
```

# ──── frontend/src/components/dashboard/delivery-tracking.tsx ────

```tsx
'use client';

import { OnfleetTask } from '@/types';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';

interface DeliveryTrackingProps {
  bookingStatus: string;
  onfleetTasks: OnfleetTask[];
}

export function DeliveryTracking({ bookingStatus, onfleetTasks }: DeliveryTrackingProps) {
  // Find pickup and dropoff tasks
  const pickupTask = onfleetTasks.find(task => task.task_type === 'pickup');
  const dropoffTask = onfleetTasks.find(task => task.task_type === 'dropoff');
  
  // Determine overall delivery status
  const getDeliveryStatus = () => {
    if (bookingStatus === 'completed') {
      return { label: '✅ Delivered', color: 'bg-green-100 text-green-800' };
    }
    
    if (dropoffTask?.status === 'active') {
      return { label: '🚚 Out for Delivery', color: 'bg-blue-100 text-blue-800' };
    }
    
    if (dropoffTask?.status === 'assigned' || pickupTask?.status === 'active') {
      return { label: '📦 Driver En Route', color: 'bg-purple-100 text-purple-800' };
    }
    
    if (bookingStatus === 'paid' || bookingStatus === 'confirmed') {
      return { label: '⏳ Awaiting Driver Assignment', color: 'bg-amber-100 text-amber-800' };
    }
    
    return { label: '📋 Pending', color: 'bg-gray-100 text-gray-800' };
  };
  
  const status = getDeliveryStatus();
  
  // If no tasks exist yet, show simple status
  if (!pickupTask && !dropoffTask) {
    return (
      <Card>
        <CardHeader>
          <h3 className="text-lg font-medium text-navy-900">🚚 Delivery Status</h3>
        </CardHeader>
        <CardContent>
          <div className="text-center py-6">
            <div className={`inline-flex items-center px-4 py-2 rounded-full text-sm font-medium ${status.color} mb-4`}>
              {status.label}
            </div>
            <p className="text-navy-600 text-sm">
              Delivery tracking will be available once your booking is confirmed.
            </p>
          </div>
        </CardContent>
      </Card>
    );
  }
  
  return (
    <Card>
      <CardHeader>
        <div className="flex justify-between items-center">
          <h3 className="text-lg font-medium text-navy-900">🚚 Delivery Tracking</h3>
          <span className={`px-3 py-1.5 rounded-full text-sm font-medium ${status.color}`}>
            {status.label}
          </span>
        </div>
      </CardHeader>
      <CardContent className="space-y-4">
        
        {/* Tracking Links */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
          {pickupTask && (
            <div className="border border-gray-200 rounded-lg p-4 space-y-2">
              <div className="flex items-center justify-between">
                <span className="text-sm font-medium text-navy-900">📦 Pickup</span>
                <TaskStatusBadge status={pickupTask.status} />
              </div>
              
              {pickupTask.worker_name && (
                <p className="text-xs text-navy-600">
                  Driver: {pickupTask.worker_name}
                </p>
              )}
              
              <Button
                variant="primary"
                size="sm"
                className="w-full"
                onClick={() => window.open(pickupTask.tracking_url, '_blank')}
              >
                Track Pickup →
              </Button>
            </div>
          )}
          
          {dropoffTask && (
            <div className="border border-gray-200 rounded-lg p-4 space-y-2">
              <div className="flex items-center justify-between">
                <span className="text-sm font-medium text-navy-900">🚚 Delivery</span>
                <TaskStatusBadge status={dropoffTask.status} />
              </div>
              
              {dropoffTask.worker_name && (
                <p className="text-xs text-navy-600">
                  Driver: {dropoffTask.worker_name}
                </p>
              )}
              
              <Button
                variant="primary"
                size="sm"
                className="w-full"
                onClick={() => window.open(dropoffTask.tracking_url, '_blank')}
              >
                Track Delivery →
              </Button>
            </div>
          )}
        </div>
        
        {/* Completion Info */}
        {bookingStatus === 'completed' && dropoffTask?.completed_at && (
          <div className="bg-green-50 border border-green-200 rounded-lg p-4">
            <p className="text-sm font-medium text-green-900 mb-1">
              ✅ Delivery Complete
            </p>
            <p className="text-xs text-green-700">
              Delivered on {new Date(dropoffTask.completed_at).toLocaleDateString()} at{' '}
              {new Date(dropoffTask.completed_at).toLocaleTimeString()}
            </p>
            {dropoffTask.worker_name && (
              <p className="text-xs text-green-700 mt-1">
                By: {dropoffTask.worker_name}
              </p>
            )}
          </div>
        )}
        
        {/* SMS Notification Info */}
        <div className="text-xs text-navy-600 bg-navy-50 rounded p-3">
          <p className="font-medium mb-1">📱 SMS Notifications:</p>
          <p>You'll receive text updates when your driver starts pickup and delivery.</p>
        </div>
        
      </CardContent>
    </Card>
  );
}

// Helper component for status badges
function TaskStatusBadge({ status }: { status: string }) {
  const statusConfig: Record<string, { label: string; color: string }> = {
    created: { label: 'Unassigned', color: 'bg-gray-100 text-gray-700' },
    assigned: { label: 'Assigned', color: 'bg-blue-100 text-blue-700' },
    active: { label: 'En Route', color: 'bg-purple-100 text-purple-700' },
    completed: { label: 'Complete', color: 'bg-green-100 text-green-700' },
    failed: { label: 'Failed', color: 'bg-red-100 text-red-700' },
    deleted: { label: 'Cancelled', color: 'bg-gray-100 text-gray-700' },
  };
  
  const config = statusConfig[status] || statusConfig.created;
  
  return (
    <span className={`px-2 py-0.5 rounded text-xs font-medium ${config.color}`}>
      {config.label}
    </span>
  );
}
```

# ──── frontend/src/components/dashboard/index.ts ────

```typescript
export { DashboardOverview } from './dashboard-overview';
export { BookingHistory } from './booking-history';
export { DeliveryTracking } from './delivery-tracking';
```

# ──── frontend/src/components/layout/main-layout.tsx ────

```tsx
// frontend/src/components/layout/main-layout.tsx
'use client';

import { cn } from '@/utils/cn';
import Link from 'next/link';
import Image from 'next/image';
import { Button } from '@/components/ui/button';
import { UserMenu } from '@/components/auth/user-menu';
import { useAuthStore } from '@/stores/auth-store';
import { useState } from 'react';
import { Bars3Icon, XMarkIcon } from '@heroicons/react/24/outline';

interface MainLayoutProps {
  children: React.ReactNode;
  className?: string;
  onBookNowClick?: () => void;
}

export function MainLayout({ children, className, onBookNowClick }: MainLayoutProps) {
  const { isAuthenticated, user } = useAuthStore();
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

  return (
    <div className={cn(
      'min-h-screen bg-gradient-to-br from-cream-50 to-cream-100',
      className
    )}>
      {/* Header */}
      <header className="border-b border-cream-200 bg-white/80 backdrop-blur-sm sticky top-0 z-40">
        <div className="container mx-auto px-4 py-4">
          <div className="flex items-center justify-between">
            {/* Logo */}
            <Link href="/" className="hover:opacity-80 transition-opacity">
              <Image
                src="/assets/images/totetaxilogo.png"
                alt="Tote Taxi"
                width={180}
                height={86}
                priority
                className="h-auto w-[120px] md:w-[180px]"
              />
            </Link>
            
            {/* Desktop Navigation */}
            <nav className="hidden lg:flex items-center space-x-8">
              <Link href="/services" className="text-navy-700 hover:text-navy-900 transition-colors font-medium">
                Services
              </Link>
              <Link href="/about" className="text-navy-700 hover:text-navy-900 transition-colors font-medium">
                About
              </Link>
              <Link href="/press" className="text-navy-700 hover:text-navy-900 transition-colors font-medium">
                Press
              </Link>
              <Link href="/partnerships" className="text-navy-700 hover:text-navy-900 transition-colors font-medium">
                Partnerships
              </Link>
              <Link href="/faq" className="text-navy-700 hover:text-navy-900 transition-colors font-medium">
                FAQ
              </Link>
              <Link href="/contact" className="text-navy-700 hover:text-navy-900 transition-colors font-medium">
                Contact
              </Link>
              
              {/* Auth-Aware Navigation */}
              {isAuthenticated ? (
                <div className="flex items-center space-x-4">
                  <Link href="/dashboard" className="text-navy-700 hover:text-navy-900 transition-colors font-medium">
                    Dashboard
                  </Link>
                  <UserMenu />
                </div>
              ) : (
                <div className="flex items-center space-x-4">
                  <Link href="/login">
                    <Button variant="ghost">
                      Sign In
                    </Button>
                  </Link>
                  {onBookNowClick ? (
                    <Button variant="primary" onClick={onBookNowClick}>
                      Book Now
                    </Button>
                  ) : (
                    <Link href="/book">
                      <Button variant="primary">
                        Book Now
                      </Button>
                    </Link>
                  )}
                </div>
              )}
            </nav>

            {/* Mobile Menu Button */}
            <div className="lg:hidden">
              <button
                onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
                className="text-navy-700 hover:text-navy-900"
              >
                {mobileMenuOpen ? (
                  <XMarkIcon className="h-6 w-6" />
                ) : (
                  <Bars3Icon className="h-6 w-6" />
                )}
              </button>
            </div>
          </div>

          {/* Mobile Menu */}
          {mobileMenuOpen && (
            <div className="lg:hidden mt-4 pb-4 border-t border-cream-200">
              <nav className="flex flex-col space-y-4 mt-4">
                <Link 
                  href="/services" 
                  className="text-navy-700 hover:text-navy-900 transition-colors font-medium"
                  onClick={() => setMobileMenuOpen(false)}
                >
                  Services
                </Link>
                <Link 
                  href="/about" 
                  className="text-navy-700 hover:text-navy-900 transition-colors font-medium"
                  onClick={() => setMobileMenuOpen(false)}
                >
                  About
                </Link>
                <Link 
                  href="/press" 
                  className="text-navy-700 hover:text-navy-900 transition-colors font-medium"
                  onClick={() => setMobileMenuOpen(false)}
                >
                  Press
                </Link>
                <Link 
                  href="/partnerships" 
                  className="text-navy-700 hover:text-navy-900 transition-colors font-medium"
                  onClick={() => setMobileMenuOpen(false)}
                >
                  Partnerships
                </Link>
                <Link 
                  href="/faq" 
                  className="text-navy-700 hover:text-navy-900 transition-colors font-medium"
                  onClick={() => setMobileMenuOpen(false)}
                >
                  FAQ
                </Link>
                <Link 
                  href="/contact" 
                  className="text-navy-700 hover:text-navy-900 transition-colors font-medium"
                  onClick={() => setMobileMenuOpen(false)}
                >
                  Contact
                </Link>
                
                {/* Mobile Auth Section */}
                {isAuthenticated ? (
                  <>
                    <Link 
                      href="/dashboard" 
                      className="text-navy-700 hover:text-navy-900 transition-colors font-medium"
                      onClick={() => setMobileMenuOpen(false)}
                    >
                      Dashboard
                    </Link>
                    <UserMenu variant="mobile" />
                  </>
                ) : (
                  <div className="flex flex-col space-y-2 pt-4 border-t border-cream-200">
                    <Link href="/login" onClick={() => setMobileMenuOpen(false)}>
                      <Button variant="ghost" className="w-full justify-start">
                        Sign In
                      </Button>
                    </Link>
                    <Link href="/register" onClick={() => setMobileMenuOpen(false)}>
                      <Button variant="outline" className="w-full justify-start">
                        Create Account
                      </Button>
                    </Link>
                    {onBookNowClick ? (
                      <Button 
                        variant="primary" 
                        onClick={() => {
                          onBookNowClick();
                          setMobileMenuOpen(false);
                        }}
                        className="w-full"
                      >
                        Book Now
                      </Button>
                    ) : (
                      <Link href="/book" onClick={() => setMobileMenuOpen(false)}>
                        <Button variant="primary" className="w-full">
                          Book Now
                        </Button>
                      </Link>
                    )}
                  </div>
                )}
              </nav>
            </div>
          )}
        </div>
      </header>

      {/* Main content */}
      <main className="flex-1">
        {children}
      </main>

      {/* Footer */}
      <footer className="bg-navy-900 text-white py-12">
        <div className="container mx-auto px-4">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
            <div className="space-y-6">
              <div>
                <Link href="/" className="inline-block hover:opacity-80 transition-opacity">
                  <Image
                    src="/assets/images/totetaxi-logo-white.png"
                    alt="Tote Taxi"
                    width={120}
                    height={58}
                    className="h-auto w-[100px]"
                  />
                </Link>
                <p className="text-navy-300 text-sm mt-2">
                  Luxury delivery service for Manhattan to Hamptons transport
                </p>
              </div>

              <div className="border-t border-navy-700 pt-4">
                <a href="https://totecamps.com" target="_blank" rel="noopener noreferrer" className="inline-block hover:opacity-80 transition-opacity">
                  <Image
                    src="/assets/images/totecamps-logo-white.png"
                    alt="Tote Camps"
                    width={120}
                    height={58}
                    className="h-auto w-[100px]"
                  />
                </a>
                <p className="text-navy-300 text-sm mt-2">
                  Sleepaway Camp Baggage Transportation
                </p>
              </div>
            </div>
            <div>
              <h4 className="font-medium mb-4">Services</h4>
              <ul className="space-y-2 text-navy-300 text-sm">
                <li><Link href="/services#mini-moves" className="hover:text-white transition-colors">Mini Moves</Link></li>
                <li><Link href="/services#standard-delivery" className="hover:text-white transition-colors">Standard Delivery</Link></li>
                <li><Link href="/services#specialty-items" className="hover:text-white transition-colors">Specialty Items</Link></li>
                <li><Link href="/services#organizing" className="hover:text-white transition-colors">Organizing Services</Link></li>
              </ul>
            </div>
            <div>
              <h4 className="font-medium mb-4">Company</h4>
              <ul className="space-y-2 text-navy-300 text-sm">
                <li><Link href="/about" className="hover:text-white transition-colors">About Us</Link></li>
                <li><Link href="/press" className="hover:text-white transition-colors">Press</Link></li>
                <li><Link href="/partnerships" className="hover:text-white transition-colors">Partnerships</Link></li>
                <li><Link href="/faq" className="hover:text-white transition-colors">FAQ</Link></li>
                <li><Link href="/contact" className="hover:text-white transition-colors">Contact</Link></li>
                <li><a href="https://totecamps.com" target="_blank" rel="noopener noreferrer" className="hover:text-white transition-colors">Tote Camps</a></li>
              </ul>
            </div>
            <div>
              <h4 className="font-medium mb-4">Contact</h4>
              <div className="text-navy-300 text-sm space-y-1">
                <p>
                  <a href="tel:+16315955100" className="hover:text-white transition-colors">
                    (631) 595-5100
                  </a>
                </p>
                <p>
                  <a href="mailto:info@totetaxi.com" className="hover:text-white transition-colors">
                    info@totetaxi.com
                  </a>
                </p>
                <p>Manhattan to Hamptons</p>
              </div>
            </div>
          </div>
          <div className="border-t border-navy-800 mt-8 pt-8 text-center text-navy-400 text-sm">
            <p>&copy; 2024 Tote Taxi. All rights reserved. | Premium delivery service for discerning clients.</p>
          </div>
        </div>
      </footer>
    </div>
  );
}
```

# ──── frontend/src/components/marketing/hero-section.tsx ────

```tsx
// src/components/marketing/hero-section.tsx
'use client';

import { Button } from '@/components/ui/button';
import Link from 'next/link';

interface HeroSectionProps {
  onBookNowClick: () => void;
}

export function HeroSection({ onBookNowClick }: HeroSectionProps) {
  return (
    <section className="relative h-screen flex items-center justify-center overflow-hidden">
      {/* Responsive Background Image */}
      <picture className="absolute inset-0 w-full h-full">
        {/* Desktop - Large screens (1024px+) */}
        <source 
          media="(min-width: 1024px)" 
          srcSet="/assets/images/hero-large.webp" 
          type="image/webp" 
        />
        <source 
          media="(min-width: 1024px)" 
          srcSet="/assets/images/hero-large.jpg" 
          type="image/jpeg" 
        />
        
        {/* Tablet - Medium screens (768px - 1023px) */}
        <source 
          media="(min-width: 768px)" 
          srcSet="/assets/images/hero-medium.webp" 
          type="image/webp" 
        />
        <source 
          media="(min-width: 768px)" 
          srcSet="/assets/images/hero-medium.jpg" 
          type="image/jpeg" 
        />
        
        {/* Mobile - Small screens (< 768px) */}
        <source 
          srcSet="/assets/images/hero-small.webp" 
          type="image/webp" 
        />
        <source 
          srcSet="/assets/images/hero-small.jpg" 
          type="image/jpeg" 
        />
        
        {/* Fallback img tag */}
        <img 
          src="/assets/images/hero-large.jpg"
          alt="Tote Taxi luxury delivery service"
          className="w-full h-full object-cover object-center"
        />
      </picture>
      
      {/* Overlay */}
      <div className="absolute inset-0 bg-black/20" />
      
      {/* Content */}
      <div className="relative z-10 text-center text-white px-4">
        <h1 className="text-5xl md:text-6xl font-serif font-bold mb-6">
          Door-to-Door Delivery Service
        </h1>
        <p className="text-xl mb-4 max-w-3xl mx-auto">
          Tote Taxi will deliver your luggage to and from the city stress-free.
        </p>
        <p className="text-lg mb-8 max-w-2xl mx-auto">
          From suitcases to surfboards, Pelotons to pop-up props — we handle it all between 
          NYC, the Hamptons, South Florida, and all major airports.
        </p>
        <div className="flex flex-col sm:flex-row gap-4 justify-center">
          <Button variant="primary" size="lg" onClick={onBookNowClick}>
            Book Now
          </Button>
          <Link href="/services">
            <Button variant="outline" size="lg" className="bg-white/10 border-white text-white hover:bg-white hover:text-navy-900">
              View Services & Pricing
            </Button>
          </Link>
        </div>
      </div>
    </section>
  );
}
```

# ──── frontend/src/components/marketing/how-it-works-section.tsx ────

```tsx
// src/components/marketing/how-it-works-section.tsx
import Image from 'next/image';

export function HowItWorksSection() {
  return (
    <section className="py-16 bg-white">
      <div className="container mx-auto px-4">
        <h2 className="text-3xl font-serif font-bold text-navy-900 text-center mb-12">
          Same Day Delivery Made Stress-Free
        </h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
          {/* Step 1 - Pickup */}
          <div className="text-center">
            <div className="mb-6 flex justify-center h-32 items-center">
              <Image
                src="/assets/images/ToteTaxiVanBlue.jpg"
                alt="ToteTaxi Van"
                width={120}
                height={120}
                className="object-contain w-auto h-auto max-h-28"
              />
            </div>
            <h3 className="text-xl font-medium text-navy-900 mb-3">Pickup</h3>
            <p className="text-navy-700">Schedule a pickup and we'll come to you.</p>
          </div>

          {/* Step 2 - Travel */}
          <div className="text-center">
            <div className="mb-6 flex justify-center h-32 items-center">
              <Image
                src="/assets/images/StylishWomanToteBag.jpg"
                alt="Travel Hands-Free"
                width={120}
                height={120}
                className="object-contain w-auto h-auto max-h-28"
              />
            </div>
            <h3 className="text-xl font-medium text-navy-900 mb-3">Travel</h3>
            <p className="text-navy-700">You travel hands-free. Très chic!</p>
          </div>

          {/* Step 3 - Delivery */}
          <div className="text-center">
            <div className="mb-6 flex justify-center h-32 items-center">
              <Image
                src="/assets/images/HamptonsBeachHouse.jpg"
                alt="Hamptons Delivery"
                width={120}
                height={120}
                className="object-contain w-auto h-auto max-h-28"
              />
            </div>
            <h3 className="text-xl font-medium text-navy-900 mb-3">Delivery</h3>
            <p className="text-navy-700">We'll deliver to your desired destination.</p>
          </div>
        </div>
      </div>
    </section>
  );
}
```

# ──── frontend/src/components/marketing/index.ts ────

```typescript
// src/components/marketing/index.ts
export { HeroSection } from './hero-section';
export { HowItWorksSection } from './how-it-works-section';
export { WhatWeTransportSection } from './what-we-transport-section';
export { ServiceAreasSection } from './service-areas-section';
export { TestimonialsSection } from './testimonials-section';
export { JFKAnnouncementPopup } from './jfk-announcement-popup';
```

# ──── frontend/src/components/marketing/jfk-announcement-popup.tsx ────

```tsx
'use client';

import { useState, useEffect } from 'react';
import { Modal } from '@/components/ui/modal';
import { Button } from '@/components/ui/button';

interface JFKAnnouncementPopupProps {
  onBookAirportTransfer: () => void;
}

export function JFKAnnouncementPopup({ onBookAirportTransfer }: JFKAnnouncementPopupProps) {
  const [isOpen, setIsOpen] = useState(false);

  useEffect(() => {
    // Check if user has already seen the popup
    const hasSeenPopup = localStorage.getItem('jfk_announcement_seen');

    if (!hasSeenPopup) {
      // Small delay before showing popup for better UX
      const timer = setTimeout(() => {
        setIsOpen(true);
      }, 1500);

      return () => clearTimeout(timer);
    }
  }, []);

  const handleClose = () => {
    localStorage.setItem('jfk_announcement_seen', 'true');
    setIsOpen(false);
  };

  const handleBookNow = () => {
    localStorage.setItem('jfk_announcement_seen', 'true');
    setIsOpen(false);
    onBookAirportTransfer();
  };

  return (
    <Modal
      isOpen={isOpen}
      onClose={handleClose}
      size="md"
      showCloseButton={true}
    >
      <div className="p-8 text-center">
        <div className="mb-6">
          <div className="inline-flex items-center justify-center w-16 h-16 bg-navy-100 rounded-full mb-4">
            <svg
              className="w-8 h-8 text-navy-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                strokeWidth={2}
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
              />
            </svg>
          </div>

          <h2 className="text-2xl font-serif font-bold text-navy-900 mb-2">
            Introducing Our New JFK Route!
          </h2>
        </div>

        <p className="text-navy-700 mb-6 leading-relaxed">
          Traveling to or from JFK just got a whole lot easier. Tote Taxi now offers
          seamless luggage delivery right to your hotel or straight to your terminal.
          Enjoy a stress-free journey with your luggage already waiting for you at your destination.
        </p>

        <div className="flex flex-col sm:flex-row gap-3 justify-center">
          <Button
            variant="primary"
            size="lg"
            onClick={handleBookNow}
          >
            Book Now
          </Button>

          <Button
            variant="outline"
            size="lg"
            onClick={handleClose}
          >
            Maybe Later
          </Button>
        </div>
      </div>
    </Modal>
  );
}
```

# ──── frontend/src/components/marketing/service-areas-section.tsx ────

```tsx
// src/components/marketing/service-areas-section.tsx
import Image from 'next/image';

export function ServiceAreasSection() {
  return (
    <section className="py-16 bg-white">
      <div className="container mx-auto px-4">
        <div className="text-center mb-12">
          <h2 className="text-3xl font-serif font-bold text-navy-900 mb-4">
            Where We Deliver
          </h2>
          <p className="text-lg text-navy-700">
            Comprehensive delivery service across multiple locations
          </p>
        </div>

        {/* Main Route Visualization */}
        <div className="flex flex-col lg:flex-row items-center justify-center gap-8 mb-12">
          <div className="text-center">
            <div className="h-40 flex items-center justify-center mb-4">
              <Image
                src="/assets/images/NycSkylineView.jpg"
                alt="NYC Skyline"
                width={200}
                height={150}
                className="object-contain w-auto h-auto max-h-36"
              />
            </div>
            <h3 className="font-medium text-navy-900">NYC & Surrounding Areas</h3>
          </div>
          
          <div className="hidden lg:block text-4xl text-navy-600">→</div>
          <div className="lg:hidden text-4xl text-navy-600">↓</div>
          
          <div className="text-center">
            <div className="h-40 flex items-center justify-center mb-4">
              <Image
                src="/assets/images/HamptonsBeachHouse.jpg"
                alt="Hamptons Beach House"
                width={200}
                height={150}
                className="object-contain w-auto h-auto max-h-36"
              />
            </div>
            <h3 className="font-medium text-navy-900">The Hamptons</h3>
          </div>
        </div>

        {/* Service Areas Grid */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
          <div className="text-center">
            <h3 className="font-medium text-navy-900 mb-2">NYC</h3>
            <p className="text-navy-600 text-sm">Manhattan, Brooklyn, and surrounding areas</p>
          </div>
          <div className="text-center">
            <h3 className="font-medium text-navy-900 mb-2">The Hamptons</h3>
            <p className="text-navy-600 text-sm">East Hampton, Southampton, Montauk, and more</p>
          </div>
          <div className="text-center">
            <h3 className="font-medium text-navy-900 mb-2">NYC Airports</h3>
            <p className="text-navy-600 text-sm">JFK, LaGuardia, Newark</p>
          </div>
          <div className="text-center">
            <h3 className="font-medium text-navy-900 mb-2">South Florida</h3>
            <p className="text-navy-600 text-sm">Palm Beach, Miami, Boca Raton, Jupiter</p>
          </div>
        </div>
      </div>
    </section>
  );
}
```

# ──── frontend/src/components/marketing/service-showcase.tsx ────

```tsx
// frontend/src/components/marketing/service-showcase.tsx
'use client';

import { useQuery } from '@tanstack/react-query';
import { useRouter } from 'next/navigation';
import { apiClient } from '@/lib/api-client';
import { Card, CardHeader, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { useBookingWizard } from '@/stores/booking-store';
import type { ServiceCatalog } from '@/types';

export function ServiceShowcase() {
  const router = useRouter();
  const { updateBookingData, resetWizard } = useBookingWizard();

  const { data: services, isLoading, error } = useQuery({
    queryKey: ['services', 'catalog'],
    queryFn: async (): Promise<ServiceCatalog> => {
      const response = await apiClient.get('/api/public/services/');
      return response.data;
    }
  });

  if (isLoading) {
    return (
      <section className="py-16 bg-cream-50">
        <div className="container mx-auto px-4">
          <div className="text-center">
            <div className="animate-pulse">
              <div className="h-8 bg-navy-200 rounded w-64 mx-auto mb-4"></div>
              <div className="h-4 bg-navy-100 rounded w-96 mx-auto"></div>
            </div>
          </div>
        </div>
      </section>
    );
  }

  if (error) {
    return (
      <section className="py-16 bg-cream-50">
        <div className="container mx-auto px-4 text-center">
          <p className="text-red-600">Unable to load services</p>
        </div>
      </section>
    );
  }

  // Handler for selecting a mini move package
  const handleSelectPackage = (pkg: { id: string; package_type: string }) => {
    resetWizard();
    updateBookingData({
      service_type: 'mini_move',
      mini_move_package_id: pkg.id,
      package_type: pkg.package_type as 'petite' | 'standard' | 'full',
    });
    router.push('/book');
  };

  return (
    <section className="py-16 bg-cream-50">
      <div className="container mx-auto px-4">
        {/* Section Header */}
        <div className="text-center mb-12">
          <h2 className="text-3xl font-serif font-bold text-navy-900 mb-4">
            Our Luxury Services
          </h2>
          <p className="text-lg text-navy-700 max-w-2xl mx-auto">
            From weekend getaways to seasonal relocations, we handle your Hamptons transport with premium care.
          </p>
        </div>

        {/* Mini Move Packages */}
        <div className="mb-16">
          <h3 className="text-2xl font-serif font-bold text-navy-900 text-center mb-8">
            Mini Moves
          </h3>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
            {services?.mini_move_packages?.map((pkg) => (
              <Card 
                key={pkg.id} 
                variant={pkg.is_most_popular ? "luxury" : "elevated"}
                className="relative"
              >
                {pkg.is_most_popular && (
                  <div className="absolute -top-3 left-1/2 transform -translate-x-1/2">
                    <span className="bg-gold-500 text-navy-900 px-4 py-1 rounded-full text-sm font-medium">
                      Most Popular
                    </span>
                  </div>
                )}
                
                <CardHeader>
                  <div className="text-center">
                    <h4 className="text-xl font-serif font-bold text-navy-900 mb-2">
                      {pkg.name}
                    </h4>
                    <div className="text-3xl font-bold text-navy-900 mb-2">
                      ${pkg.base_price_dollars}
                    </div>
                    {pkg.max_items && (
                      <p className="text-navy-600 text-sm">
                        Up to {pkg.max_items} items
                      </p>
                    )}
                  </div>
                </CardHeader>
                
                <CardContent>
                  <p className="text-navy-700 text-sm mb-4">{pkg.description}</p>
                  
                  <ul className="space-y-2 mb-6">
                    {pkg.coi_included && (
                      <li className="flex items-center text-sm text-navy-700">
                        <span className="text-green-500 mr-2">✓</span>
                        COI Included
                      </li>
                    )}
                    {pkg.priority_scheduling && (
                      <li className="flex items-center text-sm text-navy-700">
                        <span className="text-green-500 mr-2">✓</span>
                        Priority Scheduling
                      </li>
                    )}
                    {pkg.protective_wrapping && (
                      <li className="flex items-center text-sm text-navy-700">
                        <span className="text-green-500 mr-2">✓</span>
                        Protective Wrapping
                      </li>
                    )}
                  </ul>
                  
                  <Button
                    variant={pkg.is_most_popular ? "primary" : "outline"}
                    className="w-full"
                    onClick={() => handleSelectPackage(pkg)}
                  >
                    Select {pkg.name}
                  </Button>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>

        {/* Standard Delivery */}
        {services?.standard_delivery && (
          <div className="mb-16">
            <h3 className="text-2xl font-serif font-bold text-navy-900 text-center mb-8">
              Standard Delivery
            </h3>
            <div className="max-w-2xl mx-auto">
              <Card variant="elevated">
                <CardContent>
                  <div className="text-center">
                    <div className="text-2xl font-bold text-navy-900 mb-2">
                      ${services.standard_delivery.price_per_item_dollars} per item
                    </div>
                    <p className="text-navy-600 mb-4">
                      Minimum {services.standard_delivery.minimum_items} items • ${services.standard_delivery.minimum_charge_dollars} minimum
                    </p>
                    <p className="text-sm text-navy-700 mb-4">
                      Perfect for individual items under {services.standard_delivery.max_weight_per_item_lbs} lbs each
                    </p>
                    <div className="bg-gold-50 border border-gold-200 rounded-lg p-4 mb-4">
                      <p className="text-gold-800 font-medium">
                        Same-Day Delivery: ${services.standard_delivery.same_day_flat_rate_dollars}
                      </p>
                    </div>
                    <Button
                      variant="outline"
                      className="w-full"
                      onClick={() => {
                        resetWizard();
                        updateBookingData({ service_type: 'standard_delivery' });
                        router.push('/book');
                      }}
                    >
                      Calculate Your Delivery
                    </Button>
                  </div>
                </CardContent>
              </Card>
            </div>
          </div>
        )}

        {/* Specialty Items */}
        {services?.specialty_items && services.specialty_items.length > 0 && (
          <div>
            <h3 className="text-2xl font-serif font-bold text-navy-900 text-center mb-8">
              Specialty Items
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              {services.specialty_items.map((item) => (
                <Card key={item.id} variant="default">
                  <CardContent>
                    <div className="text-center">
                      <h4 className="font-medium text-navy-900 mb-2">{item.name}</h4>
                      <div className="text-xl font-bold text-navy-900 mb-2">
                        ${item.price_dollars}
                      </div>
                      <p className="text-navy-600 text-sm mb-3">{item.description}</p>
                      {item.special_handling && (
                        <span className="inline-block bg-gold-100 text-gold-800 text-xs px-2 py-1 rounded">
                          Special Handling
                        </span>
                      )}
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>
          </div>
        )}
      </div>
    </section>
  );
}
```

# ──── frontend/src/components/marketing/testimonials-section.tsx ────

```tsx
// src/components/marketing/testimonials-section.tsx
import { Card, CardContent } from '@/components/ui/card';

export function TestimonialsSection() {
  const testimonials = [
    {
      quote: "I've heard amazing things about Tote Taxi for awhile now and finally used it for the first time today when I took Blade from JFK to Manhattan and LOVED it! It was so easy and seamless!",
      author: "Natalie M."
    },
    {
      quote: "We have been using Tote Taxi for the last three years when we come out to East Hampton and when we head back to the city. They've always been wonderful! Makes moving bikes and extras easy and stress free!",
      author: "Kimberly R."
    },
    {
      quote: "Tote Taxi was a lifesaver! They were so easy to coordinate with, showed up exactly on time, communicated well. I highly recommend their services.",
      author: "Robyn M."
    },
    {
      quote: "Seamless and fast delivery between Palm Beach and Bridgehampton. The service was excellent, Danielle responded quickly and was flexible/accommodating to our needs for both pick up and delivery.",
      author: "Samantha M."
    },
    {
      quote: "Had them pick up a rental tux in NYC and drive it out on Labor Day weekend. Totally saved the wedding!",
      author: "Richard M."
    },
    {
      quote: "Danielle and her team helped us move many rolling racks of high end, delicate clothing from one NYC apartment to another. They were professional, timely and awesome to work with!",
      author: "Lauren S."
    }
  ];

  return (
    <section className="py-16 bg-cream-50">
      <div className="container mx-auto px-4">
        <h2 className="text-3xl font-serif font-bold text-navy-900 text-center mb-12">
          What Our Customers Say
        </h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {testimonials.map((testimonial, index) => (
            <Card key={index} variant="elevated">
              <CardContent>
                <p className="text-navy-700 text-sm mb-4">
                  &quot;{testimonial.quote}&quot;
                </p>
                <p className="font-medium text-navy-900">- {testimonial.author}</p>
              </CardContent>
            </Card>
          ))}
        </div>
      </div>
    </section>
  );
}
```

# ──── frontend/src/components/marketing/what-we-transport-section.tsx ────

```tsx
// src/components/marketing/what-we-transport-section.tsx
import Image from 'next/image';

export function WhatWeTransportSection() {
  const transportItems = [
    {
      image: '/assets/images/LuxuryLuggageCollection.png',
      title: 'Weekend Essentials',
      description: 'Suitcases, travel bags, and personal items'
    },
    {
      image: '/assets/images/ModernLuggageSet.jpg',
      title: 'Travel Luggage',
      description: 'All types of luggage and carry-ons'
    },
    {
      image: '/assets/images/PinkBicycleBasket.jpg',
      title: 'Bicycles & Recreation',
      description: 'Bikes, sports equipment, and gear'
    },
    {
      image: '/assets/images/PelotonExerciseBike.jpg',
      title: 'Fitness Equipment',
      description: 'Pelotons, exercise bikes, and gym equipment'
    },
    {
      image: '/assets/images/BabyStrollerBlue.jpg',
      title: 'Family Items',
      description: 'Strollers, baby gear, and kids toys'
    },
    {
      image: '/assets/images/SummerDressesHangers.jpg',
      title: 'Clothing & Garments',
      description: 'Garment bags, clothing racks, and wardrobes'
    }
  ];

  return (
    <section className="py-16 bg-cream-50">
      <div className="container mx-auto px-4">
        <div className="text-center mb-12">
          <h2 className="text-3xl font-serif font-bold text-navy-900 mb-4">
            What We Transport
          </h2>
          <p className="text-lg text-navy-700 max-w-2xl mx-auto">
            From suitcases to surfboards, Pelotons to pop-up props — we handle it all
          </p>
        </div>
        
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {transportItems.map((item, index) => (
            <div key={index} className="text-center bg-white rounded-lg p-6 shadow-sm">
              <div className="mb-4 flex justify-center h-24 items-center">
                <Image
                  src={item.image}
                  alt={item.title}
                  width={100}
                  height={100}
                  className="object-contain w-auto h-auto max-h-20"
                />
              </div>
              <h3 className="font-medium text-navy-900 mb-2">{item.title}</h3>
              <p className="text-navy-600 text-sm">{item.description}</p>
            </div>
          ))}
        </div>
      </div>
    </section>
  );
}
```

# ──── frontend/src/components/providers/client-providers.tsx ────

```tsx
// frontend/src/components/providers/client-providers.tsx
'use client';

import { QueryProvider } from "@/components/providers/query-provider";
import { useEffect } from 'react';
import { useAuthStore } from '@/stores/auth-store';
import { useStaffAuthStore } from '@/stores/staff-auth-store';

// Component to handle session validation
function SessionValidator() {
  const { validateSession: validateCustomer } = useAuthStore();
  const { validateSession: validateStaff } = useStaffAuthStore();

  useEffect(() => {
    const validateSessions = async () => {
      console.log('Validating stored sessions on app startup');

      // Read auth state at call time (not from stale closure)
      const isCustomerAuth = useAuthStore.getState().isAuthenticated;
      const isStaffAuth = useStaffAuthStore.getState().isAuthenticated;

      try {
        if (isCustomerAuth) {
          const isValid = await validateCustomer();
          if (!isValid) {
            console.log('Customer session invalid - cleared automatically');
          }
        }

        if (isStaffAuth) {
          const isValid = await validateStaff();
          if (!isValid) {
            console.log('Staff session invalid - cleared automatically');
          }
        }
      } catch (error) {
        console.warn('Session validation error:', error);
      }
    };

    // Run validation once on mount only
    const timer = setTimeout(validateSessions, 1000);
    return () => clearTimeout(timer);
  // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  return null; // This component doesn't render anything
}

interface ClientProvidersProps {
  children: React.ReactNode;
}

export function ClientProviders({ children }: ClientProvidersProps) {
  return (
    <QueryProvider>
      <SessionValidator />
      {children}
    </QueryProvider>
  );
}
```

# ──── frontend/src/components/providers/query-provider.tsx ────

```tsx
// frontend/src/components/providers/query-provider.tsx
'use client';

import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { ReactQueryDevtools } from '@tanstack/react-query-devtools';
import { useState } from 'react';
import { queryClient } from '@/lib/query-client';

interface QueryProviderProps {
  children: React.ReactNode;
}

export function QueryProvider({ children }: QueryProviderProps) {
  // Use the pre-configured client
  const [client] = useState(() => queryClient);

  return (
    <QueryClientProvider client={client}>
      {children}
      <ReactQueryDevtools initialIsOpen={false} />
    </QueryClientProvider>
  );
}
```

# ──── frontend/src/components/staff/booking-calendar.tsx ────

```tsx
// src/components/staff/booking-calendar.tsx
'use client';

import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
import { useRouter } from 'next/navigation';
import { apiClient } from '@/lib/api-client';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { BookingDetailModal } from './booking-detail-modal';

interface CalendarBooking {
  id: string;
  booking_number: string;
  customer_name: string;
  service_type: string;
  pickup_time: string;
  status: string;
  total_price_dollars: number;
  coi_required: boolean;
}

interface CalendarDay {
  date: string;
  available: boolean;
  is_weekend: boolean;
  bookings: CalendarBooking[];
  surcharges: Array<{ name: string; type: string; description: string }>;
}

interface CalendarData {
  availability: CalendarDay[];
  start_date: string;
  end_date: string;
}

type ViewMode = 'month' | 'week' | 'day';

const MONTHS = [
  'January', 'February', 'March', 'April', 'May', 'June',
  'July', 'August', 'September', 'October', 'November', 'December'
];

const WEEKDAYS = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
const WEEKDAYS_SHORT = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

export function BookingCalendar() {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [selectedDate, setSelectedDate] = useState<string | null>(null);
  const [selectedBooking, setSelectedBooking] = useState<string | null>(null);
  const [viewMode, setViewMode] = useState<ViewMode>('month');
  const router = useRouter();

  // Get date range based on view mode
  const getDateRange = () => {
    if (viewMode === 'month') {
      const startOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
      const endOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
      return { startDate: startOfMonth, endDate: endOfMonth };
    } else if (viewMode === 'week') {
      const startOfWeek = new Date(currentDate);
      startOfWeek.setDate(currentDate.getDate() - currentDate.getDay()); // Go to Sunday
      const endOfWeek = new Date(startOfWeek);
      endOfWeek.setDate(startOfWeek.getDate() + 6); // Go to Saturday
      return { startDate: startOfWeek, endDate: endOfWeek };
    } else {
      // Day view
      return { startDate: new Date(currentDate), endDate: new Date(currentDate) };
    }
  };

  const { startDate, endDate } = getDateRange();

  const { data: calendarData, isLoading } = useQuery({
    queryKey: ['calendar', 'availability', viewMode, startDate.toISOString().split('T')[0]],
    queryFn: async (): Promise<CalendarData> => {
      const response = await apiClient.get('/api/public/availability/', {
        params: {
          start_date: startDate.toISOString().split('T')[0],
          end_date: endDate.toISOString().split('T')[0]
        }
      });
      return response.data;
    }
  });

  // Navigate based on view mode
  const navigate = (direction: 'prev' | 'next') => {
    const newDate = new Date(currentDate);
    if (viewMode === 'month') {
      if (direction === 'prev') {
        newDate.setMonth(newDate.getMonth() - 1);
      } else {
        newDate.setMonth(newDate.getMonth() + 1);
      }
    } else if (viewMode === 'week') {
      if (direction === 'prev') {
        newDate.setDate(newDate.getDate() - 7);
      } else {
        newDate.setDate(newDate.getDate() + 7);
      }
    } else {
      // Day view
      if (direction === 'prev') {
        newDate.setDate(newDate.getDate() - 1);
      } else {
        newDate.setDate(newDate.getDate() + 1);
      }
    }
    setCurrentDate(newDate);
  };

  // Handle day click - switch to day view
  const handleDayClick = (dateStr: string) => {
    const clickedDate = new Date(dateStr);
    setCurrentDate(clickedDate);
    setViewMode('day');
  };

  // Handle booking click
  const handleBookingClick = (booking: CalendarBooking, e: React.MouseEvent) => {
    e.stopPropagation(); // Don't trigger day selection
    setSelectedBooking(booking.id);
  };

  // Get calendar grid for month view
  const getMonthCalendarDays = () => {
    if (!calendarData) return [];
    
    const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
    const startDate = new Date(firstDayOfMonth);
    startDate.setDate(startDate.getDate() - firstDayOfMonth.getDay());
    
    const days = [];
    const currentDay = new Date(startDate);
    
    while (days.length < 42) { // 6 weeks × 7 days
      const dateStr = currentDay.toISOString().split('T')[0];
      const dayData = calendarData.availability.find(day => day.date === dateStr);
      
      days.push({
        date: new Date(currentDay),
        dateStr,
        isCurrentMonth: currentDay.getMonth() === currentDate.getMonth(),
        isToday: dateStr === new Date().toISOString().split('T')[0],
        data: dayData
      });
      
      currentDay.setDate(currentDay.getDate() + 1);
    }
    
    return days;
  };

  // Get week days for week view
  const getWeekDays = () => {
    if (!calendarData) return [];
    
    const days = [];
    const weekStart = new Date(startDate);
    
    for (let i = 0; i < 7; i++) {
      const currentDay = new Date(weekStart);
      currentDay.setDate(weekStart.getDate() + i);
      const dateStr = currentDay.toISOString().split('T')[0];
      const dayData = calendarData.availability.find(day => day.date === dateStr);
      
      days.push({
        date: new Date(currentDay),
        dateStr,
        isToday: dateStr === new Date().toISOString().split('T')[0],
        data: dayData
      });
    }
    
    return days;
  };

  // Get single day for day view
  const getDayData = () => {
    if (!calendarData) return null;
    
    const dateStr = currentDate.toISOString().split('T')[0];
    const dayData = calendarData.availability.find(day => day.date === dateStr);
    
    return {
      date: new Date(currentDate),
      dateStr,
      isToday: dateStr === new Date().toISOString().split('T')[0],
      data: dayData
    };
  };

  // Get booking color based on count
  const getBookingColor = (day: any) => {
    if (!day.data || !day.data.bookings) return 'bg-gray-50';
    
    const bookingCount = day.data.bookings.length;
    if (bookingCount >= 5) return 'bg-red-100 border-red-300';
    if (bookingCount >= 3) return 'bg-amber-100 border-amber-300';
    if (bookingCount >= 1) return 'bg-yellow-100 border-yellow-300';
    return 'bg-green-100 border-green-300';
  };

  // Get display title based on view mode
  const getDisplayTitle = () => {
    if (viewMode === 'month') {
      return `${MONTHS[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
    } else if (viewMode === 'week') {
      const weekStart = new Date(startDate);
      const weekEnd = new Date(endDate);
      if (weekStart.getMonth() === weekEnd.getMonth()) {
        return `${MONTHS[weekStart.getMonth()]} ${weekStart.getDate()}-${weekEnd.getDate()}, ${weekStart.getFullYear()}`;
      } else {
        return `${MONTHS[weekStart.getMonth()]} ${weekStart.getDate()} - ${MONTHS[weekEnd.getMonth()]} ${weekEnd.getDate()}, ${weekStart.getFullYear()}`;
      }
    } else {
      return currentDate.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
    }
  };

  if (isLoading) {
    return (
      <div className="flex justify-center items-center h-96">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-navy-900"></div>
      </div>
    );
  }

  const renderMonthView = () => {
    const calendarDays = getMonthCalendarDays();
    
    return (
      <Card>
        <CardContent className="p-0">
          <div className="grid grid-cols-7 gap-0">
            {/* Header row */}
            {WEEKDAYS_SHORT.map(day => (
              <div key={day} className="bg-gray-50 px-3 py-2 text-sm font-medium text-navy-800 text-center border-b">
                {day}
              </div>
            ))}
            
            {/* Calendar days */}
            {calendarDays.map((day, index) => (
              <div
                key={index}
                className={`min-h-[120px] p-2 border-r border-b cursor-pointer hover:bg-gray-50 ${getBookingColor(day)} ${
                  !day.isCurrentMonth ? 'opacity-30' : ''
                } ${day.isToday ? 'ring-2 ring-navy-500' : ''}`}
                onClick={() => handleDayClick(day.dateStr)}
              >
                <div className="flex items-start justify-between">
                  <span className={`text-sm font-medium ${
                    day.isCurrentMonth ? 'text-navy-800' : 'text-navy-400'
                  }`}>
                    {day.date.getDate()}
                  </span>
                  
                  {day.data?.surcharges && day.data.surcharges.length > 0 && (
                    <span className="text-amber-600 text-xs">!</span>
                  )}
                </div>
                
                {day.data && (
                  <div className="mt-1 space-y-1">
                    {day.data.bookings?.slice(0, 2).map(booking => (
                      <div
                        key={booking.id}
                        className={`text-xs p-1 rounded truncate cursor-pointer hover:opacity-75 ${
                          booking.status === 'pending'
                            ? 'bg-amber-200 text-amber-800'
                            : booking.status === 'confirmed'
                            ? 'bg-blue-200 text-blue-800'
                            : 'bg-green-200 text-green-800'
                        }`}
                        onClick={(e) => handleBookingClick(booking, e)}
                      >
                        {booking.booking_number}
                      </div>
                    ))}
                    
                    {day.data.bookings && day.data.bookings.length > 2 && (
                      <div className="text-xs text-navy-600">
                        +{day.data.bookings.length - 2} more
                      </div>
                    )}
                  </div>
                )}
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    );
  };

  const renderWeekView = () => {
    const weekDays = getWeekDays();
    
    return (
      <Card>
        <CardContent className="p-0">
          <div className="grid grid-cols-7 gap-0">
            {/* Header row */}
            {weekDays.map((day, index) => (
              <div key={index} className="bg-gray-50 px-3 py-3 text-sm font-medium text-navy-800 text-center border-b">
                <div className="font-semibold">{WEEKDAYS_SHORT[index]}</div>
                <div className={`text-lg mt-1 ${day.isToday ? 'text-navy-900 font-bold' : 'text-navy-600'}`}>
                  {day.date.getDate()}
                </div>
              </div>
            ))}
            
            {/* Week days */}
            {weekDays.map((day, index) => (
              <div
                key={index}
                className={`min-h-[200px] p-3 border-r border-b cursor-pointer hover:bg-gray-50 ${getBookingColor(day)} ${
                  day.isToday ? 'ring-2 ring-navy-500' : ''
                }`}
                onClick={() => handleDayClick(day.dateStr)}
              >
                <div className="flex items-start justify-between mb-2">
                  {day.data?.surcharges && day.data.surcharges.length > 0 && (
                    <span className="text-amber-600 text-xs bg-amber-100 px-1 rounded">Surcharge</span>
                  )}
                </div>
                
                {day.data && (
                  <div className="space-y-2">
                    {day.data.bookings?.map(booking => (
                      <div
                        key={booking.id}
                        className={`text-xs p-2 rounded cursor-pointer hover:opacity-75 ${
                          booking.status === 'pending'
                            ? 'bg-amber-200 text-amber-800'
                            : booking.status === 'confirmed'
                            ? 'bg-blue-200 text-blue-800'
                            : booking.status === 'paid'
                            ? 'bg-green-200 text-green-800'
                            : 'bg-gray-200 text-gray-800'
                        }`}
                        onClick={(e) => handleBookingClick(booking, e)}
                      >
                        <div className="font-semibold">{booking.booking_number}</div>
                        <div className="text-xs mt-1">{booking.customer_name}</div>
                        <div className="text-xs">{booking.service_type}</div>
                        <div className="text-xs">${booking.total_price_dollars}</div>
                        {booking.coi_required && (
                          <div className="text-xs text-orange-600 font-medium">COI Required</div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    );
  };

  const renderDayView = () => {
    const dayData = getDayData();
    
    if (!dayData?.data || !dayData.data.bookings || dayData.data.bookings.length === 0) {
      return (
        <Card>
          <CardHeader>
            <h3 className="text-lg font-medium text-navy-900">
              {dayData?.date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
              })}
            </h3>
          </CardHeader>
          <CardContent className="p-12 text-center">
            <p className="text-navy-600">No bookings scheduled for this date</p>
          </CardContent>
        </Card>
      );
    }

    return (
      <Card>
        <CardHeader>
          <h3 className="text-lg font-medium text-navy-900">
            {dayData.date.toLocaleDateString('en-US', { 
              weekday: 'long', 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            })}
          </h3>
          <p className="text-navy-600">{dayData.data.bookings.length} bookings scheduled</p>
        </CardHeader>
        <CardContent className="space-y-4">
          {dayData.data.bookings.map(booking => (
            <Card key={booking.id} variant="elevated">
              <CardContent className="p-4">
                <div className="flex justify-between items-start">
                  <div className="flex-1">
                    <div className="flex items-center space-x-3 mb-2">
                      <h4 className="font-semibold text-navy-900">{booking.booking_number}</h4>
                      <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                        booking.status === 'completed' 
                          ? 'bg-green-100 text-green-800'
                          : booking.status === 'paid'
                          ? 'bg-blue-100 text-blue-800'
                          : booking.status === 'confirmed'
                          ? 'bg-purple-100 text-purple-800'
                          : booking.status === 'pending'
                          ? 'bg-amber-100 text-amber-800'
                          : 'bg-red-100 text-red-800'
                      }`}>
                        {booking.status}
                      </span>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-4 text-sm text-navy-700">
                      <div>
                        <p><strong className="text-navy-900">Customer:</strong> {booking.customer_name}</p>
                        <p><strong className="text-navy-900">Service:</strong> {booking.service_type}</p>
                        <p><strong className="text-navy-900">Time:</strong> {booking.pickup_time}</p>
                      </div>
                      <div>
                        <p><strong className="text-navy-900">Total:</strong> ${booking.total_price_dollars}</p>
                        {booking.coi_required && (
                          <p className="text-orange-600 font-medium">COI Required</p>
                        )}
                      </div>
                    </div>
                  </div>
                  
                  <div className="flex flex-col space-y-2 ml-4">
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={(e) => handleBookingClick(booking, e)}
                    >
                      Quick Edit
                    </Button>
                    <Button
                      variant="primary"
                      size="sm"
                      onClick={() => router.push(`/staff/bookings/${booking.id}`)}
                    >
                      Full Details
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
          
          {dayData.data.surcharges && dayData.data.surcharges.length > 0 && (
            <Card className="border-amber-200 bg-amber-50">
              <CardContent className="p-4">
                <h4 className="font-medium text-amber-800 mb-2">Active Surcharges</h4>
                {dayData.data.surcharges.map((surcharge, index) => (
                  <p key={index} className="text-sm text-amber-700">
                    • {surcharge.name}: {surcharge.description}
                  </p>
                ))}
              </CardContent>
            </Card>
          )}
        </CardContent>
      </Card>
    );
  };

  return (
    <div className="space-y-6">
      {/* Calendar Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center space-x-4">
          <h1 className="text-2xl font-serif font-bold text-navy-900">
            Booking Calendar
          </h1>
          
          {/* View Mode Selector */}
          <div className="flex items-center space-x-2 bg-navy-100 rounded-lg p-1">
            {(['month', 'week', 'day'] as ViewMode[]).map(mode => (
              <button
                key={mode}
                className={`px-3 py-1 rounded text-sm font-medium transition-colors ${
                  viewMode === mode 
                    ? 'bg-navy-900 text-white' 
                    : 'text-navy-700 hover:bg-navy-200'
                }`}
                onClick={() => setViewMode(mode)}
              >
                {mode.charAt(0).toUpperCase() + mode.slice(1)}
              </button>
            ))}
          </div>
          
          <div className="flex items-center space-x-2">
            <Button
              variant="outline"
              size="sm"
              onClick={() => navigate('prev')}
            >
              ←
            </Button>
            <h2 className="text-lg font-medium min-w-[200px] text-center text-navy-900">
              {getDisplayTitle()}
            </h2>
            <Button
              variant="outline"
              size="sm"
              onClick={() => navigate('next')}
            >
              →
            </Button>
          </div>
        </div>
      </div>

      {/* Calendar Legend */}
      <Card>
        <CardContent className="p-4">
          <div className="flex items-center space-x-6 text-sm">
            <div className="flex items-center space-x-2">
              <div className="w-4 h-4 bg-green-100 border border-green-300 rounded"></div>
              <span className="text-navy-700">No bookings</span>
            </div>
            <div className="flex items-center space-x-2">
              <div className="w-4 h-4 bg-yellow-100 border border-yellow-300 rounded"></div>
              <span className="text-navy-700">Light (1-2)</span>
            </div>
            <div className="flex items-center space-x-2">
              <div className="w-4 h-4 bg-amber-100 border border-amber-300 rounded"></div>
              <span className="text-navy-700">Busy (3-4)</span>
            </div>
            <div className="flex items-center space-x-2">
              <div className="w-4 h-4 bg-red-100 border border-red-300 rounded"></div>
              <span className="text-navy-700">Heavy (5+)</span>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Calendar Views */}
      {viewMode === 'month' && renderMonthView()}
      {viewMode === 'week' && renderWeekView()}
      {viewMode === 'day' && renderDayView()}

      {/* Booking Detail Modal */}
      {selectedBooking && (
        <BookingDetailModal
          bookingId={selectedBooking}
          isOpen={!!selectedBooking}
          onClose={() => setSelectedBooking(null)}
        />
      )}
    </div>
  );
}
```

# ──── frontend/src/components/staff/booking-detail-modal.tsx ────

```tsx
// src/components/staff/booking-detail-modal.tsx
'use client';

import { useState, useEffect } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { apiClient } from '@/lib/api-client';
import { Modal } from '@/components/ui/modal';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Select } from '@/components/ui/select';

interface BookingDetailModalProps {
  bookingId: string;
  isOpen: boolean;
  onClose: () => void;
}

interface Address {
  address_line_1: string;
  address_line_2: string;
  city: string;
  state: string;
  zip_code: string;
}

interface ServiceDetails {
  mini_move?: {
    package_name: string;
    package_type: string;
    description: string;
    max_items: number | null;
    max_weight_per_item_lbs: number;
    coi_included: boolean;
    priority_scheduling: boolean;
    protective_wrapping: boolean;
    base_price_dollars: number;
  };
  organizing_services?: {
    include_packing: boolean;
    include_unpacking: boolean;
    packing_service?: {
      name: string;
      price_dollars: number;
      duration_hours: number;
      organizer_count: number;
      supplies_allowance: number;
    };
    unpacking_service?: {
      name: string;
      price_dollars: number;
      duration_hours: number;
      organizer_count: number;
      supplies_allowance: number;
    };
  };
  specialty_items?: Array<{
    id: string;
    name: string;
    item_type: string;
    description: string;
    price_dollars: number;
    special_handling: boolean;
  }>;
  standard_delivery?: {
    item_count: number;
    is_same_day: boolean;
  };
  blade_transfer?: {
    airport: string;
    flight_date: string;
    flight_time: string;
    bag_count: number;
    ready_time: string;
    per_bag_price: number;
  };
}

interface BookingFormData {
  status: string;
  pickup_date: string;
  pickup_time: string;
  special_instructions: string;
  coi_required: boolean;
  pickup_address: Address;
  delivery_address: Address;
}

interface BookingDetail {
  booking: {
    id: string;
    booking_number: string;
    service_type: string;
    service_type_display: string;
    status: string;
    pickup_date: string;
    pickup_time: string;
    pickup_time_display: string;
    pickup_address: Address;
    delivery_address: Address;
    special_instructions: string;
    coi_required: boolean;
    is_outside_core_area: boolean;
    total_price_dollars: number;
    base_price_dollars: number;
    surcharge_dollars: number;
    same_day_surcharge_dollars: number;
    coi_fee_dollars: number;
    organizing_total_dollars: number;
    organizing_tax_dollars: number;
    geographic_surcharge_dollars: number;
    time_window_surcharge_dollars: number;
    discount_amount_dollars: number;
    pre_discount_total_dollars: number;
    discount_code_name: string | null;
    discount_description: string | null;
    pricing_breakdown: any;
    service_details: ServiceDetails;
    created_at: string;
    updated_at: string;
  };
  customer?: {
    id: number;
    name: string;
    email: string;
    phone: string;
    is_vip: boolean;
  };
  guest_checkout?: {
    first_name: string;
    last_name: string;
    email: string;
    phone: string;
  };
  payment?: {
    id: string;
    status: string;
    amount_dollars: number;
  };
}

export function BookingDetailModal({ bookingId, isOpen, onClose }: BookingDetailModalProps) {
  const [activeTab, setActiveTab] = useState('general');
  const [formData, setFormData] = useState<BookingFormData>({
    status: '',
    pickup_date: '',
    pickup_time: '',
    special_instructions: '',
    coi_required: false,
    pickup_address: {
      address_line_1: '',
      address_line_2: '',
      city: '',
      state: '',
      zip_code: ''
    },
    delivery_address: {
      address_line_1: '',
      address_line_2: '',
      city: '',
      state: '',
      zip_code: ''
    }
  });
  
  const queryClient = useQueryClient();

  const { data: bookingDetail, isLoading } = useQuery({
    queryKey: ['staff', 'booking', bookingId],
    queryFn: async (): Promise<BookingDetail> => {
      const response = await apiClient.get(`/api/staff/bookings/${bookingId}/`);
      return response.data;
    },
    enabled: isOpen && !!bookingId,
  });

  const updateBookingMutation = useMutation({
    mutationFn: async (updates: Partial<BookingFormData>) => {
      const response = await apiClient.patch(`/api/staff/bookings/${bookingId}/`, updates);
      return response.data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['staff', 'booking', bookingId] });
      queryClient.invalidateQueries({ queryKey: ['calendar', 'availability'] });
      queryClient.invalidateQueries({ queryKey: ['staff', 'bookings'] });
    }
  });

  useEffect(() => {
    if (bookingDetail) {
      setFormData({
        status: bookingDetail.booking.status,
        pickup_date: bookingDetail.booking.pickup_date,
        pickup_time: bookingDetail.booking.pickup_time,
        special_instructions: bookingDetail.booking.special_instructions || '',
        coi_required: bookingDetail.booking.coi_required,
        pickup_address: { ...bookingDetail.booking.pickup_address },
        delivery_address: { ...bookingDetail.booking.delivery_address },
      });
    }
  }, [bookingDetail]);

  const handleSave = () => {
    const updates: Partial<BookingFormData> = {};
    if (formData.status !== bookingDetail?.booking.status) {
      updates.status = formData.status;
    }
    if (Object.keys(updates).length > 0) {
      updateBookingMutation.mutate(updates);
    }
  };

  const statusOptions = [
    { value: 'pending', label: 'Pending' },
    { value: 'confirmed', label: 'Confirmed' },
    { value: 'paid', label: 'Paid' },
    { value: 'completed', label: 'Completed' },
    { value: 'cancelled', label: 'Cancelled' },
  ];

  const pickupTimeOptions = [
    { value: 'morning', label: '8 AM - 11 AM' },
    { value: 'morning_specific', label: 'Specific 1-hour window' },
    { value: 'no_time_preference', label: 'No time preference' },
  ];

  const tabs = [
    { id: 'general', label: 'General' },
    { id: 'addresses', label: 'Addresses' },
    { id: 'services', label: 'Services' },
    { id: 'pricing', label: 'Pricing' },
    { id: 'customer', label: 'Customer' },
  ];

  if (isLoading || !bookingDetail) {
    return (
      <Modal isOpen={isOpen} onClose={onClose} size="xl" title="Loading...">
        <div className="flex justify-center py-12">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-navy-900"></div>
        </div>
      </Modal>
    );
  }

  const serviceDetails = bookingDetail.booking.service_details;

  return (
    <Modal 
      isOpen={isOpen} 
      onClose={onClose} 
      size="xl" 
      title={`Booking ${bookingDetail.booking.booking_number}`}
      description={`${bookingDetail.booking.service_type_display} • ${bookingDetail.customer?.name || 'Guest'}`}
    >
      <div className="space-y-6">
        {/* Tabs */}
        <div className="border-b border-gray-200">
          <div className="flex space-x-8">
            {tabs.map(tab => (
              <button
                key={tab.id}
                className={`py-2 px-1 border-b-2 font-medium text-sm transition-colors ${
                  activeTab === tab.id
                    ? 'border-navy-500 text-navy-600'
                    : 'border-transparent text-navy-500 hover:text-navy-700 hover:border-navy-300'
                }`}
                onClick={() => setActiveTab(tab.id)}
              >
                {tab.label}
              </button>
            ))}
          </div>
        </div>

        {/* Tab Content */}
        <div className="max-h-96 overflow-y-auto">
          {activeTab === 'general' && (
            <div className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <Select
                  label="Status"
                  options={statusOptions}
                  value={formData.status}
                  onChange={(e) => setFormData((prev: BookingFormData) => ({ ...prev, status: e.target.value }))}
                />
                <Input
                  label="Service Type"
                  value={bookingDetail.booking.service_type_display}
                  disabled
                  className="bg-gray-100"
                />
              </div>
              
              <div className="grid grid-cols-2 gap-4">
                <Input
                  label="Pickup Date"
                  type="date"
                  value={formData.pickup_date}
                  onChange={(e) => setFormData((prev: BookingFormData) => ({ ...prev, pickup_date: e.target.value }))}
                />
                <Select
                  label="Pickup Time"
                  options={pickupTimeOptions}
                  value={formData.pickup_time}
                  onChange={(e) => setFormData((prev: BookingFormData) => ({ ...prev, pickup_time: e.target.value }))}
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-navy-900 mb-1">
                  Special Instructions
                </label>
                <textarea
                  value={formData.special_instructions}
                  onChange={(e) => setFormData((prev: BookingFormData) => ({ ...prev, special_instructions: e.target.value }))}
                  rows={3}
                  className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-navy-500 focus:border-navy-500 text-gray-900"
                />
              </div>

              <div className="flex items-center space-x-4">
                <div className="flex items-center">
                  <input
                    type="checkbox"
                    id="coi_required"
                    checked={formData.coi_required}
                    onChange={(e) => setFormData((prev: BookingFormData) => ({ ...prev, coi_required: e.target.checked }))}
                    className="mr-2"
                  />
                  <label htmlFor="coi_required" className="text-sm text-navy-900">
                    COI Required
                  </label>
                </div>
                {bookingDetail.booking.is_outside_core_area && (
                  <span className="text-xs bg-amber-100 text-amber-800 px-2 py-1 rounded">
                    Outside Core Area
                  </span>
                )}
              </div>
            </div>
          )}

          {activeTab === 'services' && (
            <div className="space-y-4">
              <div className="text-sm text-navy-600 mb-4">
                <strong className="text-navy-900">Service Type:</strong> {bookingDetail.booking.service_type_display}
              </div>

              {/* Mini Move Details */}
              {serviceDetails.mini_move && (
                <Card>
                  <CardHeader>
                    <h4 className="font-medium text-navy-900">Mini Move Package</h4>
                  </CardHeader>
                  <CardContent className="space-y-2 text-sm">
                    <div><strong>Package:</strong> {serviceDetails.mini_move.package_name}</div>
                    <div><strong>Description:</strong> {serviceDetails.mini_move.description}</div>
                    <div><strong>Max Items:</strong> {serviceDetails.mini_move.max_items || 'Unlimited'}</div>
                    <div><strong>Max Weight per Item:</strong> {serviceDetails.mini_move.max_weight_per_item_lbs} lbs</div>
                    <div><strong>Base Price:</strong> ${serviceDetails.mini_move.base_price_dollars}</div>
                    <div className="flex flex-wrap gap-2 mt-2">
                      {serviceDetails.mini_move.coi_included && (
                        <span className="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">COI Included</span>
                      )}
                      {serviceDetails.mini_move.priority_scheduling && (
                        <span className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Priority Scheduling</span>
                      )}
                      {serviceDetails.mini_move.protective_wrapping && (
                        <span className="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">Protective Wrapping</span>
                      )}
                    </div>
                  </CardContent>
                </Card>
              )}

              {/* Organizing Services */}
              {serviceDetails.organizing_services && (
                <Card>
                  <CardHeader>
                    <h4 className="font-medium text-navy-900">Organizing Services</h4>
                  </CardHeader>
                  <CardContent className="space-y-3">
                    {serviceDetails.organizing_services.packing_service && (
                      <div className="border-b border-gray-200 pb-3">
                        <div className="flex items-center mb-2">
                          <span className="text-green-600 mr-2">✓</span>
                          <span className="font-medium">{serviceDetails.organizing_services.packing_service.name}</span>
                        </div>
                        <div className="text-sm text-navy-600 ml-6">
                          ${serviceDetails.organizing_services.packing_service.price_dollars} • 
                          {serviceDetails.organizing_services.packing_service.duration_hours}h • 
                          {serviceDetails.organizing_services.packing_service.organizer_count} organizer(s)
                        </div>
                      </div>
                    )}
                    {serviceDetails.organizing_services.unpacking_service && (
                      <div className="border-b border-gray-200 pb-3">
                        <div className="flex items-center mb-2">
                          <span className="text-green-600 mr-2">✓</span>
                          <span className="font-medium">{serviceDetails.organizing_services.unpacking_service.name}</span>
                        </div>
                        <div className="text-sm text-navy-600 ml-6">
                          ${serviceDetails.organizing_services.unpacking_service.price_dollars} • 
                          {serviceDetails.organizing_services.unpacking_service.duration_hours}h • 
                          {serviceDetails.organizing_services.unpacking_service.organizer_count} organizer(s)
                        </div>
                      </div>
                    )}
                    {bookingDetail.booking.organizing_total_dollars && (
                      <div className="pt-2">
                        <strong>Total:</strong> ${bookingDetail.booking.organizing_total_dollars}
                      </div>
                    )}
                  </CardContent>
                </Card>
              )}

              {/* Specialty Items */}
              {serviceDetails.specialty_items && serviceDetails.specialty_items.length > 0 && (
                <Card>
                  <CardHeader>
                    <h4 className="font-medium text-navy-900">Specialty Items</h4>
                  </CardHeader>
                  <CardContent className="space-y-3">
                    {serviceDetails.specialty_items.map((item) => (
                      <div key={item.id} className="border-b border-gray-200 pb-3 last:border-0">
                        <div className="font-medium text-navy-900">{item.name}</div>
                        <div className="text-sm text-navy-600">{item.description}</div>
                        <div className="text-sm mt-1">
                          <strong>Price:</strong> ${item.price_dollars}
                          {item.special_handling && (
                            <span className="ml-2 text-xs bg-orange-100 text-orange-800 px-2 py-0.5 rounded">
                              Special Handling
                            </span>
                          )}
                        </div>
                      </div>
                    ))}
                  </CardContent>
                </Card>
              )}

              {/* Standard Delivery */}
              {serviceDetails.standard_delivery && (
                <Card>
                  <CardHeader>
                    <h4 className="font-medium text-navy-900">Standard Delivery</h4>
                  </CardHeader>
                  <CardContent className="space-y-2 text-sm">
                    <div><strong>Item Count:</strong> {serviceDetails.standard_delivery.item_count}</div>
                    {serviceDetails.standard_delivery.is_same_day && (
                      <div className="text-orange-600 font-medium">Same-Day Delivery</div>
                    )}
                  </CardContent>
                </Card>
              )}

              {/* BLADE Transfer */}
              {serviceDetails.blade_transfer && (
                <Card>
                  <CardHeader>
                    <h4 className="font-medium text-navy-900">BLADE Airport Transfer</h4>
                  </CardHeader>
                  <CardContent className="space-y-2 text-sm">
                    <div><strong>Airport:</strong> {serviceDetails.blade_transfer.airport}</div>
                    <div><strong>Flight Date:</strong> {new Date(serviceDetails.blade_transfer.flight_date + 'T00:00:00').toLocaleDateString()}</div>
                    <div><strong>Flight Time:</strong> {serviceDetails.blade_transfer.flight_time}</div>
                    <div><strong>Bag Count:</strong> {serviceDetails.blade_transfer.bag_count} @ ${serviceDetails.blade_transfer.per_bag_price}/bag</div>
                    {serviceDetails.blade_transfer.ready_time && (
                      <div><strong>Ready Time:</strong> {serviceDetails.blade_transfer.ready_time}</div>
                    )}
                  </CardContent>
                </Card>
              )}
            </div>
          )}

          {activeTab === 'addresses' && (
            <div className="space-y-6">
              <Card>
                <CardHeader>
                  <h3 className="text-lg font-medium text-navy-900">Pickup Address</h3>
                </CardHeader>
                <CardContent>
                  <div className="text-navy-800">
                    <div>{bookingDetail.booking.pickup_address.address_line_1}</div>
                    {bookingDetail.booking.pickup_address.address_line_2 && (
                      <div>{bookingDetail.booking.pickup_address.address_line_2}</div>
                    )}
                    <div>
                      {bookingDetail.booking.pickup_address.city}, {bookingDetail.booking.pickup_address.state} {bookingDetail.booking.pickup_address.zip_code}
                    </div>
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <h3 className="text-lg font-medium text-navy-900">Delivery Address</h3>
                </CardHeader>
                <CardContent>
                  <div className="text-navy-800">
                    <div>{bookingDetail.booking.delivery_address.address_line_1}</div>
                    {bookingDetail.booking.delivery_address.address_line_2 && (
                      <div>{bookingDetail.booking.delivery_address.address_line_2}</div>
                    )}
                    <div>
                      {bookingDetail.booking.delivery_address.city}, {bookingDetail.booking.delivery_address.state} {bookingDetail.booking.delivery_address.zip_code}
                    </div>
                  </div>
                </CardContent>
              </Card>
            </div>
          )}

          {activeTab === 'customer' && (
            <div className="space-y-4">
              {bookingDetail.customer ? (
                <Card>
                  <CardContent>
                    <div className="space-y-2">
                      <p><strong>Name:</strong> {bookingDetail.customer.name}</p>
                      <p><strong>Email:</strong> {bookingDetail.customer.email}</p>
                      <p><strong>Phone:</strong> {bookingDetail.customer.phone}</p>
                      <p><strong>VIP Status:</strong> {bookingDetail.customer.is_vip ? 'Yes' : 'No'}</p>
                    </div>
                  </CardContent>
                </Card>
              ) : bookingDetail.guest_checkout ? (
                <Card>
                  <CardHeader>
                    <h3 className="text-lg font-medium text-navy-900">Guest Customer</h3>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-2">
                      <p><strong>Name:</strong> {bookingDetail.guest_checkout.first_name} {bookingDetail.guest_checkout.last_name}</p>
                      <p><strong>Email:</strong> {bookingDetail.guest_checkout.email}</p>
                      <p><strong>Phone:</strong> {bookingDetail.guest_checkout.phone}</p>
                    </div>
                  </CardContent>
                </Card>
              ) : (
                <p>No customer information available</p>
              )}
            </div>
          )}

          {activeTab === 'pricing' && (
            <Card>
              <CardContent>
                <div className="space-y-3">
                  <div className="space-y-2 text-sm">
                    {/* Base Price */}
                    <div className="flex justify-between">
                      <span className="text-navy-600">Base Price:</span>
                      <span className="text-navy-900">${bookingDetail.booking.base_price_dollars || 0}</span>
                    </div>

                    {/* Surcharges */}
                    {bookingDetail.booking.same_day_surcharge_dollars > 0 && (
                      <div className="flex justify-between">
                        <span className="text-navy-600">Same-Day Delivery:</span>
                        <span className="text-navy-900">+${bookingDetail.booking.same_day_surcharge_dollars}</span>
                      </div>
                    )}
                    {bookingDetail.booking.surcharge_dollars > 0 && (
                      <div className="flex justify-between">
                        <span className="text-navy-600">Peak Date Surcharge:</span>
                        <span className="text-navy-900">+${bookingDetail.booking.surcharge_dollars}</span>
                      </div>
                    )}
                    {bookingDetail.booking.coi_fee_dollars > 0 && (
                      <div className="flex justify-between">
                        <span className="text-navy-600">COI Fee:</span>
                        <span className="text-navy-900">+${bookingDetail.booking.coi_fee_dollars}</span>
                      </div>
                    )}
                    {bookingDetail.booking.organizing_total_dollars > 0 && (
                      <div className="flex justify-between">
                        <span className="text-navy-600">Organizing Services:</span>
                        <span className="text-navy-900">+${bookingDetail.booking.organizing_total_dollars}</span>
                      </div>
                    )}
                    {bookingDetail.booking.geographic_surcharge_dollars > 0 && (
                      <div className="flex justify-between">
                        <span className="text-navy-600">Geographic Surcharge:</span>
                        <span className="text-navy-900">+${bookingDetail.booking.geographic_surcharge_dollars}</span>
                      </div>
                    )}
                    {bookingDetail.booking.time_window_surcharge_dollars > 0 && (
                      <div className="flex justify-between">
                        <span className="text-navy-600">Time Window Surcharge:</span>
                        <span className="text-navy-900">+${bookingDetail.booking.time_window_surcharge_dollars}</span>
                      </div>
                    )}

                    {/* Discount */}
                    {bookingDetail.booking.discount_amount_dollars > 0 && (
                      <>
                        <div className="flex justify-between border-t pt-2 mt-2">
                          <span className="text-navy-600">Subtotal:</span>
                          <span className="text-navy-900">${bookingDetail.booking.pre_discount_total_dollars}</span>
                        </div>
                        <div className="flex justify-between">
                          <span className="text-green-700">
                            Discount ({bookingDetail.booking.discount_description || bookingDetail.booking.discount_code_name}):
                          </span>
                          <span className="text-green-700">-${bookingDetail.booking.discount_amount_dollars}</span>
                        </div>
                      </>
                    )}
                  </div>

                  {/* Total */}
                  <div className="flex justify-between text-lg font-semibold border-t pt-2">
                    <span>Total:</span>
                    <span>${bookingDetail.booking.total_price_dollars}</span>
                  </div>

                  <div className="text-xs text-navy-600 pt-3 border-t">
                    <p>Created: {new Date(bookingDetail.booking.created_at).toLocaleString()}</p>
                    <p>Updated: {new Date(bookingDetail.booking.updated_at).toLocaleString()}</p>
                  </div>
                </div>
              </CardContent>
            </Card>
          )}
        </div>

        {/* Footer Actions */}
        <div className="flex justify-end space-x-3 pt-4 border-t">
          <Button variant="outline" onClick={onClose}>
            Cancel
          </Button>
          <Button 
            variant="primary" 
            onClick={handleSave}
            disabled={updateBookingMutation.isPending}
          >
            {updateBookingMutation.isPending ? 'Saving...' : 'Save Changes'}
          </Button>
        </div>
      </div>
    </Modal>
  );
}
```

# ──── frontend/src/components/staff/booking-management.tsx ────

```tsx
// frontend/src/components/staff/booking-management.tsx
'use client';

import { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { apiClient } from '@/lib/api-client';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Select } from '@/components/ui/select';
import { useRouter } from 'next/navigation';
import { useDebounce } from '@/hooks/use-debounce';

interface BookingListItem {
  id: string;
  booking_number: string;
  customer_name: string;
  customer_email: string;
  service_type: string;
  pickup_date: string;
  pickup_time: string;
  status: string;
  total_price_dollars: number;
  payment_status: string;
  created_at: string;
  coi_required: boolean;
}

interface BookingFilters {
  status?: string;
  date?: string;
  search?: string;
}

export function BookingManagement() {
  const router = useRouter();
  const queryClient = useQueryClient();
  const [filters, setFilters] = useState<BookingFilters>({});
  const debouncedSearch = useDebounce(filters.search, 300);

  const { data: bookingData, isLoading, error } = useQuery({
    queryKey: ['staff', 'bookings', { ...filters, search: debouncedSearch }],
    queryFn: async () => {
      const params = new URLSearchParams();
      if (filters.status) params.append('status', filters.status);
      if (filters.date) params.append('date', filters.date);
      if (debouncedSearch) params.append('search', debouncedSearch);
      
      const response = await apiClient.get(`/api/staff/bookings/?${params}`);
      return response.data;
    },
  });

  const updateStatusMutation = useMutation({
    mutationFn: async ({ bookingId, status, notes }: { bookingId: string; status: string; notes?: string }) => {
      const response = await apiClient.patch(`/api/staff/bookings/${bookingId}/`, {
        status,
        staff_notes: notes
      });
      return response.data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['staff', 'bookings'] });
      queryClient.invalidateQueries({ queryKey: ['staff', 'dashboard'] });
    }
  });

  const handleStatusUpdate = (bookingId: string, newStatus: string) => {
    const notes = prompt('Optional notes for this status change:');
    updateStatusMutation.mutate({ bookingId, status: newStatus, notes: notes || undefined });
  };

  const statusOptions = [
    { value: '', label: 'All Status' },
    { value: 'pending', label: 'Pending' },
    { value: 'confirmed', label: 'Confirmed' },
    { value: 'paid', label: 'Paid' },
    { value: 'completed', label: 'Completed' },
    { value: 'cancelled', label: 'Cancelled' },
  ];

  if (isLoading) {
    return (
      <div className="space-y-4">
        {[...Array(5)].map((_, i) => (
          <Card key={i} className="animate-pulse">
            <CardContent className="p-6">
              <div className="h-4 bg-gray-200 rounded mb-2"></div>
              <div className="h-8 bg-gray-200 rounded"></div>
            </CardContent>
          </Card>
        ))}
      </div>
    );
  }

  if (error) {
    return (
      <Card>
        <CardContent className="p-6 text-center">
          <p className="text-red-600">Failed to load bookings</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-serif font-bold text-navy-900">
          Booking Management
        </h1>
        <p className="text-navy-600">
          {bookingData?.total_count || 0} total bookings
        </p>
      </div>

      {/* Filters */}
      <Card>
        <CardContent className="p-4">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <Input
              placeholder="Search by booking #, name, or email"
              value={filters.search || ''}
              onChange={(e) => setFilters(prev => ({ ...prev, search: e.target.value }))}
            />
            <Select
              options={statusOptions}
              value={filters.status || ''}
              onChange={(e) => setFilters(prev => ({ ...prev, status: e.target.value }))}
              placeholder="Filter by status"
            />
            <Input
              type="date"
              value={filters.date || ''}
              onChange={(e) => setFilters(prev => ({ ...prev, date: e.target.value }))}
            />
            <Button
              variant="outline"
              onClick={() => setFilters({})}
            >
              Clear Filters
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* Bookings List */}
      <div className="space-y-4">
        {bookingData?.bookings?.map((booking: BookingListItem) => (
          <Card key={booking.id}>
            <CardContent className="p-6">
              <div className="flex flex-col lg:flex-row lg:items-center justify-between space-y-4 lg:space-y-0">
                {/* Booking Info */}
                <div className="flex-1">
                  <div className="flex items-center space-x-4 mb-2">
                    <h3 className="font-semibold text-navy-900">
                      #{booking.booking_number}
                    </h3>
                    <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                      booking.status === 'completed' 
                        ? 'bg-green-100 text-green-800'
                        : booking.status === 'paid'
                        ? 'bg-blue-100 text-blue-800'
                        : booking.status === 'confirmed'
                        ? 'bg-purple-100 text-purple-800'
                        : booking.status === 'pending'
                        ? 'bg-amber-100 text-amber-800'
                        : 'bg-red-100 text-red-800'
                    }`}>
                      {booking.status}
                    </span>
                    {booking.coi_required && (
                      <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                        COI Required
                      </span>
                    )}
                  </div>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-navy-600">
                    <div>
                      <p><strong>Customer:</strong> {booking.customer_name}</p>
                      <p><strong>Email:</strong> {booking.customer_email}</p>
                      <p><strong>Service:</strong> {booking.service_type}</p>
                    </div>
                    <div>
                      <p><strong>Pickup Date:</strong> {new Date(booking.pickup_date + 'T00:00:00').toLocaleDateString()}</p>
                      <p><strong>Pickup Time:</strong> {booking.pickup_time}</p>
                      <p><strong>Total:</strong> ${booking.total_price_dollars}</p>
                    </div>
                  </div>
                </div>

                {/* Actions */}
                <div className="flex flex-col space-y-2 lg:ml-6">
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => router.push(`/staff/bookings/${booking.id}`)}
                  >
                    View Details
                  </Button>
                  
                  {booking.status !== 'completed' && booking.status !== 'cancelled' && (
                    <div className="flex space-x-2">
                      {booking.status === 'pending' && (
                        <Button
                          variant="primary"
                          size="sm"
                          onClick={() => handleStatusUpdate(booking.id, 'confirmed')}
                          disabled={updateStatusMutation.isPending}
                        >
                          Confirm
                        </Button>
                      )}
                      {(booking.status === 'confirmed' || booking.status === 'paid') && (
                        <Button
                          variant="primary"
                          size="sm"
                          onClick={() => handleStatusUpdate(booking.id, 'completed')}
                          disabled={updateStatusMutation.isPending}
                        >
                          Complete
                        </Button>
                      )}
                    </div>
                  )}
                </div>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>

      {bookingData?.bookings?.length === 0 && (
        <Card>
          <CardContent className="p-12 text-center">
            <p className="text-navy-600">No bookings found with current filters</p>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
```

# ──── frontend/src/components/staff/customer-management.tsx ────

```tsx
// frontend/src/components/staff/customer-management.tsx
'use client';

import { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { apiClient } from '@/lib/api-client';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Select } from '@/components/ui/select';
import { useDebounce } from '@/hooks/use-debounce';
import {
  MagnifyingGlassIcon,
  StarIcon,
  PhoneIcon,
  EnvelopeIcon,
  MapPinIcon,
  PencilIcon,
  CheckIcon,
  XMarkIcon
} from '@heroicons/react/24/outline';

interface CustomerProfile {
  id: string;
  name: string;
  email: string;
  phone: string;
  is_vip: boolean;
  total_bookings: number;
  total_spent_dollars: number;
  last_booking_at: string | null;
  created_at: string;
  notes: string;
  recent_bookings: Array<{
    id: string;
    booking_number: string;
    service_type: string;
    status: string;
    total_price_dollars: number;
    created_at: string;
  }>;
  saved_addresses: Array<{
    id: string;
    address_line_1: string;
    city: string;
    state: string;
    is_primary: boolean;
  }>;
}

export function CustomerManagement() {
  const [searchTerm, setSearchTerm] = useState('');
  const debouncedSearch = useDebounce(searchTerm, 300);
  const [vipFilter, setVipFilter] = useState('');
  const [selectedCustomer, setSelectedCustomer] = useState<string | null>(null);

  const { data: customersData, isLoading } = useQuery({
    queryKey: ['staff', 'customers', debouncedSearch, vipFilter],
    queryFn: async () => {
      const params = new URLSearchParams();
      if (debouncedSearch) params.append('search', debouncedSearch);
      if (vipFilter) params.append('vip', vipFilter);
      
      const response = await apiClient.get(`/api/staff/customers/?${params}`);
      return response.data;
    }
  });

  const { data: customerDetail } = useQuery({
    queryKey: ['staff', 'customer', selectedCustomer],
    queryFn: async (): Promise<CustomerProfile> => {
      const response = await apiClient.get(`/api/staff/customers/${selectedCustomer}/`);
      return response.data;
    },
    enabled: !!selectedCustomer
  });

  const vipOptions = [
    { value: '', label: 'All Customers' },
    { value: 'true', label: 'VIP Only' },
    { value: 'false', label: 'Standard Only' }
  ];

  if (isLoading) {
    return (
      <div className="flex justify-center items-center h-96">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-navy-900"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-serif font-bold text-navy-900">
          Customer Management
        </h1>
        <p className="text-navy-600">
          {customersData?.total_count || 0} customers
        </p>
      </div>

      {/* Search and Filters */}
      <Card>
        <CardContent className="p-4">
          <div className="flex space-x-4">
            <div className="flex-1 relative">
              <MagnifyingGlassIcon className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
              <Input
                placeholder="Search customers by name or email"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="pl-10"
              />
            </div>
            <Select
              options={vipOptions}
              value={vipFilter}
              onChange={(e) => setVipFilter(e.target.value)}
              className="w-48"
            />
          </div>
        </CardContent>
      </Card>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Customer List */}
        <div className="lg:col-span-2 space-y-4">
          {customersData?.customers?.map((customer: any) => (
            <Card 
              key={customer.id} 
              className={`cursor-pointer transition-all hover:shadow-md ${
                selectedCustomer === customer.id ? 'ring-2 ring-navy-500' : ''
              }`}
              onClick={() => setSelectedCustomer(customer.id)}
            >
              <CardContent className="p-6">
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center space-x-2 mb-2">
                      <h3 className="font-semibold text-navy-900">{customer.name}</h3>
                      {customer.is_vip && (
                        <StarIcon className="h-4 w-4 text-gold-500 fill-current" />
                      )}
                    </div>
                    
                    <div className="space-y-1 text-sm text-navy-600">
                      <div className="flex items-center space-x-2">
                        <EnvelopeIcon className="h-4 w-4" />
                        <span>{customer.email}</span>
                      </div>
                      {customer.phone && (
                        <div className="flex items-center space-x-2">
                          <PhoneIcon className="h-4 w-4" />
                          <span>{customer.phone}</span>
                        </div>
                      )}
                    </div>
                  </div>
                  
                  <div className="text-right">
                    <div className="text-lg font-semibold text-navy-900">
                      ${customer.total_spent_dollars?.toLocaleString() || 0}
                    </div>
                    <div className="text-sm text-navy-600">
                      {customer.total_bookings || 0} bookings
                    </div>
                    {customer.last_booking_at && (
                      <div className="text-xs text-navy-500">
                        Last: {new Date(customer.last_booking_at).toLocaleDateString()}
                      </div>
                    )}
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>

        {/* Customer Detail Panel */}
        <div className="space-y-6">
          {selectedCustomer && customerDetail ? (
            <CustomerDetailPanel customer={customerDetail} />
          ) : (
            <Card>
              <CardContent className="p-6 text-center text-gray-500">
                Select a customer to view details
              </CardContent>
            </Card>
          )}
        </div>
      </div>
    </div>
  );
}

function CustomerDetailPanel({ customer }: { customer: CustomerProfile }) {
  const [isEditingNotes, setIsEditingNotes] = useState(false);
  const [notesValue, setNotesValue] = useState(customer.notes || '');
  const queryClient = useQueryClient();

  const updateNotesMutation = useMutation({
    mutationFn: async (notes: string) => {
      const response = await apiClient.patch(`/api/customer/${customer.id}/notes/`, {
        notes
      });
      return response.data;
    },
    onSuccess: () => {
      // Refresh customer detail
      queryClient.invalidateQueries({ queryKey: ['staff', 'customer', customer.id] });
      setIsEditingNotes(false);
    },
    onError: (error) => {
      console.error('Failed to update notes:', error);
      alert('Failed to update notes. Please try again.');
    }
  });

  const handleSaveNotes = () => {
    updateNotesMutation.mutate(notesValue);
  };

  const handleCancelNotes = () => {
    setNotesValue(customer.notes || '');
    setIsEditingNotes(false);
  };

  return (
    <div className="space-y-6">
      {/* Customer Overview */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <h3 className="text-lg font-medium">Customer Details</h3>
            {customer.is_vip && (
              <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gold-100 text-gold-800">
                <StarIcon className="h-3 w-3 mr-1 fill-current" />
                VIP Member
              </span>
            )}
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <h4 className="font-medium text-navy-900">{customer.name}</h4>
            <p className="text-sm text-navy-600">{customer.email}</p>
            {customer.phone && <p className="text-sm text-navy-600">{customer.phone}</p>}
          </div>
          
          <div className="grid grid-cols-2 gap-4 text-center">
            <div>
              <div className="text-2xl font-bold text-navy-900">{customer.total_bookings}</div>
              <div className="text-sm text-navy-600">Total Bookings</div>
            </div>
            <div>
              <div className="text-2xl font-bold text-green-600">
                ${customer.total_spent_dollars?.toLocaleString() || 0}
              </div>
              <div className="text-sm text-navy-600">Total Spent</div>
            </div>
          </div>
          
          <div className="text-sm text-navy-600">
            <strong>Member since:</strong> {new Date(customer.created_at).toLocaleDateString()}
          </div>
        </CardContent>
      </Card>

      {/* Staff Notes - NEW */}
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <h3 className="text-lg font-medium">Staff Notes</h3>
            {!isEditingNotes && (
              <Button
                variant="ghost"
                size="sm"
                onClick={() => setIsEditingNotes(true)}
              >
                <PencilIcon className="h-4 w-4 mr-1" />
                Edit
              </Button>
            )}
          </div>
        </CardHeader>
        <CardContent>
          {isEditingNotes ? (
            <div className="space-y-3">
              <textarea
                value={notesValue}
                onChange={(e) => setNotesValue(e.target.value)}
                placeholder="Add notes about customer preferences, special requests, VIP details, etc."
                className="w-full p-3 border border-gray-300 rounded-lg resize-vertical min-h-[100px] text-navy-900"
                rows={4}
              />
              <div className="flex space-x-2">
                <Button
                  variant="primary"
                  size="sm"
                  onClick={handleSaveNotes}
                  disabled={updateNotesMutation.isPending}
                >
                  <CheckIcon className="h-4 w-4 mr-1" />
                  {updateNotesMutation.isPending ? 'Saving...' : 'Save'}
                </Button>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={handleCancelNotes}
                  disabled={updateNotesMutation.isPending}
                >
                  <XMarkIcon className="h-4 w-4 mr-1" />
                  Cancel
                </Button>
              </div>
            </div>
          ) : (
            <div className="min-h-[60px]">
              {customer.notes ? (
                <p className="text-navy-700 whitespace-pre-wrap">{customer.notes}</p>
              ) : (
                <p className="text-gray-500 italic">No notes added yet. Click Edit to add customer notes.</p>
              )}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Recent Bookings */}
      <Card>
        <CardHeader>
          <h3 className="text-lg font-medium">Recent Bookings</h3>
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            {customer.recent_bookings?.slice(0, 5).map(booking => (
              <div key={booking.id} className="flex justify-between items-center p-3 bg-cream-50 rounded-lg">
                <div>
                  <div className="font-medium text-navy-900">#{booking.booking_number}</div>
                  <div className="text-sm text-navy-600">{booking.service_type}</div>
                </div>
                <div className="text-right">
                  <div className="font-medium">${booking.total_price_dollars}</div>
                  <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                    booking.status === 'completed' ? 'bg-green-100 text-green-800' : 'bg-amber-100 text-amber-800'
                  }`}>
                    {booking.status}
                  </span>
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      {/* Saved Addresses */}
      {customer.saved_addresses?.length > 0 && (
        <Card>
          <CardHeader>
            <h3 className="text-lg font-medium">Saved Addresses</h3>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {customer.saved_addresses.map(address => (
                <div key={address.id} className="flex items-start space-x-3 p-3 bg-cream-50 rounded-lg">
                  <MapPinIcon className="h-4 w-4 text-navy-600 mt-1 flex-shrink-0" />
                  <div>
                    <div className="font-medium text-navy-900">{address.address_line_1}</div>
                    <div className="text-sm text-navy-600">
                      {address.city}, {address.state}
                    </div>
                    {address.is_primary && (
                      <span className="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-navy-100 text-navy-800 mt-1">
                        Primary
                      </span>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
```

# ──── frontend/src/components/staff/index.ts ────

```typescript
// frontend/src/components/staff/index.ts
export { StaffLoginForm } from './staff-login-form';
export { StaffDashboardOverview } from './staff-dashboard-overview';
export { BookingManagement } from './booking-management';
export { BookingCalendar } from './booking-calendar';
export { BookingDetailModal } from './booking-detail-modal';
export { CustomerManagement } from './customer-management';
export { StaffLayout } from './staff-layout';
export { RefundModal } from './refund-modal';
export { LogisticsManagement } from './logistics-management';
```

# ──── frontend/src/components/staff/logistics-management.tsx ────

```tsx
// frontend/src/components/staff/logistics-management.tsx
'use client';

import { useState } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { apiClient } from '@/lib/api-client';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  TruckIcon,
  ClockIcon,
  CheckCircleIcon,
  ArrowPathIcon,
  MapPinIcon,
  PhoneIcon,
  CalendarIcon,
  PlusIcon,
  XCircleIcon,
} from '@heroicons/react/24/outline';

interface OnfleetTask {
  id: string;
  booking_number: string;
  customer_name: string;
  task_type: 'pickup' | 'dropoff';
  onfleet_task_id: string;
  onfleet_short_id: string;
  tracking_url: string;
  recipient_name: string;
  recipient_phone: string;
  status: 'created' | 'assigned' | 'active' | 'completed' | 'failed' | 'deleted';
  worker_name: string;
  worker_id?: string;
  estimated_arrival?: string | null;
  completed_at?: string | null;
  started_at?: string | null;
  created_at: string;
  last_synced?: string | null;
  environment: 'sandbox' | 'production';
  linked_to?: string | null;
}

interface LogisticsSummary {
  active_tasks: number;
  tasks_today: number;
  completed_today: number;
  pending_tasks: number;
  completion_rate: number;
  onfleet_stats: {
    active_tasks: number;
    available_workers: number;
    organization_name: string;
  };
  integration_stats: {
    tasks_created_today: number;
    pickup_tasks: number;
    dropoff_tasks: number;
  };
  environment: 'sandbox' | 'production';
  mock_mode: boolean;
}

interface TasksResponse {
  success: boolean;
  tasks: OnfleetTask[];  // Backend returns 'tasks' not 'results'
  count: number;
}

interface TaskFilters {
  status: string;
  task_type: string;
  date: string;
  search: string;
}

export function LogisticsManagement() {
  const queryClient = useQueryClient();
  const [filters, setFilters] = useState<TaskFilters>({
    status: '',
    task_type: '',
    date: '',
    search: '',
  });
  const [selectedTask, setSelectedTask] = useState<OnfleetTask | null>(null);
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [createBookingId, setCreateBookingId] = useState('');

  const { data: summary, isLoading: summaryLoading } = useQuery({
    queryKey: ['staff', 'logistics', 'summary'],
    queryFn: async (): Promise<LogisticsSummary> => {
      const response = await apiClient.get('/api/staff/logistics/summary/');
      return response.data.data;
    },
    refetchInterval: 30000,
  });

  const { data: tasksData, isLoading: tasksLoading } = useQuery<TasksResponse>({
    queryKey: ['staff', 'logistics', 'tasks', filters],
    queryFn: async () => {
      const params = new URLSearchParams();
      if (filters.status) params.append('status', filters.status);
      if (filters.task_type) params.append('task_type', filters.task_type);
      if (filters.date) params.append('date', filters.date);
      if (filters.search) params.append('search', filters.search);

      const response = await apiClient.get(`/api/staff/logistics/tasks/?${params}`);
      return response.data;
    },
    refetchInterval: 30000,
  });

  const syncMutation = useMutation({
    mutationFn: async () => {
      const response = await apiClient.post('/api/staff/logistics/sync/');
      return response.data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['staff', 'logistics'] });
    },
  });

  const createTaskMutation = useMutation({
    mutationFn: async (bookingId: string) => {
      const response = await apiClient.post('/api/staff/logistics/create-task/', {
        booking_id: bookingId,
      });
      return response.data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['staff', 'logistics'] });
      setShowCreateModal(false);
      setCreateBookingId('');
    },
  });

  const handleSync = () => {
    syncMutation.mutate();
  };

  const handleCreateTask = () => {
    if (createBookingId.trim()) {
      createTaskMutation.mutate(createBookingId);
    }
  };

  const getStatusBadge = (status: string) => {
    const badges = {
      created: 'bg-gray-100 text-gray-800',
      assigned: 'bg-blue-100 text-blue-800',
      active: 'bg-amber-100 text-amber-800',
      completed: 'bg-green-100 text-green-800',
      failed: 'bg-red-100 text-red-800',
      deleted: 'bg-gray-100 text-gray-500',
    };
    return badges[status as keyof typeof badges] || badges.created;
  };

  const getTaskTypeIcon = (taskType: string) => {
    return taskType === 'pickup' ? (
      <MapPinIcon className="w-5 h-5 text-blue-600" />
    ) : (
      <TruckIcon className="w-5 h-5 text-green-600" />
    );
  };

  if (summaryLoading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-navy-900"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-2xl font-serif font-bold text-navy-900">
            Logistics Management
          </h1>
          <p className="text-navy-600 mt-1">
            Real-time delivery tracking and task management
          </p>
        </div>
        <div className="flex gap-3">
          <Button
            variant="outline"
            size="sm"
            onClick={handleSync}
            disabled={syncMutation.isPending}
          >
            <ArrowPathIcon className={`w-4 h-4 mr-2 ${syncMutation.isPending ? 'animate-spin' : ''}`} />
            {syncMutation.isPending ? 'Syncing...' : 'Sync Status'}
          </Button>
          <Button
            variant="primary"
            size="sm"
            onClick={() => setShowCreateModal(true)}
          >
            <PlusIcon className="w-4 h-4 mr-2" />
            Create Task
          </Button>
        </div>
      </div>

      {/* Environment Badge */}
      {summary && (
        <div className="flex items-center gap-2 text-sm">
          <span className={`px-3 py-1 rounded-full font-medium ${
            summary.environment === 'production'
              ? 'bg-red-100 text-red-800'
              : 'bg-blue-100 text-blue-800'
          }`}>
            {summary.environment.toUpperCase()}
          </span>
          {summary.mock_mode && (
            <span className="px-3 py-1 rounded-full bg-amber-100 text-amber-800 font-medium">
              MOCK MODE
            </span>
          )}
        </div>
      )}

      {/* Statistics Grid */}
      {summary && (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-navy-600">Active Tasks</p>
                  <p className="text-3xl font-bold text-navy-900 mt-2">
                    {summary.active_tasks}
                  </p>
                </div>
                <div className="p-3 bg-blue-100 rounded-lg">
                  <TruckIcon className="w-6 h-6 text-blue-600" />
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-navy-600">Today&apos;s Deliveries</p>
                  <p className="text-3xl font-bold text-navy-900 mt-2">
                    {summary.tasks_today}
                  </p>
                </div>
                <div className="p-3 bg-green-100 rounded-lg">
                  <CalendarIcon className="w-6 h-6 text-green-600" />
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-navy-600">Completed Today</p>
                  <p className="text-3xl font-bold text-navy-900 mt-2">
                    {summary.completed_today}
                  </p>
                </div>
                <div className="p-3 bg-green-100 rounded-lg">
                  <CheckCircleIcon className="w-6 h-6 text-green-600" />
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-navy-600">Completion Rate</p>
                  <p className="text-3xl font-bold text-navy-900 mt-2">
                    {summary.completion_rate}%
                  </p>
                </div>
                <div className="p-3 bg-amber-100 rounded-lg">
                  <ClockIcon className="w-6 h-6 text-amber-600" />
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Onfleet Integration Stats */}
      {summary?.onfleet_stats && (
        <Card>
          <CardHeader>
            <h2 className="text-lg font-semibold text-navy-900">Onfleet Integration</h2>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <p className="text-sm text-navy-600">Organization</p>
                <p className="text-lg font-semibold text-navy-900 mt-1">
                  {summary.onfleet_stats.organization_name}
                </p>
              </div>
              <div>
                <p className="text-sm text-navy-600">Available Workers</p>
                <p className="text-lg font-semibold text-navy-900 mt-1">
                  {summary.onfleet_stats.available_workers}
                </p>
              </div>
              <div>
                <p className="text-sm text-navy-600">Tasks Today</p>
                <p className="text-lg font-semibold text-navy-900 mt-1">
                  {summary.integration_stats.pickup_tasks + summary.integration_stats.dropoff_tasks}
                  <span className="text-sm text-navy-500 ml-2">
                    ({summary.integration_stats.pickup_tasks} pickup, {summary.integration_stats.dropoff_tasks} dropoff)
                  </span>
                </p>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Filters */}
      <Card>
        <CardContent className="p-4">
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <Input
              type="text"
              placeholder="Search booking number..."
              value={filters.search}
              onChange={(e) => setFilters({ ...filters, search: e.target.value })}
            />
            <select
              value={filters.status}
              onChange={(e) => setFilters({ ...filters, status: e.target.value })}
              className="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-navy-500"
            >
              <option value="">All Statuses</option>
              <option value="created">Created</option>
              <option value="assigned">Assigned</option>
              <option value="active">Active</option>
              <option value="completed">Completed</option>
              <option value="failed">Failed</option>
            </select>
            <select
              value={filters.task_type}
              onChange={(e) => setFilters({ ...filters, task_type: e.target.value })}
              className="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-navy-500"
            >
              <option value="">All Task Types</option>
              <option value="pickup">Pickup</option>
              <option value="dropoff">Dropoff</option>
            </select>
            <Input
              type="date"
              value={filters.date}
              onChange={(e) => setFilters({ ...filters, date: e.target.value })}
            />
          </div>
        </CardContent>
      </Card>

      {/* Tasks List */}
      <Card>
        <CardHeader>
          <div className="flex justify-between items-center">
            <h2 className="text-lg font-semibold text-navy-900">Active Tasks</h2>
            {tasksData && (
              <span className="text-sm text-navy-600">
                {tasksData.count} tasks
              </span>
            )}
          </div>
        </CardHeader>
        <CardContent>
          {tasksLoading ? (
            <div className="flex justify-center py-8">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-navy-900"></div>
            </div>
          ) : !tasksData?.tasks || tasksData.tasks.length === 0 ? (
            <div className="text-center py-8 text-navy-600">
              No tasks found matching your filters.
            </div>
          ) : (
            <div className="space-y-3">
              {tasksData.tasks.map((task: OnfleetTask) => (
                <div
                  key={task.id}
                  className="p-4 border border-gray-200 rounded-lg hover:border-navy-300 transition-colors cursor-pointer"
                  onClick={() => setSelectedTask(task)}
                >
                  <div className="flex items-start justify-between">
                    <div className="flex items-start gap-3 flex-1">
                      <div className="mt-1">
                        {getTaskTypeIcon(task.task_type)}
                      </div>
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-2">
                          <span className="font-semibold text-navy-900">
                            #{task.booking_number}
                          </span>
                          <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${getStatusBadge(task.status)}`}>
                            {task.status}
                          </span>
                          <span className="text-xs text-navy-600 bg-gray-100 px-2 py-0.5 rounded">
                            {task.task_type}
                          </span>
                        </div>
                        <div className="space-y-1 text-sm">
                          <p className="text-navy-900 font-medium">
                            {task.customer_name}
                          </p>
                          {task.recipient_name && (
                            <div className="flex items-center gap-2 text-navy-600">
                              <PhoneIcon className="w-4 h-4" />
                              <span>{task.recipient_name} - {task.recipient_phone}</span>
                            </div>
                          )}
                          {task.worker_name && (
                            <p className="text-navy-600">
                              Driver: {task.worker_name}
                            </p>
                          )}
                          {task.estimated_arrival && (
                            <div className="flex items-center gap-2 text-navy-600">
                              <ClockIcon className="w-4 h-4" />
                              <span>ETA: {new Date(task.estimated_arrival).toLocaleString()}</span>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                    <div className="flex flex-col items-end gap-2">
                      {task.tracking_url && (
                        <a
                          href={task.tracking_url}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="text-sm text-navy-600 hover:text-navy-900 underline"
                          onClick={(e) => e.stopPropagation()}
                        >
                          Track
                        </a>
                      )}
                      <span className="text-xs text-navy-500">
                        {new Date(task.created_at).toLocaleDateString()}
                      </span>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </CardContent>
      </Card>

      {/* Create Task Modal */}
      {showCreateModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <Card className="w-full max-w-md">
            <CardHeader>
              <h2 className="text-xl font-semibold text-navy-900">Create Manual Task</h2>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-navy-700 mb-2">
                    Booking ID
                  </label>
                  <Input
                    type="text"
                    placeholder="Enter booking ID or number..."
                    value={createBookingId}
                    onChange={(e) => setCreateBookingId(e.target.value)}
                  />
                  <p className="text-xs text-navy-600 mt-1">
                    This will create both pickup and dropoff tasks for the booking.
                  </p>
                </div>

                {createTaskMutation.isError && (
                  <div className="p-3 bg-red-50 border border-red-200 rounded-lg">
                    <p className="text-sm text-red-800">
                      {(createTaskMutation.error as any)?.response?.data?.error || 'Failed to create task'}
                    </p>
                  </div>
                )}

                <div className="flex justify-end gap-3 pt-4">
                  <Button
                    variant="outline"
                    onClick={() => {
                      setShowCreateModal(false);
                      setCreateBookingId('');
                    }}
                    disabled={createTaskMutation.isPending}
                  >
                    Cancel
                  </Button>
                  <Button
                    variant="primary"
                    onClick={handleCreateTask}
                    disabled={createTaskMutation.isPending || !createBookingId.trim()}
                  >
                    {createTaskMutation.isPending ? 'Creating...' : 'Create Tasks'}
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Task Detail Modal */}
      {selectedTask && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <Card className="w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <CardHeader>
              <div className="flex justify-between items-start">
                <div>
                  <h2 className="text-xl font-semibold text-navy-900">
                    Task Details
                  </h2>
                  <p className="text-navy-600 mt-1">
                    Booking #{selectedTask.booking_number}
                  </p>
                </div>
                <button
                  onClick={() => setSelectedTask(null)}
                  className="text-navy-600 hover:text-navy-900"
                >
                  <XCircleIcon className="w-6 h-6" />
                </button>
              </div>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm font-medium text-navy-700">Task Type</p>
                    <p className="text-navy-900 mt-1 capitalize">{selectedTask.task_type}</p>
                  </div>
                  <div>
                    <p className="text-sm font-medium text-navy-700">Status</p>
                    <span className={`inline-block px-2 py-1 rounded-full text-xs font-medium mt-1 ${getStatusBadge(selectedTask.status)}`}>
                      {selectedTask.status}
                    </span>
                  </div>
                </div>

                <div>
                  <p className="text-sm font-medium text-navy-700">Customer</p>
                  <p className="text-navy-900 mt-1">{selectedTask.customer_name}</p>
                </div>

                {selectedTask.recipient_name && (
                  <div>
                    <p className="text-sm font-medium text-navy-700">Recipient</p>
                    <p className="text-navy-900 mt-1">
                      {selectedTask.recipient_name} - {selectedTask.recipient_phone}
                    </p>
                  </div>
                )}

                {selectedTask.worker_name && (
                  <div>
                    <p className="text-sm font-medium text-navy-700">Assigned Driver</p>
                    <p className="text-navy-900 mt-1">{selectedTask.worker_name}</p>
                  </div>
                )}

                {selectedTask.estimated_arrival && (
                  <div>
                    <p className="text-sm font-medium text-navy-700">Estimated Arrival</p>
                    <p className="text-navy-900 mt-1">
                      {new Date(selectedTask.estimated_arrival).toLocaleString()}
                    </p>
                  </div>
                )}

                {selectedTask.started_at && (
                  <div>
                    <p className="text-sm font-medium text-navy-700">Started At</p>
                    <p className="text-navy-900 mt-1">
                      {new Date(selectedTask.started_at).toLocaleString()}
                    </p>
                  </div>
                )}

                {selectedTask.completed_at && (
                  <div>
                    <p className="text-sm font-medium text-navy-700">Completed At</p>
                    <p className="text-navy-900 mt-1">
                      {new Date(selectedTask.completed_at).toLocaleString()}
                    </p>
                  </div>
                )}

                <div>
                  <p className="text-sm font-medium text-navy-700">Created At</p>
                  <p className="text-navy-900 mt-1">
                    {new Date(selectedTask.created_at).toLocaleString()}
                  </p>
                </div>

                <div>
                  <p className="text-sm font-medium text-navy-700">Environment</p>
                  <span className={`inline-block px-2 py-1 rounded-full text-xs font-medium mt-1 ${
                    selectedTask.environment === 'production'
                      ? 'bg-red-100 text-red-800'
                      : 'bg-blue-100 text-blue-800'
                  }`}>
                    {selectedTask.environment.toUpperCase()}
                  </span>
                </div>

                {selectedTask.tracking_url && (
                  <div className="pt-4 border-t">
                    <a
                      href={selectedTask.tracking_url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="inline-flex items-center gap-2 text-navy-600 hover:text-navy-900 font-medium"
                    >
                      <MapPinIcon className="w-5 h-5" />
                      View Live Tracking
                    </a>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>
        </div>
      )}
    </div>
  );
}
```

# ──── frontend/src/components/staff/refund-modal.tsx ────

```tsx
'use client';
// frontend/src/components/staff/refund-modal.tsx

import { useState } from 'react';
import { useMutation, useQueryClient } from '@tanstack/react-query';
import { apiClient } from '@/lib/api-client';
import { Modal } from '@/components/ui/modal';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import type { Payment, Refund } from '@/types';

interface RefundModalProps {
  isOpen: boolean;
  onClose: () => void;
  payment: Payment;
  bookingNumber: string;
}

export function RefundModal({ isOpen, onClose, payment, bookingNumber }: RefundModalProps) {
  const queryClient = useQueryClient();
  const maxRefundable = payment.amount_dollars - (payment.total_refunded_dollars || 0);
  const [amount, setAmount] = useState(maxRefundable.toString());
  const [reason, setReason] = useState('');
  const [error, setError] = useState('');

  const refundMutation = useMutation({
    mutationFn: async (data: { payment_id: string; amount_cents: number; reason: string }) => {
      const response = await apiClient.post('/api/payments/refunds/process/', data);
      return response.data;
    },
    onSuccess: () => {
      queryClient.invalidateQueries({ queryKey: ['staff', 'booking'] });
      queryClient.invalidateQueries({ queryKey: ['staff', 'bookings'] });
      onClose();
      setAmount(maxRefundable.toString());
      setReason('');
      setError('');
    },
    onError: (error: any) => {
      setError(error.response?.data?.error || 'Failed to process refund');
    }
  });

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    setError('');

    const amountNum = parseFloat(amount);
    if (isNaN(amountNum) || amountNum <= 0) {
      setError('Invalid amount');
      return;
    }

    if (amountNum > maxRefundable) {
      setError(`Amount cannot exceed $${maxRefundable.toFixed(2)} (remaining refundable)`);
      return;
    }

    const amountCents = Math.round(amountNum * 100);

    refundMutation.mutate({
      payment_id: payment.id,
      amount_cents: amountCents,
      reason: reason.trim() || 'No reason provided'
    });
  };

  return (
    <Modal
      isOpen={isOpen}
      onClose={onClose}
      size="md"
      title={`Issue Refund - ${bookingNumber}`}
      description={`Payment: $${payment.amount_dollars}${(payment.total_refunded_dollars || 0) > 0 ? ` ($${payment.total_refunded_dollars?.toFixed(2)} already refunded)` : ''} (${payment.status})`}
    >
      <form onSubmit={handleSubmit} className="space-y-6">
        <div>
          <label className="block text-sm font-medium text-navy-900 mb-1">
            Refund Amount
          </label>
          <div className="relative">
            <span className="absolute left-3 top-2.5 text-navy-600">$</span>
            <Input
              type="number"
              step="0.01"
              min="0.01"
              max={maxRefundable}
              value={amount}
              onChange={(e) => setAmount(e.target.value)}
              className="pl-7"
              placeholder="0.00"
              required
            />
          </div>
          <p className="text-xs text-navy-500 mt-1">
            Maximum refundable: ${maxRefundable.toFixed(2)}
          </p>
        </div>

        <div>
          <label className="block text-sm font-medium text-navy-900 mb-1">
            Reason for Refund <span className="text-navy-500 font-normal">(optional)</span>
          </label>
          <textarea
            value={reason}
            onChange={(e) => setReason(e.target.value)}
            rows={4}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-navy-500 focus:border-navy-500 text-gray-900"
            placeholder="Enter reason for refund (optional)"
          />
        </div>

        {error && (
          <div className="bg-red-50 border border-red-200 rounded-md p-3">
            <p className="text-red-700 text-sm">{error}</p>
          </div>
        )}

        <div className="bg-amber-50 border border-amber-200 rounded-md p-3">
          <p className="text-amber-800 text-sm font-medium mb-1">Warning</p>
          <p className="text-amber-700 text-sm">
            This will immediately process a refund through Stripe. This action cannot be undone.
          </p>
        </div>

        <div className="flex justify-end space-x-3 pt-4 border-t">
          <Button
            type="button"
            variant="outline"
            onClick={onClose}
            disabled={refundMutation.isPending}
          >
            Cancel
          </Button>
          <Button
            type="submit"
            variant="primary"
            disabled={refundMutation.isPending}
          >
            {refundMutation.isPending ? 'Processing...' : 'Process Refund'}
          </Button>
        </div>
      </form>
    </Modal>
  );
}
```

# ──── frontend/src/components/staff/staff-dashboard-overview.tsx ────

```tsx
'use client';
// frontend/src/components/staff/staff-dashboard-overview.tsx
import { useQuery } from '@tanstack/react-query';
import { apiClient } from '@/lib/api-client';
import { useStaffAuthStore } from '@/stores/staff-auth-store';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { useRouter } from 'next/navigation';

interface StaffDashboardData {
  staff_info: {
    name: string;
    role: string;
    permissions: {
      can_approve_refunds: boolean;
      can_manage_staff: boolean;
      can_view_financial_reports: boolean;
    };
  };
  booking_stats: {
    total_bookings: number;
    pending_bookings: number;
    confirmed_bookings: number;
    paid_bookings: number;
    completed_bookings: number;
  };
  payment_stats: {
    total_payments: number;
    pending_payments: number;
    failed_payments: number;
    total_revenue_dollars: number;
  };
  customer_stats: {
    total_customers: number;
    vip_customers: number;
  };
  urgent_bookings: Array<{
    id: string;
    booking_number: string;
    customer_name: string;
    customer_email: string;
    service_type: string;
    pickup_date: string;
    status: string;
    total_price_dollars: number;
    created_at: string;
  }>;
}

export function StaffDashboardOverview() {
  const { staffProfile } = useStaffAuthStore();
  const router = useRouter();

  const { data: dashboardData, isLoading, isFetching, error, refetch } = useQuery({
    queryKey: ['staff', 'dashboard'],
    queryFn: async (): Promise<StaffDashboardData> => {
      const response = await apiClient.get('/api/staff/dashboard/');
      return response.data;
    },
    enabled: !!staffProfile,
    refetchInterval: 30000, // Refresh every 30 seconds
  });

  if (isLoading) {
    return (
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {[...Array(8)].map((_, i) => (
          <Card key={i} className="animate-pulse">
            <CardContent className="p-6">
              <div className="h-4 bg-gray-200 rounded mb-2"></div>
              <div className="h-8 bg-gray-200 rounded"></div>
            </CardContent>
          </Card>
        ))}
      </div>
    );
  }

  if (error) {
    return (
      <Card>
        <CardContent className="p-6 text-center">
          <p className="text-red-600">Failed to load dashboard data</p>
          <Button 
            variant="outline" 
            onClick={() => refetch()}
            className="mt-4"
          >
            Retry
          </Button>
        </CardContent>
      </Card>
    );
  }

  const bookingStats = dashboardData?.booking_stats;
  const paymentStats = dashboardData?.payment_stats;
  const customerStats = dashboardData?.customer_stats;

  // Helper function for payment success rate calculation
  const calculateSuccessRate = () => {
    if (!paymentStats) return '0%';
    const { total_payments = 0, failed_payments = 0 } = paymentStats;
    if (total_payments === 0 && failed_payments === 0) return '0%';
    const successRate = Math.round((total_payments / (total_payments + failed_payments)) * 100);
    return `${successRate}%`;
  };

  return (
    <div className="space-y-6">
      {/* Welcome Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-2xl font-serif font-bold text-navy-900">
            Operations Dashboard
          </h1>
          <p className="text-navy-600">
            Welcome back, {dashboardData?.staff_info?.name || 'Staff'} ({dashboardData?.staff_info?.role || 'staff'})
          </p>
        </div>
        <div className="flex space-x-2">
          <Button 
            variant="outline"
            onClick={() => router.push('/staff/bookings')}
          >
            All Bookings
          </Button>
          <Button
            variant="primary"
            onClick={() => refetch()}
            disabled={isFetching}
          >
            {isFetching ? 'Refreshing...' : 'Refresh Data'}
          </Button>
        </div>
      </div>

      {/* Key Metrics */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        {/* Booking Metrics */}
        <Card>
          <CardHeader>
            <h3 className="text-sm font-medium text-navy-600">Total Bookings</h3>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-navy-900">
              {bookingStats?.total_bookings || 0}
            </div>
            <p className="text-xs text-navy-600">All time</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <h3 className="text-sm font-medium text-navy-600">Pending Actions</h3>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-amber-600">
              {(bookingStats?.pending_bookings || 0) + (bookingStats?.confirmed_bookings || 0)}
            </div>
            <p className="text-xs text-navy-600">Need attention</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <h3 className="text-sm font-medium text-navy-600">Revenue</h3>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-green-600">
              ${paymentStats?.total_revenue_dollars?.toLocaleString() || 0}
            </div>
            <p className="text-xs text-navy-600">Total processed</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <h3 className="text-sm font-medium text-navy-600">VIP Customers</h3>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold text-gold-600">
              {customerStats?.vip_customers || 0}
            </div>
            <p className="text-xs text-navy-600">
              of {customerStats?.total_customers || 0} total
            </p>
          </CardContent>
        </Card>
      </div>

      {/* Detailed Stats Grid */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Booking Status Breakdown */}
        <Card>
          <CardHeader>
            <h3 className="text-lg font-medium text-navy-900">Booking Status</h3>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              <div className="flex justify-between items-center">
                <span className="text-sm text-navy-600">Pending</span>
                <span className="font-medium text-amber-600">
                  {bookingStats?.pending_bookings || 0}
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-sm text-navy-600">Confirmed</span>
                <span className="font-medium text-blue-600">
                  {bookingStats?.confirmed_bookings || 0}
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-sm text-navy-600">Paid</span>
                <span className="font-medium text-green-600">
                  {bookingStats?.paid_bookings || 0}
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-sm text-navy-600">Completed</span>
                <span className="font-medium text-navy-900">
                  {bookingStats?.completed_bookings || 0}
                </span>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* Payment Status */}
        <Card>
          <CardHeader>
            <h3 className="text-lg font-medium text-navy-900">Payment Status</h3>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              <div className="flex justify-between items-center">
                <span className="text-sm text-navy-600">Processed</span>
                <span className="font-medium text-green-600">
                  {paymentStats?.total_payments || 0}
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-sm text-navy-600">Pending</span>
                <span className="font-medium text-amber-600">
                  {paymentStats?.pending_payments || 0}
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-sm text-navy-600">Failed</span>
                <span className="font-medium text-red-600">
                  {paymentStats?.failed_payments || 0}
                </span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-sm text-navy-600">Success Rate</span>
                <span className="font-medium text-navy-900">
                  {calculateSuccessRate()}
                </span>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Urgent Bookings */}
      {dashboardData?.urgent_bookings && dashboardData.urgent_bookings.length > 0 && (
        <Card>
          <CardHeader className="flex flex-row items-center justify-between">
            <h3 className="text-lg font-medium text-navy-900">Bookings Needing Attention</h3>
            <Button 
              variant="ghost" 
              onClick={() => router.push('/staff/bookings?filter=urgent')}
            >
              View All
            </Button>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {dashboardData.urgent_bookings.slice(0, 5).map((booking) => (
                <div 
                  key={booking.id} 
                  className="flex items-center justify-between p-3 border border-cream-200 rounded-lg hover:bg-cream-50 cursor-pointer"
                  onClick={() => router.push(`/staff/bookings/${booking.id}`)}
                >
                  <div>
                    <p className="font-medium text-navy-900">
                      #{booking.booking_number}
                    </p>
                    <p className="text-sm text-navy-600">
                      {booking.customer_name} - {booking.service_type}
                    </p>
                    <p className="text-xs text-navy-500">
                      Pickup: {new Date(booking.pickup_date + 'T00:00:00').toLocaleDateString()}
                    </p>
                  </div>
                  <div className="text-right">
                    <p className="font-medium text-navy-900">
                      ${booking.total_price_dollars}
                    </p>
                    <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                      booking.status === 'pending' 
                        ? 'bg-amber-100 text-amber-800'
                        : 'bg-blue-100 text-blue-800'
                    }`}>
                      {booking.status}
                    </span>
                  </div>
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
```

# ──── frontend/src/components/staff/staff-layout.tsx ────

```tsx
// frontend/src/components/staff/staff-layout.tsx
'use client';

import { useState } from 'react';
import { useStaffAuthStore } from '@/stores/staff-auth-store';
import { useRouter, usePathname } from 'next/navigation';
import Link from 'next/link';

interface StaffLayoutProps {
  children: React.ReactNode;
}

const navigation = [
  { name: 'Dashboard', href: '/staff/dashboard' },
  { name: 'Calendar', href: '/staff/calendar' },
  { name: 'Bookings', href: '/staff/bookings' },
  { name: 'Customers', href: '/staff/customers' },
  { name: 'Logistics', href: '/staff/logistics' },
  { name: 'Reports', href: '/staff/reports' }
];

export function StaffLayout({ children }: StaffLayoutProps) {
  const { staffProfile, logout, isLoading } = useStaffAuthStore();
  const router = useRouter();
  const pathname = usePathname();
  const [sidebarOpen, setSidebarOpen] = useState(false);

  // FIXED: Use enhanced store logout method instead of direct API calls
  const handleLogout = async () => {
    try {
      await logout();
      router.push('/staff/login');
    } catch (error) {
      console.error('Logout error:', error);
      // Fallback: still redirect even if logout fails
      router.push('/staff/login');
    }
  };

  return (
    <div className="min-h-screen bg-cream-50 flex">
      {/* Mobile sidebar overlay */}
      {sidebarOpen && (
        <div className="fixed inset-0 z-40 lg:hidden">
          <div 
            className="fixed inset-0 bg-gray-600 bg-opacity-75" 
            onClick={() => setSidebarOpen(false)} 
          />
          <div className="relative flex w-full max-w-xs flex-1 flex-col bg-navy-900">
            <div className="absolute top-0 right-0 -mr-12 pt-2">
              <button
                type="button"
                className="ml-1 flex h-10 w-10 items-center justify-center rounded-full focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white text-white"
                onClick={() => setSidebarOpen(false)}
              >
                ×
              </button>
            </div>
            <SidebarContent navigation={navigation} pathname={pathname} />
          </div>
        </div>
      )}

      {/* Desktop sidebar */}
      <div className="hidden lg:flex lg:w-64 lg:flex-col lg:fixed lg:inset-y-0 lg:bg-navy-900">
        <SidebarContent navigation={navigation} pathname={pathname} />
      </div>

      {/* Main content */}
      <div className="lg:pl-64 flex flex-1 flex-col">
        {/* Top navigation */}
        <div className="sticky top-0 z-10 flex h-16 flex-shrink-0 bg-white shadow">
          <button
            type="button"
            className="border-r border-gray-200 px-4 text-gray-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-navy-500 lg:hidden"
            onClick={() => setSidebarOpen(true)}
          >
            ☰
          </button>

          <div className="flex flex-1 justify-between px-4">
            <div className="flex flex-1">
              {/* Breadcrumb or page title can go here */}
            </div>
            <div className="ml-4 flex items-center space-x-4">
              <span className="text-sm text-gray-700">
                {staffProfile?.full_name || 'Staff User'}
              </span>
              <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-navy-100 text-navy-800">
                {staffProfile?.role || 'staff'}
              </span>
              <button
                onClick={handleLogout}
                disabled={isLoading}
                className="text-gray-500 hover:text-gray-700 focus:outline-none focus:ring-2 focus:ring-navy-500 disabled:opacity-50"
              >
                {isLoading ? 'Logging out...' : 'Logout'}
              </button>
            </div>
          </div>
        </div>

        {/* Page content */}
        <main className="flex-1 overflow-y-auto">
          <div className="py-6">
            <div className="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
              {children}
            </div>
          </div>
        </main>
      </div>
    </div>
  );
}

function SidebarContent({ navigation, pathname }: { 
  navigation: Array<{ name: string; href: string }>;
  pathname: string;
}) {
  return (
    <div className="flex flex-1 flex-col min-h-0">
      <div className="flex items-center h-16 flex-shrink-0 px-4 bg-navy-800">
        <h1 className="text-lg font-bold text-white">ToteTaxi Operations</h1>
      </div>
      <div className="flex-1 flex flex-col overflow-y-auto">
        <nav className="flex-1 px-2 py-4 space-y-1">
          {navigation.map((item) => {
            const isActive = pathname === item.href || pathname.startsWith(item.href + '/');
            return (
              <Link
                key={item.name}
                href={item.href}
                className={`group flex items-center px-2 py-2 text-sm font-medium rounded-md transition-colors ${
                  isActive
                    ? 'bg-navy-800 text-white'
                    : 'text-navy-100 hover:bg-navy-700 hover:text-white'
                }`}
              >
                {item.name}
              </Link>
            );
          })}
        </nav>
      </div>
    </div>
  );
}
```

# ──── frontend/src/components/staff/staff-login-form.tsx ────

```tsx
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { useStaffAuthStore } from '@/stores/staff-auth-store';

const staffLoginSchema = z.object({
  username: z.string().min(1, 'Username is required'),
  password: z.string().min(1, 'Password is required'),
  rememberMe: z.boolean().optional(),
});

type StaffLoginForm = z.infer<typeof staffLoginSchema>;

export function StaffLoginForm() {
  const router = useRouter();
  const { login, isLoading } = useStaffAuthStore();
  const [apiError, setApiError] = useState<string>('');
  const [showPassword, setShowPassword] = useState(false);

  const {
    register,
    handleSubmit,
    formState: { errors, isSubmitting },
    setValue,
  } = useForm<StaffLoginForm>({
    resolver: zodResolver(staffLoginSchema),
    mode: 'onSubmit',
    reValidateMode: 'onSubmit',
    defaultValues: {
      username: '',
      password: '',
      rememberMe: false,
    }
  });

  // Load saved username on mount
  useEffect(() => {
    const savedUsername = localStorage.getItem('staff-remember-username');
    if (savedUsername) {
      setValue('username', savedUsername);
      setValue('rememberMe', true);
    }
  }, [setValue]);

  const onSubmit = async (data: StaffLoginForm) => {
    // Prevent double submit
    if (isSubmitting || isLoading) return;

    setApiError('');

    try {
      // Handle remember me
      if (data.rememberMe) {
        localStorage.setItem('staff-remember-username', data.username);
      } else {
        localStorage.removeItem('staff-remember-username');
      }

      const result = await login(data.username, data.password);

      if (result.success) {
        console.log('Staff login successful, redirecting to dashboard');
        router.push('/staff/dashboard');
      } else {
        setApiError(result.error || 'Login failed. Please check your credentials.');
      }
    } catch (error) {
      console.error('Staff login error:', error);
      setApiError('An unexpected error occurred. Please try again.');
    }
  };

  // Sync DOM values to React Hook Form before validation.
  // Mobile password managers fill inputs without triggering React events,
  // so RHF's internal state can be empty even when fields are filled.
  const handleFormSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    const form = e.currentTarget;
    const usernameEl = form.elements.namedItem('username') as HTMLInputElement;
    const passwordEl = form.elements.namedItem('password') as HTMLInputElement;
    if (usernameEl) setValue('username', usernameEl.value);
    if (passwordEl) setValue('password', passwordEl.value);
    await handleSubmit(onSubmit)();
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-cream-50 py-12 px-4 sm:px-6 lg:px-8">
      <div className="max-w-md w-full space-y-8">
        <div className="text-center">
          <h2 className="text-3xl font-serif font-bold text-navy-900">
            Staff Login
          </h2>
          <p className="mt-2 text-sm text-navy-600">
            ToteTaxi Operations Dashboard
          </p>
        </div>

        <Card variant="elevated">
          <CardContent className="p-6">
            <form onSubmit={handleFormSubmit} className="space-y-4">
              <div>
                <label htmlFor="username" className="block text-sm font-medium text-navy-900 mb-1">
                  Username
                </label>
                <Input
                  id="username"
                  autoComplete="username"
                  {...register('username')}
                  placeholder="Enter your username"
                  className={errors.username ? 'border-red-500' : ''}
                />
                {errors.username && (
                  <p className="text-red-600 text-sm mt-1">{errors.username.message}</p>
                )}
              </div>

              <div>
                <label htmlFor="password" className="block text-sm font-medium text-navy-900 mb-1">
                  Password
                </label>
                <div className="relative">
                  <Input
                    id="password"
                    type={showPassword ? 'text' : 'password'}
                    autoComplete="current-password"
                    {...register('password')}
                    placeholder="Enter your password"
                    className={errors.password ? 'border-red-500 pr-10' : 'pr-10'}
                  />
                  <button
                    type="button"
                    onClick={() => setShowPassword(!showPassword)}
                    className="absolute right-3 top-1/2 -translate-y-1/2 text-navy-500 hover:text-navy-700 focus:outline-none"
                    tabIndex={-1}
                  >
                    {showPassword ? (
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />
                      </svg>
                    ) : (
                      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-5 h-5">
                        <path strokeLinecap="round" strokeLinejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                        <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                    )}
                  </button>
                </div>
                {errors.password && (
                  <p className="text-red-600 text-sm mt-1">{errors.password.message}</p>
                )}
              </div>

              <div className="flex items-center">
                <input
                  id="rememberMe"
                  type="checkbox"
                  {...register('rememberMe')}
                  className="h-4 w-4 text-navy-600 focus:ring-navy-500 border-gray-300 rounded"
                />
                <label htmlFor="rememberMe" className="ml-2 block text-sm text-navy-700">
                  Remember my username
                </label>
              </div>

              {apiError && (
                <div className="bg-red-50 border border-red-200 rounded-md p-3">
                  <p className="text-red-700 text-sm">{apiError}</p>
                </div>
              )}

              <Button
                type="submit"
                variant="primary"
                size="lg"
                className="w-full"
                disabled={isLoading || isSubmitting}
              >
                {isLoading || isSubmitting ? 'Signing In...' : 'Sign In'}
              </Button>
            </form>
          </CardContent>
        </Card>

        <div className="text-center text-xs text-navy-600">
          <p>
            Need access? Contact your administrator.<br/>
            This system logs all authentication attempts.
          </p>
        </div>
      </div>
    </div>
  );
}
```

# ──── frontend/src/components/ui/button.tsx ────

```tsx
// frontend/src/components/ui/button.tsx
import { cn } from '@/utils/cn';
import { ButtonHTMLAttributes, forwardRef } from 'react';

// Easy to change - all styling in config objects
const buttonVariants = {
  variant: {
    primary: 'bg-navy-900 text-white hover:bg-navy-800 focus:ring-navy-500',
    secondary: 'bg-gold-500 text-navy-900 hover:bg-gold-600 focus:ring-gold-400',
    outline: 'border-2 border-navy-900 text-navy-900 hover:bg-navy-50 focus:ring-navy-300',
    ghost: 'text-navy-900 hover:bg-navy-100 focus:ring-navy-300',
  },
  size: {
    sm: 'px-3 py-2 text-sm',
    md: 'px-4 py-2 text-base',
    lg: 'px-6 py-3 text-lg',
    xl: 'px-8 py-4 text-xl',
  },
  rounded: {
    none: 'rounded-none',
    sm: 'rounded',
    md: 'rounded-md',
    lg: 'rounded-lg',
    full: 'rounded-full',
  }
};

// Base styles that rarely change
const baseStyles = 'inline-flex items-center justify-center font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed';

interface ButtonProps extends ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: keyof typeof buttonVariants.variant;
  size?: keyof typeof buttonVariants.size;
  rounded?: keyof typeof buttonVariants.rounded;
  children: React.ReactNode;
}

export const Button = forwardRef<HTMLButtonElement, ButtonProps>(({
  variant = 'primary',
  size = 'md',
  rounded = 'md',
  className,
  children,
  ...props
}, ref) => {
  return (
    <button
      ref={ref}
      className={cn(
        baseStyles,
        buttonVariants.variant[variant],
        buttonVariants.size[size],
        buttonVariants.rounded[rounded],
        className
      )}
      {...props}
    >
      {children}
    </button>
  );
});

Button.displayName = 'Button';
```

# ──── frontend/src/components/ui/card.tsx ────

```tsx
// frontend/src/components/ui/card.tsx
import { cn } from '@/utils/cn';
import { HTMLAttributes, forwardRef } from 'react';

// Easy to change card styling
const cardVariants = {
  variant: {
    default: 'bg-white border border-gray-200',
    elevated: 'bg-white shadow-lg shadow-navy-900/10',
    luxury: 'bg-white border border-gold-200 shadow-xl shadow-navy-900/20',
    ghost: 'bg-transparent border-0',
  },
  padding: {
    none: 'p-0',
    sm: 'p-4',
    md: 'p-6',
    lg: 'p-8',
  },
  rounded: {
    none: 'rounded-none',
    sm: 'rounded',
    md: 'rounded-md',
    lg: 'rounded-lg',
    xl: 'rounded-xl',
  }
};

const baseStyles = 'transition-all duration-200';

interface CardProps extends HTMLAttributes<HTMLDivElement> {
  variant?: keyof typeof cardVariants.variant;
  padding?: keyof typeof cardVariants.padding;
  rounded?: keyof typeof cardVariants.rounded;
  children: React.ReactNode;
}

export const Card = forwardRef<HTMLDivElement, CardProps>(({
  variant = 'default',
  padding = 'md',
  rounded = 'lg',
  className,
  children,
  ...props
}, ref) => {
  return (
    <div
      ref={ref}
      className={cn(
        baseStyles,
        cardVariants.variant[variant],
        cardVariants.padding[padding],
        cardVariants.rounded[rounded],
        className
      )}
      {...props}
    >
      {children}
    </div>
  );
});

Card.displayName = 'Card';

// Subcomponents for structured content
export const CardHeader = forwardRef<HTMLDivElement, HTMLAttributes<HTMLDivElement>>(({
  className,
  children,
  ...props
}, ref) => (
  <div ref={ref} className={cn('pb-4 border-b border-gray-100', className)} {...props}>
    {children}
  </div>
));

CardHeader.displayName = 'CardHeader';

export const CardContent = forwardRef<HTMLDivElement, HTMLAttributes<HTMLDivElement>>(({
  className,
  children,
  ...props
}, ref) => (
  <div ref={ref} className={cn('py-4', className)} {...props}>
    {children}
  </div>
));

CardContent.displayName = 'CardContent';

export const CardFooter = forwardRef<HTMLDivElement, HTMLAttributes<HTMLDivElement>>(({
  className,
  children,
  ...props
}, ref) => (
  <div ref={ref} className={cn('pt-4 border-t border-gray-100', className)} {...props}>
    {children}
  </div>
));

CardFooter.displayName = 'CardFooter';
```

# ──── frontend/src/components/ui/index.ts ────

```typescript
// frontend/src/components/ui/index.ts
export { Button } from './button';
export { Input } from './input';
export { Card, CardHeader, CardContent, CardFooter } from './card';
export { Modal } from './modal';
export { Select } from './select';
```

# ──── frontend/src/components/ui/input.tsx ────

```tsx
// frontend/src/components/ui/input.tsx
import { cn } from '@/utils/cn';
import { InputHTMLAttributes, forwardRef, useState, useRef } from 'react';

const inputVariants = {
  variant: {
    default: 'border-gray-300 focus:border-navy-500 focus:ring-navy-500',
    error: 'border-red-300 focus:border-red-500 focus:ring-red-500',
    success: 'border-green-300 focus:border-green-500 focus:ring-green-500',
  },
  size: {
    sm: 'px-3 py-2 text-sm',
    md: 'px-4 py-3 text-base',
    lg: 'px-4 py-4 text-lg',
  }
};

const baseStyles = 'block w-full rounded-md shadow-sm transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed text-gray-900 placeholder:text-gray-400 bg-white';

// Utility functions for input masking
const formatPhoneNumber = (value: string) => {
  const cleaned = value.replace(/\D/g, '');
  if (cleaned.length >= 10) {
    return `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6,10)}`;
  }
  if (cleaned.length >= 6) return `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6)}`;
  if (cleaned.length >= 3) return `(${cleaned.slice(0,3)}) ${cleaned.slice(3)}`;
  return cleaned;
};

const formatZipCode = (value: string) => {
  const cleaned = value.replace(/\D/g, '');
  if (cleaned.length > 5) {
    return `${cleaned.slice(0,5)}-${cleaned.slice(5,9)}`;
  }
  return cleaned;
};

const validateEmail = (email: string) => {
  if (!email) return '';
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) return 'Please enter a valid email address (e.g., name@example.com)';
  if (email.includes('..')) return 'Email cannot contain consecutive dots';
  if (email.length > 254) return 'Email address is too long';
  return '';
};

const validatePhone = (phone: string) => {
  const cleaned = phone.replace(/\D/g, '');
  if (!cleaned) return '';
  if (cleaned.length < 10) return 'Phone number must be at least 10 digits';
  if (cleaned.length > 11) return 'Phone number is too long';
  return '';
};

interface InputProps extends InputHTMLAttributes<HTMLInputElement> {
  variant?: keyof typeof inputVariants.variant;
  inputSize?: keyof typeof inputVariants.size;
  label?: string;
  error?: string;
  success?: string;
  helper?: string;
  mask?: 'phone' | 'zip';
  realTimeValidation?: boolean;
}

export const Input = forwardRef<HTMLInputElement, InputProps>(({
  variant = 'default',
  inputSize = 'md',
  label,
  error,
  success,
  helper,
  mask,
  realTimeValidation = false,
  className,
  onChange,
  value,
  type,
  id,
  ...props
}, ref) => {
  const [internalValue, setInternalValue] = useState(value || '');
  const [validationError, setValidationError] = useState('');
  const internalRef = useRef<HTMLInputElement>(null);
  const generatedId = useRef(`input-${Math.random().toString(36).substr(2, 9)}`);
  const inputId = id || generatedId.current;

  // Use the forwarded ref if provided, otherwise use internal ref
  const inputRef = (ref as React.RefObject<HTMLInputElement>) || internalRef;

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    let newValue = e.target.value;
    
    // Apply input masking
    if (mask === 'phone') {
      newValue = formatPhoneNumber(newValue);
    } else if (mask === 'zip') {
      newValue = formatZipCode(newValue);
    }
    
    setInternalValue(newValue);
    
    // Real-time validation
    if (realTimeValidation) {
      let validationErr = '';
      if (type === 'email') {
        validationErr = validateEmail(newValue);
      } else if (mask === 'phone') {
        validationErr = validatePhone(newValue);
      }
      setValidationError(validationErr);
    }
    
    // Create new event with formatted value
    const newEvent = { ...e, target: { ...e.target, value: newValue } };
    onChange?.(newEvent);
  };

  // Make entire container clickable for date/time inputs on desktop
  const handleContainerClick = () => {
    if (type === 'date' || type === 'time') {
      const input = inputRef.current;
      if (input) {
        // Modern browsers support showPicker() for date/time inputs
        try {
          input.showPicker?.();
        } catch (e) {
          // Fallback for browsers that don't support showPicker
          input.focus();
          input.click();
        }
      }
    }
  };

  // Only use internal value management if we're not in controlled mode (no onChange from react-hook-form)
  // When using {...register()}, we should let the native input handle its own value
  const isControlled = value !== undefined;
  const displayValue = isControlled ? value : undefined;
  const actualVariant = error || validationError ? 'error' : success ? 'success' : variant;

  // Enhanced styling for date and time inputs to make them stand out and more clickable
  const isDateOrTime = type === 'date' || type === 'time';
  const dateTimeStyles = isDateOrTime 
    ? 'border-2 border-navy-400 bg-navy-50/30 focus:bg-white focus:border-navy-600 font-medium text-navy-900 cursor-pointer min-h-[48px] text-base' 
    : '';

  return (
    <div className="space-y-2">
      {label && (
        <label 
          htmlFor={inputId}
          onClick={handleContainerClick}
          className={cn(
            "block text-sm font-semibold text-navy-900",
            isDateOrTime && "cursor-pointer select-none hover:text-navy-700 transition-colors"
          )}
        >
          {label}
          {props.required && <span className="text-red-500 ml-1">*</span>}
        </label>
      )}
      
      <div 
        onClick={handleContainerClick}
        className={cn(
          isDateOrTime && "cursor-pointer"
        )}
      >
        <input
          ref={inputRef}
          id={inputId}
          type={type}
          className={cn(
            baseStyles,
            inputVariants.variant[actualVariant],
            inputVariants.size[inputSize],
            dateTimeStyles,
            className
          )}
          {...(isControlled ? { value: displayValue, onChange: handleChange } : {})}
          {...props}
        />
      </div>
      
      {(error || validationError) && (
        <p className="text-sm text-red-600 flex items-center">
          <svg className="w-4 h-4 mr-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />
          </svg>
          {error || validationError}
        </p>
      )}
      {success && !error && !validationError && (
        <p className="text-sm text-green-600 flex items-center">
          <svg className="w-4 h-4 mr-1 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
          </svg>
          {success}
        </p>
      )}
      {helper && !error && !validationError && !success && (
        <p className="text-sm text-navy-600 font-medium">{helper}</p>
      )}
    </div>
  );
});

Input.displayName = 'Input';
```

# ──── frontend/src/components/ui/modal.tsx ────

```tsx
// frontend/src/components/ui/modal.tsx
'use client';

import { cn } from '@/utils/cn';
import { Dialog, Transition } from '@headlessui/react';
import { XMarkIcon } from '@heroicons/react/24/outline';
import { Fragment, ReactNode } from 'react';

// Easy to change modal styling
const modalVariants = {
  size: {
    sm: 'max-w-md',
    md: 'max-w-lg',
    lg: 'max-w-2xl',
    xl: 'max-w-4xl',
    full: 'max-w-7xl',
  },
  position: {
    center: 'items-center justify-center',
    top: 'items-start justify-center pt-16',
  }
};

const overlayStyles = 'fixed inset-0 bg-navy-900 bg-opacity-50 transition-opacity';
const panelStyles = 'relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all';

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  size?: keyof typeof modalVariants.size;
  position?: keyof typeof modalVariants.position;
  title?: string;
  description?: string;
  showCloseButton?: boolean;
  children: ReactNode;
  className?: string;
}

export function Modal({
  isOpen,
  onClose,
  size = 'md',
  position = 'center',
  title,
  description,
  showCloseButton = true,
  children,
  className
}: ModalProps) {
  return (
    <Transition appear show={isOpen} as={Fragment}>
      <Dialog as="div" className="relative z-50" onClose={onClose}>
        <Transition.Child
          as={Fragment}
          enter="ease-out duration-300"
          enterFrom="opacity-0"
          enterTo="opacity-100"
          leave="ease-in duration-200"
          leaveFrom="opacity-100"
          leaveTo="opacity-0"
        >
          <div className={overlayStyles} />
        </Transition.Child>

        <div className="fixed inset-0 overflow-y-auto">
          <div className={cn(
            'flex min-h-full p-4 text-center',
            modalVariants.position[position]
          )}>
            <Transition.Child
              as={Fragment}
              enter="ease-out duration-300"
              enterFrom="opacity-0 scale-95"
              enterTo="opacity-100 scale-100"
              leave="ease-in duration-200"
              leaveFrom="opacity-100 scale-100"
              leaveTo="opacity-0 scale-95"
            >
              <Dialog.Panel className={cn(
                panelStyles,
                modalVariants.size[size],
                'w-full',
                className
              )}>
                {/* Header */}
                {(title || showCloseButton) && (
                  <div className="flex items-center justify-between p-6 pb-4">
                    <div>
                      {title && (
                        <Dialog.Title className="text-lg font-serif font-medium text-navy-900">
                          {title}
                        </Dialog.Title>
                      )}
                      {description && (
                        <Dialog.Description className="mt-1 text-sm text-navy-600">
                          {description}
                        </Dialog.Description>
                      )}
                    </div>
                    {showCloseButton && (
                      <button
                        type="button"
                        className="rounded-md text-navy-400 hover:text-navy-600 focus:outline-none focus:ring-2 focus:ring-navy-500"
                        onClick={onClose}
                      >
                        <XMarkIcon className="h-6 w-6" />
                      </button>
                    )}
                  </div>
                )}

                {/* Content */}
                <div className={cn(
                  'px-6',
                  (title || showCloseButton) ? 'pb-6' : 'py-6'
                )}>
                  {children}
                </div>
              </Dialog.Panel>
            </Transition.Child>
          </div>
        </div>
      </Dialog>
    </Transition>
  );
}
```

# ──── frontend/src/components/ui/select.tsx ────

```tsx
// frontend/src/components/ui/select.tsx
import { cn } from '@/utils/cn';
import { SelectHTMLAttributes, forwardRef } from 'react';

interface SelectProps extends SelectHTMLAttributes<HTMLSelectElement> {
  label?: string;
  error?: string;
  options: Array<{ value: string; label: string }>;
  placeholder?: string;
}

export const Select = forwardRef<HTMLSelectElement, SelectProps>(({
  label,
  error,
  options,
  placeholder = 'Select an option',
  className,
  ...props
}, ref) => {
  return (
    <div className="space-y-1">
      {label && (
        <label className="block text-sm font-medium text-navy-900">
          {label}
          {props.required && <span className="text-red-500 ml-1">*</span>}
        </label>
      )}
      <select
        ref={ref}
        className={cn(
          'w-full px-4 py-3 text-base border border-gray-300 rounded-md shadow-sm transition-colors duration-200',
          'focus:border-navy-500 focus:ring-navy-500 text-gray-900 bg-white',
          'disabled:opacity-50 disabled:cursor-not-allowed',
          error && 'border-red-300 focus:border-red-500 focus:ring-red-500',
          className
        )}
        {...props}
      >
        <option value="" className="text-gray-400">{placeholder}</option>
        {options.map(option => (
          <option key={option.value} value={option.value} className="text-gray-900">
            {option.label}
          </option>
        ))}
      </select>
      {error && (
        <p className="text-sm text-red-600">{error}</p>
      )}
    </div>
  );
});

Select.displayName = 'Select';
```

# ──── frontend/src/hooks/use-click-away.ts ────

```typescript
// frontend/src/hooks/use-click-away.ts
import { useEffect, RefObject } from 'react';

export function useClickAway<T extends HTMLElement>(
  ref: RefObject<T | null>, // 👈 Add | null here
  handler: () => void
) {
  useEffect(() => {
    const listener = (event: MouseEvent | TouchEvent) => {
      if (!ref.current || ref.current.contains(event.target as Node)) {
        return;
      }
      handler();
    };

    document.addEventListener('mousedown', listener);
    document.addEventListener('touchstart', listener);

    return () => {
      document.removeEventListener('mousedown', listener);
      document.removeEventListener('touchstart', listener);
    };
  }, [ref, handler]);
}
```

# ──── frontend/src/hooks/use-debounce.ts ────

```typescript
import { useState, useEffect } from 'react';

export function useDebounce<T>(value: T, delay: number = 300): T {
  const [debouncedValue, setDebouncedValue] = useState<T>(value);

  useEffect(() => {
    const timer = setTimeout(() => setDebouncedValue(value), delay);
    return () => clearTimeout(timer);
  }, [value, delay]);

  return debouncedValue;
}
```

# ──── frontend/src/hooks/use-discount-code.ts ────

```typescript
import { useState } from 'react';
import { apiClient } from '@/lib/api-client';
import { useBookingWizard } from '@/stores/booking-store';
import { useAuthStore } from '@/stores/auth-store';

export function useDiscountCode() {
  const { bookingData, applyDiscountCode, clearDiscountCode } = useBookingWizard();
  const { user, isAuthenticated } = useAuthStore();
  const [isValidating, setIsValidating] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [success, setSuccess] = useState<string | null>(null);

  const getEmail = () => {
    if (isAuthenticated && user?.email) return user.email;
    return bookingData.customer_info?.email || '';
  };

  const validateCode = async (code: string) => {
    if (!code.trim()) {
      clearDiscountCode();
      setError(null);
      setSuccess(null);
      return;
    }

    const email = getEmail();
    if (!email) {
      setError('Email is required to validate a discount code');
      return;
    }

    setIsValidating(true);
    setError(null);
    setSuccess(null);

    try {
      const response = await apiClient.post('/api/public/validate-discount/', {
        code: code.trim(),
        email,
        service_type: bookingData.service_type,
        subtotal_cents: bookingData.pricing_data
          ? Math.round(bookingData.pricing_data.total_price_dollars * 100)
          : 0,
      });

      const data = response.data;

      applyDiscountCode(data.code, {
        code: data.code,
        discount_type: data.discount_type,
        discount_description: data.discount_description,
        discount_amount_dollars: data.discount_amount_dollars,
      });

      setSuccess(`${data.discount_description} discount applied!`);
    } catch (err: any) {
      clearDiscountCode();
      const errorMessage = err.response?.data?.error || 'Invalid discount code';
      setError(errorMessage);
    } finally {
      setIsValidating(false);
    }
  };

  const removeCode = () => {
    clearDiscountCode();
    setError(null);
    setSuccess(null);
  };

  return {
    validateCode,
    removeCode,
    isValidating,
    error,
    success,
    appliedCode: bookingData.discount_info,
  };
}
```

# ──── frontend/src/lib/api-client.ts ────

```typescript
// frontend/src/lib/api-client.ts
import axios from 'axios';

export const apiClient = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8005',
  withCredentials: true,
  headers: { 'Content-Type': 'application/json' },
  timeout: 10000
});

// Request interceptor - handle mobile session fallback and CSRF tokens
apiClient.interceptors.request.use(async (config) => {
  // Check if cookies are working (desktop browsers)
  const hasCookies = document.cookie.includes('sessionid') || 
                     document.cookie.includes('totetaxi_sessionid');
  
  if (!hasCookies) {
    // Mobile fallback: use stored session ID in header
    const sessionId = localStorage.getItem('totetaxi-session-id');
    if (sessionId) {
      config.headers['X-Session-Id'] = sessionId;
      console.log('Mobile: Using session ID from localStorage');
    }
  }
  
  // Handle CSRF token for mutations
  if (['post', 'put', 'patch', 'delete'].includes(config.method!)) {
    const csrfToken = localStorage.getItem('totetaxi-csrf-token');
    
    if (csrfToken) {
      config.headers['X-CSRFToken'] = csrfToken;
    } else {
      // Determine if this is a staff or customer endpoint
      const isStaffEndpoint = config.url?.includes('/api/staff/');
      const csrfEndpoint = isStaffEndpoint 
        ? '/api/staff/csrf-token/' 
        : '/api/customer/csrf-token/';
      
      // Try to fetch CSRF token from correct endpoint
      try {
        const csrfResponse = await axios.get(
          `${config.baseURL}${csrfEndpoint}`,
          { 
            withCredentials: true,
            timeout: 5000
          }
        );
        
        const token = csrfResponse.data.csrf_token;
        if (token) {
          localStorage.setItem('totetaxi-csrf-token', token);
          config.headers['X-CSRFToken'] = token;
        }
      } catch (error) {
        console.error('CSRF token fetch failed:', error);
      }
    }
  }
  
  return config;
});

// Response interceptor - handle auth errors
apiClient.interceptors.response.use(
  (response) => response,
  async (error) => {
    if (error.response?.status === 401) {
      const requestUrl = error.config?.url || '';

      // Only clear the auth store that matches the failed request
      // This prevents a customer 401 from logging out staff (and vice versa)
      try {
        if (requestUrl.includes('/api/staff/')) {
          console.log('401 on staff endpoint - clearing staff auth');
          const { useStaffAuthStore } = await import('@/stores/staff-auth-store');
          useStaffAuthStore.getState().clearAuth();
        } else if (requestUrl.includes('/api/customer/')) {
          console.log('401 on customer endpoint - clearing customer auth');
          const { useAuthStore } = await import('@/stores/auth-store');
          useAuthStore.getState().clearAuth();
        }
      } catch (e) {
        console.warn('Error clearing auth on 401:', e);
      }

      localStorage.removeItem('totetaxi-csrf-token');
    }
    
    return Promise.reject(error);
  }
);
```

# ──── frontend/src/lib/google-places-utils.ts ────

```typescript
import type { BookingAddress } from '@/stores/booking-store';

export function parseGooglePlace(
  place: google.maps.places.PlaceResult
): Partial<BookingAddress> | null {
  if (!place.address_components) {
    console.warn('No address components in place result');
    return null;
  }

  const components = place.address_components;

  // Extract components with proper typing
  const streetNumber = components.find((c: google.maps.GeocoderAddressComponent) => 
    c.types.includes('street_number')
  )?.long_name || '';
  
  const route = components.find((c: google.maps.GeocoderAddressComponent) => 
    c.types.includes('route')
  )?.long_name || '';
  
  const city = components.find((c: google.maps.GeocoderAddressComponent) => 
    c.types.includes('locality')
  )?.long_name || 
  components.find((c: google.maps.GeocoderAddressComponent) => 
    c.types.includes('sublocality')
  )?.long_name || '';
  
  const state = components.find((c: google.maps.GeocoderAddressComponent) => 
    c.types.includes('administrative_area_level_1')
  )?.short_name || '';
  
  const zipCode = components.find((c: google.maps.GeocoderAddressComponent) => 
    c.types.includes('postal_code')
  )?.long_name || '';

  // Validate required fields
  if (!city || !state || !zipCode) {
    console.warn('Missing required address components:', { 
      city, state, zipCode 
    });
    return null;
  }

  // Validate state is in service area
  if (!['NY', 'CT', 'NJ'].includes(state)) {
    console.warn('Address outside service states:', state);
    return null;
  }

  const address_line_1 = `${streetNumber} ${route}`.trim();

  if (!address_line_1) {
    console.warn('No street address found');
    return null;
  }

  return {
    address_line_1,
    address_line_2: '',
    city,
    state: state as 'NY' | 'CT' | 'NJ',
    zip_code: zipCode
  };
}

export function formatAddressForDisplay(address: BookingAddress): string {
  const parts = [
    address.address_line_1,
    address.address_line_2,
    address.city,
    address.state,
    address.zip_code
  ].filter(Boolean);

  return parts.join(', ');
}
```

# ──── frontend/src/lib/query-client.ts ────

```typescript
// frontend/src/lib/query-client.ts
import { QueryClient } from '@tanstack/react-query';

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60 * 5, // 5 minutes
      gcTime: 1000 * 60 * 30, // 30 minutes
      retry: (failureCount, error: any) => {
        if (error?.response?.status === 401) return false;
        return failureCount < 3;
      },
      refetchOnWindowFocus: false,
    },
    mutations: {
      retry: 1,
    }
  }
});

// ✅ CORRECT v5 APPROACH: Global error handling using QueryClient events
queryClient.getQueryCache().subscribe((event) => {
  if (event?.type === 'observerResultsUpdated') {
    const result = event.query.state;
    if (result.error?.response?.status === 401) {
      handle401Error();
    }
  }
});

queryClient.getMutationCache().subscribe((event) => {
  if (event?.type === 'updated') {
    const result = event.mutation.state;
    if (result.error?.response?.status === 401) {
      handle401Error();
    }
  }
});

// ✅ CENTRALIZED: 401 error handler
async function handle401Error() {
  console.log('🚨 React Query detected 401 - clearing cache');
  
  try {
    // Clear the query cache
    queryClient.clear();
    console.log('✅ React Query cache cleared');
    
    // Clear auth stores
    const { useAuthStore } = await import('@/stores/auth-store');
    const { useStaffAuthStore } = await import('@/stores/staff-auth-store');
    
    useAuthStore.getState().clearAuth();
    useStaffAuthStore.getState().clearAuth();
    
  } catch (e) {
    console.warn('Error handling React Query 401:', e);
  }
}
```

# ──── frontend/src/lib/stripe.ts ────

```typescript
// src/lib/stripe.ts
import { loadStripe, Stripe } from '@stripe/stripe-js';

let stripePromise: Promise<Stripe | null>;

export const getStripe = () => {
  if (!stripePromise) {
    stripePromise = loadStripe(process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY!);
  }
  return stripePromise;
};
```

# ──── frontend/src/stores/auth-store.ts ────

```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import type { DjangoUser, CustomerProfile } from '@/types';
import { apiClient } from '@/lib/api-client';
import { queryClient } from '@/lib/query-client';

interface AuthState {
  user: DjangoUser | null;
  customerProfile: CustomerProfile | null;
  isAuthenticated: boolean;
  isLoading: boolean;
}

interface AuthActions {
  setAuth: (user: DjangoUser, profile: CustomerProfile) => void;
  clearAuth: () => void;
  setLoading: (loading: boolean) => void;
  updateProfile: (updates: Partial<CustomerProfile>) => void;
  login: (email: string, password: string) => Promise<{ success: boolean; user?: DjangoUser; error?: string }>;
  register: (data: RegisterData) => Promise<{ success: boolean; user?: DjangoUser; error?: string }>;
  logout: () => Promise<void>;
  validateSession: () => Promise<boolean>;
  clearSessionIfIncognito: () => void;
  secureReset: () => void;
}

interface RegisterData {
  email: string;
  password: string;
  first_name: string;
  last_name: string;
  phone?: string;
}

const initialState: AuthState = {
  user: null,
  customerProfile: null,
  isAuthenticated: false,
  isLoading: false,
};

export const useAuthStore = create<AuthState & AuthActions>()(
  persist(
    (set, get) => ({
      // State
      ...initialState,

      // Actions
      setAuth: (user, profile) => {
        if (typeof window !== 'undefined') {
          localStorage.setItem('totetaxi-last-activity', Date.now().toString());
        }
        set({
          user,
          customerProfile: profile,
          isAuthenticated: true,
          isLoading: false
        });
      },

      clearAuth: () => {
        console.log('Clearing customer auth state');
        
        if (typeof window !== 'undefined') {
          const keysToRemove = [
            'totetaxi-auth',
            'totetaxi-last-activity',
            'totetaxi-booking-wizard',
            'totetaxi-session-id',
            'totetaxi-csrf-token'
          ];
          
          keysToRemove.forEach(key => {
            try {
              localStorage.removeItem(key);
              console.log(`Cleared ${key}`);
            } catch (e) {
              console.warn(`Failed to remove ${key}:`, e);
            }
          });
        }
        
        queryClient.clear();
        console.log('Cleared React Query cache');
        
        set(initialState);
      },

      setLoading: (loading) => set({ isLoading: loading }),

      updateProfile: (updates) => set((state) => ({
        customerProfile: state.customerProfile 
          ? { ...state.customerProfile, ...updates }
          : null
      })),

      login: async (email: string, password: string) => {
        set({ isLoading: true });
        
        try {
          const response = await apiClient.post('/api/customer/auth/login/', {
            email,
            password
          });

          if (response.status === 200) {
            const { user, customer_profile, session_id, csrf_token } = response.data;
            
            // Store session ID and CSRF token for mobile fallback
            if (session_id) {
              localStorage.setItem('totetaxi-session-id', session_id);
              console.log('Stored session ID for mobile compatibility');
            }
            if (csrf_token) {
              localStorage.setItem('totetaxi-csrf-token', csrf_token);
            }
            
            get().setAuth(user, customer_profile);
            return { success: true, user };
          } else {
            set({ isLoading: false });
            return { success: false, error: 'Login failed' };
          }
        } catch (error: any) {
          set({ isLoading: false });
          const errorMessage = error.response?.data?.error || 'Network error. Please try again.';
          return { success: false, error: errorMessage };
        }
      },

      register: async (data: RegisterData) => {
        set({ isLoading: true });
        
        try {
          const response = await apiClient.post('/api/customer/auth/register/', {
            ...data,
            password_confirm: data.password
          });

          if (response.status === 201) {
            set({ isLoading: false });
            return { success: true, user: response.data.user };
          } else {
            set({ isLoading: false });
            return { success: false, error: 'Registration failed' };
          }
        } catch (error: any) {
          set({ isLoading: false });
          const errorMessage = error.response?.data?.error || 'Network error. Please try again.';
          return { success: false, error: errorMessage };
        }
      },

      logout: async () => {
        console.log('Customer logout initiated');
        
        try {
          await apiClient.post('/api/customer/auth/logout/');
          console.log('Customer logout API call successful');
        } catch (error) {
          console.warn('Customer logout API failed:', error);
        }
        
        get().clearAuth();
        
        try {
          const { useStaffAuthStore } = await import('@/stores/staff-auth-store');
          useStaffAuthStore.getState().clearAuth();
          console.log('Staff auth cleared during customer logout');
        } catch (e) {
          console.warn('Could not clear staff auth:', e);
        }
        
        if (typeof window !== 'undefined') {
          try {
            const { useBookingWizard } = await import('@/stores/booking-store');
            useBookingWizard.getState().resetWizard();
            console.log('Booking wizard cleared');
          } catch (e) {
            console.warn('Could not clear booking wizard:', e);
          }
        }
      },

      validateSession: async () => {
        const { user, isAuthenticated } = get();
        
        if (!isAuthenticated || !user) {
          return false;
        }
        
        try {
          const response = await apiClient.get('/api/customer/profile/');
          
          if (response.status === 200) {
            const { customer_profile } = response.data;
            if (customer_profile) {
              set({ customerProfile: customer_profile });
            }
            return true;
          }
          
          return false;
        } catch (error: any) {
          if (error.response?.status === 401) {
            console.log('Session validation failed - clearing auth');
            get().clearAuth();
          }
          return false;
        }
      },

      clearSessionIfIncognito: () => {
        if (typeof window !== 'undefined') {
          localStorage.setItem('totetaxi-last-activity', Date.now().toString());
        }
      },

      secureReset: () => {
        console.log('SECURITY: Performing secure reset of customer auth');
        
        if (typeof window !== 'undefined') {
          try {
            const allKeys = Object.keys(localStorage);
            allKeys
              .filter(key => key.startsWith('totetaxi-'))
              .forEach(key => {
                localStorage.removeItem(key);
                console.log(`SECURITY: Cleared ${key}`);
              });
          } catch (e) {
            console.warn('Could not perform secure localStorage clear:', e);
          }
        }
        
        queryClient.clear();
        console.log('SECURITY: Cleared React Query cache');
        
        set(initialState);
      }
    }),
    {
      name: 'totetaxi-auth',
      version: 2,
      migrate: (persistedState: any, version: number) => {
        console.log(`Customer auth migrating from version ${version} to 2`);
        
        if (version < 2) {
          console.log('Customer auth reset due to version upgrade');
          return initialState;
        }
        
        return persistedState;
      },
      partialize: (state) => ({
        user: state.user,
        customerProfile: state.customerProfile,
        isAuthenticated: state.isAuthenticated
      })
    }
  )
);
```

# ──── frontend/src/stores/booking-store.ts ────

```typescript
// frontend/src/stores/booking-store.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';

export interface BookingAddress {
  address_line_1: string;
  address_line_2?: string;
  city: string;
  state: 'NY' | 'CT' | 'NJ';
  zip_code: string;
}

export interface BookingData {
  service_type?: 'mini_move' | 'standard_delivery' | 'specialty_item' | 'blade_transfer';
  mini_move_package_id?: string;
  package_type?: 'petite' | 'standard' | 'full';
  include_packing?: boolean;
  include_unpacking?: boolean;
  standard_delivery_item_count?: number;
  is_same_day_delivery?: boolean;
  
  specialty_items?: Array<{
    item_id: string;
    quantity: number;
  }>;
  
  blade_airport?: 'JFK' | 'EWR';
  blade_flight_date?: string;
  blade_flight_time?: string;
  blade_bag_count?: number;
  blade_ready_time?: string;
  
  pickup_date?: string;
  pickup_time?: 'morning' | 'morning_specific' | 'no_time_preference';
  specific_pickup_hour?: number;
  pickup_address?: BookingAddress;
  delivery_address?: BookingAddress;
  customer_info?: {
    first_name: string;
    last_name: string;
    email: string;
    phone: string;
  };
  special_instructions?: string;
  coi_required?: boolean;
  is_outside_core_area?: boolean;
  pricing_data?: {
    base_price_dollars: number;
    same_day_delivery_dollars: number;
    surcharge_dollars: number;
    coi_fee_dollars: number;
    organizing_total_dollars: number;
    organizing_tax_dollars: number;
    geographic_surcharge_dollars: number;
    time_window_surcharge_dollars: number;
    total_price_dollars: number;
    pre_discount_total_dollars?: number | null;
    discount_amount_dollars?: number;
  };
  discount_code?: string;
  discount_validated?: boolean;
  discount_info?: {
    code: string;
    discount_type: 'percentage' | 'fixed';
    discount_description: string;
    discount_amount_dollars: number;
  };
}

interface BookingWizardState {
  currentStep: number;
  isLoading: boolean;
  bookingData: BookingData;
  errors: Record<string, string>;
  isBookingComplete: boolean;
  completedBookingNumber?: string;
  userId?: string;
  isGuestMode: boolean;
  lastResetTimestamp?: number;
}

interface BookingWizardActions {
  setCurrentStep: (step: number) => void;
  nextStep: () => void;
  previousStep: () => void;
  updateBookingData: (data: Partial<BookingData>) => void;
  setLoading: (loading: boolean) => void;
  setError: (field: string, message: string) => void;
  clearError: (field: string) => void;
  clearErrors: () => void;
  resetWizard: () => void;
  secureReset: () => void;
  canProceedToStep: (step: number) => boolean;
  setBookingComplete: (bookingNumber: string) => void;
  initializeForUser: (userId?: string, isGuest?: boolean) => void;
  updateSpecialtyItemQuantity: (itemId: string, quantity: number) => void;
  getSpecialtyItemQuantity: (itemId: string) => number;
  applyDiscountCode: (code: string, discountInfo: NonNullable<BookingData['discount_info']>) => void;
  clearDiscountCode: () => void;
}

const initialBookingData: BookingData = {
  service_type: 'mini_move',
  pickup_time: 'morning',
  coi_required: false,
  include_packing: false,
  include_unpacking: false,
  is_same_day_delivery: false,
  is_outside_core_area: false,
  specialty_items: [],
};

const STORE_VERSION = 6;
const MAX_SESSION_AGE_MS = 24 * 60 * 60 * 1000;

export const useBookingWizard = create<BookingWizardState & BookingWizardActions>()(
  persist(
    (set, get) => ({
      currentStep: 0,
      isLoading: false,
      bookingData: initialBookingData,
      errors: {},
      isBookingComplete: false,
      completedBookingNumber: undefined,
      userId: undefined,
      isGuestMode: true,
      lastResetTimestamp: Date.now(),

      setCurrentStep: (step) => {
        const validStep = Math.max(0, Math.min(step, 5));
        set({ currentStep: validStep });
      },
      
      nextStep: () => set((state) => {
        const maxStep = 5;
        let nextStep = state.currentStep + 1;
        
        if (state.currentStep === 1 && state.bookingData.service_type === 'mini_move' && !state.bookingData.mini_move_package_id) {
          console.error('Cannot proceed: No package selected for mini move');
          return state;
        }
        
        if (!state.isGuestMode && nextStep === 4) {
          nextStep = 5;
        }
        
        return { currentStep: Math.min(nextStep, maxStep) };
      }),
      
      previousStep: () => set((state) => {
        let prevStep = state.currentStep - 1;
        
        if (!state.isGuestMode && prevStep === 4) {
          prevStep = 3;
        }
        
        return { currentStep: Math.max(prevStep, 0) };
      }),
      
      updateBookingData: (data) => {
        set((state) => ({
          bookingData: { ...state.bookingData, ...data }
        }));
      },
      
      updateSpecialtyItemQuantity: (itemId: string, quantity: number) => {
        set((state) => {
          const currentItems = state.bookingData.specialty_items || [];
          const existing = currentItems.find(item => item.item_id === itemId);
          
          if (quantity === 0) {
            return {
              bookingData: {
                ...state.bookingData,
                specialty_items: currentItems.filter(item => item.item_id !== itemId)
              }
            };
          }
          
          if (existing) {
            return {
              bookingData: {
                ...state.bookingData,
                specialty_items: currentItems.map(item =>
                  item.item_id === itemId ? { ...item, quantity } : item
                )
              }
            };
          } else {
            return {
              bookingData: {
                ...state.bookingData,
                specialty_items: [...currentItems, { item_id: itemId, quantity }]
              }
            };
          }
        });
      },
      
      getSpecialtyItemQuantity: (itemId: string) => {
        const state = get();
        const item = state.bookingData.specialty_items?.find(i => i.item_id === itemId);
        return item?.quantity || 0;
      },

      applyDiscountCode: (code, discountInfo) => {
        set((state) => ({
          bookingData: {
            ...state.bookingData,
            discount_code: code,
            discount_validated: true,
            discount_info: discountInfo,
          }
        }));
      },

      clearDiscountCode: () => {
        set((state) => ({
          bookingData: {
            ...state.bookingData,
            discount_code: undefined,
            discount_validated: false,
            discount_info: undefined,
          }
        }));
      },

      setLoading: (loading) => set({ isLoading: !!loading }),
      
      setError: (field, message) => {
        set((state) => ({
          errors: { ...state.errors, [field]: message }
        }));
      },
      
      clearError: (field) => set((state) => {
        const newErrors = { ...state.errors };
        delete newErrors[field];
        return { errors: newErrors };
      }),
      
      clearErrors: () => set({ errors: {} }),
      
      setBookingComplete: (bookingNumber) => {
        if (bookingNumber) {
          set({
            isBookingComplete: true,
            completedBookingNumber: bookingNumber
          });
        }
      },
      
      // ✅ FIX: Properly handle guest mode updates
      initializeForUser: (providedUserId?, isGuest?) => {
        const userId = providedUserId || 'guest';
        const guestMode = isGuest !== undefined ? isGuest : (userId === 'guest');
        
        const state = get();
        
        console.log('Initializing booking wizard', { 
          userId, 
          guestMode, 
          currentUserId: state.userId,
          currentGuestMode: state.isGuestMode 
        });
        
        const timeSinceLastReset = state.lastResetTimestamp ? 
          Date.now() - state.lastResetTimestamp : Infinity;
        
        // ✅ Allow update if guest mode changed
        if (timeSinceLastReset < 1000 && state.isGuestMode === guestMode) {
          console.warn('Ignoring rapid user initialization (same state)');
          return;
        }
        
        const isStale = state.lastResetTimestamp && 
          (Date.now() - state.lastResetTimestamp > MAX_SESSION_AGE_MS);
        
        if (
          (state.userId && state.userId !== userId && state.userId !== 'guest') ||
          isStale ||
          state.isBookingComplete ||
          state.isGuestMode !== guestMode  // ✅ Also reset if guest mode changes
        ) {
          console.log('Resetting wizard - user/state change detected');
          set({
            bookingData: { ...initialBookingData },
            errors: {},
            isBookingComplete: false,
            completedBookingNumber: undefined,
            currentStep: 0,
            userId: userId,
            isGuestMode: guestMode,
            lastResetTimestamp: Date.now()
          });
        } else {
          // ✅ Always update both userId and guestMode together
          console.log('Updating user state without reset');
          set({ 
            userId: userId,
            isGuestMode: guestMode,
            lastResetTimestamp: Date.now()
          });
        }
      },
      
      // ✅ FIX: Calculate guest mode correctly based on userId
      resetWizard: () => {
        console.log('Resetting booking wizard completely');
        
        const state = get();
        
        // ✅ FIX: Calculate guest mode from userId, don't preserve old value
        const preservedUserId = state.userId !== 'guest' ? state.userId : 'guest';
        const calculatedGuestMode = preservedUserId === 'guest';
        
        console.log('Reset wizard with:', {
          preservedUserId,
          calculatedGuestMode,
          oldGuestMode: state.isGuestMode
        });
        
        const newState = {
          currentStep: 0,
          isLoading: false,
          bookingData: { ...initialBookingData },
          errors: {},
          isBookingComplete: false,
          completedBookingNumber: undefined,
          userId: preservedUserId,
          isGuestMode: calculatedGuestMode,  // ✅ Use calculated value
          lastResetTimestamp: Date.now()
        };
        
        set(newState);
        
        if (typeof window !== 'undefined') {
          try {
            localStorage.removeItem('totetaxi-booking-wizard');
            console.log('Cleared booking wizard from localStorage');
          } catch (e) {
            console.warn('Could not clear localStorage:', e);
          }
        }
      },
      
      secureReset: () => {
        console.log('SECURITY: Performing secure reset of booking wizard');
        
        if (typeof window !== 'undefined') {
          try {
            const allKeys = Object.keys(localStorage);
            allKeys
              .filter(key => key.startsWith('totetaxi-booking'))
              .forEach(key => {
                localStorage.removeItem(key);
                console.log(`SECURITY: Cleared ${key}`);
              });
          } catch (e) {
            console.warn('Could not perform secure localStorage clear:', e);
          }
        }
        
        set({
          currentStep: 0,
          isLoading: false,
          bookingData: { ...initialBookingData },
          errors: {},
          isBookingComplete: false,
          completedBookingNumber: undefined,
          userId: 'guest',
          isGuestMode: true,
          lastResetTimestamp: Date.now()
        });
      },
      
      canProceedToStep: (step) => {
        const { bookingData, isGuestMode } = get();
        
        switch (step) {
          case 0: return true;
          case 1: return true;
          case 2:
            if (bookingData.service_type === 'blade_transfer') {
              return !!(
                bookingData.blade_airport &&
                bookingData.blade_flight_date &&
                bookingData.blade_flight_time &&
                bookingData.blade_bag_count &&
                bookingData.blade_bag_count >= 2
              );
            }
            return !!bookingData.service_type && (
              (bookingData.service_type === 'mini_move' && !!bookingData.mini_move_package_id) ||
              (bookingData.service_type === 'standard_delivery' && !!bookingData.standard_delivery_item_count) ||
              (bookingData.service_type === 'specialty_item' && !!bookingData.specialty_items?.length)
            );
          case 3:
            if (bookingData.service_type === 'blade_transfer') {
              return !!(bookingData.blade_flight_date);
            }
            return !!bookingData.pickup_date;
          case 4:
            return !!bookingData.pickup_address && !!bookingData.delivery_address;
          case 5:
            if (isGuestMode) {
              return !!bookingData.customer_info?.email;
            } else {
              return !!bookingData.pickup_address && !!bookingData.delivery_address;
            }
          default:
            return false;
        }
      }
    }),
    {
      name: 'totetaxi-booking-wizard',
      version: STORE_VERSION,
      migrate: (persistedState: any, version: number) => {
        if (version !== STORE_VERSION) {
          console.log(`Store version mismatch (${version} !== ${STORE_VERSION}), resetting to defaults`);
          return {
            currentStep: 0,
            isLoading: false,
            bookingData: { ...initialBookingData },
            errors: {},
            isBookingComplete: false,
            completedBookingNumber: undefined,
            userId: 'guest',
            isGuestMode: true,
            lastResetTimestamp: Date.now()
          };
        }
        
        if (persistedState?.lastResetTimestamp) {
          const age = Date.now() - persistedState.lastResetTimestamp;
          if (age > MAX_SESSION_AGE_MS) {
            console.log('Persisted state is stale (>24h), resetting');
            return {
              currentStep: 0,
              isLoading: false,
              bookingData: { ...initialBookingData },
              errors: {},
              isBookingComplete: false,
              completedBookingNumber: undefined,
              userId: 'guest',
              isGuestMode: true,
              lastResetTimestamp: Date.now()
            };
          }
        }
        
        return persistedState;
      },
      partialize: (state) => ({
        bookingData: {
          ...state.bookingData,
          customer_info: undefined
        },
        currentStep: state.currentStep,
        isBookingComplete: state.isBookingComplete,
        completedBookingNumber: state.completedBookingNumber,
        userId: state.userId,
        isGuestMode: state.isGuestMode,
        lastResetTimestamp: state.lastResetTimestamp
      })
    }
  )
);
```

# ──── frontend/src/stores/staff-auth-store.ts ────

```typescript
// frontend/src/stores/staff-auth-store.ts
import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import { apiClient } from '@/lib/api-client';
import { queryClient } from '@/lib/query-client';

interface StaffUser {
  id: number;
  username: string;
  email: string;
  first_name: string;
  last_name: string;
}

interface StaffProfile {
  id: string;
  role: 'staff' | 'admin';
  department: string;
  full_name: string;
  permissions: {
    can_approve_refunds: boolean;
    can_manage_staff: boolean;
    can_view_financial_reports: boolean;
  };
}

interface StaffAuthState {
  user: StaffUser | null;
  staffProfile: StaffProfile | null;
  isAuthenticated: boolean;
  isLoading: boolean;
}

interface StaffAuthActions {
  setAuth: (user: StaffUser, profile: StaffProfile) => void;
  clearAuth: () => void;
  setLoading: (loading: boolean) => void;
  login: (username: string, password: string) => Promise<{ success: boolean; user?: StaffUser; error?: string }>;
  logout: () => Promise<void>;
  validateSession: () => Promise<boolean>;
  secureReset: () => void;
}

const initialState: StaffAuthState = {
  user: null,
  staffProfile: null,
  isAuthenticated: false,
  isLoading: false,
};

export const useStaffAuthStore = create<StaffAuthState & StaffAuthActions>()(
  persist(
    (set, get) => ({
      ...initialState,

      setAuth: (user, profile) => {
        set({
          user,
          staffProfile: profile,
          isAuthenticated: true,
          isLoading: false
        });
      },

      clearAuth: () => {
        console.log('Clearing staff auth state');
        
        if (typeof window !== 'undefined') {
          const keysToRemove = [
            'totetaxi-staff-auth',
            'totetaxi-session-id',
            'totetaxi-csrf-token'
          ];
          
          keysToRemove.forEach(key => {
            try {
              localStorage.removeItem(key);
              console.log(`Cleared ${key}`);
            } catch (e) {
              console.warn(`Failed to remove ${key}:`, e);
            }
          });
        }
        
        queryClient.clear();
        console.log('Cleared React Query cache');
        
        set(initialState);
      },

      setLoading: (loading) => set({ isLoading: loading }),

      login: async (username: string, password: string) => {
        set({ isLoading: true });
        
        try {
          const response = await apiClient.post('/api/staff/auth/login/', {
            username,
            password
          });

          if (response.status === 200) {
            const { user, staff_profile, session_id, csrf_token } = response.data;
            
            // Store session ID and CSRF token for mobile compatibility
            if (session_id) {
              localStorage.setItem('totetaxi-session-id', session_id);
              console.log('Stored session ID for mobile compatibility');
            }
            if (csrf_token) {
              localStorage.setItem('totetaxi-csrf-token', csrf_token);
              console.log('Stored CSRF token for mobile compatibility');
            }
            
            get().setAuth(user, staff_profile);
            return { success: true, user };
          } else {
            set({ isLoading: false });
            return { success: false, error: 'Login failed' };
          }
        } catch (error: any) {
          set({ isLoading: false });
          const errorMessage = error.response?.data?.error || 'Network error. Please try again.';
          return { success: false, error: errorMessage };
        }
      },

      logout: async () => {
        console.log('Staff logout initiated');
        
        try {
          await apiClient.post('/api/staff/auth/logout/');
          console.log('Staff logout API call successful');
        } catch (error) {
          console.warn('Staff logout API failed:', error);
        }
        
        get().clearAuth();
        
        try {
          const { useAuthStore } = await import('@/stores/auth-store');
          useAuthStore.getState().clearAuth();
          console.log('Customer auth cleared during staff logout');
        } catch (e) {
          console.warn('Could not clear customer auth:', e);
        }
      },

      validateSession: async () => {
        const { user, isAuthenticated } = get();
        
        if (!isAuthenticated || !user) {
          return false;
        }
        
        try {
          const response = await apiClient.get('/api/staff/dashboard/');
          
          if (response.status === 200) {
            return true;
          }
          
          return false;
        } catch (error: any) {
          if (error.response?.status === 401) {
            console.log('Staff session validation failed - clearing auth');
            get().clearAuth();
          }
          return false;
        }
      },

      secureReset: () => {
        console.log('SECURITY: Performing secure reset of staff auth');
        
        if (typeof window !== 'undefined') {
          try {
            const allKeys = Object.keys(localStorage);
            allKeys
              .filter(key => key.startsWith('totetaxi-staff') || key.startsWith('totetaxi-session') || key.startsWith('totetaxi-csrf'))
              .forEach(key => {
                localStorage.removeItem(key);
                console.log(`SECURITY: Cleared ${key}`);
              });
          } catch (e) {
            console.warn('Could not perform secure localStorage clear:', e);
          }
        }
        
        queryClient.clear();
        console.log('SECURITY: Cleared React Query cache');
        
        set(initialState);
      }
    }),
    {
      name: 'totetaxi-staff-auth',
      version: 2,
      migrate: (persistedState: any, version: number) => {
        console.log(`Staff auth migrating from version ${version} to 2`);
        
        if (version < 2) {
          console.log('Staff auth reset due to version upgrade');
          return initialState;
        }
        
        return persistedState;
      },
      partialize: (state) => ({
        user: state.user,
        staffProfile: state.staffProfile,
        isAuthenticated: state.isAuthenticated
      })
    }
  )
);
```

# ──── frontend/src/stores/ui-store.ts ────

```typescript
// frontend/src/stores/ui-store.ts
import { create } from 'zustand';

interface Notification {
  id: string;
  type: 'success' | 'error' | 'warning' | 'info';
  message: string;
  duration?: number;
}

interface UIState {
  sidebarOpen: boolean;
  theme: 'light' | 'dark';
  notifications: Notification[];
  modals: {
    login: boolean;
    register: boolean;
    addressForm: boolean;
    paymentMethod: boolean;
  };
}

interface UIActions {
  toggleSidebar: () => void;
  setSidebar: (open: boolean) => void;
  setTheme: (theme: 'light' | 'dark') => void;
  openModal: (modal: keyof UIState['modals']) => void;
  closeModal: (modal: keyof UIState['modals']) => void;
  addNotification: (notification: Omit<Notification, 'id'>) => void;
  removeNotification: (id: string) => void;
  clearNotifications: () => void;
  secureReset: () => void;
}

// SECURITY: Input sanitization helpers
const sanitizeNotification = (notification: Omit<Notification, 'id'>): Omit<Notification, 'id'> => {
  return {
    type: ['success', 'error', 'warning', 'info'].includes(notification.type) 
      ? notification.type 
      : 'info',
    message: notification.message?.substring(0, 500).trim() || '',
    duration: typeof notification.duration === 'number' 
      ? Math.max(1000, Math.min(notification.duration, 30000)) // 1s to 30s
      : undefined
  };
};

export const useUIStore = create<UIState & UIActions>((set, get) => ({
  // State
  sidebarOpen: false,
  theme: 'light',
  notifications: [],
  modals: {
    login: false,
    register: false,
    addressForm: false,
    paymentMethod: false,
  },

  // Actions
  toggleSidebar: () => set((state) => ({ sidebarOpen: !state.sidebarOpen })),
  
  setSidebar: (open) => set({ sidebarOpen: !!open }),
  
  setTheme: (theme) => {
    // SECURITY: Validate theme value
    const validTheme = ['light', 'dark'].includes(theme) ? theme : 'light';
    set({ theme: validTheme });
  },

  openModal: (modal) => {
    // SECURITY: Validate modal key exists
    const validModals = ['login', 'register', 'addressForm', 'paymentMethod'];
    if (validModals.includes(modal)) {
      set((state) => ({
        modals: { ...state.modals, [modal]: true }
      }));
    }
  },

  closeModal: (modal) => {
    // SECURITY: Validate modal key exists
    const validModals = ['login', 'register', 'addressForm', 'paymentMethod'];
    if (validModals.includes(modal)) {
      set((state) => ({
        modals: { ...state.modals, [modal]: false }
      }));
    }
  },

  addNotification: (notification) => {
    const sanitizedNotification = sanitizeNotification(notification);
    
    set((state) => {
      // SECURITY: Limit total notifications to prevent memory issues
      const maxNotifications = 10;
      const newNotifications = [
        ...state.notifications.slice(-maxNotifications + 1),
        { 
          ...sanitizedNotification, 
          id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}` 
        }
      ];
      
      return { notifications: newNotifications };
    });
  },

  removeNotification: (id) => {
    // SECURITY: Validate ID format
    const sanitizedId = id?.substring(0, 50);
    if (sanitizedId) {
      set((state) => ({
        notifications: state.notifications.filter(n => n.id !== sanitizedId)
      }));
    }
  },

  clearNotifications: () => set({ notifications: [] }),

  // SECURITY: Reset method for security incidents
  secureReset: () => {
    console.log('SECURITY: Performing secure reset of UI store');
    set({
      sidebarOpen: false,
      theme: 'light',
      notifications: [],
      modals: {
        login: false,
        register: false,
        addressForm: false,
        paymentMethod: false,
      }
    });
  }
}));
```

# ──── frontend/src/types/index.ts ────

```typescript
// frontend/src/types/index.ts
export interface DjangoUser {
  id: number;
  username: string;
  email: string;
  first_name: string;
  last_name: string;
  is_active: boolean;
  date_joined: string;
}

export interface CustomerProfile {
  id: string;
  user: DjangoUser;
  phone: string;
  stripe_customer_id: string;
  total_bookings: number;
  total_spent_cents: number;
  total_spent_dollars: number;
  preferred_pickup_time: 'morning' | 'morning_specific' | 'no_time_preference';
  email_notifications: boolean;
  sms_notifications: boolean;
  is_vip: boolean;
  last_booking_at: string | null;
}

export interface AuthResponse {
  message: string;
  user: DjangoUser;
  customer_profile: CustomerProfile;
  csrf_token: string;
}

export interface MiniMovePackage {
  id: string;
  package_type: 'petite' | 'standard' | 'full';
  name: string;
  description: string;
  base_price_dollars: number;
  max_items: number | null;
  coi_included: boolean;
  coi_fee_dollars: number;
  is_most_popular: boolean;
  priority_scheduling: boolean;
  protective_wrapping: boolean;
}

export interface SpecialtyItem {
  id: string;
  item_type: string;
  name: string;
  description: string;
  price_dollars: number;
  special_handling: boolean;
}

export interface ServiceCatalog {
  mini_move_packages: MiniMovePackage[];
  standard_delivery: {
    price_per_item_dollars: number;
    minimum_items: number;
    minimum_charge_dollars: number;
    same_day_flat_rate_dollars: number;
    max_weight_per_item_lbs: number;
  } | null;
  specialty_items: SpecialtyItem[];
}

export interface APIError {
  message: string;
  field_errors?: Record<string, string[]>;
}

export interface BookingWizardState {
  currentStep: number;
  isLoading: boolean;
  bookingData: BookingData;
  errors: Record<string, string>;
}

export interface BookingData {
  service_type?: 'mini_move' | 'standard_delivery' | 'specialty_item' | 'blade_transfer';
  mini_move_package_id?: string;
  package_type?: 'petite' | 'standard' | 'full';
  include_packing?: boolean;
  include_unpacking?: boolean;
  standard_delivery_item_count?: number;
  is_same_day_delivery?: boolean;
  specialty_items?: Array<{
  item_id: string;
  quantity: number;
}>;
  
  blade_airport?: 'JFK' | 'EWR';
  blade_flight_date?: string;
  blade_flight_time?: string;
  blade_bag_count?: number;
  blade_ready_time?: string;
  
  pickup_date?: string;
  pickup_time?: 'morning' | 'morning_specific' | 'no_time_preference';
  specific_pickup_hour?: number;
  pickup_address?: BookingAddress;
  delivery_address?: BookingAddress;
  customer_info?: {
    first_name: string;
    last_name: string;
    email: string;
    phone: string;
  };
  special_instructions?: string;
  coi_required?: boolean;
  is_outside_core_area?: boolean;
  pricing_data?: {
    base_price_dollars: number;
    same_day_delivery_dollars: number;
    surcharge_dollars: number;
    coi_fee_dollars: number;
    organizing_total_dollars: number;
    organizing_tax_dollars: number;
    geographic_surcharge_dollars: number;
    time_window_surcharge_dollars: number;
    total_price_dollars: number;
  };
}

export interface BookingAddress {
  address_line_1: string;
  address_line_2?: string;
  city: string;
  state: 'NY' | 'CT' | 'NJ';
  zip_code: string;
}

export interface Payment {
  id: string;
  booking_number: string;
  customer_name: string;
  amount_cents: number;
  amount_dollars: number;
  status: 'pending' | 'succeeded' | 'failed' | 'refunded';
  stripe_payment_intent_id: string;
  stripe_charge_id: string;
  failure_reason?: string;
  processed_at: string | null;
  created_at: string;
  total_refunded_cents?: number;
  total_refunded_dollars?: number;
}

export interface Refund {
  id: string;
  payment_booking_number: string;
  amount_cents: number;
  amount_dollars: number;
  reason: string;
  status: 'requested' | 'approved' | 'denied' | 'completed';
  requested_by_name: string;
  approved_by_name: string | null;
  approved_at: string | null;
  completed_at: string | null;
  created_at: string;
}



export interface RefundRequest {
  payment_id: string;
  amount_cents: number;
  reason: string;
}

// Onfleet Integration Types
export interface OnfleetTask {
  task_type: 'pickup' | 'dropoff';
  tracking_url: string;
  status: 'created' | 'assigned' | 'active' | 'completed' | 'failed' | 'deleted';
  worker_name: string;
  completed_at: string | null;
  started_at: string | null;
}

export interface BookingWithTracking {
  id: string;
  booking_number: string;
  customer_name: string;
  service_type: string;
  pickup_date: string;
  pickup_time: string;
  status: 'pending' | 'confirmed' | 'paid' | 'in_progress' | 'completed' | 'cancelled';
  pickup_address: BookingAddress;
  delivery_address: BookingAddress;
  special_instructions: string;
  coi_required: boolean;
  total_price_dollars: number;
  pricing_breakdown: any;
  payment_status: string;
  can_rebook: boolean;
  onfleet_tasks: OnfleetTask[];
  created_at: string;
  updated_at: string;
}
```

# ──── frontend/src/utils/cn.ts ────

```typescript
// frontend/src/utils/cn.ts
import { clsx, type ClassValue } from 'clsx';
import { twMerge } from 'tailwind-merge';

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
```

