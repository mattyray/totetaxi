# backend/apps/bookings/tests/test_booking_api.py
import pytest
from django.contrib.auth.models import User
from rest_framework.test import APIClient
from apps.customers.models import CustomerProfile
from apps.bookings.models import Booking, Address, GuestCheckout
from apps.services.models import MiniMovePackage
from django.utils import timezone
from datetime import timedelta


@pytest.fixture
def authenticated_client(db):
    """Create authenticated API client"""
    user = User.objects.create_user(
        username='testuser',
        email='test@example.com',
        password='testpass123',
        is_active=True
    )
    CustomerProfile.objects.create(user=user, phone='5551234567')
    
    client = APIClient()
    client.force_authenticate(user=user)
    return client, user


@pytest.fixture
def addresses(db):
    """Create test addresses"""
    pickup = Address.objects.create(
        address_line_1='123 Pickup St',
        city='New York',
        state='NY',
        zip_code='10001'
    )
    delivery = Address.objects.create(
        address_line_1='456 Delivery Ave',
        city='New York',
        state='NY',
        zip_code='10002'
    )
    return pickup, delivery


@pytest.fixture
def mini_move_package(db):
    """Create test mini move package"""
    return MiniMovePackage.objects.create(
        package_type='petite',
        name='Petite',
        description='Test package',
        base_price_cents=99500,
        max_items=15,
        max_weight_per_item_lbs=50,
        is_active=True
    )


@pytest.mark.django_db
class TestBookingCreation:
    """Test booking creation"""
    
    def test_create_booking_authenticated(self, authenticated_client, addresses, mini_move_package):
        """Test creating booking as authenticated user"""
        client, user = authenticated_client
        pickup, delivery = addresses
        
        response = client.post('/api/customer/bookings/create/', {
            'service_type': 'mini_move',
            'mini_move_package_id': str(mini_move_package.id),
            'pickup_address': str(pickup.id),
            'delivery_address': str(delivery.id),
            'pickup_date': (timezone.now().date() + timedelta(days=2)).isoformat(),
            'pickup_time': 'morning',
            'payment_intent_id': 'pi_test_123'
        })
        
        assert response.status_code == 201
        assert 'booking_number' in response.data
        
        # Verify booking was created
        booking = Booking.objects.get(booking_number=response.data['booking_number'])
        assert booking.customer == user
        assert booking.status == 'paid'
    
    def test_create_booking_guest(self, addresses, mini_move_package):
        """Test creating booking as guest"""
        client = APIClient()
        pickup, delivery = addresses
        
        response = client.post('/api/public/bookings/create/', {
            'service_type': 'mini_move',
            'mini_move_package_id': str(mini_move_package.id),
            'pickup_address': str(pickup.id),
            'delivery_address': str(delivery.id),
            'pickup_date': (timezone.now().date() + timedelta(days=2)).isoformat(),
            'pickup_time': 'morning',
            'guest_info': {
                'first_name': 'Guest',
                'last_name': 'User',
                'email': 'guest@example.com',
                'phone': '5559876543'
            },
            'payment_intent_id': 'pi_test_123'
        })
        
        assert response.status_code == 201
        
        # Verify guest checkout was created
        booking = Booking.objects.get(booking_number=response.data['booking_number'])
        assert booking.guest_checkout is not None
        assert booking.guest_checkout.email == 'guest@example.com'
    
    def test_create_booking_past_date(self, authenticated_client, addresses, mini_move_package):
        """Test creating booking with past date fails"""
        client, user = authenticated_client
        pickup, delivery = addresses
        
        response = client.post('/api/customer/bookings/create/', {
            'service_type': 'mini_move',
            'mini_move_package_id': str(mini_move_package.id),
            'pickup_address': str(pickup.id),
            'delivery_address': str(delivery.id),
            'pickup_date': (timezone.now().date() - timedelta(days=1)).isoformat(),
            'pickup_time': 'morning',
            'payment_intent_id': 'pi_test_123'
        })
        
        assert response.status_code == 400


@pytest.mark.django_db
class TestBookingRetrieval:
    """Test booking retrieval"""
    
    def test_get_customer_bookings(self, authenticated_client, addresses, mini_move_package):
        """Test getting customer's bookings"""
        client, user = authenticated_client
        pickup, delivery = addresses
        
        # Create a booking
        Booking.objects.create(
            customer=user,
            service_type='mini_move',
            mini_move_package=mini_move_package,
            pickup_address=pickup,
            delivery_address=delivery,
            pickup_date=timezone.now().date() + timedelta(days=1),
            status='confirmed'
        )
        
        response = client.get('/api/customer/bookings/')
        
        assert response.status_code == 200
        assert len(response.data['bookings']) == 1
    
    def test_cannot_see_other_customer_bookings(self, authenticated_client, addresses):
        """Test customer cannot see another customer's bookings"""
        client, user = authenticated_client
        pickup, delivery = addresses
        
        # Create another user with booking
        other_user = User.objects.create_user(
            username='other',
            email='other@example.com',
            password='testpass123'
        )
        CustomerProfile.objects.create(user=other_user, phone='5559999999')
        
        Booking.objects.create(
            customer=other_user,
            service_type='mini_move',
            pickup_address=pickup,
            delivery_address=delivery,
            pickup_date=timezone.now().date() + timedelta(days=1),
            status='confirmed'
        )
        
        response = client.get('/api/customer/bookings/')
        
        assert response.status_code == 200
        assert len(response.data['bookings']) == 0