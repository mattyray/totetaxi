app = 'totetaxi-backend'
primary_region = 'ewr'

[build]
  dockerfile = 'Dockerfile.prod'

# NOTE: release_command disabled — the temporary machine Fly.io creates
# for it only gets ~256MB, but Django + langchain packages need ~190MB
# just to import, leaving no headroom. Run migrations manually before
# deploying: fly ssh console -C "su appuser -c 'cd /app && python manage.py migrate'"
# [deploy]
#   release_command = "python manage.py migrate --noinput"

[env]
  DEBUG = "False"
  DJANGO_LOG_LEVEL = "INFO"
  DJANGO_SETTINGS_MODULE = 'config.settings'
  PORT = '8000'
  PYTHONUNBUFFERED = '1'
  PYTHONPATH = '/app'

# ✅ MULTI-PROCESS CONFIGURATION
[processes]
  web = "gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 4 --worker-class gevent --worker-connections 100"
  worker = "celery -A config worker -l info --concurrency 2"
  beat = "celery -A config beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler"

[http_service]
  internal_port = 8000
  force_https = true
  auto_stop_machines = false
  auto_start_machines = true
  min_machines_running = 1
  processes = ['web']  # Only web handles HTTP traffic

  [http_service.concurrency]
    type = 'requests'
    hard_limit = 200
    soft_limit = 100

# ✅ MACHINE CONFIGURATION - Separate for each process
[[vm]]
  memory = '1gb'
  cpu_kind = 'shared'
  cpus = 1
  processes = ['web']

[[vm]]
  memory = '512mb'
  cpu_kind = 'shared'
  cpus = 1
  processes = ['worker']

[[vm]]
  memory = '256mb'
  cpu_kind = 'shared'
  cpus = 1
  processes = ['beat']

[[statics]]
  guest_path = "/app/staticfiles"
  url_prefix = "/static/"